# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **TSL (Timber Script Language) Knowledge Base** for hsbCAD, a timber construction CAD system built on AutoCAD. TSL is a scripting language based on **C syntax**, designed specifically to control timber construction entities (beams, walls, panels, hardware connections).

**Primary purpose**: Use LLM to auto-generate user-facing documentation for ~1,200 TSL scripts, targeting non-programmer timber structure designers and CAD operators.

A TSL script is not just code—in AutoCAD/hsbCAD, it behaves as an **Intelligent Entity (TslInst)**:
- **Parametric**: The script defines the shape and behavior of the entity
- **Dynamic**: If a linked Beam or Wall (Element) moves, the script automatically **recalculates**
- **Interactive**: Variables defined in the script automatically appear in the AutoCAD Properties Palette (OPM) for user modification

## Repository Structure

```
TSL/
├── CLAUDE.md                    # This file - TSL language reference
├── PRD-TSL-UserGuide-Generation-System.md  # Full PRD with script classification
├── TSL/                         # Main script directory
│   ├── *.mcr                    # ~400+ TSL script files
│   ├── Settings/                # XML configuration files (hardware catalogs)
│   └── Trusses/                 # Roof truss-specific scripts
└── output/
    └── docs/                    # Generated user documentation (Markdown)
```

**Key script categories by prefix:**
- `hsb*` - Core hsbCAD operations
- `hsbCLT-*` - Cross-Laminated Timber tools
- `Hilti-*`, `Simpson*`, `Rothoblaas-*` - Hardware/fastener systems
- `GA*.mcr` - Generic angle bracket system
- `HSB_W-*`, `HSB_R-*`, `FLR_*` - Wall/roof/floor framing
- `sd_*` - Shop drawing scripts (Paper Space)

See `PRD-TSL-UserGuide-Generation-System.md` for complete script classification (1,218 scripts across 11 categories).

## Script File Format

Every `.mcr` file follows this structure:

```c
#Version 8
#BeginDescription
V1.0 Date Description
#End
#Type O                  // O=Object, T=Tool, E=Element
#NumBeamsReq 0           // Beams required for operation
#NumPointsGrip 0
#MajorVersion 1
#MinorVersion 0
#BeginContents
// TSL code here
#End
#BeginMapX
// XML metadata (IDE settings, version history)
#End
```

## Core Data Types

TSL mixes standard programming types with CAD-specific geometry types.

### Basic Geometry

| Type | Description | Example |
|------|-------------|---------|
| `Point3d` | 3D point | `Point3d pt(0, 0, 0);` |
| `Vector3d` | 3D vector (direction and length), used for extrusions, moving objects, or defining axes | `Vector3d v = _ZU;` |
| `Line` | Infinite line | |
| `LineSeg` | Finite line segment | |
| `Plane` | Used for cutting objects or defining coordinate systems | |
| `PLine` | Polyline, used to define profiles, contours, or holes to be extruded into solids | `plCircle.createCircle(_Pt0, _ZU, dRadius);` |
| `Body` | **Core Type**. 3D Solid (ACIS Solid). Supports Boolean operations (Union, Subtract, Intersect) | |

### HSB Specific Entities

| Type | Description |
|------|-------------|
| `TslInst` / `_ThisInst` | Current instance of the script itself |
| `GenBeam` / `Beam` | Timber member. Methods: `.dD()` (depth), `.dW()` (width), `.dH()` (height), `.ptCen()` (center point), `.addTool()` |
| `Element` | Complete wall, floor, or roof (collection of beams and sheets) |
| `Sheet` | Paneling material (e.g., OSB, Gypsum) |
| `Sip` | Structural Insulated Panel |
| `MetalPart` | Metal hardware/connectors, usually generated by script |

### Data Container

**`Map`** - Very important. A Key-Value container used to pass data between scripts or store non-geometric attributes:
```c
_Map.setInt("MyValue", 10);
if (_Map.hasInt("MyValue")) { ... }
```

## User Properties (OPM)

Define parameters that users can change in the CAD Properties Palette without writing UI code:

| Type | Usage | Example |
|------|-------|---------|
| `PropDouble` | Floating-point (Length, Width) | `PropDouble dLen(0, U(100), "Length");` |
| `PropInt` | Integer (Quantity, Type switch) | `PropInt nCount(1, 5, "Count");` |
| `PropString` | String (Model Name, Material) | `PropString sName(2, "Default", "Name");` |

**Syntax**: `PropType varName(index, defaultValue, "Display Name");`

These behave like normal variables in calculations but are automatically bound to the CAD interface.

## Key Predefined Variables

Based on script type (T-Type, E-Type, O-Type, etc.), TSL predefines:

| Variable | Description |
|----------|-------------|
| `_Pt0` | Insertion Point (Origin). Everything is usually calculated relative to this point |
| `_Beam0`, `_Beam1` | Primary and secondary beams associated with the script |
| `_bOnInsert` | Boolean flag. `TRUE` only when user is currently inserting the script |
| `_XU`, `_YU`, `_ZU` | X, Y, Z axes of the current UCS |
| `_XW`, `_YW`, `_ZW` | X, Y, Z axes of the World coordinate system |
| `_kPathHsbCompany` | Company-specific path |
| `_kPathHsbInstall` | Installation path |
| `_kPathDwg` | Current drawing path |

## Unit Conversion - U()

**The most frequently used function.** hsbCAD handles units strictly.

```c
double d = U(100);        // Converts 100 to current drawing units
double d = U(100, "mm");  // Explicit mm specification
```

**Critical**: Never write `double d = 100;`. Always write `double d = U(100);` to ensure your script works in both Millimeter and Inch templates.

## Script Lifecycle

```c
// 1. Define Units
Unit(1, "mm");

// 2. Define User Properties (Visible in OPM)
PropDouble dRadius(0, U(50), "Radius");

// 3. Insertion Logic (Runs only when user first places it)
if (_bOnInsert) {
    _Pt0 = getPoint("Select a point");  // Ask user to click
    return;  // End insertion phase
}

// 4. Geometry Calculation & Drawing Logic
PLine plCircle;
plCircle.createCircle(_Pt0, _ZU, dRadius);  // At _Pt0, facing Z axis

// 5. Display Result
Display dp(1);  // Set color to 1 (Red)
dp.draw(plCircle);
```

## Debugging & Visualization

### Console Output
```c
reportMessage("Debug: " + value);  // Prints to command line
```

### Visual Debugging with .vis()
Almost all geometry types (Point3d, Line, PLine, Body) have this method:
```c
_Pt0.vis(1);      // Draws point on screen in Color 1 (Red)
myBody.vis(3);    // Draws body in Color 3
```
This is essential for visualizing your math in 3D space during development.

### Debug Flag Pattern
```c
int bDebug = _bOnDbCreated;
MapObject mo("hsbTSLDev", "hsbTSLDebugController");
```

## Tooling Operations

The power of TSL—modifying other entities:

```c
// Define a drill (Location, Direction, Diameter, Depth)
Drill myDrill(_Pt0, _ZU, U(20), U(100));

// Apply the drill to Beam0
_Beam0.addTool(myDrill);
```

**Common Tools**: `Cut`, `Drill`, `Slot`, `Mortise`

## Settings Persistence

Scripts read XML configuration from two locations:
1. Company: `_kPathHsbCompany + "\TSL\Settings\"`
2. Install: `_kPathHsbInstall + "\Content\General\TSL\Settings\"`

```c
MapObject mo("hsbTSL", "FileName");
if (mo.bIsValid()) {
    mapSetting = mo.map();
} else {
    mapSetting.readFromXmlFile(sFile);
    mo.dbCreate(mapSetting);
}
```

## Dialog UI (via TslUtilities.dll)

```c
String stDll = _kPathHsbInstall + "\\Utilities\\DialogService\\TslUtilities.dll";
String stClass = "TslUtilities.TslDialogService";

// Available methods:
// - SelectFromList: Combobox with search field
// - SelectOption: Radio button list
// - GetText: Simple text input
// - AskYesNo: Binary question dialog
// - ShowNotice: Simple message
// - ShowMultilineNotice: Multi-line message
// - ShowDynamicDialog: Dynamic form with multiple control types

Map mpOut = callDotNetFunction2(stDll, stClass, "SelectFromList", mpIn);
```

## Internationalization

```c
String sYes = T("|Yes|");  // Translation key with pipe notation
```

## XML Configuration Format

Settings files use `<Hsb_Map>` structure:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Hsb_Map>
  <lst nm="Array[]">
    <lst nm="Element">
      <str nm="Name" vl="Value"/>
      <dbl nm="Height" ut="L" vl="100"/>
      <int nm="Color" vl="1"/>
    </lst>
  </lst>
  <unit ut="L" uv="millimeter"/>
</Hsb_Map>
```

## Reference Files

| File | Purpose |
|------|---------|
| `TSL/DialogExample.mcr` | Reference for all dialog UI types |
| `TSL/GA.mcr` | Complex example with all UI elements (OPM, context menu, XML settings) |
| `TSL/Settings/*.xml` | Hardware/material catalog examples |
| `PRD-TSL-UserGuide-Generation-System.md` | Complete system PRD with 6-pass analysis workflow |

## Important Notes

1. Use `envelopeBody()` instead of `realBody()` for performance in complex scripts
2. Version numbers tracked in `#BeginDescription` and `#MajorVersion`/`#MinorVersion` headers
3. Scripts validate XML version compatibility on instantiation
4. Map communication between scripts via `MapObject` system with `setDependencyOnDictObject()` for tracking

---

## User Guide Generation System (Summary)

This repo implements LLM-based documentation generation for TSL scripts. See `PRD-TSL-UserGuide-Generation-System.md` for full details.

### 6-Pass Analysis Pipeline

```
Pass 1: Metadata Extraction    → Script headers (#Type, #NumBeamsReq, version)
Pass 2: Environment Detection  → Model Space / Paper Space / ShopDrawing
Pass 3: UI Extraction          → OPM properties, dialogs, context menus, command prompts
Pass 4: Semantic Analysis      → Parameter business meanings and dependencies
Pass 5: Logic Analysis         → User workflow and conditional branches
Pass 6: Guide Generation       → Final Markdown documentation
```

### Script Categories (for prompt selection)

| Category | Prefix | Focus |
|----------|--------|-------|
| Hardware | `Hilti-*`, `Simpson*`, `GA*`, `BMF*` | Product selection, fastener specs |
| StickFrame | `HSB_W-*`, `HSB_R-*`, `FLR_*` | Wall/roof/floor framing |
| CLT | `hsbCLT-*` | Cross-laminated timber |
| ShopDrawing | `sd_*` | Fabrication drawings |
| Manufacturing | `Nail-*`, `Drill*`, `*Mill*` | CNC operations |

### Parent-Child Script Suites

Some scripts work as suites (parent controls children):
- `HVAC` → `HVAC-T`, `HVAC-G`, `HVAC-P`
- `MultipageController` → `MultipageAnchor`, dimension TSLs
- `FastenerManager` → `FastenerEditor`, `FastenerInspector`

Detection: Look for `TslInst.dbCreate("ScriptName")` or `hsb_ScriptInsert()` calls.
