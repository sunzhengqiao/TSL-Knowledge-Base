{
  "filename": "BeA-HVV-Typ1.mcr",
  "status": "completed",
  "total_tokens": 54533,
  "processing_time": 358.10694909095764,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 10154,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses `_kModelSpace` explicitly during insertion (`tsl.dbCreate(..., _kModelSpace, mapTsl)`). It processes `Beam` and `TslInst` entities and generates 3D geometry using `Body` and `PLine`. There is no use of `_Viewport`, `sd_` prefixes, or `#Type E` logic typical of Paper Space or Shop Drawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam",
            "TslInst (DetailGenBeam)"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 6519,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": false\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity.go\",\n        \"promptOriginal\": \"|Select beams|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"nSide\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"|Side|\",\n      \"defaultValue\": \"1\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"1\",\n        \"2\",\n        \"3\",\n        \"4\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sModel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Model|\",\n      \"defaultValue\": \"First item in generated list\",\n      \"inputType\": \"dropdown\",\n      \"options\": \"Generated from dimension arrays (e.g., '40 x 40 x 2 x 20')\",\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sMulti\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|multiple Insertion|\",\n      \"defaultValue\": \"|Single Side|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Single Side|\",\n        \"|Two opposite Sides|\",\n       "
      },
      "tokens_used": 10870,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts and configures a BeA HVV Type 1 angle bracket for timber beam connections (T-connections or corner details) with options for multi-sided wrapping.",
          "category": "Hardware",
          "typicalUseCase": "Connecting two timber beams perpendicularly (e.g., purlin to rafter or stud to plate) using a specific BeA brand angle bracket, potentially with multiple brackets wrapping around a column."
        },
        "parameters": [
          {
            "name": "nSide",
            "technicalDefault": "1",
            "businessMeaning": "Defines the mounting face orientation of the bracket relative to the primary beam's cross-section (e.g., Top, Right, Bottom, Left).",
            "validRange": "1 to 4",
            "unit": "Index",
            "affectsOutput": "Rotates the bracket geometry around the beam's longitudinal axis to the selected side."
          },
          {
            "name": "sModel",
            "technicalDefault": "First item in generated list (e.g., '40 x 40 x 2 x 20')",
            "businessMeaning": "Selects the specific physical size/SKU of the BeA HVV bracket. The format corresponds to Height x Length x Thickness x Width.",
            "validRange": "Predefined list of manufacturer sizes (e.g., '40 x 40 x 2 x 20' to '120 x 120 x 3 x 120')",
            "unit": "String (mm dimensions)",
            "affectsOutput": "Changes the geometric dimensions of the 3D Body, the BOM description, and the hardware classification."
          },
          {
            "name": "sMulti",
            "technicalDefault": "|Single Side|",
            "businessMeaning": "Configures how many brackets are inserted simultaneously around the connection point (wrapping configuration).",
            "validRange": "Single Side, Two opposite Sides, Two neighbouring Sides, Three Sides, Four Sides",
            "unit": "Enumeration",
            "affectsOutput": "Creates additional mirrored or rotated instances of the bracket body and updates the BOM quantity accordingly."
          },
          {
            "name": "dSnap",
            "technicalDefault": "20",
            "businessMeaning": "The tolerance distance for IntelliSnap to detect connecting beams during automatic insertion.",
            "validRange": "0 to 500 (depending on model scale)",
            "unit": "mm",
            "affectsOutput": "Does not change geometry. Determines whether the script identifies a valid T-connection during the initial selection."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "Current Standard DimStyle",
            "businessMeaning": "Assigns the CAD dimensioning style to any dimensions generated by the script (if applicable).",
            "validRange": "Any DimStyle defined in the drawing",
            "unit": "String",
            "affectsOutput": "Affects the visual appearance of dimensions if generated."
          },
          {
            "name": "nColor",
            "technicalDefault": "254",
            "businessMeaning": "The display color of the 3D hardware model in the CAD workspace.",
            "validRange": "0 to 255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Changes the visual color of the bracket Body."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMulti changes",
            "effect": "Adjusts the quantity of brackets generated (nQty) and creates mirrored/rotated copies.",
            "cascade": [
              "nQty (derived)",
              "Body Geometry (Count)"
            ]
          },
          {
            "trigger": "nSide changes",
            "effect": "Rotates the coordinate system (vy, vz) of the bracket placement.",
            "cascade": [
              "Body Geometry (Orientation)",
              "Cut Position"
            ]
          },
          {
            "trigger": "sModel changes",
            "effect": "Updates internal dimension variables (dArA, dArB, dArC, dArD) used for drawing and BOM.",
            "cascade": [
              "Body Geometry (Size)",
              "HardWrComp Data",
              "BOM Export"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (MetalPart)",
            "description": "A 3D solid representing the steel angle bracket, dimensions derived from 'sModel'.",
            "appliedTo": "Generated at the intersection point of the beams (calculated as _Pt0)."
          },
          {
            "type": "Cut",
            "description": "A cross-cut applied perpendicular to the main beam's axis at the connection point.",
            "appliedTo": "The main beam (bm0)."
          },
          {
            "type": "HardWrComp",
            "description": "BOM entry including article number (script name), dimensions, quantity, and material (Steel, zincated).",
            "appliedTo": "Associated with the script instance and/or the specific Element/Beam group."
          },
          {
            "type": "ElemItem",
            "description": "Logical link between the hardware and a structural element (Wall/Floor) if an Element context is detected.",
            "appliedTo": "The detected Element (elThis)."
          }
        ]
      },
      "tokens_used": 10147,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User launches the script via command line.",
          "2. Properties dialog displays for user configuration (Model, Side, Multi-insertion, etc.).",
          "3. User is prompted to select entities (Beams or existing TslInst of type 'DetailGenBeam').",
          "4. [Branch] Script determines insertion mode based on selection (Beam Connection vs. Detail Mode).",
          "5. Script creates the local TSL instance(s) at detected intersection points or detail locations.",
          "6. Original (master) TSL instance erases itself from the database, leaving only the working instances.",
          "7. Local instance calculates geometry based on beam intersection, side index, and model dimensions.",
          "8. Script validates beam contact (edge intersection). If no contact, geometry generation aborts.",
          "9. Cuts are applied to the main beam.",
          "10. 3D Body(s) are generated (mirrored/rotated based on Multi-insertion setting).",
          "11. BOM data (HardWrComp/ElemItem) and DXA data are exported."
        ],
        "conditionalBranches": [
          {
            "condition": "Selection Type during Insertion",
            "path1": {
              "name": "Beam Mode (T-Connection)",
              "steps": [
                "User selects Beams.",
                "If 1 Beam selected: Script jumps to Special Insert mode (attaches to beam, waits for external connection logic).",
                "If >1 Beam selected: Script loops through selected beams.",
                "Calculates T-Connections using `filterBeamsTConnection`.",
                "Iterates through found connections.",
                "For each valid connection pair (Main/Female), inserts a new TSL instance at the intersection."
              ]
            },
            "path2": {
              "name": "Detail Mode (Sub-Component)",
              "steps": [
                "User selects a TslInst (DetailGenBeam).",
                "Sets dependency on the selected DetailGenBeam.",
                "Retrieves dimensions (Y, Z, Angle) from the DetailGenBeam properties.",
                "Calculates local coordinate system on the face of the detail beam.",
                "Inserts a single TSL instance linked to the detail."
              ]
            }
          },
          {
            "condition": "Side Property (nSide)",
            "path1": {
              "name": "Side 1 (Top-ish)",
              "steps": [
                "Vector vz is derived from Female Beam's Z direction mapped to Main Beam.",
                "Geometry is rotated 0 degrees relative to the connection face."
              ]
            },
            "path2": {
              "name": "Side 2, 3, 4 (Right/Bottom/Left)",
              "steps": [
                "Vector vz is re-calculated to align with Main Beam's local axes or negative equivalents.",
                "Geometry is rotated (90, 180, or 270 degrees) around the connection X-axis."
              ]
            }
          },
          {
            "condition": "Multi-Insertion Property (sMulti)",
            "path1": {
              "name": "Single Side",
              "steps": [
                "Generates one primary Body.",
                "No further transformations applied."
              ]
            },
            "path2": {
              "name": "Two Opposite / Three / Four Sides",
              "steps": [
                "Generates primary Body.",
                "Applies mirroring transformation across the X-axis plane to create the opposite side bracket.",
                "If 3 or 4 sides, also applies rotational logic for neighbouring sides."
              ]
            },
            "path3": {
              "name": "Two Neighbouring / Three / Four Sides",
              "steps": [
                "Generates primary Body.",
                "Copies Body and rotates 90 degrees around the X-axis.",
                "Applies Y-offset correction based on beam depth."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Contact Validation",
            "errorMessage": "None (Script silently aborts geometry generation if false).",
            "recovery": "Ensure the secondary beam actually physically intersects or touches the main beam within the snapping tolerance."
          },
          {
            "check": "Detail Mode Entity Validity",
            "errorMessage": "None (Instance erases itself).",
            "recovery": "Ensure the selected DetailGenBeam instance exists and is valid."
          },
          {
            "check": "Beam T-Connection Geometry",
            "errorMessage": "None (Loop continues to next beam if connection fails).",
            "recovery": "Select beams that form a valid perpendicular T-junction."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Bracket Model",
            "how": "OPM (Properties Palette) - sModel",
            "effect": "Updates the dimensions of the 3D Body and BOM description immediately upon recalculation."
          },
          {
            "action": "Change Orientation",
            "how": "OPM - nSide",
            "effect": "Rotates the bracket 90 degrees around the beam axis to the next face."
          },
          {
            "action": "Add Multiple Brackets",
            "how": "OPM - sMulti",
            "effect": "Instantiates additional bracket bodies around the connection point (mirroring or rotating the original)."
          },
          {
            "action": "Switch Assignment Target",
            "how": "Right-click Context Menu - 'Assign to...'",
            "effect": "Toggles the logical assignment of the hardware between the Male beam and the Female beam (or their parent Elements). Updates the group hierarchy and BOM listing."
          },
          {
            "action": "Update/Refresh",
            "how": "Right-click Context Menu - 'Update'",
            "effect": "Forces a recalculation of the script, useful if underlying beam geometry has changed manually."
          }
        ]
      },
      "tokens_used": 10457,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# BeA-HVV-Typ1.mcr\n\n## Overview\nThis script automates the insertion and configuration of the BeA HVV Type 1 angle bracket for timber beam connections. It supports T-connections between beams, multi-sided wrapping configurations, and attachment to existing detail components.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in 3D Model Space to generate solid bodies and beam cuts. |\n| Paper Space | No | Not designed for 2D layout or detailing views. |\n| Shop Drawing | No | Does not generate shop drawing views or labels. |\n\n## Prerequisites\n- **Required entities**: Timber Beams or existing TslInst entities (specifically `DetailGenBeam`).\n- **Minimum beam count**: 1 (However, a T-connection typically requires at least 2 intersecting beams to generate geometry correctly).\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `BeA-HVV-Typ1.mcr` from the file dialog.\n\n### Step 2: Configure Properties\nA properties dialog (or the Properties Palette) will appear allowing you to pre-configure the bracket size and insertion mode before selecting objects.\n\n### Step 3: Select Beams\n```\nCommand Line: |Select beams|\nAction: Click on the primary timber beam(s).\n```\n- **If multiple beams are selected**: The script will automatically detect T-connections (perpendicular intersections) and insert brackets at valid intersection points.\n- **If a single beam is selected**: The script enters a special mode attaching to that beam, waiting for further logic or manual connection definition.\n- **If a TslInst is selected**: The script attaches to the existing detail component, using its dimensions for placement.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Side** (nSide) | dropdown | 1 | Defines the mounting face orientation (Top, Right, Bottom, Left) relative to the beam's cross-section. |\n| **Model** (sModel) | dropdown | (First Item) | Selects the specific SKU/size of the bracket (format: Height x Length x Thickness x Width, e.g., 40 x 40 x 2 x 20). |\n| **multiple Insertion** (sMulti) | dropdown | |Single Side| | Determines the wrapping configuration: Single Side, Two opposite Sides, Two neighbouring Sides, Three Sides, or Four Sides. |\n| **dSnap** | number | 20 | The detection tolerance (in mm) for IntelliSnap to find connecting beams. |\n| **sDimStyle** | text | Current Standard DimStyle | Sets the CAD dimension style used if dimensions are generated. |\n| **nColor** | number | 254 | Sets the display color index (0-255) for the 3D bracket body. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Assign to...** | Switches the logical assignment of the hardware between the Main beam, the Female (connecting) beam, or their parent Elements/Groups. Updates the BOM hierarchy. |\n| **Update** | Forces a manual recalculation of the script. Use this if the underlying beam geometry has changed and the hardware has not updated automatically. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external XML settings files; all configuration is handled via OPM properties.\n\n## Tips\n- **Batch Processing**: Select multiple beams at once during insertion to automatically generate brackets for all T-junctions in the selection set.\n- **Adjusting Orientation**: If the bracket appears on the wrong side of the beam, change the `Side` property in the Properties Palette to rotate it 90 degrees around the beam axis.\n- **Corner Connections**: Use the `multiple Insertion` property set to \"Two neighbouring Sides\" or \"Three Sides\" when connecting columns or posts where brackets wrap around the corner.\n\n## FAQ\n- **Q: I selected beams, but no brackets appeared. Why?**\n  A: The beams may not form a valid T-connection within the `dSnap` tolerance. Ensure the secondary beam physically intersects the main beam. Try increasing the `dSnap` value or moving the beams closer together.\n- **Q: How do I change the bracket size after insertion?**\n  A: Select the script instance in the drawing, open the Properties Palette (Ctrl+1), and choose a different size from the `Model` dropdown list.\n- **Q: Can I use this for non-perpendicular connections?**\n  A: This script is optimized for T-connections (perpendicular beams). Results on acute or obtuse angles may be unpredictable."
      },
      "tokens_used": 6386,
      "error": null
    }
  }
}