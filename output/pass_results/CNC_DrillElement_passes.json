{
  "filename": "CNC_DrillElement.mcr",
  "status": "completed",
  "total_tokens": 52549,
  "processing_time": 381.9246995449066,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8223,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses 'tsl.dbCreate(..., _kModelSpace, ...)' during insertion. It operates on 3D geometry by creating 'Drill', 'BeamCut', and 'Cut' tools attached to Beam and Element objects. It checks '_Element.length()' and retrieves beams using 'el.beam()'. No 'sd_' prefixes, '_Viewport' usage, or Paper Space specific logic found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space (requires an Element and its associated Beams to calculate intersections and add tooling)",
          "requiredSettings": [
            "Catalog entries (referenced by _kExecuteKey or _LastInserted)"
          ]
        }
      },
      "tokens_used": 6289,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select set of beams|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select insertion point|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrPoint",
              "promptOriginal": "|Select end point (optional)|",
              "condition": "_bOnInsert",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert when _kExecuteKey is empty or invalid",
            "title": null,
            "dataSource": "Standard TSL Property Dialog",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sVisualize",
            "type": "PropString",
            "displayName": "|Visualization Type|",
            "defaultValue": "|Drill|",
            "inputType": "dropdown",
            "options": [
              "|Drill|",
              "|Symbol|",
              "|Both|",
              "|Elementdrill|",
              "|Mill|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "drillDiameter",
            "type": "PropDouble",
            "displayName": "|Diameter|",
            "defaultValue": "8mm",
            "inputType": "number",
            "options": [],
            "category": "|Drill|",
            "description": null
          },
          {
            "index": 4,
            "variable": "millWidth",
            "type": "PropDouble",
            "displayName": "|Width mill|",
            "defaultValue": "10mm",
            "inputType": "number",
            "options": [],
            "category": "|Mill|",
            "description": null
          },
          {
            "index": 5,
            "variable": "millDepth",
            "type": "PropDouble",
            "displayName": "|Depth mill|",
            "defaultValue": "10mm",
            "inputType": "number",
            "options": [],
            "category": "|Mill|",
            "description": null
          },
          {
            "index": 6,
            "variable": "cutAngle",
            "type": "PropDouble",
            "displayName": "|Cut angle|",
            "defaultValue": "0",
            "inputType": "angle",
            "options": [],
            "category": "|Mill|",
            "description": null
          },
          {
            "index": 7,
            "variable": "cutOffset",
            "type": "PropDouble",
            "displayName": "|Cut offset|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Mill|",
            "description": null
          },
          {
            "index": 1,
            "variable": "dimensionStyle",
            "type": "PropString",
            "displayName": "|Dimension style|",
            "defaultValue": "Standard",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 1,
            "variable": "symbolDiameter",
            "type": "PropDouble",
            "displayName": "|Diameter symbol|",
            "defaultValue": "40mm",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 2,
            "variable": "textSize",
            "type": "PropDouble",
            "displayName": "|Text size|",
            "defaultValue": "30mm",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 0,
            "variable": "colorCircle",
            "type": "PropInt",
            "displayName": "|Color circle|",
            "defaultValue": "4",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 1,
            "variable": "colorLine",
            "type": "PropInt",
            "displayName": "|Color line|",
            "defaultValue": "4",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 2,
            "variable": "colorText",
            "type": "PropInt",
            "displayName": "|Color text|",
            "defaultValue": "7",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 3,
            "variable": "zoneIndex",
            "type": "PropInt",
            "displayName": "|Zone index|",
            "defaultValue": "4",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 4,
            "variable": "toolIndex",
            "type": "PropInt",
            "displayName": "|Tool index|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": null
          },
          {
            "index": 3,
            "variable": "frameOffset",
            "type": "PropDouble",
            "displayName": "|Offset inside frame|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Drill|",
            "description": "|Defines the inside frame offset|"
          },
          {
            "index": 2,
            "variable": "subType",
            "type": "PropString",
            "displayName": "|Subtype|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Markup and measurement|",
            "description": "|Adds a prefix to the dimension subtypes, used to filter on dimension TSLs as HSB_D-Element.|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8824,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the insertion of vertical drilling, slot milling, or annotation symbols into timber beams and elements, with specific support for angled milling cuts and element-level tooling.",
          "category": "Machining/CNC",
          "typicalUseCase": "Used to create vertical utility holes for MEP (electrical/plumbing), slots for connections, or to generate graphical symbols for drill locations in shop drawings."
        },
        "parameters": [
          {
            "name": "sVisualize",
            "technicalDefault": "|Drill|",
            "businessMeaning": "Determines the mode of operation: creates a physical CNC drill hole, a graphical symbol only, both, an element-level drill, or a milled slot with angled cuts.",
            "validRange": "List Selection: Drill, Symbol, Both, Elementdrill, Mill",
            "unit": "enum",
            "affectsOutput": "Switches the script logic entirely. It determines whether geometric tooling (Drill/BeamCut/ElemDrill) or graphical entities (PLine/Text) are generated."
          },
          {
            "name": "drillDiameter",
            "technicalDefault": "8mm",
            "businessMeaning": "The physical diameter of the hole to be drilled.",
            "validRange": "6mm - 50mm (Standard drill bit sizes)",
            "unit": "mm",
            "affectsOutput": "Controls the diameter of the Drill or ElemDrill object. Larger diameters remove more material."
          },
          {
            "name": "millWidth",
            "technicalDefault": "10mm",
            "businessMeaning": "The width of the rectangular slot (milling cut).",
            "validRange": "10mm - 300mm",
            "unit": "mm",
            "affectsOutput": "Defines the Y-axis width of the BeamCut when Visualization is set to 'Mill'."
          },
          {
            "name": "millDepth",
            "technicalDefault": "10mm",
            "businessMeaning": "The depth of the rectangular slot cut into the beam face.",
            "validRange": "5mm - Beam Depth",
            "unit": "mm",
            "affectsOutput": "Defines the depth of the BeamCut. Affects how far into the beam the mill penetrates."
          },
          {
            "name": "cutAngle",
            "technicalDefault": "0",
            "businessMeaning": "The angle of the saw cut applied at the ends of the milled slot relative to the beam axis.",
            "validRange": "0 - 90 degrees",
            "unit": "degrees",
            "affectsOutput": "Rotates the normal vector of the 'Cut' planes generated at the start and end of the slot."
          },
          {
            "name": "cutOffset",
            "technicalDefault": "0",
            "businessMeaning": "The distance the angled end cuts are shifted inward from the theoretical end of the slot.",
            "validRange": "0mm - Slot Length/2",
            "unit": "mm",
            "affectsOutput": "Moves the start/end points of the angled cuts along the beam axis."
          },
          {
            "name": "frameOffset",
            "technicalDefault": "0",
            "businessMeaning": "The distance the drill stops short of the opposite face (creating a blind hole) or an offset from the start face.",
            "validRange": "0mm - Element Length",
            "unit": "mm",
            "affectsOutput": "Modifies the end point of the drill. If > 0, the drill does not go all the way through the element."
          },
          {
            "name": "symbolDiameter",
            "technicalDefault": "40mm",
            "businessMeaning": "The visual size of the circle drawn to represent the hole in 2D drawings.",
            "validRange": "10mm - 100mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the radius of the PLine circle drawn when Visualization is 'Symbol' or 'Both'."
          },
          {
            "name": "textSize",
            "technicalDefault": "30mm",
            "businessMeaning": "The height of the dimension or annotation text associated with the drill symbol.",
            "validRange": "10mm - 50mm",
            "unit": "mm",
            "affectsOutput": "Sets the text height in the Display properties."
          },
          {
            "name": "zoneIndex",
            "technicalDefault": "4",
            "businessMeaning": "Specifies the logical zone (layer/grouping) within the element to which the tooling is assigned.",
            "validRange": "0 - 100",
            "unit": "integer",
            "affectsOutput": "Used by the `ElemDrill` command to associate the drill with a specific element zone coordinate system."
          },
          {
            "name": "toolIndex",
            "technicalDefault": "1",
            "businessMeaning": "The identifier for the specific CNC tool (drill bit) to be used in the machine.",
            "validRange": "1 - 999",
            "unit": "integer",
            "affectsOutput": "Passed to the CNC data export (ElemDrill) to tell the machine which tool to load."
          },
          {
            "name": "subType",
            "technicalDefault": "",
            "businessMeaning": "A filter tag used to group or filter this specific drill in other scripts (e.g., dimensioning or BOM scripts).",
            "validRange": "String (Alphanumeric)",
            "unit": "string",
            "affectsOutput": "Written to the 'DimInfo' map; does not change geometry but affects data processing downstream."
          },
          {
            "name": "colorCircle",
            "technicalDefault": "4",
            "businessMeaning": "CAD Color index for the drill circle symbol.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Display color of the circle PLine."
          },
          {
            "name": "colorLine",
            "technicalDefault": "4",
            "businessMeaning": "CAD Color index for the centerline of the drill.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Display color of the center PLine."
          },
          {
            "name": "colorText",
            "technicalDefault": "7",
            "businessMeaning": "CAD Color index for the annotation text.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Display color of the text entities."
          },
          {
            "name": "dimensionStyle",
            "technicalDefault": "Standard",
            "businessMeaning": "The drafting style (font, arrow style) used for dimensions and text.",
            "validRange": "Valid hsbCAD Dimension Styles",
            "unit": "string",
            "affectsOutput": "Sets the visual appearance of the text/dimensions."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sVisualize = 'Mill'",
            "effect": "Enables milling parameters and ignores standard drill parameters.",
            "cascade": [
              "millWidth",
              "millDepth",
              "cutAngle",
              "cutOffset"
            ]
          },
          {
            "trigger": "sVisualize = 'Elementdrill'",
            "effect": "Switches logic to Element-level drilling rather than single beam drilling.",
            "cascade": [
              "zoneIndex",
              "toolIndex",
              "frameOffset"
            ]
          },
          {
            "trigger": "sVisualize = 'Symbol' or 'Both'",
            "effect": "Activates graphical representation properties.",
            "cascade": [
              "symbolDiameter",
              "textSize",
              "colorCircle",
              "colorLine",
              "colorText",
              "dimensionStyle"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Drill",
            "description": "A cylindrical hole through the beam.",
            "appliedTo": "Individual GenBeams"
          },
          {
            "type": "ElemDrill",
            "description": "A cylindrical hole defined at the Element level (Wall/Floor), typically used for through-drills in assembled walls.",
            "appliedTo": "Element"
          },
          {
            "type": "BeamCut",
            "description": "A rectangular volume removed from the beam (Slotting).",
            "appliedTo": "GenBeams (where sVisualize is 'Mill')"
          },
          {
            "type": "Cut",
            "description": "Planar cuts at the ends of the milled slot to create angles (e.g., for housing tenons or angled supports).",
            "appliedTo": "GenBeams (where sVisualize is 'Mill')"
          },
          {
            "type": "PLine / Text",
            "description": "2D geometry representing the hole location, size, and dimensions in the model.",
            "appliedTo": "ModelSpace (Visuals)"
          }
        ]
      },
      "tokens_used": 9715,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch/Insertion",
          "2. [Insertion Phase] Check ExecuteKey/Catalog",
          "3. [Insertion Phase] Prompt user to select a set of beams",
          "4. [Insertion Phase] Prompt user for Insertion Point (Start)",
          "5. [Insertion Phase] Prompt user for End Point (Optional). If skipped, calculate projection to frame.",
          "6. [Insertion Phase] Loop through selected beams: Project points to beam/element geometry and create TSL instance",
          "7. [Calculation Phase] Validate Element and Point Geometry exist",
          "8. [Calculation Phase] Normalize points: Ensure Start point is 'highest' relative to Element Z",
          "9. [Calculation Phase] Apply frameOffset to End point",
          "10. [Calculation Phase] Branch based on Visualization Type (sVisualize)",
          "11. [Branch Elementdrill] Calculate depth relative to Zone, add ElemDrill to Element, End Script",
          "12. [Branch Drill/Symbol/Mill] Create virtual Drill body for intersection testing",
          "13. [Branch Drill/Symbol/Mill] Iterate through Element Beams (Filtering by HSB ID if auto-inserted)",
          "14. [Branch Drill/Symbol/Mill] Check Intersection between Virtual Drill and Beam Envelope",
          "15. [If Intersection Found] Execute specific logic based on Visualization Type (Add Tooling vs Draw Graphics)",
          "16. [If Intersection Found] Export Data to Maps (BOM, DimInfo) and assign Beam reference",
          "17. [Completion] Keep or Erase instance based on success of intersection"
        ],
        "conditionalBranches": [
          {
            "condition": "Script State (_bOnInsert)",
            "path1": {
              "name": "Insertion Flow",
              "steps": [
                "Show Dialog if _kExecuteKey is missing/invalid",
                "Select Beams (Set)",
                "Select Insertion Point",
                "Select End Point (Optional)",
                "Project points to valid planes",
                "Create Instance",
                "Erase Temporary Instance"
              ]
            },
            "path2": {
              "name": "Execution/Recalc Flow",
              "steps": [
                "Validate Inputs",
                "Normalize Points (Start/End)",
                "Apply Offsets",
                "Filter Beams",
                "Generate Tooling/Graphics",
                "Update Maps"
              ]
            }
          },
          {
            "condition": "Visualization Type (sVisualize)",
            "path1": {
              "name": "Elementdrill (Index 3)",
              "steps": [
                "Adjust Start Point to Zone Coordinate System",
                "Calculate depth using frameOffset",
                "Create and Add ElemDrill tool to Element",
                "Visualize Start/End points",
                "Stop script (Return)"
              ]
            },
            "path2": {
              "name": "Beam Level Processing (Drill, Symbol, Both, Mill)",
              "steps": [
                "Create Virtual Drill Body",
                "Loop Beams in Element",
                "Check Intersection",
                "Apply specific tooling (Drill/BeamCut/Cut) or Graphics (PLine/Text)",
                "Update BOM/Dimension Maps"
              ]
            }
          },
          {
            "condition": "End Point Selection",
            "path1": {
              "name": "User Defined",
              "steps": [
                "Use coordinates from user input"
              ]
            },
            "path2": {
              "name": "Calculated (Default)",
              "steps": [
                "Project insertion point to Element frame bottom/inside to determine End Point"
              ]
            }
          },
          {
            "condition": "Beam Intersection in Mill Mode (sVisualize == 'Mill')",
            "path1": {
              "name": "Valid Structural Beam (HSB ID 4110)",
              "steps": [
                "Calculate Slot Geometry (Width/Depth)",
                "Add BeamCut tool",
                "Calculate Angled Vectors based on cutAngle",
                "Add Cut tool (Start)",
                "Add Cut tool (End)"
              ]
            },
            "path2": {
              "name": "Other Beam ID",
              "steps": [
                "Skip beam (Continue loop)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Intersection between insertion line and beam plane",
            "errorMessage": "Notice: 'No intersection with line found.'",
            "recovery": "Script erases the instance and stops. User must pick a point that intersects the beam plane."
          },
          {
            "check": "Element Existence",
            "errorMessage": "None (Silent fail)",
            "recovery": "Script erases instance if attached element is missing or empty."
          },
          {
            "check": "Point Geometry (_PtG) Existence",
            "errorMessage": "None (Silent fail)",
            "recovery": "Script erases instance if geometry points are missing."
          },
          {
            "check": "Beam Intersection Found",
            "errorMessage": "None (Silent fail)",
            "recovery": "If the virtual drill body does not intersect any beam in the element, the script erases itself."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Drill Diameter / Mill Dimensions",
            "how": "OPM (Object Properties Palette)",
            "effect": "Updates the size of the generated Drill or BeamCut. Triggers recalculation of intersections."
          },
          {
            "action": "Switch Visualization Type",
            "how": "OPM Dropdown (sVisualize)",
            "effect": "Switches between physical tooling (Drill/Mill), graphical symbols, or Both. If switching to 'Elementdrill', beam-level tools are removed and replaced with Element-level tooling."
          },
          {
            "action": "Adjust Offset/Angle",
            "how": "OPM (frameOffset, cutOffset, cutAngle)",
            "effect": "Modifies the position of the drill end point or the angle of the cuts in Mill mode."
          },
          {
            "action": "Move Script Instance",
            "how": "Grip Edit (Move)",
            "effect": "Updates _Pt0 and _PtG (Start/End points), effectively moving the hole/slot along the beam/element."
          }
        ]
      },
      "tokens_used": 11273,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# CNC_DrillElement.mcr\n\n## Overview\nAutomates the insertion of vertical drilling, slot milling, or annotation symbols into timber beams and elements. It supports creating physical CNC tooling (drills and slots), graphical symbols for drawings, or both simultaneously.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates on 3D beams and elements. |\n| Paper Space | No | Not designed for 2D layout or detailing space. |\n| Shop Drawing | No | Generates 3D tooling and symbols, but does not create shop drawing views directly. |\n\n## Prerequisites\n- **Required Entities**: An existing `Element` (Wall/Floor) containing `GenBeams`.\n- **Minimum Beam Count**: 1 (Must select a set of beams during insertion).\n- **Required Settings**: None required for basic use, though Catalog entries can preset parameters.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `CNC_DrillElement.mcr` from the list.\n\n### Step 2: Select Beams\n```\nCommand Line: Select set of beams\nAction: Click to select the beam(s) you wish to drill or mill, then press Enter.\n```\n\n### Step 3: Select Insertion Point\n```\nCommand Line: Select insertion point\nAction: Click on the face or surface of the beam/element where the drill center should start.\n```\n\n### Step 4: Select End Point (Optional)\n```\nCommand Line: Select end point (optional)\nAction: Click to define the end point of the drill/slot.\nNote: If skipped, the script projects the drill through the element automatically.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Visualization Type** | dropdown | Drill | Determines the operation mode: **Drill** (Physical hole), **Mill** (Slot), **Symbol** (2D drawing only), **Both** (Physical hole + 2D), or **Elementdrill** (Wall-level tooling). |\n| **Diameter** | number | 8mm | The diameter of the drill hole. |\n| **Offset inside frame** | number | 0mm | Stops the drill short of the opposite face (blind hole) or offsets it from the start. |\n| **Subtype** | text | | Prefix for dimension subtypes; used to filter drills in other scripts. |\n| **Width mill** | number | 10mm | Width of the slot (only active when Visualization is *Mill*). |\n| **Depth mill** | number | 10mm | Depth of the slot cut into the beam face (only active when Visualization is *Mill*). |\n| **Cut angle** | angle | 0° | Angle of the saw cut at the ends of the slot (0-90 degrees, only active for *Mill*). |\n| **Cut offset** | number | 0mm | Distance the angled end cuts are shifted inward (only active for *Mill*). |\n| **Dimension style** | dropdown | Standard | Drafting style used for dimensions and text. |\n| **Diameter symbol** | number | 40mm | Visual size of the drill circle in 2D drawings. |\n| **Text size** | number | 30mm | Height of the annotation text. |\n| **Color circle** | number | 4 | CAD Color index for the drill circle symbol. |\n| **Color line** | number | 4 | CAD Color index for the centerline. |\n| **Color text** | number | 7 | CAD Color index for annotation text. |\n| **Zone index** | number | 4 | Logical zone/grouping within the element (used for Elementdrill). |\n| **Tool index** | number | 1 | Identifier for the CNC tool to be used (used for Elementdrill). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None specific* | This script relies on the Properties Palette (OPM) for configuration and standard AutoCAD grips for movement. |\n\n## Settings Files\n- **Filename**: None specified.\n- **Purpose**: This script uses standard TSL properties and does not depend on external XML settings files for basic functionality.\n\n## Tips\n- **Switching Modes**: Use the **Visualization Type** property to toggle between creating a real CNC hole (Drill) and just drawing a symbol (Symbol) for planning purposes.\n- **Angled Slots**: Select **Mill** as the Visualization Type to create slots. Use the **Cut angle** parameter to create angled ends (e.g., for housing tenons).\n- **Moving Holes**: You can select the script instance in the model and use the **Grip Edit** (Move) command to slide the drill along the beam to a new position.\n- **Element Drills**: If you need a drill that goes through multiple layers of a wall (e.g., MEP vertical shafts), set **Visualization Type** to **Elementdrill**.\n\n## FAQ\n- **Q: Why did the script instance disappear after I moved it?**\n  **A:** The script automatically erases itself if it no longer intersects with the beam geometry. Ensure you move the grip point back onto the beam surface.\n- **Q: Can I use this for horizontal drilling?**\n  **A:** This script is designed for drilling perpendicular to the beam face or through the element Z-axis (vertical). It is not intended for long-axis horizontal drilling.\n- **Q: What happens if I don't select an end point?**\n  **A:** The script will calculate the end point by projecting the insertion point through the element frame, effectively creating a through-hole."
      },
      "tokens_used": 8225,
      "error": null
    }
  }
}