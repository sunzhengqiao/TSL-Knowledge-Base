{
  "filename": "HSB_E-MachineDatum.mcr",
  "status": "completed",
  "total_tokens": 43542,
  "processing_time": 296.8536071777344,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 1,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "Tsl to show the datum position.",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "26.09.2016",
            "author": "",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "03.03.2017",
            "author": "",
            "changes": "Add description to filter option."
          },
          {
            "version": "1.02",
            "date": "08.01.2018",
            "author": "",
            "changes": "Add  option to draw a block on datum"
          },
          {
            "version": "1.03",
            "date": "08.01.2018",
            "author": "",
            "changes": "Add  option to draw a block on datum also on the model"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6385,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script includes logic to handle both Element attachment ('_Element') and Viewport insertion ('_Viewport'). It checks 'if (_Viewport.length() > 0)' and applies a coordinate system transform 'ms2ps = _Viewport[0].coordSys()' for Paper Space display. It also uses 'dbCreate(..., _kModelSpace, ...)' when attaching to elements."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (when attached to an Element) or Paper Space (when inserted into a Viewport)",
          "requiredSettings": [
            "HSB_G-FilterGenBeams"
          ]
        }
      },
      "tokens_used": 5446,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "|Select elements| |<Enter> to select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "selectedElements.length() < 1",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "During script insertion",
            "title": null,
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "flipDirection",
            "type": "PropString",
            "displayName": "|Flip direction|",
            "defaultValue": "|None|",
            "inputType": "dropdown",
            "options": [
              "|None|",
              "|Flip over X|",
              "|Flip over Y|",
              "|Flip over X and Y|"
            ],
            "category": "|Orientation|",
            "description": null
          },
          {
            "index": 0,
            "variable": "rotation",
            "type": "PropDouble",
            "displayName": "|Rotation|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              0,
              90,
              180,
              270
            ],
            "category": "|Orientation|",
            "description": null
          },
          {
            "index": 0,
            "variable": "filterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "Dynamic: HSB_G-FilterGenBeams catalogs"
            ],
            "category": "|Filter|",
            "description": "|Filter definition.| |Use| HSB_G-FilterGenBeams |to define the filters|."
          },
          {
            "index": 2,
            "variable": "machineName",
            "type": "PropString",
            "displayName": "|Machine name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 1,
            "variable": "datumSymbolSize",
            "type": "PropDouble",
            "displayName": "|Symbol size|",
            "defaultValue": 1000,
            "inputType": "number",
            "options": [],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 2,
            "variable": "datumTextSize",
            "type": "PropDouble",
            "displayName": "|Text size|",
            "defaultValue": 100,
            "inputType": "number",
            "options": [],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 0,
            "variable": "datumColor",
            "type": "PropInt",
            "displayName": "|Symbol color|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 1,
            "variable": "zoneIndexProp",
            "type": "PropInt",
            "displayName": "|Zone index|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              0,
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10
            ],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 3,
            "variable": "zoneLayer",
            "type": "PropString",
            "displayName": "|Layer|",
            "defaultValue": "Tooling",
            "inputType": "dropdown",
            "options": [
              "Tooling",
              "Information",
              "Zone",
              "Element"
            ],
            "category": "|Machine datum|",
            "description": null
          },
          {
            "index": 4,
            "variable": "blockName",
            "type": "PropString",
            "displayName": "|Select a Block|",
            "defaultValue": "|None|",
            "inputType": "dropdown",
            "options": [
              "Dynamic: _BlockNames"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7684,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a visual Machine Datum (Zero Point) symbol based on the bounding box of filtered beams within an Element, displayed in either Model Space or on a Layout Viewport.",
          "category": "Production Preparation / Shop Drawings",
          "typicalUseCase": "Used by draftsmen to indicate the CNC machine reference point (origin) on wall panels or floor cassettes to ensure alignment between digital models and physical production."
        },
        "parameters": [
          {
            "name": "flipDirection",
            "technicalDefault": "|None|",
            "businessMeaning": "Defines if the machine coordinate system needs to be mirrored relative to the element's local coordinate system. Used when the machine's 'front' is opposite to the drawing's 'front'.",
            "validRange": "None, Flip over X, Flip over Y, Flip over X and Y",
            "unit": "enum",
            "affectsOutput": "Inverts the calculated origin and axes direction of the datum symbol."
          },
          {
            "name": "rotation",
            "technicalDefault": 0,
            "businessMeaning": "Rotates the datum coordinate system around the element's Z-axis. Used to align the machine axes with specific element features (e.g., rotating 90 deg if the element is processed sideways).",
            "validRange": "0, 90, 180, 270",
            "unit": "degrees",
            "affectsOutput": "Rotates the orientation of the drawn symbol and text labels."
          },
          {
            "name": "filterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Selects a subset of beams (e.g., 'Structural only', 'Cladding') within the element to define the bounding box. The datum is calculated based on the extents of these specific beams.",
            "validRange": "Any catalog entry from HSB_G-FilterGenBeams",
            "unit": "string",
            "affectsOutput": "Changes the position of the datum origin. Including more beams expands the bounding box, potentially moving the datum."
          },
          {
            "name": "machineName",
            "technicalDefault": "",
            "businessMeaning": "The label text displayed next to the datum symbol identifying the specific machine or process (e.g., 'WEINMANN', ' Hundegger').",
            "validRange": "Short alphanumeric string",
            "unit": "text",
            "affectsOutput": "Text content displayed at the datum point."
          },
          {
            "name": "datumSymbolSize",
            "technicalDefault": "1000",
            "businessMeaning": "The length of the axis lines (crosshair) representing the datum. Controls visual prominence in drawings.",
            "validRange": "100 - 5000 (depending on drawing scale)",
            "unit": "mm",
            "affectsOutput": "Geometry length of the X, Y, and Z axis lines."
          },
          {
            "name": "datumTextSize",
            "technicalDefault": "100",
            "businessMeaning": "The height of the text label for the machine name.",
            "validRange": "20 - 500",
            "unit": "mm",
            "affectsOutput": "Size of the text label."
          },
          {
            "name": "datumColor",
            "technicalDefault": 1,
            "businessMeaning": "The CAD color index used to draw the symbol and text. Used to distinguish machine data from structural geometry.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "color index",
            "affectsOutput": "Visual color of the symbol and text."
          },
          {
            "name": "zoneIndexProp",
            "technicalDefault": 0,
            "businessMeaning": "Assigns the graphical output to a specific production zone. Used for filtering elements in production lists or CNC exports.",
            "validRange": "0 - 10",
            "unit": "integer",
            "affectsOutput": "Zone property assigned to the generated graphical entities."
          },
          {
            "name": "zoneLayer",
            "technicalDefault": "Tooling",
            "businessMeaning": "The CAD layer on which the datum symbol is drawn.",
            "validRange": "Tooling, Information, Zone, Element",
            "unit": "layer",
            "affectsOutput": "Layer assignment of the generated graphical entities."
          },
          {
            "name": "blockName",
            "technicalDefault": "|None|",
            "businessMeaning": "Allows using a custom CAD Block (symbol) instead of the default XYZ crosshair. Useful for company logos or specific machine icons.",
            "validRange": "Any loaded block name in the drawing",
            "unit": "string",
            "affectsOutput": "Replaces the default 3D lines with the selected Block geometry."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "blockName is set to a specific Block",
            "effect": "The default PLine crosshair drawing is skipped, and the Block is drawn instead. 'datumSymbolSize' is effectively ignored for the symbol geometry (though text remains).",
            "cascade": [
              "datumSymbolSize"
            ]
          },
          {
            "trigger": "filterDefinition changes",
            "effect": "Changes the set of beams used to calculate the bounding box vertices.",
            "cascade": [
              "machineOrg"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Graphic (PLine or Block)",
            "description": "Visual representation of the machine axes (X, Y, Z) or a custom block inserted at the calculated bounding box minimum point.",
            "appliedTo": "Model Space (if attached to Element) or Paper Space (if inserted via Viewport)."
          },
          {
            "type": "Text",
            "description": "Label displaying the 'Machine Name' at the datum origin.",
            "appliedTo": "Model Space or Paper Space."
          }
        ]
      },
      "tokens_used": 7937,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script inserted via command or execute key",
          "Check if insertCycleCount > 1 (multiple instances). If true, erase duplicate and stop.",
          "Check if execute key is valid. If not, show property dialog (showDialog).",
          "Set internal catalog to '_LastInserted'.",
          "Prompt user to select Elements (PrEntity) or press Enter to select a Viewport.",
          "[Branch] If Elements selected: Loop through selection, create new script instances attached to Elements in Model Space, erase temporary instance.",
          "[Branch] If no Elements selected: Prompt user to select a Viewport (getViewport). Script attaches to Viewport instance.",
          "Determine Source Element: if _Element[0] exists use it; otherwise use Element linked to selected Viewport.",
          "Validate Source Element validity. If invalid, show warning and erase instance.",
          "Calculate Element Local Coordinate System (CoordSys el).",
          "Apply Flip Transformation based on 'flipDirection' property to create Machine Coordinate System.",
          "Apply Rotation Transformation based on 'rotation' property to Machine Coordinate System.",
          "Filter GenBeams within Element using 'filterDefinition' and 'HSB_G-FilterGenBeams'.",
          "[Branch] If Filtering fails: Report warning and erase instance.",
          "Collect vertices from filtered GenBeam real bodies.",
          "Project vertices onto Machine X, Y, and Z axes to find minimum extents.",
          "Calculate 'machineOrg' (Datum Point) from the minimum projected vertices.",
          "Define Datum Lines (PLine) from origin along X, Y, Z axes scaled by 'datumSymbolSize'.",
          "Set Display properties (color, zone, layer, text size).",
          "[Branch] Check if attached to Viewport (Paper Space) or Model Space.",
          "[Branch] Check if 'blockName' is valid (exists in drawing).",
          "Draw Geometry: If Block valid, draw Block at 'machineOrg'. Else, draw Datum Lines.",
          "Draw Machine Name Text at calculated origin.",
          "Finish execution."
        ],
        "conditionalBranches": [
          {
            "condition": "User Input Selection Mode",
            "path1": {
              "name": "Element Mode",
              "steps": [
                "User picks one or more Elements",
                "Script spawns new instances for each Element into Model Space",
                "Original temporary instance is erased",
                "Spawned instances calculate geometry based on specific Element"
              ]
            },
            "path2": {
              "name": "Viewport Mode (Paper Space)",
              "steps": [
                "User presses Enter at Element prompt",
                "User selects a Viewport",
                "Script attaches to Viewport instance",
                "Geometry is calculated based on Viewport's linked Element",
                "Output is transformed from Model Space to Paper Space using Viewport CoordSys"
              ]
            }
          },
          {
            "condition": "Flip Direction Setting",
            "path1": {
              "name": "No Flip (Index 0)",
              "steps": [
                "Machine Coordinate System matches Element Coordinate System"
              ]
            },
            "path2": {
              "name": "Flip X (Index 1)",
              "steps": [
                "Align System: Y and Z axes inverted relative to Element"
              ]
            },
            "path3": {
              "name": "Flip Y (Index 2)",
              "steps": [
                "Align System: X and Z axes inverted relative to Element"
              ]
            },
            "path4": {
              "name": "Flip X and Y (Index 3)",
              "steps": [
                "Align System: X and Y axes inverted relative to Element, Z remains same"
              ]
            }
          },
          {
            "condition": "Output Geometry Type",
            "path1": {
              "name": "Custom Block",
              "steps": [
                "Check if 'blockName' exists in _BlockNames",
                "Create Block object",
                "Draw Block at calculated origin using proper orientation vectors",
                "Skip drawing of standard Datum Lines (Crosshair)"
              ]
            },
            "path2": {
              "name": "Standard Symbol",
              "steps": [
                "Default behavior (Block not found or 'None' selected)",
                "Create PLine for X, Y, and Z axes",
                "Draw Lines starting at origin extending by 'datumSymbolSize'"
              ]
            }
          },
          {
            "condition": "Output Space",
            "path1": {
              "name": "Model Space (Element)",
              "steps": [
                "Geometry calculated in global coordinates",
                "Drawn directly to Model Space",
                "No coordinate transform applied before drawing"
              ]
            },
            "path2": {
              "name": "Paper Space (Viewport)",
              "steps": [
                "Retrieve Viewport Coordinate System (ms2ps)",
                "Transform Datum Lines and Block origin by ms2ps",
                "Normalize orientation vectors for Text display",
                "Draw to Paper Space"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Validity",
            "errorMessage": "|Selected element is not valid.|",
            "recovery": "User must select a valid Element or Viewport linked to an Element. Script instance is erased if invalid."
          },
          {
            "check": "Filter Execution",
            "errorMessage": "|Beams could not be filtered!| |Make sure that the tsl| HSB_G-FilterGenBeams |is loaded in the drawing|.",
            "recovery": "Ensure 'HSB_G-FilterGenBeams' script is loaded/available in the drawing and a valid filter catalog is selected."
          },
          {
            "check": "Vertex Availability",
            "errorMessage": "No vertices found (Implicit stop)",
            "recovery": "Ensure the Element contains GenBeams that match the filter definition and have valid geometry (realBody). Script stops silently if vertices list is empty."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Orientation",
            "how": "OPM Properties Palette",
            "effect": "Changing 'flipDirection' or 'rotation' recalculates the machine coordinate system and redraws the symbol rotated/mirrored."
          },
          {
            "action": "Adjust Filter",
            "how": "OPM Properties Palette -> Filter definition",
            "effect": "Changing the filter re-evaluates which GenBeams are included in the bounding box calculation, potentially shifting the datum position."
          },
          {
            "action": "Change Visual Style",
            "how": "OPM Properties Palette",
            "effect": "Updating 'datumSymbolSize', 'datumTextSize', 'datumColor', or 'blockName' immediately updates the graphical representation."
          },
          {
            "action": "Move/Update",
            "how": "Grip Edit or Element modification",
            "effect": "Script is parametric. If the Element or its beams change size, the datum position updates automatically on the next recalculation."
          }
        ]
      },
      "tokens_used": 8791,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-MachineDatum\n\n## Overview\nThis script generates a visual Machine Datum (Zero Point) symbol for timber elements (walls or floors). It calculates the datum position based on the bounding box of filtered beams within an element and displays it in either Model Space or on a Layout Viewport, serving as a reference for CNC production alignment.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Attach directly to Elements to show the datum in 3D model views. |\n| Paper Space | Yes | Attach to a Viewport to project the datum into 2D drawings. |\n| Shop Drawing | No | This is a standard insertion script, not an automatic shop drawing generation script. |\n\n## Prerequisites\n- **Required Entities**: An Element (Wall/Floor) containing GenBeams.\n- **Minimum Beam Count**: 1 (Must have beams to calculate a bounding box).\n- **Required Settings**: The script `HSB_G-FilterGenBeams` must be loaded in the drawing to allow beam filtering.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-MachineDatum.mcr`\n*   A properties dialog may appear automatically to configure initial settings.\n\n### Step 2: Select Element or Viewport\n```\nCommand Line: Select elements | <Enter> to select a viewport\nAction: \n    - To place in Model Space: Click on the desired Element(s).\n    - To place in Paper Space: Press Enter.\n```\n\n### Step 3: Select Viewport (If using Paper Space)\n```\nCommand Line: Select a viewport\nAction: Click inside the viewport frame where you want the datum visible.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Flip direction | dropdown | None | Mirrors the datum coordinate system relative to the element (e.g., Flip over X if machining from the back). |\n| Rotation | dropdown | 0 | Rotates the symbol around the element's Z-axis (0, 90, 180, 270 degrees). |\n| Filter definition | dropdown | [Dynamic] | Selects a specific subset of beams (e.g., \"Structural only\") to determine the datum position. |\n| Machine name | text | [Blank] | Text label displayed next to the symbol (e.g., \"WEINMANN\"). |\n| Symbol size | number | 1000 | Length of the axis lines (crosshair) in millimeters. |\n| Text size | number | 100 | Height of the machine name text in millimeters. |\n| Symbol color | number | 1 | AutoCAD color index for the symbol and text (Default: Red). |\n| Zone index | dropdown | 0 | Assigns the output to a specific production zone index (0-10). |\n| Layer | dropdown | Tooling | The CAD layer on which the symbol is drawn (Tooling, Information, Zone, Element). |\n| Select a Block | dropdown | None | Allows choosing a custom CAD block (e.g., company logo) instead of the standard crosshair. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom items to the right-click menu. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **External Dependency**: `HSB_G-FilterGenBeams`\n- **Purpose**: This script relies on catalogs defined in the Filter script to determine which beams are included in the bounding box calculation. Ensure the appropriate filter catalogs are available.\n\n## Tips\n- **Filtering**: Use the *Filter definition* to exclude cladding or sheathing if you only want the datum to reference the structural timber frame.\n- **Logos**: You can replace the standard crosshair with your company logo by selecting the block name in the *Select a Block* property.\n- **Visual Alignment**: If the datum appears on the wrong corner of the element, use the *Flip direction* or *Rotation* properties to adjust the orientation without moving the element.\n- **Paper Space**: When inserting into a viewport, ensure the viewport is linked to a valid Element; otherwise, the script will not generate geometry.\n\n## FAQ\n- **Q: I get an error \"Beams could not be filtered!\"**\n  A: Ensure the script `HSB_G-FilterGenBeams` is loaded in your drawing (via `TSLSCRIPTLOAD` or similar project loading routine). This script is required to find the beams.\n- **Q: Can I move the datum manually?**\n  A: No, the position is calculated parametrically based on the beams. To change the position, modify the *Filter definition* to include/exclude specific beams, or adjust the *Flip/Rotation* settings.\n- **Q: Why did the script disappear after insertion?**\n  A: This can happen if no valid vertices were found (e.g., the element was empty) or if the insertion was a duplicate. Check your command line history for warning messages."
      },
      "tokens_used": 7299,
      "error": null
    }
  }
}