{
  "filename": "HSB_E-Markerlines.mcr",
  "status": "completed",
  "total_tokens": 43315,
  "processing_time": 239.87553334236145,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7493,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses _kModelSpace in tsl.dbCreate. It operates on Element and GenBeam entities from the 3D model and uses el.addTool() to attach data. It lacks 'sd_' prefixes, Viewport handling, or _Entity[] arrays typically found in ShopDrawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "HSB_G-FilterGenBeams (TSL must be loaded)",
            "Painter definitions (if Painter is not disabled)"
          ]
        }
      },
      "tokens_used": 3834,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select a set of elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "_bOnInsert && (_kExecuteKey == \"\" || arSCatalogNames.find(_kExecuteKey) == -1)",
            "title": null,
            "dataSource": "Property Map",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "|Selection|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sApplyToolingToElementType",
            "type": "PropString",
            "displayName": "     |Apply tooling to element type(s)|",
            "defaultValue": "Roof",
            "inputType": "dropdown",
            "options": [
              "Roof",
              "Floor",
              "Wall",
              "Roof;Floor",
              "Roof;Wall",
              "Floor;Wall",
              "Roof;Floor;Wall"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sFilterBC",
            "type": "PropString",
            "displayName": "     |Filter beams with beamcode|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sExcludeModule",
            "type": "PropString",
            "displayName": "     |Exclude modules|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "filterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition beams|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": "|Filter definition for beams.|.Use| HSB_G-FilterGenBeams |to define the filters|."
          },
          {
            "index": 7,
            "variable": "sPainter",
            "type": "PropString",
            "displayName": "|Genbeam Painter|",
            "defaultValue": "|Genbeam Painter|",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": "|Defines the Painter definition to filter genbeams|"
          },
          {
            "index": 3,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "|Tooling|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dMarkSize",
            "type": "PropDouble",
            "displayName": "     |Length markerline|",
            "defaultValue": 300,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dMarkOffset",
            "type": "PropDouble",
            "displayName": "     |Offset markerline|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sApplyToolingTo",
            "type": "PropString",
            "displayName": "     |Apply tooling to|",
            "defaultValue": "Zone 1",
            "inputType": "dropdown",
            "options": [
              "Zone 1",
              "Zone 2",
              "Zone 3",
              "Zone 4",
              "Zone 5",
              "Zone 6",
              "Zone 7",
              "Zone 8",
              "Zone 9",
              "Zone 10"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sToolingDirection",
            "type": "PropString",
            "displayName": "     |Direction|",
            "defaultValue": "|Vertical|",
            "inputType": "dropdown",
            "options": [
              "|Vertical|",
              "|Horizontal|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nToolingIndex",
            "type": "PropInt",
            "displayName": "     |Toolindex|",
            "defaultValue": 10,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6542,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates layout or machining marker lines on specific structural members (studs, rafters, joists) at their intersection with a selected element zone.",
          "category": "Machining/Tooling",
          "typicalUseCase": "Marking the positions of studs or rafters on top/bottom plates or rim beams in Wall/Floor/Roof elements to guide manual assembly or CNC cutting operations."
        },
        "parameters": [
          {
            "name": "sApplyToolingToElementType",
            "technicalDefault": "Roof",
            "businessMeaning": "Specifies the type of building elements to process, preventing the script from running on unintended structure types (e.g., ignoring walls when processing floors).",
            "validRange": "List: Roof, Floor, Wall, or combinations (e.g., 'Roof;Floor')",
            "unit": "String",
            "affectsOutput": "Controls whether the script processes the selected element or skips it based on the element's geometric orientation."
          },
          {
            "name": "sFilterBC",
            "technicalDefault": "",
            "businessMeaning": "Defines a list of beam codes to EXCLUDE from processing. If a beam's code matches an entry in this list, it will not receive marker lines.",
            "validRange": "String list of beam codes separated by semicolons (;)",
            "unit": "String",
            "affectsOutput": "Removes specific beams (e.g., 'BLOCKING', 'CRIPPLE') from the set of beams receiving marks."
          },
          {
            "name": "sExcludeModule",
            "technicalDefault": "|No|",
            "businessMeaning": "Determines whether beams that are part of a pre-defined module (sub-assembly) should be ignored.",
            "validRange": "|Yes|, |No|",
            "unit": "Boolean/String",
            "affectsOutput": "If Yes, suppresses marker lines for all beams belonging to a module instance."
          },
          {
            "name": "filterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Links to a specific configuration from the 'HSB_G-FilterGenBeams' script to apply advanced filtering logic (e.g., length, width, name) to the beams.",
            "validRange": "List of available GenBeam filter definitions",
            "unit": "String",
            "affectsOutput": "Filters the pool of beams before marker lines are calculated; only beams passing this filter are considered."
          },
          {
            "name": "sPainter",
            "technicalDefault": "|Genbeam Painter|",
            "businessMeaning": "Uses a visual 'Painter' definition to filter beams based on graphical selection or color-coded properties.",
            "validRange": "List of available Painter definitions (plus |Disabled|)",
            "unit": "String",
            "affectsOutput": "Intersects the current beam set with the set of beams defined by the Painter; only overlapping beams are marked."
          },
          {
            "name": "dMarkSize",
            "technicalDefault": 300,
            "businessMeaning": "The physical length of the marker line drawn on the timber surface.",
            "validRange": "10mm to 2000mm (typical visibility range)",
            "unit": "mm",
            "affectsOutput": "Determines the visual length of the mark created on the element."
          },
          {
            "name": "dMarkOffset",
            "technicalDefault": 0,
            "businessMeaning": "Shifts the start point of the marker line along the beam's axis. Useful for avoiding clashes with other machining (e.g., tenons) at the beam ends.",
            "validRange": "-500mm to 500mm",
            "unit": "mm",
            "affectsOutput": "Moves the marker line position along the beam direction from the theoretical intersection point."
          },
          {
            "name": "sApplyToolingTo",
            "technicalDefault": "Zone 1",
            "businessMeaning": "Selects the specific construction layer (Zone) where the lines are drawn. The lines mark where the filtered beams intersect this specific layer.",
            "validRange": "Zone 1 through Zone 10",
            "unit": "Integer (Mapped)",
            "affectsOutput": "Defines the plane/profile used to calculate intersection points with the beams."
          },
          {
            "name": "sToolingDirection",
            "technicalDefault": "|Vertical|",
            "businessMeaning": "Filters beams based on their orientation relative to the Element's local axes. 'Vertical' selects beams parallel to the Element's Y-axis; 'Horizontal' selects beams parallel to the Element's X-axis.",
            "validRange": "|Vertical|, |Horizontal|",
            "unit": "Orientation",
            "affectsOutput": "Selects which subset of beams (studs vs plates/rim beams) receive the marks based on their alignment."
          },
          {
            "name": "nToolingIndex",
            "technicalDefault": 10,
            "businessMeaning": "The operation number assigned to the marker lines. Used in production data (BTL/CNC) to identify this specific tooling action.",
            "validRange": "1 to 9999",
            "unit": "Integer",
            "affectsOutput": "Sets the ID attribute of the generated ElemMarker entities."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sApplyToolingToElementType",
            "effect": "Determines the validity of sToolingDirection (meaning of Horizontal/Vertical changes based on element orientation).",
            "cascade": []
          },
          {
            "trigger": "sPainter",
            "effect": "Only active if set to a value other than |Disabled|.",
            "cascade": []
          },
          {
            "trigger": "filterDefinition",
            "effect": "Requires the script 'HSB_G-FilterGenBeams' to be loaded in the drawing.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "ElemMarker",
            "description": "Non-geometric line entities used to represent machining marks, layout lines, or engravings on the timber surface.",
            "appliedTo": "The parent Element (Wall/Floor/Roof), visualized on the surface of the target Zone."
          }
        ]
      },
      "tokens_used": 8903,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Start: Initialize variables and read properties from catalog (if _kExecuteKey matches a catalog name).",
          "Insert Check: If script is being inserted (_bOnInsert):",
          "Check Cycle Count: If insertCycleCount > 1, erase instance and return (prevents multiple execution).",
          "Dialog Display: If _kExecuteKey is empty or not found in catalog names, display the dynamic properties dialog.",
          "User Input: Prompt user to 'Select a set of elements' (PrEntity).",
          "Process Selection:",
          "Loop through each selected element.",
          "Clean up existing TSLs: Remove any existing instance of 'HSB_E-Markerlines' on the element that targets the same zone.",
          "Create Satellite: Insert a new instance of 'HSB_E-Markerlines' attached to the element with 'MasterToSatellite' flag.",
          "Report: Display message indicating number of TSLs inserted.",
          "Erase Master: Delete the temporary master instance used for insertion.",
          "Satellite Execution Start (MasterToSatellite map entry detected):",
          "Load Properties: Apply properties from the 'MasterToSatellite' catalog entry.",
          "Validation Check: If no Element is attached (_Element.length() == 0), erase instance.",
          "Determine Element Type: Calculate element type (Floor, Wall, Roof) based on Z-axis orientation.",
          "Filter Element Type: If current element type is not in 'Apply tooling to element type(s)', erase instance and report.",
          "Retrieve Beams: Get all GenBeams from the element.",
          "External Filter: Call 'HSB_G-FilterGenBeams' to filter beams based on 'Filter definition beams'.",
          "Error Handling: If external filter fails (TSL not loaded), report warning and erase instance.",
          "Painter Filter: If 'Genbeam Painter' is enabled, filter beams by Painter definition.",
          "Internal Filter Loop:",
          "Exclude beams if 'Exclude modules' is Yes and beam belongs to a module.",
          "Exclude beams if beam code matches 'Filter beams with beamcode'.",
          "Direction Filter: Keep beam if aligned with selected Direction ('Vertical' = Y-axis, 'Horizontal' = X-axis) relative to Element.",
          "Construct Zone Profile: Get GenBeams from the target Zone, apply Painter filter if active.",
          "Generate Geometry: Create a PlaneProfile representing the union of the target Zone beams.",
          "Marker Generation Loop:",
          "For each filtered beam to mark:",
          "Calculate intersection of beam shadow profile with Zone profile.",
          "If no intersection, skip beam.",
          "Calculate start points for marker lines based on beam diagonal extent and offset.",
          "Generate PLine geometry for marker lines.",
          "Create ElemMarker entities on the target Zone and add to Element.",
          "Script End."
        ],
        "conditionalBranches": [
          {
            "condition": "sApplyToolingToElementType vs Element Geometry",
            "path1": {
              "name": "Process Element",
              "steps": [
                "Element Type (Roof/Floor/Wall) is found in the property string.",
                "Script continues to beam filtering."
              ]
            },
            "path2": {
              "name": "Abort Element",
              "steps": [
                "Element Type is NOT in the property string.",
                "Report 'Element type filtered out'.",
                "Erase instance."
              ]
            }
          },
          {
            "condition": "sToolingDirection vs Beam Orientation",
            "path1": {
              "name": "Vertical Selection",
              "steps": [
                "Property is '|Vertical|'.",
                "Select beams whose X-axis is parallel to Element's Y-axis."
              ]
            },
            "path2": {
              "name": "Horizontal Selection",
              "steps": [
                "Property is '|Horizontal|'.",
                "Select beams whose X-axis is parallel to Element's X-axis."
              ]
            }
          },
          {
            "condition": "External Filter Execution",
            "path1": {
              "name": "Filter Success",
              "steps": [
                "HSB_G-FilterGenBeams returns success.",
                "Update beam list with filtered results."
              ]
            },
            "path2": {
              "name": "Filter Failure",
              "steps": [
                "HSB_G-FilterGenBeams returns failure.",
                "Report warning 'Beams could not be filtered!'.",
                "Erase instance."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Is 'HSB_G-FilterGenBeams' loaded in the drawing?",
            "errorMessage": "Beams could not be filtered! Make sure that the tsl HSB_G-FilterGenBeams is loaded in the drawing.",
            "recovery": "Load the HSB_G-FilterGenBeams.tsl script and re-run the markerlines tool."
          },
          {
            "check": "Is the selected Element type valid based on properties?",
            "errorMessage": "Element type filtered out: <Type>",
            "recovery": "Change the 'Apply tooling to element type(s)' property to include the current element's type."
          },
          {
            "check": "Does the element have any beams in the target Zone?",
            "errorMessage": "No explicit error, but no lines generated.",
            "recovery": "Ensure the Zone contains structural material (GenBeams)."
          },
          {
            "check": "Does the target Zone have a valid surface for markers?",
            "errorMessage": "Script logic prevents marking on non-existent surfaces (v2.1 logic in history).",
            "recovery": "Verify zone index corresponds to an existing layer in the element."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Updating 'dMarkSize', 'dMarkOffset', 'nToolingIndex', or filters triggers a recalculation. Changing 'sApplyToolingTo' (Zone) moves markers to a different layer. Changing 'sToolingDirection' switches between orthogonal beam sets."
          },
          {
            "action": "Re-run Catalog",
            "how": "Right-click context menu (if catalogs are defined)",
            "effect": "Resets all properties to a predefined catalog state and regenerates geometry."
          },
          {
            "action": "Erase Instance",
            "how": "AutoCAD Erase command",
            "effect": "Removes all generated marker lines from the element."
          }
        ]
      },
      "tokens_used": 9037,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-Markerlines\n\n## Overview\nThis script automatically draws layout or machining marker lines on structural elements (Walls, Floors, or Roofs). It calculates where filtered beams (such as studs or rafters) intersect a specific construction layer (Zone) and draws lines to mark those positions.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in the 3D model. |\n| Paper Space | No | Not intended for 2D layouts. |\n| Shop Drawing | No | Does not generate views or dimensions. |\n\n## Prerequisites\n- **Required Entities**: An Element (Wall, Floor, or Roof) containing GenBeams.\n- **Minimum Beam Count**: 1 beam in the target zone to mark.\n- **Required Settings**: The script `HSB_G-FilterGenBeams.mcr` must be loaded in the drawing to use the filtering features.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse and select `HSB_E-Markerlines.mcr`.\n\n### Step 2: Configure Properties\n1. Upon insertion, a dialog box appears displaying the script properties.\n2. Adjust settings such as the **Element Type** (Roof/Floor/Wall) and **Direction** (Vertical/Horizontal).\n3. Click **OK** to confirm.\n\n### Step 3: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on the Wall, Floor, or Roof elements you wish to process. Press Enter to finish selection.\n```\nThe script will attach to the elements and generate the marker lines immediately.\n\n## Properties Panel Parameters\n\n### Selection Settings\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Apply tooling to element type(s)** | dropdown | Roof | Limits the script to specific element types (e.g., only Roof, or both Roof and Floor). |\n| **Filter beams with beamcode** | text | (Empty) | Enter beam codes to EXCLUDE. Separate multiple codes with a semicolon (;). |\n| **Exclude modules** | dropdown | \\|No\\| | If set to \\|Yes\\|, beams belonging to a module (sub-assembly) are ignored. |\n| **Filter definition beams** | dropdown | (Empty) | Select a predefined filter from `HSB_G-FilterGenBeams` to filter beams by size or name. |\n| **Genbeam Painter** | dropdown | \\|Genbeam Painter\\| | Select a \"Painter\" definition to visually filter beams by color or selection set. |\n\n### Tooling Settings\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Length markerline** | number | 300 | The length of the mark drawn on the timber (in mm). |\n| **Offset markerline** | number | 0 | Moves the start point of the mark along the beam axis (in mm). |\n| **Apply tooling to** | dropdown | Zone 1 | The specific construction layer (Zone) where the marks will be drawn. |\n| **Direction** | dropdown | \\|Vertical\\| | Filters beams based on alignment. \\|Vertical\\| marks beams parallel to the element's Y-axis (studs). \\|Horizontal\\| marks beams parallel to the X-axis (plates). |\n| **Toolindex** | number | 10 | The operation number assigned to these marks for CNC/Data export. |\n\n## Right-Click Menu Options\n*Note: This script relies primarily on the Properties Palette for modifications. Standard context menu options apply.*\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the AutoCAD Properties palette to edit the script parameters and update the geometry. |\n| Erase | Removes the script and all generated marker lines from the element. |\n\n## Settings Files\n- **Dependency**: `HSB_G-FilterGenBeams.mcr`\n- **Location**: TSL Catalog path\n- **Purpose**: Provides advanced beam filtering logic (length, width, name) used by the \"Filter definition beams\" property.\n\n## Tips\n- **Avoid Clutter**: Use the \"Filter beams with beamcode\" to exclude blocking or short cripple studs that do not need layout lines.\n- **Shift Marks**: If your beams have machining (like tenons) at the ends, use \"Offset markerline\" to shift the mark inward so it doesn't overlap the machining.\n- **Zone Selection**: Ensure \"Apply tooling to\" matches a Zone that actually exists in your element construction (e.g., if marking studs on a bottom plate, select the Zone corresponding to that plate).\n\n## FAQ\n- **Q: Why did the script fail to insert?**\n  - A: Ensure that `HSB_G-FilterGenBeams.mcr` is loaded in the drawing. The marker script depends on it for filtering beams.\n- **Q: The lines appeared on the wrong beams (e.g., on plates instead of studs).**\n  - A: Check the **Direction** property. Switch between \\|Vertical\\| and \\|Horizontal\\| to change which beams are marked.\n- **Q: No lines appeared on my element.**\n  - A: Check the **Apply tooling to element type(s)**. If you selected a Wall but the property is set to \"Roof\", the script will skip that element.\n- **Q: Can I move the lines after they are created?**\n  - A: The lines are generated automatically. To move them, change the \"Offset markerline\" property in the Properties palette."
      },
      "tokens_used": 7506,
      "error": null
    }
  }
}