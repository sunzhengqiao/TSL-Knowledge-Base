{
  "filename": "hsbCNC-Drill.mcr",
  "status": "completed",
  "total_tokens": 58220,
  "processing_time": 369.3072040081024,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"2.5\",\n      \"date\": \"26jun20\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-8106 custom layer assignment added II\"\n    },\n    {\n      \"version\": \"2.4\",\n      \"date\": \"26jun20\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-8106 custom layer assignment added\"\n    },\n    {\n      \"version\": \"2.3\",\n      \"date\": \"05oct18\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"new properties to display properties, special format variable @(Elevation) will resolve the elevation of the drill in relation to the wall base line\"\n    },\n    {\n      \"version\": \"2.2\",\n      \"date\": \"13jul18\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"debug controller added\"\n    },\n    {\n      \"version\": \"2.1\",\n      \"date\": \"22mar17\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"insert suppports new properties to add optional sink hole\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"date\": \"21mar17\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"new properties to add optional sink hole\"\n    },\n    {\n      \"version\": \"1.9\",\n      \"date\": \"06apr16\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"property names updated\"\n    },\n    {\n      \"version\": \"1.8\",\n      \"date\": \"10feb15\",\n      \"author\": \"th@hsbCAD.de\",\n      \"changes\": \"validation of location with replicator dependency fixed\"\n    },\n    {\n      \"version\": \"1.7\",\n      \"date\": \"21jan15\",\n      \"author\": \"th@hsbCAD.de\",\n      \"changes\": \"bugfix solid operations also done on zones below the selected if depth exceeds current zone thickness\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"21jan15\",\n      \"author\": \"th@hsbCAD.de\",\n      \"changes\": \"solid operations also done on zones below the selected if depth exceeds current zone thickness\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"17nov14"
      },
      "tokens_used": 9197,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script operates on Element objects using el.addTool(ElemDrill(...)) and SolidSubtract for 3D visualization. It requires selecting an Element or Sheet via PrEntity. No paper space or viewports are referenced."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7605,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select a sheet of the desired zone or an element|",
              "condition": "_bOnInsert",
              "required": true,
              "details": "Allows selecting a Sheet, ElementWall, or ElementRoof."
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (if no valid catalog entry is used via execute key)",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "|Zone|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              -99,
              -5,
              -4,
              -3,
              -2,
              -1,
              1,
              2,
              3,
              4,
              5,
              99
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sZoneRelation",
            "type": "PropString",
            "displayName": "|Relation|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|Standard|",
              "|Relative|",
              "|Exclusive|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 0,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "|Depth|",
            "defaultValue": 20.0,
            "inputType": "number",
            "options": [],
            "category": "|Drill|",
            "description": "|The Depth of the CNC Operation, 0 = byZone, negative value = byZone + additional absolute value|"
          },
          {
            "index": 1,
            "variable": "dDiameter",
            "type": "PropDouble",
            "displayName": "|Diameter|",
            "defaultValue": 68.0,
            "inputType": "number",
            "options": [],
            "category": "|Drill|",
            "description": "|The Diameter of the CNC Operation|"
          },
          {
            "index": 2,
            "variable": "nToolingIndex",
            "type": "PropInt",
            "displayName": "|Tooling index|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Drill|",
            "description": null
          },
          {
            "index": 3,
            "variable": "dDepth2",
            "type": "PropDouble",
            "displayName": "|Depth| ",
            "defaultValue": 0.0,
            "inputType": "number",
            "options": [],
            "category": "|Drill| 2",
            "description": "|The Depth of the CNC Operation, 0 = byZone, negative value = byZone + additional absolute value|"
          },
          {
            "index": 4,
            "variable": "dDiameter2",
            "type": "PropDouble",
            "displayName": "|Diameter| ",
            "defaultValue": 0.0,
            "inputType": "number",
            "options": [],
            "category": "|Drill| 2",
            "description": "|The Diameter of the CNC Operation|"
          },
          {
            "index": 5,
            "variable": "nToolingIndex2",
            "type": "PropInt",
            "displayName": "|Tooling index| ",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Drill| 2",
            "description": null
          },
          {
            "index": 6,
            "variable": "sDescription",
            "type": "PropString",
            "displayName": "|Description|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the format of the composed value.|\n|Samples|\n   @(Diameter)@(Depth)\n   @(Label:L2) |the first two characters of Label|\n   @(Label:T1; |the second part of Label if value is separated by blanks, i.e. 'EG AW 2' will return AW'|)\n   @(Width:RL1) |the rounded value of width with one decimal.|\nR |Right: Takes the specified number of characters from the right of the string.|\nL |Left: Takes the specified number of characters from the left of the string.|\nS |SubString: Given one number will take all characters starting at the position (zero based).|\n |Given two numbers will start at the first number and take the second number of characters.|\nT |​Tokeniser: Returns the member of a delimited list using the specified index (zero based). A delimiter can be specified as an optional parameter with the default delimiter being the semcolon character..|\n# |Rounds a number. Specify the number of decimals to round to. Trailing zero's are removed.|\nRL |​Round Local: Rounds a number using the local regional settings..|\t\nA |​Specifies the alias| ;<|Alias Entry|>"
          },
          {
            "index": 7,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": 80.0,
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the text height|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Hide Definition|",
            "handler": "sTriggerHide",
            "action": "Sets the script instance visibility to false (IsVisible=false)",
            "alsoTriggeredBy": "Double Click (TslDoubleClick)"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 10120,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates CNC drilling operations (vertical holes) on timber elements, supporting counterbores and multi-zone penetration.",
          "category": "Machining/CNC",
          "typicalUseCase": "Drilling holes for electrical conduits, plumbing, ventilation ducts, or creating counterbored holes for bolts/anchors in timber walls or roofs."
        },
        "parameters": [
          {
            "name": "nZone",
            "technicalDefault": null,
            "businessMeaning": "Selects the specific material layer (zone) of the element to attach the drill to (e.g., inner load-bearing stud vs outer sheathing). -99 is the outermost zone, 99 is the innermost.",
            "validRange": "-99 to 99 (Integer, dependent on element construction)",
            "unit": "Index",
            "affectsOutput": "Determines which logical layer of the wall/roof the CNC instruction is assigned to and where the depth calculation starts (if relative)."
          },
          {
            "name": "sZoneRelation",
            "technicalDefault": "|Standard|",
            "businessMeaning": "Defines how the drill behaves relative to the selected zone if the element structure changes (e.g., if zones are added or removed).",
            "validRange": "Standard, Relative, Exclusive",
            "unit": "Enum",
            "affectsOutput": "Controls the persistence and mapping of the drill if the element's layering configuration is modified."
          },
          {
            "name": "dDepth",
            "technicalDefault": 20.0,
            "businessMeaning": "The depth of the hole. 0 means 'through the entire selected zone'. Negative values mean 'through the zone plus an additional X mm into the next zone'.",
            "validRange": "-500 to 1000 (0 implies auto-through zone)",
            "unit": "mm",
            "affectsOutput": "Determines the length of the cylindrical cut. If the depth exceeds the zone thickness, the drill continues into subsequent zones."
          },
          {
            "name": "dDiameter",
            "technicalDefault": 68.0,
            "businessMeaning": "The width of the drill bit.",
            "validRange": "6 to 300",
            "unit": "mm",
            "affectsOutput": "Sets the width of the cylindrical void in the 3D model and the CNC instruction."
          },
          {
            "name": "nToolingIndex",
            "technicalDefault": 1,
            "businessMeaning": "The tool number to be used in the CNC machine's tool changer (post-processor mapping).",
            "validRange": "1 to 99",
            "unit": "Integer",
            "affectsOutput": "Determines which specific drill bit the machine selects; does not change geometry directly."
          },
          {
            "name": "dDepth2",
            "technicalDefault": 0.0,
            "businessMeaning": "Depth for a secondary drill operation at the same location (e.g., for a counterbore). 0 uses zone logic.",
            "validRange": "0 to 500",
            "unit": "mm",
            "affectsOutput": "Creates a second cylindrical cut. If combined with Diameter 2, allows for stepped holes."
          },
          {
            "name": "dDiameter2",
            "technicalDefault": 0.0,
            "businessMeaning": "Diameter for the secondary drill operation (e.g., a wider hole for a bolt head washer).",
            "validRange": "0 to 300 (0 disables secondary drill)",
            "unit": "mm",
            "affectsOutput": "Creates a wider (or narrower) secondary cylinder at the same insertion point."
          },
          {
            "name": "nToolingIndex2",
            "technicalDefault": 1,
            "businessMeaning": "The CNC tool number for the secondary drill operation.",
            "validRange": "1 to 99",
            "unit": "Integer",
            "affectsOutput": "Assigns a specific tool for the secondary cut."
          },
          {
            "name": "sDescription",
            "technicalDefault": "",
            "businessMeaning": "A format string for the label displayed in the model/drawings (e.g., displaying diameter and depth info). Supports variables like @(Diameter), @(Depth), @(Elevation).",
            "validRange": "Text String (supports custom tokens)",
            "unit": "String",
            "affectsOutput": "Updates the text annotation in the CAD model visible to the user."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": 80.0,
            "businessMeaning": "The size of the text label displayed in the 3D model.",
            "validRange": "10 to 200",
            "unit": "mm",
            "affectsOutput": "Scales the text label visibility in the drawing."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dDiameter2 or dDepth2 is set to 0",
            "effect": "Secondary drill operation is skipped, only primary drill is executed.",
            "cascade": [
              "dDepth2",
              "dDiameter2",
              "nToolingIndex2"
            ]
          },
          {
            "trigger": "nZone selection",
            "effect": "Calculates the available thickness for the drill. If dDepth is 0, the actual depth becomes the thickness of the selected zone.",
            "cascade": [
              "dDepth"
            ]
          },
          {
            "trigger": "dDepth exceeds selected zone thickness",
            "effect": "The script automatically identifies and subtracts material from underlying zones in the element to ensure the hole penetrates deep enough.",
            "cascade": [
              "Element Solid Subtraction"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElemDrill",
            "description": "The primary CNC machining instruction added to the element.",
            "appliedTo": "Selected Element (Wall/Roof)"
          },
          {
            "type": "ElemDrill (Secondary)",
            "description": "Optional secondary CNC instruction for counterbores.",
            "appliedTo": "Selected Element (Wall/Roof)"
          },
          {
            "type": "SolidSubtract",
            "description": "Visual representation of the hole in the 3D model (AutoCAD body). Handles multi-zone subtraction if depth is deep.",
            "appliedTo": "Sheets/GenBeams within the Element"
          },
          {
            "type": "Text/Annotation",
            "description": "Dimension or label text defined by sDescription parameter.",
            "appliedTo": "Model Space (at drill location)"
          }
        ]
      },
      "tokens_used": 10652,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script starts: Initialize units, properties, and debug flags.",
          "2. [Insertion Phase] Check execution mode: BlockDefMode vs. Standard Model Mode.",
          "3. [Standard Mode] Prompt user to select a target Entity (Sheet, ElementWall, or ElementRoof) via PrEntity.",
          "4. [Standard Mode] Attempt to load properties from _kExecuteKey (Catalog Entry).",
          "5. [Standard Mode] If no catalog entry used: Display OPM Properties Dialog.",
          "6. [Standard Mode] Prompt user for Insertion Point via getPoint.",
          "7. [Recalculation Phase] Identify selected Element and Zone.",
          "8. [Recalculation Phase] Calculate Drill Geometry: Handle Depth (Absolute, ByZone, or Negative/Offset) and Diameter.",
          "9. [Recalculation Phase] Validate Insertion Point: Check if point lies within the Zone's profile (shrunken by diameter).",
          "10. [Recalculation Phase] Generate CNC Tools: Add ElemDrill to element (Primary and/or Secondary).",
          "11. [Recalculation Phase] Generate Visuals: Create SolidSubtract on sheets and underlying zones (if depth exceeds thickness).",
          "12. [Recalculation Phase] Generate Annotation: Format and draw text label based on Description property.",
          "13. [BlockDefMode] Draw 2D representation and save Replicator map data."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode",
            "path1": {
              "name": "BlockDefMode",
              "steps": [
                "Skip Entity Selection and getPoint prompts.",
                "Save insertion vector to _Map for Replicator usage.",
                "Draw 2D schematic symbol.",
                "Allow 'Hide Definition' context menu action."
              ]
            },
            "path2": {
              "name": "Standard Model Mode",
              "steps": [
                "Execute PrEntity to select Element/Sheet.",
                "Execute getPoint for location.",
                "Perform Solid Subtraction and add CNC operations to the Element."
              ]
            }
          },
          {
            "condition": "Catalog Entry Usage",
            "path1": {
              "name": "Catalog Entry Used",
              "steps": [
                "Load properties from catalog silently.",
                "Skip Property Dialog.",
                "Proceed to getPoint."
              ]
            },
            "path2": {
              "name": "Manual Entry",
              "steps": [
                "Show Properties Dialog to user.",
                "Wait for user confirmation.",
                "Proceed to getPoint."
              ]
            }
          },
          {
            "condition": "Drill Depth Logic",
            "path1": {
              "name": "Fixed Depth (>0)",
              "steps": [
                "Use explicit 'dDepth' value.",
                "Subtract volume only to the specified depth."
              ]
            },
            "path2": {
              "name": "ByZone / Offset (≤0)",
              "steps": [
                "Calculate thickness of the selected Zone.",
                "If 0: Depth = Zone Thickness.",
                "If Negative: Depth = Zone Thickness + Absolute Value of dDepth."
              ]
            }
          },
          {
            "condition": "Multi-Zone Penetration",
            "path1": {
              "name": "Depth fits in Zone",
              "steps": [
                "Perform solid subtraction only on the selected Zone's sheets."
              ]
            },
            "path2": {
              "name": "Depth exceeds Zone Thickness",
              "steps": [
                "Identify underlying zones (looping towards center).",
                "Collect GenBeams from underlying zones.",
                "Perform solid subtraction on selected zone AND underlying zones."
              ]
            }
          },
          {
            "condition": "Secondary Drill (Drill 2)",
            "path1": {
              "name": "Enabled (Diameter2 > 0)",
              "steps": [
                "Add second ElemDrill to element.",
                "Generate geometry for counterbore/secondary hole.",
                "Union secondary geometry with primary body for subtraction."
              ]
            },
            "path2": {
              "name": "Disabled (Diameter2 = 0)",
              "steps": [
                "Skip secondary drill generation.",
                "Process primary drill only."
              ]
            }
          },
          {
            "condition": "Location Validation",
            "path1": {
              "name": "Valid Location",
              "steps": [
                "Proceed to generate tools and geometry."
              ]
            },
            "path2": {
              "name": "Invalid Location (Outside Profile)",
              "steps": [
                "Report Error: 'CNC Tool will be removed due to location.'",
                "Erase Instance.",
                "Stop script execution."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection Validity",
            "errorMessage": "|Sheet must belong to an element.| |Tool will be deleted.|",
            "recovery": "User must select a Sheet that is part of a valid Element (Wall/Roof) or select the Element directly."
          },
          {
            "check": "Insertion Point Boundary",
            "errorMessage": "|CNC Tool will be removed due to location.|",
            "recovery": "User must move the insertion point grip so that it lies within the physical bounds of the selected element's zone."
          },
          {
            "check": "Insert Cycle Count",
            "errorMessage": "(Silent - instance erased)",
            "recovery": "System automatically handles; ensures instance doesn't duplicate if called multiple times in one loop."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Drill Location",
            "how": "Grip Edit (Drag insertion point)",
            "effect": "Updates _Pt0, recalculates profile validation, moves the CNC drill and text label."
          },
          {
            "action": "Modify Drill Parameters",
            "how": "OPM Properties Palette (Select element and script instance)",
            "effect": "Updates Diameter, Depth, Tooling Index, or Description text. Triggers immediate recalculation of geometry and CNC data."
          },
          {
            "action": "Edit Text Label Position",
            "how": "Grip Edit (Drag text grip)",
            "effect": "Moves the text label (_PtG) without moving the drill location."
          },
          {
            "action": "Hide Block Definition",
            "how": "Context Menu (Right-click) -> |Hide Definition|",
            "effect": "Sets script visibility to false (IsVisible=false). Only available in BlockDefMode."
          }
        ]
      },
      "tokens_used": 12396,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCNC-Drill.mcr\n\n## Overview\nThis script creates vertical CNC drilling operations on timber elements (walls or roofs). It supports primary and secondary drilling (e.g., counterbores for bolt heads), calculates depth based on material zones, and generates 3D holes with customizable text labels.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used for 3D modeling and assigning CNC data. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities**: An existing Element (Wall or Roof) or a Sheet within an element.\n- **Minimum Beam Count**: 0\n- **Required Settings**: None\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `hsbCNC-Drill.mcr`.\n\n### Step 2: Select Target Entity\n```\nCommand Line: Select a sheet of the desired zone or an element\nAction: Click on a Wall, Roof, or a specific Sheet (layer) within the element.\n```\n*Note: Selecting a specific sheet pre-sets the \"Zone\" property to that layer.*\n\n### Step 3: Configure Properties\nAction: The Properties Palette (OPM) will appear. Adjust the parameters (Diameter, Depth, Zone, etc.) as needed.\n*Tip: If using a Catalog Entry, properties may load automatically.*\n\n### Step 4: Set Insertion Point\n```\nCommand Line: Insertion point\nAction: Click on the face of the element where the center of the drill should be located.\n```\n*Note: Ensure you click within the bounds of the selected zone, or the tool will be deleted.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **General** | | | |\n| Zone | dropdown | - | Selects the specific material layer (e.g., stud layer, sheathing). -99 is outermost, 99 is innermost. |\n| Relation | dropdown | Standard | Determines how the drill behaves if the element construction changes (Standard, Relative, or Exclusive). |\n| **Drill** | | | |\n| Depth | number | 20.0 | Depth of the hole. `0` = through selected zone. Negative value = through zone + extra offset. |\n| Diameter | number | 68.0 | Diameter of the drill bit. |\n| Tooling index | number | 1 | CNC machine tool number to use. |\n| **Drill 2** | | | |\n| Depth | number | 0.0 | Depth for a second hole (e.g., counterbore). Set to 0 to disable. |\n| Diameter | number | 0.0 | Diameter for the second hole. |\n| Tooling index | number | 1 | CNC machine tool number for the second hole. |\n| **Display** | | | |\n| Description | text | - | Format string for the label. Use variables like `@(Diameter)`, `@(Depth)`, or `@(Elevation)`. Example: `@(Diameter)x@(Depth)`. |\n| Text Height | number | 80.0 | Size of the text label in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Hide Definition | Hides the script instance graphics while keeping the CNC data active. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: Standard properties are used. Catalog entries can be created to save preset configurations.\n\n## Tips\n- **Through-Drilling**: To drill completely through the selected material layer, set **Depth** to `0`.\n- **Counterbores**: Use the \"Drill 2\" section to create a larger, shallower hole (perfect for washers/nuts). Ensure Drill 2 Diameter is larger than the primary Diameter.\n- **Deep Drills**: If the set Depth exceeds the thickness of the selected zone, the script will automatically continue drilling into the zones behind it.\n- **Label Formatting**: You can display dynamic data on the drawing label. Try entering `D@(Diameter) L@(Depth)` in the Description field to show dimensions clearly.\n\n## FAQ\n- **Q: Why did my drill disappear after I moved it?**\n  - A: The insertion point likely moved outside the physical bounds of the selected zone. Move the grip back onto the timber surface.\n- **Q: How do I drill through the entire wall?**\n  - A: Select the outermost zone and set Depth to `0`. If the wall is thick, you may need to select the innermost zone or use a negative depth value to penetrate through multiple layers.\n- **Q: What does a negative depth mean?**\n  - A: A negative value calculates the depth as \"Zone Thickness + Absolute Value\". For example, if the zone is 50mm thick and you enter `-10`, the total drill depth will be 60mm."
      },
      "tokens_used": 8250,
      "error": null
    }
  }
}