{
  "filename": "sd_ViewportFieldDescription.mcr",
  "status": "completed",
  "total_tokens": 27715,
  "processing_time": 588.2215449810028,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 3814,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "Script filename starts with 'sd_' (sd_ViewportFieldDescription). Code uses getShopDrawView(), ShopDrawView type casting, and checks for ShopDrawView within _Entity array. XML comment mentions 'multipage blocks' and 'shopdraw view placeholder'."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layouts/Sheets)",
          "requiredSettings": []
        }
      },
      "tokens_used": 1948,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 6337,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates language-independent headers or inserts custom blocks (like logos) within a drawing layout viewport, specifically for annotating shop drawings.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used to populate title blocks on drawing sheets with dynamic project data (e.g., scale, date, project name) or to place company branding blocks relative to a specific viewport."
        },
        "parameters": [
          {
            "name": "sTxt",
            "technicalDefault": "\"|Project|\"",
            "businessMeaning": "Selects the specific dynamic data field to display (e.g., Client Name, Sheet Number, Scale). It acts as a placeholder that resolves to the actual project value based on the current drawing context.",
            "validRange": "List selection (approx 40 predefined fields)",
            "unit": "String",
            "affectsOutput": "Changes the text content displayed at the insertion point."
          },
          {
            "name": "sBlock",
            "technicalDefault": "\"\"",
            "businessMeaning": "The name of an AutoCAD block to display. If provided, this overrides the text display, effectively hiding the text field and showing the block geometry instead.",
            "validRange": "Any valid block name existing in the drawing (empty to use text)",
            "unit": "String",
            "affectsOutput": "Switches the output from a text object to a block reference instance."
          },
          {
            "name": "dScale",
            "technicalDefault": "1.0",
            "businessMeaning": "Controls the size of the displayed block. Useful for fitting logos or standard stamps into title block areas.",
            "validRange": "0.1 - 5.0",
            "unit": "Factor",
            "affectsOutput": "Uniformly scales the block geometry in X, Y, and Z directions."
          },
          {
            "name": "dAngle",
            "technicalDefault": "0.0",
            "businessMeaning": "Sets the rotation angle for the text or block relative to the drawing sheet.",
            "validRange": "0 - 360",
            "unit": "Degrees",
            "affectsOutput": "Rotates the visual output around the insertion point."
          },
          {
            "name": "dTxtH",
            "technicalDefault": "U(70)",
            "businessMeaning": "Defines the height of the text characters.",
            "validRange": "2.5 - 10.0",
            "unit": "mm",
            "affectsOutput": "Increases or decreases the font size of the text field."
          },
          {
            "name": "nColor",
            "technicalDefault": "-1",
            "businessMeaning": "Assigns a specific AutoCAD color index to the text or block. -1 typically implies 'ByLayer'.",
            "validRange": "0 - 255 or -1",
            "unit": "Index",
            "affectsOutput": "Changes the visual color of the output entity."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Selects the Dimension Style (which defines font, arrow style, etc.) to apply to the text.",
            "validRange": "List of DimStyles defined in the drawing",
            "unit": "String",
            "affectsOutput": "Alters the font and text style based on the selected standard."
          },
          {
            "name": "sVertical",
            "technicalDefault": "\"|Top|\"",
            "businessMeaning": "Aligns the text vertically relative to the insertion grip (e.g., placing the insertion point at the top, center, or bottom of the text).",
            "validRange": "Bottom, Center, Top",
            "unit": "Enum",
            "affectsOutput": "Adjusts the vertical position of the text relative to the coordinate point."
          },
          {
            "name": "sHorizontal",
            "technicalDefault": "\"|Left|\"",
            "businessMeaning": "Aligns the text horizontally relative to the insertion grip (e.g., placing the insertion point at the left, center, or right of the text).",
            "validRange": "Left, Center, Right",
            "unit": "Enum",
            "affectsOutput": "Adjusts the horizontal position of the text relative to the coordinate point."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sBlock is not empty (Block mode active)",
            "effect": "Text display parameters are disabled; geometry is replaced by the specified block.",
            "cascade": [
              "sTxt",
              "sVertical",
              "sHorizontal",
              "dTxtH"
            ]
          },
          {
            "trigger": "sBlock is empty (Text mode active)",
            "effect": "Block scaling is ignored; text formatting parameters apply.",
            "cascade": [
              "dScale"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text / MText",
            "description": "Dynamic text string resolved from project properties.",
            "appliedTo": "Paper Space (Shop Drawing Layouts)"
          },
          {
            "type": "Block Reference",
            "description": "An instance of a user-specified block definition.",
            "appliedTo": "Paper Space (Shop Drawing Layouts)"
          }
        ]
      },
      "tokens_used": 4153,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch script command.",
          "2. Show initial properties dialog (showDialog) for user input configuration.",
          "3. Prompt user to select an insertion point in Paper Space (getPoint).",
          "4. Prompt user to select a ShopDrawView (Viewport) entity (getShopDrawView).",
          "5. Link selected Viewport to script instance in _Entity array and complete insertion.",
          "6. Retrieve ShopDrawView reference and property values.",
          "7. Calculate local coordinate system (vx, vy) applying Rotation Angle (dAngle).",
          "8. Map Vertical and Horizontal alignment string properties to integer indices.",
          "9. Configure Display object with Color, DimStyle, and Text Height.",
          "10. Evaluate 'Show Block' (sBlock) property to determine render path.",
          "11. [Path A - Text] Draw dynamic text string at insertion point with alignment offsets.",
          "12. [Path B - Block] Load specified block definition and draw at insertion point with Scale Factor applied."
        ],
        "conditionalBranches": [
          {
            "condition": "Is the 'Show Block' (sBlock) property empty?",
            "path1": {
              "name": "Text Mode",
              "steps": [
                "Use Text Height (dTxtH) and DimStyle properties.",
                "Map Vertical (sVertical) and Horizontal (sHorizontal) alignment.",
                "Execute dp.draw(sTxt) to render the resolved field description text."
              ]
            },
            "path2": {
              "name": "Block Mode",
              "steps": [
                "Initialize Block object using sBlock name.",
                "Apply Scale Factor (dScale) to local vectors.",
                "Execute dp.draw(bl) to render the block geometry (ignoring text alignment settings)."
              ]
            }
          },
          {
            "condition": "Is the script running during Insertion (_bOnInsert)?",
            "path1": {
              "name": "Insertion Phase",
              "steps": [
                "Execute showDialog().",
                "Capture getPoint().",
                "Capture getShopDrawView().",
                "Append to _Entity and Return (Stop execution)."
              ]
            },
            "path2": {
              "name": "Calculation/Rendering Phase",
              "steps": [
                "Extract ShopDrawView from _Entity array.",
                "Calculate geometry and display entities."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Block Definition Existence",
            "errorMessage": "None explicitly in code; geometry fails silently if block name is invalid.",
            "recovery": "User must enter a valid block name existing in the current drawing or clear the 'sBlock' property to revert to text mode."
          },
          {
            "check": "Viewport Selection",
            "errorMessage": "Standard hsbCAD selection prompt behavior (requires valid selection to proceed).",
            "recovery": "User must select a valid ShopDrawView entity during the insertion prompt."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Relocate Annotation",
            "how": "Drag the Insertion Point Grip (_Pt0)",
            "effect": "Moves the text or block to a new coordinate on the sheet."
          },
          {
            "action": "Modify Content or Style",
            "how": "Edit Properties in Object Properties Palette (OPM)",
            "effect": "Changing 'sTxt' updates the dynamic field; changing 'sBlock' toggles between text and block; changing 'dScale' or 'dAngle' resizes/rotates the output immediately."
          }
        ]
      },
      "tokens_used": 6371,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# sd_ViewportFieldDescription\n\n## Overview\nThis script is used to insert dynamic text labels or custom blocks (such as logos) into drawing layouts. It links the label to a specific shop drawing viewport to display project data like the sheet number, scale, or project name.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is intended for Layouts/Sheets. |\n| Paper Space | Yes | The script functions in the Sheet environment. |\n| Shop Drawing | Yes | Specifically designed for shop drawing viewports. |\n\n## Prerequisites\n- **Required Entities**: A `ShopDrawView` (Viewport) must exist in the layout to link the text/block to.\n- **Minimum Beam Count**: 0\n- **Required Settings**: None\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `sd_ViewportFieldDescription.mcr` from the list.\n\n### Step 2: Configure Properties\nA dialog box will appear automatically upon insertion.\n- **Action**: Use the dropdowns to select the data field you wish to display (e.g., Project Name) or browse for a Block name if inserting a logo. Click OK to confirm.\n\n### Step 3: Set Insertion Point\n```\nCommand Line: Insertion point:\nAction: Click in the Paper Space layout where you want the text or block to appear.\n```\n\n### Step 4: Select Viewport\n```\nCommand Line: Select ShopDrawView:\nAction: Click on the viewport (ShopDrawView) frame that you want to associate with this label.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| sTxt | dropdown | \\|Project\\| | Selects the dynamic data field to display (e.g., Client Name, Sheet Number, Scale). |\n| sBlock | text | | The name of an AutoCAD block to insert. If filled, this overrides the text display. |\n| dScale | number | 1.0 | Scale factor for the block (only active if sBlock is used). |\n| dAngle | number | 0.0 | Rotation angle for the text or block (in degrees). |\n| dTxtH | number | U(70) | Height of the text characters (in mm). |\n| nColor | number | -1 | Color index for the entity (-1 = ByLayer). |\n| sDimStyle | dropdown | _DimStyles | The text style (font) to use for the label. |\n| sVertical | dropdown | \\|Top\\| | Vertical alignment relative to the insertion point (Top, Center, Bottom). |\n| sHorizontal | dropdown | \\|Left\\| | Horizontal alignment relative to the insertion point (Left, Center, Right). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Refreshes the text content if project data has changed. |\n\n## Settings Files\nNone\n\n## Tips\n- **Logos**: To insert a company logo, type the block name into the `sBlock` property. The script will switch to \"Block Mode\" and hide the text.\n- **Alignment**: Use the Vertical and Horizontal alignment properties to precisely fit text into title block frames without calculating offsets manually.\n- **Dynamic Updates**: If you rename the project or change the scale in the main model, the text inserted by this script will update automatically when the drawing is recalculated.\n\n## FAQ\n- **Q: Why is my text not showing up?**\n  A: Check the `sBlock` property. If it contains a block name, the script displays the block instead of text. Clear the `sBlock` field to revert to text mode.\n- **Q: How do I change the font?**\n  A: Change the `sDimStyle` property to a different dimension style defined in your drawing template.\n- **Q: Can I move the label after inserting it?**\n  A: Yes. Select the script instance in the drawing and drag the grip point to move it."
      },
      "tokens_used": 5092,
      "error": null
    }
  }
}