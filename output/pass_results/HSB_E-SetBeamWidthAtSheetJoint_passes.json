{
  "filename": "HSB_E-SetBeamWidthAtSheetJoint.mcr",
  "status": "completed",
  "total_tokens": 49855,
  "processing_time": 449.2092800140381,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "2.2",
            "date": "30/04/2025",
            "author": "Marsel Nakuci",
            "changes": "HSB-23494: Add painter filter for beams"
          },
          {
            "version": "2.1",
            "date": "30/04/2025",
            "author": "Marsel Nakuci",
            "changes": "HSB-23494: Add zone filter for the beams"
          },
          {
            "version": "2.0",
            "date": "30-9-2021",
            "author": "Ronald van Wijngaarden",
            "changes": "Make tsl more general, remove type Elementroof restriction. Improve the insert of the tsl."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7744,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script modifies 3D geometry using bm.setD() and operates on Element, Sheet, and Beam objects. Uses PrEntity to select Elements and dbCreate to attach TSL instances to Elements. Contains no Viewport or ShopDrawing (sd_*) specific logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Sheet",
            "Beam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D Construction)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7539,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "On Insert (if no execute key provided)",
            "title": "Properties",
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 1,
            "variable": "nZoneIndex",
            "type": "PropInt",
            "displayName": "Zone index sheeting",
            "defaultValue": "1",
            "inputType": "dropdown",
            "options": [
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7",
              "8",
              "9",
              "10"
            ],
            "category": "Sheet joints",
            "description": "The beams behind sheet joints of this zone are changed."
          },
          {
            "index": 0,
            "variable": "dWBeam",
            "type": "PropDouble",
            "displayName": "New beam width",
            "defaultValue": "36",
            "inputType": "number",
            "options": [],
            "category": "Beam Properties",
            "description": "Sets the width of the beams at a sheet joint"
          },
          {
            "index": 0,
            "variable": "sBmCode",
            "type": "PropString",
            "displayName": "Beamcode",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam Properties",
            "description": "Sets the beamcode of the beams at sheet joints"
          },
          {
            "index": 0,
            "variable": "nBmColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": "-2",
            "inputType": "number",
            "options": [],
            "category": "Beam Properties",
            "description": "Sets the color of the beams at sheet joints-2 keeps the original color."
          },
          {
            "index": 1,
            "variable": "sBeamZones",
            "type": "PropString",
            "displayName": "Beam Zones",
            "defaultValue": "0",
            "inputType": "text",
            "options": [],
            "category": "Beam filter",
            "description": "Defines the zones where beams will be affected. When empty then all beams will be considered"
          },
          {
            "index": 2,
            "variable": "sPainterStream",
            "type": "PropString",
            "displayName": "PainterStream",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam filter",
            "description": "Defines the PainterStream"
          },
          {
            "index": 3,
            "variable": "sFilter",
            "type": "PropString",
            "displayName": "Painter Filter",
            "defaultValue": "<Disabled>",
            "inputType": "dropdown",
            "options": [
              "Dynamic list from PainterDefinition"
            ],
            "category": "Beam filter",
            "description": "Defines the painter definition to filter entities."
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9080,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically identifies studs or posts located behind sheet joints and modifies their width, color, and code to accommodate sheathing connections or fastening requirements.",
          "category": "Framing",
          "typicalUseCase": "Used in panel or wall design when beams (studs) at sheet joints need to be wider (e.g., for nailing both sides of the sheathing) or visually marked (color/code) for fabrication."
        },
        "parameters": [
          {
            "name": "nZoneIndex",
            "technicalDefault": "1",
            "businessMeaning": "Specifies which sheeting layer (zone) to analyze for joints. In multi-layer cladding or sheeting, this determines which specific layer's joints trigger the beam modifications.",
            "validRange": "1 - 10 (Integer)",
            "unit": "Index",
            "affectsOutput": "Determines the set of Sheet entities used to detect joint locations. Only joints in the specified zone trigger beam changes."
          },
          {
            "name": "dWBeam",
            "technicalDefault": "36",
            "businessMeaning": "The new width (thickness) to apply to the studs found at sheet joints. This typically increases the width to ensure nailing edges exist on both sides of the sheeting joint.",
            "validRange": "Typically 45mm to 200mm (depending on standard timber sizes)",
            "unit": "mm",
            "affectsOutput": "Directly changes the geometric width (setD) of the target beams. This affects the 3D model body and material take-off."
          },
          {
            "name": "sBmCode",
            "technicalDefault": "",
            "businessMeaning": "Assigns a specific manufacturing or sorting code to the beams at the joint. Used for production planning, tagging, or marking specific studs for special treatment.",
            "validRange": "Any string defined in the production standards",
            "unit": "String",
            "affectsOutput": "Updates the 'BeamCode' property of the target beams. Does not change geometry but affects data export and labeling."
          },
          {
            "name": "nBmColor",
            "technicalDefault": "-2",
            "businessMeaning": "Sets the display color of the beams at sheet joints for visual identification in CAD. -2 preserves the original beam color.",
            "validRange": "-2 (Keep Original) or 0-255 (AutoCAD Color Index)",
            "unit": "ACI Index",
            "affectsOutput": "Changes the display color of the beams in the 3D model view. -2 means no change."
          },
          {
            "name": "sBeamZones",
            "technicalDefault": "0",
            "businessMeaning": "Filters which structural zones the beams belong to. Only beams within the listed zones (e.g., -2, 0, 1) will be modified. If empty, all zones are considered.",
            "validRange": "Semicolon-separated list of integers (e.g., '1;2;-1')",
            "unit": "List",
            "affectsOutput": "Restricts the script's effect to only beams that match the specified zone indices. Beams in other zones are ignored even if at a sheet joint."
          },
          {
            "name": "sPainterStream",
            "technicalDefault": "",
            "businessMeaning": "Internal storage of the Painter definition criteria (filter, format, type). Used to persist the complex filtering rules without requiring a named catalog entry.",
            "unit": "String",
            "affectsOutput": "Contains the rules used to filter beams. It is the result of the 'Painter Filter' selection, not a direct input."
          },
          {
            "name": "sFilter",
            "technicalDefault": "<Disabled>",
            "businessMeaning": "Selects a 'Painter' rule (predefined filter) to further restrict which beams are modified. For example, only 'Structural' beams or specific material grades.",
            "validRange": "List of available Painter Definitions",
            "unit": "Selection",
            "affectsOutput": "If not Disabled, only beams accepted by the selected Painter rule will have their width/code changed. Others are skipped."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User selects 'sFilter' (Painter Filter)",
            "effect": "The definition of the selected painter is serialized and stored in 'sPainterStream'.",
            "cascade": [
              "sPainterStream"
            ]
          },
          {
            "trigger": "Beam is located at a sheet joint",
            "effect": "Script checks against 'sBeamZones' and 'sFilter'. If both pass, 'dWBeam', 'sBmCode', and 'nBmColor' are applied.",
            "cascade": [
              "dWBeam",
              "sBmCode",
              "nBmColor"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam Modification",
            "description": "Existing beams are resized (width increased), recolored, and recoded.",
            "appliedTo": "Vertical beams (studs) or specific blocking beams (IDs 4109, 4110) that are geometrically located behind sheet joints in the specified zone."
          },
          {
            "type": "Blocking Adjustment",
            "description": "Intersecting blocking beams are shifted along their axis to avoid intersection with the newly widened studs.",
            "appliedTo": "Beams with HSB ID 4109 or 4110 found near the modified studs."
          }
        ]
      },
      "tokens_used": 8314,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: Initialize properties and check for Execute Key or Catalog entry",
          "2. Configuration: Load properties from Catalog (if Execute Key exists) or Show Properties Dialog (showDialog)",
          "3. Painter Setup: Serialize selected Painter Definition into a Stream string for storage",
          "4. Entity Selection: Prompt user to select Element(s) via PrEntity",
          "5. Instance Propagation: For each selected Element, create a new TSL instance attached to that Element (dbCreate)",
          "6. Cleanup: Erase the original 'launcher' script instance",
          "7. Element Processing (Attached Instance): Retrieve Element coordinate system and beams",
          "8. Zone Parsing: Parse 'sBeamZones' string into an array of valid integers",
          "9. Filter Validation: Validate selected 'sFilter'; reset to default if invalid",
          "10. Sheet Analysis: Retrieve all Sheets from the specified Zone Index (nZoneIndex)",
          "11. Joint Detection: Identify sheet joint locations based on edge midpoints and proximity (< 10mm)",
          "12. Beam Classification: Separate beams into 'Vertical' (orthogonal to Element X-axis) and 'Blocking' (IDs 4109, 4110)",
          "13. Iteration: Loop through all detected sheet joints",
          "14. Location Matching: Find Vertical Beams located within 10mm of the joint point",
          "15. Conditional Filtering: Check if beam matches 'sBeamZones' and 'Painter Filter' criteria",
          "16. Modification: Apply new Width, Color, and BeamCode to matching beams",
          "17. Collision Handling: Check for intersections with Blocking beams and shift them if necessary",
          "18. Finish: Erase processing instance"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Method Check (Execute Key vs Manual)",
            "path1": {
              "name": "Execute Key Present",
              "steps": [
                "Search for Catalog entry matching the key",
                "Load properties from Catalog",
                "Skip dialog display"
              ]
            },
            "path2": {
              "name": "No Execute Key",
              "steps": [
                "Display Properties Dialog to user",
                "Load properties from user input",
                "Save last used configuration to catalog"
              ]
            }
          },
          {
            "condition": "Sheet Existence in Zone",
            "path1": {
              "name": "Sheets Found",
              "steps": [
                "Calculate joint positions",
                "Proceed to beam modification"
              ]
            },
            "path2": {
              "name": "No Sheets Found",
              "steps": [
                "Display Notice: 'No sheets found in zone [X]'",
                "Erase Instance",
                "Stop Script"
              ]
            }
          },
          {
            "condition": "Beam Filter Criteria (Zone & Painter)",
            "path1": {
              "name": "Criteria Met",
              "steps": [
                "Update Beam Color (if nBmColor > -2)",
                "Update Beam Code (if sBmCode is not empty)",
                "Update Beam Width (setD)",
                "Check for Blocking collisions"
              ]
            },
            "path2": {
              "name": "Criteria Failed",
              "steps": [
                "Skip modification for this beam",
                "Continue to next beam"
              ]
            }
          },
          {
            "condition": "Blocking Beam Collision (Intersection Check)",
            "path1": {
              "name": "Intersection Detected",
              "steps": [
                "Calculate shift direction based on relative position",
                "Transform Blocking Beam along X-axis to resolve overlap"
              ]
            },
            "path2": {
              "name": "No Intersection",
              "steps": [
                "Leave Blocking Beam in original position"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases itself if insertCycleCount() > 1 to prevent duplicate processing"
          },
          {
            "check": "Element Selection Count",
            "errorMessage": "No element selected.",
            "recovery": "User must run the command again and select valid construction elements"
          },
          {
            "check": "Element Validity",
            "errorMessage": "Invalid element selected.",
            "recovery": "Ensure the selected entity is a valid hsbCAD Element (not deleted or corrupted)"
          },
          {
            "check": "Painter Filter Selection",
            "errorMessage": "None (Automatic Correction)",
            "recovery": "If selected filter is invalid, script resets it to the first option (Disabled) and re-executes (setExecutionLoops(2))"
          },
          {
            "check": "Zone Index Bounds",
            "errorMessage": "None (Logic handling)",
            "recovery": "Internally adjusts Zone Index if > 5 using logic `5 - nZnIndex`"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Beam Properties",
            "how": "OPM Properties Palette",
            "effect": "Changing 'New beam width', 'Color', or 'Beamcode' and updating the element triggers an immediate recalculation of all affected beams."
          },
          {
            "action": "Change Filter Criteria",
            "how": "OPM Properties Palette",
            "effect": "Updating 'Beam Zones' or 'Painter Filter' changes which specific beams at the joints are modified without changing the joint locations."
          },
          {
            "action": "Change Analysis Zone",
            "how": "OPM Properties Palette",
            "effect": "Changing 'Zone index sheeting' forces the script to look for joints in a different sheeting layer, potentially selecting completely different beams."
          },
          {
            "action": "Geometry Update",
            "how": "Element Modification (e.g. moving sheets or beams)",
            "effect": "Modifying the host Element's geometry (adding/removing sheets or moving studs) triggers an automatic recalculation to update the beam widths and blocking positions."
          }
        ]
      },
      "tokens_used": 10397,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-SetBeamWidthAtSheetJoint.mcr\n\n## Overview\nAutomatically detects beams located behind sheet joints and modifies their width, color, and beam code. It also automatically adjusts intersecting blocking beams to prevent collisions after the width changes.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D construction elements |\n| Paper Space | No | Not applicable for 2D drawings |\n| Shop Drawing | No | Does not generate shop drawings |\n\n## Prerequisites\n- **Required Entities**: Elements containing Sheets and Beams.\n- **Minimum Beam Count**: 0 (Script works on the geometry available).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n- Select `HSB_E-SetBeamWidthAtSheetJoint.mcr` from the file browser.\n\n### Step 2: Configure Properties\nThe Properties Palette will appear automatically upon insertion.\n- Set the **Zone index sheeting** to match the layer of sheets you are working with.\n- Set the **New beam width** to the desired size (e.g., 36mm).\n- Configure **Beam Zones** or **Painter Filter** if you only want to affect specific structural zones.\n\n### Step 3: Select Elements\n```\nCommand Line: Select element(s)\nAction: Click on the Element(s) (walls/floors) in the model that contain the sheeting and beams you wish to process.\n```\n*Press Enter to confirm selection.*\n\n### Step 4: Processing\nThe script attaches itself to the selected elements and immediately processes the beams. Any beams found behind sheet joints in the specified zone will be resized.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone index sheeting | dropdown | 1 | Select the sheeting layer (Zone) to analyze. Only joints in this layer will trigger beam changes. |\n| New beam width | number | 36 | The width (thickness) to apply to the beams located at sheet joints. |\n| Beamcode | text | [empty] | Assigns a specific manufacturing code to the beams at the joints. Leave empty to keep existing codes. |\n| Color | number | -2 | Sets the display color of the modified beams. Enter -2 to keep the original beam color. |\n| Beam Zones | text | 0 | Filters beams by their structural zone (e.g., \"1;2\"). Leave empty to consider beams in all zones. |\n| Painter Filter | dropdown | <Disabled> | Select a predefined Painter rule to filter specific types of beams (e.g., only structural studs). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu options are added by this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script uses the internal Catalog system to store default settings; no external user settings file is required.\n\n## Tips\n- **Visual Verification**: Set the **Color** property to a distinct color (e.g., Red) during setup to visually confirm which beams are being modified before final production settings.\n- **Blocking Beams**: The script automatically detects blocking beams (HSB ID 4109 or 4110) and shifts them along their axis if they intersect with the widened studs. You do not need to move these manually.\n- **Updating**: To change the width after insertion, select the Element, open the Properties Palette, locate the **HSB_E-SetBeamWidthAtSheetJoint** instance, and modify the **New beam width** value.\n\n## FAQ\n- **Q: Why did the script not change any beams?**\n- **A:** Check the **Zone index sheeting**. If the sheets in your model belong to Zone 2, but the script is set to Zone 1, no joints will be detected. Also, verify that the **Beam Zones** filter includes the zones where your beams are located.\n\n- **Q: Can I use this to only change the color for identification without changing the size?**\n- **A:** Yes. Set the **New beam width** to the current width of the studs (or leave it if it matches) and set the **Color** to your desired index. The script will update the color property only.\n\n- **Q: What happens if I delete a sheet after running the script?**\n- **A:** Since the script instance is attached to the Element, modifying the Element (like deleting a sheet) triggers a recalculation. The script will re-run, and beams that were previously at a joint may revert to their original size if the joint no longer exists."
      },
      "tokens_used": 6781,
      "error": null
    }
  }
}