{
  "filename": "Merk Stutzenfuss K1.mcr",
  "status": "completed",
  "total_tokens": 38671,
  "processing_time": 343.53537917137146,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6704,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit use of _kModelSpace in tslNew.dbCreate call. The script modifies 3D geometry by adding Cuts and Drills to a Beam entity (bm.addTool). It uses Display/Body for visualization rather than sdx drawing functions. No 'sd_' prefix, _Viewport usage, or ShopDrawing specific patterns found."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 4468,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": "n/a",
              "condition": "_bOnInsert && _kExecuteKey == \"\"",
              "required": true
            },
            {
              "step": 2,
              "function": "setPropValuesFromCatalog",
              "promptOriginal": "n/a",
              "condition": "_bOnInsert && _kExecuteKey != \"\"",
              "required": false
            },
            {
              "step": 3,
              "function": "PrEntity / Beam Selection",
              "promptOriginal": "|Select post(s)|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 4,
              "function": "getPoint",
              "promptOriginal": "|Select insertion point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "During script insertion if no catalog key is used (_kExecuteKey == \"\")",
            "title": null,
            "dataSource": "Internal properties (dHeight, dTotalHeight, etc.)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dHeight",
            "type": "PropDouble",
            "displayName": "Height",
            "defaultValue": "U(200)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dTotalHeight",
            "type": "PropDouble",
            "displayName": "Total Height",
            "defaultValue": "U(300)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dDiameter",
            "type": "PropDouble",
            "displayName": "Diameter",
            "defaultValue": "U(40)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dExtraDepth",
            "type": "PropDouble",
            "displayName": "Extra Drilling Depth",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dDepthSink",
            "type": "PropDouble",
            "displayName": "Depth Housing",
            "defaultValue": "U(20)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "dDiameterPressurePlate",
            "type": "PropDouble",
            "displayName": "|Diameter| |Pressure Plate|",
            "defaultValue": "U(75)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "dWidthBase",
            "type": "PropDouble",
            "displayName": "|Width| |Baseplate|",
            "defaultValue": "U(100)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "dLengthBase",
            "type": "PropDouble",
            "displayName": "|Length| |Baseplate|",
            "defaultValue": "U(180)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "253",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sLayerGroup",
            "type": "PropString",
            "displayName": "|Group, Layername or Zone Character|",
            "defaultValue": "Z",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5388,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Inserts a 'Merk' brand post shoe (column base) hardware component, including visualization and necessary machining (drilling/trimming) for the timber post.\",\n    \"category\": \"Hardware\",\n    \"typicalUseCase\": \"Anchoring a timber column (post) to a concrete foundation or floor, ensuring precise drilling and hardware placement at the column base.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dHeight\",\n      \"technicalDefault\": \"U(200)\",\n      \"businessMeaning\": \"Insertion depth of the metal rod into the timber post (also used as reference point for the trim cut and sink drill).\",\n      \"validRange\": \"50 mm - 400 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines the depth of the main drill and the location of the trim cut/sink hole relative to the insertion point.\"\n    },\n    {\n      \"name\": \"dTotalHeight\",\n      \"technicalDefault\": \"U(300)\",\n      \"businessMeaning\": \"Total length of the vertical metal rod (shaft) of the column shoe.\",\n      \"validRange\": \"dHeight + 50 mm - 1000 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Controls the length of the visualized cylinder and the length of the drill hole in the timber.\"\n    },\n    {\n      \"name\": \"dDiameter\",\n      \"technicalDefault\": \"U(40)\",\n      \"businessMeaning\": \"Diameter of the central metal rod.\",\n      \"validRange\": \"20 mm - 80 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Sets the diameter of the main visualized cylinder body and the main drill hole in the beam.\"\n    },\n    {\n      \"name\": \"dExtraDepth\",\n      \"technicalDefault\": \"U(0)\",\n      \"businessMeaning\": \"Additional drilling depth below the metal rod (often used for grout outlet or drainage clearance).\",\n      \"validRange\": \"0 mm - 100 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Extends the drill hole deeper than the metal rod length; adjusts baseplate visual position relative to the cut.\"\n    },\n    {\n      \"name\": \"dDepthSink\",\n      \"technicalDefault\": \"U(20)\",\n      \"businessMeaning\": \"Depth of the counterbore (recess) in the timber to accommodate the pressure plate/flange.\",\n      \"validRange\": \"0 mm - 50 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Creates a secondary, wider drill hole (sink) starting from the reference point defined by dHeight.\"\n    },\n    {\n      \"name\": \"dDiameterPressurePlate\",\n      \"technicalDefault\": \"U(75)\",\n      \"businessMeaning\": \"Diameter of the pressure plate (washer/flange) that sits against the timber.\",\n      \"validRange\": \"50 mm - 150 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines the diameter of the sink drill (counterbore) and the visualized pressure plate.\"\n    },\n    {\n      \"name\": \"dWidthBase\",\n      \"technicalDefault\": \"U(100)\",\n      \"businessMeaning\": \"Width of the rectangular baseplate at the bottom of the shoe.\",\n      \"validRange\": \"80 mm - 300 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Defines the X-dimension of the visualized baseplate body.\"\n    },\n    {\n      \"name\": \"dLengthBase\",\n      \"technicalDefault\": \"U(180)\",\n      \"businessMeaning\": \"Length of the rectangular baseplate at the bottom of the shoe.\",\n      \"validRange\": \"80 mm - 400 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Defines the Y-dimension of the visualized baseplate body.\"\n    },\n    {\n      \"name\": \"nColor\",\n      \"technicalDefault\": \"253\",\n      \"businessMeaning\": \"Visual color of the hardware in the CAD model.\",\n      \"validRange\": \"0 - 255\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Changes the display color of the generated bodies.\"\n    },\n    {\n      \"name\": \"sLayerGroup\",\n      \""
      },
      "tokens_used": 8019,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch / Insertion",
          "Check if script is already in insertion cycle (insertCycleCount > 1). If yes, erase instance and exit.",
          "Check if executed via Catalog Key (_kExecuteKey).",
          "[If No Catalog Key] Show Dialog to input properties (Height, Total Height, Diameter, etc.).",
          "[If Catalog Key] Set properties automatically from catalog definition.",
          "Prompt user to Select Post(s) (GenBeam) using PrEntity.",
          "Prompt user to Select Insertion Point using getPoint.",
          "Validate beam selection. If no beams selected, erase instance.",
          "Loop through selected beams: Calculate insertion point on beam centerline, Create new TSL instance (dbCreate) attached to each beam.",
          "Exit Insertion Phase (_bOnInsert).",
          "Instance Creation Phase (_bOnDbCreated): Load properties from last inserted catalog.",
          "Validate Orientation: Check if Beam local X (-_X0) is codirectional with World Z (_ZW). If not (beam is not vertical), report error and delete instance.",
          "Validate Dimensions: Check TotalHeight > 0, Diameter > 0. If invalid, report error and delete instance.",
          "Validate Logic: Check TotalHeight >= Height. If invalid, report error and delete instance.",
          "Geometry Generation: Calculate Cut plane, Main Drill, Sink Drill (if depth > 0), and Visual Bodies (Cylinder, Baseplate, Pressure Plate, Screw Head).",
          "Layer/Group Assignment: Check sLayerGroup property.",
          "Assign entity to existing Group (if name matches), or Layer/Zone based on character code ('T','I','J','Z','C'), or create custom Layer.",
          "Finalize: Display geometry in ModelSpace."
        ],
        "conditionalBranches": [
          {
            "condition": "Check execution context (_kExecuteKey)",
            "path1": {
              "name": "Manual Insert",
              "steps": [
                "Show showDialog() for user to input dimensions.",
                "Proceed to selection prompts."
              ]
            },
            "path2": {
              "name": "Catalog Insert",
              "steps": [
                "Call setPropValuesFromCatalog(_kExecuteKey).",
                "Skip Dialog, proceed to selection prompts."
              ]
            }
          },
          {
            "condition": "Sink Drill creation",
            "path1": {
              "name": "Create Sink Drill",
              "steps": [
                "Condition: dDepthSink > 0 AND dDiameterPressurePlate > 0",
                "Action: Add drill operation for counterbore at reference point."
              ]
            },
            "path2": {
              "name": "No Sink Drill",
              "steps": [
                "Condition: Else",
                "Action: Skip adding sink drill to beam."
              ]
            }
          },
          {
            "condition": "Layer/Group Assignment (sLayerGroup)",
            "path1": {
              "name": "Assign to Existing Group",
              "steps": [
                "Condition: sLayerGroup matches an existing Group name.",
                "Action: Add instance to that Group."
              ]
            },
            "path2": {
              "name": "Assign by Zone/Char Code",
              "steps": [
                "Condition: sLayerGroup is a single char ('T','I','J','Z','C').",
                "Action: Inherit layer from beam and assign specific Zone index."
              ]
            },
            "path3": {
              "name": "Assign to Custom Layer",
              "steps": [
                "Condition: sLayerGroup is not a group name or zone char.",
                "Action: Create/Assign to layer named sLayerGroup."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Orientation (Verticality)",
            "errorMessage": "The Tool may only be inserted at the bottom of a beam which is like a post",
            "recovery": "Delete instance automatically. User must rotate beam or insert on a vertical column."
          },
          {
            "check": "Minimum Dimensions",
            "errorMessage": "The Total Height and the Diameter must be greater than Zero",
            "recovery": "Delete instance automatically. User must adjust properties."
          },
          {
            "check": "Logical Dimension Relationship",
            "errorMessage": "The Total Height must be bigger then Height",
            "recovery": "Delete instance automatically. User must adjust Total Height to be greater than Height."
          },
          {
            "check": "Beam Selection",
            "errorMessage": "No error message, just instance deletion",
            "recovery": "User must run script again and select at least one beam."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Dimensions",
            "how": "OPM (Object Properties Manager)",
            "effect": "Updates geometry (Drill depth, Cut position, Body sizes) immediately upon recalculation."
          },
          {
            "action": "Move/Insertion Point Adjustment",
            "how": "Grip Edit (Grip at _Pt0)",
            "effect": "Moves the location of the cut and drills along the beam centerline."
          },
          {
            "action": "Change Layer/Group",
            "how": "OPM (sLayerGroup property)",
            "effect": "Re-assigns the instance to a different layer or group based on the string input."
          },
          {
            "action": "Update from Catalog",
            "how": "Right-click context menu (Standard TSL behavior, though no specific addRecalcTrigger is visible in this snippet, standard catalogs apply).",
            "effect": "Overwrites properties with catalog values."
          }
        ]
      },
      "tokens_used": 7396,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Merk Stutzenfuss K1\n\n## Overview\nInserts a \"Merk\" brand post shoe (column base) hardware component into vertical timber posts. It generates the 3D hardware visualization and automatically applies the necessary trimming and drilling machining to the beam.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model to modify beam geometry and add bodies. |\n| Paper Space | No | Not designed for 2D drawings or layouts. |\n| Shop Drawing | No | Not a shop drawing generation script. |\n\n## Prerequisites\n- **Required Entities**: `GenBeam` (The timber post/column).\n- **Minimum beam count**: 1\n- **Required settings**: None. (Can use standard Catalogs for preset values).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or run `Merk Stutzenfuss K1.mcr` from the script menu).\n*   **Action**: If executed via `TSLINSERT`, select the script file from the file browser.\n\n### Step 2: Configure Dimensions (Optional)\n*   **Condition**: This step occurs if you do not use a specific Catalog Key during insertion.\n*   **Action**: A dialog will appear displaying parameters like Height, Diameter, and Baseplate dimensions. Adjust these values as needed for your connection.\n\n### Step 3: Select Post\n```\nCommand Line: Select post(s)\nAction: Click on the timber beam(s) (posts) where you want to install the base. Press Enter to confirm selection.\n```\n\n### Step 4: Define Insertion Point\n```\nCommand Line: Select insertion point\nAction: Click on the beam or in 3D space to define the location of the post base. This point typically defines where the rod enters the timber.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Height | Number | 200 mm | The depth the metal rod inserts into the timber post. This defines the reference point for the cut. |\n| Total Height | Number | 300 mm | The total length of the vertical metal rod. Must be greater than the Height value. |\n| Diameter | Number | 40 mm | The thickness of the central metal rod. This controls the main drill hole size. |\n| Extra Drilling Depth | Number | 0 mm | Additional depth drilled below the metal rod length (e.g., for drainage). |\n| Depth Housing | Number | 20 mm | The depth of the counterbore (recess) required to sink the pressure plate into the timber. |\n| Diameter Pressure Plate | Number | 75 mm | The diameter of the pressure plate (flange). This controls the width of the counterbore sink drill. |\n| Width Base | Number | 100 mm | The width (X-axis) of the rectangular bottom baseplate. |\n| Length Base | Number | 180 mm | The length (Y-axis) of the rectangular bottom baseplate. |\n| Color | Number | 253 | The ACI color index used to display the hardware bodies in the model. |\n| Group, Layername or Zone Character | Text | Z | Determines layer management. Can match a Group name, a single character code (T, I, J, Z, C), or a custom layer name. |\n\n## Right-Click Menu Options\n*Note: This script uses standard TSL behavior and does not define custom context menu items.*\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the Properties Palette to edit dimension parameters. |\n| Erase | Removes the script instance and repairs the beam machining (if dynamic update is active). |\n\n## Settings Files\n- **Filename**: N/A (Internal Defaults)\n- **Purpose**: The script uses internal default values, but can be linked to standard hsbCAD Catalogs (`.catalog` files) to load predefined configurations via the `_kExecuteKey` parameter.\n\n## Tips\n- **Vertical Orientation**: The script validates that the beam is vertical (like a post). If the script disappears immediately after insertion, check that your beam is oriented correctly (Local X axis aligned with World Z).\n- **Grip Editing**: You can select the inserted hardware and drag the blue grip to move the insertion point up or down the post. The drilling and cuts will update automatically.\n- **Relationship Check**: Ensure `Total Height` is always larger than `Height`. If not, the script will delete itself to prevent invalid geometry.\n- **Layer Management**: Using the character \"Z\" in the Group property usually assigns the element to the Zone layer of the beam.\n\n## FAQ\n- **Q: Why did the script delete itself immediately after I selected the beam?**\n  - A: The beam orientation check failed. This tool is designed for vertical columns only. Ensure the beam's local X-axis is pointing vertically (World Z).\n- **Q: Why did the script delete itself after changing properties?**\n  - A: You likely set the `Total Height` to be smaller than the `Height`, or set a Diameter to 0. Correct these values in the Properties Panel.\n- **Q: Can I use this on inclined beams?**\n  - A: No, the script explicitly checks for vertical posts (\"The Tool may only be inserted at the bottom of a beam which is like a post\")."
      },
      "tokens_used": 6696,
      "error": null
    }
  }
}