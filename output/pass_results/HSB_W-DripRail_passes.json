{
  "filename": "HSB_W-DripRail.mcr",
  "status": "completed",
  "total_tokens": 49985,
  "processing_time": 229.63701677322388,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "03.03.2015",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "29jun2020",
            "author": "NG",
            "changes": "HSB-8140 Bugfix opening size and added sides"
          },
          {
            "version": "1.02",
            "date": "03jul2020",
            "author": "NG",
            "changes": "HSB-8140 Bugfix beamcut. Can beadded multiple times"
          },
          {
            "version": "1.03",
            "date": "30jul2020",
            "author": "NG",
            "changes": "HSB-8140 Changed image and add offset outside"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8234,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses `_kModelSpace` explicitly during `tsl.dbCreate`. It manipulates 3D geometry (`OpeningSF`, `Element`, `Body`, `CoordSys`) and does not contain paper space specific keywords like `sd_`, `_Viewport`, or drawing layout logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "OpeningSF",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space. The script requires a valid Element to exist in the model, and the user must select at least one valid OpeningSF entity during the insertion process.",
          "requiredSettings": []
        }
      },
      "tokens_used": 5029,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && (_kExecuteKey == \"\" || arSCatalogNames.find(_kExecuteKey) == -1)",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "|Select one or more openings|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "On Insert (if not called via execute key)",
            "title": null,
            "dataSource": "Properties defined in script",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dOffsetDripRail",
            "type": "PropDouble",
            "displayName": "|Offset from top opening|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Position|",
            "description": "|Sets the offset from the top of the opening outline.|"
          },
          {
            "index": 10,
            "variable": "dOffsetOutside",
            "type": "PropDouble",
            "displayName": "|Offset from outside|",
            "defaultValue": "10",
            "inputType": "number",
            "options": [],
            "category": "|Position|",
            "description": "|Defines the offset from the outside of the wall|"
          },
          {
            "index": 0,
            "variable": "nZoneDripRail",
            "type": "PropInt",
            "displayName": "|Place drip rail on top of zone|",
            "defaultValue": "0",
            "inputType": "dropdown",
            "options": [
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7",
              "8",
              "9"
            ],
            "category": "|Position|",
            "description": "|Sets the zone to mount the drip rail on.|"
          },
          {
            "index": 2,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "|Orientation|",
            "defaultValue": "|Opposite side|",
            "inputType": "dropdown",
            "options": [
              "|Icon side|",
              "|Opposite side|"
            ],
            "category": "|Position|",
            "description": "|Defines the orientation of the drip rail|"
          },
          {
            "index": 3,
            "variable": "sPosition",
            "type": "PropString",
            "displayName": "|Position|",
            "defaultValue": "|Bottom|",
            "inputType": "dropdown",
            "options": [
              "|Top|",
              "|Bottom|"
            ],
            "category": "|Position|",
            "description": "|Defines the Position of the drip edge towards the opening|"
          },
          {
            "index": 3,
            "variable": "dtDripRail",
            "type": "PropDouble",
            "displayName": "|Thickness drip rail|",
            "defaultValue": "8",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the thickness of the drip rail.|"
          },
          {
            "index": 2,
            "variable": "dExtendToSide",
            "type": "PropDouble",
            "displayName": "|Extend to side of opening|",
            "defaultValue": "98",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the extends to the side of the opening outline.|"
          },
          {
            "index": 1,
            "variable": "dhDripRail",
            "type": "PropDouble",
            "displayName": "|Height mounting face|",
            "defaultValue": "80",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the height of the mounting face of the drip rail.|"
          },
          {
            "index": 4,
            "variable": "dAngle",
            "type": "PropDouble",
            "displayName": "|Angle angled part|",
            "defaultValue": "15",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the angle of the angled part of the drip rail.|"
          },
          {
            "index": 5,
            "variable": "dhAngledDripRail",
            "type": "PropDouble",
            "displayName": "|Height angled part|",
            "defaultValue": "60",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the height of the angled part of the drip rail.|"
          },
          {
            "index": 6,
            "variable": "dhFrontDripRail",
            "type": "PropDouble",
            "displayName": "|Height front part|",
            "defaultValue": "60",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the height of the front part of the drip rail.|"
          },
          {
            "index": 1,
            "variable": "nColorDripRail",
            "type": "PropInt",
            "displayName": "|Color drip rail|",
            "defaultValue": "8",
            "inputType": "number",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the color of the drip rail|"
          },
          {
            "index": 1,
            "variable": "sArticle",
            "type": "PropString",
            "displayName": "|Article number|",
            "defaultValue": "DR-012345",
            "inputType": "text",
            "options": [],
            "category": "|Drip rail|",
            "description": "|Sets the article number.|"
          },
          {
            "index": 0,
            "variable": "sZonesToCut",
            "type": "PropString",
            "displayName": "|Zones to cut|",
            "defaultValue": "3",
            "inputType": "text",
            "options": [],
            "category": "|Tooling|",
            "description": "|Sets the zones to cut.| |Separate the indexes with a semicolon|"
          },
          {
            "index": 7,
            "variable": "dGapBottom",
            "type": "PropDouble",
            "displayName": "|Gap bottom|",
            "defaultValue": "2",
            "inputType": "number",
            "options": [],
            "category": "|Tooling|",
            "description": "|Sets gap at the bottom of the drip rail.|"
          },
          {
            "index": 8,
            "variable": "dGapTop",
            "type": "PropDouble",
            "displayName": "|Gap top|",
            "defaultValue": "2",
            "inputType": "number",
            "options": [],
            "category": "|Tooling|",
            "description": "|Sets gap at the top of the drip rail.|"
          },
          {
            "index": 9,
            "variable": "dGapSide",
            "type": "PropDouble",
            "displayName": "|Gap side|",
            "defaultValue": "2",
            "inputType": "number",
            "options": [],
            "category": "|Tooling|",
            "description": "|Sets gap at the side of the drip rail.|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8775,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Generates a parametric metal drip rail (flashing) over or below wall openings and cuts the necessary voids in wall sheeting to accommodate it.\",\n    \"category\": \"Hardware/Cladding\",\n    \"typicalUseCase\": \"Adding flashing above windows or doors to divert water away"
      },
      "tokens_used": 10726,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched via command or catalog.",
          "Check if triggered via an Execute Key (Catalog Name).",
          "[Conditional] If no Execute Key: Open Properties Dialog for user configuration.",
          "Prompt user to select one or more OpeningSF entities.",
          "Iterate through selected openings.",
          "Validate if OpeningSF is valid and has a valid parent Element.",
          "Create a Satellite instance linked to the OpeningSF.",
          "[Satellite Start] Inherit properties from Master (if inserted manually) or Catalog.",
          "Determine Reference Coordinate System based on Element and 'Place drip rail on top of zone' setting.",
          "Parse 'Zones to cut' string into an array of integer zone indexes.",
          "Calculate Opening geometry: Get vertices, order them, and derive Width/Height/Bottom-Left/Top-Right points.",
          "Calculate Drip Rail Base Point (using offsets and opening dimensions).",
          "Construct Solid Body: Create Mounting Area, Angled Part, and Front Part based on dimensions.",
          "Combine body parts into single 'bdDripRail' body.",
          "[Conditional] Apply Orientation: Rotate 180 degrees if 'Side' is set to 'Opposite side'.",
          "[Conditional] Apply Vertical Position: Translate down by opening height if 'Position' is 'Bottom'.",
          "Draw the final Body in the model.",
          "[Conditional] Create BeamCuts: If valid dimensions exist, apply void to GenBeams in specified zones (including gaps).",
          "Update Hardware Component data (Article number, description) if properties changed or created."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion Method",
            "path1": {
              "name": "Manual Insert",
              "steps": [
                "Trigger `showDialog()`",
                "User adjusts properties in OPM",
                "User selects Openings",
                "Settings passed via Map ('MasterToSatellite')"
              ]
            },
            "path2": {
              "name": "Catalog/Execute Key",
              "steps": [
                "Load properties from Catalog",
                "Skip Dialog",
                "User selects Openings",
                "Settings passed via Map ('MasterToSatellite')"
              ]
            }
          },
          {
            "condition": "Property 'Orientation' (sSide)",
            "path1": {
              "name": "Icon side (Index 0)",
              "steps": [
                "Construct body normally",
                "No rotation applied"
              ]
            },
            "path2": {
              "name": "Opposite side (Index 1)",
              "steps": [
                "Construct body normally",
                "Rotate body 180 degrees around Element Y-axis"
              ]
            }
          },
          {
            "condition": "Property 'Position' (sPosition)",
            "path1": {
              "name": "Top (Index 0)",
              "steps": [
                "Calculate position based on top of opening + offset",
                "Do not apply vertical translation"
              ]
            },
            "path2": {
              "name": "Bottom (Index 1)",
              "steps": [
                "Calculate position",
                "Translate body vertically by '- Opening Height'",
                "Adjust Cut Point (ptBC) accordingly"
              ]
            }
          },
          {
            "condition": "Cutting Geometry Validation",
            "path1": {
              "name": "Valid Dimensions",
              "steps": [
                "Check (dhDripRail + dGapBottom + dGapTop > Epsilon)",
                "Create BeamCut object",
                "Iterate parsed zones and add cuts to GenBeams"
              ]
            },
            "path2": {
              "name": "Invalid/Zero Dimensions",
              "steps": [
                "Skip BeamCut creation",
                "Sheathing remains uncut"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selected Entity Validity",
            "errorMessage": "None (Silent fail/erase instance)",
            "recovery": "User must select a valid OpeningSF entity. Script erases itself if entity is invalid."
          },
          {
            "check": "Parent Element Validity",
            "errorMessage": "None (Silent fail/erase instance)",
            "recovery": "Ensure the OpeningSF is attached to a valid Element. Script erases itself if element is invalid."
          },
          {
            "check": "Opening Outline Geometry",
            "errorMessage": "\"Invalid opening outline found in element [ElementNumber]\"",
            "recovery": "Repair the OpeningSF geometry (ensure it has a valid closed profile). Script erases instance."
          },
          {
            "check": "Zone Index Parsing ('sZonesToCut')",
            "errorMessage": "\"[ElementNumber] Zone 0 is not a valid zone to cut out.\"",
            "recovery": "Update 'Zones to cut' property to use valid zone numbers (1-9). Script skips the invalid zone and continues."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Dimensions",
            "how": "OPM (Properties Palette)",
            "effect": "Rebuilds the Drip Rail body (Mounting height, Angle, Thickness, etc.) and redraws it."
          },
          {
            "action": "Adjust Positioning",
            "how": "OPM (Properties Palette)",
            "effect": "Moves the Drip Rail (Offset from top/outside) or flips it (Top/Bottom, Icon/Opposite side) and updates the cut location in the wall."
          },
          {
            "action": "Change Tooling/Cuts",
            "how": "OPM (Properties Palette)",
            "effect": "Modifies the size of the void cut into the wall sheeting (Gaps) or changes which zones (layers) are cut."
          },
          {
            "action": "Update Hardware Info",
            "how": "OPM (Properties Palette)",
            "effect": "Updates the Article Number and associated metadata in the element's hardware list."
          }
        ]
      },
      "tokens_used": 10580,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_W-DripRail\n\n## Overview\nThis script automatically generates a parametric metal drip rail (flashing) over or below wall openings. It also creates the necessary voids (cuts) in the wall sheeting to ensure a proper fit.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in 3D model space. |\n| Paper Space | No | Not designed for 2D layouts. |\n| Shop Drawing | No | Manufacturing data is handled via the 3D model and Element properties. |\n\n## Prerequisites\n- **Required Entities:** An existing `OpeningSF` (Opening) attached to a valid `Element` (Wall).\n- **Minimum Beam Count:** 0 (This is a detailing accessory, not a beam generator).\n- **Required Settings:** None required; uses internal defaults.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse to and select `HSB_W-DripRail.mcr`.\n\n### Step 2: Configure Properties (Optional)\n*   If the script is run manually (not via a specific Catalog execute key), a properties dialog may appear automatically.\n*   You can adjust parameters like dimensions, offsets, and which zones to cut.\n*   Click **OK** to confirm.\n\n### Step 3: Select Openings\n```\nCommand Line: Select one or more openings\nAction: Click on one or more window or door openings in your drawing.\n```\n*   Press **Enter** to complete selection.\n\n### Step 4: Verification\nThe script will generate the drip rail solid and apply cuts to the specified layers (zones) of the wall. If the opening geometry is invalid, the script instance will erase itself.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Offset from top opening** | Number | 0 | Sets the vertical offset from the top of the opening outline. |\n| **Offset from outside** | Number | 10 | Defines the offset from the outside face of the wall. |\n| **Place drip rail on top of zone** | Dropdown | 1 | Sets the specific zone (layer) to use as the reference for mounting (1-9). |\n| **Orientation** | Dropdown | Opposite side | Defines the side of the wall: \"Icon side\" or \"Opposite side\". |\n| **Position** | Dropdown | Bottom | Defines the position relative to the opening: \"Top\" or \"Bottom\". |\n| **Thickness drip rail** | Number | 8 | Sets the material thickness of the drip rail. |\n| **Extend to side of opening** | Number | 98 | Sets how far the drip rail extends horizontally past the opening sides. |\n| **Height mounting face** | Number | 80 | Sets the vertical height of the mounting face. |\n| **Angle angled part** | Number | 15 | Sets the angle of the angled section (in degrees). |\n| **Height angled part** | Number | 60 | Sets the height of the angled section. |\n| **Height front part** | Number | 60 | Sets the height of the front vertical face. |\n| **Color drip rail** | Number | 8 | Sets the CAD color index for the drip rail. |\n| **Article number** | Text | DR-012345 | Sets the article number for reporting/bills of materials. |\n| **Zones to cut** | Text | 3 | Specifies which wall zones (layers) to cut. Separate multiple zones with a semicolon (e.g., \"1;3\"). |\n| **Gap bottom** | Number | 2 | Clearance gap at the bottom of the cut in the sheeting. |\n| **Gap top** | Number | 2 | Clearance gap at the top of the cut in the sheeting. |\n| **Gap side** | Number | 2 | Clearance gap at the sides of the cut in the sheeting. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | This script uses standard AutoCAD/hsbCAD interaction (Properties Palette) for modifications. No custom context menu items are added. |\n\n## Settings Files\nNo external settings files are required. All configuration is handled via the Properties Palette (OPM).\n\n## Tips\n- **Multiple Openings:** You can select multiple openings at once during the insertion prompt to apply the same drip rail configuration to all of them.\n- **Positioning:** Use the **Position** property to quickly toggle between installing the rail above the window (Top) or below the window (Bottom).\n- **Cutting Zones:** Ensure the **Zones to cut** property matches the actual sheeting layer numbers in your wall composition (e.g., Zone 3 might be the outer sheathing).\n- **Article Numbers:** Update the **Article number** property to ensure accurate material lists and production reports.\n\n## FAQ\n- **Q: The drip rail disappeared after I selected the opening. Why?**\n  **A:** The script erases itself if the selected OpeningSF does not have a valid geometry outline or if it is not attached to a valid wall Element. Check your wall and opening definitions.\n- **Q: The visual is there, but the sheeting isn't cut out.**\n  **A:** Check the **Zones to cut** property. You may have entered a zone index that does not exist in the element (e.g., Zone 0 or a zone higher than the total layers). Also, ensure the **Height mounting face** combined with gaps is not zero.\n- **Q: How do I flip the drip rail to the inside of the wall?**\n  **A:** Change the **Orientation** property to \"Opposite side\" or \"Icon side\" to rotate the component 180 degrees around the wall's Y-axis."
      },
      "tokens_used": 6641,
      "error": null
    }
  }
}