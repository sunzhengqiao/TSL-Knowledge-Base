{
  "filename": "hsbRP_Roofline.mcr",
  "status": "completed",
  "total_tokens": 46704,
  "processing_time": 546.8814280033112,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7700,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script interacts directly with ERoofPlane entities and creates 3D geometry (Body) based on points selected via getPoint. It utilizes U() for unit conversion and Display for drawing, which are characteristic of ModelSpace operations. There are no 'sd_' prefixes, Multipage indicators, or ShopDrawing specific constructs (#Type E) present."
        },
        "prerequisites": {
          "requiredEntities": [
            "ERoofPlane"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script relies on the existence of Roofplanes in the model to calculate dimensions, angles, and extract associated beam information. It is designed to be inserted manually or via the hsbRP_Analysis script.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4101,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity.go",
              "promptOriginal": "Select roofplanes",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Select Startpoint",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "Select Endpoint",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nDecimals",
            "type": "PropInt",
            "displayName": "Decimals",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              0,
              1,
              2,
              3,
              4
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sType",
            "type": "PropString",
            "displayName": "Type",
            "defaultValue": "Eave",
            "inputType": "dropdown",
            "options": [
              "Eave",
              "Gable End",
              "Hip",
              "Valley",
              "Ridge",
              "Rising Eave",
              "Verfallgrat",
              "Opening top",
              "Opening bottom",
              "Opening left",
              "Opening right",
              "Opening left sloped",
              "Opening right sloped",
              "Wall connection"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sUnit",
            "type": "PropString",
            "displayName": "Unit",
            "defaultValue": "mm",
            "inputType": "dropdown",
            "options": [
              "mm",
              "cm",
              "m",
              "inch",
              "feet"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sGroup",
            "type": "PropString",
            "displayName": "Group (seperate Level by'\\')",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sOverwriteType",
            "type": "PropString",
            "displayName": "Type overwriting",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sShowPos",
            "type": "PropString",
            "displayName": "Show PosNum",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Eave",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Eave",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Gable End",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Gable End",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Hip",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Hip",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Valley",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Valley",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Ridge",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Ridge",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Rising Eave",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Rising Eave",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Verfallgrat",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Verfallgrat",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening top",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening top",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening bottom",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening bottom",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening left",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening left",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening right",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening right",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening left sloped",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening left sloped",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Opening right sloped",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Opening right sloped",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Wall connection",
            "handler": "sType.set()",
            "action": "Sets the roofline type to Wall connection",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Swap description side",
            "handler": "_kExecuteKey",
            "action": "Toggles the side (nSwapSide) where the description text is drawn",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8116,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates, labels, and exports the 3D length and angles of specific roof edges (eaves, ridges, hips, valleys) directly in the model.",
          "category": "Annotation/Measurement",
          "typicalUseCase": "Automating the quantification of roof elements for manufacturing lists (BOM) and providing on-screen visual verification of roof dimensions."
        },
        "parameters": [
          {
            "name": "sType",
            "technicalDefault": "Eave",
            "businessMeaning": "The classification of the roof edge being measured. This defines the semantic meaning of the element (e.g., is it a hip, a valley, or an eave?) and drives specific geometric calculations like bevel angles.",
            "validRange": "Eave, Gable End, Hip, Valley, Ridge, Rising Eave, Verfallgrat, Opening top/bottom/left/right, Wall connection",
            "unit": "Enumeration",
            "affectsOutput": "Updates the text label prefix. If 'Hip' or 'Valley' is selected, it triggers the calculation of supplementary angles (slope angle and hip bevel angle) to be displayed."
          },
          {
            "name": "sOverwriteType",
            "technicalDefault": "",
            "businessMeaning": "A manual or automation override used to force a specific 'Type'. It allows external scripts (like hsbRP_Analysis) to pre-define the edge type based on geometric analysis, overriding the user's default selection.",
            "validRange": "String matching a valid Type",
            "unit": "Text",
            "affectsOutput": "Forces the 'sType' parameter to the specified value immediately upon recalculation. If the user manually changes 'sType', this field is cleared."
          },
          {
            "name": "sUnit",
            "technicalDefault": "mm",
            "businessMeaning": "The measurement unit used for the dimension display and reporting.",
            "validRange": "mm, cm, m, inch, feet",
            "unit": "UnitSystem",
            "affectsOutput": "Scales the numerical length value displayed in the text label and exported to the BOM data."
          },
          {
            "name": "nDecimals",
            "technicalDefault": 0,
            "businessMeaning": "The precision of the measurement displayed.",
            "validRange": "0, 1, 2, 3, 4",
            "unit": "Integer",
            "affectsOutput": "Rounds the calculated length in the text label to the specified number of decimal places."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The CAD style definition controlling the font, size, and color of the dimension label.",
            "validRange": "Any dimension style defined in the current drawing",
            "unit": "StyleName",
            "affectsOutput": "Changes the visual appearance (font, height) of the roofline text label."
          },
          {
            "name": "sGroup",
            "technicalDefault": "",
            "businessMeaning": "Categorization tag for organizing the roofline instance. Supports nested hierarchies (e.g., 'Ground Floor\\Roof') for filtering in schedules or layer management.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Assigns the script instance to a specific CAD Group and passes this string to BOM exports for sorting and filtering."
          },
          {
            "name": "sShowPos",
            "technicalDefault": "No",
            "businessMeaning": "Controls whether the unique Position Number (PosNum) of this specific label is included in the text.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "If 'Yes', prepends the label with 'PosNum: ' (e.g., '101: Eave 5000mm')."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sOverwriteType contains a value",
            "effect": "sType is forced to the value of sOverwriteType",
            "cascade": [
              "sType"
            ]
          },
          {
            "trigger": "User manually changes sType",
            "effect": "sOverwriteType is cleared (set to empty)",
            "cascade": [
              "sOverwriteType"
            ]
          },
          {
            "trigger": "sType is 'Hip' or 'Valley'",
            "effect": "Triggers angle calculation logic (dAngleHip, dAngle)",
            "cascade": [
              "Text Label Content"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (Visual Marker)",
            "description": "A thin cylindrical body (0.5mm diameter) generated between the start and end points to visually represent the roof edge in the 3D model.",
            "appliedTo": "ModelSpace (Line defined by user grips)"
          },
          {
            "type": "Text Label",
            "description": "A dynamic text string displaying the Type, Length, Unit, and Angles (if applicable). The text can be flipped to the other side of the line via context menu.",
            "appliedTo": "ModelSpace"
          },
          {
            "type": "BOM/Map Data",
            "description": "Attributes (Type, Length, Angle, Group, Roof Handles) written to the instance Map and DXI for export to Excel or lists.",
            "appliedTo": "Data Export (hsbRP_BOM, hsbExcel)"
          }
        ]
      },
      "tokens_used": 9277,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Insertion Started: User launches hsbRP_Roofline.mcr.",
          "2. Properties Dialog: Initial Properties Palette (OPM) or dialog appears via showDialog().",
          "3. Entity Selection: Prompt 'Select roofplanes' appears. User selects one or two ERoofPlane entities.",
          "4. Geometry Input: Prompt 'Select Startpoint' appears. User picks point.",
          "5. Geometry Input: Prompt 'Select Endpoint' appears. User picks point.",
          "6. Save & Exit: Selected roofplanes are stored in the internal Map. Script returns and waits for the first recalculation.",
          "7. [Recalculation] Input Validation: Script checks if points exist and distance > 0.1mm. If fail, instance is erased.",
          "8. [Recalculation] Automation Handling: Checks 'Type overwriting' (sOverwriteType). If set, it forces 'sType' to this value.",
          "9. [Recalculation] Context Menu Setup: Generates list of Roofline Types + 'Swap description side' and adds to Right-Click menu.",
          "10. [Recalculation] Dependency Check: Retrieves stored Roofplanes from Map. If Roofplanes are invalid, instance is erased.",
          "11. [Recalculation] Vector Calculation: Calculates directional vectors (vx, vy, vz) and Length between points.",
          "12. [Recalculation] Text Alignment Check: If this is the moment of creation (_bOnDbCreated), script checks if the calculated text position is inside the Roofplane profile. If outside, it automatically flips the text side (nSwapSide) and re-executes the script.",
          "13. [Recalculation] Beam Detection: Searches for beams within the selected Roofplanes that are parallel to the roofline and intersecting the defined body.",
          "14. [Recalculation] Angle Logic: If Type is 'Hip' (2) or 'Valley' (3), script calculates slope angle and hip bevel angle.",
          "15. [Recalculation] Visualization: Creates a cylindrical Body along the line and generates the dimension Text Label.",
          "16. [Recalculation] Export: Writes properties (Type, Length, Angles, Beam Handles, Roof Handles) to the instance Map and DXI for BOM extraction."
        ],
        "conditionalBranches": [
          {
            "condition": "sOverwriteType contains a value AND User has NOT manually changed sType",
            "path1": {
              "name": "Automation Mode",
              "steps": [
                "sType is forcibly set to the value of sOverwriteType.",
                "Script proceeds with calculations based on this forced type."
              ]
            },
            "path2": {
              "name": "Manual Override",
              "steps": [
                "If user edits sType manually, sOverwriteType is immediately cleared (set to '').",
                "Script proceeds with the user-selected type."
              ]
            }
          },
          {
            "condition": "Check text position during creation (_bOnDbCreated)",
            "path1": {
              "name": "Text Inside Profile",
              "steps": [
                "Text position is validated against Roofplane envelope.",
                "Script draws text normally.",
                "Script completes execution."
              ]
            },
            "path2": {
              "name": "Text Outside Profile",
              "steps": [
                "Text position is validated against Roofplane envelope.",
                "nSwapSide variable is inverted (multiplied by -1).",
                "Map is updated with new swap side.",
                "Script sets execution loops to 2 (re-runs immediately)."
              ]
            }
          },
          {
            "condition": "sType is Hip or Valley (Index 2 or 3)",
            "path1": {
              "name": "Complex Geometry",
              "steps": [
                "Calculate Hip/Valley Bevel Angle (dAngleHip) using adjacent roofplane vectors.",
                "Calculate Base Slope Angle (dAngle).",
                "Format text string to include angles.",
                "Append angles to BOM export data."
              ]
            },
            "path2": {
              "name": "Simple Geometry",
              "steps": [
                "Skip angle calculations.",
                "Format text string with Type, Length, and Unit only.",
                "Export basic data to BOM."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Point Distance",
            "errorMessage": "None (Silent failure/Erasure)",
            "recovery": "Ensure Start and End points selected during insertion are distinct points not closer than 0.1mm. Script erases itself if this fails."
          },
          {
            "check": "Roofplane Validity",
            "errorMessage": "None (Silent failure/Erasure)",
            "recovery": "Ensure selected ERoofPlane entities exist and are valid in the model. If a roofplane is deleted or becomes invalid, the script instance erases itself."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Roofline Type",
            "how": "Properties Palette (OPM) or Right-Click Context Menu",
            "effect": "Updates the text label prefix. If changed to Hip/Valley, triggers angle calculations. If changed via Context Menu, it clears the 'Type overwriting' field."
          },
          {
            "action": "Swap Description Side",
            "how": "Right-Click Context Menu",
            "effect": "Flips the text label to the opposite side of the roofline vector. Updates the internal 'swapDesc' map variable."
          },
          {
            "action": "Edit Geometry (Grip Edit)",
            "how": "Drag Start/End grips or Text position grip",
            "effect": "Recalculates Length and Vectors. Updates Text Label content and position. Re-evaluates associated beams."
          },
          {
            "action": "Modify Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Unit display (mm/inch), Decimal precision, Group assignment, or Dimension Style."
          }
        ]
      },
      "tokens_used": 10064,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbRP_Roofline.mcr\n\n## Overview\nThis script calculates, labels, and displays the 3D length and specific angles of roof edges (such as eaves, ridges, hips, and valleys) directly in the model. It generates visual markers and text labels to assist with quantification and manufacturing lists.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Primary working environment for inserting rooflines and visualizing dimensions. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | Not applicable. |\n\n## Prerequisites\n- **Required entities**: At least one `ERoofPlane` (Roofplane) must exist in the model.\n- **Minimum beam count**: 0 (The script detects associated beams automatically but does not require them to run).\n- **Required settings files**: None. The script uses standard AutoCAD dimension styles available in the drawing.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbRP_Roofline.mcr` from the list.\n\n### Step 2: Select Roofplanes\n```\nCommand Line: Select roofplanes\nAction: Click on the Roofplane(s) in the model that define the roof edge you want to measure. Press Enter to confirm selection.\n```\n\n### Step 3: Define Startpoint\n```\nCommand Line: Select Startpoint\nAction: Click the location in 3D space where the roofline measurement should begin (e.g., the corner of the eave).\n```\n\n### Step 4: Define Endpoint\n```\nCommand Line: Select Endpoint\nAction: Click the location in 3D space where the roofline measurement should end.\n```\n*Note: If the start and end points are too close (less than 0.1mm apart), the script instance will be automatically erased.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Type | dropdown | Eave | Defines the classification of the roof edge (e.g., Hip, Valley, Ridge, Gable End). Selecting \"Hip\" or \"Valley\" enables angle calculations. |\n| Type overwriting | text | | Used by automation scripts (e.g., hsbRP_Analysis) to force a specific type. If you manually change \"Type\", this field clears. |\n| Unit | dropdown | mm | The unit of measurement displayed in the label and exported to lists (mm, cm, m, inch, feet). |\n| Decimals | dropdown | 0 | Sets the precision of the displayed length (0 to 4 decimal places). |\n| Dimstyle | dropdown | _DimStyles | Selects the visual style (font, size, color) for the text label based on the drawing's available dimension styles. |\n| Group (seperate Level by'\\') | text | | Organizes the element for BOM exports. Use backslashes (e.g., \"Floor 1\\Roof\") to create sub-groups. |\n| Show PosNum | dropdown | No | If set to \"Yes\", displays the script's unique Position Number (PosNum) within the text label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Eave | Sets the roofline type to \"Eave\". |\n| Gable End | Sets the roofline type to \"Gable End\". |\n| Hip | Sets the roofline type to \"Hip\". This calculates and displays the slope and bevel angles. |\n| Valley | Sets the roofline type to \"Valley\". This calculates and displays the slope and bevel angles. |\n| Ridge | Sets the roofline type to \"Ridge\". |\n| Rising Eave | Sets the roofline type to \"Rising Eave\". |\n| Verfallgrat | Sets the roofline type to \"Verfallgrat\". |\n| Opening top / bottom / left / right | Sets the roofline type to the specific opening edge. |\n| Wall connection | Sets the roofline type to \"Wall connection\". |\n| Swap description side | Flips the text label to the opposite side of the roofline vector. |\n\n## Settings Files\n- **Filename**: N/A\n- **Location**: N/A\n- **Purpose**: This script relies on the drawing's internal Dimension Styles (`_DimStyles`) rather than external settings files.\n\n## Tips\n- **Visualizing Angles**: Change the **Type** property to \"Hip\" or \"Valley\" to automatically calculate and display the slope and bevel angles in the label.\n- **Text Positioning**: If the text label appears on the wrong side of the line or overlaps geometry, right-click the script instance and select **Swap description side**. The script also attempts to auto-detect the correct side upon insertion.\n- **Grip Editing**: You can drag the Startpoint, Endpoint, or Text Position grips to adjust the geometry dynamically. The length and label will update instantly.\n- **Data Export**: The calculated length and angles are stored in the element properties and can be exported to Excel or BOM lists using the \"Group\" parameter to filter items.\n\n## FAQ\n- **Q: Why did my label disappear after insertion?**\n  **A:** The script automatically erases itself if the Startpoint and Endpoint are identical or closer than 0.1mm. Ensure you pick two distinct points in 3D space.\n- **Q: Can I measure a wall plate instead of a roof edge?**\n  **A:** Yes. Select the relevant Roofplanes, pick the wall start and end points, and set the **Type** to \"Wall connection\" in the properties.\n- **Q: How do I change the units from mm to inches?**\n  **A:** Select the script instance, open the Properties palette (Ctrl+1), and change the **Unit** dropdown to \"inch\" or \"feet\". The label will update immediately."
      },
      "tokens_used": 7446,
      "error": null
    }
  }
}