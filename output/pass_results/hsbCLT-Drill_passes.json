{
  "filename": "hsbCLT-Drill.mcr",
  "status": "completed",
  "total_tokens": 51158,
  "processing_time": 347.44266724586487,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9019,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script filename 'hsbCLT-Drill.mcr' does not start with 'sd_' or 'Multipage'. Summary describes 'creates a free drill in a panel'. Code lacks 'sd_' prefixes, '#Type E', '_Viewport', or '_kPaperSpace' usage. Logic involves 3D geometry construction (drills/sinkholes) on panels (GenBeam/Element)."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "hsbCLT-Drill.xml"
          ]
        }
      },
      "tokens_used": 6617,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 9739,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates customizable vertical or angled drill holes (with optional sinkholes) through CLT panels or elements for utilities, fasteners, or connections.",
          "category": "Machining",
          "typicalUseCase": "Drilling through walls or floors for MEP penetrations, dowels, or bolts."
        },
        "parameters": [
          {
            "name": "dDiameter",
            "technicalDefault": "U(12)",
            "businessMeaning": "The diameter of the main drill hole.",
            "validRange": "1mm to 500mm",
            "unit": "mm",
            "affectsOutput": "Changes the thickness of the cylindrical void removed from the panel."
          },
          {
            "name": "dDepth",
            "technicalDefault": "U(0)",
            "businessMeaning": "The depth of the hole. 0 indicates a through-hole (passing completely through the panel thickness).",
            "validRange": "0 (Through) to Panel Thickness",
            "unit": "mm",
            "affectsOutput": "Determines if the hole is a blind hole (specific depth) or a through-hole (penetrates fully)."
          },
          {
            "name": "sFace",
            "technicalDefault": "\"|Reference Face|\"",
            "businessMeaning": "The reference plane from which the drill originates and is measured (Main face, Top face, or Edge).",
            "validRange": "Reference Face, Top Face, Edge",
            "unit": "enum",
            "affectsOutput": "Alters the insertion coordinate system and the visual origin of the drill grip."
          },
          {
            "name": "dBevel",
            "technicalDefault": "U(0)",
            "businessMeaning": "The tilt angle of the drill axis relative to the perpendicular of the selected face.",
            "validRange": "-90° to 90°",
            "unit": "degrees",
            "affectsOutput": "Angles the hole relative to the face surface; 0 is perpendicular."
          },
          {
            "name": "dRotation",
            "technicalDefault": "U(0)",
            "businessMeaning": "The rotation of the drill axis around its own perpendicular vector (swinging the direction left/right).",
            "validRange": "-90° to 90°",
            "unit": "degrees",
            "affectsOutput": "Rotates the angled drill direction within the plane of the face."
          },
          {
            "name": "dAxisOffset",
            "technicalDefault": "0",
            "businessMeaning": "Distance from the insertion point to the actual drill start axis. Used primarily for edge drilling to clear the material edge.",
            "validRange": "-1000mm to 1000mm",
            "unit": "mm",
            "affectsOutput": "Shifts the start point of the drill along the edge vector."
          },
          {
            "name": "sSnapAxis",
            "technicalDefault": "\"|No|\"",
            "businessMeaning": "Forces the insertion point to snap to the calculated axis defined by the offset.",
            "validRange": "Yes, No",
            "unit": "enum",
            "affectsOutput": "Controls user interaction during placement; 'Yes' restricts movement to the specific axis."
          },
          {
            "name": "dDiameterSinkStart",
            "technicalDefault": "U(0)",
            "businessMeaning": "Diameter of a counterbore (countersink) at the entry side of the drill.",
            "validRange": "0 to Max Drill Diameter",
            "unit": "mm",
            "affectsOutput": "Creates a wider cylindrical void at the start of the hole (e.g., for bolt heads)."
          },
          {
            "name": "dDepthSinkStart",
            "technicalDefault": "U(0)",
            "businessMeaning": "Depth of the counterbore at the entry side.",
            "validRange": "0 to 50mm",
            "unit": "mm",
            "affectsOutput": "Defines how deep the entry counterbore penetrates."
          },
          {
            "name": "dDiameterSinkEnd",
            "technicalDefault": "U(0)",
            "businessMeaning": "Diameter of a counterbore at the exit side of the drill.",
            "validRange": "0 to Max Drill Diameter",
            "unit": "mm",
            "affectsOutput": "Creates a wider cylindrical void at the end of the hole."
          },
          {
            "name": "dDepthSinkEnd",
            "technicalDefault": "U(0)",
            "businessMeaning": "Depth of the counterbore at the exit side.",
            "validRange": "0 to 50mm",
            "unit": "mm",
            "affectsOutput": "Defines how deep the exit counterbore penetrates."
          },
          {
            "name": "sFormat",
            "technicalDefault": "\"@(Radius)\"",
            "businessMeaning": "Template string for labeling the drill in the model view.",
            "validRange": "Text string (e.g., \"D@(Diameter)\")",
            "unit": "string",
            "affectsOutput": "Modifies the dimension text displayed near the drill location."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "U(0)",
            "businessMeaning": "Height of the label text. 0 uses the CAD text style default.",
            "validRange": "0 to 100mm",
            "unit": "mm",
            "affectsOutput": "Scales the label text size."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFace is set to \"|Edge|\"",
            "effect": "dAxisOffset and sSnapAxis become active/relevant to position the drill relative to the edge.",
            "cascade": [
              "dAxisOffset",
              "sSnapAxis"
            ]
          },
          {
            "trigger": "dDiameter change",
            "effect": "Updates any text label that uses Diameter or Radius tokens.",
            "cascade": [
              "sFormat"
            ]
          },
          {
            "trigger": "dDepth set to 0",
            "effect": "Script automatically drills through all selected connected panels.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Drill",
            "description": "A cylindrical subtraction from the solid panel geometry, potentially angled.",
            "appliedTo": "Selected GenBeam or Element panels"
          },
          {
            "type": "Sinkhole",
            "description": "A cylindrical subtraction larger than the main drill at the start or end points (counterbore).",
            "appliedTo": "Selected GenBeam or Element panels"
          },
          {
            "type": "Text Annotation",
            "description": "A text label displaying properties (e.g., Radius) in the 3D model.",
            "appliedTo": "Model Space (positioned relative to the drill)"
          }
        ]
      },
      "tokens_used": 8256,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User launches script (via command line, catalog, or drag-and-drop).",
          "Script initializes: Constants, Settings (from XML or MapObject), and Properties (diameter, depth, face, bevel, etc.).",
          "Check Insert Cycle: If `insertCycleCount() > 1`, script erases the temporary instance and exits (standard hsbCAD behavior).",
          "[Conditional] Command Line Argument Check: If `_kExecuteKey` is provided (e.g., \"_kRef\", \"_kTop\"), the script loads the specific catalog entry or defaults the `sFace` property immediately.",
          "[Conditional] Catalog Selection: If no command key is used, a dialog (`SelectFromList`) offers catalog entries (Default, LastInserted, or custom presets). User selects an entry to populate properties.",
          "Panel Selection Loop: User is prompted to select panels (`getGenBeam` or `Element`).",
          "Point Selection Loop: User is prompted to select an insertion point (`getPoint`) on the selected panels.",
          "Coordinate System Setup: The script establishes the local coordinate system (Z-axis = drill direction) based on the selected `sFace` (Reference, Top, or Edge) and the insertion point. If `sFace` is Edge and `dAxisOffset` is active, the coordinate system shifts.",
          "Script creates geometry: A single instance remains in memory. Visuals (Drill, Sinkholes, Text) are generated in the `_bOnCalc` section.",
          "Grip Definition: Script defines grips (Start point, End point/Depth, Rotation/Bevel handles) for interactive editing.",
          "Script finishes: The instance is now part of the model and reacts to recalculation events."
        ],
        "conditionalBranches": [
          {
            "condition": "Is insertion triggered via a specific command key (e.g., `_kRef`, `_kTop`, `_kEdge`)?",
            "path1": {
              "name": "Command Key Trigger",
              "steps": [
                "Script checks `_kExecuteKey`.",
                "Searches for a catalog entry matching the key.",
                "If found, loads properties from that entry.",
                "If not found, applies the key to the `sFace` property directly.",
                "Skips the initial selection dialog."
              ]
            },
            "path2": {
              "name": "Standard Insert",
              "steps": [
                "Shows 'Select properties or catalog entry' dialog.",
                "User picks a preset or configuration.",
                "Proceeds to entity selection."
              ]
            }
          },
          {
            "condition": "Does the user select a valid panel during `getGenBeam`/`getElement`?",
            "path1": {
              "name": "Valid Panel Selected",
              "steps": [
                "Panel is added to the processing list.",
                "Insertion point prompt is restricted to this panel's geometry."
              ]
            },
            "path2": {
              "name": "No Panel Selected / Escaped",
              "steps": [
                "If `_Pt0` (insertion point) is not yet defined, the script reports a warning or exits depending on the CAD environment's handling of empty selections.",
                "If point is already defined (modification mode), continues without adding new panels."
              ]
            }
          },
          {
            "condition": "Is `sFace` set to 'Edge'?",
            "path1": {
              "name": "Edge Drilling Mode",
              "steps": [
                "Coordinate system origin is placed on the edge.",
                "Z-axis points perpendicular to the edge surface.",
                "`dAxisOffset` property shifts the origin along the edge length.",
                "`sSnapAxis` (if Yes) restricts cursor movement to this calculated offset axis."
              ]
            },
            "path2": {
              "name": "Face Drilling Mode (Ref/Top)",
              "steps": [
                "Coordinate system origin is placed on the main face.",
                "Z-axis is normal to the surface.",
                "`dAxisOffset` and `sSnapAxis` are generally ignored or behave differently (standard face picking)."
              ]
            }
          },
          {
            "condition": "Is `dDepth` equal to 0 (Through)?",
            "path1": {
              "name": "Through Drill",
              "steps": [
                "Script calculates total thickness of the panel(s).",
                "Drill geometry extends through the entire element(s).",
                "Grip point for depth is disabled or fixed to the full thickness."
              ]
            },
            "path2": {
              "name": "Blind Drill (Depth > 0)",
              "steps": [
                "Drill geometry extends only the specific `dDepth` value.",
                "An 'End' grip is created to allow interactive dragging of the depth."
              ]
            }
          },
          {
            "condition": "Is a Right-click Context Menu trigger activated?",
            "path1": {
              "name": "Flip Side / Set Bevel / Rotation",
              "steps": [
                "Script detects `_kExecuteKey` matching the trigger.",
                "Modifies the specific property (e.g., `dBevel` set to 45 or -45).",
                "Forces a recalculation (`setExecutionLoops(2)`)."
              ]
            },
            "path2": {
              "name": "Add/Remove Panels",
              "steps": [
                "Script clears current selection or prompts for new selection.",
                "Updates the internal list of entities to drill.",
                "Recalculates geometry."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Check if a valid panel (GenBeam/Element) was selected.",
            "errorMessage": "Implicit in `getGenBeam` failure; if `_Pt0` is not established, the script may fail to construct the local CS and display geometry.",
            "recovery": "User must select a valid timber panel."
          },
          {
            "check": "Check if the insertion point is actually on the panel surface.",
            "errorMessage": "The script uses `closestPointOnSegment` logic, but if the point is vastly off the surface, visual grips may appear in empty space.",
            "recovery": "User should select a point closer to the intended surface or use Osnap."
          },
          {
            "check": "Check if calculated depth exceeds panel thickness (if not through-drill).",
            "errorMessage": "Script logic `if (dDepth > dThickness) dDepth = dThickness;` (common TSL logic, though specific clipping might vary). HSB-7957 update implies performance checks.",
            "recovery": "Script auto-clamps depth to maximum thickness; user sees visually clamped grip."
          },
          {
            "check": "Catalog/Settings file integrity.",
            "errorMessage": "If `hsbCLT-Drill.xml` is missing, script falls back to installation path or hardcoded defaults (e.g., Diameter 12mm).",
            "recovery": "Ensure XML file exists in Company or Install folder."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Properties (Diameter, Depth, Sinkholes, etc.)",
            "how": "OPM (Object Properties Manager / Properties Palette)",
            "effect": "Changing a value like `dDiameter` immediately triggers a recalculation, resizing the drill hole and updating the text label."
          },
          {
            "action": "Move Drill Location",
            "how": "Grip Edit (Move Start Point grip)",
            "effect": "Drags the insertion point (`_Pt0`) along the face, re-calculating the drill position relative to the panel."
          },
          {
            "action": "Adjust Depth interactively",
            "how": "Grip Edit (End Point / Depth Grip)",
            "effect": "If `dDepth` > 0 (Blind hole), dragging the end grip changes the `dDepth` property to the new distance."
          },
          {
            "action": "Adjust Angle (Bevel/Rotation)",
            "how": "Grip Edit (Bevel/Rotation handles) or Properties Palette",
            "effect": "Modifies `dBevel` or `dRotation`, tilting the drill axis."
          },
          {
            "action": "Flip Side",
            "how": "Right-click Context Menu -> 'Flip Side'",
            "effect": "Reverses the drill direction relative to the face (often handled by toggling a boolean or inverting Bevel/Rotation values)."
          },
          {
            "action": "Modify Text Format",
            "how": "Right-click Context Menu -> 'Add/Remove Format' or Properties `sFormat`",
            "effect": "Opens a command-line list of available tokens (Radius, Diameter, etc.). Selecting tokens appends them to the `sFormat` string, changing the on-screen label."
          }
        ]
      },
      "tokens_used": 10530,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-Drill.mcr\n\n## Overview\nCreates customizable vertical or angled drill holes (with optional sinkholes/counterbores) through CLT panels or elements for utilities, fasteners, or connections.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D model elements. |\n| Paper Space | No | Not applicable for 2D drawings. |\n| Shop Drawing | No | Not applicable for shop drawings. |\n\n## Prerequisites\n- **Required Entities**: GenBeam (e.g., CLT panels) or Element.\n- **Minimum Beam Count**: 1.\n- **Required Settings**: `hsbCLT-Drill.xml` (Default configurations).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Browse and select `hsbCLT-Drill.mcr`.\n\n### Step 2: Select Configuration\n**Dialog:** \"Select properties or catalog entry\"\n**Action:** Choose a preset (e.g., \"Default\", \"LastInserted\") from the list to load initial parameters, or select an option to define settings manually later.\n\n### Step 3: Select Panel\n**Command Line:** `Select beams/elements:`\n**Action:** Click on the CLT panel or timber element where you want to place the drill.\n\n### Step 4: Select Insertion Point\n**Command Line:** `Specify insertion point:`\n**Action:** Click on the face or edge of the selected panel to define the start location of the drill.\n\n### Step 5: Adjust Placement\n**Action:** Once placed, use the **Grips** (blue squares) in the model view to drag the drill location, adjust depth, or change angles. Alternatively, open the **Properties Palette** (Ctrl+1) to modify numerical values.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **dDiameter** | Number | 12 mm | The diameter of the main drill hole. |\n| **dDepth** | Number | 0 mm | The depth of the hole. **0** indicates a through-hole (passing completely through the panel). Any other value creates a blind hole. |\n| **sFace** | String | Reference Face | The reference plane for the drill. Options: `Reference Face`, `Top Face`, or `Edge`. |\n| **dBevel** | Number | 0° | The tilt angle of the drill axis relative to the perpendicular of the selected face (-90° to 90°). |\n| **dRotation** | Number | 0° | Rotates the drill axis direction within the plane of the face. |\n| **dAxisOffset** | Number | 0 mm | Distance from the insertion point to the actual drill start axis. Used primarily for edge drilling to clear the material edge. |\n| **sSnapAxis** | String | No | If set to `Yes`, forces the insertion point to snap to the calculated axis defined by the offset. |\n| **dDiameterSinkStart** | Number | 0 mm | Diameter of a counterbore (sinkhole) at the entry side of the drill. |\n| **dDepthSinkStart** | Number | 0 mm | Depth of the counterbore at the entry side. |\n| **dDiameterSinkEnd** | Number | 0 mm | Diameter of a counterbore at the exit side of the drill. |\n| **dDepthSinkEnd** | Number | 0 mm | Depth of the counterbore at the exit side. |\n| **sFormat** | String | @(Radius) | Template string for the text label displayed near the drill (e.g., \"D@(Diameter)\"). |\n| **dTextHeight** | Number | 0 mm | Height of the label text. **0** uses the CAD text style default. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Flip Side** | Reverses the drill direction relative to the selected face. |\n| **Add/Remove Format** | Opens a command-line list to add or remove tokens (like Radius or Diameter) from the on-screen text label. |\n| **Set Bevel +/- 45°** | Quick shortcuts to set the drill angle to 45 or -45 degrees. |\n| **Add/Remove Panels** | Allows you to modify the selection of panels the drill passes through. |\n\n## Settings Files\n- **Filename**: `hsbCLT-Drill.xml`\n- **Location**: Company or Install path\n- **Purpose**: Stores default catalog entries and presets for diameters, depths, and standard configurations.\n\n## Tips\n- **Through Holes**: For standard utility penetrations, leave `dDepth` as `0`. This ensures the hole automatically cuts through the entire panel thickness, even if the panel size changes later.\n- **Counterbores**: Use the `dDiameterSinkStart` and `dDepthSinkStart` parameters to create space for bolt heads or washers so they sit flush with or below the panel surface.\n- **Edge Drilling**: If drilling from the edge, use the `dAxisOffset` property to push the drill start point slightly away from the edge to avoid visual clipping or calculation errors at the boundary.\n- **Grip Editing**: You can drag the \"Depth\" grip (the endpoint handle) in the 3D view to visually set a blind hole depth instead of typing the number.\n\n## FAQ\n- **Q: How do I create a hole that goes through multiple stacked panels?**\n  **A:** Set `dDepth` to `0` (Through). Select the first panel, and the insertion point. If other panels intersect the drill path, the script will typically cut through them as well or you can add them via the context menu.\n  \n- **Q: Why is my drill not going through the whole panel?**\n  **A:** Check the `dDepth` property in the Properties Palette. It is likely set to a specific value (e.g., 50mm) instead of `0`.\n\n- **Q: Can I angle the hole?**\n  **A:** Yes. Use the `dBevel` property to tilt the drill up/down, and `dRotation` to swivel it left/right. You can also use the 3D rotation grips on the drill visualization."
      },
      "tokens_used": 6997,
      "error": null
    }
  }
}