{
  "filename": "HVAC.mcr",
  "status": "completed",
  "total_tokens": 56021,
  "processing_time": 510.9394836425781,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 2,
          "minorVersion": 5,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl assigns HVAC data to a set of beams.",
        "versionHistory": [
          {
            "version": "2.5",
            "date": "21Nov2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "minor bugfix reading settings"
          },
          {
            "version": "2.4",
            "date": "20Nov2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix purging references on splitting a system"
          },
          {
            "version": "2.3",
            "date": "25oct2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "coordinate systems fixed, new prompt to align first vertical segment, tag data published"
          },
          {
            "version": "2.2",
            "date": "09aug2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "parent reference set to child, hardware export added, linework display corrected"
          },
          {
            "version": "2.1",
            "date": "08aug2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "automatic creation of default catalog entries"
          },
          {
            "version": "2.0",
            "date": "08aug2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "dialog behaviour improved"
          },
          {
            "version": "1.9",
            "date": "07aug2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "renamed to HVAC, opm Names introduced"
          },
          {
            "version": "1.8",
            "date": "20jun2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "references published"
          },
          {
            "version": "1.7",
            "date": "19Jul2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "automatic detection and flow recognition enhanced, commands to add, remove and combine are now obsolete"
          },
          {
            "version": "1.6",
            "date": "17jul2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "sequencing further enhanced, new custom command to combine two systems, new custom command for color override"
          },
          {
            "version": "1.5",
            "date": "21jun2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "sequencing of system enhanced"
          },
          {
            "version": "1.3",
            "date": "20jun2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [
          "HVAC.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 8775,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script directly manipulates GenBeam entities (modifying dimensions, colors, names, and flow properties) within the 3D model context. It utilizes _bOnMapIO for connectivity traversal between beams. No ShopDrawing prefixes (sd_) or _Viewport usage is present, and the logic is centered on physical beam properties rather than 2D layout generation."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "HVAC.xml"
          ]
        }
      },
      "tokens_used": 7961,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "3D Ductwork",
            "handler": "|3D Ductwork|",
            "action": "Toggles one or multiple ductworks to 3D appearance",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Linework",
            "handler": "|Linework|",
            "action": "Toggles one or multiple ductworks to linework appearance",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Erase",
            "handler": "|Erase|",
            "action": "Erases an entire ductwork with all references",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "HVAC.xml",
            "searchPaths": [
              "<company>\\tsl\\settings"
            ],
            "purpose": "Provides catalog entries and property configuration for HVAC components",
            "required": true
          }
        ]
      },
      "tokens_used": 10476,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Assigns HVAC properties (dimensions, flow direction, catalog data) to a selection of structural beams to function as ductwork, with options for 3D or schematic linework visualization.",
          "category": "Mechanical/HVAC",
          "typicalUseCase": "Designing and documenting HVAC duct systems within the timber model, converting standard beams into round or rectangular ducts with flow indicators."
        },
        "parameters": [
          {
            "name": "bDrawAsLinework",
            "technicalDefault": "false",
            "businessMeaning": "Toggles the visual representation of the ductwork between a solid 3D model and a 2D schematic line (centerline) representation.",
            "validRange": "true/false",
            "unit": "Boolean",
            "affectsOutput": "If true, hides the beam solids and draws 2D polylines and annotation. If false, renders the full 3D beam geometry."
          },
          {
            "name": "nColor",
            "technicalDefault": "varies",
            "businessMeaning": "The AutoCAD color index assigned to the ductwork to differentiate between systems (e.g., hot air, cold air, exhaust).",
            "validRange": "1-255",
            "unit": "Color Index",
            "affectsOutput": "Changes the display color of the beam elements and associated linework."
          },
          {
            "name": "dDiameter",
            "technicalDefault": "0",
            "businessMeaning": "The diameter of the ductwork when using a round profile.",
            "validRange": ">0 (Typically 75mm - 1000mm)",
            "unit": "mm",
            "affectsOutput": "Forces the beam profile to Round and updates the beam width/height to the diameter."
          },
          {
            "name": "dWidth / dHeight",
            "technicalDefault": "0",
            "businessMeaning": "The cross-sectional dimensions of the ductwork when using a rectangular profile.",
            "validRange": ">0 (Typically 100mm - 2000mm)",
            "unit": "mm",
            "affectsOutput": "Forces the beam profile to Rectangular and updates the beam dimensions."
          },
          {
            "name": "bFlipFlow",
            "technicalDefault": "false",
            "businessMeaning": "Reverses the airflow direction indicator relative to the beam's coordinate system.",
            "validRange": "true/false",
            "unit": "Boolean",
            "affectsOutput": "Rotates the flow direction arrow 180 degrees and updates the 'Flow' sub-map data."
          },
          {
            "name": "sFamily / sChild",
            "technicalDefault": "from HVAC.xml",
            "businessMeaning": "Catalog selection determining the default properties (dimensions, material, naming) of the ductwork based on the HVAC.xml configuration.",
            "validRange": "String",
            "unit": "Text",
            "affectsOutput": "Populates dimensions, names, and hardware attributes based on the selected catalog entry."
          },
          {
            "name": "3D Ductwork (UI Command)",
            "technicalDefault": "N/A",
            "businessMeaning": "Context menu command to switch the selected ductwork(s) to solid 3D visualization mode.",
            "validRange": "Command",
            "unit": "N/A",
            "affectsOutput": "Sets bDrawAsLinework to false, making beam solids visible."
          },
          {
            "name": "Linework (UI Command)",
            "technicalDefault": "N/A",
            "businessMeaning": "Context menu command to switch the selected ductwork(s) to 2D schematic plan mode.",
            "validRange": "Command",
            "unit": "N/A",
            "affectsOutput": "Sets bDrawAsLinework to true, hiding solids and drawing centerlines."
          },
          {
            "name": "Erase (UI Command)",
            "technicalDefault": "N/A",
            "businessMeaning": "Context menu command to remove the HVAC assignment and script instance, effectively un-linking the duct system.",
            "validRange": "Command",
            "unit": "N/A",
            "affectsOutput": "Deletes the script instance and purges references from the map."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Setting dDiameter > 0",
            "effect": "Overrides Width/Height and forces Round Profile",
            "cascade": [
              "ExtrProfile",
              "b.dW()",
              "b.dH()"
            ]
          },
          {
            "trigger": "Setting dWidth/dHeight > 0",
            "effect": "Overrides Diameter and forces Rectangular Profile",
            "cascade": [
              "ExtrProfile",
              "b.dW()",
              "b.dH()"
            ]
          },
          {
            "trigger": "bFlipFlow",
            "effect": "Multiplies the flow direction vector by -1",
            "cascade": [
              "vecXFlow",
              "Arrow Orientation",
              "Flow SubMap"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam (Modified)",
            "description": "The underlying structural beam is resized, recolored, and renamed to match duct specifications.",
            "appliedTo": "All beams connected in the HVAC stream."
          },
          {
            "name": "Hardware Component",
            "description": "A summary component attached to the script instance representing the total duct length and dimensions for BOM/export.",
            "appliedTo": "TSL Instance"
          },
          {
            "name": "PLine / Annotation",
            "description": "Centerlines, dimension text (e.g., '300x200' or 'Ã˜200'), and flow arrows.",
            "appliedTo": "Model Space (PlanView)"
          },
          {
            "name": "Map Data",
            "description": "Stores connectivity ('HvacChild', 'HvacParent') and flow direction ('Flow') data for downstream processing.",
            "appliedTo": "Beam SubMaps"
          }
        ]
      },
      "tokens_used": 10527,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initialization via Insert or Property Change",
          "Recursive Connectivity Traversal (_bOnMapIO):",
          "  - Validate base beam exists and is valid",
          "  - Iterate through attached tools (connectors)",
          "  - Identify connection points relative to beam axis",
          "  - Determine flow direction (Tail/Head) and flip factors",
          "  - Recursively process connected beams",
          "  - Aggregate complete list of beams in stream (BeamRef[])",
          "Process HVAC Stream (Iterate entAllRefs):",
          "  - Calculate geometric properties (Centerline, Shadow Profile)",
          "  - Publish Tag Data (HVAC Map) to beams",
          "  - [Branch] Visual Representation (Linework vs 3D)",
          "  - [Branch] Profile Geometry (Round vs Rectangular)",
          "  - Apply visual updates (Color, Name, Dimensions)",
          "  - Draw annotation (Arrows, Text, Symbols)",
          "Hardware & BOM Generation:",
          "  - Purge old hardware components (_kRTTsl)",
          "  - Create summary component (Total Length, Dimensions)",
          "  - Update script instance references"
        ],
        "conditionalBranches": [
          {
            "condition": "bDrawAsLinework Property State",
            "path1": {
              "name": "Schematic/Linework Mode",
              "steps": [
                "Set beam visibility to false (b.setIsVisible(false))",
                "Draw 2D centerline polylines (dpPlan.draw(segs))",
                "Suppress 3D shadow generation"
              ]
            },
            "path2": {
              "name": "3D Model Mode",
              "steps": [
                "Set beam visibility to true (b.setIsVisible(true))",
                "Generate and join plan shadows (ppPlan.joinRing)",
                "Render full beam geometry"
              ]
            }
          },
          {
            "condition": "Diameter vs Width/Height Configuration",
            "path1": {
              "name": "Round Profile",
              "steps": [
                "Check if dDiameter > 0",
                "Force profile to _kExtrProfRound",
                "Set beam Width (Y) and Height (Z) to dDiameter"
              ]
            },
            "path2": {
              "name": "Rectangular Profile",
              "steps": [
                "Check if dDiameter is 0 or unset",
                "Force profile to _kExtrProfRectangular",
                "Set beam Width (Y) to dWidth and Height (Z) to dHeight"
              ]
            }
          },
          {
            "condition": "Flow Direction Calculation",
            "path1": {
              "name": "Topological Flow",
              "steps": [
                "Calculate flow based on connection vectors",
                "Use nFlipXDir derived from MapIO"
              ]
            },
            "path2": {
              "name": "Inverted Flow",
              "steps": [
                "User sets bFlipFlow to true",
                "Multiply calculated flow direction by -1",
                "Rotate arrow 180 degrees"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Entity Validity",
            "errorMessage": "mapIO failed due to invalid beam.",
            "recovery": "Ensure the script is attached to a valid beam entity or beam has not been deleted."
          },
          {
            "check": "Beam Reference in List",
            "errorMessage": "mapIO failed ref beam not in list.",
            "recovery": "Internal logic error; re-insert the script or refresh the connection."
          },
          {
            "check": "Connector Geometry",
            "errorMessage": "(Silent skip)",
            "recovery": "Ensures connected tools (TSLs) have exactly 2 connection points and they lie on the beam axis. Beams failing this check are ignored in the stream."
          },
          {
            "check": "Dimension Tolerance (dEps)",
            "errorMessage": "(Silent skip)",
            "recovery": "Dimensions are only updated if the difference between current and new value exceeds 0.1mm (dEps) to prevent unnecessary regeneration."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Toggle Visualization Mode",
            "how": "OPM Property 'bDrawAsLinework' or Context Menu 'Linework' / '3D Ductwork'",
            "effect": "Switches the entire connected stream between 2D schematic lines and 3D solids."
          },
          {
            "action": "Modify Dimensions",
            "how": "OPM Properties 'dDiameter', 'dWidth', 'dHeight'",
            "effect": "Updates the beam cross-section and profile type (Round/Rect) for the entire system."
          },
          {
            "action": "Reverse Airflow",
            "how": "OPM Property 'bFlipFlow'",
            "effect": "Rotates flow direction indicators and updates 'Flow' submap data."
          },
          {
            "action": "Change Color",
            "how": "OPM Property 'nColor'",
            "effect": "Updates the AutoCAD color index of all beams in the stream."
          },
          {
            "action": "Erase System",
            "how": "Context Menu 'Erase'",
            "effect": "Deletes the TSL instance, purges HvacParent references from beams, and stops the script logic."
          },
          {
            "action": "Physical Geometry Edit",
            "how": "Grip edit / Move beams",
            "effect": "Triggers MapIO to recalculate connectivity and flow paths automatically."
          }
        ]
      },
      "tokens_used": 11783,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HVAC.mcr\n\n## Overview\nThis script converts structural beams into HVAC ductwork elements. It automatically assigns dimensions, airflow direction, and visual styles (3D model or 2D schematic) to a connected system of beams.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D GenBeam entities. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Used for modeling and detailing in the design phase. |\n\n## Prerequisites\n- **Required Entities**: Structural Beams (`GenBeam`) must exist in the model.\n- **Minimum Beam Count**: 1 (the script will trace connections to find related beams).\n- **Required Settings**: `HVAC.xml` (located in the company or install folder).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `HVAC.mcr`.\n\n### Step 2: Select Base Beam\n```\nCommand Line: Select beam:\nAction: Click on the structural beam that represents the start of your ductwork system.\n```\n\n### Step 3: Configure Properties\nAction: Once inserted, select the script instance (or the beam it is attached to) and open the **Properties Palette** (Ctrl+1). Adjust dimensions and flow settings as needed.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| bDrawAsLinework | Boolean | false | If **true**, displays ducts as 2D centerlines (plan view). If **false**, displays full 3D solids. |\n| nColor | Integer | varies | Sets the AutoCAD color index (1-255) for the ductwork to differentiate systems (e.g., hot vs. cold air). |\n| dDiameter | Double | 0 | Sets the diameter for **round** ducts. Entering a value > 0 forces a round profile. |\n| dWidth | Double | 0 | Sets the width for **rectangular** ducts. (Used with dHeight). |\n| dHeight | Double | 0 | Sets the height for **rectangular** ducts. (Used with dWidth). |\n| bFlipFlow | Boolean | false | Reverses the calculated airflow direction by 180 degrees. |\n| sFamily | String | *From XML* | Selects the catalog entry defining default properties for the ductwork. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **3D Ductwork** | Switches the visualization to solid 3D mode (Sets `bDrawAsLinework` to false). |\n| **Linework** | Switches the visualization to 2D schematic centerlines (Sets `bDrawAsLinework` to true). |\n| **Erase** | Removes the HVAC assignment from the beams and deletes the script instance. |\n\n## Settings Files\n- **Filename**: `HVAC.xml`\n- **Location**: `<company>\\tsl\\settings`\n- **Purpose**: Defines available catalog entries, default dimensions, and naming conventions for HVAC components.\n\n## Tips\n- **Profile Switching**: To switch between round and rectangular ducts, simply input a value into `dDiameter` (for round) OR `dWidth`/`dHeight` (for rectangular). The other values will be automatically ignored/overridden.\n- **Flow Detection**: The script automatically detects flow direction based on beam connectivity. If the arrow points the wrong way, use the `bFlipFlow` property rather than rotating the beam manually.\n- **Splitting Systems**: If you break a connection in the ductwork chain, the script automatically purges the reference to the disconnected section, keeping your data clean.\n- **Performance**: For large models, use the **Linework** mode to simplify the visual display while retaining the data for BOM export.\n\n## FAQ\n- **Q: Why did my beams disappear from the 3D view?**\n- **A**: Check the `bDrawAsLinework` property in the Properties Palette. If it is `true`, the beams are hidden and replaced by 2D lines. Change it to `false` or use the Right-Click menu **3D Ductwork** option.\n\n- **Q: How do I export duct dimensions to my BOM?**\n- **A**: The script automatically generates a hardware component attached to the instance containing total length and dimension data. Ensure your export template includes hardware components.\n\n- **Q: Can I mix round and rectangular ducts in one system?**\n- **A**: This script applies uniform properties to the connected stream. If you need mixed profiles, insert separate script instances for the different sections."
      },
      "tokens_used": 6499,
      "error": null
    }
  }
}