{
  "filename": "Sherpa-Verbinder.mcr",
  "status": "completed",
  "total_tokens": 40650,
  "processing_time": 1020.1913414001465,
  "passes": {
    "1": {
      "success": false,
      "data": {},
      "tokens_used": 0,
      "error": "Request timeout after retries"
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script implements an `_bOnInsert` routine that uses `PrEntity` to select `Beam()` objects and `tsl.dbCreate` to generate instances in the model. It adds 3D tools (`BeamCut`, `Cut`) and creates `MetalPart` geometry. There are no references to Paper Space APIs (e.g., `_Viewport`), ShopDrawing prefixes (`sd_`), or `#Type E` entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "_DimStyles list"
          ]
        }
      },
      "tokens_used": 5500,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select beams|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Type\",\n      \"defaultValue\": \"A\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"A\",\n        \"A1\",\n        \"A2\",\n        \"A3\",\n        \"B\",\n        \"C\",\n        \"C1\",\n        \"D\",\n        \"D1\",\n        \"E\",\n        \"F\",\n        \"Multi-80x96\",\n        \"Multi-60x96\",\n       "
      },
      "tokens_used": 9841,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the insertion and machining of Sherpa brand timber connectors at T-junctions between perpendicular beams.",
          "category": "Hardware/Connection",
          "typicalUseCase": "Connecting two perpendicular timber beams (e.g., purlin to rafter) using a specific Sherpa plate model, including optional milling for the plate and hardware assignment."
        },
        "parameters": [
          {
            "name": "sType",
            "technicalDefault": "A",
            "businessMeaning": "The specific model code of the Sherpa connector (e.g., A, B, Multi, etc.). This determines the physical size of the plate, the depth of milling, and the number/type of screws required.",
            "validRange": "Defined list (A, A1, A2, A3, B, C, C1, D, D1, E, F, Multi-80x96, Multi-60x96, W8, WTS series, Serie-S series, mini, KA)",
            "unit": "String",
            "affectsOutput": "Changes the dimensions (Height, Width, Depth) of the MetalPart and the properties (Count, Length, Diameter) of the associated Hardware screws."
          },
          {
            "name": "sPos",
            "technicalDefault": "Top",
            "businessMeaning": "The vertical alignment of the connector on the main beam relative to the intersection point.",
            "validRange": "Top, Middle, Bottom",
            "unit": "Enum",
            "affectsOutput": "Adjusts the Z-coordinate of the `MetalPart` insertion point and the location of the slot `Cut` in the main beam."
          },
          {
            "name": "sMill",
            "technicalDefault": "Yes",
            "businessMeaning": "Specifies whether to cut a pocket (mortise) into the secondary beam to accommodate the thickness of the connector plate.",
            "validRange": "Yes, No",
            "unit": "Boolean (String)",
            "affectsOutput": "If 'Yes', creates a `BeamCut` (milling) volume in the crossing beam. If 'No', the connector sits on the surface."
          },
          {
            "name": "sNY",
            "technicalDefault": "No",
            "businessMeaning": "Toggles the visibility of the text label and leader line (flag) identifying the connector in the model view.",
            "validRange": "No, Yes",
            "unit": "Boolean (String)",
            "affectsOutput": "If 'Yes', draws a text label and leader line; if 'No', no text is displayed."
          },
          {
            "name": "dxFlag",
            "technicalDefault": "200",
            "businessMeaning": "The horizontal distance (X-direction relative to the beam) from the insertion point to the anchor point of the text label.",
            "validRange": "Positive/Negative numbers (typically 0-500 mm)",
            "unit": "mm",
            "affectsOutput": "Repositions the text label leader line anchor point."
          },
          {
            "name": "dyFlag",
            "technicalDefault": "300",
            "businessMeaning": "The vertical distance (Y-direction relative to the beam width) from the insertion point to the anchor point of the text label.",
            "validRange": "Positive/Negative numbers (typically 0-500 mm)",
            "unit": "mm",
            "affectsOutput": "Repositions the text label leader line anchor point."
          },
          {
            "name": "dSnap",
            "technicalDefault": "2000",
            "businessMeaning": "The maximum allowable gap or extension distance between beams for the tool to automatically recognize a valid T-connection during insertion.",
            "validRange": "0 - 5000 mm",
            "unit": "mm",
            "affectsOutput": "Controls the sensitivity of the `filterBeamsTConnection` function when selecting multiple beams at once."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles list",
            "businessMeaning": "The CAD dimension style used to render the text label appearance (font, size, arrowheads).",
            "validRange": "Available DimStyles in the drawing",
            "unit": "String",
            "affectsOutput": "Visual appearance of the connector label."
          },
          {
            "name": "nColor",
            "technicalDefault": "171",
            "businessMeaning": "The display color index for the connector and its label.",
            "validRange": "0 - 255 (AutoCAD color index) or -1 (ByLayer)",
            "unit": "Index",
            "affectsOutput": "Visual color of the MetalPart and Display text."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sType is changed",
            "effect": "Lookup tables for dimensions (Height, Width, Depth) and Screw properties are updated.",
            "cascade": [
              "MetalPart dimensions",
              "BeamCut dimensions",
              "Hardware properties (Length, Diameter, Count)"
            ]
          },
          {
            "trigger": "sPos is changed",
            "effect": "The insertion point calculation on the Z-axis of the main beam is recalculated.",
            "cascade": [
              "MetalPart location",
              "Cut location"
            ]
          },
          {
            "trigger": "sMill is set to No",
            "effect": "The generation of the milling volume in the secondary beam is skipped.",
            "cascade": [
              "BeamCut generation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "MetalPart",
            "description": "A 3D steel plate representing the Sherpa connector.",
            "appliedTo": "ModelSpace (inserted at intersection of Beams)"
          },
          {
            "type": "Cut",
            "description": "A slot in the main beam to accommodate the thickness of the connector plate.",
            "appliedTo": "Beam[0] (Main beam)"
          },
          {
            "type": "BeamCut",
            "description": "A rectangular pocket/mortise in the secondary beam to receive the connector plate (if Milling is enabled).",
            "appliedTo": "Beam[1] (Crossing/Secondary beam)"
          },
          {
            "type": "Hardware",
            "description": "Screw instances (Sherpa-Spezialschraube) required for the specific connector type.",
            "appliedTo": "Assigned to the assembly/list"
          }
        ]
      },
      "tokens_used": 8851,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Execution Start",
          "Check Execution Mode (_bOnInsert flag)",
          "[Mode: Insertion] Display Properties Dialog (showDialog)",
          "[Mode: Insertion] Prompt User to Select Beams (PrEntity)",
          "[Mode: Insertion] Store selected beams in array",
          "[Mode: Insertion] Loop through each selected beam",
          "[Mode: Insertion] Filter for T-Connections (filterBeamsTConnection) within dSnap range",
          "[Mode: Insertion] Loop through valid intersecting beams",
          "[Mode: Insertion] Verify beams are perpendicular",
          "[Mode: Insertion] Create new TSL instance (dbCreate) at intersection",
          "[Mode: Insertion] Erase the original 'seed' instance",
          "[Mode: Calculation/Update] Validate Color Index (nColor)",
          "[Mode: Calculation/Update] Retrieve linked beams (_Beam[0], _Beam[1])",
          "[Mode: Calculation/Update] Verify beams are perpendicular",
          "[Mode: Calculation/Update] Calculate Insertion Point (ptIns) based on sPos property",
          "[Mode: Calculation/Update] Check Milling property (sMill)",
          "[Mode: Calculation/Update] [If Milling Yes] Create BeamCut in secondary beam",
          "[Mode: Calculation/Update] Create Cut (slot) in main beam",
          "[Mode: Calculation/Update] Create MetalPart geometry",
          "[Mode: Calculation/Update] [If sNY Yes] Draw text label and leader line",
          "[Mode: Calculation/Update] Assign Hardware (Screws) to assembly",
          "Script End"
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode (_bOnInsert)",
            "path1": {
              "name": "Insertion Flow",
              "steps": [
                "Show Dialog",
                "Select Beams",
                "Process multiple beams (Loop)",
                "Find T-connections (Filter)",
                "Generate Instances",
                "Erase Seed"
              ]
            },
            "path2": {
              "name": "Update/Recalc Flow",
              "steps": [
                "Validate Properties",
                "Calculate Geometry",
                "Generate 3D Tools (Cut/BeamCut/MetalPart)",
                "Update Visuals"
              ]
            }
          },
          {
            "condition": "Milling Option (sMill)",
            "path1": {
              "name": "Milling Enabled ('Yes')",
              "steps": [
                "Insertion Point adjusted by plate depth",
                "Create BeamCut volume in crossing beam"
              ]
            },
            "path2": {
              "name": "Milling Disabled ('No')",
              "steps": [
                "Insertion Point stays on surface",
                "No BeamCut generated"
              ]
            }
          },
          {
            "condition": "Vertical Position (sPos)",
            "path1": {
              "name": "Top",
              "steps": [
                "ptIns = Top of Main Beam - Half Plate Height"
              ]
            },
            "path2": {
              "name": "Middle",
              "steps": [
                "ptIns = Center of Main Beam"
              ]
            },
            "path3": {
              "name": "Bottom",
              "steps": [
                "ptIns = Bottom of Main Beam + Half Plate Height"
              ]
            }
          },
          {
            "condition": "Show Description (sNY)",
            "path1": {
              "name": "Yes",
              "steps": [
                "Calculate text orientation",
                "Draw Text Label ('Sherpa [Type]')",
                "Draw Leader Line (if offsets > 0)"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip drawing text and lines"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Perpendicularity (Update Mode)",
            "errorMessage": "Incorrect user input. Beams must be perpendicular. Tool will be deleted.",
            "recovery": "Script erases itself (eraseInstance) if beams are not 90 degrees apart."
          },
          {
            "check": "Color Index (nColor)",
            "errorMessage": "None (Silent correction)",
            "recovery": "Value is automatically reset to 171 if outside range [-1, 255]."
          },
          {
            "check": "T-Connection Availability (Insertion Mode)",
            "errorMessage": "None (No action)",
            "recovery": "If `filterBeamsTConnection` returns no beams within `dSnap`, no instances are created."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Connector Type",
            "how": "OPM Property 'Type'",
            "effect": "Updates MetalPart dimensions (Height, Width, Depth), Cut depth, and associated Screw properties."
          },
          {
            "action": "Adjust Vertical Position",
            "how": "OPM Property 'Position'",
            "effect": "Moves the connector and cuts up or down relative to the main beam's cross-section."
          },
          {
            "action": "Toggle Milling",
            "how": "OPM Property 'Milling'",
            "effect": "Adds or removes the pocket (BeamCut) in the secondary beam."
          },
          {
            "action": "Relocate Text Label",
            "how": "Grip Point Edit (_PtG)",
            "effect": "Updates `dxFlag` and `dyFlag` properties to reposition the label leader line."
          },
          {
            "action": "Change Label Visibility",
            "how": "OPM Property 'Show description'",
            "effect": "Toggles the visibility of the text label and leader line."
          }
        ]
      },
      "tokens_used": 9478,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Sherpa-Verbinder.mcr\n\n## Overview\nAutomates the insertion and configuration of Sherpa brand timber connectors at T-junctions between perpendicular beams. It handles the creation of steel plates, milling pockets in the timber, and the assignment of the correct screws.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model to connect beams. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required entities**: Two or more Timber Beams (`GenBeam`).\n- **Minimum beam count**: 2 beams forming a T-junction (perpendicular).\n- **Required settings**: Dimension Styles (`_DimStyles`) must exist in the drawing for labels to display correctly.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `Sherpa-Verbinder.mcr`\n\n### Step 2: Configure Connector\n```\nCommand Line: (Dialog appears)\nAction: Choose the Connector Type (e.g., A, B, Multi), Position, and Milling options in the dialog box. Click OK to confirm.\n```\n\n### Step 3: Select Beams\n```\nCommand Line: |Select beams|\nAction: Click on the beams in the model where you want to install connectors. You can select multiple beams at once.\nNote: The script will automatically detect perpendicular intersections (T-junctions) based on the Snap Distance setting.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Type | dropdown | A | Select the model code of the Sherpa connector (e.g., A, B, C, Multi, etc.). This determines plate size and screw type. |\n| Position | dropdown | Top | Vertical alignment on the main beam. Options: Top, Middle, Bottom. |\n| Milling | dropdown | Yes | Cuts a pocket (mortise) into the secondary beam to fit the plate. Select \"No\" to place the plate on the surface. |\n| Show description | dropdown | No | Toggles the visibility of the text label and leader line identifying the connector. |\n| Offset X (dxFlag) | number | 200 | Horizontal distance from the connector to the text label anchor point (in mm). |\n| Offset Y (dyFlag) | number | 300 | Vertical distance from the connector to the text label anchor point (in mm). |\n| Snap Distance (dSnap) | number | 2000 | Maximum gap allowed for the script to recognize a valid T-connection (in mm). |\n| DimStyle | text | _DimStyles | The dimension style used for the text label (controls font and size). |\n| Color | number | 171 | The display color index for the connector and label (0-255). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Update | Recalculates the connector geometry after changing properties in the Properties Panel. |\n\n## Settings Files\n- **Filename**: None (Internal)\n- **Location**: Script Internal Logic\n- **Purpose**: Dimension data and screw mappings are handled internally by the script lookup tables based on the selected \"Type\".\n\n## Tips\n- **Batch Processing**: Select a large array of beams at once. The script loops through them and only inserts connectors where valid T-junctions exist within the Snap Distance.\n- **Label Positioning**: You can drag the label grip point in the model view to adjust the `dxFlag` and `dyFlag` offsets visually.\n- **Perpendicular Check**: Ensure your beams are exactly perpendicular (90 degrees). If the beams are at a different angle, the tool will delete itself to prevent errors.\n\n## FAQ\n- **Q: Why did the connector disappear after I updated the properties?**\n  **A:** The script validates that the connected beams are perpendicular. If they are not 90 degrees apart, the tool automatically erases itself.\n- **Q: Can I use this for connections that are not touching?**\n  **A:** Yes, if there is a gap between the beams, increase the `Snap Distance` (dSnap) property to ensure the tool recognizes the intersection."
      },
      "tokens_used": 6980,
      "error": null
    }
  }
}