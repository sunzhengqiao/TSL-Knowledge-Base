{
  "filename": "hsbCLT-LevelMarker.mcr",
  "status": "completed",
  "total_tokens": 43122,
  "processing_time": 361.90528321266174,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "03jul14",
            "author": "th@hsbCAD.de",
            "changes": "bugfix special detection"
          },
          {
            "version": "1.0",
            "date": "03jul14",
            "author": "th@hsbCAD.de",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7265,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicitly creates child instances using `_kModelSpace` in `tslNew.dbCreate(...)`. Selects `Sip` entities via `PrEntity` and `getPoint()` which are model-based interactions. Lacks `sd_` prefix, `_Viewport` references, or `#Type E` declarations typical of shop drawings."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sip"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space (XY-World plane or perpendicular to Z-World)",
          "requiredSettings": []
        }
      },
      "tokens_used": 5834,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity.go",
              "promptOriginal": "|Select CLT panels|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "DynamicDialog",
            "trigger": "Insertion (if not executed from a catalog key)",
            "title": null,
            "dataSource": "Internal Properties (dElevation, dSize, sStyle, sType, sDimStyle)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dElevation",
            "type": "PropDouble",
            "displayName": "|Elevation|",
            "defaultValue": "500",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dSize",
            "type": "PropDouble",
            "displayName": "|Size|",
            "defaultValue": "50",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sStyle",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "|Finished Face|",
            "inputType": "dropdown",
            "options": [
              "|Finished Face|",
              "|Raw Face|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sType",
            "type": "PropString",
            "displayName": "|Type|",
            "defaultValue": "|Floor|",
            "inputType": "dropdown",
            "options": [
              "|Floor|",
              "|Ceiling|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": "Populated from sorted list of available drawing DimStyles (_DimStyles)."
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "211",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Delete Childs|",
            "handler": "|Delete Childs|",
            "action": "Erases all child TSL instances associated with the current parent instance.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add Childs|",
            "handler": "|Add Childs|",
            "action": "Prompts user to select new CLT panels to create child marker instances for.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6300,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and manages elevation level markers (level stamps) attached to CLT panels in the 3D model to indicate floor levels or ceiling heights.",
          "category": "Annotation",
          "typicalUseCase": "Placing 'Finished Floor Level' (FFL) or structural level markers on CLT walls and floors during the modeling phase to denote specific heights for fabrication and assembly drawings."
        },
        "parameters": [
          {
            "name": "dElevation",
            "technicalDefault": "500",
            "businessMeaning": "The numeric value of the level to be displayed (e.g., +500.00). This represents the height offset relative to the project's zero point.",
            "validRange": "-50000 to 50000 (Project specific limits)",
            "unit": "mm (or current length unit)",
            "affectsOutput": "Updates the text label displayed next to the marker symbol."
          },
          {
            "name": "dSize",
            "technicalDefault": "50",
            "businessMeaning": "The physical size or scale of the marker symbol and its text height in the model.",
            "validRange": "20 to 150",
            "unit": "mm (or current length unit)",
            "affectsOutput": "Scales the triangle geometry and text size. Larger values make the marker more visible but may obscure model details."
          },
          {
            "name": "sStyle",
            "technicalDefault": "|Finished Face|",
            "businessMeaning": "Determines the visual style of the marker to distinguish between finished surfaces and raw structural surfaces.",
            "validRange": "N/A (Dropdown selection)",
            "unit": "N/A",
            "affectsOutput": "If 'Finished Face', the triangle is filled (solid). If 'Raw Face', the triangle is drawn as an outline (wireframe)."
          },
          {
            "name": "sType",
            "technicalDefault": "|Floor|",
            "businessMeaning": "Indicates whether the marker refers to a Floor level (pointing up) or a Ceiling/Soffit level (pointing down).",
            "validRange": "N/A (Dropdown selection)",
            "unit": "N/A",
            "affectsOutput": "Inverts the vertical direction of the triangle marker relative to the panel surface."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "First available DimStyle in drawing",
            "businessMeaning": "The specific dimension style defined in the CAD environment that controls the text font and appearance.",
            "validRange": "N/A (Dropdown selection of drawing DimStyles)",
            "unit": "N/A",
            "affectsOutput": "Modifies the font, precision, and text appearance properties of the elevation label."
          },
          {
            "name": "nColor",
            "technicalDefault": "211",
            "businessMeaning": "The display color of the marker geometry and text in the CAD model.",
            "validRange": "1 to 255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Changes the color of the triangle, base lines, and text."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Parent Instance Properties Changed",
            "effect": "Updates all associated Child instances to match the Parent's properties to ensure consistency across a level.",
            "cascade": [
              "dElevation",
              "dSize",
              "sStyle",
              "sType"
            ]
          },
          {
            "trigger": "Parent Instance Location Changed",
            "effect": "Calculates the offset vector and applies it to Child instances to maintain the relative level alignment.",
            "cascade": [
              "_Pt0"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInst (Child)",
            "description": "Child script instances representing the same level on subsequent panels selected by the user.",
            "appliedTo": "Selected CLT Panels (Sip entities)"
          },
          {
            "type": "Graphical Annotation (PLine/Text)",
            "description": "2D Geometry (Triangle arrow, base line) and Text label representing the elevation. Published via 'DimRequest[]' map for detailing.",
            "appliedTo": "3D Model Space / Generated Views"
          }
        ]
      },
      "tokens_used": 7788,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch / Insertion",
          "2. [Conditional] Check if insertCycleCount > 1",
          "3. [Path Yes] Erase current instance and Exit (Prevent duplicate runs)",
          "4. [Path No] Continue Insertion",
          "5. [Conditional] Check if executed from Catalog Key (_kExecuteKey)",
          "6. [Path Yes] Load properties from Catalog",
          "7. [Path No] Show Dynamic Dialog for properties (Elevation, Size, Style, Type, DimStyle, Color)",
          "8. Prompt user to select CLT panels (Sip entities) via PrEntity",
          "9. Prompt user to select Insertion Point via getPoint",
          "10. Analyze first selected panel to determine orientation (3D Wall vs 2D/XY Plane)",
          "11. Filter selected panels: Validate orientation (perpendicular to Z for walls, parallel to Z for floors) and intersection with the elevation plane",
          "12. [Conditional] Check if valid panels remain after filtering",
          "13. [Path No] Erase instance and Exit",
          "14. [Path Yes] Store filtered panels in _Sip, store Plane Normal in _Map, and Exit Insertion Cycle",
          "15. Script Execution / Recalculation",
          "16. Validate _Sip list",
          "17. [Conditional] Check if _Sip is empty",
          "18. [Path Yes] Erase instance and Exit",
          "19. [Path No] Assign script to groups of the first panel",
          "20. Retrieve Plane Normal from _Map",
          "21. Determine Instance Mode (Parent vs Child) based on 'parent' Entity in _Map",
          "22. [Branch: Child Instance Logic]",
          "23. Lock properties (Read-only: dElevation, dSize, sStyle, sType)",
          "24. Set Dependency on Parent Instance",
          "25. Sync Location: Calculate offset if Parent moved (dot product of normal vector)",
          "26. Sync Properties: Copy Elevation, Size, Style, and Type from Parent",
          "27. Calculate Coordinate System (vecX, vecY, vecZ) relative to panel and marker plane",
          "28. Calculate Reference Point (ptRef) on panel surface",
          "29. [Conditional] Check Execution Mode",
          "30. [Path: Delete Childs Triggered] Iterate through _Entity array, find child instances, erase them from database and array",
          "31. [Path: Add Childs Triggered] Prompt user to select NEW panels. Filter duplicates (already have marker) and invalid panels. Set creation flag bCreate=true.",
          "32. [Path: Standard Run] Set list of panels to clone (all stored _Sip except the first one).",
          "33. [Conditional] Check creation flag (bCreate)",
          "34. [Path Yes] For each target panel: Calculate reference point, Create Child TSL Instance in ModelSpace, append to _Entity array.",
          "35. Generate Marker Geometry: Construct Triangle (filled or wireframe) and Base Line based on Type (Floor/Ceiling) and Size",
          "36. Generate Display Elements: Set Color, Text Height, and Text String (Elevation value)",
          "37. Construct DimRequest Map: Store geometry, text style, and view restrictions for detailing",
          "38. Publish Map to _Map",
          "39. Finish"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count (Duplicate Run Prevention)",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Return"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Continue with Property Selection"
              ]
            }
          },
          {
            "condition": "Execution Source (Catalog vs Manual)",
            "path1": {
              "name": "Catalog Key Exists",
              "steps": [
                "Set Prop Values from Catalog"
              ]
            },
            "path2": {
              "name": "Manual Insert",
              "steps": [
                "Show Dynamic Dialog"
              ]
            }
          },
          {
            "condition": "Panel Validity (Orientation & Intersection)",
            "path1": {
              "name": "Valid Panel",
              "steps": [
                "Add to _Sip Array",
                "Process for Marker"
              ]
            },
            "path2": {
              "name": "Invalid Panel (Wrong orientation, no intersection, or wrong label)",
              "steps": [
                "Skip Panel (Continue Loop)"
              ]
            }
          },
          {
            "condition": "Instance Role (Parent vs Child)",
            "path1": {
              "name": "Parent",
              "steps": [
                "Maintain Editable Properties",
                "Create/Manage Childs",
                "Handle 'Add Childs' / 'Delete Childs' triggers"
              ]
            },
            "path2": {
              "name": "Child",
              "steps": [
                "Lock Properties (Read-Only)",
                "Sync Position & Data with Parent",
                "Skip Child Management Logic"
              ]
            }
          },
          {
            "condition": "Marker Style (Visual)",
            "path1": {
              "name": "Finished Face (Solid)",
              "steps": [
                "Draw Filled Triangle PlaneProfile"
              ]
            },
            "path2": {
              "name": "Raw Face (Wireframe)",
              "steps": [
                "Draw Triangle PLine Outline"
              ]
            }
          },
          {
            "condition": "Marker Type (Direction)",
            "path1": {
              "name": "Floor",
              "steps": [
                "Point Arrow Up (Positive Normal)"
              ]
            },
            "path2": {
              "name": "Ceiling",
              "steps": [
                "Point Arrow Down (Negative Normal)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Duplicate Insertion",
            "errorMessage": "None (Silent)",
            "recovery": "N/A (Script self-terminates)"
          },
          {
            "check": "Valid CLT Panels Selected",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases instance if no valid panels are found after filtering. User must re-run and select correct panels (Walls must be vertical to Z, Floors horizontal, or intersect the level plane)."
          },
          {
            "check": "Special Condition (KLH)",
            "errorMessage": "None (Silent)",
            "recovery": "If KLH special is active, only panels with labels starting with 'W' or containing '*W' are accepted. Others are ignored."
          },
          {
            "check": "Project Dependencies",
            "errorMessage": "None (Silent)",
            "recovery": "If the referenced Parent instance is deleted or invalid, the Child may lose dependency linkage, though script checks `bIsValid()` before syncing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Elevation/Size/Style/Type",
            "how": "Object Properties Palette (OPM)",
            "effect": "Parent updates geometry immediately. Child instances detect change, sync properties, and update their own geometry to match Parent."
          },
          {
            "action": "Move Parent Instance",
            "how": "Grip Edit / Move Command",
            "effect": "Child instances calculate the movement vector along the marker normal and move accordingly to maintain relative level alignment."
          },
          {
            "action": "Add Additional Childs",
            "how": "Right-click Context Menu -> 'Add Childs'",
            "effect": "Prompts selection of new panels. Validates them. Creates new Child instances attached to these panels, linking them to the current Parent."
          },
          {
            "action": "Delete Childs",
            "how": "Right-click Context Menu -> 'Delete Childs'",
            "effect": "Iterates through all associated Child instances and erases them from the database. Parent remains."
          }
        ]
      },
      "tokens_used": 9190,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-LevelMarker.mcr\n\n## Overview\nGenerates and manages elevation level markers (level stamps) attached to CLT panels in the 3D model to indicate floor levels or ceiling heights.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script is designed for 3D model interaction. |\n| Paper Space | No | Not applicable for layout views. |\n| Shop Drawing | No | Not applicable for detail/element drawings. |\n\n## Prerequisites\n- **Required Entities**: CLT Panels (Sip entities) must exist in the model.\n- **Minimum beam count**: 1 (though multiple panels are typically selected).\n- **Required settings files**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or drag and drop from the catalog)\nAction: Select `hsbCLT-LevelMarker.mcr` from the list.\n\n### Step 2: Configure Marker Properties\n```\nDialog: Dynamic Dialog\nAction: Set the elevation level (e.g., 500), marker size, style (Finished/Raw), and type (Floor/Ceiling).\n```\n*Note: If run from a Catalog Key with predefined properties, this step may be skipped.*\n\n### Step 3: Select CLT Panels\n```\nCommand Line: Select CLT panels\nAction: Click on the CLT panels (Sip entities) you wish to mark. Press Enter when finished.\n```\n*The script will filter panels based on their orientation relative to the level (e.g., vertical walls vs. horizontal floors).*\n\n### Step 4: Set Location\n```\nCommand Line: Select insertion point\nAction: Click a point in the model space to define the location of the level marker.\n```\n*This establishes the reference plane for the elevation.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Elevation** | Number | 500 | The numeric height value displayed on the marker (e.g., +500.00). |\n| **Size** | Number | 50 | The physical size/scale of the marker symbol and text height in the model. |\n| **Style** | Dropdown | Finished Face | Determines if the marker arrow is **Solid** (Finished Face) or an **Outline** (Raw Face). |\n| **Type** | Dropdown | Floor | Determines the arrow direction: **Up** (Floor) or **Down** (Ceiling). |\n| **Dimstyle** | Dropdown | *Current* | The text style used for the elevation label (populated from drawing DimStyles). |\n| **Color** | Number | 211 | The color index used for the marker geometry and text. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Add Childs** | Prompts you to select additional CLT panels. New marker instances will be created on these panels and linked to the current instance. |\n| **Delete Childs** | Erases all child marker instances associated with this level. The main (Parent) instance remains. |\n\n## Settings Files\nNone.\n\n## Tips\n- **Parent-Child Workflow**: The first instance created is the \"Parent\". If you select multiple panels during insertion, \"Child\" instances are automatically created on them. Always select and modify the **Parent** instance to update the Elevation, Size, or Style for all markers in that level simultaneously.\n- **Moving Levels**: If you use the Move or Grip Edit command to reposition the Parent instance, all Child instances will move with it to maintain alignment.\n- **Orientation**: Ensure your CLT panels are modeled correctly. The script may ignore panels that do not intersect the calculated elevation plane or have non-standard orientations.\n\n## FAQ\n- **Q: Why did the script disappear immediately after I ran it?**\n  A: The script erases itself if no valid CLT panels are detected or if the selected panels do not intersect the defined elevation plane. Check that your panels are modeled as Solids (Sip) and are correctly positioned in 3D space.\n- **Q: Can I change the text font of the elevation label?**\n  A: Yes. Use the **Dimstyle** property in the Properties Palette to select a different dimension style defined in your CAD project.\n- **Q: What is the difference between \"Finished Face\" and \"Raw Face\"?**\n  A: \"Finished Face\" draws a solid filled triangle, typically used for final floor levels. \"Raw Face\" draws a wireframe outline, often used for structural levels or unfinished surfaces."
      },
      "tokens_used": 6745,
      "error": null
    }
  }
}