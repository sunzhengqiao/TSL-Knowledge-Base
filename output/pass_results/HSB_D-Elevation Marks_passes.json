{
  "filename": "HSB_D-Elevation Marks.mcr",
  "status": "completed",
  "total_tokens": 48086,
  "processing_time": 366.38744163513184,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": "",
          "keywords": [],
          "majorVersion": "",
          "minorVersion": "",
          "dxaOut": "",
          "implInsert": ""
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "29.09.2014",
            "author": "",
            "changes": "Pilot version, rewritten HSB-HeightGauges."
          },
          {
            "version": "1.01",
            "date": "30.09.2014",
            "author": "",
            "changes": "Add material filter."
          },
          {
            "version": "1.02",
            "date": "05.02.2015",
            "author": "",
            "changes": "Add filters and display name"
          },
          {
            "version": "1.03",
            "date": "20.04.2016",
            "author": "",
            "changes": "Improve detection of openings"
          },
          {
            "version": "1.04",
            "date": "21.04.2016",
            "author": "",
            "changes": "Add filter for opening descriptions"
          },
          {
            "version": "1.05",
            "date": "03.03.2017",
            "author": "",
            "changes": "Correct direction in openings when using entities instead of outline."
          },
          {
            "version": "1.06",
            "date": "28.06.2018",
            "author": "",
            "changes": "Added use of HSB_G-FilterGenBeams.mcr"
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "HSB_G-FilterGenBeams.mcr"
        ]
      },
      "tokens_used": 8836,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Summary comment explicitly states 'shows elevation marks in paperspace'. Code contains 'Viewport vp = getViewport(...)' to select a viewport. Logic includes 'Matrix3d ms2ps' and coordinate transformation 'transformBy(ms2ps)' to convert model coordinates to paper space. Uses '_Viewport' array and 'Element el = vp.element()'."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "GenBeam",
            "Opening"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space Layout containing an hsbCAD viewport of an Element",
          "requiredSettings": [
            "HSB_G-FilterGenBeams.mcr"
          ]
        }
      },
      "tokens_used": 7292,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 8056,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automatically generates elevation height marks (level indicators) in Paper Space for a selected timber frame element view.\",\n    \"category\": \"ShopDrawing\",\n    \"typicalUseCase\": \"Creating elevation drawings on layout sheets to show floor-to-floor heights and sill/head heights of openings, excluding non-structural materials like sheathing or cladding.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"genBeamFilterDefinition\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Selects a pre-defined filter configuration (from HSB_G-FilterGenBeams) to exclude specific structural elements (e.g., ignoring sheathing) when determining the envelope for elevation marks.\",\n      \"validRange\": \"Any catalog name from HSB_G-FilterGenBeams or Empty\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Determines which beams define the top/bottom of the element. If sheathing is filtered out, marks indicate the timber frame height.\"\n    },\n    {\n      \"name\": \"sFilterBC\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Exclude beams/sheets with specific Beam Codes from"
      },
      "tokens_used": 9696,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Insertion triggered.",
          "2. Show Configuration Dialog (Filter definitions, Positioning, Style).",
          "3. Prompt user to Select a Viewport in PaperSpace.",
          "4. Prompt user to Select an insertion point in PaperSpace.",
          "5. [Recalculation] Retrieve linked Viewport and Element.",
          "6. Check Context Menu Exclusion Map (_Map) for element handle.",
          "7. Validate Element validity and existence of structural GenBeams.",
          "8. Parse property strings for BeamCode, Material, Label, Zone, and Opening filters.",
          "9. Calculate transformation matrix (Model Space to Paper Space).",
          "10. Iterate through all GenBeams in the element, filtering out excluded types.",
          "11. Determine element bounding box/profile based on remaining structural beams.",
          "12. Iterate through Openings, filtering by description and determining geometry (sill/head).",
          "13. Calculate elevation points based on 'Opening Marks' and 'Opening Outline' settings.",
          "14. Project points to dimension line and sort vertically.",
          "15. Draw elevation marks, labels, and script name."
        ],
        "conditionalBranches": [
          {
            "condition": "Is the current element handle found in the Exclusion Map (Context Menu)?",
            "path1": {
              "name": "Element is Filtered",
              "steps": [
                "Display script name in 'Filter this element color' (Red by default).",
                "Display 'Active filter' text.",
                "Exit script immediately (no geometry processing)."
              ]
            },
            "path2": {
              "name": "Element is Active",
              "steps": [
                "Proceed to parse filters and process geometry.",
                "Display script name in 'Default name color'."
              ]
            }
          },
          {
            "condition": "Value of 'Opening outline' property (sOpeningOutline).",
            "path1": {
              "name": "Opening outline (Index 0)",
              "steps": [
                "Use standard opening dimensions (width/height) to find sill and head points."
              ]
            },
            "path2": {
              "name": "Beams and sheets around opening (Index 1)",
              "steps": [
                "Collect structural beams profile.",
                "Project opening vertical line against beam profile.",
                "Calculate intersection points to determine exact structural height."
              ]
            }
          },
          {
            "condition": "Value of 'Opening marks' property (sOpeningMarks).",
            "path1": {
              "name": "Inside opening (Index 0)",
              "steps": [
                "Add transoms (top/bottom of opening) to the main height list.",
                "Sort all points (Floor + Openings) together."
              ]
            },
            "path2": {
              "name": "At element side (Index 1)",
              "steps": [
                "Keep main floor heights separate.",
                "Project opening marks to a side line (offset by 'Distance to opening side').",
                "Allow extra offset for opening marks."
              ]
            },
            "path3": {
              "name": "Ignore openings (Index 2)",
              "steps": [
                "Skip processing of openings entirely.",
                "Only generate main element floor height marks."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Array",
            "errorMessage": "None (Silent return)",
            "recovery": "Ensure the TSL instance has a valid viewport link (inserted correctly)."
          },
          {
            "check": "Element Validity (el.bIsValid())",
            "errorMessage": "None (Silent return)",
            "recovery": "Ensure the selected viewport refers to a valid hsbCAD Element."
          },
          {
            "check": "Structural Geometry Exists",
            "errorMessage": "None (Silent return)",
            "recovery": "Ensure the element contains GenBeams that are not filtered out by the filter definitions. If all beams are filtered (e.g., 'Sheathing' filter removes everything), no marks are generated."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Script Instance",
            "how": "Grip Edit (Drag insertion point)",
            "effect": "Relocates the script name/description block. Dimension lines update automatically based on geometry, not this point, but the reference label moves."
          },
          {
            "action": "Filter Element",
            "how": "Right-click Context Menu -> 'Filter this element'",
            "effect": "Adds element handle to internal map. Script hides all geometry and shows 'Active filter' warning. Useful for temporarily disabling marks on specific layouts."
          },
          {
            "action": "Modify Configuration",
            "how": "Object Properties Palette (OPM)",
            "effect": "Updates filters (BeamCode, Material), offsets, or dimension styles. Script recalculates immediately."
          }
        ]
      },
      "tokens_used": 8733,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_D-Elevation Marks.mcr\n\n## Overview\nAutomatically generates elevation height marks (level indicators) in Paper Space for a selected timber frame element view. It displays floor-to-floor heights and opening sill/head heights, excluding non-structural materials based on configurable filters.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed for Paper Space only. |\n| Paper Space | Yes | Requires an active layout with a hsbCAD Viewport. |\n| Shop Drawing | No | Manual insertion script for layouts. |\n\n## Prerequisites\n- **Required Entities**: A Paper Space Layout containing a valid hsbCAD Viewport displaying an Element (Model Space).\n- **Element Contents**: The Element must contain structural GenBeams (walls/floors) and optionally Openings.\n- **Required Settings**: `HSB_G-FilterGenBeams.mcr` (must be loaded for filter configurations).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_D-Elevation Marks.mcr`\n\n### Step 2: Configuration\nUpon insertion, a configuration dialog appears.\n- **Action**: Define filter settings (Beam Codes, Materials), positioning offsets, and dimension styles.\n- **Note**: You can change these later via the Properties Palette.\n\n### Step 3: Select Viewport\n```\nCommand Line: Select a viewport in PaperSpace\nAction: Click on the viewport border that displays the elevation you wish to dimension.\n```\n\n### Step 4: Place Script\n```\nCommand Line: Select an insertion point\nAction: Click in the Paper Space to place the script reference point (usually near the elevation).\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| **genBeamFilterDefinition** | String | Selects a pre-defined filter configuration (from `HSB_G-FilterGenBeams`) to exclude specific elements (e.g., sheathing) when determining the structural envelope. |\n| **sFilterBC** | String | Exclude beams/sheets with specific Beam Codes from the elevation calculation. |\n| **sOpeningOutline** | Index | Determines how opening geometry is calculated: <br>0: Standard opening dimensions (width/height). <br>1: Structural profile of beams/sheets surrounding the opening. |\n| **sOpeningMarks** | Index | Controls where opening marks are placed: <br>0: Inside the opening (mixed with floor levels). <br>1: At the side of the element (offset). <br>2: Ignore openings (floor levels only). |\n| **Distance to opening side** | Double | The offset distance from the element when `sOpeningMarks` is set to \"At element side\". |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Filter this element** | Adds the current element to an exclusion list. The script will hide all elevation marks and display a red \"Active filter\" warning. Useful for temporarily disabling marks on specific views without deleting the script. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams.mcr`\n- **Purpose**: Provides catalog entries for filtering specific structural elements (e.g., distinguishing between structural timber and cladding/sheathing).\n\n## Tips\n- **Troubleshooting Empty Views**: If no marks appear, check your filters. You may have filtered out all structural beams (e.g., if the filter only looks for \"Floor\" but the element is a \"Wall\").\n- **Moving Marks**: Use the grip point to move the script name/label. The dimension lines update automatically based on the model geometry, but the label position is controlled by the insertion point.\n- **Right-Click to Disable**: If you need to suppress marks for a specific viewport quickly, use the \"Filter this element\" right-click option.\n\n## FAQ\n- **Q: Why do my elevation marks not line up with the physical timber?**\n  - **A:** Check the `sOpeningOutline` property. If set to \"Standard opening dimensions,\" it uses the opening rough-in size rather than the structural beam size. Switch to \"Beams and sheets around opening\" for structural accuracy.\n- **Q: Can I show floor levels but ignore window heights?**\n  - **A:** Yes. Set the `sOpeningMarks` property to \"Ignore openings\".\n- **Q: The script shows \"Active filter\" in red text.**\n  - **A:** You have likely right-clicked and selected \"Filter this element\" previously. To fix this, access the context menu again to remove the filter or check the internal exclusion map logic (requires developer access) or simply delete and re-insert the script if the filter state is stuck."
      },
      "tokens_used": 5473,
      "error": null
    }
  }
}