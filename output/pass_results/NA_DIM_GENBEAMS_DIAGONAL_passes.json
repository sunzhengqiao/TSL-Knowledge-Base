{
  "filename": "NA_DIM_GENBEAMS_DIAGONAL.mcr",
  "status": "completed",
  "total_tokens": 43891,
  "processing_time": 398.1637930870056,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5620,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly requests a Viewport using getViewport(), retrieves paper space properties (ptCenPS, widthPS, heightPS), calculates a model-to-paper transformation (CoordSys), and transforms dimension output using transformBy(modelToPaperTransformation)."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script requires a selected Viewport on a Paper Space layout containing a valid Element.",
          "requiredSettings": []
        }
      },
      "tokens_used": 6247,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "\nOptional: Select viewport side TSL to use its starting point and direction for diagonal dimension line",
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "\nSelect element viewport",
              "condition": "_bOnInsert && bNeedViewport == true",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Dynamic OPM Properties Dialog",
            "trigger": "User right-clicks 'Edit dimension properties' in context menu",
            "title": "Edit dimension properties / Modifier les propriétés de cote",
            "dataSource": "Map 'Genbeams at viewport side' containing PropertyDefinitions",
            "features": {
              "searchable": true,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "N/A (Defined in Map)",
            "type": "PropInt",
            "displayName": "Version",
            "defaultValue": "Current Script Version",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Default language",
            "defaultValue": "en-US",
            "inputType": "dropdown",
            "options": [
              "en-US",
              "fr-CA"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Genbeam filter",
            "defaultValue": "First in list",
            "inputType": "dropdown",
            "options": [
              "Populated by PainterDefinitions of type GenBeam"
            ],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 3,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Genbeam subfilter",
            "defaultValue": "First in list",
            "inputType": "dropdown",
            "options": [
              "Populated by PropertyDefinitions of type GenBeam"
            ],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 4,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Genbeam property name",
            "defaultValue": "First in list",
            "inputType": "dropdown",
            "options": [
              "Populated by PropertyDefinitions of type GenBeam"
            ],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 5,
            "variable": "N/A (Defined in Map)",
            "type": "PropDouble",
            "displayName": "Genbeam property minimum",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 6,
            "variable": "N/A (Defined in Map)",
            "type": "PropDouble",
            "displayName": "Genbeam property maximum",
            "defaultValue": "99999",
            "inputType": "number",
            "options": [],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 7,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Side selection",
            "defaultValue": "Top",
            "inputType": "dropdown",
            "options": [
              "Top",
              "Bottom"
            ],
            "category": "Genbeam selection",
            "description": null
          },
          {
            "index": 8,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Dimension style",
            "defaultValue": "Standard",
            "inputType": "dropdown",
            "options": [
              "Populated by available DimensionStyles"
            ],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 9,
            "variable": "N/A (Defined in Map)",
            "type": "PropDouble",
            "displayName": "Text height",
            "defaultValue": "2.5",
            "inputType": "number",
            "options": [],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 10,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Text side",
            "defaultValue": "Above dimension line",
            "inputType": "dropdown",
            "options": [
              "Above dimension line",
              "Below dimension line"
            ],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 11,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Text orientation",
            "defaultValue": "Parallel",
            "inputType": "dropdown",
            "options": [
              "Parallel",
              "Perpendicular"
            ],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 12,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Project points to dimension line",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 13,
            "variable": "N/A (Defined in Map)",
            "type": "PropDouble",
            "displayName": "Dimension line offset",
            "defaultValue": "5",
            "inputType": "number",
            "options": [],
            "category": "Dimension styling",
            "description": null
          },
          {
            "index": 14,
            "variable": "N/A (Defined in Map)",
            "type": "PropString",
            "displayName": "Diagonal to dimension",
            "defaultValue": "Longest diagonal",
            "inputType": "dropdown",
            "options": [
              "Longest diagonal",
              "Shortest diagonal"
            ],
            "category": "Dimension styling",
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Edit dimension properties / Modifier les propriétés de cote",
            "handler": "callPropertiesTrigger",
            "action": "Opens a dialog to edit dimension properties (filters, text style, etc.)",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Add properties override for current element / Ajouter un remplacement de propriétés pour l’élément actuel",
            "handler": "overridePropertiesTrigger",
            "action": "Copies the global settings to an element-specific override map",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove properties override for current element / Supprimer le remplacement de propriétés pour l’élément actuel",
            "handler": "removePropertiesOverrideTrigger",
            "action": "Deletes the element-specific override, reverting to global settings",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Reset grip points for current element / Réinitialiser les points de préhension pour l’élément actuel",
            "handler": "resetGripPointsTrigger",
            "action": "Resets internal grip point logic",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Grip Point Drag",
            "handler": "_Grip",
            "action": "Internal trigger for handling grip point movement",
            "alsoTriggeredBy": "Grip Point Drag"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8460,
      "error": null
    },
    "4": {
      "success": true,
      "data": {},
      "tokens_used": 7845,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Set language keys ('en-US', 'fr-CA'), load 'Genbeams at viewport side' properties map, and initialize grip point logic.",
          "2. Database Linking Check: If triggered by database creation (_bOnDbCreated) with a linked entity, register this instance as a dependant to the source TSL and exit.",
          "3. Insertion Routine (_bOnInsert):",
          "   a. Cycle Check: If insertCycleCount > 1, erase instance and exit (prevents duplicates).",
          "   b. Optional Selection: Prompt user to select an existing 'NA_DIM_GENBEAMS_AT_VIEWPORT_SIDE' TSL.",
          "   c. Branching:",
          "      - If valid TSL selected: Store reference in _Entity, skip viewport prompt.",
          "      - If not selected/different: Prompt user to select a Viewport (_Viewport).",
          "4. Validation Routine:",
          "   a. Retrieve Viewport/Element data either from the linked Side TSL map or the selected Viewport object.",
          "   b. Validity Check:",
          "      - If no Viewport data exists (and not on insert): Report error, erase instance.",
          "      - If Element is invalid (and not on insert): Report error, stop execution.",
          "5. Coordinate Calculation: Compute Model-to-Paper transformation, Viewport Scale, and Layout Vectors (X, Y, Z in Model space).",
          "6. Context Menu Setup: Register triggers for 'Edit Properties', 'Add/Remove Override', and 'Reset Grips'.",
          "7. Properties Resolution:",
          "   a. Check if an Element-specific override exists (UserSelectedValues~ElementHandle).",
          "   b. If override exists: Load it and display a warning message.",
          "   c. If 'Remove Override' triggered: Delete the specific key.",
          "   d. Otherwise: Load global default properties.",
          "8. Execution (if not on _bOnInsert):",
          "   a. Filter GenBeams: Select beams matching the PainterDefinition, Property filters (Name, Min/Max), and Side (Top/Bottom).",
          "   b. Extract Geometry: Get outlines of filtered beams and join them into a single profile.",
          "   c. Calculate Diagonal: Determine either the longest or shortest diagonal of the joined profile.",
          "   d. Create Dimension: Generate the dimension line using calculated diagonal, applying style, text height, and offset settings.",
          "   e. Draw: Render the dimension in the viewport."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Source",
            "path1": {
              "name": "Inherit from Side TSL",
              "steps": [
                "User selects 'NA_DIM_GENBEAMS_AT_VIEWPORT_SIDE' instance.",
                "Script extracts Viewport and Element data from the TSL's map.",
                "Proceeds to Validation."
              ]
            },
            "path2": {
              "name": "New Viewport Selection",
              "steps": [
                "User selects a Viewport object.",
                "Script extracts Viewport and Element data directly from the object.",
                "Proceeds to Validation."
              ]
            }
          },
          {
            "condition": "Properties Scope",
            "path1": {
              "name": "Element-Specific Override",
              "steps": [
                "Map contains key 'UserSelectedValues~ElementHandle'.",
                "Load settings from this specific key.",
                "Report 'This is an override for element [Number]'."
              ]
            },
            "path2": {
              "name": "Global Default",
              "steps": [
                "Map key for Element handle does not exist.",
                "Load settings from 'UserSelectedValues'."
              ]
            }
          },
          {
            "condition": "Diagonal Calculation",
            "path1": {
              "name": "Longest Diagonal",
              "steps": [
                "Compare lengths of the two profile diagonals.",
                "Select the diagonal with the maximum length."
              ]
            },
            "path2": {
              "name": "Shortest Diagonal",
              "steps": [
                "Compare lengths of the two profile diagonals.",
                "Select the diagonal with the minimum length."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases the instance if cycle > 1."
          },
          {
            "check": "Viewport Existence",
            "errorMessage": "[ScriptName]: No valid viewport. Erasing this instance.",
            "recovery": "User must re-insert the script and ensure a valid viewport is selected."
          },
          {
            "check": "Element Validity",
            "errorMessage": "No valid element in viewport",
            "recovery": "User must check the referenced model/element in the viewport."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Dimension Properties",
            "how": "Right-click Context Menu -> 'Edit dimension properties'",
            "effect": "Opens a dynamic dialog to modify filters, styles, and text settings globally."
          },
          {
            "action": "Add Properties Override",
            "how": "Right-click Context Menu -> 'Add properties override for current element'",
            "effect": "Creates a copy of current settings specific to the element handle, allowing unique configuration per element."
          },
          {
            "action": "Remove Properties Override",
            "how": "Right-click Context Menu -> 'Remove properties override for current element'",
            "effect": "Deletes the element-specific settings, reverting to global defaults."
          },
          {
            "action": "Reset Grip Points",
            "how": "Right-click Context Menu -> 'Reset grip points for current element'",
            "effect": "Clears internal grip point arrays (_Grip) to reset state."
          },
          {
            "action": "Modify via Properties Palette",
            "how": "Select TSL instance in AutoCAD -> Properties Palette",
            "effect": "Direct modification of properties like 'Text height', 'Dimension style', or 'Genbeam filter'."
          }
        ]
      },
      "tokens_used": 9110,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# NA_DIM_GENBEAMS_DIAGONAL.mcr\n\n## Overview\nThis script automatically creates a diagonal dimension line for generic beams (GenBeams) displayed in a Paper Space viewport. It calculates the dimension based on filtered beam properties and allows users to choose between the longest or shortest diagonal of the selected elements.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script operates within Paper Space layouts. |\n| Paper Space | Yes | This is the primary environment; a Viewport must be selected. |\n| Shop Drawing | No | This is a general detailing script, not a shop drawing generator. |\n\n## Prerequisites\n- **Required Entities**: A Viewport on a Paper Space layout containing a valid Element with GenBeams.\n- **Minimum beam count**: 0.\n- **Required settings**: The script relies on existing hsbCAD PainterDefinitions and PropertyDefinitions for filtering beams.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `NA_DIM_GENBEAMS_DIAGONAL.mcr`\n\n### Step 2: Select Existing TSL (Optional)\n```\nCommand Line: Optional: Select viewport side TSL to use its starting point and direction for diagonal dimension line\nAction: If you have an existing 'NA_DIM_GENBEAMS_AT_VIEWPORT_SIDE' script on your drawing and wish to use its configuration, click it. Otherwise, press Enter or Esc to skip this step.\n```\n\n### Step 3: Select Viewport\n```\nCommand Line: Select element viewport\nAction: Click on the viewport frame (or inside it) that contains the element you want to dimension.\n```\n\n### Step 4: Configuration\nAfter insertion, the script runs using default settings. To configure the dimension, select the script instance and use the Properties Palette or the Right-Click menu to adjust filters, text styles, and diagonal options.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Default language | dropdown | en-US | Sets the language for script messages (en-US or fr-CA). |\n| **Genbeam selection** | | | |\n| Genbeam filter | dropdown | First in list | Selects the PainterDefinition to filter which beams to include. |\n| Genbeam subfilter | dropdown | First in list | Selects a Property Definition to further refine the beam selection. |\n| Genbeam property name | dropdown | First in list | The specific property name used for filtering. |\n| Genbeam property minimum | number | 0 | Minimum value for the property filter. |\n| Genbeam property maximum | number | 99999 | Maximum value for the property filter. |\n| Side selection | dropdown | Top | Selects which side of the element to dimension (Top or Bottom). |\n| **Dimension styling** | | | |\n| Dimension style | dropdown | Standard | The AutoCAD dimension style to apply. |\n| Text height | number | 2.5 | Height of the dimension text. |\n| Text side | dropdown | Above dimension line | Places text above or below the dimension line. |\n| Text orientation | dropdown | Parallel | Aligns text parallel or perpendicular to the dimension line. |\n| Project points to dimension line | dropdown | Yes | If Yes, projects points onto the dimension line; if No, uses raw coordinates. |\n| Dimension line offset | number | 5 | Distance between the dimension line and the measured geometry. |\n| Diagonal to dimension | dropdown | Longest diagonal | Chooses between dimensioning the longest or shortest diagonal of the profile. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Edit dimension properties / Modifier les propriétés de cote | Opens a dialog box to modify global dimension properties, such as filters and text styles. |\n| Add properties override for current element / Ajouter un remplacement de propriétés pour l’élément actuel | Saves the current settings specifically for the Element in the selected viewport. This allows different settings for different elements. |\n| Remove properties override for current element / Supprimer le remplacement de propriétés pour l’élément actuel | Deletes the element-specific settings and reverts to the global default settings. |\n| Reset grip points for current element / Réinitialiser les points de préhension pour l’élément actuel | Clears the internal grip point logic for the current element. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script uses internal hsbCAD definitions (Painter/Property definitions) and does not require an external settings XML file.\n\n## Tips\n- **Filtering**: Use the \"Genbeam filter\" property to target specific types of beams (e.g., only rafters or only joists).\n- **Overrides**: If you have multiple elements on one sheet that require different dimension configurations (e.g., different text heights), use the \"Add properties override\" option on each script instance rather than changing the global properties.\n- **Diagonal Choice**: If dimensioning a rectangular wall, \"Longest diagonal\" gives the overall span, while \"Shortest diagonal\" might be useful for specific panel checks.\n\n## FAQ\n- **Q: Why did my script instance disappear?**\n- **A:** The script requires a valid Viewport linked to an Element. If the viewport or element is deleted, or if the script is inserted in a cycle that duplicates it, it will automatically erase itself to prevent errors.\n- **Q: Can I use this script in Model Space?**\n- **A:** No, this script is designed specifically for creating dimensions in Paper Space viewports.\n- **Q: How do I change which beams are dimensioned?**\n- **A:** Use the Properties Palette to change the \"Genbeam filter\" or \"Genbeam property name\" to match the specific attributes of the beams you wish to measure."
      },
      "tokens_used": 6609,
      "error": null
    }
  }
}