{
  "filename": "ToolTag.mcr",
  "status": "completed",
  "total_tokens": 54287,
  "processing_time": 359.3202531337738,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "Select genbeams or multipages, when in block space of a multipage select orthogonal shopdraw viewports",
        "versionHistory": [
          {
            "version": "2.0",
            "date": "18.06.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-24185 blockspace detection improved"
          },
          {
            "version": "1.9",
            "date": "17.06.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-24187 tool naming improved, dialogs in blockspace improved, translation issues fixed"
          },
          {
            "version": "1.8",
            "date": "30.04.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23979 bugfix collecting mortises and freeprofiles"
          },
          {
            "version": "1.7",
            "date": "26.02.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23582 filtering improved, new dispaly 'shapeOnly', new filter mode 'byLocation'"
          },
          {
            "version": "1.6",
            "date": "05.02.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23466 option to use any subtype prepared"
          },
          {
            "version": "1.5",
            "date": "31.01.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23393 Beamcut: WidthInView and LengthInView added"
          },
          {
            "version": "1.4",
            "date": "31.01.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23393 face index detection fixed for free profile and boxed shaped tools"
          },
          {
            "version": "1.3",
            "date": "28.01.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23412 blockspace creation supported"
          },
          {
            "version": "1.2",
            "date": "28.01.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-23393 new painter driven tool filtering supported"
          },
          {
            "version": "1.1",
            "date": "27.11.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-23066 supports tools of type Drill, Beamcut, Mortise, House, Slot or FreeProfile, filtering, grouping and leader styles added"
          },
          {
            "version": "1.0",
            "date": "29.10.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22885 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9285,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Description explicitly mentions 'block space of a multipage select orthogonal shopdraw viewports'. Code checks for Multipages with 'if (strStartsWith(sElName, \"MP\") || strStartsWith(sElName, \"Multipage\"))'. Code uses Viewport data: 'CoordSys csBlockSpace; csBlockSpace.set UCS_2D(_Viewport[0]);'. Code accesses ShopDraw properties: 'Sheet sheet = Sheet(element.map(), \"ShopDraw\");'. Script implements Mode 3 Dummy Mode handling '_Entity' dependencies."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires GenBeams in Model Space or a Multipage Element in Paper Space.",
          "requiredSettings": [
            "TslUtilities.dll"
          ]
        }
      },
      "tokens_used": 8624,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "SelectFromList",
            "trigger": "RunScript called or User interaction initiated",
            "title": "null",
            "dataSource": "sToolTypes (Array of tool types like Drills, Beamcuts, etc.)",
            "features": {
              "searchable": true,
              "multiSelect": true
            }
          },
          {
            "type": "ShowMultilineNotice",
            "trigger": "Error in script execution",
            "title": "null",
            "dataSource": "String 'sErr'",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSelToolType",
            "type": "PropString",
            "displayName": "|Tool Type|",
            "defaultValue": "|_Default|",
            "inputType": "dropdown",
            "options": [],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 1,
            "variable": "nFilterMode",
            "type": "PropInt",
            "displayName": "|Filter Mode|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|Side|",
              "|Top/Bottom|",
              "|End|",
              "|Visible|",
              "|by Location|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 2,
            "variable": "dTolLoc",
            "type": "PropDouble",
            "displayName": "|Location Tol.|",
            "defaultValue": 50,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 3,
            "variable": "nGrouping",
            "type": "PropInt",
            "displayName": "|Grouping|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|None|",
              "|Type|",
              "|Subtype|",
              "|Diameter|",
              "|Diameter x Length|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 4,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|DimStyle|",
            "defaultValue": "|_LastInserted|",
            "inputType": "dropdown",
            "options": [],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 5,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 6,
            "variable": "sLeaderStyle",
            "type": "PropString",
            "displayName": "|Leader Style|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|None|",
              "|All|",
              "|Primary|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 7,
            "variable": "sTagStyle",
            "type": "PropString",
            "displayName": "|Tag Style|",
            "defaultValue": "|Text Filled + Shape|",
            "inputType": "dropdown",
            "options": [
              "|Text Filled|",
              "|Text Only|",
              "|Text Filled + Shape|",
              "|Text Only + Shape|",
              "|Shape Only|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 8,
            "variable": "nQuantity",
            "type": "PropInt",
            "displayName": "|Quantity|",
            "defaultValue": 2,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 9,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(Name) @(Diameter) x @(Length)",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 10,
            "variable": "bShowTags",
            "type": "PropInt",
            "displayName": "|Show Tags|",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": "null"
          },
          {
            "index": 11,
            "variable": "nTagOrder",
            "type": "PropInt",
            "displayName": "|Tag Order|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|Unsorted|",
              "|X|",
              "|Y|"
            ],
            "category": "|General|",
            "description": "null"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Tool Settings|",
            "handler": "|Tool Settings|",
            "action": "Opens dynamic dialog to modify tool selection via SelectFromList",
            "alsoTriggeredBy": "null"
          },
          {
            "menuItem": "|UserPrompt|",
            "handler": "|UserPrompt|",
            "action": "Opens dynamic dialog to modify tool selection via SelectFromList",
            "alsoTriggeredBy": "null"
          },
          {
            "menuItem": "TslDoubleClick",
            "handler": "TslDoubleClick",
            "action": "Opens dynamic dialog to modify tool selection via SelectFromList",
            "alsoTriggeredBy": "Double Click on Script"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9608,
      "error": null
    },
    "4": {
      "success": true,
      "data": {},
      "tokens_used": 9563,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: User executes command or inserts script.",
          "2. Environment Detection: Script determines if running in Model Space (GenBeams) or Paper Space (Multipage/ShopDraw).",
          "3. Initial Selection/Configuration:",
          "   - If in Model Space: Select GenBeams to process.",
          "   - If in Paper Space: Select Multipage element.",
          "4. Tool Selection Dialog (Triggered on insert or via right-click 'Tool Settings'): Displays multi-select list of available tool types (Drills, Beamcuts, etc.). User selects relevant tools.",
          "5. Data Collection & Filtering: Script iterates through tools on selected elements.",
          "   - Applies Filter Mode (All, Side, Top/Bottom, End, Visible, By Location).",
          "   - If 'By Location', applies location tolerance.",
          "   - Filters by selected Tool Types and Painter assignments (if applicable).",
          "6. Grouping: Tools are grouped based on Grouping property (None, Type, Subtype, Diameter, etc.).",
          "7. Coordinate Calculation: Calculates view coordinates. If in Paper Space (BlockSpace), uses Viewport transformations to project 2D coordinates.",
          "8. Tag Generation:",
          "   - Calculates bounding box and tag position based on Tag Style.",
          "   - Generates text string using Format property (e.g., Name, Diameter, Length).",
          "   - Handles Quantity logic.",
          "9. Visualization: Draws tag (Text, Shape, or both) and Leader lines if enabled.",
          "10. Instance Management: Handles 'Dummy Mode' (Mode 3) instances created for Painter acceptance logic.",
          "11. Completion: Tags are displayed in drawing."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion Space (Model vs Paper Space)",
            "path1": {
              "name": "Model Space",
              "steps": [
                "Prompt user to select GenBeams.",
                "Process tools directly from beam geometry.",
                "No viewport transformation required."
              ]
            },
            "path2": {
              "name": "Paper Space (BlockSpace)",
              "steps": [
                "Prompt user to select Multipage.",
                "Detect orthogonal shopdraw viewports.",
                "Transform tool coordinates from 3D Model Space to 2D Viewport Space.",
                "Filter tools visible in current view."
              ]
            }
          },
          {
            "condition": "Tag Style Selection",
            "path1": {
              "name": "Text Only",
              "steps": [
                "Generate formatted text string.",
                "Draw text at calculated position.",
                "Do not draw tool shapes."
              ]
            },
            "path2": {
              "name": "Shape Included",
              "steps": [
                "Generate formatted text string.",
                "Draw tool shape outline (projected profile).",
                "Draw text and shape background box (if 'Filled')."
              ]
            }
          },
          {
            "condition": "Leader Style and Position",
            "path1": {
              "name": "Inside Shape",
              "steps": [
                "Check if tag position point is inside the tool profile.",
                "If inside, do not draw leader line."
              ]
            },
            "path2": {
              "name": "Outside Shape",
              "steps": [
                "Check if tag position point is outside the tool profile.",
                "Calculate shortest path from tag to tool profile.",
                "Draw leader line (elbow type)."
              ]
            }
          },
          {
            "condition": "Grouping Mode",
            "path1": {
              "name": "None",
              "steps": [
                "Create individual tag for every single tool found.",
                "No aggregation."
              ]
            },
            "path2": {
              "name": "Type/Subtype/Diameter/etc.",
              "steps": [
                "Aggregate tools based on selected property.",
                "Sum quantities.",
                "Create one tag per unique group."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "No GenBeams selected in Model Space",
            "errorMessage": "No elements selected.",
            "recovery": "Select valid GenBeams and retry."
          },
          {
            "check": "No tools found on selected beams",
            "errorMessage": "No tools found matching criteria.",
            "recovery": "Change Filter Mode or Tool Selection settings."
          },
          {
            "check": "Dimension Style not found",
            "errorMessage": "Dimension Style error",
            "recovery": "Ensure valid DimStyle name is provided or default is available."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Tool Selection",
            "how": "Right-click context menu 'Tool Settings' or 'UserPrompt' or Double Click",
            "effect": "Opens SelectFromList dialog to change which tool types are tagged. Triggers recalculation."
          },
          {
            "action": "Adjust Tag Position",
            "how": "Grip Edit",
            "effect": "Drag 'Tag' grip to move text. If moved far from tool shape, leader line is automatically added/updated."
          },
          {
            "action": "Change Appearance",
            "how": "Properties Palette (OPM)",
            "effect": "Modify properties like 'Tag Style', 'Text Height', 'Filter Mode', or 'Format' to instantly update visual output."
          },
          {
            "action": "Update on Drawing Change",
            "how": "Automatic",
            "effect": "Script listens to changes in associated GenBeams or Multipage and updates tags automatically."
          }
        ]
      },
      "tokens_used": 10185,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ToolTag.mcr\n\n## Overview\nThis script automatically identifies, groups, and labels machining tools (such as Drills, Beamcuts, and Mortises) on timber beams. It works both in Model Space for direct beam selection and in Paper Space for Multipage layouts.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Select GenBeams directly. |\n| Paper Space | Yes | Select a Multipage element to tag tools within viewports. |\n| Shop Drawing | Yes | Optimized for orthogonal shop drawing viewports. |\n\n## Prerequisites\n- **Required Entities**: GenBeams (in Model Space) or Multipage/Element (in Paper Space).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: `TslUtilities.dll` (must be loaded for dialogs).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `ToolTag.mcr` from the list.\n\n### Step 2: Select Elements\n```\nCommand Line: Select element:\nAction: Click on the GenBeams you wish to process in Model Space, OR click on a Multipage border in Paper Space.\n```\n\n### Step 3: Select Tool Types\n```\nDialog: Select Tool Types\nAction: A dialog appears listing available tool types (e.g., Drill, Beamcut, Mortise, Slot, FreeProfile). Check the boxes for the tools you want to tag and click OK.\n```\n\n### Step 4: Adjust Tags (Optional)\nAfter generation, you can click the script to modify properties in the Properties Palette (OPM) or drag the \"Tag\" grip to reposition the text.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Tool Type** | dropdown | _Default | Opens dialog to select which tool types to include in the tag. |\n| **Filter Mode** | dropdown | All | Determines which tools to tag based on location/orientation (All, Side, Top/Bottom, End, Visible, or By Location). |\n| **Location Tol.** | number | 50 | Tolerance distance for the \"By Location\" filter mode. |\n| **Grouping** | dropdown | None | Groups tools by criteria (None, Type, Subtype, Diameter, Diameter x Length). Useful for summarizing quantities. |\n| **DimStyle** | dropdown | _LastInserted | Specifies the dimension style to use for the tag text. |\n| **Text Height** | number | 0 | Height of the tag text. |\n| **Leader Style** | dropdown | All | Controls leader lines: None, All, or Primary. |\n| **Tag Style** | dropdown | Text Filled + Shape | Visual appearance: Text Filled, Text Only, Text Filled + Shape, Text Only + Shape, or Shape Only. |\n| **Quantity** | dropdown | Yes | Adds a quantity prefix to the tag (e.g., \"4x\"). |\n| **Format** | text | @(Name) @(Diameter) x @(Length) | Custom string format for the tag content using tokens. |\n| **Show Tags** | dropdown | Yes | Toggles the visibility of the tags on/off. |\n| **Tag Order** | dropdown | Unsorted | Sorting order for multiple tags: Unsorted, X, or Y. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Tool Settings** | Opens the multi-select dialog to change which tool types are currently tagged. |\n| **UserPrompt** | Opens the multi-select dialog to change which tool types are currently tagged. |\n| **TslDoubleClick** | Double-clicking the script instance opens the Tool Settings dialog. |\n\n## Settings Files\nNo specific external XML settings file is required. The script relies on the `TslUtilities.dll` for dialog functionality.\n\n## Tips\n- **Grip Editing**: Select the tag and drag the square grip to move the text. If you move the text far away from the tool shape, a leader line will automatically appear.\n- **Paper Space Workflow**: When working on a layout, simply select the Multipage border. The script will detect the viewports and project the 3D tool locations onto the 2D drawing.\n- **Grouping**: Use the \"Grouping\" property set to \"Diameter x Length\" to combine identical cuts into a single label (e.g., \"2x D24 x 50\").\n- **Filtering**: Use \"Filter Mode: Visible\" to only tag tools that are currently visible in the specific view direction.\n\n## FAQ\n\n- **Q: Why does my tag show \"Shape Only\" with no text?**\n  - A: Check the **Tag Style** property in the Properties Palette. It might be set to \"Shape Only\". Change it to \"Text Filled\" or \"Text Filled + Shape\".\n\n- **Q: Can I tag only holes on the top face of a beam?**\n  - A: Yes. Select the script, go to Properties, and set **Filter Mode** to \"Top/Bottom\".\n\n- **Q: How do I tag tools in a specific area of a large beam?**\n  - A: Set **Filter Mode** to \"By Location\" and adjust the **Location Tol.** value. The script will filter tools based on their proximity to the insertion point or viewport logic.\n\n- **Q: The text is too small to read.**\n  - A: Select the script and increase the **Text Height** property value."
      },
      "tokens_used": 7022,
      "error": null
    }
  }
}