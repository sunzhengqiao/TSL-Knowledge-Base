{
  "filename": "f_Tag.mcr",
  "status": "completed",
  "total_tokens": 53005,
  "processing_time": 284.19995164871216,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": 2,\n    \"minorVersion\": 3,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"This tsl creates tags of stacked items.\",\n  \"versionHistory\": [\n    {\n      \"version\": \"2.3\",\n      \"date\": \"03.09.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22614 tag placement improved, color consider pack color if set to -2, new white background, new property access\"\n    },\n    {\n      \"version\": \"2.2\",\n      \"date\":"
      },
      "tokens_used": 9235,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script operates in Model Space, evidenced by the use of 'stackTruckMembers' which retrieves 3D entities, 3D Vector math ('Vector3d'), and 'getViewDirection' for orientation. There are no references to '_Viewport', '_kPaperSpace', 'Sheet' entities, or 'sd_' prefixes typical of Shop Drawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Hsb_TruckParent (Truck)",
            "GenBeam",
            "Body"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (specifically requires 3D stacked items/trucks to function)",
          "requiredSettings": [
            "MapObject settings: 'hsbTSL\\\\f_Stacking'",
            "XML Settings file: 'f_Stacking.xml'",
            "DLL Reference: 'TslUtilities.dll' for dialogs"
          ]
        }
      },
      "tokens_used": 7202,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sHideLinework",
            "type": "PropString",
            "displayName": "|Hide Linework|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Linework|",
            "description": "Defines the linework will be hidden"
          },
          {
            "index": 1,
            "variable": "nColorBack",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": 7,
            "inputType": "number",
            "options": [],
            "category": "|Background|",
            "description": "Defines the color, '16777214' to use almost white true color"
          },
          {
            "index": 2,
            "variable": "nTransparency",
            "type": "PropInt",
            "displayName": "|Transparency|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Background|",
            "description": "Defines the Transparency"
          },
          {
            "index": 3,
            "variable": "sLineType",
            "type": "PropString",
            "displayName": "|LineType|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "_LineTypes.sorted()"
            ],
            "category": "|Guideline|",
            "description": "Defines the LineType"
          },
          {
            "index": 4,
            "variable": "dLineTypeScale",
            "type": "PropDouble",
            "displayName": "|Linetype Scale|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Guideline|",
            "description": "Defines the scale of the linetype"
          },
          {
            "index": 5,
            "variable": "sAttribute",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(Posnum)",
            "inputType": "text",
            "options": [],
            "category": "|Content|",
            "description": "Defines the text and/or attributes. backslash '\\' separates multiple lines"
          },
          {
            "index": 6,
            "variable": "sStyle",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": "|Content|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "f_Stacking.xml",
            "searchPaths": [
              "[Company Path]\\TSL\\Settings\\",
              "[Install Path]\\Content\\General\\TSL\\Settings\\"
            ],
            "purpose": "Provides general settings map and version control. Used to set 'PropertyReadOnly' flag.",
            "required": false
          }
        ]
      },
      "tokens_used": 9463,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and positions descriptive labels for timber elements stacked on a truck or in a package.",
          "category": "Logistics/Documentation",
          "typicalUseCase": "Identifying parts during assembly planning or creating visual labels for transport load lists."
        },
        "parameters": [
          {
            "name": "sHideLinework",
            "technicalDefault": "|No|",
            "businessMeaning": "Toggles the visibility of the guide lines (leaders) connecting the tag label to the timber element.",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean",
            "affectsOutput": "If 'Yes', the guide lines connecting the text to the part are not drawn."
          },
          {
            "name": "nColorBack",
            "technicalDefault": "7",
            "businessMeaning": "Sets the background fill color of the tag to ensure readability over other geometry. A value of '16777214' forces a near-white background regardless of CAD settings.",
            "validRange": "AutoCAD Color Index (1-255) or True Color (RGB)",
            "unit": "Color Index",
            "affectsOutput": "Changes the solid fill color behind the text label."
          },
          {
            "name": "nTransparency",
            "technicalDefault": "1",
            "businessMeaning": "Controls the opacity of the tag background, allowing geometry behind the tag to remain partially visible.",
            "validRange": "0 (Solid) to 90 (Highly Transparent)",
            "unit": "Percentage (approx)",
            "affectsOutput": "Adjusts the see-through quality of the label background rectangle."
          },
          {
            "name": "sLineType",
            "technicalDefault": "null (Continuous)",
            "businessMeaning": "Defines the dash-dot pattern style of the guide lines.",
            "validRange": "Any Linetype loaded in the drawing (e.g., Continuous, Hidden, Center)",
            "unit": "String",
            "affectsOutput": "Visual style of the line connecting the tag to the item."
          },
          {
            "name": "dLineTypeScale",
            "technicalDefault": "1",
            "businessMeaning": "Scales the density of the linetype pattern (e.g., makes dashes longer or shorter).",
            "validRange": "0.1 to 10.0",
            "unit": "Factor",
            "affectsOutput": "Spacing and length of dashes in the guide lines."
          },
          {
            "name": "sAttribute",
            "technicalDefault": "@(Posnum)",
            "businessMeaning": "Defines the content of the label using attribute macros (e.g., Position Number, Length, Material) and formatting options (e.g., truncation, rounding).",
            "validRange": "String combining macros like @(Posnum), @(Length), @(Name) and modifiers like :R, :L, :T, #",
            "unit": "String",
            "affectsOutput": "The actual text information displayed on the tag. Supports multiple lines separated by '\\'."
          },
          {
            "name": "sStyle",
            "technicalDefault": "null",
            "businessMeaning": "Selects the Text Style (defining font and height) to be used for the tag text.",
            "validRange": "Any text style defined in the current drawing",
            "unit": "String",
            "affectsOutput": "Font type and text height of the label."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sHideLinework set to |Yes|",
            "effect": "Disables the drawing of guide lines, rendering Linetype settings irrelevant.",
            "cascade": [
              "sLineType",
              "dLineTypeScale"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text",
            "description": "The informative label displaying data defined by sAttribute.",
            "appliedTo": "Stacked timber members / Truck items"
          },
          {
            "type": "PLine (Polyline)",
            "description": "A rectangular frame surrounding the text.",
            "appliedTo": "Label location"
          },
          {
            "type": "PlaneProfile (Filled Region)",
            "description": "A background fill behind the text to mask underlying geometry.",
            "appliedTo": "Label area"
          },
          {
            "type": "LineSeg (Line Segment)",
            "description": "Guide lines pointing from the label to the specific timber element.",
            "appliedTo": "From Label to Element Center or Edge"
          }
        ]
      },
      "tokens_used": 9546,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: User executes f_Tag.mcr (Insert or Update).",
          "2. Initialization: Set up Units (mm), Colors, and View Direction vectors.",
          "3. Settings Loading: Search for 'f_Stacking.xml'.",
          "   a. Check Company Path (\\\\Company\\\\TSL\\\\Settings).",
          "   b. If not found, check Install Path (\\\\Install\\\\Content\\\\General\\\\TSL\\\\Settings).",
          "   c. Load settings into MapObject (set 'PropertyReadOnly' flag).",
          "4. Property Exposure (DialogMode): If DialogMode is active, register OPM properties (Linework, Background, Content) and return.",
          "5. Entity Identification: Execute 'stackTruckMembers' to retrieve all bodies stacked on the selected truck.",
          "6. Attribute Processing: Parse 'sAttribute' string (e.g., @(Posnum), @(Length)) to generate label text for each member.",
          "7. Categorization: Separate members into 'Primes' (specific main items) and 'Non-Primes' (standard items).",
          "8. Tag Placement & Collision Detection (Prime Items):",
          "   a. Calculate ideal tag location.",
          "   b. Check intersection with protected area (existing tags).",
          "   c. [Conditional] If overlap detected: Shift tag location.",
          "   d. Draw Tag (Text, Frame, Background).",
          "9. Grid Layout (Non-Prime Items):",
          "   a. Calculate grid columns based on load width.",
          "   b. Sort items by Layer.",
          "   c. Place items in sequential grid rows/columns.",
          "   d. Draw Tag and Guide Lines connecting tag to original part center."
        ],
        "conditionalBranches": [
          {
            "condition": "Settings File Path Availability",
            "path1": {
              "name": "Company Settings Found",
              "steps": [
                "Load XML from Company Path",
                "Apply Company defaults/permissions"
              ]
            },
            "path2": {
              "name": "Fallback to Install Path",
              "steps": [
                "Search Install Path",
                "Load default XML",
                "Create new MapObject in drawing if none exists"
              ]
            }
          },
          {
            "condition": "Visual Style (nStyle)",
            "path1": {
              "name": "Style 0 (Minimal)",
              "steps": [
                "Draw Text only"
              ]
            },
            "path2": {
              "name": "Style 1 (Framed)",
              "steps": [
                "Draw Text",
                "Draw PLine Frame"
              ]
            },
            "path3": {
              "name": "Style >1 (Solid)",
              "steps": [
                "Draw Text",
                "Draw PLine Frame",
                "Draw Filled PlaneProfile Background (using nTransparency)"
              ]
            }
          },
          {
            "condition": "Collision Detection (Prime Items)",
            "path1": {
              "name": "Overlap Detected",
              "steps": [
                "Calculate shift vector (vecDir)",
                "Test new location intersection",
                "Update tag position if clear"
              ]
            },
            "path2": {
              "name": "No Overlap",
              "steps": [
                "Draw tag at calculated position",
                "Add tag boundary to protected area"
              ]
            }
          },
          {
            "condition": "Linetype Validity",
            "path1": {
              "name": "Valid Linetype",
              "steps": [
                "Set dp.lineType to user selection",
                "Draw Guide Lines"
              ]
            },
            "path2": {
              "name": "Invalid/No Linetype",
              "steps": [
                "Skip Guide Line drawing"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Settings Version Compatibility",
            "errorMessage": "Notice reported if MapObject version differs from Install XML version.",
            "recovery": "User typically ignores or updates MapObject manually, script continues with current loaded settings."
          },
          {
            "check": "Attribute Syntax",
            "errorMessage": "None (Script ignores invalid keys silently).",
            "recovery": "N/A - Invalid macros are skipped during string composition."
          },
          {
            "check": "Linetype Existence",
            "errorMessage": "None",
            "recovery": "Script checks `_LineTypes.find(sLineType)`. If -1 (not found), guide lines are not drawn."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties (OPM)",
            "how": "AutoCAD Properties Palette",
            "effect": "Updating 'Format', 'Color', 'Transparency', or 'LineType' triggers a script recalc, immediately updating the visual tags."
          },
          {
            "action": "Move/Modify Stacked Elements",
            "how": "Grip edits or standard CAD commands",
            "effect": "Script listens to dependencies on the stacked members. Moving the truck or beams triggers a recalc to snap tags to new positions."
          },
          {
            "action": "Context Menu / Recalc",
            "how": "Right-click Recalculate",
            "effect": "Forces a full re-evaluation of stack, grid layout, and collision detection."
          }
        ]
      },
      "tokens_used": 11049,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# f_Tag.mcr\n\n## Overview\nThis script automatically generates descriptive labels for timber elements stacked on a truck or within a package. It intelligently positions tags to identify parts during assembly planning and creates visual labels for transport load lists.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model environment. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | This is not a shop drawing detailing script. |\n\n## Prerequisites\n- **Required Entities**: `Hsb_TruckParent` (Truck) or stacked `GenBeam`/`Body` entities must exist in the model.\n- **Minimum Beam Count**: 0 (Script detects existing stacks).\n- **Required Settings**: \n    - `f_Stacking.xml` (Optional; defaults are used if not found).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `f_Tag.mcr` from the list.\n\n### Step 2: Select Target\n```\nAction: Select the Truck entity or the location of the stacked items.\nNote: The script automatically detects 'stackTruckMembers' associated with the selection.\n```\n\n### Step 3: Configuration\n```\nAction: With the script selected, open the Properties Palette (Ctrl+1) to adjust tag appearance and content.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| |Hide Linework| | dropdown | |No| | Toggles the visibility of guide lines connecting the tag to the timber element. |\n| |Color| | number | 7 | Sets the background fill color of the tag. Enter 16777214 for a near-white true color. |\n| |Transparency| | number | 1 | Controls the opacity of the tag background (0 = Solid, 90 = Highly Transparent). |\n| |LineType| | dropdown | *Continuous* | Defines the dash-dot pattern style of the guide lines (e.g., Hidden, Center). |\n| |Linetype Scale| | number | 1.0 | Scales the density of the linetype pattern (makes dashes longer or shorter). |\n| |Format| | text | @(Posnum) | Defines the text content using attribute macros (e.g., @(Posnum), @(Length)). Use backslash '\\\\' for multiple lines. |\n| |Style| | dropdown | *Standard* | Selects the Text Style (defining font and height) used for the tag text. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Forces a full re-evaluation of the stack layout, grid positions, and collision detection. |\n\n## Settings Files\n- **Filename**: `f_Stacking.xml`\n- **Location**: Searches `[Company Path]\\TSL\\Settings\\` first, then `[Install Path]\\Content\\General\\TSL\\Settings\\`\n- **Purpose**: Provides general default settings and version control. If the MapObject version differs, a notice is reported.\n\n## Tips\n- **Multi-line Tags**: To display information on multiple lines, separate your attributes in the `Format` property with a backslash (e.g., `@(Posnum)\\@(Length)`).\n- **Readability**: If your tags are hard to read over complex geometry, set `|Color|` to `16777214` (Near White) and increase `|Transparency|` to mask the background elements effectively.\n- **Placement**: The script automatically handles collision detection for \"Prime\" (main) items to prevent overlapping tags. For other items, it arranges them in a grid layout based on the truck width.\n\n## FAQ\n- **Q: Why did my guide lines disappear?**\n  **A:** Check the `|Hide Linework|` property in the Properties Palette. If it is set to `|No|`, ensure that a valid `|LineType|` is selected and loaded in your drawing.\n- **Q: How do I show the Position Number and Material on the same tag?**\n  **A:** In the `|Format|` property, enter: `@(Posnum)\\@(Material)`. The backslash forces a new line.\n- **Q: The background color isn't changing.**\n  **A:** Ensure the script style (internal logic) is set to utilize the background fill. You may need to recalculate the script after changing the color property."
      },
      "tokens_used": 6510,
      "error": null
    }
  }
}