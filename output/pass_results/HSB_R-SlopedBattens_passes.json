{
  "filename": "HSB_R-SlopedBattens.mcr",
  "status": "completed",
  "total_tokens": 45327,
  "processing_time": 434.8684718608856,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7442,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Filename 'HSB_R-SlopedBattens.mcr' lacks 'sd_' or 'Multipage' prefixes. The script constructs physical 3D entities (Beam, Sheet) and assigns them to structural Groups using code 'Z'. It utilizes standard insertion flows (_bOnInsert) with getTslInst and getEntPLine for user input. No references to _Viewport or ShopDrawing specific drawing functions (like sd*) are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst (Gutter)",
            "EntPLine"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 5114,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getTslInst",
              "promptOriginal": "|Select the gutter|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getEntPLine",
              "promptOriginal": "|Select the distribution area|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert",
            "title": "Properties",
            "dataSource": "Internal Property Declarations",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dSlopePercentage",
            "type": "PropDouble",
            "displayName": "|Slope| [%]",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Gutter|",
            "description": "|Sets the slope| [%]."
          },
          {
            "index": 3,
            "variable": "sAssignEntitiesTo",
            "type": "PropString",
            "displayName": "|Assign battens to group|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": "|Sloped battens|",
            "description": "|Sets the group to assign the entities to.|"
          },
          {
            "index": 1,
            "variable": "dWSlopedBattens",
            "type": "PropDouble",
            "displayName": "|Width sloped battens|",
            "defaultValue": "U(50)",
            "inputType": "number",
            "options": [],
            "category": "|Sloped battens|",
            "description": "|Sets the width of the battens.|"
          },
          {
            "index": 2,
            "variable": "dSpacingSlopedBattens",
            "type": "PropDouble",
            "displayName": "|Spacing sloped battens|",
            "defaultValue": "U(600)",
            "inputType": "number",
            "options": [],
            "category": "|Sloped battens|",
            "description": "|Sets the spacing of the battens.|"
          },
          {
            "index": 3,
            "variable": "dOffsetSelectedArea",
            "type": "PropDouble",
            "displayName": "|Offset from selected area|",
            "defaultValue": "U(5)",
            "inputType": "number",
            "options": [],
            "category": "|Sloped battens|",
            "description": "|Sets the offset from the selected area.|"
          },
          {
            "index": 0,
            "variable": "nColorBattens",
            "type": "PropInt",
            "displayName": "|Color battens|",
            "defaultValue": 5,
            "inputType": "number",
            "options": [],
            "category": "|Sloped battens|",
            "description": null
          },
          {
            "index": 2,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimension style|",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [],
            "category": "|Sloped battens|",
            "description": null
          },
          {
            "index": 8,
            "variable": "dTxtSize",
            "type": "PropDouble",
            "displayName": "|Text size|",
            "defaultValue": "-U(1)",
            "inputType": "number",
            "options": [],
            "category": "|Sloped battens|",
            "description": null
          },
          {
            "index": 9,
            "variable": "dTLayer1",
            "type": "PropDouble",
            "displayName": "|Thickness first sheeting layer|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Zones|",
            "description": null
          },
          {
            "index": 1,
            "variable": "nColorLayer1",
            "type": "PropInt",
            "displayName": "|Color first sheeting layer|",
            "defaultValue": 2,
            "inputType": "number",
            "options": [],
            "category": "|Zones|",
            "description": null
          },
          {
            "index": 0,
            "variable": "sMaterialLayer1",
            "type": "PropString",
            "displayName": "|Material first sheeting layer|",
            "defaultValue": "OSB",
            "inputType": "text",
            "options": [],
            "category": "|Zones|",
            "description": null
          },
          {
            "index": 10,
            "variable": "dTLayer2",
            "type": "PropDouble",
            "displayName": "|Thickness second sheeting layer|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Zones|",
            "description": null
          },
          {
            "index": 2,
            "variable": "nColorLayer2",
            "type": "PropInt",
            "displayName": "|Color second sheeting layer|",
            "defaultValue": 35,
            "inputType": "number",
            "options": [],
            "category": "|Zones|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sMaterialLayer2",
            "type": "PropString",
            "displayName": "|Material second sheeting layer|",
            "defaultValue": "Insulation",
            "inputType": "text",
            "options": [],
            "category": "|Zones|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6757,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates sloping roof battens (tapered supports) on a flat roof structure to create a fall for drainage, based on a selected gutter and distribution boundary.",
          "category": "Framing",
          "typicalUseCase": "Creating a tapered sub-structure on flat roof roofs where insulation or decking needs to be laid to a specific fall percentage towards a drainage gutter."
        },
        "parameters": [
          {
            "name": "dSlopePercentage",
            "technicalDefault": "1",
            "businessMeaning": "The required roof fall or pitch, defining how steeply the roof slopes downwards towards the gutter.",
            "validRange": "0.5 - 5.0",
            "unit": "%",
            "affectsOutput": "Calculates the height of each batten. Higher values result in greater height differences between the highest and lowest points of the battens."
          },
          {
            "name": "sAssignEntitiesTo",
            "technicalDefault": "",
            "businessMeaning": "The construction group (e.g., specific floor or phase) to which the generated battens and sheets are logically assigned.",
            "validRange": "Existing Project Groups",
            "unit": "N/A",
            "affectsOutput": "Organizes the created Beams and Sheets under the specified group in the model tree."
          },
          {
            "name": "dWSlopedBattens",
            "technicalDefault": "U(50)",
            "businessMeaning": "The width of an individual batten element perpendicular to the direction of the slope.",
            "validRange": "40 - 100",
            "unit": "mm",
            "affectsOutput": "Sets the cross-sectional width of the generated Beam entities."
          },
          {
            "name": "dSpacingSlopedBattens",
            "technicalDefault": "U(600)",
            "businessMeaning": "The center-to-center distance between adjacent battens.",
            "validRange": "400 - 1200",
            "unit": "mm",
            "affectsOutput": "Determines the quantity and density of battens generated across the roof area."
          },
          {
            "name": "dOffsetSelectedArea",
            "technicalDefault": "U(5)",
            "businessMeaning": "A clearance margin from the selected boundary polyline, ensuring battens do not overlap the edge geometry exactly.",
            "validRange": "0 - 20",
            "unit": "mm",
            "affectsOutput": "Shrinks the effective distribution area, potentially reducing the length of the outermost battens."
          },
          {
            "name": "nColorBattens",
            "technicalDefault": "5",
            "businessMeaning": "The display color used for the batten beams in the CAD model.",
            "validRange": "1 - 255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Visual representation color of the Beam entities."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The dimension style used for visualizing measurements (if applicable) or annotations.",
            "validRange": "System Dimension Styles",
            "unit": "N/A",
            "affectsOutput": "Visual style of any dimensions drawn by the script."
          },
          {
            "name": "dTxtSize",
            "technicalDefault": "-U(1)",
            "businessMeaning": "The text height for annotations or labels.",
            "validRange": "2.5 - 10.0",
            "unit": "m",
            "affectsOutput": "Size of text elements in the display."
          },
          {
            "name": "dTLayer1",
            "technicalDefault": "U(0)",
            "businessMeaning": "Thickness of the primary sheeting layer (e.g., OSB board) placed on top of the battens.",
            "validRange": "0 - 30 (0 disables layer)",
            "unit": "mm",
            "affectsOutput": "If > 0, generates a Sheet entity with this thickness, rotated to match the roof slope."
          },
          {
            "name": "nColorLayer1",
            "technicalDefault": "2",
            "businessMeaning": "Display color for the first sheeting layer.",
            "validRange": "1 - 255",
            "unit": "Index",
            "affectsOutput": "Visual representation color of the first Sheet entity."
          },
          {
            "name": "sMaterialLayer1",
            "technicalDefault": "OSB",
            "businessMeaning": "Material specification for the first sheeting layer (used for reports and rendering).",
            "validRange": "Material Library Names",
            "unit": "String",
            "affectsOutput": "Material property assignment for the first Sheet entity."
          },
          {
            "name": "dTLayer2",
            "technicalDefault": "U(0)",
            "businessMeaning": "Thickness of a secondary sheeting layer (e.g., insulation) placed on top of the first layer.",
            "validRange": "0 - 200 (0 disables layer)",
            "unit": "mm",
            "affectsOutput": "If > 0, generates a second Sheet entity stacked on top of Layer 1, rotated to match the slope."
          },
          {
            "name": "nColorLayer2",
            "technicalDefault": "35",
            "businessMeaning": "Display color for the second sheeting layer.",
            "validRange": "1 - 255",
            "unit": "Index",
            "affectsOutput": "Visual representation color of the second Sheet entity."
          },
          {
            "name": "sMaterialLayer2",
            "technicalDefault": "Insulation",
            "businessMeaning": "Material specification for the second sheeting layer.",
            "validRange": "Material Library Names",
            "unit": "String",
            "affectsOutput": "Material property assignment for the second Sheet entity."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dSlopePercentage",
            "effect": "Determines the rotation angle of the sheeting layers and the height profile of the battens.",
            "cascade": [
              "dTLayer1",
              "dTLayer2"
            ]
          },
          {
            "trigger": "dTLayer1",
            "effect": "Sets the vertical offset (Z-height) at which the second sheeting layer (Layer 2) begins.",
            "cascade": [
              "dTLayer2"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Rectangular timber beams acting as sloped battens, trimmed to fit the roof boundary, with heights varying according to the slope percentage.",
            "appliedTo": "Selected Distribution Area"
          },
          {
            "type": "Sheet",
            "description": "Planar sheeting elements (Decking/Insulation) generated on top of the battens, transformed to match the calculated roof slope.",
            "appliedTo": "Selected Distribution Area"
          }
        ]
      },
      "tokens_used": 8147,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization",
          "Check '_bOnInsert' flag",
          "[If _bOnInsert] Check insertCycleCount() > 1 (Multi-insert guard)",
          "[If insertCycleCount > 1] Erase instance and exit",
          "[If _bOnInsert] Check if _kExecuteKey exists in catalog",
          "[If Execute Key exists] Load properties from catalog",
          "[If Execute Key missing] Show 'Properties' dialog",
          "Prompt user: Select the gutter (getTslInst)",
          "Prompt user: Select the distribution area (getEntPLine)",
          "End _bOnInsert sequence",
          "Validate _Entity array has 2 elements",
          "[If Invalid Entities] Erase instance and exit",
          "Retrieve Gutter TslInst and validate validity",
          "[If Gutter Invalid] Report Error and exit",
          "Retrieve Target Group from 'sAssignEntitiesTo' property",
          "Link Script Instance and PLine to Target Group",
          "Retrieve Distribution Area (EntPLine or stored _Map data)",
          "Coordinate System Setup: Calculate CS based on Gutter direction and global Z",
          "PlaneProfile Setup: Join PLine to profile and shrink by 'dOffsetSelectedArea'",
          "Determine Start Point: Closest point on profile to Gutter Origin",
          "Vector Check: Ensure 'vxDistribution' points away from Gutter (flip if necessary)",
          "Calculation Loop Setup: Determine max length and start distribution point",
          "Cleanup: Erase existing Map entities ('SlopedBatten' and 'Sheet')",
          "Generation Loop: Iterate along slope direction until end of area",
          "[Inside Loop] Create Batten Rectangle",
          "[Inside Loop] Intersect Batten Profile with Distribution Area",
          "[Inside Loop] Calculate Batten Height based on distance and slope %",
          "[Inside Loop] Generate Beam entity for valid profile rings",
          "End Generation Loop",
          "Check 'dTLayer1' property",
          "[If dTLayer1 > 0] Calculate transform for First Sheeting Layer (Rotation + Translation)",
          "[If dTLayer1 > 0] Generate Sheet entity for First Layer",
          "Check 'dTLayer2' property",
          "[If dTLayer2 > 0] Calculate transform for Second Sheeting Layer (Stacked on First)",
          "[If dTLayer2 > 0] Generate Sheet entity for Second Layer",
          "Draw Direction Arrow visualization",
          "Script Completion"
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count > 1",
            "path1": {
              "name": "Terminate Duplicate Insert",
              "steps": [
                "Erase current script instance",
                "Return immediately"
              ]
            },
            "path2": {
              "name": "Proceed with Insertion",
              "steps": [
                "Continue to Execute Key check"
              ]
            }
          },
          {
            "condition": "Valid Execute Key Found",
            "path1": {
              "name": "Catalog Load",
              "steps": [
                "Set properties from catalog (_kExecuteKey)",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Input",
              "steps": [
                "Show Properties Dialog",
                "User inputs configuration"
              ]
            }
          },
          {
            "condition": "Source Entities Valid (Gutter & Area)",
            "path1": {
              "name": "Valid Geometry",
              "steps": [
                "Extract Gutter Vector Data",
                "Construct Coordinate Systems",
                "Generate Battens"
              ]
            },
            "path2": {
              "name": "Invalid/Missing Geometry",
              "steps": [
                "Report Error",
                "Erase Script Instance"
              ]
            }
          },
          {
            "condition": "Sheeting Layer Thickness > 0",
            "path1": {
              "name": "Generate Layer",
              "steps": [
                "Calculate Rotation (-Angle)",
                "Calculate Translation (Z-height)",
                "Create Sheet Entity"
              ]
            },
            "path2": {
              "name": "Skip Layer",
              "steps": [
                "Do not create Sheet Entity"
              ]
            }
          },
          {
            "condition": "Dot Product check (vxDistribution vs Start Point)",
            "path1": {
              "name": "Vector Alignment Correct",
              "steps": [
                "Use calculated 'vxDistribution' and 'vyDistribution'"
              ]
            },
            "path2": {
              "name": "Vector Inverted",
              "steps": [
                "Invert 'vyDistribution' (vxGutter)",
                "Recalculate 'vxDistribution'",
                "Rebuild CoordSys and Profile"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Number of selected entities (Gutter + PLine)",
            "errorMessage": "N/A (Implicit logic: _Entity.length check)",
            "recovery": "Script erases itself if entities are missing after insertion prompt."
          },
          {
            "check": "Gutter TslInst validity (bIsValid)",
            "errorMessage": "|Invalid gutter!|",
            "recovery": "User must select a valid TSL instance acting as a gutter."
          },
          {
            "check": "PLine validity (bIsValid)",
            "errorMessage": "N/A",
            "recovery": "Script attempts to read from _Map('DistributionArea') if EntPLine is invalid. If that fails, it erases itself."
          },
          {
            "check": "Group Assignment Index",
            "errorMessage": "Potential Runtime Error (Index out of bounds)",
            "recovery": "Ensure a valid Group is selected in 'sAssignEntitiesTo' dropdown that exists in 'arSFloorGroupNames'."
          },
          {
            "check": "Loop Safety Counter (nNrOfLoops > 1000)",
            "errorMessage": "N/A (Breaks loop silently)",
            "recovery": "Prevents infinite loops if spacing is too small or geometry is degenerate."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Slope Percentage",
            "how": "OPM (Object Properties Palette) - Edit 'Slope' [%]",
            "effect": "Recalculates batten heights and rotation angle of sheeting layers."
          },
          {
            "action": "Adjust Batten Width/Spacing",
            "how": "OPM - Edit 'Width sloped battens' or 'Spacing sloped battens'",
            "effect": "Regenerates beams with new cross-sections or count/density."
          },
          {
            "action": "Toggle/Resize Sheeting Layers",
            "how": "OPM - Edit 'Thickness first/second sheeting layer'",
            "effect": "Creates or deletes Sheet entities and adjusts their vertical stacking position."
          },
          {
            "action": "Change Material/Color",
            "how": "OPM - Edit 'Material/Color' properties",
            "effect": "Updates visual representation and material data reports."
          },
          {
            "action": "Move or Stretch Distribution Area",
            "how": "Grip edit the selected PLine entity",
            "effect": "Script detects dependency change, re-reads PLine shape, re-intersects batten profiles, and regenerates geometry to fit new boundary."
          },
          {
            "action": "Move Gutter",
            "how": "Grip edit or Move the Gutter TSL instance",
            "effect": "Script recalculates the start point (_Pt0) and direction vectors, redistributing battens relative to the new gutter position."
          }
        ]
      },
      "tokens_used": 9781,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-SlopedBattens.mcr\n\n## Overview\nGenerates sloping roof battens (tapered supports) on a flat roof structure to create a fall for drainage. It calculates batten heights based on a selected gutter and a distribution boundary, and can optionally generate sheeting layers like decking or insulation.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for inserting the script and viewing 3D geometry. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Gutter Entity:** An existing TSL Instance representing the gutter to which the roof must drain.\n- **Distribution Area:** A closed Polyline defining the boundary of the roof area where battens are needed.\n- **Structural Groups:** At least one structural group (e.g., a floor or phase) defined in the project to assign the entities to.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `HSB_R-SlopedBattens.mcr` from the file dialog or catalog.\n\n### Step 2: Select the Gutter\n```\nCommand Line: Select the gutter\nAction: Click on the existing gutter TSL instance in the model. This determines the low point and direction of the roof slope.\n```\n\n### Step 3: Select the Distribution Area\n```\nCommand Line: Select the distribution area\nAction: Click on the closed Polyline that represents the roof surface where the battens should be generated.\n```\n\n### Step 4: Configure Properties\nAfter selection, a Properties dialog may appear (depending on your catalog settings). You can adjust parameters such as Slope percentage, Batten Spacing, and Sheeting Thickness here or later via the Properties Palette.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Gutter** | | | |\n| Slope [%] | number | 1 | The required roof fall percentage towards the gutter. (e.g., 1.0 means a 1% fall). |\n| **Sloped battens** | | | |\n| Assign battens to group | dropdown | *Project Default* | Sets the structural group the generated beams and sheets belong to. |\n| Width sloped battens | number | 50 mm | The width of an individual batten perpendicular to the slope direction. |\n| Spacing sloped battens | number | 600 mm | The center-to-center distance between adjacent battens. |\n| Offset from selected area | number | 5 mm | A clearance margin from the selected boundary polyline. |\n| Color battens | number | 5 | The display color index for the battens. |\n| Dimension style | dropdown | _DimStyles | The dimension style used for annotations. |\n| Text size | number | -1 m | The height for text annotations. |\n| **Zones (Sheeting)** | | | |\n| Thickness first sheeting layer | number | 0 mm | Thickness of the primary decking (e.g., OSB). Set to 0 to disable. |\n| Color first sheeting layer | number | 2 | Display color for the first layer. |\n| Material first sheeting layer | text | OSB | Material name for the first layer. |\n| Thickness second sheeting layer | number | 0 mm | Thickness of the secondary layer (e.g., Insulation). Set to 0 to disable. |\n| Color second sheeting layer | number | 35 | Display color for the second layer. |\n| Material second sheeting layer | text | Insulation | Material name for the second layer. |\n\n## Right-Click Menu Options\nNo custom right-click menu options are defined for this script. Standard context options apply.\n\n## Settings Files\nNo specific external settings files are required for this script.\n\n## Tips\n- **Dynamic Updates:** If you need to adjust the roof area, simply use grip edits to stretch or move the boundary polyline. The script will automatically detect the change and regenerate the battens to fit the new shape.\n- **Adjusting Fall:** To change the steepness of the roof, select the script instance and modify the \"Slope [%]\" property in the Properties Palette.\n- **Layering:** Use the \"Zones\" properties to quickly visualize and quantify board material or insulation thickness on top of the sloped battens.\n- **Grouping:** Always ensure \"Assign battens to group\" is set correctly so the elements appear in the correct reports and views.\n\n## FAQ\n- **Q: Why didn't any battens generate?**\n  A: Check that your \"Spacing sloped battens\" is smaller than the width of your distribution area. Also, ensure the polyline is closed and the gutter instance is valid.\n\n- **Q: Can I create a flat roof with no fall?**\n  A: Yes, set the \"Slope [%]\" to 0.\n\n- **Q: How do I add insulation on top of the decking?**\n  A: Set the \"Thickness first sheeting layer\" to your decking size (e.g., 18mm) and the \"Thickness second sheeting layer\" to your insulation size (e.g., 100mm). The script will stack them correctly.\n\n- **Q: The battens are running the wrong way.**\n  A: The script calculates direction based on the Gutter. Ensure you selected the correct Gutter entity relative to the distribution area."
      },
      "tokens_used": 8086,
      "error": null
    }
  }
}