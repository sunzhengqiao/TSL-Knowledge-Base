{
  "filename": "hsbLayoutTag.mcr",
  "status": "completed",
  "total_tokens": 56157,
  "processing_time": 365.0665662288666,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.9",
            "date": "13dec2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "property 'decimals' has been removed: the digits can be controlled via the RLxx flag of the format, see property description "
          },
          {
            "version": "1.8",
            "date": "08nov2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix "
          },
          {
            "version": "1.7",
            "date": "08nov2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "property sets supported "
          },
          {
            "version": "1.6",
            "date": "08nov2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "new context command to add panels, format description enhanced "
          },
          {
            "version": "1.5",
            "date": "13aug2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "new context command to add tsls "
          },
          {
            "version": "1.4",
            "date": "04jul2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "default selection method on double click changed to beams "
          },
          {
            "version": "1.3",
            "date": "05jun2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "decimal places fixed "
          },
          {
            "version": "1.2",
            "date": "30apr2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "new selection commands to filter beams or sheets "
          },
          {
            "version": "1.1",
            "date": "30apr2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix double detection "
          },
          {
            "version": "1.0",
            "date": "26apr2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial "
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9013,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly prompts for a Viewport using getViewport(). Contains prompts to pick points in paperspace and uses Viewport().switchToModelSpace() / switchToPaperSpace(). Script summary states: 'creates collsion free tags in paperspace, looking to modelspace entities.'"
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "ModelSpace Entity (Beam/Panel/Sheet)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout) containing a Viewport linked to Model Space.",
          "requiredSettings": []
        }
      },
      "tokens_used": 7582,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Pick a point outside of paperspace|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getString",
              "promptOriginal": "|Specify zones seperated by a semicolon, <Enter> to select from all zones|",
              "condition": "Context: |Select Sheets|",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertyDialog",
            "trigger": "On Insert (unless executed via key)",
            "title": "Instance Properties",
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "SelectFromList",
            "trigger": "Context Menu: |Set Format...|",
            "title": null,
            "dataSource": "Entity properties extracted from ModelSpace entities",
            "features": {
              "searchable": true,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sAttribute",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(Posnum) @(SolidLength)",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the format of the composed value.|\n|Samples|\n   @(Label)@(SubLabel)\n   @(Label:L2) |the first two characters of Label|\n   @(Label:T1; |the second part of Label if value is separated by blanks, i.e. 'EG AW 2' will return AW'|)\n   @(Width:RL1) |the rounded value of width with one decimal.|\nR |Right: Takes the specified number of characters from the right of the string.|\nL |Left: Takes the specified number of characters from the left of the string.|\nS |SubString: Given one number will take all characters starting at the position (zero based).|\n |Given two numbers will start at the first number and take the second number of characters.|\nT |​Tokeniser: Returns the member of a delimited list using the specified index (zero based). A delimiter can be specified as an optional parameter with the default delimiter being the semcolon character..|\n# |Rounds a number. Specify the number of decimals to round to. Trailing zero's are removed.|\nRL |​Round Local: Rounds a number using the local regional settings..|"
          },
          {
            "index": 1,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": "_DimStyles.sorted()",
            "inputType": "dropdown",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Dimstyle|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Text Height| |0 = byDimstyle|"
          },
          {
            "index": 2,
            "variable": "sOrientation",
            "type": "PropString",
            "displayName": "|Orientation|",
            "defaultValue": "|byEntity|",
            "inputType": "dropdown",
            "options": [
              "|byEntity|",
              "|Horizontal|",
              "|Vertical|"
            ],
            "category": "|Display|",
            "description": "|Defines the Orientation|"
          },
          {
            "index": 3,
            "variable": "sStyle",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "|Text only|",
            "inputType": "dropdown",
            "options": [
              "|Text only|",
              "|Text + Leader|",
              "|Border|",
              "|Border+Leader|",
              "|Filled Frame|",
              "|Filled Frame+Leader|"
            ],
            "category": "|Display|",
            "description": "|Defines the Style|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Add Viewport|",
            "handler": "|Add Viewport|",
            "action": "Prompts user to select a viewport and appends it to the instance.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Select Entities|",
            "handler": "|Select Entities|",
            "action": "Switches to ModelSpace and prompts to select generic entities.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Select Beam(s)|",
            "handler": "|Select Beam(s)|",
            "action": "Switches to ModelSpace and prompts to select Beams.",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "|Select Panel(s)|",
            "handler": "|Select Panel(s)|",
            "action": "Switches to ModelSpace and prompts to select Panels (Sip entities).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Select Sheets|",
            "handler": "|Select Sheets|",
            "action": "Prompts for zones, switches to ModelSpace, and selects Sheets filtered by zone.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Select TSL's|",
            "handler": "|Select TSL's|",
            "action": "Switches to ModelSpace and prompts to select TSL instances (Element entities).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove selection|",
            "handler": "|Remove selection|",
            "action": "Clears the list of selected entities.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clear Shadow|",
            "handler": "|Clear Shadow|",
            "action": "Clears the collision detection shadow area.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Set Format...|",
            "handler": "|Set Format...|",
            "action": "Opens a searchable list of available entity properties to insert into the Format string.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9343,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates collision-free labels in PaperSpace that display specific properties (like dimensions, marks, or codes) of selected ModelSpace structural elements.",
          "category": "ShopDrawing",
          "typicalUseCase": "Creating a clean, automated bill of materials or part list view on a drawing layout where beams and panels are tagged with their length, position number, or other attributes without overlapping other drawing details."
        },
        "parameters": [
          {
            "name": "sAttribute",
            "technicalDefault": "@(Posnum) @(SolidLength)",
            "businessMeaning": "Defines exactly what data is written on the label. It uses a syntax to pull properties (like width, height, label, or position number) from the linked model entity and format them (e.g., adding units, rounding decimals).",
            "validRange": "Any string combining text and valid property tokens (e.g., @(Width), @(Label)). Supports formatting flags like :L2 (Left 2 chars) or :RL1 (Round Local 1 decimal).",
            "unit": "Text String",
            "affectsOutput": "Directly changes the text content displayed in the tag. Incorrect tokens result in empty or error text."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles.sorted() (System Default)",
            "businessMeaning": "Selects the CAD Dimension Style to control the font, color, and layer standards for the tag, ensuring it matches the rest of the drawing's annotation standards.",
            "validRange": "Any existing Dimension Style name available in the current CAD project.",
            "unit": "N/A (String Selection)",
            "affectsOutput": "Alters the font, color, and layer properties of the text and lines generated by the script."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Sets the specific size of the text. A value of 0 inherits the height from the selected Dimension Style; otherwise, it overrides it.",
            "validRange": "0 to ~10 mm (Plot scale dependent). Typical values are 2.5 mm, 3.0 mm, or 3.5 mm for standard architectural drawings.",
            "unit": "mm",
            "affectsOutput": "Scales the text size up or down. Larger text sizes will result in larger border/background frames to fit the content."
          },
          {
            "name": "sOrientation",
            "technicalDefault": "byEntity",
            "businessMeaning": "Controls the rotation of the label. It can align with the geometry of the tagged element (useful for walls/beams), or force a standard Horizontal/Vertical orientation for easier reading.",
            "validRange": "byEntity, Horizontal, Vertical",
            "unit": "N/A (Enumeration)",
            "affectsOutput": "Rotates the tag geometry (text, border, leader) relative to the PaperSpace coordinate system."
          },
          {
            "name": "sStyle",
            "technicalDefault": "Text only",
            "businessMeaning": "Determines the visual presentation of the tag, ranging from simple floating text to text enclosed in a box or filled frame, with or without a leader line pointing to the object.",
            "validRange": "Text only, Text + Leader, Border, Border+Leader, Filled Frame, Filled Frame+Leader",
            "unit": "N/A (Enumeration)",
            "affectsOutput": "Adds or removes graphical geometry (polylines for borders, hatches for fills, polylines for leaders) around the text."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight = 0",
            "effect": "The visual text height is controlled by the settings defined in sDimStyle instead of the script property.",
            "cascade": [
              "sDimStyle"
            ]
          },
          {
            "trigger": "sStyle includes 'Border' or 'Filled Frame'",
            "effect": "The size of the graphical frame automatically adjusts to fit the text generated by sAttribute and the size defined by dTextHeight.",
            "cascade": [
              "sAttribute",
              "dTextHeight"
            ]
          },
          {
            "trigger": "sStyle includes 'Leader'",
            "effect": "The script attempts to place the tag near the entity and draw a connecting line. The success of this placement depends on the 'collision detection' logic finding empty space.",
            "cascade": [
              "sOrientation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text/PLine/Region",
            "description": "Annotation geometry created in PaperSpace. This includes the text string, optional border polylines, optional filled regions (hatches), and optional leader lines connecting the label to the viewport location of the model entity.",
            "appliedTo": "PaperSpace (referencing ModelSpace entities via Viewport)"
          }
        ]
      },
      "tokens_used": 9426,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Launch Script (hsbLayoutTag)\",\n    \"2. Check for Execute Key (Catalog entry)\",\n    \"3. [Conditional] Show Property Dialog (if no key)\",\n    \"4. Prompt User to Select a Viewport in PaperSpace\",\n    \"5. Prompt User to Pick an Origin Point in PaperSpace\",\n    \"6. Initialize Instance and Store Viewport\",\n    \"7. Display Initial Status Text (Instructions)\",\n    \"8. [User Interaction] Select ModelSpace Entities via Double Click or Context Menu\",\n    \"9. Switch Space to ModelSpace\",\n    \"10. Select Entities (Beams/Panels/Sheets/TSLs)\",\n    \"11. Switch Space back to PaperSpace\",\n    \"12. Loop Execution (Recalculate)\",\n    \"13. Process Each Entity: Project Point, Format Text, Generate Geometry\",\n    \"14. Check Collision with Existing Tags/Shadows\",\n    \"15. [Conditional] Adjust Position if Collision Detected\",\n    \"16. Draw Final Tag (Text/Border/Leader)\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Script Insertion Start\",\n      \"path1\": {\n        \"name\": \"Catalog Execution\",\n        \"steps\": [\n          \"Check _kExecuteKey\",\n          \"Load Properties from Catalog Entry\",\n          \"Skip Property Dialog\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Standard Execution\",\n        \"steps\": [\n          \"Check _kExecuteKey (Empty)\",\n          \"Show Property Dialog\",\n          \"User confirms settings\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Viewport Status Check\",\n      \"path1\": {\n        \"name\": \"Viewport Missing\",\n        \"steps\": [\n          \"Detect _Viewport.length() == 0\",\n          \"Draw Error Message: 'please add a viewport'\",\n          \"Enable 'Add Viewport' Trigger\",\n          \"Wait for User Input\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Viewport Present\",\n        \"steps\": [\n          \"Load Last Viewport from Array\",\n          \"Proceed to Entity Processing\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Entity Selection Method\",\n      \"path1\": {\n        \"name\": \"Select Sheets\",\n        \"steps\": [\n          \"Prompt for Zone String (semicolon separated)\",\n          \"Parse and Validate Zones (-5 to 5)\",\n          \"Switch to ModelSpace\",\n          \"Select Sheets\",\n          \"Filter Sheets by Zone\",\n          \"Switch to PaperSpace\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Standard Selection (Beams/Panels/Entities/TSLs)\",\n        \"steps\": [\n          \"Switch to ModelSpace\",\n          \"Prompt for Specific Entity Type\",\n          \"Switch to PaperSpace\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Collision Detection Loop\",\n      \"path1\": {\n        \"name\": \"Collision Detected\",\n        \"steps\": [\n          \"Calculate Overlap Area (dArea)\",\n          \"While (Area > Epsilon && Count < 160)\",\n          \"Calculate Offset Vector\",\n          \"Transform Tag Position\",\n          \"Re-check Area\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Free Space Found\",\n        \"steps\": [\n          \"Join Boundary to Shadow Profile\",\n          \"Draw Tag (Text, Border, Fill)\",\n          \"Draw Leader (if enabled and applicable)\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Viewport Existence\",\n      \"errorMessage\": \"Script Name: 'please add a viewport'\",\n      \"recovery\": \"User must right-click and select 'Add Viewport' or Double Click (if mapped) to select a viewport.\"\n    },\n    {\n      \"check\": \"Zone Index Range (Sheets)\",\n      \"errorMessage\": \"Implicitly ignored\",\n      \"recovery\": \"Script filters zone inputs to be between -5 and 5 (excluding 0). Invalid inputs are silently skipped during tokenization.\"\n    }\n  ],\n  \"postInsertionActions\": [\n    {\n      \"action\": \"Add Viewport\",\n      \"how\": \"Context Menu (Right-click)\",\n      \"effect\": \"Prompts user to select a viewport and appends it to the script instance.\"\n    },\n    {\n      \"action\": \"Select Beam(s)\",\n      \"how\": \"Context Menu / Double Click\",\n      \"effect\": \"Switches to ModelSpace, appends selected Beams to the list, and updates tags.\"\n    },\n    {\n      \"action\": \"Select Panel(s)\",\n      \"how\": \"Context Menu\",\n      \"effect\": \"Switches to ModelSpace, appends selected Panels (Sip entities), and updates tags.\"\n    },\n    {\n      \"action\": \"Select Sheets\",\n      \"how\": \"Context Menu\",\n      \"effect\": \"Prompts for zones, switches to ModelSpace, appends selected Sheets filtered by zone, and updates tags.\"\n    },\n    {\n      \"action\": \"Select TSL's\",\n      \"how\": \"Context Menu\",\n      \"effect\": \"Switches to ModelSpace, appends selected TSL instances (Element entities), and updates tags.\"\n    },\n    {\n      \"action\": \"Remove Selection\",\n      \"how\": \""
      },
      "tokens_used": 12604,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbLayoutTag.mcr\n\n## Overview\nThis script creates collision-free tags and labels in PaperSpace that display properties of structural elements located in ModelSpace (such as beams, panels, and sheets). It automatically calculates label positions to avoid overlapping existing drawing details.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Partial | The script reads entities from ModelSpace but is inserted and managed in PaperSpace. |\n| Paper Space | Yes | The script must be inserted on a Layout containing a Viewport. |\n| Shop Drawing | Yes | Intended for creating part lists and dimension tags on production drawings. |\n\n## Prerequisites\n- **Required Entities**: A Viewport existing in the current PaperSpace Layout.\n- **Minimum Beam Count**: 0 (can be used with Panels, Sheets, or generic entities).\n- **Required Settings**: None required.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbLayoutTag.mcr` from the list.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select a viewport\nAction: Click on the viewport frame in the layout that displays the model elements you want to tag.\n```\n\n### Step 3: Pick Origin Point\n```\nCommand Line: Pick a point outside of paperspace\nAction: Click a location in the PaperSpace to define the script's origin/insertion point.\n```\n\n### Step 4: Select Entities to Tag\nAfter insertion, the script waits for you to define what to label.\n```\nAction: Right-click the script instance and navigate to \"Select...\" options (e.g., Select Beam(s), Select Panel(s)).\nThe script will temporarily switch to ModelSpace. Select your entities and press Enter.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Format** | Text | `@(Posnum) @(SolidLength)` | Defines the text displayed on the tag. Use tokens like `@(Width)`, `@(Length)`, or `@(Label)` to pull entity properties. Flags like `:RL1` can be added to round numbers (e.g., `@(Width:RL1)` for 1 decimal). |\n| **Dimstyle** | Dropdown | `_DimStyles.sorted()` | Selects the CAD Dimension Style to control font, color, and layer settings for the tag. |\n| **Text Height** | Number | `0` | Sets the height of the text. A value of `0` uses the height defined in the selected Dimstyle. |\n| **Orientation** | Dropdown | `byEntity` | Controls the rotation of the tag. <br>• `byEntity`: Rotates to match the element's angle.<br>• `Horizontal`: Forces horizontal alignment.<br>• `Vertical`: Forces vertical alignment. |\n| **Style** | Dropdown | `Text only` | Determines the visual appearance of the tag. Options include: `Text only`, `Text + Leader`, `Border`, `Border+Leader`, `Filled Frame`, or `Filled Frame+Leader`. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Add Viewport** | Allows you to link an additional viewport to the script instance if one was missed during insertion. |\n| **Select Entities** | Switches to ModelSpace to select any generic entities (Lines, Arcs, etc.). |\n| **Select Beam(s)** | Switches to ModelSpace to select structural beams. (Also triggered by double-clicking the script). |\n| **Select Panel(s)** | Switches to ModelSpace to select structural panels (Sip entities). |\n| **Select Sheets** | Prompts for a zone string (e.g., \"1;2\"), switches to ModelSpace, and selects sheets matching those zones. |\n| **Select TSL's** | Switches to ModelSpace to select other TSL script instances (Element entities). |\n| **Remove selection** | Clears all currently selected entities from the script. |\n| **Clear Shadow** | Clears the internal \"collision map,\" allowing tags to be placed in areas that were previously occupied. |\n| **Set Format...** | Opens a searchable list of available entity properties to help build the Format string correctly. |\n\n## Settings Files\n- **Filename**: None used by this script.\n\n## Tips\n- **Finding Properties**: If you don't know the exact name of a property (e.g., is it `Length` or `SolidLength`?), use the **Set Format...** context menu option. It lists all available properties for the selected element type.\n- **Collision Detection**: If tags appear far away or seem \"stuck,\" try using the **Clear Shadow** command. This resets the area the script considers \"occupied.\"\n- **Standard Text**: Set **Text Height** to `0` and define the size in your **Dimstyle** to ensure all annotations in your drawing update consistently when styles change.\n\n## FAQ\n- **Q: Can I tag walls and panels at the same time?**\n  - A: No, you must run the specific context command for each type (e.g., run \"Select Beam(s)\" for walls, then \"Select Panel(s)\" for panels) one after another. The script will combine them into the layout.\n- **Q: My tags are overlapping each other.**\n  - A: The script tries to avoid collisions, but if you manually move the script instance or drastically change text sizes, overlaps might occur. Use **Clear Shadow** and trigger a recalculation (save/reload or toggle a property) to force a re-layout.\n- **Q: What does the \"RL1\" flag do in the Format?**\n  - A: It rounds the number to 1 decimal place according to your local Windows settings (e.g., a length of 1200.45 becomes 1200.5 or 1200,5 depending on region)."
      },
      "tokens_used": 8189,
      "error": null
    }
  }
}