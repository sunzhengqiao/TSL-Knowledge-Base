{
  "filename": "GE_PLOT_ELEMENT_BOM.mcr",
  "status": "completed",
  "total_tokens": 43619,
  "processing_time": 2024.9375925064087,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "11.mar.2013",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "Copied from hsb_ElementBOM, to keep US content folder naming standards"
          },
          {
            "version": "1.19",
            "date": "11.mar.2013",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "Version control from 1.0 to 1.19, to keep updated with hsb_ElementBOM"
          },
          {
            "version": "1.20",
            "date": "14.mar.2013",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "Prop. \"Show Angle Column\" (yes/no) added\n- Bugfix when displaying real sizes instead of nominal for US market"
          },
          {
            "version": "1.21",
            "date": "07.apr.2013",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "Prop. \"Using Defaults Editor\" (yes/no) added\n- If \"Using Defaults editor\" beam material and grade will be taken from 1st. and 2nd. token from grade prop on beam"
          },
          {
            "version": "1.22",
            "date": "20.may.2013",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "All strings are to be translated (all except those for map use)"
          },
          {
            "version": "1.23",
            "date": "13.ene.2014",
            "author": "David Rueda (dr@hsb-cad.com)",
            "changes": "Classification groups added:\n- Sill\n- Very Top Plate\n- Jacks\n- Header (renamed from lintel)"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9028,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "PropString sSpace allows selection between 'paper space' and 'shopdraw multipage'. Script logic includes explicit handling for Viewport (Paper Space) using getViewport and ShopDrawView (Shopdrawing) using getShopDrawView. It uses CoordSys transformations (ms2ps, ps2ms) to map model space geometry to 2D drawing spaces."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Viewport",
            "ShopDrawView"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires a Layout with a Viewport linked to a hsb Element (for Paper Space) OR a Shopdrawing View linked to an Element (for Shopdraw Space).",
          "requiredSettings": []
        }
      },
      "tokens_used": 6342,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"|Pick a point to show the table|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getViewport\",\n        \"promptOriginal\": \"|Select the viewport from which the element is taken|\",\n        \"condition\": \"_bOnInsert && sSpace == '|paper space|'\",\n        \"required\": true\n      },\n      {\n        \"step\": 4,\n        \"function\": \"getShopDrawView\",\n        \"promptOriginal\": \"|Select the view entity from which the module is taken|\",\n        \"condition\": \"_bOnInsert && sSpace == '|shopdraw multipage|'\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 2,\n      \"variable\": \"sSpace\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Drawing space|\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|paper space|\",\n        \"|shopdraw multipage|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 17,\n      \"variable\": \"sUsingDefaultsEditor\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Using Defaults Editor|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Dim Style|\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"|Color|\",\n      \"defaultValue\": 3,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"strMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Materials to exclude from the BOM|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Please fill the materials that you don't need to list on the BOM, use| ; |as separator if you want to filter more that 1 material|\"\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sCompAngle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Switch to Complementary Angle|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sDoSheets\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Show Sheets in the BOM|\",\n      \"defaultValue\": \"|Yes|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"sDoBeams\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Show Beams in the BOM|\",\n      \"defaultValue\": \"|Yes|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 13,\n      \"variable\": \"sDoSIPs\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Show SIPs in the BOM|\",\n      \"defaultValue\": \"|Yes|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category"
      },
      "tokens_used": 10709,
      "error": null
    },
    "4": {
      "success": false,
      "data": {},
      "tokens_used": 0,
      "error": "Request timeout after retries"
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Execute Script Insertion",
          "2. Display Configuration Dialog (showDialog)",
          "3. Prompt user for table insertion point (getPoint)",
          "4. Branch: Check 'Drawing space' Property (sSpace)",
          "5. [Paper Space] Select Viewport (getViewport)",
          "6. [Shopdraw Space] Select View Entity (getShopDrawView)",
          "7. Initialize Display (dp) and Parse Material Exclusions",
          "8. Retrieve linked Entity (Viewport or ShopDrawView) from script storage",
          "9. Validate linked Entity (exists and contains valid hsb data)",
          "10. Extract Element and Coordinate Systems (ms2ps, ps2ms)",
          "11. Validate Element extracted",
          "12. Set Property 'sSpace' to Read-Only",
          "13. Determine Element Construction Type (Wall, Floor, SIP, Roof)",
          "14. Collect and Filter Entities (Beams, Sheets, Trusses) based on OPM settings",
          "15. Process Data: Group by dimensions/material, Calculate Counts",
          "16. Draw BOM Table Headers and Data Rows",
          "17. Calculate and Draw Position Numbers with collision avoidance"
        ],
        "conditionalBranches": [
          {
            "condition": "User selection for 'Drawing space' (sSpace)",
            "path1": {
              "name": "Paper Space",
              "steps": [
                "Prompt user to select a Viewport",
                "Verify Viewport contains valid Element",
                "Use Viewport Coordinate System for transformation"
              ]
            },
            "path2": {
              "name": "Shopdraw Multipage",
              "steps": [
                "Prompt user to select a ShopDrawView Entity",
                "Map ViewData from internal Map",
                "Extract Element from View Data",
                "Use View Data Coordinate System for transformation"
              ]
            }
          },
          {
            "condition": "Element Construction Type (Geometry)",
            "path1": {
              "name": "Roof / Floor",
              "steps": [
                "Cast Element to ElementRoof",
                "Set internal flag nFloor = true",
                "Use Roof specific beam types/mappings"
              ]
            },
            "path2": {
              "name": "Wall (SF)",
              "steps": [
                "Cast Element to ElementWallSF",
                "Set internal flag nWall = true",
                "Use Wall specific beam types (studs, plates, headers)"
              ]
            },
            "path3": {
              "name": "SIP",
              "steps": [
                "Cast Element to ElementWall or ElementSip",
                "Set internal flag nSip = true or nSipRoof = true",
                "Use specific SIP mappings"
              ]
            }
          },
          {
            "condition": "Truss Dimensions Processing",
            "path1": {
              "name": "Height > Width",
              "steps": [
                "Standard Mapping: Width remains Width, Height remains Height"
              ]
            },
            "path2": {
              "name": "Width > Height (Swap)",
              "steps": [
                "Swap values: Truss Width becomes Truss Height",
                "Truss Height becomes Truss Width"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Array Integrity",
            "errorMessage": "None (Script exits)",
            "recovery": "Script runs eraseInstance() and returns. User must re-insert or ensure link integrity."
          },
          {
            "check": "Viewport hsb Data",
            "errorMessage": "None (Script exits)",
            "recovery": "Script returns without drawing if !vp.element().bIsValid(). User must select a viewport with a valid hsb Element."
          },
          {
            "check": "ShopDrawView Validity",
            "errorMessage": "None (Script exits)",
            "recovery": "Script returns if !sv.bIsValid()."
          },
          {
            "check": "ViewData Mapping",
            "errorMessage": "None (Script exits)",
            "recovery": "Script returns if nIndFound < 0 (no matching data found in map)."
          },
          {
            "check": "Element Validity",
            "errorMessage": "None (Script exits)",
            "recovery": "Script returns if !el.bIsValid() after attempting extraction."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify OPM Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'Show Beams', 'Show Sheets', 'Materials to exclude', 'Dim Style', or 'Color' triggers a recalculation, instantly redrawing the BOM table and Posnums."
          },
          {
            "action": "Move Script Entity",
            "how": "Grip Edit / Move Command",
            "effect": "The BOM table and all associated Position Numbers move relative to the insertion point (_Pt0) in the drawing space."
          },
          {
            "action": "Delete Source Entity",
            "how": "Standard AutoCAD Erase",
            "effect": "If the linked Viewport or Element is deleted, the script detects invalid data during the next recalculation and erases itself (eraseInstance)."
          }
        ]
      },
      "tokens_used": 10519,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# GE_PLOT_ELEMENT_BOM.mcr\n\n## Overview\nThis script generates a Bill of Materials (BOM) table and places position numbers for hsbCAD Elements. It supports both Paper Space (via Viewports) and Shop Drawings (via ShopDrawViews), automatically categorizing beams and sheets based on the element type (Wall, Floor, Roof, or SIP).\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed for detailing output. |\n| Paper Space | Yes | Select a Viewport linked to an hsb Element. |\n| Shop Drawing | Yes | Select a ShopDrawView entity. |\n\n## Prerequisites\n- **Required Entities**: An existing Layout with a Viewport linked to an hsb Element OR a Shopdrawing containing a ShopDrawView linked to an Element.\n- **Minimum Beam Count**: 0 (Processes any valid element).\n- **Required Settings**: None specific.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `GE_PLOT_ELEMENT_BOM.mcr`\n\n### Step 2: Configure Options\nA dialog will appear upon insertion. Set the **Drawing space** property to either:\n- **paper space**: If you are working on a 2D layout with a viewport.\n- **shopdraw multipage**: If you are working within the hsbCAM/Shopdrawing environment.\n\n### Step 3: Pick Insertion Point\n```\nCommand Line: Pick a point to show the table\nAction: Click in the drawing where you want the top-left corner of the BOM table to be placed.\n```\n\n### Step 4: Select Source View\nDepending on your selection in Step 2:\n- **If Paper Space**:\n  ```\n  Command Line: Select the viewport from which the element is taken\n  Action: Click on the border of the viewport displaying the element.\n  ```\n- **If Shopdraw Multipage**:\n  ```\n  Command Line: Select the view entity from which the module is taken\n  Action: Click on the ShopDrawView frame of the element.\n  ```\n\n### Step 5: Automatic Generation\nThe script will automatically generate the table and position numbers based on the default properties.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Drawing space | Dropdown | paper space | Choose between 'paper space' or 'shopdraw multipage'. |\n| Using Defaults Editor | Dropdown | No | If Yes, material and grade are parsed from tokens in the grade property on the beam. |\n| Dim Style | Dropdown | *Current* | Select the dimension style to use for the table text. |\n| Color | Number | 3 | Sets the AutoCAD color index (e.g., 3 = Green) for the table entities. |\n| Materials to exclude from the BOM | Text | (Empty) | List materials to hide in the BOM. Use a semicolon (;) as a separator (e.g., \"M12;Nail\"). |\n| Switch to Complementary Angle | Dropdown | No | Toggles the display of angles to their complementary value. |\n| Show Sheets in the BOM | Dropdown | Yes | Toggles the visibility of sheet/panel materials in the table. |\n| Show Beams in the BOM | Dropdown | Yes | Toggles the visibility of timber beams in the table. |\n| Show SIPs in the BOM | Dropdown | Yes | Toggles the visibility of Structural Insulated Panels in the table. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the Properties Palette to configure BOM filters and visual styles. |\n| Recalculate | Manually refreshes the BOM if automatic updates are disabled. |\n| Erase | Removes the script instance and all generated geometry from the drawing. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script uses internal logic and standard Element properties; no external XML settings file is required.\n\n## Tips\n- **Filtering Materials**: To exclude fasteners or small hardware from the BOM, type their material names into the \"Materials to exclude\" property separated by semicolons (e.g., `Steel;Connector`).\n- **Moving the Table**: Select the script insertion point (usually the top-left of the table) and use the AutoCAD `MOVE` command. The table and position numbers will move together.\n- **Updating the BOM**: Simply change a property in the Properties Palette (e.g., toggle \"Show Beams\") to force an immediate redraw of the table without re-inserting the script.\n- **Classification**: The script automatically detects if the element is a Wall, Floor, or Roof and adjusts the content columns (e.g., showing \"Studs\" for walls or \"Rafters\" for roofs) accordingly.\n\n## FAQ\n- **Q: Why did the BOM table disappear?**\n  **A:** The script is linked to a specific Viewport or ShopDrawView. If you delete that source entity, the script detects this and erases itself to prevent errors.\n- **Q: Can I use this script in Model Space?**\n  **A:** No, this script is specifically designed for detailing in Paper Space or Shop Drawings to ensure correct 2D representation.\n- **Q: How do I change the table text size?**\n  **A:** The text size is controlled by the selected \"Dim Style\". Change the `Dim Style` property to a style with your preferred text height."
      },
      "tokens_used": 7021,
      "error": null
    }
  }
}