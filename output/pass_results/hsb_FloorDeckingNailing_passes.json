{
  "filename": "hsb_FloorDeckingNailing.mcr",
  "status": "completed",
  "total_tokens": 37277,
  "processing_time": 1035.7259769439697,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "11.10.2012",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "Release Version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4475,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses PrEntity to select ElementRoof objects and operates on 3D construction data. It accesses Beams and Sheets using el.beam() and el.sheet(), calculates 3D segments using NailLine().calculateAllowedNailLineSegments(), and creates NailLine database objects. It concludes with eraseInstance(), indicating it is a utility script for generating manufacturing data in the model rather than creating 2D shop drawings."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 4369,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && _kExecuteKey == \"\"",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Select one or More Elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "_bOnInsert && _kExecuteKey == \"\"",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZones",
            "type": "PropInt",
            "displayName": "Zone to be Nail",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nToolingIndex",
            "type": "PropInt",
            "displayName": "   Nailing Tool index",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dSpacing",
            "type": "PropDouble",
            "displayName": "   Maximum nailing spacing",
            "defaultValue": 200,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dDistEdge",
            "type": "PropDouble",
            "displayName": "   Distance from beam edge",
            "defaultValue": 9,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "This value is the distance between the end of the nail line to the end of the beam"
          },
          {
            "index": 1,
            "variable": "strMaterialZone",
            "type": "PropString",
            "displayName": "   Zone Material to be Nailed",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "If any Material name is set here then only that material is going to be use to apply the nailing"
          },
          {
            "index": 2,
            "variable": "strMaterialBeams",
            "type": "PropString",
            "displayName": "   Material beams to avoid",
            "defaultValue": "CLS;",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "If any Material name is set here then only that material is going to be use to apply the nailing"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7143,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the generation of nailing patterns (NailLines) for floor or roof decking elements, calculating precise nail locations, spacing, and tool assignments for manufacturing or shop drawings.\",\n    \"category\": \"Manufacturing/CAM\",\n    \"typicalUseCase\": \"Used during the detailing phase to generate data for CNC nailing machines or to produce graphical representations of nailing schedules on structural floor/roof panels.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"nZones\",\n      \"technicalDefault\": \"1\",\n      \"businessMeaning\": \"Selects the specific construction layer (Zone) of the roof or floor element to nail. Options 1-5 usually correspond to layers on one side (e.g., top structural deck), while 6-10 correspond to the opposite side (e.g., bottom ceiling layer).\",\n      \"validRange\": \"1 to 10\",\n      \"unit\": \"count\",\n      \"affectsOutput\": \"Determines which set of sheets within the element are selected to receive nail lines.\"\n    },\n    {\n      \"name\": \"nToolingIndex\",\n      \"technicalDefault\": \"1\",\n      \"businessMeaning\": \"Specifies the identifier for the nail gun or specific nail configuration to be used. This links the nailing instruction to a specific setup in the manufacturing machine database and controls the display color in the model.\",\n      \"validRange\": \"Positive integers (typically 1-10)\",\n      \"unit\": \"index\",\n      \"affectsOutput\": \"Sets the tooling code in the output data and the graphical color of the generated nail lines.\"\n    },\n    {\n      \"name\": \"dSpacing\",\n      \"technicalDefault\": \"200\",\n      \"businessMeaning\": \"The maximum allowable distance between nails along the nailing line.\",\n      \"validRange\": \"100mm - 600mm (Standard structural nailing is often 150mm-300mm)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Controls the frequency/density of the nails; increasing the value reduces the total number of nails generated.\"\n    },\n    {\n      \"name\": \"dDistEdge\",\n      \"technicalDefault\": \"9\",\n      \"businessMeaning\": \"The required setback distance from the edge of the supporting beam or sheet intersection. It ensures nails are not placed too close to the end of the timber to prevent splitting.\",\n      \"validRange\": \"5mm - 50mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Shortens the start and end points of the calculated nail lines, creating nail-free borders at beam ends and sheet edges.\"\n    },\n    {\n      \"name\": \"strMaterialZone\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Filter that restricts nailing to sheets of a specific material name (e.g., 'OSB', 'PLYWOOD'). Only sheets matching this name will be processed.\",\n      \"validRange\": \"String name matching the catalog material\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"If set, prevents nailing on sheets of different materials found within the selected zone.\"\n    },\n    {\n      \"name\": \"strMaterialBeams\",\n      \"technicalDefault\": \"\\\"CLS;\\\"\",\n      \"businessMeaning\": \"A list of beam materials to explicitly exclude from nailing. Beams matching these names (e.g., 'CLS' for softwood trimmers) will be skipped during calculation.\",\n      \"validRange\": \"Semicolon-separated list of material names (e.g., 'CLS;MDF;')\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"Removes potential nailing targets from the calculation, preventing nail lines from being drawn over specific beams.\"\n    }\n "
      },
      "tokens_used": 7795,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Set units (mm) and sequence number.",
          "2. Define Properties: nZones, nToolingIndex, dSpacing, dDistEdge, strMaterialZone, strMaterialBeams.",
          "3. Check Context: Is the script running on Insert (_bOnInsert)?",
          "4. [Yes - Insert Flow] Check insertCycleCount(). If > 1, eraseInstance() and exit (prevents recursion).",
          "5. [Yes - Insert Flow] Check _kExecuteKey. If empty, launch OPM Dialog (showDialog()).",
          "6. [Yes - Insert Flow] Prompt user to select ElementRoof entities (PrEntity).",
          "7. [Yes - Insert Flow] Iterate through selected elements.",
          "8. [Yes - Insert Flow] For each element, spawn a new instance (dbCreate) attached to that entity, passing current property values.",
          "9. [Yes - Insert Flow] Erase the initial 'commander' instance (eraseInstance) and return.",
          "10. [No - Calculation Flow] Check if running on DbCreated (_bOnDbCreated). Set properties from catalog if true.",
          "11. [Calculation Flow] Validate Element. If empty or invalid, eraseInstance and return.",
          "12. [Calculation Flow] Map User Zone (1-10) to Internal Zone (1-5 or -1 to -5).",
          "13. [Calculation Flow] Parse 'strMaterialBeams' into an array of excluded materials.",
          "14. [Calculation Flow] Cleanup: Find and erase other instances of this script on the element.",
          "15. [Calculation Flow] Cleanup: Find and erase existing NailLines matching the nToolingIndex.",
          "16. [Calculation Flow] Collect Beams: Filter out beams without nailing codes.",
          "17. [Calculation Flow] Validate Beams: Check against exclusion list, beam type, and minimum width (20mm).",
          "18. [Calculation Flow] Collect Sheets: Retrieve sheets corresponding to the mapped Zone index.",
          "19. [Calculation Flow] Calculate Geometry: Determine Beam and Sheet Coordinate Systems/Planes.",
          "20. [Calculation Flow] Generate Segments: Call calculateAllowedNailLineSegments with spacing and edge distances.",
          "21. [Calculation Flow] Create Database Objects: For each segment, create an ElemNail and NailLine object.",
          "22. [Calculation Flow] Set Display: Assign color to NailLine based on ToolIndex.",
          "23. [Calculation Flow] Finalize: EraseInstance (self-destruct)."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Context (Insert vs. Calculation)",
            "path1": {
              "name": "Insert Flow (Commander Instance)",
              "steps": [
                "Validate insert count",
                "Show Dialog if needed",
                "Select Entities",
                "Spawn Child Instances",
                "Self-Destruct"
              ]
            },
            "path2": {
              "name": "Calculation Flow (Worker Instance)",
              "steps": [
                "Load Properties",
                "Filter Geometry",
                "Calculate Lines",
                "Write to DB",
                "Self-Destruct"
              ]
            }
          },
          {
            "condition": "Zone Selection (1-5 vs 6-10)",
            "path1": {
              "name": "Positive Zones (1-5)",
              "steps": [
                "Map to internal indices 1 to 5",
                "Select Sheets from the primary side (Side = 1)"
              ]
            },
            "path2": {
              "name": "Negative Zones (6-10)",
              "steps": [
                "Map to internal indices -1 to -5",
                "Select Sheets from the opposite side (Side = -1)"
              ]
            }
          },
          {
            "condition": "Beam Material Filtering",
            "path1": {
              "name": "Material in Exclusion List",
              "steps": [
                "Beam is skipped (not added to bmValid)"
              ]
            },
            "path2": {
              "name": "Material Allowed",
              "steps": [
                "Proceed to Dimension check",
                "Add to bmValid array"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "Implicit: Script terminates if no element is selected.",
            "recovery": "User must ensure at least one ElementRoof is selected during the PrEntity prompt."
          },
          {
            "check": "Element Integrity",
            "errorMessage": "None explicit in UI.",
            "recovery": "Script checks el.bIsValid() and erases itself if the element is corrupt or invalid."
          },
          {
            "check": "Beam Dimensions",
            "errorMessage": "None explicit.",
            "recovery": "Beams with a width (dW) less than 20mm are automatically filtered out."
          },
          {
            "check": "Nailing Code Presence",
            "errorMessage": "None explicit.",
            "recovery": "Only beams associated with a nailing code are processed; others are removed by removeGenBeamsWithNoNailingBeamCode."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Nailing Parameters",
            "how": "Run the script command again on the same elements.",
            "effect": "Previous NailLines (with the specific ToolIndex) are deleted and replaced with lines calculated using the new properties (spacing, edge distance, etc.)."
          },
          {
            "action": "Delete Generated Data",
            "how": "Select the generated NailLine objects in the model and delete them.",
            "effect": "Nailing data is removed from the element."
          },
          {
            "action": "Visual Inspection",
            "how": "Look at the model representation.",
            "effect": "NailLines are displayed in the color corresponding to their nToolingIndex."
          }
        ]
      },
      "tokens_used": 7050,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_FloorDeckingNailing\n\n## Overview\nAutomates the generation of nailing patterns (NailLines) for floor or roof decking elements within hsbCAD. It calculates precise nail locations, spacing, and tool assignments based on specific zones and material filters to create manufacturing data for CNC machines or graphical representations for shop drawings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D construction elements. |\n| Paper Space | No | Not designed for 2D layouts. |\n| Shop Drawing | No | Generates data in the model environment only. |\n\n## Prerequisites\n- **Required Entities**: `ElementRoof` (Floor or Roof elements).\n- **Minimum Beam Count**: 0 (The script operates on the sheets and beams contained within the selected Element).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the AutoCAD command line.\n2.  Browse to and select `hsb_FloorDeckingNailing.mcr`.\n\n### Step 2: Configure Parameters\n```\nAction: The Properties Palette (OPM) will appear automatically.\nInstructions: Adjust the nailing settings (Zone, Spacing, Materials, etc.) before selecting elements.\nNote: Changes made here apply to the elements you are about to select.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or More Elements\nAction: Click on the desired Floor or Roof elements in the model view. Press Enter to confirm selection.\n```\n\n### Step 4: Execution\n```\nAction: The script calculates nailing lines for the selected elements and adds them to the model.\nResult: The script instance removes itself from the drawing upon completion.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone to be Nail | dropdown | 1 | Selects the construction layer to nail. <br>• **1-5**: Layers on the primary side (e.g., top deck).<br>• **6-10**: Layers on the opposite side (e.g., bottom ceiling). |\n| Nailing Tool index | number | 1 | Identifier for the nail gun or machine configuration. This also determines the color of the nail lines in the model. |\n| Maximum nailing spacing | number | 200 mm | The maximum distance allowed between nails along the line. |\n| Distance from beam edge | number | 9 mm | Setback distance from the end of the beam or sheet edge. Ensures nails are not placed too close to the timber ends to prevent splitting. |\n| Zone Material to be Nailed | text | \"\" | Optional filter. If a material name is entered (e.g., \"OSB\"), nailing will only be applied to sheets matching that name. |\n| Material beams to avoid | text | \"CLS;\" | List of beam materials to exclude from nailing. Default excludes \"CLS\" (timber trimmers). Separate multiple materials with a semicolon (;). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script is a \"fire and forget\" utility. Once executed, the script instance deletes itself. To modify nailing, run the script again on the elements. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: All configuration is handled via the Properties Panel during insertion.\n\n## Tips\n- **Updating Existing Nailing**: If you run the script on an element that already has nail lines generated with the same **Nailing Tool index**, the old lines will be deleted and replaced with the new calculations.\n- **Visual Verification**: Nail lines are displayed in the color corresponding to the **Nailing Tool index**. If you do not see lines, check your layer visibility or display settings for that tool index.\n- **Beam Filtering**: Use the **Material beams to avoid** field to prevent the script from calculating nails on trimmers or stiffeners that do not require nailing (e.g., small blocking members).\n- **Side Selection**: Remember that Zones 6-10 correspond to the \"negative\" or bottom side of the element. If you expect nails on the bottom and see none, ensure you have selected a zone between 6 and 10.\n\n## FAQ\n- **Q: How do I nail the bottom layer of my floor element?**\n  A: Change the **Zone to be Nail** parameter to a value between 6 and 10 (e.g., 6).\n- **Q: Why are some beams being skipped?**\n  A: Check the **Material beams to avoid** property. Also, beams without a defined nailing code in the database or beams narrower than 20mm are automatically excluded.\n- **Q: Can I nail specific sheet materials (like just OSB and ignore Plywood)?**\n  A: Yes. Enter \"OSB\" into the **Zone Material to be Nailed** property. The script will only process sheets with that exact material name."
      },
      "tokens_used": 6445,
      "error": null
    }
  }
}