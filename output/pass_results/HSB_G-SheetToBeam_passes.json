{
  "filename": "HSB_G-SheetToBeam.mcr",
  "status": "completed",
  "total_tokens": 47706,
  "processing_time": 386.3169455528259,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8153,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly passes `_kModelSpace` to `tsl.dbCreate` in the `_bOnInsert` block. It operates on 3D `Body`, `Sheet`, and `Beam` objects, performing geometric calculations with `Vector3d` and `CoordSys`. It lacks `sd_` prefixes or Paper Space handling logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sheet",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": [
            "HSB_G-FilterGenBeams"
          ]
        }
      },
      "tokens_used": 5939,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select one or more elements| <|Right click to select sheets|>",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select sheets|",
              "condition": "_bOnInsert (if previous selection returned 0 elements)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert",
            "title": null,
            "dataSource": "Internal OPM",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sZn",
            "type": "PropString",
            "displayName": "|Zone to convert|",
            "defaultValue": "--",
            "inputType": "dropdown",
            "options": [
              "--",
              "10",
              "9",
              "8",
              "7",
              "6",
              "0",
              "1",
              "2",
              "3",
              "4",
              "5"
            ],
            "category": "|Selection|",
            "description": "|Filterdefenition will always override this propertie!|"
          },
          {
            "index": 10,
            "variable": "genBeamFilterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition for GenBeams|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Dynamic from HSB_G-FilterGenBeams catalog",
            "category": "|Selection|",
            "description": "|Filter definition for GenBeams.| (|Will be combined with custom filters|)|Use| HSB_G-FilterGenBeams |to define the filters|."
          },
          {
            "index": 2,
            "variable": "sName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 3,
            "variable": "sMaterial",
            "type": "PropString",
            "displayName": "|hsbCAD Material|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 4,
            "variable": "sGrade",
            "type": "PropString",
            "displayName": "|Grade|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 5,
            "variable": "sInformation",
            "type": "PropString",
            "displayName": "|Information|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 6,
            "variable": "sLabel",
            "type": "PropString",
            "displayName": "|Label|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 7,
            "variable": "sSublabel",
            "type": "PropString",
            "displayName": "|Sublabel|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 8,
            "variable": "sSublabel2",
            "type": "PropString",
            "displayName": "|Sublabel 2|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 9,
            "variable": "sBeamCode",
            "type": "PropString",
            "displayName": "|Beam code|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Override properties|",
            "description": null
          },
          {
            "index": 1,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": "|Override properties|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "HSB_E-BeamToSheet",
            "searchPaths": [],
            "purpose": "Determine property preset via _kExecuteKey",
            "required": false
          },
          {
            "filename": "HSB_G-FilterGenBeams",
            "searchPaths": [],
            "purpose": "Populate 'Filter definition for GenBeams' dropdown",
            "required": true
          }
        ]
      },
      "tokens_used": 7169,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Converts selected Sheet entities into structural Beam entities, automatically calculating the best-fitting rectangular bounding box for the new beam geometry.",
          "category": "Framing/Modeling",
          "typicalUseCase": "Used when preliminary design geometry modeled as 'Sheets' needs to be converted into structural 'Beams' for detailing, machining, and production lists. It regularizes irregular geometry into rectangular timber sections."
        },
        "parameters": [
          {
            "name": "sZn",
            "technicalDefault": "--",
            "businessMeaning": "Filters the sheets to be converted based on their assigned construction zone or floor index.",
            "validRange": "-- (All), 10, 9, 8, 7, 6, 0, 1, 2, 3, 4, 5",
            "unit": "Index/Text",
            "affectsOutput": "Determines which specific sheets within the selected Elements are processed for conversion."
          },
          {
            "name": "genBeamFilterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Applies an advanced custom filter (defined in the HSB_G-FilterGenBeams catalog) to select sheets based on properties like name, size, or material, rather than just Zone.",
            "validRange": "Any filter name defined in HSB_G-FilterGenBeams catalog",
            "unit": "Text",
            "affectsOutput": "Selects the subset of sheets to convert. Overrides the 'Zone to convert' filter if active."
          },
          {
            "name": "sName",
            "technicalDefault": "",
            "businessMeaning": "Overrides the Name attribute of the resulting Beam. If left empty, inherits from the source Sheet.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the logical Name property in the ERP/Data export."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "",
            "businessMeaning": "Forces a specific hsbCAD Material on the new Beam. If empty, the material is copied from the source Sheet.",
            "validRange": "Valid material name from the hsbCAD catalog",
            "unit": "Text",
            "affectsOutput": "Determines the physical material properties and cross-section definition of the beam."
          },
          {
            "name": "sGrade",
            "technicalDefault": "",
            "businessMeaning": "Overrides the Timber Grade (e.g., C24, GL28h) for the new Beam.",
            "validRange": "Valid grade name from the hsbCAD catalog",
            "unit": "Text",
            "affectsOutput": "Sets structural grading information used in calculations and reports."
          },
          {
            "name": "sInformation",
            "technicalDefault": "",
            "businessMeaning": "Sets a custom comment or information text on the resulting Beam.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Updates the 'Information' field visible in lists and labels."
          },
          {
            "name": "sLabel",
            "technicalDefault": "",
            "businessMeaning": "Overrides the main part number/Label (e.g., position number) for the new Beam.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the identifier used on drawings and production tags."
          },
          {
            "name": "sSublabel",
            "technicalDefault": "",
            "businessMeaning": "Overrides the Sublabel (often used for package or assembly grouping) for the new Beam.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Updates the 'Sublabel' field for sorting and grouping."
          },
          {
            "name": "sSublabel2",
            "technicalDefault": "",
            "businessMeaning": "Overrides the secondary Sublabel for the new Beam.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Updates the 'Sublabel 2' field for extended data requirements."
          },
          {
            "name": "sBeamCode",
            "technicalDefault": "",
            "businessMeaning": "Overrides the production Beam Code (machining class) for the new Beam.",
            "validRange": "Valid Beam Code string",
            "unit": "Text",
            "affectsOutput": "Determines default machining behaviors and production rules applied to the beam."
          },
          {
            "name": "nColor",
            "technicalDefault": "-1",
            "businessMeaning": "Sets the display color (AutoCAD Color Index) of the new Beam. -1 indicates 'Keep Original/ByLayer'.",
            "validRange": "-1 to 255 (Integer)",
            "unit": "ACI Index",
            "affectsOutput": "Visual appearance of the beam in the CAD model."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "genBeamFilterDefinition is set to a value other than empty",
            "effect": "The script ignores the value in 'sZn' (Zone to convert) and uses the filter logic instead.",
            "cascade": [
              "sZn"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Creates a new rectangular Beam entity based on the best-fit bounding box of the original Sheet. The script attempts to align the new Beam's X-axis with the Element's coordinate system for consistency.",
            "appliedTo": "Model Space (Replacing selected Sheets)"
          }
        ]
      },
      "tokens_used": 8833,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script initializes properties (Zone, Filter Definition, Property Overrides).\",\n    \"2. Check if execution is triggered by an Execute Key (Preset).\",\n    \"3. If Insert Mode (`_bOnInsert`): Prompt user 'Select one or more elements (Right click to select sheets)'.\",\n    \"4. [Conditional Branch] Determine input method based on user selection.\",\n    \"5. Path A (Elements Selected): Show properties dialog if no Execute Key. Create Satellite script instances on sheets within the selected elements. Erase Master instance.\",\n    \"6. Path B (Sheets Selected): Show properties dialog if no Execute Key. Attach script directly to selected sheets. Proceed to execution.\",\n    \"7. Execution Phase: Sync properties if this is a Satellite instance. Gather sheets from selection or Element construction.\",\n    \"8. Validation: Check if valid sheets exist in selection.\",\n    \"9. Filtering: Configure filter map (Zone and GenBeamFilter). Call 'HSB_G-FilterGenBeams' TSL to filter sheets.\",\n    \"10. [Conditional Branch] If filtering fails, report warning and erase instance.\",\n    \"11. Loop through each filtered sheet.\",\n    \"12. Calculate geometric 'Best Fit' bounding box by analyzing vertex segments.\",\n    \"13. Determine Beam Orientation: Align X-vector with Element coordinate system or previously processed beams. Flip direction if opposed (>180 degrees).\",\n    \"14. Create new Beam geometry using the calculated bounding box.\",\n    \"15. Map Properties: Copy attributes from original Sheet, then override with any user-defined properties (Name, Material, Grade, etc.) if they are not empty.\",\n    \"16. Delete original Sheet entity.\",\n    \"17. Final Report: Display count of converted entities. Erase script instance.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"User input selection type at command prompt\",\n      \"path1\": {\n        \"name\": \"Element Selection\",\n        \"steps\": [\n          \"User selects Element entities\",\n          \"Script shows dialog (if no Execute Key)\",\n          \"Script iterates selected Elements\",\n          \"Finds all Sheets inside Elements\",\n          \"Erases existing instances of this script on the Element\",\n          \"Creates new 'Satellite' instances of this script attached to the Sheets\",\n          \"Master script instance erases itself\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Sheet Selection\",\n        \"steps\": [\n          \"User Right-Clicks or cancels Element selection\",\n          \"Script shows dialog (if no Execute Key)\",\n          \"User prompts 'Select sheets'\",\n          \"Script attaches itself directly to the selected Sheet entities\",\n          \"Proceeds to execution logic immediately\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Beam X-Vector Alignment Check\",\n      \"path1\": {\n        \"name\": \"Aligned\",\n        \"steps\": [\n          \"Calculated X-vector dot product with Element X is close to 1\",\n          \"Or X-vector matches a previously processed beam in the batch\",\n          \"Direction is preserved\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Opposed (Flip)\",\n        \"steps\": [\n          \"Calculated X-vector dot product with Element X is < -0.999\",\n          \"X-vector is multiplied by -1 (flipped 180 degrees)\",\n          \"Ensures all beams point roughly the same direction relative to the Element\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Property Override Logic\",\n      \"path1\": {\n        \"name\": \"Override Applied\",\n        \"steps\": [\n          \"User has entered a value in an OPM property (e.g., sMaterial, sName)\",\n          \"Resulting Beam uses the User value explicitly\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Inherited\",\n        \"steps\": [\n          \"User OPM property is empty ('')\",\n          \"Resulting Beam copies the value from the source Sheet\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Input Selection Validity\",\n      \"errorMessage\": \"|Invalid selection|!\",\n      \"recovery\": \"User must select at least one Element or Sheet entity to run the script.\"\n    },\n    {\n      \"check\": \"External Filter Script ('HSB_G-FilterGenBeams') Availability\",\n      \"errorMessage\": \"|GenBe"
      },
      "tokens_used": 10819,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-SheetToBeam.mcr\n\n## Overview\nConverts Sheet entities into structural Beam entities, automatically calculating the best-fitting rectangular bounding box for the new beam geometry. This tool is ideal for converting preliminary design \"skins\" into structural timber elements for detailing and production.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Operates in 3D model space only. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | Not intended for 2D production drawings. |\n\n## Prerequisites\n- **Required Entities**: `Sheet` or `Element` entities must exist in the model.\n- **Required Settings**: The catalog file `HSB_G-FilterGenBeams` must be present to populate the filter options.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse and select `HSB_G-SheetToBeam.mcr`.\n\n### Step 2: Select Elements or Sheets\n```\nCommand Line: Select one or more elements <Right click to select sheets>\nAction: \n- Click on an Element (e.g., a Wall or Roof) to process all Sheets inside it.\n- OR Right-click (or Enter) to switch to manual selection.\n```\n\n### Step 3: Select Sheets (If applicable)\n```\nCommand Line: Select sheets\nAction: Click on individual Sheet entities to convert them. Press Enter to finish selection.\n```\n\n### Step 4: Configure Properties\nAfter selection, the Properties Palette (OPM) will appear.\n1. **Filtering**: Use \"Zone to convert\" or \"Filter definition\" to limit which sheets are processed.\n2. **Overrides**: Enter values for Name, Material, Grade, etc., if you want to force specific data on the new beams.\n3. Close the Properties Palette to start the conversion.\n\n### Step 5: Review\nThe script will delete the original Sheets and replace them with new Beam entities. The command line will report the number of converted entities.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Zone to convert** | dropdown | -- | Filters sheets based on a zone index (e.g., Floor 1, Floor 2). Note: This is ignored if a Filter definition is set. |\n| **Filter definition for GenBeams** | dropdown | *Dynamic* | Advanced filter based on the `HSB_G-FilterGenBeams` catalog. If set, this overrides the simple Zone filter. |\n| **Name** | text | *Empty* | Overrides the Name of the new Beam. Leave empty to inherit the Name from the original Sheet. |\n| **hsbCAD Material** | text | *Empty* | Sets the material for the new Beam. Leave empty to inherit from the Sheet. |\n| **Grade** | text | *Empty* | Sets the timber grade (e.g., C24). Leave empty to inherit from the Sheet. |\n| **Information** | text | *Empty* | Adds custom information text to the new Beam. |\n| **Label** | text | *Empty* | Overrides the main part number/Label. Leave empty to inherit. |\n| **Sublabel** | text | *Empty* | Overrides the Sublabel. Leave empty to inherit. |\n| **Sublabel 2** | text | *Empty* | Overrides the second Sublabel. Leave empty to inherit. |\n| **Beam code** | text | *Empty* | Sets the production/machining code for the new Beam. Leave empty to inherit. |\n| **Color** | number | -1 | Sets the AutoCAD color index (ACI) for the new Beam. Use -1 to keep the layer color. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add specific options to the entity right-click menu during normal editing. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams`\n- **Location**: hsbCAD Company or Install directory (Catalogs).\n- **Purpose**: Provides the list of available filter options for the \"Filter definition for GenBeams\" property, allowing you to filter sheets by size, name, or other criteria.\n\n## Tips\n- **Inheritance**: If you want the new beams to look and act exactly like the sheets they replace, leave all \"Override properties\" fields empty.\n- **Geometry Handling**: The script calculates a \"best fit\" rectangular box. If your source sheets are complex polygons (e.g., L-shapes or T-shapes), they will be converted into a rectangular solid timber that encompasses the original shape.\n- **Alignment**: New beams are automatically aligned to the Element's coordinate system to ensure they run in the correct direction relative to the wall or roof.\n- **Filtering**: Use the \"Filter definition\" instead of \"Zone\" if you need to convert only specific sheets (e.g., only \"Cladding\" sheets) within a selected Element.\n\n## FAQ\n- **Q: What happens to the original Sheet entities?**\n  **A:** The original Sheets are deleted from the model and replaced by the new Beams. Ensure you have a backup if you need to retain the Sheet geometry.\n- **Q: Why did my beam appear in the wrong direction?**\n  **A:** The script aligns the beam based on the Element's local coordinate system. Check the orientation of the parent Element if the beam direction is unexpected.\n- **Q: Can I use this to convert curved walls?**\n  **A:** This script creates rectangular Beams (linear). It is best suited for straight elements. Curved sheets will likely result in a bounding box that approximates the curve's start and end points, effectively straightening the element."
      },
      "tokens_used": 6793,
      "error": null
    }
  }
}