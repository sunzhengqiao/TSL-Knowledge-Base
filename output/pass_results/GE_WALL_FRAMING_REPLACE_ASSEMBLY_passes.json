{
  "filename": "GE_WALL_FRAMING_REPLACE_ASSEMBLY.mcr",
  "status": "completed",
  "total_tokens": 43477,
  "processing_time": 417.5712606906891,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8671,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses Entity arEnt[] = gpCurrent.collectEntities(true, Element(), _kModelSpace); explicitly filtering for Model Space. No sd_ prefixes, #Type E, or _Viewport usage found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Wall",
            "ElementWall",
            "ElementWallSF"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script requires two connected Walls (ElementWall or ElementWallSF) forming a T or L connection within the Model Space.",
          "requiredSettings": [
            "hsbFramingDefaults.details.dll (via callDotNetFunction2)",
            "Script dependency: GE_WALL_RERUN_BLOCKING_LINES"
          ]
        }
      },
      "tokens_used": 5062,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 5812,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Replaces the generic framing at a wall-to-wall intersection (T-junction or corner) with a specific, user-defined engineering assembly, handling the cleanup of existing material and insertion of the new detail.",
          "category": "Framing / Detailing",
          "typicalUseCase": "Applying a specific structural junction detail (e.g., a 3-stud corner, fire-stop blocking, or structural post) after the initial wall generation, allowing for rotation and precise positioning along the wall length."
        },
        "parameters": [
          {
            "name": "sAssembly",
            "technicalDefault": "First entry from hsbFramingDefaults.details.dll",
            "businessMeaning": "The specific framing pattern or engineering detail to apply at the connection (e.g., 'Corner_2Stud', 'T-Junc_Firestop'). This defines the configuration of studs, plates, and noggins.",
            "validRange": "Dependent on the hsbFramingDefaults library configuration",
            "unit": "String (List)",
            "affectsOutput": "Determines the geometry, quantity, and type of beams generated by the ElementDetailInsert directive. Replaces the erased generic framing."
          },
          {
            "name": "sRotate",
            "technicalDefault": "0",
            "businessMeaning": "The rotational orientation of the assembly around the vertical axis at the connection point. Used to align the detail correctly regardless of whether the intersecting wall is on the left or right side.",
            "validRange": "0, 90, 180, 270",
            "unit": "degrees",
            "affectsOutput": "Rotates the insertion vectors (VECX, VECY, VECZ) passed to the detail, effectively flipping the assembly to match the wall geometry."
          },
          {
            "name": "dOffset",
            "technicalDefault": "0.0",
            "businessMeaning": "Displaces the assembly along the length of the 'Female' (receiving) wall from the exact connection intersection point.",
            "validRange": "Typically -500mm to 500mm (limited by wall length and adjacent openings)",
            "unit": "Length (current project units, inches or mm)",
            "affectsOutput": "Shifts the insertion point (_Pt0) along the wall's longitudinal axis, moving the entire assembly pattern left or right relative to the intersecting wall."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Change in sRotate",
            "effect": "Recalculates the insertion coordinate system (vDx, vDy, vDz) to ensure the assembly detail is oriented correctly relative to the Male/Female wall vectors.",
            "cascade": [
              "VECX",
              "VECY",
              "VECZ",
              "yFlag",
              "zFlag"
            ]
          },
          {
            "trigger": "Change in dOffset",
            "effect": "Updates the insertion origin point (_Pt0) by shifting it along the Female wall's vector X.",
            "cascade": [
              "PTORG"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (Implicit/Eraser)",
            "description": "A calculation box (approx 7.5 units wide) used to identify and erase existing studs and blocking in the connection zone, preserving top and bottom plates.",
            "appliedTo": "Female Wall (ElementWall)"
          },
          {
            "type": "ElementDetailInsert (Assembly)",
            "description": "Generates new beams (studs, noggins, etc.) based on the selected sAssembly pattern, constrained by the calculated height between plates and user-defined rotation/offset.",
            "appliedTo": "Female Wall (ElementWall)"
          },
          {
            "type": "TslInst",
            "description": "Creates an instance of the helper script 'GE_WALL_RERUN_BLOCKING_LINES' to handle adjacent framing updates.",
            "appliedTo": "Female Wall (ElementWall)"
          }
        ]
      },
      "tokens_used": 8692,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launch: Cycle check (if > 1, erase instance immediately).",
          "2. User Input: Prompt to select a point near a wall-to-wall connection.",
          "3. Entity Search: Collect all Walls/ElementWalls in ModelSpace; identify the closest wall (el1) to the point.",
          "4. Connection Search: Retrieve elements connected to el1; identify the closest one to the point as el2.",
          "5. Geometry Validation: Calculate intersection points of outlines. Verify exactly 2 intersections exist (T or L shape).",
          "6. Role Determination: Check vertex coincidences to determine which wall is 'Male' (ends at intersection) and which is 'Female' (continuous).",
          "7. Assignment: Assign script instance to the Female wall; set dependency.",
          "8. .NET Dialog: Invoke hsbFramingDefaults.details.dll to display assembly selection dialog.",
          "9. Helper Script: Clone instance of 'GE_WALL_RERUN_BLOCKING_LINES' onto the Female wall.",
          "10. State Save: Store selected assembly, Female wall, contact point, and execution mode in _Map; Exit (return).",
          "11. Recalculation Phase: Load properties (Assembly, Rotate, Offset) from _Map.",
          "12. Cleaning Phase: Create a temporary Body box at the connection; erase any beams inside it except top/bottom plates.",
          "13. Height Calculation: Detect the highest bottom plate and lowest top plate to determine stud length.",
          "14. Vector Calculation: Compute VECX, VECY, VECZ based on the wall geometry and user-defined Rotation angle.",
          "15. Generation: Execute 'ElementDetailInsert' directive to generate the new assembly beams.",
          "16. Visualization: Draw reference circle at insertion point."
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Stop Execution"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Continue to User Input"
              ]
            }
          },
          {
            "condition": "Connected Elements Found",
            "path1": {
              "name": "No Connections",
              "steps": [
                "Report Message 'Wall has not valid connections'",
                "Erase Instance"
              ]
            },
            "path2": {
              "name": "Connections Found",
              "steps": [
                "Select closest connected wall",
                "Proceed to Geometry Validation"
              ]
            }
          },
          {
            "condition": "Geometry Type (Intersection Points)",
            "path1": {
              "name": "Intersections != 2",
              "steps": [
                "Report Error 'Not a proper T or L connection'",
                "Erase Instance"
              ]
            },
            "path2": {
              "name": "2 Intersections",
              "steps": [
                "Proceed to Role Determination (Male/Female)"
              ]
            }
          },
          {
            "condition": "Male/Female Identification",
            "path1": {
              "name": "Male-to-Male",
              "steps": [
                "Report Warning 'Male to male connection not implemented'",
                "Erase Instance"
              ]
            },
            "path2": {
              "name": "No Male Wall",
              "steps": [
                "Report Error 'Not a T or L connection'",
                "Erase Instance"
              ]
            },
            "path3": {
              "name": "Valid Male/Female Pair",
              "steps": [
                "Assign script to Female wall",
                "Continue to Dialog"
              ]
            }
          },
          {
            "condition": "Assembly Selection",
            "path1": {
              "name": "Empty Selection",
              "steps": [
                "Erase Instance"
              ]
            },
            "path2": {
              "name": "Valid Selection",
              "steps": [
                "Store selection in Map",
                "Generate Helper Script",
                "Recalculate"
              ]
            }
          },
          {
            "condition": "Rotation Angle (sRotate)",
            "path1": {
              "name": "0 Degrees",
              "steps": [
                "Set VECY to Right of Connection",
                "Set Alignment Flags (y=0, z=1)"
              ]
            },
            "path2": {
              "name": "90 Degrees",
              "steps": [
                "Set VECY towards Male Wall",
                "Set Alignment Flags (y=1, z=0)"
              ]
            },
            "path3": {
              "name": "180 Degrees",
              "steps": [
                "Set VECY to Left of Connection",
                "Set Alignment Flags (y=0, z=-1)"
              ]
            },
            "path4": {
              "name": "270 Degrees",
              "steps": [
                "Set VECY away from Male Wall",
                "Set Alignment Flags (y=-1, z=0)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Number of wall outline intersections",
            "errorMessage": "ERROR: This is not a proper T or L connection or the connection is not cleaned up, cannot apply this tsl on this type of connection",
            "recovery": "Ensure walls are properly joined or cleaned up before running script."
          },
          {
            "check": "Coincident vertices (Male vs Female)",
            "errorMessage": "WARNING: Male to male connection not implemented yet OR ERROR: This is not a T or L connection",
            "recovery": "Ensure one wall ends cleanly against the side of the other (T or L). End-to-end connections are not supported."
          },
          {
            "check": "Assembly Selection Dialog",
            "errorMessage": "Silent failure (Instance erased)",
            "recovery": "Must select a valid assembly name from the pop-up dialog."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Assembly Type",
            "how": "Properties Palette (OPM) -> 'Assembly' dropdown",
            "effect": "Erases current detail and inserts the newly selected assembly pattern."
          },
          {
            "action": "Rotate Assembly",
            "how": "Properties Palette (OPM) -> 'Rotate' dropdown (0, 90, 180, 270)",
            "effect": "Changes the orientation (VECX/Y/Z) of the detail insertion vectors relative to the wall connection."
          },
          {
            "action": "Offset Assembly",
            "how": "Properties Palette (OPM) -> 'Offset' numeric input",
            "effect": "Slides the assembly along the length of the Female wall (Left/Right) from the connection point."
          }
        ]
      },
      "tokens_used": 9524,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# GE_WALL_FRAMING_REPLACE_ASSEMBLY\n\n## Overview\nThis script replaces the generic framing at a wall-to-wall intersection (T-junction or L-corner) with a specific, user-defined engineering assembly. It automatically removes existing studs in the connection zone and inserts the new detail, allowing for adjustments to rotation and offset.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script is designed to run strictly in Model Space. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: Two connected Walls (`ElementWall` or `ElementWallSF`) forming a valid T or L connection.\n- **Geometry**: Walls must form a clean intersection. End-to-end connections are not supported.\n- **Required Settings**: `hsbFramingDefaults.details.dll` (Provides the list of available assemblies).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT`\n**Action**: Browse and select `GE_WALL_FRAMING_REPLACE_ASSEMBLY.mcr`.\n\n### Step 2: Select Intersection Point\n```\nCommand Line: Select a point near a connection:\nAction: Click near the intersection point of the two walls you wish to modify.\n```\n*Note: The script will automatically detect the two walls involved.*\n\n### Step 3: Select Assembly\n**Action**: A dialog box will appear displaying a list of available framing assemblies (e.g., \"Corner_2Stud\", \"T-Junc_Firestop\").\n- Select the desired assembly pattern from the list.\n- Click **OK**.\n\nThe script will then assign itself to the \"Female\" (receiving) wall, erase the old framing, and insert the new assembly.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Assembly | Dropdown (String) | (First entry in library) | Selects the specific framing pattern or engineering detail to apply at the connection. |\n| Rotate | Dropdown (Int) | 0 | Rotates the assembly around the vertical axis. Options: 0, 90, 180, 270 degrees. Use this to flip the detail orientation. |\n| Offset | Number (Double) | 0.0 | Shifts the assembly along the length of the main (receiving) wall from the exact connection point. Use positive or negative values to move it left or right. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the Properties Palette to modify Assembly, Rotation, or Offset settings. |\n| Erase | Removes the script instance from the wall. |\n\n## Settings Files\n- **Filename**: `hsbFramingDefaults.details.dll` (or associated configuration)\n- **Location**: hsbCAD installation directory or Company standards folder.\n- **Purpose**: This external library provides the list of valid assembly names and their definitions used in the selection dialog.\n\n## Tips\n- **Orientation**: If the inserted assembly is facing the wrong direction (e.g., into the wall instead of along it), use the **Rotate** property in the palette to change it to 90 or 270 degrees.\n- **Positioning**: If the new assembly clashes with a door or window nearby, use the **Offset** property to slide it along the wall length.\n- **Validation**: Ensure your walls are properly joined in an \"L\" or \"T\" shape before running the script. If the script disappears immediately after selection, the connection may not be valid (e.g., the walls might just be touching end-to-end).\n\n## FAQ\n- **Q: Why did the script disappear immediately after I clicked the wall?**\n  **A**: The script likely did not find a valid T or L connection. Ensure one wall runs fully into the side of the other, rather than just touching end-to-end.\n- **Q: Can I use this to connect two walls that don't touch yet?**\n  **A**: No. The walls must already be drawn and intersecting in the model for the script to detect the connection point.\n- **Q: Does this script work on Shop Drawings?**\n  **A**: No, this is a Model Space scripting tool for generating 3D model geometry."
      },
      "tokens_used": 5716,
      "error": null
    }
  }
}