{
  "filename": "MultiElementCOG.mcr",
  "status": "completed",
  "total_tokens": 41540,
  "processing_time": 216.9191336631775,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl displays the COG of an element. In case of a multi element it displays the COG of the indiviual elements if available.",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "04.10.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-12789 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "hsbCenterOfGravity"
        ]
      },
      "tokens_used": 6449,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly detects the current space using Viewport().inLayoutTab() and Viewport().inPaperSpace(). In Model Space, it iterates through selected Elements to attach TSL instances. In Paper Space, it prompts the user to select a Viewport to display COG data transformed via ms2ps coordinate system."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "ElementMulti",
            "Viewport"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (requires Element selection) or Paper Space (requires Viewport selection).",
          "requiredSettings": [
            "hsbCenterOfGravity"
          ]
        }
      },
      "tokens_used": 4260,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "bInLayoutTab (Paper Space)",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "|Pick a point outside of paperspace|",
              "condition": "bInLayoutTab (Paper Space)",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "|Select elements|",
              "condition": "Model Space",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(Weight:RL1)kg",
            "inputType": "text",
            "options": [],
            "category": "|Content|",
            "description": "|Defines the Format|"
          },
          {
            "index": 1,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|DimStyle|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "_DimStyles.sorted()"
            ],
            "category": "|Display|",
            "description": "|Defines the DimStyle|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|TextHeight|",
            "defaultValue": "3",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Text Height|"
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Color|"
          },
          {
            "index": 1,
            "variable": "dScaleFactor",
            "type": "PropDouble",
            "displayName": "|Scale Factor|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": "|Defines the ScaleFactor|"
          },
          {
            "index": 1,
            "variable": "nTransparency",
            "type": "PropInt",
            "displayName": "|Transparency|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Symbol|",
            "description": "|Defines the Transparency|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Add/Remove Format|",
            "handler": "|Add/Remove Format|",
            "action": "Prompts user on command line to select a property index to add or remove from the format string.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8612,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Visualizes the Center of Gravity (COG) and properties (like weight) for individual panels within a Multi-Element assembly in both Model and Paper Space.",
          "category": "Analysis/Annotation",
          "typicalUseCase": "Labeling individual wall or floor panels in a transport layout to indicate their specific weight and balance point for logistics and crane lifting."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(Weight:RL1)kg",
            "businessMeaning": "The template string that determines what data is displayed next to the COG marker (e.g., weight, element number).",
            "validRange": "Any string containing format tokens like @(Weight), @(Number), or static text.",
            "unit": "String",
            "affectsOutput": "Changes the text content of the label (e.g., displaying '1500kg' vs 'Weight: 1500kg')."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "The AutoCAD dimension style used to determine the font and text properties for the COG label.",
            "validRange": "Any existing Dimension Style name in the current drawing.",
            "unit": "String",
            "affectsOutput": "Alters the font, text slant, and general appearance of the annotation based on the selected style."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "3",
            "businessMeaning": "The height of the text label for the COG.",
            "validRange": "2.0 to 10.0 (depends on plot scale and visibility needs).",
            "unit": "mm",
            "affectsOutput": "Resizes the text. Also acts as the base size for the COG symbol unless modified by the scale factor."
          },
          {
            "name": "nColor",
            "technicalDefault": "1",
            "businessMeaning": "The AutoCAD color index used for the COG symbol and text.",
            "validRange": "0 to 255 (Standard CAD colors).",
            "unit": "Index",
            "affectsOutput": "Changes the color of the drawing elements (e.g., Red for visibility)."
          },
          {
            "name": "dScaleFactor",
            "technicalDefault": "1",
            "businessMeaning": "A multiplier to resize the graphical COG symbol (the square marker) independently of the text height.",
            "validRange": "0.1 to 5.0 (used to make the symbol larger or smaller relative to text).",
            "unit": "Unitless",
            "affectsOutput": "Scales the size of the square marker placed at the COG location."
          },
          {
            "name": "nTransparency",
            "technicalDefault": "0",
            "businessMeaning": "The transparency level of the filled COG symbol.",
            "validRange": "0 (Solid) to 90 (Nearly invisible).",
            "unit": "Percentage",
            "affectsOutput": "Adjusts how much the COG symbol obscures the drawing underneath it."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight changes",
            "effect": "The base size of the symbol changes, and the text size updates.",
            "cascade": [
              "dTextHeight"
            ]
          },
          {
            "trigger": "dScaleFactor changes",
            "effect": "The graphic symbol size is multiplied by this factor (relative to TextHeight).",
            "cascade": [
              "dTextHeight",
              "dScaleFactor"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation",
            "description": "A rotated square symbol (filled with transparency) marking the Center of Gravity, and a text string displaying calculated properties.",
            "appliedTo": "Single elements within a selected ElementMulti (Multi-wall/floor)."
          }
        ]
      },
      "tokens_used": 6607,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script execution starts; check if running in duplicate insert cycle (erase if true).",
          "2. Check if executing via Command Key (Silent mode) or standard insertion.",
          "3. If standard insertion, display Properties Dialog (showDialog).",
          "4. Detect current CAD Space: Model Space or Paper Space (Layout Tab).",
          "5. [Branch] Paper Space Flow: Prompt user to select a Viewport, then prompt user to pick an insertion point outside the viewport. Script instance is anchored to the point.",
          "6. [Branch] Model Space Flow: Prompt user to select Elements. Script iterates selection and creates a new TSL instance attached to each selected Element. The original 'master' instance is erased.",
          "7. Instance Execution: Retrieve associated Element or Viewport data.",
          "8. Determine if Element is a Multi-Element (ElementMulti).",
          "9. Collect relevant sub-elements (SingleElementRefs) or the single element itself.",
          "10. Iterate through collected elements to calculate COG.",
          "11. For each element: Collect GenBeams/Openings, call 'hsbCenterOfGravity' MapIO to get Weight and Center point.",
          "12. Transform COG coordinates based on assembly offsets and Viewport transformation (ms2ps).",
          "13. Construct display string based on 'sFormat' and calculated data.",
          "14. Draw COG Symbol (Rotated Square) and Text at the transformed location.",
          "15. [Branch] Format Edit Flow: If triggered via Context Menu, list available properties, prompt for index selection, add/remove/toggle properties, update 'sFormat', and redraw."
        ],
        "conditionalBranches": [
          {
            "condition": "Current CAD Space during Insertion",
            "path1": {
              "name": "Paper Space",
              "steps": [
                "Execute getViewport()",
                "Execute getPoint() for placement",
                "Link instance to Viewport and Point"
              ]
            },
            "path2": {
              "name": "Model Space",
              "steps": [
                "Execute PrEntity.go() to select elements",
                "Loop through selection and dbCreate instances per element",
                "Erase original script instance"
              ]
            }
          },
          {
            "condition": "Type of Element Selected",
            "path1": {
              "name": "ElementMulti (Multi-wall/floor)",
              "steps": [
                "Extract SingleElementRefs",
                "Find matching drawing Elements in ModelSpace",
                "Process each sub-element individually for COG"
              ]
            },
            "path2": {
              "name": "Single Element",
              "steps": [
                "Use element directly",
                "Calculate COG for the whole entity"
              ]
            }
          },
          {
            "condition": "User Input in Format Editor (Add/Remove Format)",
            "path1": {
              "name": "Input = 0",
              "steps": [
                "Exit editing loop"
              ]
            },
            "path2": {
              "name": "Input = -1",
              "steps": [
                "Append New Line token (\\P) to format",
                "Loop again"
              ]
            },
            "path3": {
              "name": "Input = Property Index (1 to N)",
              "steps": [
                "Check if property token exists in string",
                "If exists, remove it",
                "If missing, append it",
                "Loop again"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Duplicate Insert Cycle",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases the new instance and retains the original."
          },
          {
            "check": "Viewport Selection (Paper Space)",
            "errorMessage": "None (Standard CAD cancellation)",
            "recovery": "User must select a valid viewport or press ESC to cancel command."
          },
          {
            "check": "Element Selection (Model Space)",
            "errorMessage": "None (PrEntity.go returns false)",
            "recovery": "User must select at least one Element. If none selected, script ends without creating instances."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Display Format",
            "how": "Context Menu: '|Add/Remove Format|'",
            "effect": "Prompts user on command line to toggle specific data fields (Weight, Number, etc.) in the label string."
          },
          {
            "action": "Change Visual Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Text Height, Color, DimStyle, Scale Factor, and Transparency immediately."
          },
          {
            "action": "Move Label",
            "how": "Grip Edit (Point)",
            "effect": "In Paper Space, moving the insertion point (_Pt0) moves the entire annotation set relative to the viewport origin. (Note: The COG markers update relative to element position, but the text origin is fixed by _Pt0 in Paper Space mode)."
          }
        ]
      },
      "tokens_used": 9622,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# MultiElementCOG\n\n## Overview\nThis script visualizes the Center of Gravity (COG) and displays specific properties (such as weight) for timber elements. It handles both single elements and Multi-Elements (e.g., multi-layer walls), displaying individual COGs for sub-components in both Model and Paper Space.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Select elements to attach the COG marker directly to the geometry. |\n| Paper Space | Yes | Select a Viewport to display COG data projected onto the layout. |\n| Shop Drawing | No | This is an annotation script for general layout and modeling. |\n\n## Prerequisites\n- **Required Entities**: Element (Single or Multi), Viewport (if in Paper Space).\n- **Minimum Beams**: 0 (Operates on Elements).\n- **Required Settings**: The `hsbCenterOfGravity` script must be present in the system.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT` â†’ Browse and select `MultiElementCOG.mcr`.\n\n### Step 2: Select Elements or Viewport\nThe script behaves differently depending on your current CAD space:\n\n**In Model Space:**\n```\nCommand Line: Select elements\nAction: Click on the timber elements or multi-elements you want to analyze. Press Enter to confirm.\n```\n*Result*: The script attaches an instance to each selected element.\n\n**In Paper Space (Layout Tab):**\n```\nCommand Line: Select a viewport\nAction: Click on the viewport frame displaying the model you wish to annotate.\n```\n```\nCommand Line: Pick a point outside of paperspace\nAction: Click a location in the layout (outside the viewport boundary) to place the annotation leader/text origin.\n```\n\n### Step 3: Configure Properties (Optional)\nAfter insertion, select the script instance and open the **Properties Palette** to adjust text format, color, or scale.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | text | `@(Weight:RL1)kg` | Defines the text displayed using dynamic tokens (e.g., `@(Weight)`, `@(Number)`). |\n| DimStyle | dropdown | `(Current Style)` | Selects the AutoCAD Dimension Style to control font and text appearance. |\n| TextHeight | number | 3 | Sets the height of the text label (in current drawing units). |\n| Color | number | 1 | Sets the AutoCAD color index for the symbol and text (e.g., 1 = Red). |\n| Scale Factor | number | 1 | Multiplies the size of the COG square symbol independently of the text height. |\n| Transparency | number | 0 | Sets the transparency of the filled COG symbol (0 = Solid/Opaque). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add/Remove Format | Opens a command-line menu listing available data properties (e.g., 1. Weight, 2. Number). Type the number to toggle that property in the display label, or type 0 to exit. |\n\n## Settings Files\n- **Dependency**: `hsbCenterOfGravity`\n- **Purpose**: This external script is used to calculate the physical center and weight of the timber elements.\n\n## Tips\n- **Multi-Elements**: If you select a Multi-Element (e.g., a wall with multiple layers), the script automatically calculates and displays the COG for each individual sub-layer.\n- **Paper Space Workflow**: Use the Paper Space mode to create clean production drawings where the data is projected from the model but the text remains editable in the layout.\n- **Format Tokens**: You can combine static text with tokens. For example, entering `No: @(Number) W: @(Weight)` will display \"No: 100 W: 500kg\".\n- **Visibility**: If the COG square obscures important details in your drawing, increase the **Transparency** value or decrease the **Scale Factor**.\n\n## FAQ\n- **Q: Why do I see multiple squares when I only selected one wall?**\n  **A**: You likely selected a \"Multi-Element\" (e.g., a timber frame wall with cladding). The script displays the COG for every single layer (wood, cladding, insulation) separately.\n- **Q: How do I change the label to show the Element Number instead of Weight?**\n  **A**: Select the script, right-click and choose \"Add/Remove Format\". Follow the command line prompts to toggle Weight off and Number on.\n- **Q: My text is too small to read in the Layout view.**\n  **A**: Select the script in the layout and increase the **TextHeight** parameter in the Properties palette."
      },
      "tokens_used": 5990,
      "error": null
    }
  }
}