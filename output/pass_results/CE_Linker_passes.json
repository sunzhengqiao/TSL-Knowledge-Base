{
  "filename": "CE_Linker.mcr",
  "status": "completed",
  "total_tokens": 50767,
  "processing_time": 272.96311259269714,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6475,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script executes in _bOnInsert by prompting for GenBeam and CollectionEntity selection via command line (getGenBeam, PrEntity). It uses standard Display dp for 3D visualization and creates TslInst objects (SC_Fastener) directly in the model using dbCreate. No Paper Space, Viewport, or ShopDrawing specific constructs (sd_*, _kPaperSpace) are utilized."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "CollectionEntity"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing valid Collection Definitions",
          "requiredSettings": [
            "Materials.xml (located at _kPathHsbCompany\\Abbund\\Materials.xml)",
            "Collection Definitions (hsc/hc files) referenced by CollectionDefinition()"
          ]
        }
      },
      "tokens_used": 6689,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select Existing",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getGenBeam",
              "promptOriginal": "Select Main Beam/Panel (Parent)",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity",
              "promptOriginal": "Select Other Beams/Panels (Children)",
              "condition": "_bOnInsert",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Property Dialog",
            "trigger": "Context Menu: Pick New Custom Assembly",
            "title": "Properties",
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "psCollectionEntityName",
            "type": "PropString",
            "displayName": "Assembly Name",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "Dynamic from Collection Definitions"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "psInstallation",
            "type": "PropString",
            "displayName": "Installation",
            "defaultValue": "Installed",
            "inputType": "dropdown",
            "options": [
              "Installed",
              "Shipped Loose"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "psDoDrills",
            "type": "PropString",
            "displayName": "Apply Drills",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "psNotes",
            "type": "PropString",
            "displayName": "Shopdraw Notes",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "psShowLabel",
            "type": "PropString",
            "displayName": "Show Label?",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "psManufacturer",
            "type": "PropString",
            "displayName": "Manufacturer",
            "defaultValue": "Generic",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "pdTextH",
            "type": "PropDouble",
            "displayName": "Text Height",
            "defaultValue": 1.0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "pdLabelTextHeight",
            "type": "PropDouble",
            "displayName": "Label Text Height",
            "defaultValue": 25.0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "piParentNumber",
            "type": "PropInt",
            "displayName": "Parent Entity",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "piLabelColor",
            "type": "PropInt",
            "displayName": "Label Text Color",
            "defaultValue": 30,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Reselect Parent Beam",
            "handler": "stResetParent",
            "action": "Prompts user to select a new primary beam/panel and updates _GenBeam[0]",
            "alsoTriggeredBy": "Reselect All Beams"
          },
          {
            "menuItem": "Reselect Child Beams",
            "handler": "stResetChildren",
            "action": "Clears current child beams (except parent) and prompts to select new child beams",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Reselect All Beams",
            "handler": "stResetAll",
            "action": "Clears all beams, then prompts for a new parent beam followed by new child beams",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Pick New Custom Assembly",
            "handler": "stChangeAssemblyInUse",
            "action": "Opens dialog to change the Collection Entity definition",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Materials.xml",
            "searchPaths": [
              "_kPathHsbCompany\\Abbund\\Materials.xml"
            ],
            "purpose": "Provides density values (specifically Steel) for weight calculations",
            "required": false
          }
        ]
      },
      "tokens_used": 9243,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Installs and manages parametric sub-assemblies (Collection Entities) onto structural beams, processing associated drilling, cuts, and hardware generation.",
          "category": "Hardware / Connection Logic",
          "typicalUseCase": "Applying complex standardized connections (e.g., heavy truss hangers, shear plates, or bracket assemblies) to beams in the model to drive machining and shop drawings."
        },
        "parameters": [
          {
            "name": "psCollectionEntityName",
            "technicalDefault": "",
            "businessMeaning": "The specific definition of the custom assembly or connection to be applied. It defines the geometry, machining, and hardware requirements.",
            "validRange": "List of valid Collection Entities available in the project",
            "unit": "String",
            "affectsOutput": "Determines which drills, cuts, and fasteners are generated. Reloads the entire assembly definition."
          },
          {
            "name": "psInstallation",
            "technicalDefault": "Installed",
            "businessMeaning": "Specifies the installation state of the assembly, distinguishing between factory-applied and loose hardware.",
            "validRange": "Installed, Shipped Loose",
            "unit": "String",
            "affectsOutput": "Filters whether the hardware appears in specific shop drawing maps or BOM lists (depending on 'SHOP' logic)."
          },
          {
            "name": "psDoDrills",
            "technicalDefault": "Yes",
            "businessMeaning": "Global switch to enable or disable the creation of drilling operations defined in the assembly.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "If 'No', suppresses all drilling (holes) on the linked beams. If 'Yes', drills are applied."
          },
          {
            "name": "psNotes",
            "technicalDefault": "",
            "businessMeaning": "Custom textual information intended for the shop floor or installer regarding this specific assembly instance.",
            "validRange": "Free text",
            "unit": "String",
            "affectsOutput": "Metadata storage; visible in properties and potentially reports/shop drawings."
          },
          {
            "name": "psShowLabel",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the visibility of the 3D label identifying the assembly in the model space.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "Controls whether the leader line and text label are drawn in the CAD model."
          },
          {
            "name": "psManufacturer",
            "technicalDefault": "Generic",
            "businessMeaning": "The name of the supplier or manufacturer of the assembly/hardware.",
            "validRange": "Free text (e.g., 'Simpson', 'MiTek')",
            "unit": "String",
            "affectsOutput": "Updates the Manufacturer field in Hardware Components for BOM generation."
          },
          {
            "name": "pdTextH",
            "technicalDefault": "1.0",
            "businessMeaning": "The height of the script origin/identifier text.",
            "validRange": "0.5 - 5.0",
            "unit": "mm",
            "affectsOutput": "Visual scale of the debug/origin marker text in the 3D model."
          },
          {
            "name": "pdLabelTextHeight",
            "technicalDefault": "25.0",
            "businessMeaning": "The height of the assembly label text visible in the model.",
            "validRange": "10.0 - 100.0",
            "unit": "mm",
            "affectsOutput": "Visual scale of the assembly name label."
          },
          {
            "name": "piParentNumber",
            "technicalDefault": "-1",
            "businessMeaning": "The unique position or mark number of the primary (parent) beam the assembly is attached to.",
            "validRange": "Any positive integer (Auto-generated)",
            "unit": "Count",
            "affectsOutput": "Read-only reference linking the assembly to the host beam."
          },
          {
            "name": "piLabelColor",
            "technicalDefault": "30",
            "businessMeaning": "The CAD color used to display the assembly label.",
            "validRange": "1 - 255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Visual color of the label in the model view."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "psShowLabel is set to 'No'",
            "effect": "Label drawing logic is skipped",
            "cascade": [
              "pdLabelTextHeight",
              "piLabelColor"
            ]
          },
          {
            "trigger": "psCollectionEntityName changes",
            "effect": "Script recalculates all geometry, fasteners, and cuts based on new definition",
            "cascade": [
              "mpFastenerRequests",
              "mpDrills",
              "mpBeamCuts",
              "mpCuts"
            ]
          },
          {
            "trigger": "psDoDrills is set to 'No'",
            "effect": "Drill operations defined in the collection are ignored",
            "cascade": [
              "mpDrills"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "SC_Fastener (TslInst)",
            "description": "Individual fastener objects (screws/bolts) generated based on the assembly's fastener requests.",
            "appliedTo": "Parent and Child beams (geometry mapped to beam surfaces)"
          },
          {
            "type": "Drills / Machining",
            "description": "Holes and bores required for the assembly.",
            "appliedTo": "Parent and Child beams"
          },
          {
            "type": "Cuts",
            "description": "Trimming or notching operations on the beams to accommodate the assembly.",
            "appliedTo": "Parent and Child beams"
          },
          {
            "type": "HardWrComp",
            "description": "Hardware component entries for BOM and scheduling.",
            "appliedTo": "The Script Instance (linked to Parent Beam)"
          },
          {
            "type": "3D Text Label",
            "description": "Visual annotation indicating the assembly name.",
            "appliedTo": "Model Space at the assembly origin"
          }
        ]
      },
      "tokens_used": 10224,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Load Material Densities (check Materials.xml).",
          "2. _bOnInsert Start: Prompt user to 'Select Existing' Collection Entity.",
          "3. Check Selection: If a Collection Entity is selected, set 'Assembly Name'. If nothing selected, report error and erase instance.",
          "4. Select Parent: Prompt user to select 'Main Beam/Panel (Parent)'. Append to _GenBeam[0].",
          "5. Select Children: Prompt user to 'Select Other Beams/Panels (Children)'. Append valid beams to _GenBeam array (excluding duplicates).",
          "6. Validation: Verify _Entity (Collection) and _GenBeam are valid. If not, erase instance.",
          "7. Context Command Check: Check if a Context Menu command triggered the run (e.g., stResetParent, stResetAll).",
          "8. Handle Context Commands: Modify _GenBeam list or update Collection Definition based on the command.",
          "9. Dependency Update: Link script instance to the Parent Beam (_GenBeam[0]). Update 'Parent Entity' property.",
          "10. Geometry Collection: Generate envelope bodies and quaders for all linked beams.",
          "11. Map Extraction: Iterate through sub-scripts in the Collection Definition to extract Drills, Cuts, and Fastener Requests.",
          "12. Drill & Cut Processing: Apply extracted Drills, BeamCuts, and Cuts to the relevant beams based on intersection logic.",
          "13. Fastener Creation: Validate fastener positions against beam geometry. Create SC_Fastener instances or update existing ones.",
          "14. Hardware Compilation: Collect HardWrComp from the assembly and link to Parent Beam. Set Manufacturer and Model.",
          "15. Shopdraw Integration: Update sub-maps on beams with installed fastener entities.",
          "16. Visualization: Draw script identifier text and 3D Label (if enabled)."
        ],
        "conditionalBranches": [
          {
            "condition": "Existing Collection Entity Selection",
            "path1": {
              "name": "Selection Made",
              "steps": [
                "Extract definition name from selected entity.",
                "Set 'Assembly Name' property.",
                "Append entity to script dependencies."
              ]
            },
            "path2": {
              "name": "Selection Cancelled/Empty",
              "steps": [
                "Show message: 'Nothing selected'.",
                "Erase script instance.",
                "Exit execution."
              ]
            }
          },
          {
            "condition": "Context Menu Triggered",
            "path1": {
              "name": "Reselect Parent Beam",
              "steps": [
                "Prompt for new beam.",
                "Swap with or insert at index 0 of _GenBeam.",
                "Recalculate dependencies."
              ]
            },
            "path2": {
              "name": "Reselect All Beams",
              "steps": [
                "Clear _GenBeam array.",
                "Prompt for new Parent (index 0).",
                "Prompt for new Children (index 1+).",
                "Recalculate dependencies."
              ]
            },
            "path3": {
              "name": "Reselect Child Beams",
              "steps": [
                "Keep Parent (index 0), clear rest of array.",
                "Prompt for new Children.",
                "Append valid unique beams."
              ]
            },
            "path4": {
              "name": "Pick New Custom Assembly",
              "steps": [
                "Enable editing of 'Assembly Name' property.",
                "Show Properties Dialog.",
                "Disable editing.",
                "Update underlying Collection Entity definition.",
                "Force geometry regeneration."
              ]
            }
          },
          {
            "condition": "Fastener Intersection Logic",
            "path1": {
              "name": "Hits Female Beam (Only)",
              "steps": [
                "Assign target beam to Female Beam.",
                "Orient fastener coordinate system to Female beam orientation."
              ]
            },
            "path2": {
              "name": "Hits Male Beam (Default)",
              "steps": [
                "Assign target beam to Male Beam (Parent).",
                "Orient fastener coordinate system to Parent beam orientation."
              ]
            }
          },
          {
            "condition": "Show Label Property",
            "path1": {
              "name": "Yes",
              "steps": [
                "Calculate label position (_PtG).",
                "Draw leader line.",
                "Draw text with specified height and color."
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip label drawing logic."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of Materials.xml",
            "errorMessage": "None (Silent fail in provided code, though commented out reportWarning exists)",
            "recovery": "Ensure file exists at _kPathHsbCompany\\Abbund\\Materials.xml to get steel density."
          },
          {
            "check": "Valid Collection Entity Selected on Insert",
            "errorMessage": "Nothing selected",
            "recovery": "Script self-destructs. User must re-run and select a valid Collection Entity."
          },
          {
            "check": "Valid Parent Beam Selected",
            "errorMessage": "Implicit failure if _GenBeam[0] is invalid.",
            "recovery": "Script execution halts or handles null reference (likely self-destruct in TSL environment if critical). User must use 'Reselect Parent' context command."
          },
          {
            "check": "Duplicate Beam Selection",
            "errorMessage": "None (Silent handling)",
            "recovery": "Script checks `if(_GenBeam.find(gb) == -1)` before appending. Duplicate is ignored."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Assembly Type",
            "how": "Context Menu -> Pick New Custom Assembly",
            "effect": "Opens Properties dialog to select new definition. Reloads geometry and parameters."
          },
          {
            "action": "Modify Parent Beam",
            "how": "Context Menu -> Reselect Parent Beam",
            "effect": "Re-runs calculation logic with a new primary beam."
          },
          {
            "action": "Modify Child Beams",
            "how": "Context Menu -> Reselect Child Beams",
            "effect": "Clears secondary beams and allows selecting a new set."
          },
          {
            "action": "Edit Configuration",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'Apply Drills', 'Show Label', 'Text Height', or 'Notes' triggers immediate visual or logical update."
          },
          {
            "action": "Move/Rotate Label",
            "how": "Grip Edit on the Label Point (_PtG)",
            "effect": "Updates the graphical location of the assembly label in the model."
          }
        ]
      },
      "tokens_used": 10524,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# CE_Linker\n\n## Overview\nThis script is used to install and manage parametric sub-assemblies (Collection Entities) onto structural beams. It automates the generation of machining details (drills and cuts) and hardware components based on a selected assembly definition.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script runs in Model Space to apply connections to beams. |\n| Paper Space | No | Not applicable for Paper Space. |\n| Shop Drawing | No | Outputs machining data and hardware lists for drawings, but is not a drawing layout script. |\n\n## Prerequisites\n- **Required Entities**: At least one GenBeam (Beam or Panel). You also need an existing Collection Entity in the model to define the assembly type upon insertion.\n- **Minimum Beam Count**: 1 (Parent Beam).\n- **Required Settings**:\n  - Valid Collection Definitions (.hsc or .hc files) must be available in the project.\n  - `Materials.xml` (Optional): Located at `_kPathHsbCompany\\Abbund\\Materials.xml`. Used for calculating hardware weights.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `CE_Linker.mcr` from the list.\n\n### Step 2: Define Assembly Type\n```\nCommand Line: Select Existing\nAction: Click on an existing Collection Entity in the model to use as a template. \nNote: You must select an existing entity. If you press Esc or click nothing, the script will report \"Nothing selected\" and erase itself.\n```\n\n### Step 3: Select Parent Beam\n```\nCommand Line: Select Main Beam/Panel (Parent)\nAction: Click the primary beam or panel that will host the connection.\n```\n\n### Step 4: Select Child Beams\n```\nCommand Line: Select Other Beams/Panels (Children)\nAction: Click any secondary beams involved in the connection. \nNote: This step is optional. Press Enter to finish if only the parent beam is involved.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Assembly Name | dropdown | *Dynamic* | The name of the Collection Entity definition applied to the beams. |\n| Installation | dropdown | Installed | Determines if the hardware is \"Installed\" or \"Shipped Loose\". Affects BOM and filtering. |\n| Apply Drills | dropdown | Yes | Toggles the generation of drill holes on the beams. |\n| Shopdraw Notes | text | | Custom notes for the shop floor or installer regarding this instance. |\n| Show Label? | dropdown | Yes | Toggles the visibility of the 3D assembly label in the model. |\n| Manufacturer | text | Generic | The name of the hardware manufacturer (e.g., Simpson, MiTek). |\n| Text Height | number | 1.0 | Height of the origin/identifier text in the model (mm). |\n| Label Text Height | number | 25.0 | Height of the assembly label text (mm). |\n| Parent Entity | number | -1 | (Read-only) The Entity number of the parent beam. |\n| Label Text Color | number | 30 | The AutoCAD color index for the label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Reselect Parent Beam | Prompts you to select a new primary beam to replace the current parent. |\n| Reselect Child Beams | Clears current child beams and prompts you to select new ones. |\n| Reselect All Beams | Clears all links and prompts you to select the Parent and Children again from scratch. |\n| Pick New Custom Assembly | Opens the Properties dialog to allow you to select a different Assembly Name (Collection Entity). |\n\n## Settings Files\n- **Filename**: `Materials.xml`\n- **Location**: `_kPathHsbCompany\\Abbund\\Materials.xml`\n- **Purpose**: Provides material density values (specifically for Steel) to calculate the weight of the generated hardware components.\n\n## Tips\n- If you need to change the type of connection after placing the script, use the **Pick New Custom Assembly** option in the right-click menu instead of deleting and re-inserting.\n- To keep your model view clean, set **Show Label?** to \"No\" once you have verified the installation.\n- The script automatically filters duplicate beams; if you accidentally click the same beam twice, it will only be linked once.\n\n## FAQ\n- **Q: The script disappeared immediately after I tried to insert it. Why?**\n  **A:** You likely did not select a Collection Entity when prompted to \"Select Existing\". This script requires you to click an existing assembly definition in the model to know what type of connection to build.\n- **Q: How do I stop the script from drilling holes in my beam?**\n  **A:** Select the script instance, open the Properties Palette, and change **Apply Drills** to \"No\".\n- **Q: Can I use this for single-sided connections?**\n  **A:** Yes. When prompted to \"Select Other Beams/Panels (Children)\", simply press Enter without selecting anything."
      },
      "tokens_used": 7612,
      "error": null
    }
  }
}