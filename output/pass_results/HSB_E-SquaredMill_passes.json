{
  "filename": "HSB_E-SquaredMill.mcr",
  "status": "completed",
  "total_tokens": 45074,
  "processing_time": 349.6985263824463,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8379,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `_kModelSpace` in `TslInst.dbCreate(...)`. It processes 3D geometry (GenBeam, Body, BeamCut) and relies on `el.genBeam()` and intersection logic, which are Model Space operations. No ShopDrawing (sd_*) or Viewport patterns are found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 4725,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select one or more elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "_bOnInsert && (_kExecuteKey == \"\" || !arSCatalogNames.find(_kExecuteKey))",
            "title": null,
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 3,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "Filter",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sFilterBC",
            "type": "PropString",
            "displayName": "Filter beams with beamcode",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "Squared mill",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sBmCodeMill",
            "type": "PropString",
            "displayName": "Beamcode",
            "defaultValue": "KK-05",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dMillingGap",
            "type": "PropDouble",
            "displayName": "Gap",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sAtBeamEnd",
            "type": "PropString",
            "displayName": "Mill at the end of the beam",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sCutBeamAtShortestPoint",
            "type": "PropString",
            "displayName": "Square off beam at shortest point",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6361,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Converts intersections with specific beams (defined by beam code) into square, rectangular milling operations on other beams, rather than following the exact profile of the intersecting beam.",
          "category": "Machining",
          "typicalUseCase": "Used when a timber beam needs to be cut square where it passes through a wall or trimmer element, ensuring a clean rectangular hole or pocket rather than a complex angled cut."
        },
        "parameters": [
          {
            "name": "sSeperator02",
            "technicalDefault": "",
            "businessMeaning": "UI Label/Group Separator for the 'Filter' section. Has no effect on geometry.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None (Read-only UI element)."
          },
          {
            "name": "sFilterBC",
            "technicalDefault": "",
            "businessMeaning": "A list of beam codes to exclude from processing. Any beam with these codes will be ignored by the script.",
            "validRange": "Semicolon-separated string of beam codes (e.g., 'STU;PLT')",
            "unit": "Text",
            "affectsOutput": "Prevents specific beams from being checked or modified."
          },
          {
            "name": "sSeperator01",
            "technicalDefault": "",
            "businessMeaning": "UI Label/Group Separator for the 'Squared mill' section. Has no effect on geometry.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None (Read-only UI element)."
          },
          {
            "name": "sBmCodeMill",
            "technicalDefault": "KK-05",
            "businessMeaning": "The beam code(s) that define the 'milling' or intersecting elements. Beams with this code will trigger a square cut on *other* beams they intersect.",
            "validRange": "Semicolon-separated string of beam codes",
            "unit": "Text",
            "affectsOutput": "Determines which beams drive the geometry of the cuts on surrounding elements."
          },
          {
            "name": "dMillingGap",
            "technicalDefault": "1",
            "businessMeaning": "A clearance allowance added to the square cut. It ensures the resulting hole is slightly larger than the intersecting beam to account for tolerances.",
            "validRange": "0.0 to 10.0 mm (typically)",
            "unit": "mm",
            "affectsOutput": "Increases the width and depth of the rectangular milling cut. The gap is dynamically adjusted based on the angle of intersection."
          },
          {
            "name": "sAtBeamEnd",
            "technicalDefault": "Yes",
            "businessMeaning": "Controls the depth of the milling cut relative to the beam face. 'Yes' applies a deep multiplier (10x) to ensure a through-cut, while 'No' limits the depth to the intersection width.",
            "validRange": "Yes, No",
            "unit": "Selection",
            "affectsOutput": "If 'Yes', the cut penetrates deeply through the beam. If 'No', the cut is shallower (defined by intersection width + gap)."
          },
          {
            "name": "sCutBeamAtShortestPoint",
            "technicalDefault": "Yes",
            "businessMeaning": "If enabled, the script finds the shortest intersection point and creates an additional axial cut to square off the end of the beam at that point.",
            "validRange": "Yes, No",
            "unit": "Selection",
            "affectsOutput": "If 'Yes', the beam length is trimmed (shortened) to create a square end at the intersection. If 'No', the beam retains its length but has a milled pocket."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sBmCodeMill",
            "effect": "Drives the logic for identifying milling beams. If empty or no matches found, the script does nothing.",
            "cascade": [
              "sFilterBC",
              "dMillingGap"
            ]
          },
          {
            "trigger": "dMillingGap",
            "effect": "The calculated gap is divided by the sine of the intersection angle. A larger intersection angle (closer to parallel) significantly increases the actual gap applied.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "BeamCut",
            "description": "A rectangular milling operation (pocket or slot) applied to beams intersecting the 'Milling Beams'. The cut is squared relative to the machined beam's axis.",
            "appliedTo": "Beams within the selected Element that do NOT match the sBmCodeMill (and are not filtered by sFilterBC)."
          },
          {
            "type": "Cut",
            "description": "An axial end cut (saw cut) applied to square off the beam end at the intersection point.",
            "appliedTo": "Beams where 'sCutBeamAtShortestPoint' is 'Yes'."
          }
        ]
      },
      "tokens_used": 9069,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script: Check for execute key or catalog mapping.",
          "2. Configuration: If no execute key is provided, display ShowDynamicDialog for properties (Beamcodes, Gap, Squaring options).",
          "3. Selection: Prompt user to select one or more Elements (PrEntity).",
          "4. Satellite Creation: Iterate through selected elements and attach a new instance of the script to each via dbCreate, passing current properties as a catalog.",
          "5. Master Cleanup: Erase the original 'Master' script instance.",
          "6. [Satellite] Initialization: Load properties from the passed 'MasterToSatellite' map.",
          "7. [Satellite] Classification: Scan all GenBeams within the Element; separate into 'Milling Beams' (by code) and 'Other Beams' (targets), applying Filter exclusions.",
          "8. [Satellite] Intersection Loop: For every Milling Beam, check intersection with every Other Beam.",
          "9. [Satellite] Geometry Calculation: If intersection is valid (Volume > 0, Angle > 0), calculate square pocket dimensions (applying Gap based on angle).",
          "10. [Satellite] Milling Application: Apply BeamCut (static tool) to the target beam.",
          "11. [Satellite] [Conditional] End Squaring: If 'Square off beam at shortest point' is Yes, identify the shortest edge of the new cut and apply an axial Cut.",
          "12. [Satellite] Finalize: Report number of modified cuts and erase the Satellite instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Input Method",
            "path1": {
              "name": "Catalog/Execute Key",
              "steps": [
                "Load properties directly from catalog definition.",
                "Skip ShowDynamicDialog.",
                "Proceed to Selection."
              ]
            },
            "path2": {
              "name": "Manual Run",
              "steps": [
                "Show ShowDynamicDialog to user.",
                "User modifies properties.",
                "Proceed to Selection."
              ]
            }
          },
          {
            "condition": "Beam Role Classification",
            "path1": {
              "name": "Filtered Beam",
              "steps": [
                "Beam Code matches 'Filter' list.",
                "Exclude from all processing."
              ]
            },
            "path2": {
              "name": "Milling Beam",
              "steps": [
                "Beam Code matches 'Beamcode' list.",
                "Treated as the cutting tool.",
                "Generates the milling body geometry."
              ]
            },
            "path3": {
              "name": "Target Beam",
              "steps": [
                "Does not match Filter or Milling codes.",
                "Receives the machining operations (BeamCut/Cut)."
              ]
            }
          },
          {
            "condition": "Intersection Validity",
            "path1": {
              "name": "Valid Intersection",
              "steps": [
                "Angle between beams > Epsilon (prevents divide by zero).",
                "Intersection volume > 0.",
                "Proceed to calculate square mill dimensions and apply tool."
              ]
            },
            "path2": {
              "name": "Invalid/No Intersection",
              "steps": [
                "Beams are parallel or do not touch.",
                "Skip this beam pair.",
                "Continue to next pair."
              ]
            }
          },
          {
            "condition": "Square Off Beam (sCutBeamAtShortestPoint)",
            "path1": {
              "name": "Yes",
              "steps": [
                "After milling, add beam to 'arBmToCut' list.",
                "Analyze new cuts on the beam.",
                "Find cut closest to beam start (shortest point).",
                "Apply axial Cut to square off the beam end."
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip end squaring logic.",
                "Keep beam length but apply pocket."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "(Internal - Instance erased)",
            "recovery": "Script prevents recursive insertion by checking insertCycleCount() > 1 and erasing the instance."
          },
          {
            "check": "Entity Validity",
            "errorMessage": "(Internal - Instance erased)",
            "recovery": "If no valid Element is attached (_Entity.length() == 0), the script erases itself to prevent errors."
          },
          {
            "check": "Intersection Angle",
            "errorMessage": "None (Silent skip)",
            "recovery": "If angle between beams is close to 0 (parallel), calculation is skipped to prevent division by zero errors."
          },
          {
            "check": "Calculated Dimensions",
            "errorMessage": "None (Silent skip)",
            "recovery": "If calculated Width/Length/Height of the cut is < 0.001mm, the tool is not applied (avoids invalid geometry)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Script Properties",
            "how": "N/A",
            "effect": "Script instance is erased after execution (eraseInstance). User cannot modify properties post-insertion. To change settings, the user must delete the generated tools and run the script again."
          },
          {
            "action": "Edit Generated Machining",
            "how": "hsbCAD Beam Tools / Manual Edit",
            "effect": "The script creates static 'BeamCut' and 'Cut' tools. These can be manually deleted or modified via the beam's tool properties after the script has finished."
          }
        ]
      },
      "tokens_used": 9593,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-SquaredMill\n\n## Overview\nThis script creates rectangular (square) milling cuts on timber beams where they intersect with specific \"milling\" beams defined by a beam code. Instead of following the complex angled profile of the intersecting beam, it generates a clean square pocket or through-hole with an optional clearance gap.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script operates on 3D Elements and GenBeams in the model. |\n| Paper Space | No | Not applicable for layout views. |\n| Shop Drawing | No | Does not process 2D drawings or viewports. |\n\n## Prerequisites\n- **Required Entities**: At least two Elements or GenBeams. One to act as the \"Cutter\" (defined by Beamcode) and one to receive the cut.\n- **Minimum Beam Count**: 2 (One intersecting, one being intersected).\n- **Required Settings Files**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-SquaredMill.mcr`\n\n### Step 2: Configure Properties\nA dialog will appear automatically upon insertion. Adjust the following settings before proceeding:\n- **Beamcode**: Enter the beam code of the element that defines the cut size (e.g., the wall or trimmer).\n- **Gap**: Enter the clearance allowance (in mm).\n- **Mill at the end of the beam**: Select \"Yes\" for a deep through-cut or \"No\" for a shallow pocket.\n- **Square off beam at shortest point**: Select \"Yes\" to trim the beam length to the cut, or \"No\" to keep the beam length.\n- **Filter beams with beamcode**: (Optional) Enter beam codes to exclude specific beams from processing.\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or more elements\nAction: Click on the Elements or GenBeams in the Model Space that you wish to process.\n```\n*Note: The script will automatically distinguish between \"Milling Beams\" (cutters) and \"Target Beams\" (receivers) based on the properties set in Step 2.*\n\n### Step 4: Completion\nOnce selected, the script calculates the intersections, applies the milling operations and saw cuts, and then automatically removes itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Squared Mill** | | | *Section Header* |\n| Beamcode | Text | KK-05 | The beam code of the intersecting element that will drive the cut geometry. Beams with this code will act as the \"tool\". |\n| Gap | Number | 1 | Clearance allowance added to the cut size (in mm). Note: The applied gap increases as the intersection angle becomes shallower. |\n| Mill at the end of the beam | Dropdown | Yes | If **Yes**, the cut penetrates deeply through the beam. If **No**, the depth is limited to the intersection width. |\n| Square off beam at shortest point | Dropdown | Yes | If **Yes**, the beam is axially cut (shortened) to create a square end at the intersection. If **No**, the beam retains its length and receives a pocket only. |\n| **Filter** | | | *Section Header* |\n| Filter beams with beamcode | Text | (Empty) | List of beam codes to ignore during processing (e.g., \"STU;PLT\"). Beams matching these codes will not be modified. |\n\n## Right-Click Menu Options\n*None. The script instance is erased immediately after execution.*\n\n## Settings Files\n*None. All configuration is handled via the Properties Panel/Dialog during insertion.*\n\n## Tips\n- **Gap Calculation**: The script divides the Gap by the sine of the intersection angle. For shallow angles (beams running nearly parallel), the gap will expand significantly to ensure clearance. Use small values (e.g., 1mm) for tight fits.\n- **Trimming vs. Pocketing**: Use \"Square off beam at shortest point\" = **Yes** when you want to cut a beam back to a wall face. Use **No** if you just want a slot or hole in the middle of a beam.\n- **Re-running**: Since the script deletes itself after running, to edit the cuts, you must manually delete the generated BeamCut/Cut tools and run the script again.\n\n## FAQ\n- **Q: Why did the script disappear after I selected the elements?**\n  - A: This is normal behavior. The script is a \"generator\" that creates machining tools (BeamCuts) and then removes itself. You can edit the resulting cuts via the beam's properties, but you must re-insert the script to generate new cuts with different settings.\n- **Q: The cut is much larger than the gap I specified. Why?**\n  - A: This occurs when beams intersect at a very sharp angle. To ensure the intersecting beam fits, the script mathematically increases the gap based on the angle. Reduce the `Gap` parameter or check the intersection angle.\n- **Q: Can I use this to square off the end of a beam against a slanted wall?**\n  - A: Yes. Set the \"Beamcode\" to match the wall beam and ensure \"Square off beam at shortest point\" is set to **Yes**. This will cut the target beam perpendicular to its own axis at the point of intersection."
      },
      "tokens_used": 6947,
      "error": null
    }
  }
}