{
  "filename": "HSB_R-GutterForFlatRoof.mcr",
  "status": "completed",
  "total_tokens": 36295,
  "processing_time": 288.31822896003723,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 1,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "16.10.2014",
            "author": "AS",
            "changes": "Pilot version."
          },
          {
            "version": "1.01",
            "date": "12.11.2014",
            "author": "AS",
            "changes": "Add custom action to add and remove sheets."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6400,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script operates directly on 3D Sheet entities and Elements. It uses `PrEntity` to select `Sheet` objects, retrieves their `Element` and `CoordSys`, and physically transforms the Sheets using `sh.transformBy()` and `sh.setSubMap()`. It calculates geometry based on profile vertices (`profShape().getGripVertexPoints()`). There is no usage of ShopDrawing functions (sd_*), Viewports, or 2D layout entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 4537,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"T(\\\"|Select a set of sheets|\\\")\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"T(\\\"|Select start point for distribution|\\\")\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sSeparatorGutter\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Gutter|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dSlopePercentage\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"     |Slope| [%]\",\n      \"defaultValue\": \"2\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Gutter\",\n      \"description\": \"|Sets the slope| [%].\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sSeparatorSymbol\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Symbol|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sLayerSymbol\",\n      \"type\":"
      },
      "tokens_used": 7433,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically calculates and applies a drainage slope to flat roof sheets, transforming their geometry to create a fall and generating a visual slope indicator symbol.",
          "category": "Framing",
          "typicalUseCase": "Used during structural detailing to establish the roof fall (pitch) for flat roof drainage systems, ensuring sheets are rotated correctly towards a drainage point."
        },
        "parameters": [
          {
            "name": "sSeparatorGutter",
            "technicalDefault": "",
            "businessMeaning": "A read-only header in the Properties Palette used to group gutter configuration settings.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None (UI organization only)."
          },
          {
            "name": "dSlopePercentage",
            "technicalDefault": "2",
            "businessMeaning": "The gradient or pitch of the roof drainage, expressed as a percentage of rise over run.",
            "validRange": "0.5 - 5.0",
            "unit": "Percent",
            "affectsOutput": "Calculates the rotation angle (in radians) applied to the selected sheets. Higher values create a steeper roof fall."
          },
          {
            "name": "sSeparatorSymbol",
            "technicalDefault": "",
            "businessMeaning": "A read-only header in the Properties Palette used to group annotation/visual settings.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None (UI organization only)."
          },
          {
            "name": "sLayerSymbol",
            "technicalDefault": "0",
            "businessMeaning": "The CAD layer assignment for the slope arrow and text symbols generated in the model.",
            "validRange": "Any valid layer string",
            "unit": "String",
            "affectsOutput": "Determines the layer property of the drawn PLine and Text entities."
          },
          {
            "name": "dSymbolSize",
            "technicalDefault": "100",
            "businessMeaning": "The scale or size of the directional arrow symbol used to indicate the slope direction.",
            "validRange": "50 - 500",
            "unit": "mm",
            "affectsOutput": "Scales the length of the arrow lines and the offset distance of the text label from the start point."
          },
          {
            "name": "nColorSymbol",
            "technicalDefault": "-1",
            "businessMeaning": "The color of the slope arrow lines.",
            "validRange": "0 - 255 (Index), -1 (ByLayer)",
            "unit": "Color Index",
            "affectsOutput": "Sets the color of the PLine entities representing the arrow."
          },
          {
            "name": "nColorText",
            "technicalDefault": "1",
            "businessMeaning": "The color of the text displaying the slope percentage.",
            "validRange": "0 - 255 (Index)",
            "unit": "Color Index",
            "affectsOutput": "Sets the color of the text entity showing the percentage value."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The Dimension Style used to define the font (Text Style) for the slope label.",
            "validRange": "Existing Dimension Style names",
            "unit": "String",
            "affectsOutput": "Controls the font appearance of the percentage text."
          },
          {
            "name": "dTextSize",
            "technicalDefault": "-1",
            "businessMeaning": "The explicit height for the slope percentage text.",
            "validRange": "0 - 100 (0 or negative uses DimStyle setting)",
            "unit": "mm",
            "affectsOutput": "Sets the text height. If less than or equal to 0, the script ignores this value and uses the height defined in `sDimStyle`."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextSize <= 0",
            "effect": "Text size is overridden by the settings in the selected Dimension Style.",
            "cascade": [
              "sDimStyle"
            ]
          },
          {
            "trigger": "User changes dSlopePercentage",
            "effect": "Recalculates the rotation angle for sheets and updates the text label.",
            "cascade": [
              "Sheet Geometry",
              "Symbol Text"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Sheet Transformation",
            "description": "Rotates and vertically adjusts selected roof sheets to create the specified fall.",
            "appliedTo": "Selected Sheets (Array _Sheet)"
          },
          {
            "type": "3D Symbol (PLine)",
            "description": "Draws a double-headed arrow indicating the direction and high-point of the gutter.",
            "appliedTo": "Model Space (Centered on _Pt0)"
          },
          {
            "type": "3D Text",
            "description": "Draws the slope percentage (e.g., '2%') next to the arrow.",
            "appliedTo": "Model Space (Offset from _Pt0)"
          }
        ]
      },
      "tokens_used": 5621,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch Script (TSL Instance Creation)",
          "Check Insertion Cycle",
          "[Conditional] If insertCycleCount() > 1, Erase Instance and Exit",
          "Check for Execute Key (Catalog Preset)",
          "[Conditional] If no Execute Key, Show Dialog",
          "Prompt User: Select Sheets (PrEntity)",
          "Prompt User: Select Start Point (getPoint)",
          "Assign Instance to Element Groups",
          "Loop Through Selected Sheets",
          "[Inside Loop] Check for Existing Rotation SubMap",
          "[Inside Loop] Invert Previous Rotation if found",
          "[Inside Loop] Project Sheet vertically to start point level",
          "[Inside Loop] Calculate Slope Angle based on Percentage",
          "[Inside Loop] Apply Rotation Transform around Y-axis at Start Point",
          "[Inside Loop] Save Rotation details to Sheet SubMap",
          "Draw Slope Symbol (Lines and Text) in Model Space",
          "Mirror Symbol to show direction on both sides (optional visual)",
          "Finish Execution"
        ],
        "conditionalBranches": [
          {
            "condition": "insertCycleCount() > 1",
            "path1": {
              "name": "Skip Duplicate",
              "steps": [
                "Erase Instance",
                "Return"
              ]
            },
            "path2": {
              "name": "Proceed with Insertion",
              "steps": [
                "Check Execute Key",
                "Show Dialog",
                "Select Entities"
              ]
            }
          },
          {
            "condition": "_kExecuteKey == '' (No Catalog Key)",
            "path1": {
              "name": "Manual Config",
              "steps": [
                "Show Dialog",
                "User enters parameters"
              ]
            },
            "path2": {
              "name": "Catalog Config",
              "steps": [
                "Load Preset Parameters",
                "Skip Dialog"
              ]
            }
          },
          {
            "condition": "User selects Context Menu Trigger",
            "path1": {
              "name": "Add Sheet",
              "steps": [
                "Prompt Select Sheets",
                "Append to _Sheet Array if not duplicate",
                "Recalculate Slopes"
              ]
            },
            "path2": {
              "name": "Remove Sheet",
              "steps": [
                "Prompt Select Sheets",
                "Remove from _Sheet Array",
                "Recalculate Slopes"
              ]
            }
          },
          {
            "condition": "vxGutter.dotProduct(sh.ptCen() - _Pt0) < 0",
            "path1": {
              "name": "Positive Slope Direction",
              "steps": [
                "Apply calculated positive angle"
              ]
            },
            "path2": {
              "name": "Negative Slope Direction",
              "steps": [
                "Invert angle (multiply by -1)",
                "Apply rotation"
              ]
            }
          },
          {
            "condition": "Sheet has SubMap 'Rotation'",
            "path1": {
              "name": "Reset Previous Geometry",
              "steps": [
                "Retrieve Axis, Center, Angle",
                "Invert Angle (-Angle)",
                "Transform Sheet back to original orientation"
              ]
            },
            "path2": {
              "name": "Fresh Sheet",
              "steps": [
                "Skip Rotation Inversion"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Number of selected Sheets > 0",
            "errorMessage": "There are no sheets selected.",
            "recovery": "Script erases itself. User must re-insert and select at least one sheet."
          },
          {
            "check": "First selected Sheet belongs to a valid Element",
            "errorMessage": "Sheet is not part of an element.",
            "recovery": "Script erases itself. User must select sheets that are within an Element (e.g., Wall/ Roof)."
          },
          {
            "check": "Zone 2 Sheets exist for height reference",
            "errorMessage": "None explicitly handled, likely uses 0 or fails.",
            "recovery": "Implicitly handles empty array (likely default height 0 or existing height), but assumes standard Element zoning."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add Sheets to Gutter",
            "how": "Right-click Context Menu -> 'Add sheet'",
            "effect": "Prompts selection, appends new sheets to the calculation set, applies the slope transform to new sheets."
          },
          {
            "action": "Remove Sheets from Gutter",
            "how": "Right-click Context Menu -> 'Remove sheet'",
            "effect": "Prompts selection, removes sheets from calculation set. Note: Removed sheets likely stay in their last transformed state (code doesn't appear to reset them upon removal)."
          },
          {
            "action": "Change Slope Percentage",
            "how": "Properties Palette (OPM)",
            "effect": "Recalculates the rotation angle for all sheets in the set. Re-inverts old rotation and applies new rotation. Updates text label."
          },
          {
            "action": "Change Symbol Appearance",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Layer, Color, Size, and Text Style of the visual arrow and text entities."
          }
        ]
      },
      "tokens_used": 6635,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-GutterForFlatRoof.mcr\n\n## Overview\nThis script automatically calculates and applies a drainage slope to flat roof sheets. It rotates the selected sheets to create a roof fall (pitch) and generates a visual slope indicator arrow with the percentage label.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates on 3D Sheet entities. |\n| Paper Space | No | Not designed for 2D layouts or views. |\n| Shop Drawing | No | Does not generate shop drawing views. |\n\n## Prerequisites\n- **Required Entities:** Flat roof `Sheet` entities.\n- **Element Association:** Selected sheets must belong to a valid Element (e.g., a Roof or Wall element).\n- **Settings:** None required (uses internal defaults).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_R-GutterForFlatRoof.mcr`\n\n### Step 2: Select Sheets\n```\nCommand Line: Select a set of sheets\nAction: Click on the roof sheets you wish to slope. Press Enter to confirm selection.\n```\n\n### Step 3: Define Start Point\n```\nCommand Line: Select start point for distribution\nAction: Click a point in the model to define the high side/pivot point for the gutter slope.\n```\n*Note: The script will automatically calculate the direction of the fall based on the location of the sheets relative to this point.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Gutter Settings** | | | |\n| Slope [%] | Number | 2 | The gradient of the roof drainage (e.g., 2%). |\n| **Symbol Settings** | | | |\n| Layer | Text | 0 | The CAD layer assigned to the arrow and text symbols. |\n| Symbol Size | Number | 100 | The size (scale) of the directional arrow in millimeters. |\n| Color Symbol | Integer | -1 | The color of the arrow lines (-1 = ByLayer). |\n| Color Text | Integer | 1 | The color of the slope percentage text. |\n| DimStyle | Text | _DimStyles | The Dimension Style used to determine the text font. |\n| Text Size | Number | -1 | The height of the text. If set to 0 or negative, the DimStyle height is used. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add sheet | Prompts you to select additional sheets to add to the current slope calculation. |\n| Remove sheet | Prompts you to select sheets to remove from the calculation. *Note: Removed sheets will remain in their last transformed position.* |\n\n## Settings Files\n- **Filename:** None\n- **Location:** N/A\n- **Purpose:** This script relies on user input and Properties Palette configuration; no external XML settings files are required.\n\n## Tips\n- **Updating Slope:** You can change the slope percentage at any time by selecting the script instance in the model and modifying the \"Slope [%]\" value in the Properties Palette. The sheets will automatically update.\n- **Direction:** The script determines the slope direction by comparing the sheet center to the selected start point.\n- **Undo Logic:** The script remembers the rotation it applies. If you add or remove sheets, it correctly handles the geometry of the remaining sheets without double-rotating them.\n\n## FAQ\n- **Q: The script disappeared immediately after I selected the start point.**\n  A: This usually happens if no sheets were selected or if the selected sheets do not belong to a valid Element. Ensure you select Sheets that are part of a constructed Roof or Wall element.\n- **Q: Can I use this on curved roofs?**\n  A: This script is designed for flat roof drainage. Using it on complex curved geometries may produce unexpected results.\n- **Q: How do I change the arrow size?**\n  A: Select the script instance, open the Properties Palette, and adjust the \"Symbol Size\" value under the Symbol category."
      },
      "tokens_used": 5669,
      "error": null
    }
  }
}