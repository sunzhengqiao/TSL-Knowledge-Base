{
  "filename": "hsb_DrawMultiElement.mcr",
  "status": "completed",
  "total_tokens": 38326,
  "processing_time": 310.43833923339844,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "22.08.2012",
            "author": "AJ",
            "changes": "Pilot version"
          },
          {
            "version": "1.02",
            "date": "14.11.2013",
            "author": "AJ",
            "changes": "Bugfix"
          },
          {
            "version": "1.03",
            "date": "21.07.2015",
            "author": "AS",
            "changes": "Correct orientation and position of single element numbers (FogBugzId 1498)."
          },
          {
            "version": "1.04",
            "date": "05.04.2019",
            "author": "AS",
            "changes": "Show the multiwall number."
          },
          {
            "version": "1.05",
            "date": "09.04.2021",
            "author": "AS",
            "changes": "Normalize vectors before using them.  Vectors are stored as points in the MapX and are in drawing units."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7125,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses gp.collectEntities(..., _kModel) to gather elements. It draws 3D geometry (envelopeBody) and text using a Display dp. It does not contain #Type E or _Viewport usage typical of ShopDrawing scripts. It visualizes grouped Elements relative to a point picked in the model."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "The script requires Elements in the Model Space that contain MapX data with the key 'hsb_Multiwall'.",
          "requiredSettings": [
            "MapX entry 'hsb_Multiwall' on Elements",
            "Properties: Vertical offset, Horizontal offset, Dimension Style, Grouping format"
          ]
        }
      },
      "tokens_used": 3910,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Pick a point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dVerticalOffset",
            "type": "PropDouble",
            "displayName": " Vertical offset between panels",
            "defaultValue": "4000",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dHorizontalOffset",
            "type": "PropDouble",
            "displayName": " Horizontal offset between panels",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimension Style",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dNewTextHeight",
            "type": "PropDouble",
            "displayName": "Text Height",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Text Color",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "groupingFormat",
            "type": "PropString",
            "displayName": "|Grouping format|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "|Specifies the format for grouping the multi-elements|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "../|Refresh all Multielements|",
            "handler": "strChangeEntity",
            "action": "Recalculates and re-imports all elements containing 'hsb_Multiwall' MapX data.",
            "alsoTriggeredBy": "Command 'update Multielements'"
          },
          {
            "menuItem": "--------------------------------------",
            "handler": "strSeparator",
            "action": "Visual separator",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Delete Multiwalls|",
            "handler": "strDeleteEntity",
            "action": "Removes the 'hsb_Multiwall' MapX data from all elements, effectively un-grouping them.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6846,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Visualizes a 3D schematic layout of timber wall elements grouped as 'multiwalls', arranging them in a stacked or tabular view for verification.",
          "category": "Visualization",
          "typicalUseCase": "Used during the design phase to preview how individual wall panels (elements) are grouped together into larger transport or assembly units (multiwalls), checking their sequence and spatial arrangement."
        },
        "parameters": [
          {
            "name": "dVerticalOffset",
            "technicalDefault": "4000",
            "businessMeaning": "The vertical distance placed between successive multiwall panels in the generated view.",
            "validRange": "1000 - 10000",
            "unit": "mm",
            "affectsOutput": "Increases the vertical gap between the stacked wall representations, preventing visual overlap or accommodating taller walls."
          },
          {
            "name": "dHorizontalOffset",
            "technicalDefault": "0",
            "businessMeaning": "The horizontal spacing applied between distinct groups of multiwalls.",
            "validRange": "0 - 5000",
            "unit": "mm",
            "affectsOutput": "Shifts subsequent groups of walls to the right (or left) relative to the previous group. Used when the 'groupingFormat' creates distinct columns."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The specific drafting standard applied to text labels (element numbers, multiwall IDs).",
            "validRange": "Names of existing Dimension Styles in the CAD template",
            "unit": "String",
            "affectsOutput": "Alters the font, arrow style, and global scale settings for all text annotations generated by the script."
          },
          {
            "name": "dNewTextHeight",
            "technicalDefault": "-1",
            "businessMeaning": "The explicit height for annotation text.",
            "validRange": "50 - 500 (or -1 to use default)",
            "unit": "mm",
            "affectsOutput": "Resizes the text labels. If set to -1, the height is dictated by the 'sDimStyle'."
          },
          {
            "name": "nColor",
            "technicalDefault": "-1",
            "businessMeaning": "The color index used for the text annotations.",
            "validRange": "1 - 255 (CAD Color Index) or -1",
            "unit": "Index",
            "affectsOutput": "Changes the color of the multiwall numbers and element numbers for better visibility contrast."
          },
          {
            "name": "groupingFormat",
            "technicalDefault": "",
            "businessMeaning": "A logic string used to sort and categorize multiwalls into visual clusters (e.g., by floor, phase, or elevation).",
            "validRange": "hsbCAD format strings (e.g., \"%Elevation%\", \"%Zone%\")",
            "unit": "String",
            "affectsOutput": "Triggers the script to organize walls into separate columns/rows based on the attribute, resetting the drawing origin for each new group."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "groupingFormat is not empty",
            "effect": "Activates the horizontal shifting logic using dHorizontalOffset between groups.",
            "cascade": [
              "dHorizontalOffset"
            ]
          },
          {
            "trigger": "dNewTextHeight == -1",
            "effect": "Text display relies on sDimStyle for height configuration.",
            "cascade": [
              "sDimStyle"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Geometry",
            "description": "3D Envelopes of the constituent GenBeams, transformed to the visualization coordinate system.",
            "appliedTo": "All Elements found with 'hsb_Multiwall' MapX data."
          },
          {
            "type": "Annotation Text",
            "description": "Labels for Multiwall Numbers, Element Numbers, and Group Headers.",
            "appliedTo": "The Model Space at the insertion point and calculated offsets."
          }
        ]
      },
      "tokens_used": 6221,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script executed (Insert or Recalc)",
          "[Insert Mode] Check if insertCycleCount > 1",
          "[Insert Mode] If true, eraseInstance() and return (Prevent duplicate instances)",
          "[Insert Mode] Collect all Entities of type 'Element' from ModelSpace",
          "[Insert Mode] Filter elements: Keep only those with valid 'hsb_Multiwall' MapX data",
          "[Insert Mode] Store filtered elements in internal _Element array",
          "[Insert Mode] Prompt user for insertion point (getPoint)",
          "[Insert Mode] Store point in _Pt0 and return (Wait for recalc/exec)",
          "[Execution/Recalc] Initialize display properties (Dimension Style, Text Height, Color)",
          "Parse _Element array to extract unique Multiwall Numbers and Grouping Keys",
          "Sort unique Multiwall Numbers alphabetically",
          "Sort Multiwalls by Grouping Keys (secondary sort)",
          "Sort Multiwalls by the first Multiwall Number in each group (tertiary sort)",
          "Initialize Coordinate System (cs) at user picked point (_Pt0)",
          "Iterate through sorted Multiwall list",
          "Check for Grouping Key change (if groupingFormat is used)",
          "[Group Change] Shift Coordinate System horizontally by previous group width + Horizontal Offset",
          "[Group Change] Reset group width tracker to 0",
          "[Group Change] Draw Group Label (Text)",
          "Shift Coordinate System vertically downwards by Vertical Offset",
          "Draw Multiwall Number (Text)",
          "Find all constituent Elements belonging to the current Multiwall",
          "Loop through constituent Elements",
          "Retrieve Element's stored Coordinate System from MapX (Position & Orientation)",
          "Calculate transformation from Element local space to Multiwall visualization space",
          "Draw Element's GenBeams (envelopes) at calculated position",
          "Draw Element Number text at calculated position",
          "Calculate bounding box size (X and Y) of the drawn Multiwall",
          "Update current group width if this Multiwall is wider than previous ones in group",
          "Finished (Displays visualization in ModelSpace)"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Mode: Insert vs Recalc/Update",
            "path1": {
              "name": "Insert Mode",
              "steps": [
                "Cycle Check (prevent re-run on same insert)",
                "Collect Elements with MapX",
                "Pick Insertion Point",
                "Save State and Exit"
              ]
            },
            "path2": {
              "name": "Recalc/Execution Mode",
              "steps": [
                "Check Context Menu Triggers (Refresh/Delete)",
                "Sort and Group Data",
                "Draw Geometry"
              ]
            }
          },
          {
            "condition": "Context Menu Selection",
            "path1": {
              "name": "Refresh all Multielements",
              "steps": [
                "Clear internal element list",
                "Re-collect all Elements with 'hsb_Multiwall' MapX",
                "Proceed to Draw"
              ]
            },
            "path2": {
              "name": "Delete Multiwalls",
              "steps": [
                "Find all Elements with 'hsb_Multiwall' MapX",
                "Remove 'hsb_Multiwall' MapX entry from Elements",
                "Clear internal element list",
                "Skip drawing (Script effectively clears data)"
              ]
            },
            "path3": {
              "name": "Standard Recalc",
              "steps": [
                "Use existing collected elements",
                "Proceed to Draw"
              ]
            }
          },
          {
            "condition": "Grouping Format Usage",
            "path1": {
              "name": "Grouping Enabled (groupingFormat not empty)",
              "steps": [
                "Evaluate grouping key for each Multiwall",
                "Sort by Grouping Key",
                "Shift coordinate system horizontally for new groups",
                "Apply dHorizontalOffset"
              ]
            },
            "path2": {
              "name": "Grouping Disabled (Default)",
              "steps": [
                "Treat all Multiwalls as single list",
                "Stack vertically only (No horizontal shift)",
                "Ignore dHorizontalOffset"
              ]
            }
          },
          {
            "condition": "Text Height Configuration",
            "path1": {
              "name": "Explicit Height",
              "steps": [
                "Use value from dNewTextHeight property"
              ]
            },
            "path2": {
              "name": "Default Height",
              "steps": [
                "dNewTextHeight is -1",
                "Use height defined in sDimStyle"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of 'hsb_Multiwall' MapX data",
            "errorMessage": "No output generated. Script requires elements to have specific metadata.",
            "recovery": "Run the external process/tool that assigns 'hsb_Multiwall' data to elements, or use 'Refresh' context menu if data was just added."
          },
          {
            "check": "MapX Vector validity",
            "errorMessage": "N/A (Handled internally)",
            "recovery": "Script normalizes vectors stored in MapX (v1.05) to ensure valid orientation calculations."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Offsets (Vertical/Horizontal)",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Updates the spacing between drawn panels instantly on recalc."
          },
          {
            "action": "Change Text Appearance (Style, Height, Color)",
            "how": "OPM",
            "effect": "Updates labels for Multiwall numbers, Element numbers, and Group headers."
          },
          {
            "action": "Refresh Data",
            "how": "Right-click Context Menu -> Refresh all Multielements",
            "effect": "Re-scans the model for Elements with 'hsb_Multiwall' data and redraws the schema. Useful if new multiwalls were created in the model."
          },
          {
            "action": "Delete Multiwalls Data",
            "how": "Right-click Context Menu -> Delete Multiwalls",
            "effect": "Removes the 'hsb_Multiwall' MapX tag from all elements in the model, effectively 'ungrouping' them and clearing the script visualization."
          },
          {
            "action": "Move Visualization",
            "how": "Grip Edit / Move Command on the script instance",
            "effect": "Relocates the entire visualization schema to the new insertion point."
          }
        ]
      },
      "tokens_used": 8075,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_DrawMultiElement.mcr\n\n## Overview\nThis script visualizes timber wall elements grouped as 'multiwalls' in a 3D schematic layout. It arranges panels in a stacked or tabular view, allowing you to verify their sequence and spatial arrangement for transport or assembly.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This is the primary environment for the script. |\n| Paper Space | No | Not supported in layout views. |\n| Shop Drawing | No | This is a model visualization tool, not a drawing generator. |\n\n## Prerequisites\n- **Required Entities**: Elements (Walls) that contain internal MapX data with the key `hsb_Multiwall`.\n- **Minimum Beam Count**: 1 (Though typically used for multiple grouped elements).\n- **Required Settings**: None required; however, the external process creating the 'multiwalls' must have tagged the elements correctly.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_DrawMultiElement.mcr` from the list.\n\n### Step 2: Place Visualization\n```\nCommand Line: |Pick a point|\nAction: Click in the Model Space to define the origin (top-left usually) for the multiwall layout.\n```\n*Note: The script will automatically search the model for elements tagged as multiwalls and draw them relative to this point.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Vertical offset between panels | number | 4000 | The vertical distance (in mm) placed between successive multiwall panels in the view. |\n| Horizontal offset between panels | number | 0 | The horizontal spacing (in mm) applied between distinct groups of multiwalls (used when a Grouping format is set). |\n| Dimension Style | dropdown | _DimStyles | The drafting standard used to determine text font and arrow style for labels. |\n| Text Height | number | -1 | The explicit height for text labels. Set to -1 to use the height defined in the Dimension Style. |\n| Text Color | number | -1 | The CAD Color Index (1-255) for the text labels. Set to -1 to use the default layer color. |\n| Grouping format | text | | A logic string used to sort multiwalls into visual clusters (e.g., `%Elevation%` or `%Zone%`). If empty, all walls are stacked in a single list. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Refresh all Multielements | Re-scans the entire model for Elements with 'hsb_Multiwall' data and redraws the schematic. Use this if new multiwalls were added or updated. |\n| Delete Multiwalls | Removes the 'hsb_Multiwall' internal data tag from all elements, effectively un-grouping them and clearing the visualization. |\n\n## Settings Files\n- No specific settings files are used by this script. It relies on OPM (Object Property Model) properties for configuration.\n\n## Tips\n- **Organizing by Floor**: To view walls separated by floor or phase, enter the attribute name (e.g., `%Elevation%`) into the **Grouping format** property. The script will create a new column for each elevation.\n- **Adjusting Layout**: If walls overlap visually, increase the **Vertical offset between panels**. If groups are too close, increase the **Horizontal offset**.\n- **Moving the View**: You can use the standard AutoCAD `MOVE` command or grip-edit the script instance anchor point to relocate the entire visualization schema.\n\n## FAQ\n- **Q: I inserted the script, but nothing is visible.**\n  - A: Ensure your wall elements actually contain the 'hsb_Multiwall' internal data. This data is usually applied by a separate multiwall generation tool. Try right-clicking and selecting \"Refresh all Multielements\".\n- **Q: How do I change the size of the text labels?**\n  - A: You can either set an explicit **Text Height** in the properties, or set it to -1 and change the text size within your selected **Dimension Style**.\n- **Q: What does the 'Horizontal offset' do?**\n  - A: It only creates space between *groups* of walls. You must define a **Grouping format** (like `%Phase%`) for the horizontal offset to take effect; otherwise, all walls stack in a single vertical column."
      },
      "tokens_used": 6149,
      "error": null
    }
  }
}