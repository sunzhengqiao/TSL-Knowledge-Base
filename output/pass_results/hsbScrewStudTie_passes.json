{
  "filename": "hsbScrewStudTie.mcr",
  "status": "completed",
  "total_tokens": 51579,
  "processing_time": 335.86855459213257,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8967,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses _kModelSpace in the tslNew.dbCreate() call. It uses Element and GenBeam entities for construction logic, with no references to sd_ prefixes, Viewport, or #Type E entities used in ShopDrawing environments."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space containing an Element with T-connections (studs and plates) or manual selection of two beams.",
          "requiredSettings": [
            "ScrewCatalog.xml (Expected in company folder \\tsl\\settings\\ or installation path Content\\General\\TSL\\Settings\\)"
          ]
        }
      },
      "tokens_used": 5325,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getString\",\n        \"promptOriginal\": \"|Select insertion mode| => [|Element|/|Beams|] \",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": [\n      {\n        \"prompt\": \"|Select insertion mode| => [|Element|/|Beams|] \",\n        \"options\": [\n          \"Element\",\n          \"Beams\"\n        ]\n      }\n    ]\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sPainter\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Painter\",\n      \"defaultValue\": \"<Disabled>\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Painter Definitions (Dynamic)\",\n        \"<Disabled>\"\n      ],\n      \"category\": \"Filter\",\n      \"description\": \"A filter which will use painter definitions\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sPosition\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Position\",\n      \"defaultValue\": \"Top plate\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Top plate\",\n        \"Bottom plate\",\n        \"Both plates\"\n      ],\n      \"category\": \"Ruleset\",\n      \"description\": \"Defines the position of the screws\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sDistribution\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Distribution\",\n      \"defaultValue\": \"Every Stud\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Every Stud\",\n        \"Every odd Stud\",\n        \"Every even Stud\"\n      ],\n      \"category\": \"Ruleset\",\n      \"description\": \"Defines the distribution of the screws\",\n      \"condition\": \"Visible when nMode == 1 (Element mode)\"\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sOpeningPos\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Opening rule\",\n      \"defaultValue\": \"Screws in King studs, none in cripples\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Screws in King studs, none in cripples\",\n        \"Screws in King stud and cripples\",\n        \"No rule for openings\"\n      ],\n      \"category\": \"Ruleset\",\n      \"description\": \"Defines the positioning at openings. The first two rules will always at screws at openings\",\n      \"condition\": \"Visible when nMode == 1 (Element mode)\"\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sDrill\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Drill\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": \"Drill\",\n      \"description\": \"Defines if Drill should be applied\",\n      \"note\": \"Index is 6 if nMode < 2 (Insert/Element mode)\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dDiameterDrill\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Diameter\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"category\": \"Drill\",\n      \"description\": \"Defines the Diameter of Drill\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dLengthDrill\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Depth\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"category\": \"Drill\",\n      \"description\": \"Defines the Length of the Drill\"\n    },\n    {\n      \"index\": \"Dynamic (nStringIndex++)\",\n      \""
      },
      "tokens_used": 9694,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically inserts stud tie screws (center stud locks) at T-connections between wall studs and top/bottom plates based on defined rulesets.",
          "category": "Hardware",
          "typicalUseCase": "Reinforcing T-connections in timber frame walls to resist uplift or shear forces, typically used in floor-to-wall or roof-to-wall connections."
        },
        "parameters": [
          {
            "name": "sPainter",
            "technicalDefault": "\"<Disabled>\"",
            "businessMeaning": "Filters which studs receive the screw based on a predefined Painter definition (e.g., only specific wall types or load-bearing walls).",
            "validRange": "List of available Painter Definitions or '<Disabled>'",
            "unit": "N/A",
            "affectsOutput": "Controls the selection of 'Male' beams (studs). If disabled, all connected studs in the element are considered."
          },
          {
            "name": "sPosition",
            "technicalDefault": "\"Top plate\"",
            "businessMeaning": "Specifies whether the screw connects the stud to the top plate, bottom plate, or both.",
            "validRange": "Top plate, Bottom plate, Both plates",
            "unit": "N/A",
            "affectsOutput": "Determines the direction of the screw calculation relative to the stud (upward for top plate, downward for bottom plate)."
          },
          {
            "name": "sDistribution",
            "technicalDefault": "\"Every Stud\"",
            "businessMeaning": "Controls the frequency of screw insertion along the wall line.",
            "validRange": "Every Stud, Every odd Stud, Every even Stud",
            "unit": "N/A",
            "affectsOutput": "Reduces the number of screws generated. 'Every Stud' installs at every T-connection; others skip specific studs."
          },
          {
            "name": "sOpeningPos",
            "technicalDefault": "\"Screws in King studs, none in cripples\"",
            "businessMeaning": "Defines logic for placing screws around window/door openings.",
            "validRange": "Screws in King studs, none in cripples; Screws in King stud and cripples; No rule for openings",
            "unit": "N/A",
            "affectsOutput": "Suppresses screws on 'cripple' studs (shorter studs above/below openings) unless explicitly enabled, or places screws on King studs only."
          },
          {
            "name": "sDrill",
            "technicalDefault": "\"No\"",
            "businessMeaning": "Enables or disables the creation of a clearance drill hole through the stud for the screw.",
            "validRange": "No, Yes",
            "unit": "N/A",
            "affectsOutput": "If 'Yes', creates a Drill machining entity in the stud. If 'No', the screw is modeled but no drill geometry is added (or assumes self-drilling)."
          },
          {
            "name": "dDiameterDrill",
            "technicalDefault": "0",
            "businessMeaning": "The diameter of the clearance hole to be drilled in the stud.",
            "validRange": "Typically screw diameter + 1mm to 3mm (e.g., 5mm - 15mm)",
            "unit": "mm",
            "affectsOutput": "Adjusts the diameter of the Drill entity geometry."
          },
          {
            "name": "dLengthDrill",
            "technicalDefault": "0",
            "businessMeaning": "The depth of the drill hole into the stud.",
            "validRange": "Stud width (e.g., 45mm - 150mm depending on timber thickness)",
            "unit": "mm",
            "affectsOutput": "Adjusts the depth of the Drill entity geometry."
          },
          {
            "name": "sManufacturer",
            "technicalDefault": "First entry from ScrewCatalog.xml",
            "businessMeaning": "Selects the specific brand of stud tie system (e.g., Simpson, Mitek, Heco).",
            "validRange": "Manufacturers listed in ScrewCatalog.xml",
            "unit": "N/A",
            "affectsOutput": "Filters the available 'Families' and specific Screw parameters."
          },
          {
            "name": "sFamily",
            "technicalDefault": "First entry for selected Manufacturer",
            "businessMeaning": "Selects the specific product series or model within the manufacturer's range.",
            "validRange": "Product Families listed in ScrewCatalog.xml for selected Manufacturer",
            "unit": "N/A",
            "affectsOutput": "Filters the available Lengths and Loads specific geometric properties (head size, thread diameter)."
          },
          {
            "name": "sLength",
            "technicalDefault": "First entry for selected Family",
            "businessMeaning": "The physical length of the screw to be inserted.",
            "validRange": "Standard lengths from catalog (e.g., 60mm - 300mm)",
            "unit": "mm",
            "affectsOutput": "Sets the length of the generated screw geometry."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "Catalog dependent",
            "businessMeaning": "The material finish of the screw (e.g., Galvanized, Stainless Steel, BZN coated).",
            "validRange": "Materials defined in ScrewCatalog.xml",
            "unit": "N/A",
            "affectsOutput": "Sets the material property for BOM/list output and potentially color display."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sManufacturer is changed",
            "effect": "Updates the list of available Families, Materials, and Lengths.",
            "cascade": [
              "sFamily",
              "sLength",
              "sMaterial"
            ]
          },
          {
            "trigger": "sFamily is changed",
            "effect": "Updates the list of available valid Lengths for that product line.",
            "cascade": [
              "sLength"
            ]
          },
          {
            "trigger": "nMode changes from 'Beams' (2) to 'Element' (1)",
            "effect": "Enables properties related to batch processing rules.",
            "cascade": [
              "sDistribution",
              "sOpeningPos"
            ]
          },
          {
            "trigger": "sDrill set to 'No'",
            "effect": "Disables functionality of Drill dimensions.",
            "cascade": [
              "dDiameterDrill",
              "dLengthDrill"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam/MetalPart",
            "description": "A 3D representation of the stud tie screw, generated as a separate TSL instance connecting the stud and the plate.",
            "appliedTo": "Between selected Studs (Male) and Plates (Female)."
          },
          {
            "type": "Drill",
            "description": "A cylindrical hole through the stud to accommodate the screw shank.",
            "appliedTo": "The Stud (Male beam)."
          }
        ]
      },
      "tokens_used": 9228,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Start: Load Constants and check for 'hsbTSLDebugController'.",
          "2. Load Settings: Read ScrewCatalog.xml from Company folder (fallback to Install path).",
          "3. Validation: Check if Manufacturer data exists. If not, report error and erase instance.",
          "4. Mode Detection: Retrieve internal 'mode' state (0=Insert, 1=Element, 2=Beams).",
          "5. Auto-Detection (Insert Phase): If mode is 0 and an Element is detected, auto-switch to Element mode (mode=1).",
          "6. User Prompt (Insert Phase): Ask user for insertion mode: 'Element' or 'Beams'.",
          "7. Property Initialization: Configure property palette based on selected mode.",
          "8. Catalog Selection: User selects Manufacturer, Family, Length, and Material properties (often via dynamic dialog).",
          "9. Execution Branch:",
          "   A. Element Mode (nMode=1): Identify studs and plates within the element. Apply filter/distribution rules.",
          "   B. Beams Mode (nMode=2): Identify the single Stud (Male) and Plate (Female) connection.",
          "10. Geometry Generation:",
          "    A. Element Mode: Create temporary Screw instances (nMode=2) at valid locations. Erase the Manager instance.",
          "    B. Beams Mode: Generate the 3D Screw body and apply Drill operation to the stud. Keep instance in model."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Mode Selection (Command Line Prompt)",
            "path1": {
              "name": "Element Mode (Batch)",
              "steps": [
                "User selects 'Element' or presses Enter.",
                "Properties 'Distribution' and 'Opening rule' become visible.",
                "Script filters all beams in the selected Element.",
                "Finds T-connections between Studs (vertical) and Plates (horizontal).",
                "Applies 'Painter' filter if enabled.",
                "Applies 'Distribution' rule (Every/Odd/Even).",
                "Applies 'Opening rule' (King studs vs Cripples).",
                "Generates individual Screw instances (mode 2) for each valid connection.",
                "Self-destructs (eraseInstance) to leave only the generated screws."
              ]
            },
            "path2": {
              "name": "Beams Mode (Single)",
              "steps": [
                "User selects 'Beams'.",
                "Property 'Position' becomes Read-Only (determined by selection).",
                "Properties 'Distribution' and 'Opening rule' are hidden.",
                "Script requires exactly 2 beams (Stud and Plate).",
                "Calculates screw geometry based on the specific intersection.",
                "Creates the single Screw instance (mode 2).",
                "Instance remains in model for editing."
              ]
            }
          },
          {
            "condition": "Opening Rule Logic (Element Mode only)",
            "path1": {
              "name": "Screws in King studs, none in cripples",
              "steps": [
                "Script identifies openings in the wall.",
                "Calculates King Studs (longer studs at opening edges).",
                "Only places screws on King Studs.",
                "Suppresses screws on cripple studs (shorter infill studs)."
              ]
            },
            "path2": {
              "name": "Screws in King stud and cripples",
              "steps": [
                "Script identifies openings.",
                "Places screws on both King Studs and Cripple studs."
              ]
            },
            "path3": {
              "name": "No rule for openings",
              "steps": [
                "Treats all studs uniformly regardless of openings.",
                "Standard distribution rules apply."
              ]
            }
          },
          {
            "condition": "Drill Option",
            "path1": {
              "name": "Drill = Yes",
              "steps": [
                "Reads 'Diameter' and 'Depth' properties.",
                "Creates a Drill machining entity in the Stud (Male beam)."
              ]
            },
            "path2": {
              "name": "Drill = No",
              "steps": [
                "Skips Drill creation.",
                "Only Screw body is generated."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "ScrewCatalog.xml Availability",
            "errorMessage": "Could not find manufacturer data. Tool will be deleted.",
            "recovery": "Ensure ScrewCatalog.xml exists in \\Company\\TSL\\Settings\\ or \\Install\\Content\\General\\TSL\\Settings\\."
          },
          {
            "check": "Beam Selection (Beams Mode)",
            "errorMessage": "Implicit in failure to find geometry or create screw.",
            "recovery": "Ensure exactly two beams (one stud, one plate) forming a T-connection are selected or linked to the instance."
          },
          {
            "check": "Valid T-Connection",
            "errorMessage": "No valid intersection found (Logic filter).",
            "recovery": "Ensure the stud intersects the plate properly perpendicularly."
          },
          {
            "check": "Dimensions (Thread/Head)",
            "errorMessage": "Geometry generation fails silently or produces zero-length body if parameters are invalid.",
            "recovery": "Select a valid Length/Manufacturer combination from the catalog."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Manufacturer / Family",
            "how": "OPM (Object Properties Palette) Dropdowns",
            "effect": "Updates the screw geometry to match new catalog dimensions (Head size, Thread diameter, Length)."
          },
          {
            "action": "Modify Ruleset (Element Mode Manager)",
            "how": "OPM or Right-Click Context Menu -> Properties",
            "effect": "Triggers a recalculation. Adds or removes child screw instances based on new Distribution or Opening rules."
          },
          {
            "action": "Enable/Change Drill",
            "how": "OPM (Drill Category)",
            "effect": "Adds or removes Drill machining operations on the connected studs."
          },
          {
            "action": "Move Wall/Studs",
            "how": "Grip Edit / Move Command in CAD",
            "effect": "Attached screws (mode 2) move with the beams. The Element Manager (mode 1) regenerates screws if the wall configuration changes."
          }
        ]
      },
      "tokens_used": 10923,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbScrewStudTie.mcr\n\n## Overview\nAutomates the insertion of stud tie screws (center stud locks) at T-connections between wall studs and top or bottom plates. It supports batch processing for entire wall elements using rulesets or manual placement for individual beam connections.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Intended for use in the 3D model. |\n| Paper Space | No | Not supported in layout views. |\n| Shop Drawing | No | Not used for generating 2D drawings directly. |\n\n## Prerequisites\n- **Required Entities**: An `Element` (pre-defined wall) or two `GenBeams` (Stud and Plate).\n- **Minimum Beam Count**: 2 (One Stud and one Plate intersecting).\n- **Required Settings**: `ScrewCatalog.xml` (Must be present in `\\\\Company\\TSL\\Settings\\` or the installation `Content\\General\\TSL\\Settings\\` folder).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT` â†’ Select `hsbScrewStudTie.mcr` from the list.\n\n### Step 2: Select Insertion Mode\n```\nCommand Line: Select insertion mode => [Element/Beams]\nAction:\n  - Press ENTER to select [Element] (Batch mode for a whole wall).\n  - Type \"B\" and press ENTER to select [Beams] (Manual mode for a single connection).\n```\n\n### Step 3: Select Geometry\n- **If Element Mode:** Click on the Wall Element containing the studs and plates you wish to process.\n- **If Beams Mode:** Click on the **Stud** (vertical beam), then click on the **Plate** (horizontal beam) to define the connection point.\n\n### Step 4: Configure Properties\nUse the **Properties Palette** (Ctrl+1) to select the Screw Manufacturer, Family, and Ruleset. The screw geometry will update automatically upon selection.\n\n### Step 5: Finish\n- **Element Mode:** The script generates screws at all valid locations and then removes itself from the model (only the screws remain).\n- **Beams Mode:** The screw instance remains in the model, attached to the two beams.\n\n## Properties Panel Parameters\n\n### Catalog Selection\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Manufacturer | Dropdown | (First in XML) | Select the screw brand (e.g., Simpson, Mitek). |\n| Family | Dropdown | (First in XML) | Select the specific product model. |\n| Length | Dropdown | (First in XML) | Select the physical length of the screw (mm). |\n| Material | Dropdown | (Catalog Dependent) | Select the material finish (e.g., Galvanized, Stainless). |\n\n### Ruleset (Element Mode Only)\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Position | Dropdown | Top plate | Set connection to Top plate, Bottom plate, or Both plates. |\n| Distribution | Dropdown | Every Stud | Pattern: Every Stud, Every odd Stud, or Every even Stud. |\n| Opening rule | Dropdown | Screws in King studs... | Logic for windows/doors: King studs only, King + Cripples, or No rule. |\n\n### Drill Options\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Drill | Dropdown | No | Enable or disable drilling a hole in the stud. |\n| Diameter | Number | 0 | Diameter of the drill hole (mm). |\n| Depth | Number | 0 | Depth of the drill hole (mm). |\n\n### Filter\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Painter | Dropdown | <Disabled> | Filter studs based on a Painter definition (e.g., only load-bearing walls). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the screw position and geometry if beams have moved or properties changed. |\n| Properties | Opens the Properties Palette to edit parameters. |\n| Erase | Removes the screw instance. |\n\n## Settings Files\n- **Filename**: `ScrewCatalog.xml`\n- **Location**: `\\Company\\TSL\\Settings\\` or `Content\\General\\TSL\\Settings\\`\n- **Purpose**: Contains all geometric data for available screw manufacturers, families, and dimensions.\n\n## Tips\n- **Element Mode Behavior:** When using Element mode, the script acts as a \"Manager\". It creates the individual screws and then deletes itself. To change settings later, you typically need to erase the generated screws and run the script again, or edit the screws individually if they are independent instances.\n- **Drill Holes:** If you enable drilling, ensure the Diameter is slightly larger than the screw shank to avoid clashes.\n- **Openings:** Use the \"Opening rule\" to prevent unnecessary screws in cripple studs above windows, saving material and time.\n\n## FAQ\n- **Q: Why can't I see the \"Distribution\" or \"Opening rule\" properties?**\n  **A:** These are only available in **Element Mode**. If you are in **Beams Mode**, they are hidden because the placement is manually determined by your selection.\n  \n- **Q: Why did the script disappear immediately after I ran it?**\n  **A:** You likely used **Element Mode**. This is normal behavior; the script finishes its job (placing screws) and removes itself to keep the model clean. The screws should remain in the wall.\n\n- **Q: The tool says \"Could not find manufacturer data\". What do I do?**\n  **A:** The `ScrewCatalog.xml` file is missing or misplaced. Ask your CAD Manager to ensure it is located in the correct Company or Install settings folder."
      },
      "tokens_used": 7442,
      "error": null
    }
  }
}