{
  "filename": "hsb_AreaTakeOff.mcr",
  "status": "completed",
  "total_tokens": 38521,
  "processing_time": 214.3094871044159,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "23.07.2010",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "Release Version"
          },
          {
            "version": "1.1",
            "date": "26.07.2010",
            "author": "",
            "changes": "Export to DBase Implement"
          },
          {
            "version": "1.2",
            "date": "06.08.2010",
            "author": "",
            "changes": "Remove opening export"
          }
        ],
        "settingsFiles": [
          "Inv_Sheet.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 6059,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to select ElementWall entities and performs geometric calculations (PlaneProfile, unionWith) on their 3D outlines. It uses Display dp for visualization and assigns the instance to an ElementFloorGroup. No usage of sd_* classes, Viewports, or #Type E exports."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing Wall Elements",
          "requiredSettings": [
            "Inv_Sheet.xml"
          ]
        }
      },
      "tokens_used": 4821,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Please select Walls",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDispRep",
            "type": "PropString",
            "displayName": "Show in Disp Rep",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sLineType",
            "type": "PropString",
            "displayName": "Line Type",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_LineTypes",
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dim style",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color Foundation Lines",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "psExtType",
            "type": "PropString",
            "displayName": "Code External Walls",
            "defaultValue": "A;B;",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Please type the codes of the external walls separate by ; "
          },
          {
            "index": 4,
            "variable": "sSheetType",
            "type": "PropString",
            "displayName": "Floor Sheet Type",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "sSheetingName",
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dToleranceCavityCloser",
            "type": "PropDouble",
            "displayName": "% Extra for Cavity Closer",
            "defaultValue": 15,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "Inv_Sheet.xml",
            "searchPaths": [
              "_kPathPersonalTemp"
            ],
            "purpose": "Provides sheeting information (Description, PartNumber, Material, Dimensions) for the Floor Sheet Type dropdown.",
            "required": true
          }
        ]
      },
      "tokens_used": 5209,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates floor area, perimeter, and opening statistics (including adjusted perimeters for cavity closers) based on selected external walls, and exports material data for floor sheeting.",
          "category": "Estimation/Take-off",
          "typicalUseCase": "Used during the design phase to generate a Bill of Materials (BOM) for flooring materials and finishing elements (skirting/cavity closers) by analyzing the 3D wall model."
        },
        "parameters": [
          {
            "name": "sDispRep",
            "technicalDefault": "",
            "businessMeaning": "Controls the visibility of the calculated floor outline in specific model views or display representations (e.g., 'Plan', '3D').",
            "validRange": "String names of valid display representations in the drawing.",
            "unit": "text",
            "affectsOutput": "Determines in which view styles the generated floor outline polyline is visible to the user."
          },
          {
            "name": "sLineType",
            "technicalDefault": "",
            "businessMeaning": "Sets the graphical line style (e.g., Continuous, Dashed, Hidden) used to draw the floor outline.",
            "validRange": "Standard AutoCAD/hsbCAD line types loaded in the drawing.",
            "unit": "text",
            "affectsOutput": "Visual appearance of the calculated floor area line."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Assigns a specific dimension style to the display entity, likely used if dimensions were to be annotated or for consistency with project standards.",
            "validRange": "Standard dimension styles defined in the CAD template.",
            "unit": "text",
            "affectsOutput": "Standardizes the visual properties of any associated dimensions or text."
          },
          {
            "name": "nColor",
            "technicalDefault": "3",
            "businessMeaning": "Sets the CAD color index for the line representing the floor foundation outline.",
            "validRange": "0 to 255 (Standard AutoCAD Color Index), default is Green (3).",
            "unit": "index",
            "affectsOutput": "Visual color of the floor outline drawn in the model."
          },
          {
            "name": "psExtType",
            "technicalDefault": "A;B;",
            "businessMeaning": "Defines the wall codes (e.g., 'Ext', 'A', 'PartyWall') that identify which selected walls are considered 'External' for the calculation.",
            "validRange": "Semicolon-separated string list (e.g., \"A;B;EXT;\").",
            "unit": "text",
            "affectsOutput": "Filters the input walls; only walls matching these codes will have their area unioned and calculated. Incorrect codes result in zero area."
          },
          {
            "name": "sSheetType",
            "technicalDefault": "",
            "businessMeaning": "Selects the specific type of floor sheeting material (e.g., 'OSB 18mm', 'Chipboard 22mm') from the catalog to report in the export.",
            "validRange": "Dropdown list populated by 'Inv_Sheet.xml'.",
            "unit": "text",
            "affectsOutput": "Sets the value of the 'U_SHEET' export attribute, linking the area calculation to a specific material part number."
          },
          {
            "name": "dToleranceCavityCloser",
            "technicalDefault": "15",
            "businessMeaning": "Specifies a percentage wastage or overlap allowance added to the opening perimeters to account for cavity closers, trim, or fitting tolerances.",
            "validRange": "0.0 to 100.0+ (Percentage). 15% suggests standard allowance for framing trim around windows/doors.",
            "unit": "%",
            "affectsOutput": "Increases the calculated values for 'U_OPWINDOWPER', 'U_OPDOORPER', and 'U_OPPERIMETER'. Does not change geometry, only the exported data."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "psExtType",
            "effect": "Determines which walls are processed for area calculation.",
            "cascade": [
              "U_AREA",
              "U_PERIMETER",
              "U_SHEET"
            ]
          },
          {
            "trigger": "sSheetType",
            "effect": "Looks up the Part Number from 'Inv_Sheet.xml' map based on the selected Description.",
            "cascade": [
              "U_SHEET"
            ]
          },
          {
            "trigger": "dToleranceCavityCloser",
            "effect": "Multiplies the raw perimeter of all openings by (1 + percentage/100).",
            "cascade": [
              "U_OPPERIMETER",
              "U_OPWINDOWPER",
              "U_OPDOORPER",
              "U_OPOPENINGPER"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Graphic Line / PLine",
            "description": "A visual polyline representing the calculated external floor area, offset 15mm inward from the wall outline. Placed on the layer defined by the script instance.",
            "appliedTo": "Model Space (visual reference)"
          },
          {
            "type": "Data Attributes (DXA)",
            "description": "Exports Area (m2), Perimeter (m), Corner Count, Sheet Part Number, and detailed opening quantities/perimeters to the hsbCAD database/Excel.",
            "appliedTo": "ElementFloorGroup"
          }
        ]
      },
      "tokens_used": 7234,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Read 'Inv_Sheet.xml' from _kPathPersonalTemp to populate sheeting catalog data.",
          "2. Property Declaration: Define OPM properties (sDispRep, sLineType, psExtType, etc.) and load default values from catalog if _bOnDbCreated.",
          "3. Input Selection (On Insert): Check insertCycleCount; if > 1, erase instance and exit. If 1, prompt user to select Wall entities (ElementWall).",
          "4. Entity Processing: Filter valid ElementWall entities from the selection and store them in the instance's _Element array.",
          "5. Coordinate System Setup: Define a World Coordinate System (WCS) based on the first valid wall's origin.",
          "6. Wall Segregation: Iterate through stored walls to collect valid ElementWall objects.",
          "7. Geometry Calculation: Generate outline profiles (plOutlineWall), shrink them by 15mm, and union profiles of walls whose codes match the 'psExtType' property.",
          "8. Opening Collection: Collect all openings (windows, doors, generic openings) from the identified external walls.",
          "9. Area Analysis: Iterate through unioned profile rings to identify the largest closed loop (Floor Area).",
          "10. Simplification: Remove collinear vertices (dot product check) from the outline to reduce point count.",
          "11. Visualization: Draw the simplified floor outline in the model using specified display properties (Color, LineType, DispRep).",
          "12. Statistics Calculation: Calculate area (mm² to m²), perimeter (mm to m), and opening quantities/perimeters. Apply tolerance percentage to opening perimeters.",
          "13. Data Export: Export calculated metrics (U_AREA, U_PERIMETER, U_SHEET, etc.) to the hsbCAD database (DXA) if values exist.",
          "14. Assignment: Assign the script instance to the ElementFloorGroup of the primary external wall."
        ],
        "conditionalBranches": [
          {
            "condition": "Valid XML Catalog",
            "path1": {
              "name": "Catalog Loaded",
              "steps": [
                "Parse 'Sheet' map entries",
                "Populate sSheetingName dropdown options",
                "Store PartNumbers and Dimensions in arrays"
              ]
            },
            "path2": {
              "name": "Catalog Missing/Invalid",
              "steps": [
                "Report 'No Valid dll or path not found'",
                "Proceed with empty catalog arrays"
              ]
            }
          },
          {
            "condition": "Insert Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "eraseInstance()",
                "return (Stop script)"
              ]
            },
            "path2": {
              "name": "Cycle = 1",
              "steps": [
                "Check Execute Key",
                "Show Dialog if needed",
                "Execute Entity Selection (PrEntity)"
              ]
            }
          },
          {
            "condition": "Post-Insertion Recalculation (eWalls check)",
            "path1": {
              "name": "Valid Walls Found",
              "steps": [
                "Set up CoordSys",
                "Calculate Unions",
                "Draw Geometry"
              ]
            },
            "path2": {
              "name": "No Valid Walls",
              "steps": [
                "eraseInstance()",
                "return (Delete script instance)"
              ]
            }
          },
          {
            "condition": "External Wall Detection",
            "path1": {
              "name": "Code Matches psExtType",
              "steps": [
                "Append to elExternal array",
                "Union geometry to ppExternalTemp",
                "Add openings to opAll array"
              ]
            },
            "path2": {
              "name": "Code Mismatch",
              "steps": [
                "Ignore wall for area/perimeter calculation"
              ]
            }
          },
          {
            "condition": "Opening Type Classification",
            "path1": {
              "name": "Type == Window",
              "steps": [
                "Update Window Qty/Perimeter arrays",
                "Calc Perimeter: 2*Width + 2*Height"
              ]
            },
            "path2": {
              "name": "Type == Door",
              "steps": [
                "Update Door Qty/Perimeter arrays",
                "Calc Perimeter: Width + 2*Height"
              ]
            },
            "path3": {
              "name": "Type == Opening",
              "steps": [
                "Update Generic Opening Qty/Perimeter arrays",
                "Calc Perimeter: 2*Width + 2*Height"
              ]
            }
          },
          {
            "condition": "Export Data Existence",
            "path1": {
              "name": "Data Exists (>0)",
              "steps": [
                "Call dxaout() for specific attribute (e.g., U_OPWINDOWPER)"
              ]
            },
            "path2": {
              "name": "Data is 0/Empty",
              "steps": [
                "Skip export for specific attribute"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Filepath 'Inv_Sheet.xml' exists at _kPathPersonalTemp",
            "errorMessage": "No Valid dll or path not found (via reportNotice)",
            "recovery": "Ensure XML configuration file exists in the correct temp folder."
          },
          {
            "check": "Selected entities are of type ElementWall",
            "errorMessage": "None (Non-wall entities are silently ignored in the loop)",
            "recovery": "Select valid Wall elements."
          },
          {
            "check": "At least one selected wall has a code matching the 'Code External Walls' property",
            "errorMessage": "None (Script instance is erased if elExternal.length() < 1)",
            "recovery": "Adjust 'Code External Walls' property to match the actual wall codes (e.g., 'A;B;') or select walls with correct codes."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Display Representation",
            "how": "OPM Property 'Show in Disp Rep'",
            "effect": "Toggles visibility of the floor outline in different views (Plan/3D)."
          },
          {
            "action": "Adjust External Wall Codes",
            "how": "OPM Property 'Code External Walls'",
            "effect": "Modifies which walls contribute to the floor area union. Changing this triggers a recalculation and redraw."
          },
          {
            "action": "Change Floor Sheet Material",
            "how": "OPM Property 'Floor Sheet Type'",
            "effect": "Updates the exported Part Number (U_SHEET) based on the XML catalog mapping."
          },
          {
            "action": "Adjust Cavity Closer Tolerance",
            "how": "OPM Property '% Extra for Cavity Closer'",
            "effect": "Changes the percentage multiplier applied to opening perimeters in the exported data."
          },
          {
            "action": "Modify Visual Style",
            "how": "OPM Properties 'Color Foundation Lines', 'Line Type', 'Dim style'",
            "effect": "Updates the graphical properties of the drawn outline immediately."
          }
        ]
      },
      "tokens_used": 8486,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_AreaTakeOff.mcr\n\n## Overview\nCalculates floor area, perimeter, and opening statistics (windows, doors) based on selected wall elements. It also exports material data for floor sheeting to the hsbCAD database or Excel for estimation purposes.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script is intended to be used in the 3D model to select wall elements. |\n| Paper Space | No | Not designed for layout views. |\n| Shop Drawing | No | Not used for generating manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities**: `ElementWall` (Wall entities must exist in the model).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: `Inv_Sheet.xml` must be present in your temporary path (`_kPathPersonalTemp`) to populate floor sheeting options.\n\n## Usage Steps\n\n### Step 1: Launch Script\nExecute the command `TSLINSERT` in the AutoCAD command line and select `hsb_AreaTakeOff.mcr` from the list.\n\n### Step 2: Select Walls\n```\nCommand Line: Please select Walls\nAction: Select the wall elements in the model that define the floor area you want to calculate.\n```\n*Note: Ensure the walls you select have the correct wall codes assigned (e.g., 'A' or 'B') so the script can identify them as external walls.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Show in Disp Rep | text | (empty) | Specifies in which display representation (e.g., Plan, 3D) the calculated floor outline is visible. |\n| Line Type | dropdown | (empty) | Sets the line style (e.g., Continuous, Dashed) for the floor outline. |\n| Dim style | dropdown | (empty) | Assigns a dimension style to the entity. |\n| Color Foundation Lines | number | 3 | Sets the color index (0-255) for the floor outline. Default is Green (3). |\n| Code External Walls | text | A;B; | Defines the wall codes used to identify external walls. Separate codes with a semicolon (;). Only walls matching these codes are included in the calculation. |\n| Floor Sheet Type | dropdown | (empty) | Selects the specific floor sheeting material (e.g., OSB 18mm) to report in the export data. |\n| % Extra for Cavity Closer | number | 15 | Adds a percentage allowance to opening perimeters to account for trim/wastage (e.g., 15%). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu options are defined. Use the Properties Palette to modify parameters. |\n\n## Settings Files\n- **Filename**: `Inv_Sheet.xml`\n- **Location**: `_kPathPersonalTemp` (Your personal hsbCAD temp folder).\n- **Purpose**: Provides the catalog of sheeting materials (Description, Part Number, Dimensions) used to populate the \"Floor Sheet Type\" dropdown.\n\n## Tips\n- **Wall Codes are Critical**: If the calculated area is 0, check the **Code External Walls** property. It must match the codes assigned to your wall entities exactly (e.g., if your walls are code \"EXT\", enter \"EXT;\" in the property).\n- **Cavity Closer Allowance**: Use the **% Extra for Cavity Closer** property to automatically increase the perimeter length for openings in the export data, ensuring you order enough material for trim work.\n- **Visualizing the Result**: The script draws a polyline 15mm inward from the selected walls. Change the **Color Foundation Lines** or **Line Type** properties to make this outline stand out against your walls.\n\n## FAQ\n- **Q: Why is the floor area showing as 0?**\n- **A**: Check the **Code External Walls** property. The script only calculates area for walls whose codes match the list in this field (e.g., \"A;B;\"). Ensure your selected walls actually have these codes.\n- **Q: Where does the \"Floor Sheet Type\" list come from?**\n- **A**: It is loaded from the `Inv_Sheet.xml` file. If the dropdown is empty, check that this file exists in the correct temp folder and is formatted correctly.\n- **Q: Can I include internal walls in the calculation?**\n- **A**: Only if you add their wall codes to the **Code External Walls** property string. By default, it is set to filter for external walls only."
      },
      "tokens_used": 6712,
      "error": null
    }
  }
}