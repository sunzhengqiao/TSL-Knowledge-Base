{
  "filename": "hsbCullenPC.mcr",
  "status": "completed",
  "total_tokens": 48383,
  "processing_time": 358.59300446510315,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9488,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly targets `_kModelSpace` during insertion (`tslNew.dbCreate(..., _kModelSpace, ...)`). There are no `sd_` prefixes or `_Viewport` references. The script manipulates 3D geometry (GenBeams, Planes, Quaders, Bodies) and hardware components."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space with at least two GenBeams that share a common plane or intersect.",
          "requiredSettings": [
            "Block definition named 'Panel Closer' (optional, falls back to a generated Body if not found in drawing or hsbCompany\\Block folder)"
          ]
        }
      },
      "tokens_used": 5911,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select genBeam(s)|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select the Point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "|swap X-Y|",
            "handler": "|swap X-Y|",
            "action": "Swaps the orientation of the panel closer by toggling the internal 'iSide' state.",
            "alsoTriggeredBy": "TslDoubleClick"
          }
        ],
        "settingsFiles": [
          {
            "filename": "Panel Closer.dwg",
            "searchPaths": [
              "Current Drawing Blocks",
              "hsbCompany\\Block"
            ],
            "purpose": "Block definition for the graphical representation of the connector. If missing, a generic Body is generated.",
            "required": false
          }
        ]
      },
      "tokens_used": 9067,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Inserts a 'Cullen Panel Closer' metal plate connector that bridges and connects two timber elements (beams, sheets, or panels).\",\n    \"category\": \"Hardware\",\n    \"typicalUseCase\": \"Used to connect two timber walls or panels where a flat steel tie plate (typically 180x85mm) is required to transfer loads or close a joint, including hardware export for BOM.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"Beam Selection\",\n      \"technicalDefault\": \"_GenBeam[2]\",\n      \"businessMeaning\": \"The two structural timber elements (beams or panels) that the connector will join.\",\n      \"validRange\": \"Any two valid GenBeams sharing a common plane or intersecting.\",\n      \"unit\": \"Entities\",\n      \"affectsOutput\": \"Determines the geometry of the connection point and the bounding planes used to calculate the connector's position and orientation.\"\n    },\n    {\n      \"name\": \"Insertion Point\",\n      \"technicalDefault\": \"_Pt0\",\n      \"businessMeaning\": \"The user-selected location near the desired joint used to identify which specific intersection or edge to connect.\",\n      \"validRange\": \"Any 3D point in Model Space near the target beams.\",\n      \"unit\": \"Coordinates (mm)\",\n      \"affectsOutput\": \"The script calculates the closest valid edge to this point and snaps the connector center line to it.\"\n    },\n    {\n      \"name\": \"Connector Length (dLPart)\",\n      \"technicalDefault\": \"180\",\n      \"businessMeaning\": \"The longitudinal length of the metal plate profile.\",\n      \"validRange\": \"100 - 300 mm (Standard steel plate lengths)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Defines the size of the 3D Body/Block representation and"
      },
      "tokens_used": 10074,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch Script (via Command 'hsbCullenPC' or Catalog)",
          "[Insert Mode Check] Detect if _bOnInsert is true",
          "[Prompt 1] Select genBeam(s) using PrEntity",
          "[Check 1] Verify selection count >= 2",
          "   [If False] Report error 'Select at least two genBeams...', eraseInstance, and exit",
          "[Prompt 2] Select point near joint using getPoint",
          "[Initialize] Set internal Map 'iSide' to 1",
          "[Create Instance] Generate TSL instance in ModelSpace linked to selected beams and point",
          "[Erase Placeholder] Remove the temporary insert script instance",
          "[Recalculation] New instance executes with _bOnRecalc",
          "[Validation] Verify attached GenBeam count == 2",
          "   [If False] Report error 'two beams needed', eraseInstance, exit",
          "[Geometry Calc] Generate 6 bounding planes for each beam",
          "[Analysis] Find common co-planar surface pairs between the two beams",
          "[Edge Detection] Identify the closest parallel edges on the common surface to the selected point",
          "[Positioning] Snap insertion point (_Pt0) and grip point (_PtG[0]) to the detected edge line",
          "[Orientation Logic] Calculate Body orientation based on detected edge, World axes, and 'iSide' state",
          "[Visuals] Attempt to load 'Panel Closer' block (Current DWG > Company Folder > Generate generic Body)",
          "[Hardware] Create HardWrComp for 'Panel closer' and 'Annular Ringshank Nails'",
          "[Finish] Assign layer 'i' and groups from parent beam"
        ],
        "conditionalBranches": [
          {
            "condition": "User triggers 'swap X-Y' or Double Click (via Context Menu)",
            "path1": {
              "name": "Standard Orientation",
              "steps": [
                "Script calculates orientation based on dot product of edge vector and World Axes (ZW, XW, YW)",
                "Uses 'iSide' value (1 or -1) to flip direction if previously swapped"
              ]
            },
            "path2": {
              "name": "Swapped Orientation",
              "steps": [
                "Read current 'iSide' from Map",
                "Multiply 'iSide' by -1 (flips the orientation vector)",
                "Set new 'iSide' in Map",
                "Trigger recalculation loop to update visual"
              ]
            }
          },
          {
            "condition": "Block 'Panel Closer' availability",
            "path1": {
              "name": "Use Block Definition",
              "steps": [
                "Check internal drawing block names",
                "If found, draw block at calculated position"
              ]
            },
            "path2": {
              "name": "Load External Block",
              "steps": [
                "Check hsbCompany\\Block folder",
                "If found, import and draw block"
              ]
            },
            "path3": {
              "name": "Fallback to Body",
              "steps": [
                "If no block found anywhere",
                "Create generic Body (Quader) using dLPart, dWPart, dThicknessPart",
                "Draw Body"
              ]
            }
          },
          {
            "condition": "Input Entity Count (During Insert)",
            "path1": {
              "name": "Valid Selection",
              "steps": [
                "User selects 2+ GenBeams",
                "Proceed to getPoint prompt"
              ]
            },
            "path2": {
              "name": "Invalid Selection",
              "steps": [
                "User selects < 2 GenBeams",
                "Report message: 'Select at least two genBeams...'",
                "Erase instance and stop"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Minimum GenBeam selection",
            "errorMessage": "Select at least two genBeams (beam, sheet or panel)",
            "recovery": "User must restart script and select at least two valid timber elements."
          },
          {
            "check": "Attached GenBeam count (Post-Insertion)",
            "errorMessage": "two beams needed",
            "recovery": "Ensure the TSL instance is linked to exactly two GenBeams. If one is deleted, the TSL will erase itself."
          },
          {
            "check": "Common Plane Existence",
            "errorMessage": "no common plane found",
            "recovery": "The selected beams do not share a coplanar surface or are not positioned correctly for this connector."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Position",
            "how": "Grip Edit (_PtG) or OPM _Pt0",
            "effect": "Script projects the new point onto the detected edge line and updates connector placement."
          },
          {
            "action": "Swap Orientation (Flip)",
            "how": "Right-click Context Menu -> 'swap X-Y' OR Double Click",
            "effect": "Flips the connector 180 degrees along its length vector relative to the world coordinate system."
          },
          {
            "action": "Modify Dimensions",
            "how": "Edit OPM Properties (dLPart, dWPart, dThicknessPart)",
            "effect": "Updates the size of the generic Body if block is not used. Note: Block definitions are static unless the block file is edited."
          },
          {
            "action": "Refresh Hardware",
            "how": "Geometry Recalculation (Auto or Manual)",
            "effect": "Updates HardWrComp data (Manufacturer: Cullen, Material: galvanised mild steel, Nails quantity)."
          }
        ]
      },
      "tokens_used": 8868,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCullenPC.mcr\n\n## Overview\nInserts a \"Cullen Panel Closer\" metal plate connector that bridges and connects two timber elements (beams, sheets, or panels). It automatically detects the connecting edge and generates the necessary hardware data for manufacturing exports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script operates in 3D model space to connect structural timber elements. |\n| Paper Space | No | This script does not function in layout views. |\n| Shop Drawing | No | This is a modeling tool, not a detailing tool for 2D drawings. |\n\n## Prerequisites\n- **Required Entities:** At least 2 `GenBeams` (beams, sheets, or panels) that share a common plane or intersect.\n- **Minimum Beam Count:** 2.\n- **Required Settings Files:** A block definition named `Panel Closer.dwg`.\n  - *Note:* If this block is not found in the current drawing or the `hsbCompany\\Block` folder, the script will generate a generic rectangular body based on parameter dimensions.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCullenPC.mcr` from the catalog or file dialog.\n\n### Step 2: Select Timber Elements\n```\nCommand Line: Select genBeam(s)\nAction: Click on the two timber elements (walls, panels, or beams) you wish to connect.\nNote: You must select at least two elements for the script to proceed.\n```\n\n### Step 3: Select Location\n```\nCommand Line: Select the Point\nAction: Click in the 3D model near the joint or edge where you want the Panel Closer to be placed.\nNote: The script will snap the connector to the closest valid edge intersection.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Pt0 | Point | Calculated | The insertion point of the connector on the joint edge. Can be dragged to reposition along the edge. |\n| dLPart | Double | 180 mm | The longitudinal length of the metal plate. |\n| dWPart | Double | 85 mm | The width of the metal plate. |\n| dThicknessPart | Double | System Default | The thickness of the metal plate material. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| swap X-Y | Flips the orientation of the panel closer 180 degrees along its length vector. Useful if the connector is facing the wrong direction relative to the joint. |\n\n## Settings Files\n- **Filename**: `Panel Closer.dwg`\n- **Location**: `hsbCompany\\Block` folder or Current Drawing Blocks.\n- **Purpose**: Provides the specific 3D geometry for the Cullen connector. If this file is missing, a generic rectangular box (Body) is drawn using the dimensions defined in the Properties Panel.\n\n## Tips\n- **Double-Click to Flip:** You can double-click the connector in the model to trigger the \"swap X-Y\" function instead of using the right-click menu.\n- **Repositioning:** Use the grip point (Pt0) to slide the connector along the edge of the beam after insertion.\n- **Automatic Detection:** Ensure the two selected beams physically touch or share a coplanar surface; otherwise, the script may fail to find a valid connection point.\n\n## FAQ\n- **Q: Why does my connector look like a simple box instead of a detailed metal plate?**\n  **A:** The script could not find the `Panel Closer.dwg` block in your `hsbCompany\\Block` folder or the current drawing. It is displaying the fallback generic body.\n- **Q: The script reported \"no common plane found\".**\n  **A:** The two beams you selected do not share a flat surface or are not aligned correctly for this type of connector. Check that the beams are touching or properly intersected.\n- **Q: How do I change the size of the plate?**\n  **A:** Select the connector, open the Properties Palette (Ctrl+1), and adjust the `dLPart` (Length) or `dWPart` (Width) values."
      },
      "tokens_used": 4975,
      "error": null
    }
  }
}