{
  "filename": "HSB_G-Wallplates.mcr",
  "status": "completed",
  "total_tokens": 49861,
  "processing_time": 527.0993416309357,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9018,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses '_kModelSpace' in 'dbCreate' calls for generating dimensions and anchors. It manipulates 3D geometry by joining and splitting wall plates (GenBeams) and interacting with ElementRoof entities. There is no 'sd_' prefix, '#Type E' input definitions, or '_Viewport' usage, indicating it operates solely in the 3D model environment."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": [
            "HSB_T-Anchor",
            "HSB_D-Aligned",
            "Anchor blocks with 'BK', 'ANKER', or 'HSB' in the name"
          ]
        }
      },
      "tokens_used": 6500,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 9765,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the joining of wall plates within a roof plane, splitting them into standard transport lengths, assigning them to production groups, and distributing anchors with specific spacings.\",\n    \"category\": \"Framing\",\n    \"typicalUseCase\": \"Used to process raw roof geometry into production-ready wall plates with standard lengths and anchor layouts for loose material lists and fabrication.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sName\",\n      \"technicalDefault\": \"\\\"hsbCAD Wallplates\\\"\",\n      \"businessMeaning\": \"Identifier for the script instance in the project tree.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Identification only.\"\n    },\n    {\n      \"name\": \"sDeleteOldBeams\",\n      \"technicalDefault\": \"\\\"No\\\"\",\n      \"businessMeaning\": \"Determines if the generated wall plates are deleted when the source element is removed/unframed.\",\n      \"validRange\": \"Yes/No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Persistence of generated geometry when source elements change.\"\n    },\n    {\n      \"name\": \"sBmCodesToJoin\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Material code filter (e.g., 'C24') to select which specific wall plates to process.\",\n      \"validRange\": \"Project-specific material codes\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Filters input beams for processing.\"\n    },\n    {\n      \"name\": \"sBmNamesToJoin\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Name filter to select which specific wall plates to process.\",\n      \"validRange\": \"Project-specific beam names\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Filters input beams for processing.\"\n    },\n    {\n      \"name\": \"sAssignToGroup\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Target group (Floor/Element) for the generated wall plates to ensure they appear on the correct loose material list.\",\n      \"validRange\": \"Existing Group names\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Group assignment of output beams.\"\n    },\n    {\n      \"name\": \"dDefaultSplitL\",\n      \"technicalDefault\": \"5100 mm\",\n      \"businessMeaning\": \"Target length for wall plates based on transport or raw material constraints (e.g., max truck length).\",\n      \"validRange\": \"3000 mm - 13000 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Location of cuts along the joined wall plate.\"\n    },\n    {\n      \"name\": \"dMinimumSplitL\",\n      \"technicalDefault\": \"2700 mm\",\n      \"businessMeaning\": \"Shortest allowable length for a wall plate segment to prevent unusable offcuts.\",\n      \"validRange\": \"1000 mm - dDefaultSplitL\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Length of the final segment; adjusts previous cut if too short.\"\n    },\n    {\n      \"name\": \"dSplitGap\",\n      \"technicalDefault\": \"0 mm\",\n      \"businessMeaning\": \"Physical separation between split beam segments.\",\n      \"validRange\": \"0 mm - 20 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Gap between resulting beams.\"\n    },\n    {\n      \"name\": \"sScriptNameAnchor\",\n      \"technicalDefault\": \"\\\"HSB_T-Anchor\\\"\",\n      \"businessMeaning\": \"The TSL script responsible for generating anchor"
      },
      "tokens_used": 9345,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Insert Initiated (e.g., via AnchorPlan or Manual Run)",
          "Check Insertion Cycle Count",
          "[Conditional] Cycle > 1: Erase instance and exit",
          "Show Configuration Dialog",
          "Prompt User to Select Elements (ElementRoof)",
          "Prompt User for Insertion Point (_Pt0)",
          "Store 'Insert' flag in internal Map",
          "Exit Initial Insertion Routine",
          "Recalculation/Execution Phase Starts",
          "Check if Elements are Selected (_Element.length)",
          "[Conditional] No Elements: Report error, erase instance, exit",
          "Assign Script Instance to Layer 0",
          "Draw Visualization Symbol (Name at _Pt0)",
          "Resolve and Sort Property Values (Anchor blocks, Groups, etc.)",
          "Iterate through Selected Elements",
          "Collect Beams associated with each Element",
          "[Conditional] Filter Beams: Check Beam Code and Beam Name against properties",
          "Join Filtered Beams into Wall Plates (Linear sorting and connection)",
          "Split Joined Wall Plates based on Default and Minimum Lengths",
          "[Conditional] Gap Splitting: Move segments by dSplitGap if > 0",
          "Assign Output Beams to Specified Group (sAssignToGroup)",
          "Assign Delete Status to Output Beams (sDeleteOldBeams)",
          "Loop for Anchor Distribution (1 and 2)",
          "[Conditional] Check if Anchor 2 is Active (sApplyAnchor2)",
          "Calculate Anchor Positions (Grid, Extremes, or Center based)",
          "Insert Anchor Script Instances (HSB_T-Anchor)",
          "Loop for Dimension Creation",
          "Sort Anchor Points and Types",
          "Create Dimension Instances for Wall Plates (HSB_D-Aligned)",
          "Create Dimension Instances for Anchors (grouped by type)",
          "Create Dimension Instances for Elements",
          "Store Generated TSL Instances in Map to prevent duplicates",
          "Finish Execution"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Check",
            "path1": {
              "name": "Cycle > 1 (Double Insert Prevention)",
              "steps": [
                "Erase Instance",
                "Return/Exit"
              ]
            },
            "path2": {
              "name": "Cycle = 1 (Normal Insert)",
              "steps": [
                "Show Dialog",
                "Select Elements",
                "Select Point",
                "Continue to Logic"
              ]
            }
          },
          {
            "condition": "Element Selection Validation",
            "path1": {
              "name": "No Elements Selected",
              "steps": [
                "Report 'No element selected'",
                "Erase Instance",
                "Exit"
              ]
            },
            "path2": {
              "name": "Elements Selected",
              "steps": [
                "Process Wall Plates",
                "Generate Geometry"
              ]
            }
          },
          {
            "condition": "Beam Filtering (sBmCodesToJoin / sBmNamesToJoin)",
            "path1": {
              "name": "Filters Set (Empty String = All)",
              "steps": [
                "Check Beam Code",
                "Check Beam Name",
                "Include only matching Beams"
              ]
            },
            "path2": {
              "name": "Filters Empty",
              "steps": [
                "Include all Beams in Element"
              ]
            }
          },
          {
            "condition": "Last Split Segment Length",
            "path1": {
              "name": "Last Segment < Minimum Length (dMinimumSplitL)",
              "steps": [
                "Adjust previous split location",
                "Make last segment longer to meet minimum"
              ]
            },
            "path2": {
              "name": "Last Segment >= Minimum Length",
              "steps": [
                "Perform standard split at Default length"
              ]
            }
          },
          {
            "condition": "Anchor 2 Configuration (sApplyAnchor2)",
            "path1": {
              "name": "Anchor 2 Active (Yes)",
              "steps": [
                "Read Anchor 2 Properties",
                "Calculate Anchor 2 Distribution",
                "Insert Anchor 2 Instances"
              ]
            },
            "path2": {
              "name": "Anchor 2 Inactive (No)",
              "steps": [
                "Skip Anchor 2 Logic"
              ]
            }
          },
          {
            "condition": "Dimension Linking (sLinkDimensionToObjects)",
            "path1": {
              "name": "Linked (Yes)",
              "steps": [
                "Pass Entity Maps to Dimension TSL",
                "Dimensions update if geometry moves"
              ]
            },
            "path2": {
              "name": "Static (No)",
              "steps": [
                "Pass Point coordinates only",
                "Dimensions do not auto-update with geometry"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent erase)",
            "recovery": "N/A (Automatic prevention)"
          },
          {
            "check": "Element Selection Set",
            "errorMessage": "TN(\"|No element selected|!\")",
            "recovery": "Select valid ElementRoof entities and re-run/insert script."
          },
          {
            "check": "Anchor Block Availability",
            "errorMessage": "None (Handled by static list population at start)",
            "recovery": "Ensure drawing contains blocks starting with 'BK', containing 'ANKER', or 'HSB'."
          },
          {
            "check": "Division by Zero (Spacing/Lengths)",
            "errorMessage": "None (Handled in v1.04)",
            "recovery": "Ensure 'Default split length', 'Minimum split length', and 'Spacing' values are greater than 0."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Geometry Parameters (Lengths/Groups)",
            "how": "OPM (Object Properties Palette) - Double-click script instance",
            "effect": "Recalculates and regenerates wall plates, splits, and group assignments on next recalculation."
          },
          {
            "action": "Modify Anchor Layout",
            "how": "OPM - Change offsets, spacing, or distribution type",
            "effect": "Re-distributes anchors along the wall plates on next recalculation."
          },
          {
            "action": "Move Anchor Individually",
            "how": "Grip Edit - Select the inserted Anchor (HSB_T-Anchor) instance",
            "effect": "Moves the specific anchor to a new location (manual override of distribution)."
          },
          {
            "action": "Refresh Dimensions",
            "how": "Context Menu - 'Recalculate dimensions'",
            "effect": "Redraws dimension lines without recalculating the entire wall plate geometry."
          },
          {
            "action": "Full Recalculation",
            "how": "Context Menu - 'Recalculate all' or modify Properties",
            "effect": "Re-runs the joining, splitting, and anchoring logic from scratch."
          }
        ]
      },
      "tokens_used": 9037,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-Wallplates\n\n## Overview\nThis script automates the joining of wall plates within a roof plane, splits them into standard transport lengths, assigns them to production groups, and distributes anchors with specific spacings to create production-ready wall plates.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Operates in 3D model environment only. |\n| Paper Space | No | Not designed for 2D layouts or shop drawings. |\n| Shop Drawing | No | Does not generate views or layouts. |\n\n## Prerequisites\n- **Required Entities**: `ElementRoof` entities and `GenBeams` (wall plates).\n- **Minimum Beam Count**: 0 (Logic processes beams found within selected elements).\n- **Required Settings**:\n    - The script `HSB_T-Anchor.mcr` must be available.\n    - The script `HSB_D-Aligned.mcr` must be available.\n    - Drawing must contain Anchor blocks with names containing 'BK', 'ANKER', or 'HSB'.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_G-Wallplates.mcr`\n\n### Step 2: Configuration Dialog\n```\nCommand Line: (Dialog appears)\nAction: Configure initial settings (e.g., Split lengths, Groups) or click OK to accept defaults.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Select elements:\nAction: Click on the `ElementRoof` entities in the model that contain the wall plates you wish to process. Press Enter to confirm selection.\n```\n\n### Step 4: Select Insertion Point\n```\nCommand Line: Specify insertion point:\nAction: Click a location in the model space to place the script instance (visualization symbol).\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Name | Text | \"hsbCAD Wallplates\" | Identifier for the script instance in the project tree. |\n| Delete Old Beams | Yes/No | No | If \"Yes\", generated wall plates are deleted when the source element is removed or unframed. |\n| Beam Codes to Join | Text | (Empty) | Filter to select specific wall plates based on Material Code (e.g., \"C24\"). |\n| Beam Names to Join | Text | (Empty) | Filter to select specific wall plates based on Beam Name. |\n| Assign to Group | Text | (Empty) | Target group name (Floor/Element) for the generated wall plates to appear on loose material lists. |\n| Default Split Length | Number | 5100 mm | Target length for wall plates based on transport constraints. |\n| Minimum Split Length | Number | 2700 mm | Shortest allowable length for a wall plate segment to prevent unusable offcuts. |\n| Split Gap | Number | 0 mm | Physical separation (gap) between split beam segments. |\n| Script Name Anchor | Text | \"HSB_T-Anchor\" | The specific TSL script used to generate the anchor instances. |\n| Apply Anchor 2 | Yes/No | No | Enables the configuration and insertion of a second type of anchor. |\n| Link Dimension to Objects | Yes/No | Yes | If \"Yes\", dimensions automatically update if geometry moves. If \"No\", dimensions are static. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate all | Re-runs the entire script logic (joining, splitting, and anchoring) based on current properties and geometry. |\n| Recalculate dimensions | Redraws dimension lines only, without recalculating the wall plate geometry. |\n| Erase | Removes the script instance from the drawing. |\n\n## Settings Files\n- **Script Dependencies**: `HSB_T-Anchor.mcr`, `HSB_D-Aligned.mcr`\n- **Location**: hsbCAD standard TSL folder.\n- **Purpose**: These sub-scripts are called by the main script to generate anchor details and dimension lines respectively.\n\n## Tips\n- **Filtering**: Use the *Beam Codes* and *Beam Names* fields to process only specific types of wall plates (e.g., only top plates) within a complex roof element.\n- **Transport Lengths**: Adjust the *Default Split Length* to match your supplier's maximum transport length to optimize cutting lists.\n- **Minimum Lengths**: Ensure the *Minimum Split Length* is set appropriately; the script will automatically adjust the previous cut to ensure the last segment is not too short.\n- **Manual Anchor Adjustment**: After insertion, you can select individual anchor instances and use grip edits to move them manually if the automatic distribution does not suit specific constraints.\n\n## FAQ\n- **Q: Why does the script report \"No element selected\"?**\n  A: Ensure you are selecting `ElementRoof` entities, not individual beams or lines, during the selection prompt.\n- **Q: Why are my wall plates not being split?**\n  A: Check if the beams are longer than the *Default Split Length*. Also, verify that the *Beam Codes to Join* or *Beam Names to Join* filters are not excluding your specific beams.\n- **Q: Why are no anchors appearing?**\n  A: Verify that your drawing contains blocks with 'BK', 'ANKER', or 'HSB' in their names. The script searches for these blocks to use as anchor definitions."
      },
      "tokens_used": 6196,
      "error": null
    }
  }
}