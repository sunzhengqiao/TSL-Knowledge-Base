{
  "filename": "hsb_Spandrel_Marking.mcr",
  "status": "completed",
  "total_tokens": 41209,
  "processing_time": 271.8425142765045,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type"
      },
      "tokens_used": 8533,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit creation of TSL instances in _kModelSpace via tslNew.dbCreate(..., _kModelSpace, ...). Selects ElementWallSF during insertion. Direct manipulation of ElementWall geometry and beam envelopes in 3D space."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space containing a Stick Frame Wall with sloped edges (angled beams) and sill plates.",
          "requiredSettings": []
        }
      },
      "tokens_used": 6128,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion or Property Update (_bOnMapIO)",
            "title": null,
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dOffset",
            "type": "PropDouble",
            "displayName": "|Offset for mark|",
            "defaultValue": 5.0,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Offset|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5701,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates layout marks on sill plates to indicate the positions of angled studs (spandrel/gable studs) in a stick frame wall.",
          "category": "Framing / Layout",
          "typicalUseCase": "Used during detailing of stick frame walls with sloped top edges (gable ends) to mark the exact location on the bottom plate where spandrel studs land, aiding manufacturing or assembly."
        },
        "parameters": [
          {
            "name": "dOffset",
            "technicalDefault": 5.0,
            "businessMeaning": "Defines the distance the layout mark is placed from the edge of the sill plate section. The mark is placed at the extent of the plate (start or end) plus or minus this offset.",
            "validRange": "0.0 - 20.0",
            "unit": "mm",
            "affectsOutput": "Shifts the position of the generated 'Mark' tool along the length of the sill plate beam relative to the calculated intersection point."
          }
        ],
        "parameterDependencies": [],
        "outputEntities": [
          {
            "type": "Mark",
            "description": "Layout lines drawn on the surface of the sill plate indicating the projection of the spandrel/angled stud apex or intersection points.",
            "appliedTo": "Sill plate beams (horizontal beams identified as plates connected to vertical studs)."
          }
        ]
      },
      "tokens_used": 8340,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Insertion/Execution triggered",
          "[Insert] Check if insertCycleCount > 1 (Instance exists). If true, erase and exit.",
          "[Insert] Determine execution method (Catalog Key vs Dialog). Show Dialog if needed.",
          "[Insert] Prompt user to select Element(s) (ElementWallSF).",
          "[Insert] Validate selection. If empty, exit.",
          "[Insert] Create TSL instance(s) attached to selected Elements in ModelSpace.",
          "[Insert] Erase original template instance.",
          "[Execution/Update] Check MapIO for property updates (_bOnMapIO). If present, update properties and exit.",
          "[Execution/Update] Validate _Element[0] exists and is ElementWall. If not, report error and erase.",
          "Extract Wall Coordinate System and Geometry (Beams).",
          "Categorize Beams: Vertical (bmVerts), Horizontal (bmHors), Angled (bmAngleds).",
          "[Validation] Check for Angled Beams (bmAngleds). If length < 1, erase instance and exit (Spandrel required).",
          "Identify Sill Plates: Filter horizontal beams, union shadows to find connected plates.",
          "[Validation] Check for Sill Plates. If none found or area invalid, report error and erase.",
          "Generate Base PlaneProfile: Project vertical studs onto a plane derived from the sill.",
          "[Conditional] Check if Base PlaneProfile generation (Z0 profile) resulted in a single ring.",
          "   [Fallback Path] If base profile generation failed, use default studs (HSB ID 26) or Element Netto profile.",
          "   [Success Path] If base profile valid, subtract horizontal and angled beam profiles to create inner profile.",
          "[Fallback] If Inner Profile logic fails, use HSB ID 26 studs for marks.",
          "[Geometry Calc] Extract vertex points from the Inner PlaneProfile.",
          "Filter Vertices: Remove first/last extremes and points with 90-degree angles (or close to).",
          "[Validation] Remove points at the ridge (top Y). If insufficient points remain, erase.",
          "[Placement] For each calculated mark point, project to Sill Plate.",
          "[Placement] Apply Offset (dOffset) along Plate X-axis.",
          "[Cleanup] Check for existing marks at that location to prevent duplicates.",
          "Generate 'Mark' tool on the specific Sill Plate beam.",
          "[End] If not in Debug Mode, erase the calculation instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Check (Prevents duplicates)",
            "path1": {
              "name": "Subsequent Cycle",
              "steps": [
                "Erase current instance",
                "Exit script"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Proceed to Properties/Selection"
              ]
            }
          },
          {
            "condition": "Source of Insertion (Catalog vs Dialog)",
            "path1": {
              "name": "Catalog Key",
              "steps": [
                "Extract catalog key from _kExecuteKey",
                "Load properties from Catalog",
                "Skip dialog if found"
              ]
            },
            "path2": {
              "name": "Standard/No Key",
              "steps": [
                "Show Properties Dialog",
                "User confirms settings"
              ]
            }
          },
          {
            "condition": "Geometry Analysis Success (Inner Profile Generation)",
            "path1": {
              "name": "Complex Geometry Success",
              "steps": [
                "Use projected Inner PlaneProfile",
                "Calculate precise vertices between angled and vertical intersections"
              ]
            },
            "path2": {
              "name": "Geometry Fallback",
              "steps": [
                "Identify studs by HSB ID '26'",
                "Mark center points of these specific studs",
                "OR fall back to Element Netto profile if ID 26 fails"
              ]
            }
          },
          {
            "condition": "Existing Mark Detection",
            "path1": {
              "name": "Duplicate Found",
              "steps": [
                "Analyze existing tools on beam",
                "Identify match at calculated offset",
                "Skip creation of new mark"
              ]
            },
            "path2": {
              "name": "Location Clear",
              "steps": [
                "Create Mark entity",
                "Add to Sill Plate as static tool"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Assignment",
            "errorMessage": "\"<scriptName> could not find reference to element.\"",
            "recovery": "Ensure a valid ElementWall is selected before running or that the link is not broken."
          },
          {
            "check": "Angled Beams Present",
            "errorMessage": "(Implicit) Instance erased silently if no angled beams found.",
            "recovery": "Ensure the wall has a sloped top edge (gable) with angled studs."
          },
          {
            "check": "Sill Plates Present",
            "errorMessage": "\"No plates found. Instance deleted\"",
            "recovery": "Ensure the wall has horizontal bottom plates that touch each other to form a continuous sill."
          },
          {
            "check": "Profile Logic Validity",
            "errorMessage": "\"Unexpected error of <scriptName>\" or Silent Erase",
            "recovery": "Check wall geometry consistency. Ensure studs intersect plates properly."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Mark Offset",
            "how": "OPM (Object Properties Palette)",
            "effect": "Updating 'Offset for mark' triggers recalculation, shifting the marks along the sill plates."
          },
          {
            "action": "Wall Geometry Modification",
            "how": "Modify Wall/Beams (Standard hsbCAD edit)",
            "effect": "Script recalculates on update (_bOnElementConstructed/_bOnMapIO), regenerating marks based on new stud positions."
          }
        ]
      },
      "tokens_used": 7734,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_Spandrel_Marking\n\n## Overview\nThis script automatically generates layout marks on the sill plates (bottom plates) of stick frame walls. It calculates and marks the exact landing positions of angled studs (spandrel or gable studs) to assist in manufacturing and assembly.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in the 3D model. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: `ElementWall` (Stick Frame Wall).\n- **Minimum Requirements**: The wall must contain angled/sloped beams (gable condition) and horizontal sill plates (bottom plates).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Select `hsb_Spandrel_Marking.mcr` from the list.\n3. Alternatively, run the script via a custom toolbar button or catalog key if configured.\n\n### Step 2: Select Wall Element\n```\nCommand Line: Select element(s)\nAction: Click on the Stick Frame Wall that requires spandrel marking.\n```\n*Note: You can select multiple walls if needed.*\n\n### Step 3: Configuration (Optional)\n- If a default Catalog Key is not assigned, a properties dialog may appear.\n- Adjust the **Offset for mark** if the default position is not suitable.\n- Click **OK** or **Insert** to confirm.\n\n### Step 4: Generation\n- The script analyzes the wall geometry to identify angled studs and sill plates.\n- It projects the intersection points onto the plates and draws \"Mark\" entities.\n- The script instance will erase itself after generating the marks to keep the drawing clean.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Offset for mark | Number | 5.0 mm | Defines the distance from the calculated intersection point where the mark is placed on the plate. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom context menu options. Standard properties can be edited via the Properties Palette. |\n\n## Settings Files\n- **Filename**: *None*\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Adjusting Marks**: If you need to shift the marks after insertion, select the generated marks in the model and adjust the **Offset for mark** property in the Properties Palette (OPM).\n- **Wall Geometry**: Ensure your wall has a continuous bottom plate. If the script cannot find a valid sill plate or angled beams, it will delete itself silently.\n- **Complex Walls**: For complex geometries, the script attempts a fallback method by looking for Studs with HSB ID 26 to determine mark positions.\n\n## FAQ\n- **Q: The script disappeared immediately after I ran it. Did it fail?**\n  - A: Not necessarily. If the wall has no angled studs (e.g., it is a rectangular wall with a flat top) or if no sill plates were detected, the script erases itself automatically as there is nothing to mark.\n- **Q: Can I move the marks manually?**\n  - A: The marks are generated as static tools. While they can be moved using standard CAD commands, it is recommended to adjust the **Offset for mark** parameter to maintain associativity with the wall logic.\n- **Q: How do I update the marks if I change the wall shape?**\n  - A: Modify the wall geometry (e.g., change the roof pitch) using standard hsbCAD tools. The script instance (if it still exists) or a re-run of the script will update the positions based on the new geometry."
      },
      "tokens_used": 4773,
      "error": null
    }
  }
}