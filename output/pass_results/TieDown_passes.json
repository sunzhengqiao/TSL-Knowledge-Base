{
  "filename": "TieDown.mcr",
  "status": "completed",
  "total_tokens": 50552,
  "processing_time": 334.2244279384613,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "18aug2020",
            "author": "geoffroy.cenni@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [
          "ScrewCatalog.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 7769,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly passes _kModelSpace to tslNew.dbCreate(). It interacts with construction entities (ElementWallSF, TrussEntity) and performs 3D geometric calculations (realBody(), Body intersection, PlaneProfile). No 'sd_' prefix, Viewport usage, or drawing generation logic is present."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWallSF",
            "TrussEntity"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space (3D environment required to detect intersections between Wall and Truss elements).",
          "requiredSettings": [
            "ScrewCatalog.xml"
          ]
        }
      },
      "tokens_used": 7047,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity.go",
              "promptOriginal": "|Select wall(s) and truss(es)|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getBeam",
              "promptOriginal": "|Select Truss beam|",
              "condition": "_bOnInsert && (Walls.length() < 1 || Trusses.length() < 1)",
              "required": true
            },
            {
              "step": 3,
              "function": "getBeam",
              "promptOriginal": "|Select Wall beam|",
              "condition": "_bOnInsert && (Walls.length() < 1 || Trusses.length() < 1)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "During Insertion (Manufacturer Selection)",
            "title": null,
            "dataSource": "sManufacturers array",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowDynamicDialog",
            "trigger": "During Insertion (Family Selection)",
            "title": null,
            "dataSource": "sFamilies array",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sPainter",
            "type": "PropString",
            "displayName": "|Painter|",
            "defaultValue": "<|Disabled|>",
            "inputType": "dropdown",
            "options": [
              "<|Disabled|>"
            ],
            "category": "|Filter|",
            "description": "|A filter which will use painter definitions|"
          },
          {
            "index": 1,
            "variable": "sScrewAngled",
            "type": "PropString",
            "displayName": "|Is Angled|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Rotation|",
            "description": "|Defines if the Screw is angled or perpendicular|"
          },
          {
            "index": 2,
            "variable": "sManufacturer",
            "type": "PropString",
            "displayName": "|Manufacturer|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Manufacturer|"
          },
          {
            "index": 3,
            "variable": "sFamily",
            "type": "PropString",
            "displayName": "|Family|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": "|Product|",
            "description": null
          },
          {
            "index": 0,
            "variable": "dLength",
            "type": "PropDouble",
            "displayName": "|Length|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Product|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "ScrewCatalog.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings",
              "_kPathHsbInstall\\Content\\General\\TSL\\Settings"
            ],
            "purpose": "Contains lists of Manufacturers, Families, Products, Lengths, Materials, and Colors.",
            "required": true
          }
        ]
      },
      "tokens_used": 7583,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts a structural tie-down connector (screw) to anchor roof trusses to wall top plates for wind uplift resistance.",
          "category": "Hardware / Connection",
          "typicalUseCase": "Connecting a Truss element to a Stud Wall element where perpendicular connection is required to secure the roof structure."
        },
        "parameters": [
          {
            "name": "sPainter",
            "technicalDefault": "<|Disabled|>",
            "businessMeaning": "A classification filter used to apply specific visual styles, grouping, or processing rules defined in the project's painter definitions.",
            "validRange": "List of Painter Definitions available in the current hsbCAD project",
            "unit": "String",
            "affectsOutput": "Filtering in lists/views and visual attributes of the generated connector."
          },
          {
            "name": "sScrewAngled",
            "technicalDefault": "|No|",
            "businessMeaning": "Determines the installation method of the screw: either driven vertically (perpendicular) into the top plate or at an angle to optimize uplift resistance or avoid obstructions.",
            "validRange": "|No| (Perpendicular), |Yes| (Angled)",
            "unit": "Boolean/String",
            "affectsOutput": "The geometric orientation and insertion angle of the 3D screw body relative to the wall beams."
          },
          {
            "name": "sManufacturer",
            "technicalDefault": "",
            "businessMeaning": "The specific brand or supplier of the tie-down hardware (e.g., Mitek, Simpson). This dictates the geometric standards and catalog data available for selection.",
            "validRange": "Manufacturers listed in ScrewCatalog.xml",
            "unit": "String",
            "affectsOutput": "Filters the available Families, determines specific geometric dimensions, and sets the manufacturer name in the BOM."
          },
          {
            "name": "sFamily",
            "technicalDefault": "",
            "businessMeaning": "The specific product line or model of the screw (e.g., StudLok). This defines the shape, head type, and material properties of the connector.",
            "validRange": "Product families listed in ScrewCatalog.xml under the selected Manufacturer",
            "unit": "String",
            "affectsOutput": "Filters the available Lengths, sets the Model name in the BOM, and defines internal geometry like head and thread diameters."
          },
          {
            "name": "dLength",
            "technicalDefault": "0",
            "businessMeaning": "The nominal length of the screw. This ensures the connector penetrates the wall top plate sufficiently to engage the truss bottom chord.",
            "validRange": "Lengths listed in ScrewCatalog.xml under the selected Family (typically mm)",
            "unit": "mm (Length)",
            "affectsOutput": "The physical length of the 3D screw body and the 'DScaleX' (scale) of the hardware component in the BOM."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sManufacturer is changed",
            "effect": "Updates the list of available sFamily options. Resets sFamily and dLength to defaults or empty.",
            "cascade": [
              "sFamily",
              "dLength"
            ]
          },
          {
            "trigger": "sFamily is changed",
            "effect": "Updates the list of available dLength options and loads internal geometric parameters (diameters, head dimensions) from the catalog.",
            "cascade": [
              "dLength"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "3D Body (Visual Representation)",
            "description": "A cylinder combination representing the screw thread and head, drawn in the model space to visualize the connection.",
            "appliedTo": "Intersection of Wall Top Plate and Truss Bottom Chord."
          },
          {
            "type": "Hardware Component (BOM Entry)",
            "description": "A data object containing Article Number, Manufacturer, Model, Length, and Diameter for reports and material lists.",
            "appliedTo": "The TSL instance itself (linked to the element)."
          }
        ]
      },
      "tokens_used": 9809,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Start Insertion (_bOnInsert)\",\n    \"2. Load ScrewCatalog.xml from Company or Install path\",\n    \"3. Validate Manufacturers list is not empty\",\n    \"4. Select Manufacturer: Check ExecuteKey token -> Prompt Dialog (if >1) -> Set Default (if 1)\",\n    \"5. Select Family: Check ExecuteKey token -> Prompt Dialog (if >1) -> Set Default (if 1)\",\n    \"6. Set Length (Property Grid based on Family selection)\",\n    \"7. Entity Selection: Prompt for Wall(s) and Truss(es)\",\n    \"8. [Branch] Determine Selection Mode:\",\n    \"   Path A (Elements Found): Loop through Wall/Truss pairs -> Spawn Child TSL (nMode=1) -> Erase Parent\",\n    \"   Path B (Beams Required): Prompt for individual Truss Beam -> Prompt for individual Wall Beam -> Keep Instance\",\n    \"9. [Path A Sub-flow] Child TSL (nMode=1) Execution:\",\n    \"   Validate Truss/Wall Perpendicularity\",\n    \"   Calculate Common Profile Intersection\",\n    \"   Validate Z-Axis Alignment (Wall Top vs Truss Bottom)\",\n    \"   Identify Intersecting Beams\",\n    \"   Spawn Final TSL (referencing specific beams) -> Erase Child\",\n    \"10. Final Instance Execution (Geometric Generation):\",\n    \"   Extract geometric data from ScrewCatalog (Diameters, Head Length)\",\n    \"   Calculate Screw Coordinates (Top, Bottom) based on 'Is Angled' property\",\n    \"   Generate 3D Visuals (Thread and Head Bodies)\",\n    \"   Generate/Update Hardware Component (BOM Entry)\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Manufacturer Input Source\",\n      \"path1\": {\n        \"name\": \"Token Provided\",\n        \"steps\": [\n          \"Parse ExecuteKey (e.g., 'Mitek?StudLok')\",\n          \"Match token to Manufacturers list\",\n          \"Auto-set Manufacturer property\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Manual Selection\",\n        \"steps\": [\n          \"Open Dynamic Dialog if Manufacturers.length > 1\",\n          \"User selects Manufacturer\",\n          \"Set Manufacturer property\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Entity Selection Results\",\n      \"path1\": {\n        \"name\": \"Element Mode (Batch)\",\n        \"steps\": [\n          \"User selected ElementWallSF and TrussEntity\",\n          \"Script sets nMode=1 in Map\",\n          \"Script spawns new instance for every Wall/Truss pair\",\n          \"Parent instance erases itself\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Beam Mode (Single)\",\n        \"steps\": [\n          \"User failed to select valid Elements\",\n          \"Script prompts 'Select Truss beam'\",\n          \"Script prompts 'Select Wall beam'\",\n          \"Script retains current instance to generate screw\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Element Geometry Validation (Inside Child TSL)\",\n      \"path1\": {\n        \"name\": \"Valid Geometry\",\n        \"steps\": [\n          \"Truss is perpendicular to Wall\",\n          \"Intersection area > 0\",\n          \"Wall Top Z matches Truss Bottom Z\",\n          \"Spawn Final Component TSL\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Invalid Geometry\",\n        \"steps\": [\n          \"Report failure (if debug mode)\",\n          \"Erase instance (No screw generated)\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"ScrewCatalog.xml Manufacturers List\",\n      \"errorMessage\": \"|Could not find manufacturer data.| |Tool will be deleted.|\",\n      \"recovery"
      },
      "tokens_used": 11274,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# TieDown.mcr\n\n## Overview\nInserts a structural tie-down screw (hardware connector) to anchor roof trusses to wall top plates for wind uplift resistance. It supports batch processing by automatically placing screws at intersections between Wall and Truss elements.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D intersection calculations. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | Not applicable. |\n\n## Prerequisites\n- **Required Entities:** Wall elements (`ElementWallSF`) and Truss elements (`TrussEntity`). Alternatively, individual Wall and Truss beams can be selected.\n- **Minimum Beam Count:** 2 (One Wall Top Plate beam and one Truss Bottom Chord beam).\n- **Required Settings:** `ScrewCatalog.xml` must exist in the Company or Install settings path.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `TieDown.mcr`.\n\n### Step 2: Select Manufacturer\nA dialog appears listing available manufacturers from the Screw Catalog.\n```\nAction: Click on a Manufacturer (e.g., Simpson, Mitek) and click OK.\nNote: If only one manufacturer exists in the catalog, this step may be skipped automatically.\n```\n\n### Step 3: Select Product Family\nA dialog appears listing product families (e.g., \"StudLok\") for the chosen manufacturer.\n```\nAction: Click on a Family and click OK.\n```\n\n### Step 4: Select Elements\nThe command line prompts for entity selection.\n```\nCommand Line: Select wall(s) and truss(es)\nAction: Click the Wall element and then the Truss element, or select both using a window selection. Press Enter to confirm.\n```\n*Note: If Elements are not detected, the script will fall back to prompting you to select individual beams (\"Select Truss beam\", then \"Select Wall beam\").*\n\n### Step 5: Adjust Parameters (Optional)\nAfter insertion, select the generated screw instance.\n```\nAction: Open the Properties Palette (Ctrl+1). Change the \"Length\" or \"Is Angled\" properties as needed.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Painter | dropdown | \\<Disabled\\> | Applies a specific visual style or filter based on project Painter definitions. |\n| Is Angled | dropdown | No | Sets the installation orientation. Select \"Yes\" for an angled screw or \"No\" for perpendicular installation. |\n| Manufacturer | dropdown | (From Catalog) | The brand of the hardware (e.g., Simpson). Changing this resets the Family and Length. |\n| Family | dropdown | (From Catalog) | The specific product model (e.g., StudLok). Changing this resets the Length. |\n| Length | number | 0 | The length of the screw in millimeters. Select from valid catalog entries. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Standard Options | Standard hsbCAD context options apply (Erase, Copy, Properties, etc.). No custom script-specific menu items are defined. |\n\n## Settings Files\n- **Filename**: `ScrewCatalog.xml`\n- **Location**: `_kPathHsbCompany\\TSL\\Settings` or `_kPathHsbInstall\\Content\\General\\TSL\\Settings`\n- **Purpose**: Defines the database of Manufacturers, Product Families, available Lengths, and geometric dimensions (diameters, head sizes) required to generate the 3D screw body.\n\n## Tips\n- **Batch Processing:** To insert multiple screws at once, select the entire Wall element and the entire Truss element during the selection prompt. The script will calculate valid intersections and create an instance for each location.\n- **Validation:** The script automatically checks if the Truss is perpendicular to the Wall. If the geometry is invalid (e.g., parallel or no intersection), no screw will be created at that location.\n- **Quick Command:** You can preset parameters via the command line using tokens, e.g., `TieDown.mcr?ManufacturerName?FamilyName`.\n- **Visuals:** The script generates a 3D cylinder body representing the screw. Use this to check for clashes with other connectors or studs in the wall.\n\n## FAQ\n- **Q: The script deletes itself immediately after I select the elements. Why?**\n  - A: This usually happens in \"Batch Mode\". When you select Elements, the main script acts as a \"manager\"â€”it spawns individual screw scripts at the valid intersections and then erases itself. Check the intersections; the screws should be there.\n- **Q: I get an error \"Could not find manufacturer data.\"**\n  - A: The `ScrewCatalog.xml` file is missing from your settings folders, or it is empty. Contact your hsbCAD administrator.\n- **Q: Can I use this on non-standard roofs?**\n  - A: The script requires the Truss and Wall to be roughly perpendicular and their Z-axes (Top of Wall / Bottom of Truss) to align reasonably well. Complex geometries may require manual beam selection or individual placement."
      },
      "tokens_used": 7070,
      "error": null
    }
  }
}