{
  "filename": "hsbAcisExport.mcr",
  "status": "completed",
  "total_tokens": 46660,
  "processing_time": 150.38606429100037,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 0,\n    \"minorVersion\": 0,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.7\",\n      \"date\": \"20.02.2023\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-18017: make sure the tsl is updated when language is changed\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"25.11.2022\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-17177: add \\\"solid quality\\\" of klhDisplay\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"21.11.2022\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-17114:If \\\"klhDisplay\\\" tsl instances are found, make sure to export their text solid for coating side\"\n    },\n    {\n      \"version\": \"1.4\",\n      \"date\": \"27.09.2022\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-16663: If \\\"klhDisplay\\\" tsl instances are found, make sure to export"
      },
      "tokens_used": 8896,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script functions as a command utility for exporting 3D geometry (SAT/STL). It uses 'PrEntity' to prompt for user selection of solid entities and calls 'eraseInstance()' immediately after execution, which is typical behavior for Model Space command scripts rather than persistent elements. It explicitly sets 'bForceModelSpace = true' when creating helper TSL instances. It contains no '#Type E' declarations, '_Viewport' handling, or 'sd_' prefixes associated with Shop Drawings or Paper Space."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element",
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing solid entities (Beams, Sheets, or TSLs with solid representations).",
          "requiredSettings": [
            "Optional: 'klhDisplay' or 'klhCoating' scripts for specific grain/coating export features."
          ]
        }
      },
      "tokens_used": 6957,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && !(_kExecuteKey.length()>0)",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select entities|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity",
              "promptOriginal": "|Select subtraction entities|",
              "condition": "_bOnInsert && nSolidMode==1 && 0",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFileName",
            "type": "PropString",
            "displayName": "|File Name|",
            "defaultValue": "dwgName()",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the file name.| |The specified may contain format expressions such as @(Name:D\"\") which will create individual files named after the resolving.|"
          },
          {
            "index": 1,
            "variable": "sSolidMode",
            "type": "PropString",
            "displayName": "|Mode|",
            "defaultValue": "|BREP|",
            "inputType": "dropdown",
            "options": [
              "|BREP|",
              "|CSG|"
            ],
            "category": "|General|",
            "description": "|Defines the solid model mode.| |BREP (Boundary Representation) describes only the oriented surface of a solid as a data structure composed of vertices, edges, and faces.| |CSG (Constructive Solid Geometry) describes a solid represented as a Boolean expression of primitive solid objects of a simpler structure.| |Using the CSG mode you can (optional) select solids to be used as subtraction of the model| |CSG mode resolves certain tools automatically.|"
          },
          {
            "index": 2,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "|SAT|",
            "inputType": "dropdown",
            "options": [
              "|SAT|",
              "|STL|"
            ],
            "category": "|General|",
            "description": "|Defines the export format|, |SAT = Acis Solid, STL = Standard Tesselation Language (3D Printing)|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7130,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Exports selected 3D solid entities (beams, sheets, or custom TSL geometry) to external 3D files (SAT or STL) for use in CAD interchange or 3D printing.",
          "category": "Data Exchange / Utilities",
          "typicalUseCase": "Generating 3D model files for CNC simulation, architectural visualization, 3D printing, or sharing structural timber models with clients or engineers who use non-hsbCAD software."
        },
        "parameters": [
          {
            "name": "sFileName",
            "technicalDefault": "dwgName()",
            "businessMeaning": "Specifies the name of the exported file. Supports dynamic naming tokens to automate file naming based on element properties (e.g., project number, beam name) to avoid overwriting when exporting multiple elements.",
            "validRange": "Valid filename strings (no special characters like :;/\\). Can include format expressions like @(Name:D\"\").",
            "unit": "String (Text)",
            "affectsOutput": "Determines the destination filename and path for the SAT or STL file. Invalid characters are automatically replaced with underscores."
          },
          {
            "name": "sSolidMode",
            "technicalDefault": "BREP",
            "businessMeaning": "Defines the geometric calculation method for the export. 'BREP' exports the exact current visual geometry. 'CSG' calculates the final solid by reconstructing the beam and applying all tools (machinings) mathematically, which is useful for high-fidelity representation of complex joinery.",
            "validRange": "BREP, CSG",
            "unit": "Enumeration",
            "affectsOutput": "BREP mode exports the visible body immediately. CSG mode triggers a recalculation of the raw beam body with all subtractions (tools) applied, potentially resolving details that might be visual approximations in the model view."
          },
          {
            "name": "sFormat",
            "technicalDefault": "SAT",
            "businessMeaning": "Selects the target 3D file format for the export. SAT is a precise CAD format for solid modeling, while STL is a mesh format commonly used for 3D printing.",
            "validRange": "SAT, STL",
            "unit": "Enumeration",
            "affectsOutput": "SAT creates a .sat file containing precise NURBS/BREP geometry. STL creates a .stl file containing a triangulated mesh approximation of the geometry."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sSolidMode is set to CSG",
            "effect": "Enables the reconstruction of the solid geometry based on the raw beam and its tools. In the script context, this mode allows for the specific handling of 'GrainBody' and complex tool subtractions that might not be fully resolved in standard BREP mode.",
            "cascade": []
          },
          {
            "trigger": "Selected entities include 'klhDisplay' or 'klhCoating' TSLs",
            "effect": "The script temporarily forces these TSLs to generate their internal solids (grain direction or coating text) to ensure they are included in the export, then restores their original display settings.",
            "cascade": [
              "Internal TSL properties (bShowGrain, bShowArrow, etc.)"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "External File (SAT/STL)",
            "description": "Generates a 3D file saved to the drawing directory containing the geometry of the selected entities. In CSG mode, it may also generate a temporary cylinder representing wood grain direction if enabled.",
            "appliedTo": "Disk (File System)"
          }
        ]
      },
      "tokens_used": 7725,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Execution Start",
          "Check if Insert Cycle > 1",
          "[If Cycle > 1] Erase Instance and Exit",
          "Check Execution Key (Silent Mode)",
          "[If Key Exists] Load Properties from Catalog",
          "[If No Key] Show Properties Dialog",
          "Determine Mode (BREP or CSG)",
          "Prompt User to Select Entities",
          "Filter Entities: Remove non-solids (except klhDisplay/klhCoating)",
          "[Branch Based on Mode]",
          "[If BREP] Assign entities to script instance and Recalculate",
          "[If CSG] Create Helper TSL Instances for each entity",
          "[CSG Path] Recalculate Helper TSLs",
          "[CSG Path] Retrieve Export Filename from Helper Map",
          "[CSG Path] Export Geometry (SAT/STL) to File",
          "[CSG Path] Erase Helper TSLs",
          "[CSG Path] Collect BREP-only exports",
          "[CSG Path] Create Single Aggregator TSL for BREP leftovers",
          "[BREP/Aggregator Path] Check for KLH scripts (klhDisplay/klhCoating)",
          "[If KLH Found] Temporarily Force Solid Generation Properties",
          "[If KLH Found] Recalc KLH instances",
          "Generate Final Filename",
          "Sanitize Filename (remove forbidden chars)",
          "Export Geometry to SAT or STL",
          "Report Success Message",
          "[If KLH Found] Restore Original KLH Properties",
          "[If KLH Found] Recalc KLH instances",
          "Erase Script Instance",
          "Script End"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Subsequent Cycle",
              "steps": [
                "Erase Instance",
                "Exit"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Continue to Property Dialog"
              ]
            }
          },
          {
            "condition": "Execution Key (_kExecuteKey) Presence",
            "path1": {
              "name": "Silent Mode",
              "steps": [
                "Load Catalog Settings",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Interactive Mode",
              "steps": [
                "Show Standard Dialog"
              ]
            }
          },
          {
            "condition": "Solid Mode Selection (sSolidMode)",
            "path1": {
              "name": "BREP Mode (Default)",
              "steps": [
                "Assign selected entities to _Entity",
                "Script recalculates with assigned entities",
                "Export BREP geometry directly"
              ]
            },
            "path2": {
              "name": "CSG Mode",
              "steps": [
                "Iterate selected solids",
                "Create temporary TSL instance per solid",
                "Pass 'mode': 1 to temporary instances",
                "Re-run script logic for CSG reconstruction",
                "Export results",
                "Clean up temporary instances"
              ]
            }
          },
          {
            "condition": "Selected Entity Type (Filtering)",
            "path1": {
              "name": "Valid Solid",
              "steps": [
                "Retain for export"
              ]
            },
            "path2": {
              "name": "Non-Solid",
              "steps": [
                "Check if 'klhDisplay' or 'klhCoating'",
                "If Yes, Retain",
                "If No, Remove from selection"
              ]
            }
          },
          {
            "condition": "Format Selection (sFormat)",
            "path1": {
              "name": "SAT",
              "steps": [
                "Create RealBodySatFile"
              ]
            },
            "path2": {
              "name": "STL",
              "steps": [
                "Create RealBodyStlFile"
              ]
            }
          },
          {
            "condition": "Filename Format Expression",
            "path1": {
              "name": "Expression Detected (CSG Mode)",
              "steps": [
                "Set bCreateAsOne flag",
                "Store filename in Map for Helper TSL",
                "Helper TSL exports individually"
              ]
            },
            "path2": {
              "name": "Static Filename",
              "steps": [
                "Helper TSL aggregates to single export list"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Solid Volume",
            "errorMessage": "None explicitly to user, but entity is filtered out.",
            "recovery": "Select entities with actual 3D geometry (Beams, Sheets, Solids). Note: klhDisplay is accepted even if volume is low."
          },
          {
            "check": "Filename Format",
            "errorMessage": "None explicit, invalid characters are silently replaced.",
            "recovery": "Script replaces '. ; : \\ / & \"' with '_' automatically. Path is appended if missing."
          },
          {
            "check": "Catalog/Key Lookup",
            "errorMessage": "None",
            "recovery": "If Key not found in catalog, defaults to 'LastInserted' settings."
          },
          {
            "check": "CSG Filename Resolve",
            "errorMessage": "None",
            "recovery": "If format expression fails to resolve or is empty, defaults to the base sFileName property."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties (OPM)",
            "how": "Select the TSL instance before it auto-deletes or modify catalog entry.",
            "effect": "Changes Filename, Mode, or Format for the next execution."
          },
          {
            "action": "Re-execute",
            "how": "Run command again or use Execute Key.",
            "effect": "Restarts the workflow, prompting for new entities or reusing catalog settings."
          }
        ]
      },
      "tokens_used": 9319,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbAcisExport.mcr\n\n## Overview\nThis script exports selected 3D solid entities (beams, sheets, or custom TSL geometry) to external SAT or STL files. It is designed for data interchange with other CAD software or for preparing models for 3D printing, supporting both visual (BREP) and calculated solid (CSG) export modes.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script runs in the 3D model to export solid geometry. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities:** GenBeams, Elements, or TSL instances with solid geometry (e.g., `klhDisplay`).\n- **Minimum Beam Count:** 0 (You can export single solids or groups).\n- **Required Settings:** None strictly required, though the script interacts specifically with `klhDisplay` or `klhCoating` TSLs if present to ensure grain/coating details are exported.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbAcisExport.mcr` from the list.\n\n### Step 2: Configure Properties\n**Action:** The Properties Palette (OPM) will appear. Configure the following before proceeding:\n- **File Name:** Enter the desired name (e.g., `ProjectExport`). You can use format expressions like `@(Name:D\"\")` to name files based on entity properties.\n- **Mode:** Choose **BREP** for quick visual export or **CSG** for precise geometric reconstruction including tooling.\n- **Format:** Choose **SAT** for CAD interchange or **STL** for 3D printing.\n\n### Step 3: Select Entities\n```\nCommand Line: Select entities\nAction: Click on the beams, sheets, or solids in the model you wish to export. Press Enter when selection is complete.\n```\n\n### Step 4: Execution\nThe script will process the geometry, generate the file in the current drawing's directory, and automatically delete the script instance from the model.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| File Name | Text | dwgName() | Defines the output file name. Supports dynamic tokens (e.g., `@(Name:D\"\")`) to create individual files per selected entity. Invalid characters are replaced automatically. |\n| Mode | Dropdown | BREP | **BREP:** Exports the boundary representation (visible surface).<br>**CSG:** Exports Constructive Solid Geometry (reconstructs the body including all tools/machinings). |\n| Format | Dropdown | SAT | **SAT:** ACIS Solid file (precise NURBS geometry).<br>**STL:** Standard Tesselation Language (triangulated mesh for 3D printing). |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| Standard Recalculate | Recalculates the script logic if parameters are changed manually. |\n\n## Settings Files\n- No specific external settings files are required. The script uses standard hsbCAD catalogs and defaults.\n\n## Tips\n- **Batch Exporting:** Use the `@(Name:D\"\")` syntax in the **File Name** field. This ensures that if you select 10 different beams, the script creates 10 separate files named after each beam, rather than overwriting a single file.\n- **CSG Mode:** Use CSG mode if the visual representation in hsbCAD shows simplifications, but you need the full machining detail in the export (e.g., for CNC verification).\n- **KLH Elements:** If you are using `klhDisplay` or `klhCoating` scripts, this tool automatically detects them and forces the generation of grain/coating solids for the export, ensuring they appear in the SAT/STL file.\n\n## FAQ\n- **Q: Where is the exported file saved?**\n  - **A:** The file is saved in the same folder as your current CAD drawing (DWG).\n- **Q: Why did the script disappear after I ran it?**\n  - **A:** This is a utility script designed to perform a task (export) and then clean up after itself. It does not remain as a persistent object in the drawing.\n- **Q: What is the difference between SAT and STL?**\n  - **A:** SAT is a vector-based format used for CAD editing (preserves curves and precise faces). STL is a mesh format made of triangles, used primarily for 3D printing and visualization.\n- **Q: Can I export only specific tools or subtractions?**\n  - **A:** The script exports the final composite body of the selected elements. Use CSG mode to ensure all tools are mathematically included in that body."
      },
      "tokens_used": 6633,
      "error": null
    }
  }
}