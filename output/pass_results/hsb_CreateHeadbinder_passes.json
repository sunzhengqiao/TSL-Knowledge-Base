{
  "filename": "hsb_CreateHeadbinder.mcr",
  "status": "completed",
  "total_tokens": 56337,
  "processing_time": 265.18934535980225,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9246,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Uses PrEntity to select Element(), iterates ElementWall and Beam objects to create geometry. Creates Groups and Beams in Model Space. Does not use sd_ prefix, #Type E, or _Viewport."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing Element Walls with Top Plates",
          "requiredSettings": [
            "hsb_SolePlate Material Table script (if Show BOM is Yes)"
          ]
        }
      },
      "tokens_used": 7054,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialogOnce\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert && insertCycleCount() == 1\",\n        \"required\": false\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Select the Location for the Material Table\",\n        \"condition\": \"_bOnInsert && bShowBOM == true\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"\\nSelect a set of elements\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Name\",\n      \"defaultValue\": \"Headbinder\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Material\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sGrade\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Grade\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sInformation\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Information\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sLabel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Label\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sSublabel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Sublabel\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sSublabel2\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Sublabel 2\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"sGrpNm1\",\n      \"type\": \"PropString\",\n      \"displayName\": \"House Level group name\",\n      \"defaultValue\": \"00_GF-Headbinder\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 8,\n      \"variable\": \"sGrpNm2\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Floor Level group name\",\n      \"defaultValue\": \"GF-Headbinder\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 9,\n      \"variable\": \"psExtType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Code External Walls\",\n      \"defaultValue\": \"A;B;\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Please type the codes of the External walls separate by ; \"\n    },\n    {\n      \"index\": 10,\n      \"variable\": \"psIntType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Code Party Walls\",\n      \"defaultValue\": \"F;G;\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Please type the codes of the Party walls separate by ; \"\n    },\n    {\n      \"index\": 11,\n      \"variable\": \"psHBType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Headbinder Type\",\n      \"defaultValue\": \"Loose Material\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Loose Material\",\n        \"Fix to the Element\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 12,\n      \"variable\": \"sAA\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Details of the BOM\",\n      \"defaultValue\": \"------------------------\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 13,\n      \"variable\": \"sShowBOM\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Show BOM\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 14,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimstyle\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": \"_DimStyles\",\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 15,\n      \"variable\": \"sDispRep\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Show the Metal Parts in Disp Rep\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"\"\n    },\n    {\n      \"index\": 16,\n      \"variable\": \"sNails\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Insert Nails\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n     "
      },
      "tokens_used": 9936,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the generation of headbinders (rim beams) running along the top of selected timber walls, including length optimization, material assignment, and BOM creation.",
          "category": "Framing",
          "typicalUseCase": "Used after wall design is complete to generate the horizontal top plates that tie studs together, calculating material requirements and nail counts for procurement or shop drawings."
        },
        "parameters": [
          {
            "name": "psExtType",
            "technicalDefault": "A;B;",
            "businessMeaning": "Identifies which wall codes represent 'External' walls for labeling purposes.",
            "validRange": "String containing wall codes separated by semicolons (e.g., 'A;B;EXT;')",
            "unit": "string",
            "affectsOutput": "Assigns specific labels ('External') to headbinders if the parent wall code matches this list."
          },
          {
            "name": "psIntType",
            "technicalDefault": "F;G;",
            "businessMeaning": "Identifies which wall codes represent 'Party' (fire-rated/shared) walls.",
            "validRange": "String containing wall codes separated by semicolons (e.g., 'F;G;PARTY;')",
            "unit": "string",
            "affectsOutput": "Assigns specific labels ('Party') to headbinders if the parent wall code matches this list."
          },
          {
            "name": "psHBType",
            "technicalDefault": "Loose Material",
            "businessMeaning": "Defines the construction method: separate loose timbers or fixed part of the wall element.",
            "validRange": "Loose Material, Fix to the Element",
            "unit": "enum",
            "affectsOutput": "'Loose Material' creates separate beams in a construction group; 'Fix to Element' integrates them into the wall's specific element group."
          },
          {
            "name": "sShowBOM",
            "technicalDefault": "No",
            "businessMeaning": "Toggles the generation of a Bill of Materials table on the drawing.",
            "validRange": "Yes, No",
            "unit": "bool",
            "affectsOutput": "If Yes, triggers a point selection for table placement and runs the 'hsb_SolePlate Material Table' script."
          },
          {
            "name": "sNails",
            "technicalDefault": "No",
            "businessMeaning": "Includes nail requirements in the BOM calculation.",
            "validRange": "Yes, No",
            "unit": "bool",
            "affectsOutput": "If Yes, calculates nail quantity based on total headbinder length, spacing, and wastage."
          },
          {
            "name": "dH1SolePlate",
            "technicalDefault": "38",
            "businessMeaning": "The height (depth) of the headbinder timber cross-section.",
            "validRange": "35 - 300",
            "unit": "mm",
            "affectsOutput": "Determines the vertical size of the generated beam geometry."
          },
          {
            "name": "dMaxLength",
            "technicalDefault": "4800",
            "businessMeaning": "The maximum practical length for a single piece of timber (transport/handling limit).",
            "validRange": "2400 - 12000",
            "unit": "mm",
            "affectsOutput": "Longer headbinders are split into multiple pieces joined end-to-end at this interval."
          },
          {
            "name": "dMinLength",
            "technicalDefault": "600",
            "businessMeaning": "The minimum acceptable length for a cut piece to avoid unusable offcuts.",
            "validRange": "300 - 1500",
            "unit": "mm",
            "affectsOutput": "Influences where splits occur; ensures the last segment of a split beam meets minimum size."
          },
          {
            "name": "dNailsCenters",
            "technicalDefault": "600",
            "businessMeaning": "The spacing (center-to-center) between nails fixing the headbinder.",
            "validRange": "150 - 1000",
            "unit": "mm",
            "affectsOutput": "Used to calculate the total number of nails required for the BOM."
          },
          {
            "name": "sGrpNm1",
            "technicalDefault": "00_GF-Headbinder",
            "businessMeaning": "Top-level organizational group name (e.g., House Level).",
            "validRange": "Any valid group path string",
            "unit": "string",
            "affectsOutput": "Sets the parent group for the created beams."
          },
          {
            "name": "sGrpNm2",
            "technicalDefault": "GF-Headbinder",
            "businessMeaning": "Second-level organizational group name (e.g., Floor Level).",
            "validRange": "Any valid group path string",
            "unit": "string",
            "affectsOutput": "Sets the child group for the created beams."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sShowBOM set to 'Yes'",
            "effect": "Enables command line prompt to select table location.",
            "cascade": [
              "_Pt0"
            ]
          },
          {
            "trigger": "sNails set to 'Yes'",
            "effect": "Activates BOM row calculation for nail boxes.",
            "cascade": [
              "sNailMaterial",
              "dNailsCenters",
              "nNailsBox",
              "dExtraPercent"
            ]
          },
          {
            "trigger": "psHBType set to 'Fix to the Element'",
            "effect": "Overrides default group naming; uses the wall's existing group structure.",
            "cascade": [
              "sGrpNm1",
              "sGrpNm2"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Linear timber elements representing headbinders/rim joists, generated along the top wall outline.",
            "appliedTo": "Selected Element Walls containing Top Plates."
          },
          {
            "type": "Group",
            "description": "Construction groups organizing the generated beams by project level.",
            "appliedTo": "Generated Beams."
          },
          {
            "type": "TslInst (Material Table)",
            "description": "A drawing table instance generated by 'hsb_SolePlate Material Table' listing timber lengths and nail quantities.",
            "appliedTo": "Model Space (at selected point)."
          }
        ]
      },
      "tokens_used": 10787,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User executes script (hsb_CreateHeadbinder)",
          "Check insert cycle; if > 1, erase script instance and stop",
          "If no Execute Key, show Configuration Dialog (properties)",
          "Check 'Show BOM' property",
          "If Show BOM is 'Yes', prompt user to select location for Material Table",
          "Prompt user to Select a set of elements (Walls)",
          "Script validates selection (must be ElementWall with Top Plates)",
          "Iterate through selected walls",
          "Filter wall beams to identify Top Plates",
          "Determine wall labeling (External vs Party) based on wall code",
          "Create Headbinder geometry based on Top Plate extents",
          "Assign Headbinder to Group (Loose Material or Fixed to Element)",
          "Aggregate all created beams",
          "Split beams longer than 'Max Length' into segments",
          "Calculate totals for Bill of Materials",
          "If 'Insert Nails' is Yes, calculate nail quantity and boxes",
          "If Show BOM is 'Yes', insert 'hsb_SolePlate Material Table' at selected point",
          "Erase script instance"
        ],
        "conditionalBranches": [
          {
            "condition": "Headbinder Type (psHBType)",
            "path1": {
              "name": "Loose Material",
              "steps": [
                "Create specific Group structure (House Level + Floor Level)",
                "Set Group as Deliverable Container",
                "Add generated beams to this specific group"
              ]
            },
            "path2": {
              "name": "Fix to the Element",
              "steps": [
                "Retrieve existing Group from the selected Wall",
                "Add generated beams directly to the Wall's element group",
                "Skip creating separate 'Headbinder' construction groups"
              ]
            }
          },
          {
            "condition": "Wall Code Matching (for Labeling)",
            "path1": {
              "name": "External Wall",
              "steps": [
                "Check if wall code exists in 'Code External Walls' string",
                "If match, assign 'External' label logic"
              ]
            },
            "path2": {
              "name": "Party Wall",
              "steps": [
                "Check if wall code exists in 'Code Party Walls' string",
                "If match, assign 'Party' label logic"
              ]
            },
            "path3": {
              "name": "Standard/Internal",
              "steps": [
                "Apply default labeling if no code matches found"
              ]
            }
          },
          {
            "condition": "Beam Length vs Max Length",
            "path1": {
              "name": "Short Beam (<= Max Length)",
              "steps": [
                "Add beam to list without modification"
              ]
            },
            "path2": {
              "name": "Long Beam (> Max Length)",
              "steps": [
                "Calculate number of splits",
                "Iteratively split beam at Max Length intervals",
                "Check tail length: if < Min Length, adjust previous cut point backwards",
                "Add resulting segments to list"
              ]
            }
          },
          {
            "condition": "Show BOM (sShowBOM)",
            "path1": {
              "name": "Yes",
              "steps": [
                "Prompt user for Point location (_Pt0)",
                "Compile beam dimensions into arrays",
                "Calculate nails if enabled",
                "Execute 'hsb_SolePlate Material Table' script with data"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip table generation prompts",
                "Skip table insertion"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "None (silent skip)",
            "recovery": "User must select at least one valid ElementWall. If no elements are selected, the script erases itself immediately."
          },
          {
            "check": "Top Plate Existence",
            "errorMessage": "None (internal continue)",
            "recovery": "If a selected wall contains no beams of type '_kSFTopPlate' or '_kTopPlate', the script skips that specific wall and continues to the next."
          },
          {
            "check": "Split Geometry Validity",
            "errorMessage": "None (internal logic)",
            "recovery": "Script ensures split segments meet 'Min Length' requirements. If splitting creates a piece smaller than Min Length, it adjusts the cut point to merge the short piece with the previous segment."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Generated Geometry",
            "how": "AutoCAD Grips / Properties Palette",
            "effect": "Since the script erases itself after execution, changes to configuration (e.g. Material, Dimensions) require re-running the script. However, the resulting Beams and Groups are standard CAD entities and can be modified directly."
          },
          {
            "action": "Update Material Table",
            "how": "Regenerate script / Manual Edit",
            "effect": "The BOM is a separate script instance. To update it, the user must delete the old table and re-run the headbinder script with 'Show BOM' enabled."
          }
        ]
      },
      "tokens_used": 11274,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_CreateHeadbinder\n\n## Overview\nAutomates the generation of headbinders (rim beams) along the top of selected timber walls. It calculates material lengths, creates optimized beam segments based on maximum transport lengths, and optionally generates a Bill of Materials (BOM) table.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be run in Model Space where Element Walls exist. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Generates 3D model geometry, not 2D drawing views. |\n\n## Prerequisites\n- **Required Entities**: `ElementWall` entities with Top Plates already generated.\n- **Minimum Beams**: 0 (Requires Walls, but works on the wall geometry itself).\n- **Required Settings**: `hsb_SolePlate Material Table` script (if \"Show BOM\" is enabled).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_CreateHeadbinder.mcr`\n\n### Step 2: Configure Properties\n1.  Select the script instance in the drawing.\n2.  Open the **Properties Palette** (Ctrl+1).\n3.  Adjust settings such as Material, Dimensions, and Group Names as required.\n4.  Set **Show BOM** to \"Yes\" if you need a material list.\n\n### Step 3: Execute Creation\n1.  Right-click the script instance and select **Execute**.\n2.  **If Show BOM is \"Yes\"**: The command line will prompt: `Select the Location for the Material Table`. Click in the model to place the table.\n3.  **Prompt**: `Select a set of elements`.\n4.  **Action**: Click on the timber walls (ElementWalls) you wish to process and press Enter.\n\n### Step 4: Processing\nThe script will generate the headbinders. If \"Loose Material\" is selected, they will be placed in the specified construction group. If \"Fix to the Element\" is selected, they will be added directly to the wall's element group. The script instance will erase itself automatically upon completion.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Identification** | | | |\n| Name | String | Headbinder | Name assigned to the generated beam entities. |\n| Material | String | | Material code for the timber. |\n| Grade | String | | Timber grade. |\n| Information | String | | Additional text info. |\n| Label | String | | Primary label. |\n| Sublabel | String | | Secondary label. |\n| Sublabel 2 | String | | Third level label. |\n| **Grouping** | | | |\n| House Level group name | String | 00_GF-Headbinder | Top-level group name (e.g., Project level). |\n| Floor Level group name | String | GF-Headbinder | Second-level group name (e.g., Floor level). |\n| **Configuration** | | | |\n| Code External Walls | String | A;B; | Wall codes that define \"External\" walls (separated by `;`). Used for labeling. |\n| Code Party Walls | String | F;G; | Wall codes that define \"Party\" walls (separated by `;`). Used for labeling. |\n| Headbinder Type | Dropdown | Loose Material | **Loose Material**: Creates separate beams in a new group.<br>**Fix to the Element**: Adds beams to the existing Wall element group. |\n| Show BOM | Dropdown | No | If **Yes**, prompts for a location to insert a Material Table. |\n| Dimstyle | Dropdown | | Dimension style to use. |\n| Show the Metal Parts in Disp Rep | String | | Display representation setting. |\n| **Dimensions & Nails** | | | |\n| H1 SolePlate | Number | 38 | Height/Depth of the headbinder timber (mm). |\n| Max Length | Number | 4800 | Maximum length for a single piece (mm). Beams longer than this will be split. |\n| Min Length | Number | 600 | Minimum acceptable cut length (mm). Prevents tiny offcuts. |\n| Nails Centers | Number | 600 | Spacing between nails (mm). Used for BOM calculations. |\n| Insert Nails | Dropdown | No | If **Yes**, calculates nail quantities in the BOM. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Execute | Runs the script to generate geometry based on current properties. |\n| Erase | Removes the script instance from the drawing without generating geometry. |\n| Properties | Opens the Properties palette to edit parameters. |\n\n## Settings Files\n- **Script**: `hsb_SolePlate Material Table`\n- **Purpose**: This script is called internally if \"Show BOM\" is set to \"Yes\". It reads the generated data and formats it into a table on the drawing.\n\n## Tips\n- **Wall Codes**: Ensure your Wall Codes (e.g., \"A\" for external, \"F\" for party) match the values in the **Code External Walls** and **Code Party Walls** properties to ensure labels are applied correctly.\n- **Length Optimization**: The script automatically splits long walls into segments based on the **Max Length**. If the last segment is too short (below **Min Length**), the script adjusts the previous cut to ensure all pieces are usable.\n- **Re-running**: Since the script erases itself after running, you must insert `hsb_CreateHeadbinder.mcr` again if you need to regenerate the headbinders with new settings.\n- **Group Organization**: Use \"House Level group name\" to keep your \"Loose\" headbinders organized separately from the main wall structure, making it easier to generate cut lists or exports.\n\n## FAQ\n- **Q: Why did the script disappear after I selected the walls?**\n  - A: This is normal behavior. The script is designed to run once (\"Fire and Forget\"), create the geometry, and then erase itself to clean up the drawing.\n- **Q: The headbinders are not appearing in the correct group.**\n  - A: Check the **Headbinder Type** property. If set to \"Fix to the Element\", they will appear inside the specific Wall's group. If set to \"Loose Material\", they will appear in the group names specified in the Properties palette.\n- **Q: How do I change the size of the timber?**\n  - A: You cannot change the size of the generated beams simply by updating the script (because it erases itself). You must either manually edit the beam properties in AutoCAD or delete the beams and re-run the `hsb_CreateHeadbinder` script with the new **H1 SolePlate** dimension."
      },
      "tokens_used": 8040,
      "error": null
    }
  }
}