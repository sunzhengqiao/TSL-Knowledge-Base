{
  "filename": "HSB_G-CalculateProductionEstimates.mcr",
  "status": "completed",
  "total_tokens": 34120,
  "processing_time": 874.9393107891083,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 0,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates naillines for the different materials.",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "03.09.2018",
            "author": "AS",
            "changes": "First revision"
          },
          {
            "version": "1.01",
            "date": "07.09.2018",
            "author": "AS",
            "changes": "Support different shapes."
          },
          {
            "version": "1.02",
            "date": "12.09.2018",
            "author": "AS",
            "changes": "Show table."
          }
        ],
        "settingsFiles": [
          "ProductionRateConfigurations.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 6890,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Entity allElements[] = Group().collectEntities(true, Element(), _kModelSpace);"
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "ProductionRateConfigurations.xml"
          ]
        }
      },
      "tokens_used": 6079,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": "TSL Properties",
              "condition": "_bOnInsert && (_kExecuteKey == \"\" || catalogNames.find(_kExecuteKey) == -1)",
              "required": false
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Select a position",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "productionRateConfigurationName",
            "type": "PropString",
            "displayName": "Production rate configuration",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": "productionRateConfigurationNames (loaded from XML)",
            "category": "General",
            "description": "Specifies the production rate configuration to use."
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Reload production rate configurations",
            "handler": "reloadProductionRateConfigurationsCommand",
            "action": "Reloads the production rate configurations from the XML file into the drawing dictionary.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "ProductionRateConfigurations.xml",
            "searchPaths": [
              "_kPathHsbCompany + \\Tsl\\Settings"
            ],
            "purpose": "Stores default production rates for various element shapes and additional work calculations.",
            "required": true
          }
        ]
      },
      "tokens_used": 7608,
      "error": null
    },
    "4": {
      "success": false,
      "data": {},
      "tokens_used": 0,
      "error": "Request timeout after retries"
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Execution Start",
          "Check for XML Settings File: ProductionRateConfigurations.xml",
          "[Condition 1] File Missing?",
          "[Path Yes] Attempt to create default folder structure",
          "[Path Yes] Check folder creation success",
          "[Path Yes Fail] Report error and erase script instance",
          "[Path Yes Success] Create default configurations in memory (Default, A&T Default)",
          "[Path Yes Success] Write default configurations to XML file",
          "[Path Yes Success] Report default file creation",
          "[Path No] File exists, proceed to load",
          "Access Drawing Dictionary for Production Rate Configurations",
          "[Condition 2] Dictionary Entry Valid?",
          "[Path No] Check if XML file is still accessible",
          "[Path No File Missing] Report error and erase script instance",
          "[Path No File Found] Read XML file into Map",
          "[Path No File Found] Create Dictionary entry from Map",
          "[Path No File Found] Report configuration loaded",
          "[Path Yes] Dictionary is valid, proceed",
          "Check Execute Key for 'Reload production rate configurations'",
          "[Condition 3] Reload Command Triggered?",
          "[Path Yes] Check XML file accessibility",
          "[Path Yes File Missing] Report error, do not reload",
          "[Path Yes File Found] Read XML file into Map",
          "[Path Yes File Found] Update Dictionary entry",
          "[Path Yes File Found] Report reloaded",
          "Extract Configuration Maps and Names from Dictionary",
          "Define Properties: ProductionRateConfigurationName (Dropdown)",
          "[Condition 4] Is this an Insertion Event (_bOnInsert)?",
          "[Path Yes] Check Insert Cycle Count",
          "[Path Yes] [Condition 5] Cycle > 1?",
          "[Path Yes] Erase instance and return (Prevent duplicates)",
          "[Path No] Check Execute Key (Catalog)",
          "[Path No] [Condition 6] Catalog Name Found?",
          "[Path Yes] Set properties from Catalog values",
          "[Path No] Show Dialog for Configuration Selection",
          "[Path No] Prompt user for Insertion Point (getPoint)",
          "[Path No] Return (Finish Insertion)",
          "[Path No (Calculation Phase)] Retrieve Selected Configuration Name from Property",
          "[Condition 7] Configuration Name Valid?",
          "[Path No] Report warning and erase instance",
          "[Path Yes] Get Shape Rates and Units (Rect, Triangle, Hip, Valley, etc.)",
          "[Path Yes] Get Addition Rates and Units (if any)",
          "Collect all Elements from ModelSpace",
          "Loop through each Element",
          "Verify Element Validity",
          "[Condition 8] Element Invalid?",
          "[Path Yes] Skip to next Element",
          "[Path No] Get Envelope PLine",
          "[Path No] Get Vertex Points",
          "[Condition 9] Vertices < 3?",
          "[Path Yes] Skip to next Element",
          "[Path No] Calculate Shape Geometry (Orientation, Angles)",
          "[Path No] Determine Element Shape Type (Rectangle, Triangle, Hip, Valley, Internal Valley, Default)",
          "[Path No] Calculate Element Area (m2)",
          "[Path No] Retrieve Production Rate for Shape",
          "[Condition 10] Shape Known?",
          "[Path No] Report notice (unknown shape)",
          "[Path No] Calculate Estimated Time (Area * Rate)",
          "[Path No] Store Estimate in Element SubMap (hsb_ProductionData)",
          "[Path No] Repeat Loop",
          "End Element Loop",
          "Generate Visual Table",
          "Draw Headers (Element, Shape, Rate, Area, Estimate)",
          "Draw Data Rows for each calculated Element",
          "Script Execution End"
        ],
        "conditionalBranches": [
          {
            "condition": "XML Settings File Missing on Startup",
            "path1": {
              "name": "Successful Auto-Config",
              "steps": [
                "Create folder structure",
                "Generate default XML file with hard-coded rates",
                "Report success to user"
              ]
            },
            "path2": {
              "name": "Critical Failure",
              "steps": [
                "Folder creation fails",
                "Report error to user",
                "Erase script instance"
              ]
            }
          },
          {
            "condition": "User selects 'Reload production rate configurations' from Context Menu",
            "path1": {
              "name": "Successful Reload",
              "steps": [
                "Read XML file from disk",
                "Update drawing dictionary map",
                "Report reloaded status",
                "Script recalculates"
              ]
            },
            "path2": {
              "name": "File Not Found",
              "steps": [
                "Report XML file missing",
                "Do not update dictionary",
                "Existing data remains"
              ]
            }
          },
          {
            "condition": "Script Insertion Cycle",
            "path1": {
              "name": "First Insertion",
              "steps": [
                "Check for Catalog Execute Key",
                "Show Dialog if no key",
                "Get Insertion Point",
                "Create Visual Entity"
              ]
            },
            "path2": {
              "name": "Recalculation / Duplicate Cycle",
              "steps": [
                "Cycle > 1 detected",
                "Erase instance (prevents stacking)"
              ]
            }
          },
          {
            "condition": "Element Shape Analysis (Geometry)",
            "path1": {
              "name": "Simple Shapes (Vertices <= 4)",
              "steps": [
                "3 Vertices -> Triangle",
                "4 Vertices -> Triangle (Code logic path)",
                "Assign generic/default rate if needed"
              ]
            },
            "path2": {
              "name": "Complex Shapes (Vertices > 4)",
              "steps": [
                "Check Angles (90 vs Angled)",
                "Check Hip/Valley vectors",
                "Determine shape: Hip, Valley, Internal Valley, Rectangle (if all 90)",
                "Assign specific rate from configuration"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of 'ProductionRateConfigurations.xml' in Tsl\\Settings folder",
            "errorMessage": "Folder does not exist... or ...could not be found. The tsl will be deleted.",
            "recovery": "Ensure company path _kPathHsbCompany is correct and accessible. Script attempts to generate a default file if folder exists."
          },
          {
            "check": "Selected Production Rate Configuration Name in Properties",
            "errorMessage": "The selected production rate configuration could not be found: '[Name]'.",
            "recovery": "Select a valid configuration from the dropdown in the Properties Palette."
          },
          {
            "check": "Element Geometry Outline (Vertices count)",
            "errorMessage": "None explicit, but elements with < 3 vertices are skipped.",
            "recovery": "Ensure elements have valid closed 2D envelopes."
          },
          {
            "check": "Shape Name found in Configuration Map",
            "errorMessage": "Element [Number] has an unknown shape: [ShapeName].",
            "recovery": "Update the XML configuration to include the detected shape, or check element geometry validity."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Production Rate Configuration",
            "how": "Properties Palette (OPM) - Dropdown 'Production rate configuration'",
            "effect": "Triggers recalculation of all elements based on new rates. Updates table display and Element submaps."
          },
          {
            "action": "Reload Production Rate Configurations",
            "how": "Right-click Context Menu - 'Reload production rate configurations'",
            "effect": "Forces a read of the XML file from disk into the drawing dictionary, updating available configurations and current calculations immediately."
          },
          {
            "action": "Move Table",
            "how": "Grip Edit on Insertion Point (_Pt0)",
            "effect": "Moves the visual table to the new location."
          },
          {
            "action": "Delete Script",
            "how": "AutoCAD Erase / Delete command",
            "effect": "Removes the visual table. The calculated data stored in the Element submaps (hsb_ProductionData) remains attached to the elements."
          }
        ]
      },
      "tokens_used": 8551,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-CalculateProductionEstimates.mcr\n\n## Overview\nThis script calculates production time estimates for timber elements based on their geometric shape and area. It generates a visual table displaying the estimated time for each element and stores this data within the drawing.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Collects all elements in the model. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities**: Elements (e.g., roofs, walls) must exist in the Model Space.\n- **Settings Files**: `ProductionRateConfigurations.xml` (The script will attempt to create a default file if one does not exist).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or `TSL` catalog) â†’ Select `HSB_G-CalculateProductionEstimates.mcr`.\n\n### Step 2: Select Configuration\nA dialog appears upon insertion.\n```\nDialog: TSL Properties\nAction: Select a \"Production rate configuration\" from the dropdown list (e.g., \"Default\").\n```\n\n### Step 3: Place Table\n```\nCommand Line: Select a position\nAction: Click anywhere in the Model Space to place the generated table.\n```\n*The script will now scan all elements, calculate estimates, and draw the table.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Options | Description |\n|-----------|------|---------|-------------|\n| Production rate configuration | dropdown | (Loaded from XML) | Selects the specific set of calculation rates to apply to the elements. Changing this triggers an immediate recalculation. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Reload production rate configurations | Refreshes the list of configurations from the XML file on disk. Use this if you have manually updated the XML file. |\n\n## Settings Files\n- **Filename**: `ProductionRateConfigurations.xml`\n- **Location**: `_kPathHsbCompany\\Tsl\\Settings` (Your Company Folder)\n- **Purpose**: Defines the production rates (time per unit area) for different element shapes such as Rectangle, Triangle, Hip, Valley, and Internal Valley.\n\n## Tips\n- **Auto-Configuration**: If the XML file is missing, the script will try to create a default file with standard rates automatically.\n- **Geometry Detection**: The script analyzes the 2D envelope of elements. Ensure your elements have valid, closed outlines.\n- **Data Persistence**: Even if you delete the script instance (the table), the calculated production data remains stored in the individual elements.\n- **Moving the Table**: You can move the generated table by using the grip edit on the insertion point selected in Step 3.\n\n## FAQ\n- **Q: Why did the script delete itself immediately after insertion?**\n  A: This usually happens if you are trying to insert a second instance, or if the required folder structure could not be created. Check the command line for specific error messages regarding the XML file path.\n- **Q: The table shows \"Unknown shape\" for some elements.**\n  A: The script could not match the element's geometry to a defined shape in the XML. You may need to update the XML configuration to include the detected shape name or check the element's geometry.\n- **Q: How do I update the rates?**\n  A: Open the `ProductionRateConfigurations.xml` file in a text editor, modify the values, save the file, and then use the Right-Click menu option \"Reload production rate configurations\" on the script instance."
      },
      "tokens_used": 4992,
      "error": null
    }
  }
}