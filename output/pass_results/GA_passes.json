{
  "filename": "GA.mcr",
  "status": "completed",
  "total_tokens": 51900,
  "processing_time": 471.8720247745514,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9464,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script manipulates 3D geometry using Body, BeamCut, and GenBeam classes, and attaches hardware components (HardWrComp) to beams. It lacks Viewport handling, sd_ prefix, or 2D layout logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D environment)",
          "requiredSettings": [
            "AngleBracketCatalog.xml (or GenericAngle.xml)",
            "hsbTSL MapObject in Dictionary"
          ]
        }
      },
      "tokens_used": 6766,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 10163,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts and manages generic angle bracket connections (metal L-plates) between timber elements, automating the 3D geometry, beam milling/pocketing, and BOM data.",
          "category": "Hardware / Connection",
          "typicalUseCase": "Connecting two timber beams (e.g., beam-to-beam, beam-to-column) or securing a single beam to a substructure using standardized angle brackets from a manufacturer catalog."
        },
        "parameters": [
          {
            "name": "_Pt0",
            "technicalDefault": "User Click Point",
            "businessMeaning": "The insertion point and anchor. On a single beam, it snaps to the nearest edge. On two beams, it defines the intersection line. It controls which face of the timber the bracket is attached to.",
            "validRange": "Any point on the surface or near the edge of the target GenBeam(s).",
            "unit": "3D Coordinates (mm)",
            "affectsOutput": "Position of the bracket, rotation relative to the beam, and selection of the attachment face."
          },
          {
            "name": "_GenBeam[]",
            "technicalDefault": "User Selection",
            "businessMeaning": "The structural timber elements being connected. Supports 1 or 2 beams.",
            "validRange": "GenBeam, GenSheet, or GenPanel entities.",
            "unit": "Entity Reference",
            "affectsOutput": "Determines which beams receive the milling cuts and hardware assignments."
          },
          {
            "name": "sFamily",
            "technicalDefault": "From XML (e.g., 'Standard')",
            "businessMeaning": "The profile family of the angle bracket (e.g., standard L-bracket vs. reinforced). This sets the base geometric dimensions like height, width, and thickness.",
            "validRange": "List of families defined in AngleBracketCatalog.xml.",
            "unit": "String",
            "affectsOutput": "Base dimensions (Width, Height, Thickness) of the 3D body and default milling size."
          },
          {
            "name": "sProduct",
            "technicalDefault": "From XML (e.g., 'AA60280')",
            "businessMeaning": "The specific article number or SKU of the hardware for purchasing and production lists.",
            "validRange": "Valid product codes mapped to the selected family in the XML.",
            "unit": "String",
            "affectsOutput": "BOM/Hardware list properties."
          },
          {
            "name": "sManufacturer",
            "technicalDefault": "From XML",
            "businessMeaning": "The supplier of the hardware component.",
            "validRange": "Available manufacturers in the catalog.",
            "unit": "String",
            "affectsOutput": "BOM information and hardware attributes."
          },
          {
            "name": "iMillingType",
            "technicalDefault": "1",
            "businessMeaning": "Selects the machining strategy for the timber. Determines if the bracket sits on the surface (0), is recessed (1), or has a specific complex pocket (3).",
            "validRange": "1, 2, or 3 (Integer).",
            "unit": "Enumeration",
            "affectsOutput": "Geometry of the BeamCut operation (e.g., depth, negative pockets, and clearance shape)."
          },
          {
            "name": "dTolerance",
            "technicalDefault": "0.0",
            "businessMeaning": "The additional clearance added to the thickness and width of the cut. Ensures the metal plate fits without forcing.",
            "validRange": "0.0 to 5.0 mm",
            "unit": "mm",
            "affectsOutput": "Expands the size of the milled pocket in the beam."
          },
          {
            "name": "iRotate180",
            "technicalDefault": "0 (False)",
            "businessMeaning": "Flips the orientation of the bracket 180 degrees around the insertion axis.",
            "validRange": "0 (No), 1 (Yes).",
            "unit": "Boolean/Integer",
            "affectsOutput": "Rotates the 3D body and the associated machining volume."
          },
          {
            "name": "sNail",
            "technicalDefault": "From XML",
            "businessMeaning": "The article number of the fasteners (nails/screws) used to secure the bracket.",
            "validRange": "Valid fastener codes in catalog.",
            "unit": "String",
            "affectsOutput": "Hardware list entries for fasteners."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing 'sFamily'",
            "effect": "Updates 'sProduct', 'sManufacturer', and underlying dimensions (dA, dB, dC, dt) to match the new family's default configuration.",
            "cascade": [
              "sProduct",
              "sManufacturer",
              "Geometric Dimensions"
            ]
          },
          {
            "trigger": "Changing 'iMillingType'",
            "effect": "Switches the algorithm used to calculate the BeamCut volume, altering how deep or how complex the timber is machined.",
            "cascade": [
              "BeamCut Geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (Visual)",
            "description": "A 3D solid representation of the angle bracket, sized according to dA, dB, dC, and dt.",
            "appliedTo": "Model Space (visualizing the hardware location)."
          },
          {
            "type": "BeamCut (Milling)",
            "description": "Material removal operation on the beam. The shape varies by 'iMillingType' (simple surface removal vs. deep pocketing) and includes 'dTolerance'.",
            "appliedTo": "_GenBeam[0] and _GenBeam[1] (if present)."
          },
          {
            "type": "HardWrComp (Hardware)",
            "description": "BOM entries created for the main bracket component and associated fasteners (nails/screws).",
            "appliedTo": "The linked GenBeam (for production reports)."
          }
        ]
      },
      "tokens_used": 8894,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Loads constants and defines file paths for 'AngleBracketCatalog.xml'.",
          "2. Configuration Loading: Attempts to load settings from a Dictionary MapObject. If unavailable or on Insert, it looks for an XML file first in the Company folder (hsbCompany), then the General Installation folder (Content\\General).",
          "3. Insertion Loop (_bOnInsert): Script enters a loop to allow placing multiple instances sequentially.",
          "4. Entity Selection: User selects 1 or 2 GenBeams/GenSheets/GenPanels as supports.",
          "5. Point Placement: User picks a point (_Pt0) to define the insertion location and attachment face.",
          "6. Default Property Assignment: Script assigns the first available Family/Product and default MillingType from the loaded XML.",
          "7. Instance Creation: A new TSL instance is created at the calculated location.",
          "8. Geometric Calculation: Vectors (vxBody, vyBody, vzBody) are calculated based on the beam edges and insertion point. If 2 beams are used, an intersection line is determined.",
          "9. 3D Body Generation: The angle bracket body is constructed using geometric dimensions (dA, dB, dC, dt) and transformed based on rotation settings.",
          "10. Milling Operation: BeamCut tools are generated based on the 'iMillingType' and applied to the beam(s).",
          "11. Hardware/BOM Generation: HardWrComp entries are created for the bracket and associated fasteners (nails/screws), then linked to the GenBeams.",
          "12. Visualization: The 3D body is drawn in the model."
        ],
        "conditionalBranches": [
          {
            "condition": "Configuration Source Availability",
            "path1": {
              "name": "Dictionary MapObject Found",
              "steps": [
                "Load settings from MapObject in 'hsbTSL' dictionary.",
                "Skip XML reading unless debugging or updating version."
              ]
            },
            "path2": {
              "name": "MapObject Not Found",
              "steps": [
                "Search Company Folder for XML.",
                "If not found, search General Install Folder for XML.",
                "If still not found, use internal hardcoded default map."
              ]
            }
          },
          {
            "condition": "Number of Selected Beams",
            "path1": {
              "name": "Single Beam Connection",
              "steps": [
                "Projection finds the nearest edge to the insertion point.",
                "Grip point (_PtG) defines the specific face/plane priority.",
                "Milling and Hardware applied to the single beam."
              ]
            },
            "path2": {
              "name": "Double Beam Connection",
              "steps": [
                "Connection placed at the line of intersection of the two beam planes.",
                "Milling and Hardware applied to both beams.",
                "Context menu option available to 'Swap Legs' (flip beams).",
                "Double-click functionality available to flip connection."
              ]
            }
          },
          {
            "condition": "iMillingType (Milling Strategy)",
            "path1": {
              "name": "Type 1 (Standard/Surface)",
              "steps": [
                "Generates cuts relative to the surface based on thickness and width.",
                "Standard clearance application."
              ]
            },
            "path2": {
              "name": "Type 3 (Recessed/Pocket)",
              "steps": [
                "Transforms body and cuts deeper into the timber (offset by dt + dTolerance).",
                "Creates a specific pocket geometry, often involving multiple intersecting cuts."
              ]
            }
          },
          {
            "condition": "iRotate180 (Orientation)",
            "path1": {
              "name": "0 (Standard)",
              "steps": [
                "Body and cuts aligned in the default positive vector direction."
              ]
            },
            "path2": {
              "name": "1 (Rotated)",
              "steps": [
                "Body and cuts rotated 180 degrees around the vertical axis.",
                "Cutting directions (vzBody) inverted where necessary."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "XML File Availability",
            "errorMessage": "No AngleBracketCatalog.xml found in Company or General folder.",
            "recovery": "Script falls back to internal default map (limited functionality). User should install correct XML."
          },
          {
            "check": "Valid Beam Selection",
            "errorMessage": "Invalid entity selected or no beam found.",
            "recovery": "Prompt repeats asking for a valid GenBeam/GenSheet/GenPanel."
          },
          {
            "check": "Geometric Dimensions",
            "errorMessage": "Invalid dimensions (e.g., negative width/height) preventing Body creation.",
            "recovery": "User must select a valid product/family combination with positive dimensions in the XML."
          },
          {
            "check": "Catalog Entry Exists",
            "errorMessage": "Selected Manufacturer/Family/Product combination does not exist in loaded XML.",
            "recovery": "User resets properties to a valid combination available in the Properties Palette."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Relocate Bracket",
            "how": "Grip Point Edit (_PtG)",
            "effect": "Moves the insertion point along the beam edge. Updates _Pt0 and recalculates the attachment face if moved near a different edge."
          },
          {
            "action": "Swap Beams / Legs",
            "how": "Context Menu (Right-click) or Double Click",
            "effect": "Swaps the primary and secondary beam roles (flips the connection orientation) in a 2-beam scenario."
          },
          {
            "action": "Rotate 180 Degrees",
            "how": "Context Menu (Right-click)",
            "effect": "Toggles 'iRotate180' property, flipping the bracket orientation relative to the insertion axis."
          },
          {
            "action": "Change Product Specifications",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'sFamily' updates dimensions and defaults. Changing 'sProduct' updates BOM data. Changing 'iMillingType' alters the machining geometry."
          },
          {
            "action": "Adjust Tolerance",
            "how": "Properties Palette (OPM) -> dTolerance",
            "effect": "Increases or decreases the size of the milling pocket (clearance) around the metal bracket."
          }
        ]
      },
      "tokens_used": 10682,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# GA.mcr\n\n## Overview\nInserts and manages generic angle bracket connections (metal L-plates) between timber elements. It automates the creation of 3D geometry, beam milling/pocketing, and BOM data for manufacturing lists.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D geometry and beam processing. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required entities**: GenBeam, GenSheet, or GenPanel (1 or 2 elements).\n- **Minimum beam count**: 1.\n- **Required settings files**: `AngleBracketCatalog.xml` (or `GenericAngle.xml`) located in the Company or Content\\General installation folder.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Browse to the script location and select `GA.mcr`.\n\n### Step 2: Select Timber Elements\n```\nCommand Line: Select GenBeam/GenSheet/GenPanel:\nAction: Click on the primary timber element you wish to connect.\n```\n*(Note: The script allows selecting a second element immediately after for beam-to-beam connections, or you can press Enter to proceed with a single beam).*\n\n### Step 3: Define Insertion Point\n```\nCommand Line: Specify insertion point:\nAction: Click on the face or edge of the selected beam where the bracket should be placed.\n```\n*   **Single Beam:** The script snaps to the nearest edge based on your click.\n*   **Two Beams:** The point defines the intersection line where the two beams meet.\n\n### Step 4: Configure Properties\n**Action:** The script inserts the default bracket. Use the **Properties Palette** (Ctrl+1) to select the specific Family, Manufacturer, and Product code required for your design.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| sFamily | Dropdown | From XML | The profile family of the angle bracket (e.g., Standard L-Bracket). This determines the base geometric dimensions (Height, Width, Thickness). |\n| sProduct | Dropdown | From XML | The specific article number or SKU for purchasing and production lists. |\n| sManufacturer | Dropdown | From XML | The supplier of the hardware component. |\n| sNail | String | From XML | The article number of the fasteners (nails/screws) used to secure the bracket. |\n| iMillingType | Integer | 1 | Machining strategy: 1 (Standard/Surface), 2, or 3 (Recessed/Pocket). Determines how deep the timber is cut. |\n| dTolerance | Double | 0.0 mm | Additional clearance added to the cut dimensions. Increase this if the bracket fits too tightly. |\n| iRotate180 | Integer | 0 | Flips the orientation of the bracket 180 degrees around the insertion axis (0 = No, 1 = Yes). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Swap Legs | Swaps the primary and secondary beam roles (flips the connection orientation). Available only for 2-beam connections. |\n| Rotate 180 | Flips the bracket orientation relative to the insertion axis without changing the assigned beams. |\n\n## Settings Files\n- **Filename**: `AngleBracketCatalog.xml` or `GenericAngle.xml`\n- **Location**: `hsbCompany` folder or `Content\\General` installation path.\n- **Purpose**: Provides the database of available manufacturers, families, product codes, dimensions (dA, dB, dC, dt), and associated fasteners.\n\n## Tips\n- **Grip Editing:** Select the inserted bracket to reveal the grip point. Drag the grip along the beam edge to reposition the connection quickly.\n- **Double-Click:** Double-clicking an existing connection on two beams acts as a shortcut to \"Swap Legs.\"\n- **Recessing:** If you need the bracket to sit inside the timber (flush mount), change the `iMillingType` to 3.\n- **Clearance:** If the manufacturing report indicates the pocket is too small, increase the `dTolerance` value in small increments (e.g., 1.0 mm).\n\n## FAQ\n- **Q: What happens if the script asks for an XML file?**\n  **A:** The script cannot find the required catalog. Ensure your CAD administrator has placed the correct `AngleBracketCatalog.xml` in the correct Company or Content folder.\n- **Q: Can I connect more than two beams?**\n  **A:** No, this script is designed for single-beam anchoring or connections between exactly two beams.\n- **Q: Why does my bracket look rotated wrong?**\n  **A:** Use the `iRotate180` property in the Properties Palette or select \"Rotate 180\" from the right-click context menu."
      },
      "tokens_used": 5931,
      "error": null
    }
  }
}