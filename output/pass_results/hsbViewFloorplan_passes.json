{
  "filename": "hsbViewFloorplan.mcr",
  "status": "completed",
  "total_tokens": 49202,
  "processing_time": 350.66435718536377,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.5\",\n      \"date\": \"08feb2021\",\n      \"author\": \"mars"
      },
      "tokens_used": 9371,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script prompts `Viewport vp = getViewport()` and uses `_Viewport.append(vp)`. It utilizes `ElementWall().modelToPaperTransform(vp)` to transform coordinates from Model Space to the Viewport context. While it reads entities from `_kModelSpace`, it is explicitly designed to create a plan view attached to a viewport in a layout."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "ElementWall",
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be inserted into a Paper Space Layout containing a Viewport, which views Elements in Model Space.",
          "requiredSettings": []
        }
      },
      "tokens_used": 7586,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert (standard flow)",
            "title": null,
            "dataSource": "Properties Palette",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dim Style|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles.sorted()",
            "category": "|General|",
            "description": "|Defines the DimStyle|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Text Height. 0 = scaled to view byDImstyle|"
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Color|"
          },
          {
            "index": 1,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(ElementNumber)",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the text and/or attributes.| |Multiple lines are separated by a backslash| '|' |Attributes can also be added or removed by context commands.|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7124,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a 2D floor plan view in a PaperSpace layout by highlighting ModelSpace elements (walls/roofs) and labeling them with specific attributes.",
          "category": "ShopDrawing",
          "typicalUseCase": "Generating architectural presentation drawings or installation plans where specific elements on a floor level need to be visually distinct and tagged with their Element Number or other data."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Defines the text style (font, specific line characteristics) used for the element labels in the layout.",
            "validRange": "Any existing Dimension Style in the drawing.",
            "unit": "Style Name",
            "affectsOutput": "Visual appearance (font face, basic size factor) of the text labels."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Sets the plotted height of the text labels in the PaperSpace. A value of 0 enables automatic scaling based on the Viewport scale and DimStyle settings.",
            "validRange": "0 (Auto) or >0 (e.g., 2.5, 3.5, 5.0 mm depending on plotting standards).",
            "unit": "Length (mm)",
            "affectsOutput": "The physical size of the text on the drawing sheet."
          },
          {
            "name": "nColor",
            "technicalDefault": "0",
            "businessMeaning": "Controls the color of the solid fill used to highlight the elements in the floor plan.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "The fill color of the element outlines in the layout."
          },
          {
            "name": "sFormat",
            "technicalDefault": "@(ElementNumber)",
            "businessMeaning": "Defines what information is displayed inside the element label using hsbCAD attribute placeholders (e.g., ElementNumber, Length, Elevation).",
            "validRange": "Valid hsbCAD format string syntax.",
            "unit": "String",
            "affectsOutput": "The textual content displayed for each element."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight is set to 0",
            "effect": "The text height is calculated automatically based on the selected sDimStyle and the scale of the selected Viewport.",
            "cascade": [
              "sDimStyle",
              "Viewport Scale"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Profile / Hatch",
            "description": "A solid-filled representation of the ElementWall or ElementRoof outlines.",
            "appliedTo": "PaperSpace (derived from ModelSpace Elements)."
          },
          {
            "type": "Text Entity",
            "description": "A text label containing the formatted string, placed at the center of the element.",
            "appliedTo": "PaperSpace."
          }
        ]
      },
      "tokens_used": 9193,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch / Insert",
          "Check insertCycleCount (>1 triggers erase)",
          "Command Prompt: Select Viewport (getViewport)",
          "Check _kExecuteKey: Load from Catalog OR Display Properties Dialog (showDialog)",
          "Validate: Get Element from Viewport. If invalid -> Report Error & Erase Instance.",
          "Scan ModelSpace: Collect all ElementWall and ElementRoof entities.",
          "Validate: Check if elements found. If none -> Report Error & Erase Instance.",
          "Branch: Determine Element Type (ElementMulti vs. Single Element)",
          "Logic: Compile list of Levels found in the collected elements",
          "[Inferred/Truncated] Dialog: Select specific Level to process",
          "[Inferred/Truncated] Command Prompt: Pick Insertion Point (_Pt0)",
          "[Inferred/Truncated] Command Prompt/Jig: Define Scale/Reference Point (_PtG)",
          "Generate Output: Transform coordinates to PaperSpace",
          "Loop through Elements Level:",
          "- Calculate Geometry (Outline for Walls, Envelope for Roofs)",
          "- Apply Transformations (Move & Scale based on points)",
          "- Draw Filled Profiles (Color = nColor)",
          "- Determine Text Orientation (Wall Normal or World XY)",
          "- Branch: Set Text Height (Fixed dTextHeight OR Auto-Scaled)",
          "- Draw Text Labels (Format = sFormat)"
        ],
        "conditionalBranches": [
          {
            "condition": "Type of Element in Viewport",
            "path1": {
              "name": "ElementMulti",
              "steps": [
                "Retrieve singleElementRefs",
                "Match references with ModelSpace entities",
                "Populate eElementsVp with specific sub-elements"
              ]
            },
            "path2": {
              "name": "Single Element",
              "steps": [
                "Validate directly against ElementWall or ElementRoof",
                "Populate eElementsVp with the single element"
              ]
            }
          },
          {
            "condition": "Value of dTextHeight Property",
            "path1": {
              "name": "Fixed Height (>0)",
              "steps": [
                "Set dpText.textHeight to value of dTextHeight"
              ]
            },
            "path2": {
              "name": "Auto-Scaled (0)",
              "steps": [
                "Calculate required height using textHeightForStyle",
                "Multiply result by Viewport Scale (vp.dScale())"
              ]
            }
          },
          {
            "condition": "Entity Type during Drawing Loop",
            "path1": {
              "name": "ElementWall",
              "steps": [
                "Get plOutlineWall",
                "Calculate Text Rotation based on -vecZ transformed",
                "Offset text slightly towards interior"
              ]
            },
            "path2": {
              "name": "ElementRoof",
              "steps": [
                "Get plEnvelope",
                "Set Text Rotation to World X/Y",
                "Center text on profile"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "|Select a viewport| (Prompt loop until selected)",
            "recovery": "User selects a valid viewport in the PaperSpace layout."
          },
          {
            "check": "Validity of Element in Viewport",
            "errorMessage": "|no valid element found|",
            "recovery": "User must ensure the viewport looks at a valid hsbCAD Element; script erases itself."
          },
          {
            "check": "Existence of Walls or Roofs in ModelSpace",
            "errorMessage": "|no elements found|",
            "recovery": "User must create or ensure visibility of ElementWall/ElementRoof entities in ModelSpace; script erases itself."
          },
          {
            "check": "Insertion Cycle",
            "errorMessage": "Silent erase",
            "recovery": "N/A (Internal protection against double-insertion)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Visual Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'Color', 'Format', 'Dim Style', or 'Text Height' triggers an immediate recalculation and redraw of the view."
          },
          {
            "action": "Move/Scale View",
            "how": "Grip Edit or Context Menu (Inferred from _Pt0/_PtG logic)",
            "effect": "Modifying the insertion point or scale reference points re-transforms the 2D geometry in PaperSpace."
          }
        ]
      },
      "tokens_used": 10213,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbViewFloorplan.mcr\n\n## Overview\nThis script generates a 2D floor plan view in a Paper Space layout by creating solid hatches and labels for walls and roofs visible in a selected Viewport. It is used to create architectural presentation drawings or installation plans where specific elements need to be tagged and highlighted directly on the drawing sheet.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | The script reads elements from Model Space but must be inserted into Paper Space. |\n| Paper Space | Yes | This is the primary working environment. You must have a layout with an active Viewport. |\n| Shop Drawing | No | This is a standalone script for creating presentation views. |\n\n## Prerequisites\n- **Required Entities**: A `Viewport` in Paper Space that is viewing the model. The Model Space must contain `ElementWall` or `ElementRoof` entities.\n- **Minimum Beam Count**: 0 (This script works with architectural elements, not individual beams).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nRun the command `TSLINSERT` and select `hsbViewFloorplan.mcr` from the list.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select a viewport\nAction: Click on the viewport in your layout that displays the floor level you want to document.\n```\n\n### Step 3: Select Level\n```\nDialog: Select Level\nAction: The script scans the model for elements and groups them by level. Select the specific level (elevation) you wish to generate the view for from the list.\n```\n\n### Step 4: Define Location and Scale\n```\nCommand Line: Pick insertion point\nAction: Click in the Paper Space to place the top-left corner of the floor plan view.\n\nCommand Line: Pick reference point / Define scale\nAction: Click a second point to define the scale and size of the view (dragging away enlarges it, dragging closer shrinks it).\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dim Style | Dropdown | *(Current Style)* | Selects the text style (font, line characteristics) used for the element labels. |\n| Text Height | Number | 0 | Sets the plotted height of the text labels. **0** means the text scales automatically based on the Viewport scale. |\n| Color | Number | 0 | Defines the color index (0-255) for the solid fill hatches representing the walls/roofs. |\n| Format | String | @(ElementNumber) | Defines the text displayed inside each element. You can use attributes like `@(ElementNumber)`, `@(Length)`, etc. Separate multiple lines with a backslash `\\`. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (Standard TSL Menu) | Use the Properties Palette to modify parameters. Standard context options for moving/grip-editing the view are available. |\n\n## Settings Files\n- None.\n\n## Tips\n- **Automatic Text Scaling**: Leave the **Text Height** set to `0` to ensure your labels remain readable regardless of the viewport zoom level. The script calculates the appropriate size based on your Dim Style settings.\n- **Custom Labels**: Use the **Format** property to add more data to your floor plan. For example, change it to `@(ElementNumber)\\n@(Length)` to display the element number on one line and its length on the next.\n- **Color Coding**: Change the **Color** property to different values (e.g., standard Red for walls, Blue for roofs) to visually distinguish different types of elements in your plan.\n\n## FAQ\n- **Q: Why does the script disappear after I select a viewport?**\n  **A:** The script erases itself if it cannot find any valid ElementWall or ElementRoof entities inside the selected viewport's model space view. Ensure your model has walls or roofs and that they are visible within the viewport boundaries.\n\n- **Q: Can I move the floor plan after inserting it?**\n  **A:** Yes, you can use standard AutoCAD grip editing or the Move command to reposition the generated view in Paper Space.\n\n- **Q: How do I change the information shown in the labels?**\n  **A:** Select the script instance, open the Properties Palette (Ctrl+1), and edit the **Format** string. You can use any hsbCAD attribute token available for the elements."
      },
      "tokens_used": 5715,
      "error": null
    }
  }
}