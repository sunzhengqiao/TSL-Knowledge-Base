{
  "filename": "hsbDrawQR-Code.mcr",
  "status": "completed",
  "total_tokens": 50021,
  "processing_time": 398.77598428726196,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.7\",\n      \"date\": \"25.02.2021\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-10913 bugfix when using preset catalog entry in shopdraw mode. You can now control the QR content and the logo type by the selected catalog entry.\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"22.01.2021\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-10325 internal bugfix\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"15.01.2021\",\n      \"author\": \"\",\n      \"changes\": \"HSB-10325 optional logo drawn in QR\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"13nov2020\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-9706 'Handle' supported as format variable\"\n    },\n    {\n      \"version\": \"1.4\",\n      \"date\": \"20oct2020\",\n     "
      },
      "tokens_used": 8992,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Property 'sMode' defines the environment with options 'Paperspace', 'Shopdrawing', and 'Model'. Logic branches explicitly handle Viewport selection for Paperspace (getViewport), ShopDrawView selection for Shopdraw, and Entity selection for Model space."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport containing Element (Paperspace mode)",
            "ShopDrawView (Shopdrawing mode)",
            "Element (Model mode)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space, Paper Space, or Shopdrawing Space (configured via property)",
          "requiredSettings": []
        }
      },
      "tokens_used": 8534,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert (silent mode false)",
              "required": false
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "Select a viewport",
              "condition": "nMode==0 (Paperspace) on Insert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity/Selection",
              "promptOriginal": "Select a Shopdraw View",
              "condition": "nMode==1 (Shopdrawing) on Insert",
              "required": true
            },
            {
              "step": 4,
              "function": "getEntity",
              "promptOriginal": null,
              "condition": "nMode==2 (Model) on Insert",
              "required": true
            },
            {
              "step": 5,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "End of _bOnInsert",
              "required": true
            },
            {
              "step": 6,
              "function": "getViewport",
              "promptOriginal": "Select a viewport",
              "condition": "Trigger: 'Add Viewport'",
              "required": true
            },
            {
              "step": 7,
              "function": "getInt",
              "promptOriginal": "Select entry by index",
              "condition": "Trigger: 'Select Catalog Default'",
              "required": true
            },
            {
              "step": 8,
              "function": "getInt",
              "promptOriginal": "Select a property by index to add(+) or to remove(-) ,|-1 = Exit|",
              "condition": "Trigger: 'Add/Remove Format'",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "EL;@(ElementNumber)",
            "inputType": "text",
            "options": [],
            "category": "General",
            "description": "Defines the text and/or attributes.\nSyntax\n\t@(<PropertyName>)\nSyntax for properties of property sets\n \t<PropertySetName.PropertyName>\nSample: @(ProjectName) @(Delivery.TruckID) will resolve the project name and a property 'TruckID' of a property set called 'Delivery'"
          },
          {
            "index": 1,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Mode",
            "defaultValue": "Paperspace",
            "inputType": "dropdown",
            "options": [
              "Paperspace",
              "Shopdrawing",
              "Model"
            ],
            "category": "General",
            "description": "Defines the Mode"
          },
          {
            "index": 2,
            "variable": "dSize",
            "type": "PropDouble",
            "displayName": "Size",
            "defaultValue": "25",
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "Defines the size"
          },
          {
            "index": 3,
            "variable": "nMargin",
            "type": "PropInt",
            "displayName": "Margin",
            "defaultValue": "4",
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "Specifies the margin, <default>=4"
          },
          {
            "index": 4,
            "variable": "sLogo",
            "type": "PropString",
            "displayName": "Logo",
            "defaultValue": "no logo",
            "inputType": "dropdown",
            "options": [
              "no logo",
              "red",
              "yellow",
              "green",
              "cyan"
            ],
            "category": "Display",
            "description": "Defines the Logo"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Add Viewport",
            "handler": "Add Viewport",
            "action": "Prompts to select a Viewport for Paperspace mode.",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "Select Catalog Default",
            "handler": "Select Catalog Default",
            "action": "Lists catalog entries to select a format/logo preset for Shopdraw mode.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Add/Remove Format",
            "handler": "Add/Remove Format",
            "action": "Interactive command-line builder to add or remove variables from the Format property.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8150,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and places a scannable QR code symbol within CAD drawings (Model, Paper, or Shopdrawing spaces) to encode element or project data.",
          "category": "Annotation / Data Management",
          "typicalUseCase": "Labeling timber beams or shop drawings with QR codes to provide machine-readable access to element numbers, project IDs, or tracking info via mobile scanning."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "EL;@(ElementNumber)",
            "businessMeaning": "The logical data content to be encoded in the QR code. It constructs a string using specific element properties (like ElementNumber, Length, etc.) or project metadata.",
            "validRange": "String containing keys wrapped in @(), e.g., '@(ElementNumber)', 'ID: @(ElementNumber) Len: @(Length)'.",
            "unit": "String",
            "affectsOutput": "Alters the pixel pattern of the QR code. When scanned, the device reads the resolved text defined by this format."
          },
          {
            "name": "sMode",
            "technicalDefault": "Paperspace",
            "businessMeaning": "Determines the drawing environment where the QR code is placed and which type of entity it associates with.",
            "validRange": "Paperspace, Shopdrawing, Model",
            "unit": "Enum",
            "affectsOutput": "Switches the selection logic between Viewports (Paperspace), ShopDrawViews (Shopdrawing), and Elements (Model), affecting coordinate transformations and data source."
          },
          {
            "name": "dSize",
            "technicalDefault": "25",
            "businessMeaning": "The physical dimensions of the QR code symbol.",
            "validRange": "10mm to 100mm (Typically 15mm-50mm for reliable scanning on paper or timber)",
            "unit": "mm",
            "affectsOutput": "Scales the geometric size of the QR code drawing. Larger codes are easier for scanners to read from a distance but consume more drawing space."
          },
          {
            "name": "nMargin",
            "technicalDefault": "4",
            "businessMeaning": "The size of the blank border zone surrounding the data matrix, required for scanners to detect the code boundaries.",
            "validRange": "0 to 10 (4 is standard QR spec)",
            "unit": "Modules (quiet zone)",
            "affectsOutput": "Increases or decreases the empty whitespace padding around the QR code pattern."
          },
          {
            "name": "sLogo",
            "technicalDefault": "no logo",
            "businessMeaning": "Selects a colored hsbCAD logo to embed centrally within the QR code for branding.",
            "validRange": "no logo, red, yellow, green, cyan",
            "unit": "Enum",
            "affectsOutput": "Overlays a vector logo in the center of the QR code. If active, the script automatically adjusts error correction to maintain data integrity despite the visual obstruction."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMode == 'Shopdrawing'",
            "effect": "Enables the 'Select Catalog Default' context command, which allows the sFormat and sLogo properties to be overridden by values stored in a catalog entry.",
            "cascade": [
              "sFormat",
              "sLogo"
            ]
          },
          {
            "trigger": "sLogo != 'no logo'",
            "effect": "Forces the QR encoding algorithm to use a higher Error Correction Level (Medium/High) to ensure the code remains readable even though the logo covers part of the data matrix.",
            "cascade": [
              "QR Encoding Logic",
              "Scanning Reliability"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry (Lines/Polylines)",
            "description": "Visual representation of the QR code matrix.",
            "appliedTo": "Selected Element (Model), Viewport (Paperspace), or ShopDrawView (Shopdrawing)."
          }
        ]
      },
      "tokens_used": 8331,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch / Insert",
          "Check Insert Cycle (Ignore if cycle > 1)",
          "Check Execute Key (Catalog Entry or Dialog)",
          "Display Properties Dialog (if no Execute Key)",
          "Determine Mode (sMode: Paperspace/Shopdrawing/Model)",
          "[Paperspace] Select Viewport",
          "[Shopdrawing] Select ShopDrawView",
          "[Model] Select Element",
          "Select Insertion Point (getPoint)",
          "Calculate Coordinate System & Reference Point",
          "Fetch Format & Logo Settings (Properties or Catalog)",
          "Resolve Format Variables (e.g., ElementNumber)",
          "Generate QR Matrix (Encode String)",
          "Draw QR Code Geometry",
          "[Optional] Draw Center Logo"
        ],
        "conditionalBranches": [
          {
            "condition": "Mode Selection (sMode)",
            "path1": {
              "name": "Paperspace (0)",
              "steps": [
                "Prompt to select Viewport",
                "Validate Viewport has Element",
                "Transform coordinates (ModelSpace -> PaperSpace)",
                "Fetch Element properties from Viewport"
              ]
            },
            "path2": {
              "name": "Shopdrawing (1)",
              "steps": [
                "Prompt to select ShopDrawView",
                "Check for Catalog Entry override",
                "If Catalog Entry exists, use its Format/Logo",
                "Fetch Element properties from View"
              ]
            },
            "path3": {
              "name": "Model (2)",
              "steps": [
                "Prompt to select Element (getEntity)",
                "Use local coordinate system of Element"
              ]
            }
          },
          {
            "condition": "Viewport availability (Post-Insert)",
            "path1": {
              "name": "Viewport Missing",
              "steps": [
                "Display Error Text 'please add a viewport'",
                "Add Context Menu 'Add Viewport'",
                "Wait for user input"
              ]
            },
            "path2": {
              "name": "Viewport Valid",
              "steps": [
                "Proceed to Calculation"
              ]
            }
          },
          {
            "condition": "Logo Selection (sLogo)",
            "path1": {
              "name": "No Logo",
              "steps": [
                "Standard QR Encoding (Low Error Correction)"
              ]
            },
            "path2": {
              "name": "Logo (Red/Yellow/Green/Cyan)",
              "steps": [
                "QR Encoding with High Error Correction",
                "Calculate embedded image size",
                "Draw HsbLogo in center"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Element Validity",
            "errorMessage": "(Implicit) Script exits silently or does not draw",
            "recovery": "Select a different viewport containing valid hsb Element"
          },
          {
            "check": "ShopDrawView Selection",
            "errorMessage": "Script instance erased if no entity selected",
            "recovery": "Ensure a ShopDrawView is selected during insertion"
          },
          {
            "check": "Format String Syntax",
            "errorMessage": "Variables unresolved in output",
            "recovery": "Use 'Add/Remove Format' context command to verify variable names"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add Viewport",
            "how": "Context Menu (Right-click) or Double-Click",
            "effect": "Prompts user to select a new Viewport to link the QR code to."
          },
          {
            "action": "Select Catalog Default",
            "how": "Context Menu (Shopdrawing mode only)",
            "effect": "Prompts to select a catalog entry by index to override sFormat and sLogo properties."
          },
          {
            "action": "Add/Remove Format",
            "how": "Context Menu",
            "effect": "Opens command-line interface to add (+) or remove (-) properties from the sFormat string interactively."
          },
          {
            "action": "Modify Properties",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Changing sFormat, sMode, dSize, nMargin, or sLogo updates the QR geometry immediately."
          }
        ]
      },
      "tokens_used": 9290,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbDrawQR-Code.mcr\n\n## Overview\nThis script generates a scannable QR code symbol that encodes data from selected timber elements, viewports, or shop drawings. It allows users to create machine-readable labels for tracking or identification directly within the CAD environment.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Attaches directly to a selected element. |\n| Paper Space | Yes | Requires a viewport containing an element to encode data. |\n| Shop Drawing | Yes | Requires a ShopDrawView selection; supports catalog presets. |\n\n## Prerequisites\n- **Required Entities:** \n    - **Model Space:** An existing Element (e.g., beam, wall).\n    - **Paper Space:** A Layout with a Viewport containing an Element.\n    - **Shop Drawing:** A ShopDrawView.\n- **Minimum beam count:** 0.\n- **Required settings files:** None (Standard properties only, though optional catalog entries can be used in Shopdrawing mode).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbDrawQR-Code.mcr`.\n\n### Step 2: Configure Mode and Properties\nThe script displays properties in the AutoCAD Properties Palette (OPM) before or after insertion.\n1. Set the **Mode** property to `Model`, `Paperspace`, or `Shopdrawing` depending on where you are working.\n2. Set the **Format** property to define what data is encoded (e.g., `@(ElementNumber)`).\n3. (Optional) Set **Size** and **Logo** preferences.\n\n### Step 3: Select Entity based on Mode\nDepending on the selected **Mode**, the command line will prompt:\n- **Paperspace:**\n    ```\n    Command Line: Select a viewport\n    Action: Click on a viewport frame in the layout that contains the element you wish to label.\n    ```\n- **Shopdrawing:**\n    ```\n    Command Line: Select a Shopdraw View\n    Action: Select the view entity in the shop drawing environment.\n    ```\n- **Model:**\n    ```\n    (Implicit prompt / Selection box)\n    Action: Select an element (beam, wall, etc.) in the model.\n    ```\n\n### Step 4: Set Insertion Point\n```\nCommand Line: Insertion point\nAction: Click in the drawing area to place the QR code.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | text | EL;@(ElementNumber) | Defines the text/attributes encoded in the QR code. Use `@()` to reference properties (e.g., `@(ElementNumber)`, `@(ProjectName)`). |\n| Mode | dropdown | Paperspace | Determines the working environment. Options: `Paperspace`, `Shopdrawing`, `Model`. |\n| Size | number | 25 | The physical size of the QR code symbol in drawing units. |\n| Margin | number | 4 | The quiet zone (blank border) around the code, measured in modules. |\n| Logo | dropdown | no logo | Embeds a colored hsbCAD logo in the center. Options: `no logo`, `red`, `yellow`, `green`, `cyan`. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add Viewport | Prompts to re-select or link a different viewport (Paperspace mode). Can also be triggered by double-clicking the script instance. |\n| Select Catalog Default | Allows selecting a catalog entry to automatically set Format and Logo properties (Shopdrawing mode only). |\n| Add/Remove Format | Opens a command-line list to interactively add (+) or remove (-) property variables from the Format string. |\n\n## Settings Files\n- **Filename:** None required (Catalog entries optional).\n- **Location:** N/A.\n- **Purpose:** While not strictly required, using a catalog entry in Shopdrawing mode can streamline the setup of Format and Logo settings for different label types.\n\n## Tips\n- **Scanning Reliability:** If using a Logo, the script automatically increases error correction. However, ensure the **Size** is large enough (minimum 15-20mm) for scanners to read clearly on printed output.\n- **Custom Data:** Use the `Add/Remove Format` context menu to quickly build complex strings without typing the syntax manually.\n- **Viewport Linking:** In Paperspace, if the QR code shows \"please add a viewport\", use the **Add Viewport** context menu to link it to the correct view.\n\n## FAQ\n- **Q: My QR code isn't scanning.**\n  - A: Ensure the **Size** is sufficient (e.g., 25mm or larger) and that the **Margin** is not set to 0. Also, check if the contrast is high enough on your final output.\n- **Q: Can I combine multiple properties in one code?**\n  - A: Yes. In the **Format** property, you can combine variables, e.g., `ID: @(ElementNumber) Len: @(Length)`.\n- **Q: How do I change the element the QR code refers to?**\n  - A: In Model or Paperspace, you can delete and re-insert, or use the provided context menu options (like \"Add Viewport\") to re-associate the script instance with a different entity."
      },
      "tokens_used": 6724,
      "error": null
    }
  }
}