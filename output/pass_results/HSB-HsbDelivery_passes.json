{
  "filename": "HSB-HsbDelivery.mcr",
  "status": "completed",
  "total_tokens": 49400,
  "processing_time": 215.73770022392273,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 2,\n    \"minorVersion\": 2,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"This tsl creates and maintains deliveries. The information of those deliveries can be used on production drawings and as input for the database.\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.00\",\n      \"date\": \"14.09.2009\",\n      \"author\": \"AS\",\n      \"changes\": \"Pilot version\"\n    },\n    {\n      \"version\": \"1.01\",\n      \"date\": \"16.09.2009\",\n      \"author\": \"AS\",\n      \"changes\": \"Fix issues with link to database app.\"\n    },\n    {\n      \"version\": \"1.02\",\n      \"date\": \"16.09.2009\",\n      \"author\": \"AS\",\n      \"changes\": \"Add trigger for delivery items when name of delivery changes\"\n    },\n    {\n      \"version\": \"1.03\",\n      \"date\": \"17.09.2009\",\n      \"author\": \"AS\",\n      \"changes\": \"Add description as read-only property\"\n    },\n    {\n      \"version\": \"1.04\",\n      \"date\": \"18.09.2009\",\n      \"author\": \"AS\",\n      \"changes\": \"Add Edit function to custom menu\"\n    },\n    {\n      \"version\": \"1.05\",\n      \"date\": \"12.01.2010\",\n      \"author\": \"AS\",\n      \"changes\": \"Set quantity of elements, add option to hide element when amount is 0\"\n    },\n    {\n      \"version\": \"1.06\",\n      \"date\": \"15."
      },
      "tokens_used": 8643,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses `Entity arEnt[] = floorGroup.collectEntities(TRUE, Element(), _kModelSpace);` and `Entity allEntElements[] = Group().collectEntities(TRUE, Element(), _kModelSpace);` to gather data from model elements. It also uses `Group().collectEntities(TRUE, TslInst(), _kModelSpace);` to check for duplicate instances, implying the script instances reside in ModelSpace. No usage of `_kPaperSpace`, `_Viewport`, `sd_` prefixes, or `#Type E` shopdrawing constructs found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Group",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires a model with valid Floor Groups (Groups satisfying `bIsDeliverableContainer()` naming rules).",
          "requiredSettings": [
            "External DLL: _kPathHsbInstall + \\Custom\\CDDelivery\\hsbTslDelivery.dll",
            "TSL Script: HSB-DeliveryItem (referenced for triggering updates)"
          ]
        }
      },
      "tokens_used": 8216,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select a point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Executed during script insertion (_bOnInsert) or via 'Create a new delivery' context menu item.",
            "title": null,
            "dataSource": "Properties sNewDeliveryName and sNewDeliveryDescription",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimension style",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles (System dimension styles)",
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sDeliveryName",
            "type": "PropString",
            "displayName": "Delivery name",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Populated from internal map of delivery names (arSDeliveryName)",
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDeliveryDescription",
            "type": "PropString",
            "displayName": "Delivery description",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Read-only property"
          },
          {
            "index": 3,
            "variable": "sHideWhenZero",
            "type": "PropString",
            "displayName": "Hide when amount is '0'",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": null,
            "variable": "nColorTable",
            "type": "PropInt",
            "displayName": "Color table",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": null,
            "variable": "nColorContent",
            "type": "PropInt",
            "displayName": "Color content",
            "defaultValue": 5,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Create a new delivery",
            "handler": "arSTrigger[0]",
            "action": "Initializes a new delivery. Gathers Floor Group and Element data. Opens the .NET dialog (hsbTslDelivery.dll) to set Name and Description.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Edit the current delivery",
            "handler": "arSTrigger[1]",
            "action": "Opens the .NET dialog (hsbTslDelivery.dll) to modify the currently selected delivery data.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "hsbTslDelivery.dll",
            "searchPaths": [
              "_kPathHsbInstall + \\Custom\\CDDelivery\\"
            ],
            "purpose": "Provides the external user interface for creating and editing delivery details via callDotNetFunction2.",
            "required": true
          }
        ]
      },
      "tokens_used": 7387,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Manages delivery logistics by grouping floor elements into shipment batches, updating production quantities, and generating a visual delivery list in the model.",
          "category": "Management/Reporting",
          "typicalUseCase": "Used by project managers or production planners to define specific shipments (e.g., 'Ground Floor Delivery'), assign elements to them, and generate lists for production drawings and logistics."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Specifies the CAD dimension style to be used for the text in the delivery table, controlling font and text size.",
            "validRange": "Any valid dimension style name existing in the drawing.",
            "unit": "Style Name",
            "affectsOutput": "Visually scales and styles the text in the generated delivery table."
          },
          {
            "name": "sDeliveryName",
            "technicalDefault": "",
            "businessMeaning": "The identifier for the specific delivery batch (e.g., 'Truck Load 1') being viewed or managed.",
            "validRange": "List of existing delivery names stored in the script's internal map.",
            "unit": "Text",
            "affectsOutput": "Switches the active data context, refreshing the visual table and updating the 'Quantity' property of all Elements associated with the selected delivery."
          },
          {
            "name": "sDeliveryDescription",
            "technicalDefault": "",
            "businessMeaning": "A descriptive note for the selected delivery, providing details like project phase or destination.",
            "validRange": "Free text (Read-only in OPM, edited via context menu).",
            "unit": "Text",
            "affectsOutput": "Updates the description text in the visual delivery table and the project MapX data."
          },
          {
            "name": "sHideWhenZero",
            "technicalDefault": "|No|",
            "businessMeaning": "Controls the visibility of elements in the list that have a quantity of zero.",
            "validRange": "|Yes|, |No|",
            "unit": "Boolean",
            "affectsOutput": "If set to Yes, elements with 0 quantity are hidden in the visual table, making the list shorter."
          },
          {
            "name": "nColorTable",
            "technicalDefault": -1,
            "businessMeaning": "Defines the display color for the lines drawing the table structure (borders, grids).",
            "validRange": "0-255 (AutoCAD Color Index) or -1 (ByBlock).",
            "unit": "Color Index",
            "affectsOutput": "Changes the color of the graphical lines forming the table."
          },
          {
            "name": "nColorContent",
            "technicalDefault": 5,
            "businessMeaning": "Defines the display color for the text content within the table.",
            "validRange": "0-255 (AutoCAD Color Index) or -1 (ByBlock).",
            "unit": "Color Index",
            "affectsOutput": "Changes the color of the text written inside the table."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User changes 'sDeliveryName'",
            "effect": "Updates the active delivery map, refreshes 'sDeliveryDescription', updates Element quantities, and redraws the table.",
            "cascade": [
              "sDeliveryDescription",
              "Visual Table Content",
              "Element Quantities"
            ]
          },
          {
            "trigger": "User selects 'Create a new delivery' (Context Menu)",
            "effect": "Initializes a new delivery map, populates it with current Floor/Element data, and opens the external dialog.",
            "cascade": [
              "sDeliveryName",
              "sDeliveryDescription",
              "Internal Map Data"
            ]
          },
          {
            "trigger": "User selects 'Edit the current delivery' (Context Menu)",
            "effect": "Opens the external .NET dialog to modify amounts/dates, saves changes to the map, and triggers a redraw.",
            "cascade": [
              "Visual Table Content",
              "Element Quantities"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Table (PLine & Text)",
            "description": "A schematic drawing representing the delivery schedule, placed in Model Space.",
            "appliedTo": "Model Space (at insertion point _Pt0)."
          },
          {
            "type": "Element Property Update",
            "description": "Sets the 'Quantity' property of Elements based on the delivery data.",
            "appliedTo": "Elements found within the Floor Groups assigned to the delivery."
          },
          {
            "type": "Project MapX Data",
            "description": "Embeds the current delivery name and description into the project properties.",
            "appliedTo": "Project (Key: Hsb_Delivery)."
          }
        ]
      },
      "tokens_used": 8283,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch script insertion.",
          "Check if insert cycle > 1 (re-calc). If so, erase instance and exit.",
          "Filter Groups in the project: Collect all groups satisfying 'bIsDeliverableContainer()' naming rules.",
          "Prompt user for 'Delivery name' and 'Delivery description' via ShowDynamicDialog.",
          "Construct internal Map structure for the new delivery, populating it with identified Floor Groups and their contained Elements.",
          "Prompt user to 'Select a point' in Model Space.",
          "Verify Uniqueness: Check current Group for existing 'HSB-HsbDelivery' instances.",
          "Conditional Check: Is there an existing instance?",
          "Path YES: Report warning, erase current instance, and abort.",
          "Path NO: Save internal Map to debug file ('C:\\\\temp\\\\delivery.dxx').",
          "Launch External Interface: Call 'hsbTslDelivery.dll' (LoadFromTsl) with the delivery Map.",
          "Save returned Map to debug file ('C:\\temp\\deliveryOut.dxx').",
          "Store processed delivery Map into script's internal _Map storage.",
          "Exit script (Finish Insertion).",
          "Execution Continues (Post-Insert/Recalc):",
          "Parse 'Hide when amount is 0' property.",
          "Collect all Elements from the current Group and reset their Quantity property to 0.",
          "Extract all delivery data from _Map to populate arrays.",
          "Update Project MapX data ('Hsb_Delivery') with current Name and Description.",
          "Check 'PreviousDeliveryName' against current selection to detect changes.",
          "Conditional: Did the delivery name change OR was 'Edit' triggered?",
          "Path YES: Update 'PreviousDeliveryName', search model for 'HSB-DeliveryItem' scripts, and transform them to trigger recalculation.",
          "Conditional: Was 'Edit the current delivery' triggered?",
          "Path YES: Load current map into DLL, open for edit, save result back to _Map, remove old entry, and force 'Name Changed' logic.",
          "Generate Visuals: Calculate table dimensions based on dimension style.",
          "Draw Table Header and Lines.",
          "Draw Delivery Info (Name, Description).",
          "Iterate through Delivery Groups within the selected delivery:",
          "Draw Group Info (Name, Amount).",
          "Iterate through Delivery Items (Elements):",
          "Update Element Quantity property based on map data.",
          "Conditional: Is 'Hide when amount is 0' active AND Quantity is 0?",
          "Path YES: Skip drawing this row.",
          "Path NO: Draw Item row (Name, Type, Amount) with grid lines."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Return"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Proceed to data gathering"
              ]
            }
          },
          {
            "condition": "Existing Delivery Instance Check",
            "path1": {
              "name": "Duplicate Found",
              "steps": [
                "Report Warning",
                "Erase Instance",
                "Return"
              ]
            },
            "path2": {
              "name": "Unique Instance",
              "steps": [
                "Proceed to External DLL call"
              ]
            }
          },
          {
            "condition": "Delivery Name Change or Edit Trigger",
            "path1": {
              "name": "Changed / Edited",
              "steps": [
                "Update Previous Name Flag",
                "Trigger Delivery Item Scripts",
                "Update Map Data"
              ]
            },
            "path2": {
              "name": "Unchanged",
              "steps": [
                "Skip triggering",
                "Draw current table"
              ]
            }
          },
          {
            "condition": "Hide Zero Items",
            "path1": {
              "name": "Hidden",
              "steps": [
                "Check Quantity",
                "If 0, skip drawing row"
              ]
            },
            "path2": {
              "name": "Visible",
              "steps": [
                "Draw all rows regardless of quantity"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Duplicate script instance on the same Group during insertion.",
            "errorMessage": "|There is already a delivery tsl attached to this floorgroup!|",
            "recovery": "Script automatically erases the new instance to prevent conflict."
          },
          {
            "check": "Existence of Floor Groups (bIsDeliverableContainer).",
            "errorMessage": "Implicitly handles empty lists; if no groups found, the delivery map will be empty.",
            "recovery": "User must ensure proper Group naming conventions exist in the model before creating the delivery."
          },
          {
            "check": "External DLL availability.",
            "errorMessage": "Script will crash or fail silently if 'hsbTslDelivery.dll' is missing or fails to load.",
            "recovery": "Ensure the DLL exists in '_kPathHsbInstall + \\Custom\\CDDelivery\\'."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Active Delivery",
            "how": "OPM Property 'Delivery name'",
            "effect": "Updates the displayed table data, modifies the 'Quantity' property of all mapped Elements, and triggers 'HSB-DeliveryItem' script updates."
          },
          {
            "action": "Edit Delivery Data",
            "how": "Context Menu 'Edit the current delivery'",
            "effect": "Opens the .NET dialog to modify amounts/dates. Updates the visual table and Element quantities upon saving."
          },
          {
            "action": "Visual Styling",
            "how": "OPM Properties 'Dimension style', 'Color table', 'Color content'",
            "effect": "Regenerates the table with new fonts, sizes, and colors."
          },
          {
            "action": "Filter View",
            "how": "OPM Property 'Hide when amount is '0''",
            "effect": "Redraws the table, hiding rows for items that have a calculated quantity of 0."
          }
        ]
      },
      "tokens_used": 9934,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "```json\n{\n  \"documentation\": \"# HSB-HsbDelivery\\n\\n## Overview\\nThis script creates and manages delivery batches (shipments) within your timber project. It groups floor elements into specific deliveries, updates element quantities, and generates a visual table in Model Space for production drawings and database integration.\\n\\n## Usage Environment\\n\\n| Space | Supported | Notes |\\n|-------|-----------|-------|\\n| Model Space | Yes | The script instance and visual table are placed here. |\\n| Paper Space | No | Not supported in layouts. |\\n| Shop Drawing | No | This is a model management script, not a detailing tool. |\\n\\n## Prerequisites\\n- **Required Entities**: Floor Groups (must meet specific naming rules) and Elements inside those groups.\\n- **Minimum Beam Count**: 0 (This script works with Elements, not necessarily structural beams).\\n- **Required Settings Files**:\\n  - `hsbTslDelivery.dll` located in `hsbCAD\\\\Custom\\\\CDDelivery\\\\`. This is required for the editing interface.\\n\\n## Usage Steps\\n\\n### Step 1: Launch Script\\nCommand: `TSLINSERT` â†’ Select `HSB-HsbDelivery.mcr` from the list.\\n\\n### Step 2: Define Delivery Details\\nA dialog will appear automatically during insertion.\\n- **Action**: Enter a **Delivery Name** (e.g., \\\"Truck 1\\\") and a **Description**. Click OK.\\n\\n### Step 3: Placement\\n```\\nCommand Line: |Select a point|\\nAction: Click anywhere in the Model Space to place the delivery list origin.\\n```\\n\\n### Step 4: Configure Content (External Interface)\\n- **Action**: After placement, an external dialog window (.NET) will open. Use this interface to select which Floor Groups belong to this delivery and set the quantity for each element.\\n- **Action**: Save and Close the external dialog. The script will generate the visual table and update the model.\\n\\n## Properties Panel Parameters\\n\\n| Parameter | Type | Default | Description |\\n|-----------|------|---------|-------------|\\n| Dimension style | Dropdown | (Current DimStyle) | Selects the CAD dimension style to control the text font and size in the table. |\\n| Delivery name | Dropdown | (Empty) | Selects the active delivery batch to view or manage. Changing this updates the entire table and element quantities. |\\n| Delivery description | Text | (Empty) | Displays a description of the current delivery. (Read-only; edit via Right-Click menu). |\\n| Hide when amount is '0' | Dropdown | \\\\|No\\\\| | If set to \\\\|Yes\\\\|, items with a quantity of 0 are hidden in the visual table. |\\n| Color table | Number | -1 | Sets the color for the table grid lines (-1 = ByBlock). |\\n| Color content | Number | 5 | Sets the color for the text inside the table. |\\n\\n## Right-Click Menu Options\\n\\n| Menu Item | Description |\\n|-----------|-------------|\\n| Create a new delivery | Initializes a new delivery map, gathers current model data, and opens the external dialog to define the batch. |\\n| Edit the current delivery | Opens the external dialog for the currently selected delivery, allowing you to modify quantities and assignments. |\\n\\n## Settings Files\\n- **Filename**: `hsbTslDelivery.dll`\\n- **Location**: `_kPathHsbInstall + \\\\Custom\\\\CDDelivery\\\\`\\n- **Purpose**: Provides the user interface for assigning elements to deliveries and editing quantities.\\n\\n## Tips\\n- **Group Naming**: Ensure your Floor Groups follow the project naming convention required for delivery containers, otherwise, they will not appear in the external selection list.\\n- **Switching Deliveries**: You can switch between different deliveries (e.g., Truck 1 vs. Truck 2) simply by changing the \\\"Delivery name\\\" property in the Properties Palette without running the script again.\\n- **Clean Drawings**: Use the \\\"Hide when amount is '0'\\\" option to keep your production drawings clean by removing rows for items not included in the specific shipment.\\n\\n## FAQ\\n- **Q: Why did the script disappear immediately after I placed it?**\\n  A: You likely tried to insert a second delivery instance on a Floor Group that already has one. The script prevents duplicates to avoid conflicts. Delete the existing one first or use the \\\"Edit\\\" function on the existing instance.\\n\\n- **Q: How do I change the description of a delivery?**\\n  A: The description is read-only in the Properties Palette. Right-click the script instance and select \\\"Edit the current delivery\\\" to modify the description in the external dialog.\\n\\n- **Q: The table text is too small/large.**\\n  A: Change the \\\"Dimension style\\\" property in the Properties Palette to a style with your preferred text height and font settings.\"\n}\n```"
      },
      "tokens_used": 6937,
      "error": null
    }
  }
}