{
  "filename": "f_LorryTag.mcr",
  "status": "completed",
  "total_tokens": 54003,
  "processing_time": 254.67318868637085,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": 1,\n    \"minorVersion\": 2,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"This tsl creates tagging and hatching of packages. Hatches are based on painter definitions\",\n  \"versionHistory\": [\n    {\n     "
      },
      "tokens_used": 9191,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Viewport().inLayoutTab(), Viewport().inPaperSpace(), ShopDrawView sdv, _kOnGenerateShopDrawing, ViewData viewDatas, ents[i].typeDxfName()==\"HSBCAD_MULTIPAGE\", bForceModelSpace = true"
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst (f_LorryPackage)",
            "Entity (HSBCAD_MULTIPAGE)",
            "ShopDrawView"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (instance location), selectable in Paper Space via Viewports",
          "requiredSettings": [
            "PainterDefinition"
          ]
        }
      },
      "tokens_used": 7601,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select shopdraw viewport",
              "condition": "viewEnts.length()>0",
              "required": true
            },
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select lorry packages (or its multipages)",
              "condition": "!(viewEnts.length()>0)",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "",
              "condition": "_Entity.length()>0 (ShopDrawView selected)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "Insertion (_bOnInsert) if _kExecuteKey is empty",
            "title": "Properties",
            "dataSource": "Properties defined in script",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowDialog (DialogMode 1)",
            "trigger": "Context Menu: Set painter hatches",
            "title": "addHatch",
            "dataSource": "PainterDefinition list, Color, Transparency inputs",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowDialog (DialogMode 2)",
            "trigger": "Context Menu: Remove painter hatches",
            "title": "removeHatch",
            "dataSource": "PainterDefinition list",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ReportNotice",
            "trigger": "Context Menu: List Painter Hatches",
            "title": "Information",
            "dataSource": "Internal PainterDefinition scan results",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "@(PosNum)",
            "inputType": "text",
            "options": [],
            "category": "Tag",
            "description": "Defines the Format"
          },
          {
            "index": 1,
            "variable": "sTagRule",
            "type": "PropString",
            "displayName": "Tag Placement",
            "defaultValue": "Closest Location",
            "inputType": "dropdown",
            "options": [
              "Closest Location",
              "Outside of Object"
            ],
            "category": "Tag",
            "description": "Defines the TagRule"
          },
          {
            "index": 2,
            "variable": "sApplyHatch",
            "type": "PropString",
            "displayName": "Hatch active",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": "Hatch",
            "description": "Defines if the painter hatching is active"
          },
          {
            "index": 3,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": "System DimStyles",
            "inputType": "dropdown",
            "options": [
              "_DimStyles.sorted()"
            ],
            "category": "Display",
            "description": "Defines the DimStyle"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "Text Height",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "Defines the Text Height"
          },
          {
            "index": 0,
            "variable": "sPainter",
            "type": "PropString",
            "displayName": "Painter",
            "defaultValue": "System Painters",
            "inputType": "dropdown",
            "options": [
              "PainterDefinition().getAllEntryNames()"
            ],
            "category": "General",
            "description": "Defines the Painter where the hatching will be stored to"
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the Color"
          },
          {
            "index": 1,
            "variable": "nTransparency",
            "type": "PropInt",
            "displayName": "Transparency",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the Transparency"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "../|Grip points on|",
            "handler": "../|Grip points on|",
            "action": "Enables EditInPlace mode, showing grips for manual tag repositioning.",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "../|Grip points off|",
            "handler": "../|Grip points off|",
            "action": "Disables EditInPlace mode and removes manual repositioning grips.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Set painter hatches",
            "handler": "Set painter hatches",
            "action": "Launches a dialog (DialogMode=1) to assign hatch properties (Color, Transparency) to a Painter definition.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove painter hatches",
            "handler": "Remove painter hatches",
            "action": "Launches a dialog (DialogMode=2) to select a Painter definition and remove its associated hatch data.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "List Painter Hatches",
            "handler": "List Painter Hatches",
            "action": "Scans all Painter definitions and displays a report of those containing hatch settings for this script.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8364,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates logistics tags (labels) and visual hatching for timber packages, primarily used in production or shipping layouts to identify and distinguish package contents.",
          "category": "ShopDrawing / Logistics",
          "typicalUseCase": "Used during the creation of shop drawings or packaging plans to automatically label 'Lorry Packages' (e.g., Package 1, Package 2) and apply color-coded hatching to them based on their material definitions."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(PosNum)",
            "businessMeaning": "The data content displayed on the package tag label. It uses a format string to display properties like Position Number, Elevation, or custom attributes.",
            "validRange": "Any valid hsbCAD format string (e.g., '@(PosNum)', '@(Elev)', 'Pack @(Length)mm').",
            "unit": "String",
            "affectsOutput": "Changes the text displayed inside the tag box on the drawing."
          },
          {
            "name": "sTagRule",
            "technicalDefault": "Closest Location",
            "businessMeaning": "The algorithm used to determine where the tag is placed relative to the package geometry to prevent overlap with other elements.",
            "validRange": "Closest Location, Outside of Object",
            "unit": "Enum",
            "affectsOutput": "Determines the position of the label and the leader line origin point."
          },
          {
            "name": "sApplyHatch",
            "technicalDefault": "No",
            "businessMeaning": "Toggles the visual hatching (color fill) of the package boundary, useful for visually separating different packages on a congested drawing.",
            "validRange": "Yes, No",
            "unit": "Enum",
            "affectsOutput": "If Yes, draws a filled hatch pattern over the package geometry using settings from the Painter Definition."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "System DimStyles",
            "businessMeaning": "Selects the CAD Dimension Style that governs the text appearance (font, default size) for the tag.",
            "validRange": "Available DimStyles in the current drawing.",
            "unit": "String (Name of Style)",
            "affectsOutput": "Alters the font and arrow style of the tag if 'Text Height' is set to 0."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Explicitly sets the height of the tag text, overriding the default size defined in the selected DimStyle.",
            "validRange": "Any positive number (e.g., 2.5, 5.0). 0 uses DimStyle default.",
            "unit": "mm",
            "affectsOutput": "Scales the text size of the tag. Also affects the spacing logic (step size) used by the placement algorithm to avoid collisions."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight is set to 0",
            "effect": "The text height is derived from the sDimStyle setting.",
            "cascade": [
              "sDimStyle"
            ]
          },
          {
            "trigger": "sApplyHatch is set to 'Yes'",
            "effect": "The script reads hatching settings (Color/Transparency) stored in the Painter Definitions linked to the package elements.",
            "cascade": [
              "PainterDefinition (External)"
            ]
          },
          {
            "trigger": "sTagRule is changed",
            "effect": "The collision detection algorithm changes logic (searching nearest point vs. forcing outside), which relies on the calculated text size to determine spacing steps.",
            "cascade": [
              "dTextHeight"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text/Tag",
            "description": "A text label displaying the formatted string (e.g., Package Number), enclosed in a box with a leader line pointing to the package.",
            "appliedTo": "TslInst (f_LorryPackage) or Multipage views in Model/Paper space."
          },
          {
            "type": "Hatch (PlanarProfile)",
            "description": "A colored fill pattern applied to the outline of the package to visually distinguish it. The properties (Color/Transparency) are retrieved from the package's Painter Definition.",
            "appliedTo": "The projection of the Lorry Package in the current coordinate system (Model Space or Shop Drawing View)."
          }
        ]
      },
      "tokens_used": 10405,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script Execution Starts\",\n    \"2. Check Execution Key (Catalog Entry). If empty, show Properties Dialog.\",\n    \"3. Check current space for ShopDrawViews (Environment Scan).\",\n    \"4. [Decision] Are ShopDrawViews present in Model Space?\",\n    \"5. [Path A] Yes: Prompt user to Select ShopDraw Viewport.\",\n    \"5. [Path B] No: Prompt user to Select Lorry Packages or Multipages.\",\n    \"6. Process Selected Entities (Filter into Packages, Multipages, or ShopDrawView).\",\n    \"7. [Decision] Was a ShopDrawView selected?\",\n    \"8. [Path A] Yes: Persist script instance, request Insertion Point (getPoint).\",\n    \"8. [Path B] No: Batch-create TSL instances for each Package/Multipage, Erase script instance.\",\n    \"9. Script Recalculation (Generation Phase).\",\n    \"10. Determine execution mode (ShopDraw Mode vs Model Space Mode).\",\n    \"11. Collect Target Packages (from ShowSet or Entity links).\",\n    \"12. Loop through Packages:\",\n    \"13.   - Format Tag String based on sFormat property.\",\n    \"14.   - [Decision] Is 'Hatch active' set to Yes?\",\n    \"15.     - Yes: Retrieve Color/Transparency from PainterDefinition and draw Hatch.\",\n    \"16.   - [Decision] What is the 'Tag Placement' rule?\",\n    \"17.     - 'Closest Location': Search for nearest open spot on package profile.\",\n    \"18.     - 'Outside of Object': Search for spot on the outer ring boundary.\",\n    \"19.   - Draw Text, Box, and Leader Line.\",\n    \"20.   - Update collision protection area.\",\n    \"21. [Decision] Is 'EditInPlace' active?\",\n    \"22.   - Yes: Generate Grip Points for tag repositioning.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Presence of ShopDrawViews in Model Space during insertion\",\n      \"path1\": {\n        \"name\": \"ShopDraw Mode\",\n        \"steps\": [\n          \"Prompt: 'Select shopdraw viewport'\",\n          \"Filter selection for ShopDrawView entity\",\n          \"Link script instance to the Viewport\",\n          \"Prompt for insertion point (_Pt0)\",\n          \"Script persists as a view-annotation\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Package/Multipage Mode\",\n        \"steps\": [\n          \"Prompt: 'Select lorry packages (or its multipages)'\",\n          \"Filter selection for TslInst (f_LorryPackage) or HSBCAD_MULTIPAGE\",\n          \"Batch create child instances for each selection\",\n          \"Script self-erases (EraseInstance)\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Shop"
      },
      "tokens_used": 11975,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# f_LorryTag.mcr\n\n## Overview\nThis script automatically generates logistics tags (labels) and applies color-coded hatching to timber packages (Lorry Packages) in shop drawings or model space. It helps visualize and identify package contents during production and shipping planning.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Tags packages or attaches to ShopDrawView viewports. |\n| Paper Space | Yes | Updates automatically when viewed through viewports linked to Model Space. |\n| Shop Drawing | Yes | Supports standard ShopDrawView entities and Multipage views. |\n\n## Prerequisites\n- **Required Entities**: `TslInst` (f_LorryPackage), `HSBCAD_MULTIPAGE`, or `ShopDrawView` (Viewport).\n- **Minimum Beam Count**: 0\n- **Required Settings**: Valid `PainterDefinition` entries (if using the hatching feature).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `f_LorryTag.mcr` from the list.\n\n### Step 2: Select Target Entity\nThe command line prompt depends on your current drawing environment:\n*   **If ShopDrawView viewports exist**:\n    ```\n    Command Line: Select shopdraw viewport\n    Action: Click on the viewport in Model Space representing the shop drawing view you wish to annotate.\n    ```\n*   **If no ShopDrawView viewports exist**:\n    ```\n    Command Line: Select lorry packages (or its multipages)\n    Action: Select the specific Lorry Package instances or Multipage entities in the drawing.\n    ```\n\n### Step 3: Define Placement (If Viewport Selected)\nIf you selected a viewport in Step 2:\n```\nCommand Line: \nAction: Click a point in the drawing to set the reference location for the script instance.\n```\n*Note: If you selected Lorry Packages directly, the script will automatically apply tags to all selected items and finish.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | text | @(PosNum) | Defines the text displayed on the tag (e.g., Package Number). |\n| Tag Placement | dropdown | Closest Location | Determines where the tag is placed: \"Closest Location\" or \"Outside of Object\". |\n| Hatch active | dropdown | No | Toggles the visual hatching of the package boundary (Yes/No). |\n| Dimstyle | dropdown | System DimStyles | Selects the CAD Dimension Style used for the tag text font and arrows. |\n| Text Height | number | 0 | Defines the text height in mm. Set to 0 to use the DimStyle default. |\n| Painter | dropdown | System Painters | Selects the Painter Definition where hatch settings are stored. |\n| Color | number | 1 | Defines the Color index (ACI) for the hatch. |\n| Transparency | number | 0 | Defines the Transparency level for the hatch (0-255). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Grip points on | Enables EditInPlace mode, showing grips that allow you to manually drag and reposition tags. |\n| Grip points off | Disables EditInPlace mode and hides the manual repositioning grips. |\n| Set painter hatches | Opens a dialog to assign hatch properties (Color, Transparency) to a specific Painter Definition. |\n| Remove painter hatches | Opens a dialog to select a Painter Definition and remove its associated hatch data. |\n| List Painter Hatches | Displays a report listing all Painter Definitions currently configured with hatch settings for this script. |\n\n## Settings Files\n- **Painter Definitions**: System database\n- **Location**: hsbCAD Company/Project Standards\n- **Purpose**: Stores hatch patterns and layer assignments used by the `Hatch active` parameter.\n\n## Tips\n- Set **Text Height** to `0` to ensure the tag text automatically scales if you change your drawing's DimStyle.\n- Use **Hatch active** set to \"Yes\" with contrasting colors to visually separate different packages on congested loading plans.\n- You can double-click the script instance to toggle \"Grip points on/off\" for quick adjustments.\n- The **Format** property supports dynamic fields like `@(PosNum)`, `@(Length)`, or `@(Elev)` to display specific package data.\n\n## FAQ\n- Q: Why is my tag text appearing in the wrong size?\n  A: Check the **Text Height** property. If it is set to `0`, the size is controlled by the **Dimstyle** property.\n- Q: The hatch is not showing up even though \"Hatch active\" is set to \"Yes\".\n  A: Ensure that the **Painter** property is set to a Painter Definition that actually contains hatch geometry or valid color assignments.\n- Q: How do I move a tag that is overlapping another object?\n  A: Right-click the script instance and select \"Grip points on\", then drag the blue grip points to move the tag to a clear location."
      },
      "tokens_used": 6467,
      "error": null
    }
  }
}