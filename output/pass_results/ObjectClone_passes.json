{
  "filename": "ObjectClone.mcr",
  "status": "completed",
  "total_tokens": 52334,
  "processing_time": 352.4379267692566,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates a clone of an entity and transforms its representation into XY-World plane",
        "versionHistory": [
          {
            "version": "1.8",
            "date": "31.10.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22323 bugfix purging on insert"
          },
          {
            "version": "1.7",
            "date": "30.10.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22323 supports weight, purges duplicates, settings to control tag location"
          },
          {
            "version": "1.6",
            "date": "24.10.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-20438 default tag location set to middle"
          },
          {
            "version": "1.5",
            "date": "02.08.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 bugfix initial distribution"
          },
          {
            "version": "1.4",
            "date": "01.08.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 grip based assigning"
          },
          {
            "version": "1.3",
            "date": "24.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 visible height published"
          },
          {
            "version": "1.1",
            "date": "05.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 parent/child grouping fixed"
          },
          {
            "version": "1.1",
            "date": "05.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 supports parent/child grouping"
          },
          {
            "version": "1.0",
            "date": "22.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 initial version of ObjectClone"
          }
        ],
        "settingsFiles": [
          "ObjectClone.xml"
        ],
        "dependencies": [
          "ObjectNester.mcr"
        ]
      },
      "tokens_used": 8886,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses _kModelSpace explicitly in `dbCreate` calls and `Group().collectEntities(..., _kModelSpace)`. It references GenBeam and Element entities but lacks ShopDrawing specific prefixes (sd_*) or Paper Space keywords (_kPaperSpace, _Viewport). The functionality involves cloning entities and transforming them to the XY-World plane, characteristic of Model Space detailing or visualization tools."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "ObjectClone.xml"
          ]
        }
      },
      "tokens_used": 6029,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [],\n    \"keywordOptions\": [],\n    \"userPrompts\": [\n      {\n        \"function\": \"getString\",\n        \"promptOriginal\": \"\\\"|Are you sure to overwrite existing settings?|\\\" + \\\" [|No|]/[|Yes|]\\\"\",\n        \"context\": \"Export Settings confirmation\",\n        \"condition\": \"_bOnRecalc && _kExecuteKey == sTriggerExportSettings && findFile(sFullPath).length()>0\"\n      }\n    ]\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"ShowDynamicDialog\",\n      \"trigger\": \"Context Menu Item: '|Settings|'\",\n      \"title\": null,\n      \"dataSource\": \"Properties defined in DialogMode block (nDialogMode==1)\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dXOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|X-Offset Tag|\",\n      \"defaultValue\": \"0\",\n      \"inputType\": \"number\",\n      \"category\": \"|Tag Position|\",\n      \"description\": \"|Defines the default X-offset of the tag seen from the upper left corner.| |The selected mode specifies if an absolute offset or a fraction of the corresponding clone dimension is used.|\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sXMode\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|X-Offset Mode|\",\n      \"defaultValue\": \"|Absolute|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Absolute|\",\n        \"|Relative|\"\n      ],\n      \"category\": \"|Tag Position|\",\n      \"description\": \"|Defines if the offset is absolute or relative|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dYOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Y-Offset Tag|\",\n      \"defaultValue\": \"0\",\n      \"inputType\": \"number\",\n      \"category\": \"|Tag Position|\",\n      \"description\": \"|Defines the default X-offset of the tag seen from the upper left corner.| |The selected mode specifies if an absolute offset or a fraction of the corresponding clone dimension is used.|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sYMode\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Y-Offset Mode|\",\n      \"defaultValue\": \"|Absolute|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Absolute|\",\n        \"|Relative|\"\n      ],\n      \"category\": \"|Tag Position|\",\n      \"description\": \"|Defines if the offset is absolute or relative|\"\n    }\n  ],\n  \"contextMenu\": [\n    {\n      \"menuItem\": \"|Show Relation|\",\n      \"handler\": \"_kExecuteKey == sTriggerShowRelation\",\n      \"action\": \"Toggles the ShowRelation map state (true/false) and forces a recalculation.\"\n    },\n    {\n      \"menuItem\": \"|Hide Relation|\",\n      \"handler\": \"_kExecuteKey == sTriggerShowRelation\",\n      \"action\": \"Toggles the ShowRelation map state (true/false) and forces a recalculation.\"\n    },\n    {\n      \"menuItem\": \"|Settings|\",\n      \"handler\": \"_kExecuteKey == sTriggerDisplaySetting\",\n      \"action\": \"Opens a dynamic dialog to modify Tag offset and mode settings (X/Y).\"\n    },\n    {\n      \"menuItem\": \"|Import Settings|\",\n      \"handler\": \"_kExecuteKey == sTriggerImportSettings\",\n      \"action\": \"Reads settings from ObjectClone.xml and updates the MapObject.\"\n    },\n    {\n      \"menuItem\": \"|Export Settings|\",\n      \"handler\": \"_kExecuteKey"
      },
      "tokens_used": 10369,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "This script creates a flattened 2D clone representation of timber elements (GenBeams or Elements) projected onto the XY-World plane, typically used for creating production tags, labels, or nestings within model space.",
          "category": "Visualization/ProductionSupport",
          "typicalUseCase": "Generating visual tags or representations of timber parts on a flat plane for identification, nesting optimization, or workshop documentation directly in the 3D model."
        },
        "parameters": [
          {
            "name": "dXOffset",
            "technicalDefault": "0",
            "businessMeaning": "Controls the horizontal distance of the text tag from the origin point of the cloned representation. It determines where the information label sits relative to the geometry.",
            "validRange": "0 to unlimited (depending on part size)",
            "unit": "mm",
            "affectsOutput": "Moves the generated text tag left or right relative to the clone's insertion point."
          },
          {
            "name": "sXMode",
            "technicalDefault": "\"|Absolute|\"",
            "businessMeaning": "Determines how the X offset is calculated. 'Absolute' uses fixed millimeters, while 'Relative' uses a percentage of the clone's width.",
            "validRange": "\"|Absolute|\", \"|Relative|\"",
            "unit": "Enumeration",
            "affectsOutput": "Changes the scaling of the horizontal tag offset based on the size of the cloned object."
          },
          {
            "name": "dYOffset",
            "technicalDefault": "0",
            "businessMeaning": "Controls the vertical distance of the text tag from the origin point of the cloned representation.",
            "validRange": "0 to unlimited",
            "unit": "mm",
            "affectsOutput": "Moves the generated text tag up or down relative to the clone's insertion point."
          },
          {
            "name": "sYMode",
            "technicalDefault": "\"|Absolute|\"",
            "businessMeaning": "Determines how the Y offset is calculated. 'Absolute' uses fixed millimeters, while 'Relative' uses a percentage of the clone's height.",
            "validRange": "\"|Absolute|\", \"|Relative|\"",
            "unit": "Enumeration",
            "affectsOutput": "Changes the scaling of the vertical tag offset based on the size of the cloned object."
          },
          {
            "name": "ShowRelation",
            "technicalDefault": "false (implied)",
            "businessMeaning": "Toggles the visibility of the connection line or relationship between the 3D source entity and its 2D clone representation.",
            "validRange": "true, false",
            "unit": "Boolean",
            "affectsOutput": "Displays or hides a visual link showing which original object the clone belongs to."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sXMode changes to \"|Relative|\"",
            "effect": "dXOffset is interpreted as a fraction (0.0 to 1.0) of the clone's bounding box width instead of absolute millimeters.",
            "cascade": [
              "dXOffset"
            ]
          },
          {
            "trigger": "sYMode changes to \"|Relative|\"",
            "effect": "dYOffset is interpreted as a fraction (0.0 to 1.0) of the clone's bounding box height instead of absolute millimeters.",
            "cascade": [
              "dYOffset"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry (PlaneProfile)",
            "description": "A flattened 2D projection of the selected 3D timber entity onto the XY plane.",
            "appliedTo": "Model Space (standalone representation linked to parent GenBeam/Element)"
          },
          {
            "type": "Text/Tag",
            "description": "Formatted text label displaying properties (e.g., Weight, VisibleHeight) of the source entity.",
            "appliedTo": "Model Space (positioned relative to the 2D clone)"
          },
          {
            "type": "Visual Link (Line)",
            "description": "A connector drawn between the 3D source entity and the 2D clone when 'Show Relation' is active.",
            "appliedTo": "Model Space (between source entity and clone)"
          }
        ]
      },
      "tokens_used": 8695,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Load constants, colors, and view definitions.",
          "2. Settings Management: Check for existing MapObject.",
          "3. [Conditional] If MapObject is missing or invalid on insert: Read 'ObjectClone.xml' from Company or Install path and create MapObject.",
          "4. [Conditional] If on DbCreated: Compare version of current MapObject vs. XML file; report notice if mismatched.",
          "5. Load configuration: Retrieve dXOffset, dYOffset, sXMode, sYMode from Map.",
          "6. [Insert Mode - Implied]: Prompt user to select entity (GenBeam/Element) and pick location for the 2D clone.",
          "7. Calculation: Generate 2D PlaneProfile (Shape) and determine Tag position based on offsets.",
          "8. [Recalc Mode] Check for Execute Keys (Context Menu triggers):",
          "   a. Handle 'Show Relation' / 'Hide Relation' (Toggle boolean).",
          "   b. Handle 'Settings' (Open Dialog, update Map).",
          "   c. Handle 'Import/Export Settings' (File I/O).",
          "9. Execution: Draw 2D Shape, Text Tag, and Relation Line (if enabled) in Model Space."
        ],
        "conditionalBranches": [
          {
            "condition": "Settings Load Source (On Insert)",
            "path1": {
              "name": "Existing MapObject",
              "steps": [
                "Retrieve valid MapObject from hsbTSL dictionary",
                "Read settings from Map"
              ]
            },
            "path2": {
              "name": "New/Invalid MapObject",
              "steps": [
                "Search for ObjectClone.xml in Company path",
                "Fallback to Install path if not found",
                "Read XML and create new MapObject"
              ]
            }
          },
          {
            "condition": "Grip Drag Interaction (Moving the Clone)",
            "path1": {
              "name": "Dropped on ObjectNester",
              "steps": [
                "Identify target Nester via geometric intersection",
                "Remove 'Child2Remove' key from previous parent Nester",
                "Set 'Child2Add' key on new parent Nester",
                "Update instance position"
              ]
            },
            "path2": {
              "name": "Dropped in free space",
              "steps": [
                "Remove 'Child2Remove' key from previous parent Nester",
                "Update instance position",
                "No new parent assignment"
              ]
            }
          },
          {
            "condition": "Export Settings Trigger",
            "path1": {
              "name": "File Exists",
              "steps": [
                "Prompt user: 'Are you sure to overwrite existing settings? [No]/[Yes]'",
                "If Yes: Write Map to XML",
                "If No: Cancel export"
              ]
            },
            "path2": {
              "name": "File Does Not Exist",
              "steps": [
                "Create necessary directories",
                "Write Map to XML"
              ]
            }
          },
          {
            "condition": "Show Relation Toggle",
            "path1": {
              "name": "Enable Relation",
              "steps": [
                "Set Map 'ShowRelation' to 1",
                "Draw connector line between 3D entity and 2D clone"
              ]
            },
            "path2": {
              "name": "Disable Relation",
              "steps": [
                "Set Map 'ShowRelation' to 0",
                "Suppress connector line drawing"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Settings Overwrite",
            "errorMessage": "Command line prompt: '|Are you sure to overwrite existing settings?| [|No|]/[|Yes|]'",
            "recovery": "User must input 'Yes' to proceed or 'No' to cancel."
          },
          {
            "check": "Version Compatibility",
            "errorMessage": "Notice: '|A different Version of the settings has been found for| [ScriptName] ...'",
            "recovery": "No automatic fix; user is notified to check XML vs Database consistency."
          },
          {
            "check": "File Path Availability",
            "errorMessage": "Failure if 'makeFolder' returns false or 'findFile' returns empty string.",
            "recovery": "Ensure write permissions exist in _kPathHsbCompany and folder structure is correct."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Clone Position",
            "how": "Grip Edit (Drag the clone)",
            "effect": "Moves the 2D representation. Logic automatically handles assigning/reassigning the clone to an 'ObjectNester' parent based on geometric overlap."
          },
          {
            "action": "Configure Tag Layout",
            "how": "Context Menu -> '|Settings|' or OPM Properties",
            "effect": "Opens dynamic dialog to change X/Y Offsets and Modes (Absolute/Relative). Updates are saved to the MapObject."
          },
          {
            "action": "Toggle Visual Link",
            "how": "Context Menu -> '|Show Relation|' / '|Hide Relation|'",
            "effect": "Toggles the visibility of the line linking the source timber entity to the 2D clone."
          },
          {
            "action": "Import/Export Configuration",
            "how": "Context Menu -> '|Import Settings|' / '|Export Settings|'",
            "effect": "Loads current configuration from XML or saves current configuration to XML for project/company standardization."
          }
        ]
      },
      "tokens_used": 11567,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ObjectClone.mcr\n\n## Overview\nThis script creates a flattened 2D clone of selected 3D timber elements (GenBeams or Elements) projected onto the XY-world plane. It is primarily used for generating production tags, labels, or preparing geometry for nesting layouts directly within the model space.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script generates 2D geometry and visual links in the 3D model environment. |\n| Paper Space | No | Not designed for use in Layouts/Viewports. |\n| Shop Drawing | No | Not intended for 2D detailing views. |\n\n## Prerequisites\n- **Required Entities**: An existing `GenBeam` or `Element` to clone.\n- **Minimum Beam Count**: 0 (Selects existing entities rather than creating new ones).\n- **Required Settings**: `ObjectClone.xml` (Auto-loaded from Company or Install path on first use).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `ObjectClone.mcr` from the list.\n\n### Step 2: Select Entity and Location\n1.  **Command Line**: Select the timber entity (GenBeam or Element) you wish to clone.\n2.  **Command Line**: Specify the insertion point for the 2D clone in the XY-plane.\n3.  The script generates the 2D representation and the tag at the specified location.\n\n### Step 3: Positioning (Optional)\n1.  Select the newly created clone.\n2.  Drag the **Grip** to move the clone.\n    *   *Note*: If you drop the clone onto an `ObjectNester` entity, it will automatically group/assign itself to it.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| X-Offset Tag | Number | 0 | Sets the horizontal distance (mm) of the text tag from the clone's top-left corner. |\n| X-Offset Mode | Dropdown | Absolute | Determines how X offset is calculated: **Absolute** (fixed mm) or **Relative** (percentage of clone width). |\n| Y-Offset Tag | Number | 0 | Sets the vertical distance (mm) of the text tag from the clone's top-left corner. |\n| Y-Offset Mode | Dropdown | Absolute | Determines how Y offset is calculated: **Absolute** (fixed mm) or **Relative** (percentage of clone height). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Show / Hide Relation | Toggles the visibility of the connector line between the original 3D timber part and the 2D clone. |\n| Settings | Opens a dialog box to quickly configure Tag Offsets and Modes without using the Properties palette. |\n| Import Settings | Loads configuration settings from the `ObjectClone.xml` file. |\n| Export Settings | Saves the current configuration settings to the `ObjectClone.xml` file (overwrites existing). |\n\n## Settings Files\n- **Filename**: `ObjectClone.xml`\n- **Location**: Company path (preferred) or hsbCAD Install path.\n- **Purpose**: Stores default values for tag positioning (X/Y offsets and modes) to ensure consistency across projects.\n\n## Tips\n- **Nesting Integration**: Use the grip to drag and drop clones onto `ObjectNester` objects to automatically organize them for production.\n- **Relative Positioning**: If you are cloning parts of varying sizes, set the Offset Modes to **Relative**. This ensures the tag stays in a proportional position (e.g., always 10% from the edge) regardless of the part size.\n- **Weight Visibility**: The script supports calculating and displaying the weight of the cloned entity (Version 1.7+).\n\n## FAQ\n- **Q: How do I reset the tag position to the default?**\n  - **A**: Open the Context Menu, select **Import Settings**, or manually set the X and Y Offset values to `0` in the Properties panel.\n- **Q: Why does my tag disappear when I change the size?**\n  - **A**: If you are using **Relative** mode, an offset value like `1.0` (100%) or greater might place the text outside the visible boundary of the clone. Try reducing the offset value (e.g., to `0.1` for 10%).\n- **Q: Can I use this script in a drawing view?**\n  - **A**: No, this script works exclusively in Model Space (`_kModelSpace`)."
      },
      "tokens_used": 6788,
      "error": null
    }
  }
}