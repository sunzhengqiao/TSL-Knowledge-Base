{
  "filename": "hsb_ProjectSettings.mcr",
  "status": "completed",
  "total_tokens": 34453,
  "processing_time": 361.01065826416016,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4966,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses `_kModel` in `gp.collectEntities(true, TslInst(), _kModel)` to find other TSL instances. It lacks `sd_` prefixes, `_Viewport` checks, or `#Type E` definitions, indicating it is a standard Model Space script."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "hsbSoft.BomLink.Tsl.dll (DotNet assembly located at _kPathHsbInstall)",
            "BOMLink Project list",
            "Dimension Styles"
          ]
        }
      },
      "tokens_used": 3164,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "Pick a point",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 1,
            "variable": "sSelectedProject",
            "type": "PropString",
            "displayName": "BOMLink Project",
            "defaultValue": "arProjects[1]",
            "inputType": "dropdown",
            "options": [
              "arProjects (Dynamic from DotNet)"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimension style",
            "defaultValue": "_DimStyles[0]",
            "inputType": "dropdown",
            "options": [
              "_DimStyles (System Global)"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColorLine",
            "type": "PropInt",
            "displayName": "Line color",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nColorHeader",
            "type": "PropInt",
            "displayName": "Text color: Header",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "nColorContent",
            "type": "PropInt",
            "displayName": "Text color: Content",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Update Project Settings|",
            "handler": "strChangeEntity",
            "action": "Refreshes project variables from the BOMLink DLL based on the current company and selected project.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6662,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Establishes a link between the CAD model and the external BOMLink database by selecting a specific project, visualizing its global variables as a table, and storing them in the project settings for use by other scripts.",
          "category": "Setup/Configuration",
          "typicalUseCase": "Used at the beginning of a project to define the global context (Company/Project) ensuring that all subsequent automated elements and reports reference the correct data from the BOMLink system."
        },
        "parameters": [
          {
            "name": "sSelectedProject",
            "technicalDefault": "arProjects[1]",
            "businessMeaning": "Identifies the specific project context from the BOMLink database. This selection determines which set of global variables and standards are applied to the entire CAD model.",
            "validRange": "List of available projects in the BOMLink database (dynamic list)",
            "unit": "String",
            "affectsOutput": "Drives the content of the generated table and the variables stored in the global Project MapX ('HSB_PROJECTSETTINGS'). Changing this updates the underlying configuration data for all dependent scripts."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles[0]",
            "businessMeaning": "Controls the visual appearance (font, text height, scale) of the text inside the generated project settings table.",
            "validRange": "Any existing Dimension Style in the current CAD drawing",
            "unit": "Style Name",
            "affectsOutput": "Determines the size and legibility of the project table text in Model Space. Does not affect the data values themselves."
          },
          {
            "name": "nColorLine",
            "technicalDefault": "-1",
            "businessMeaning": "Sets the display color for the grid lines and border outlines of the settings table.",
            "validRange": "0-255 (AutoCAD Color Index), -1 (ByBlock/Default)",
            "unit": "ACI",
            "affectsOutput": "Changes the color of the graphical lines drawn in the 2D table representation."
          },
          {
            "name": "nColorHeader",
            "technicalDefault": "-1",
            "businessMeaning": "Sets the display color for the header text, including the Project Name and column titles (NAME, VALUE).",
            "validRange": "0-255 (AutoCAD Color Index), -1 (ByBlock/Default)",
            "unit": "ACI",
            "affectsOutput": "Changes the color of the text in the first row of the 2D table representation."
          },
          {
            "name": "nColorContent",
            "technicalDefault": "-1",
            "businessMeaning": "Sets the display color for the variable names and their corresponding values listed in the table.",
            "validRange": "0-255 (AutoCAD Color Index), -1 (ByBlock/Default)",
            "unit": "ACI",
            "affectsOutput": "Changes the color of the text in the data rows of the 2D table representation."
          },
          {
            "name": "_Pt0",
            "technicalDefault": "User Input (getPoint)",
            "businessMeaning": "The insertion point (typically top-left corner) for the project settings table in the Model Space.",
            "validRange": "Any valid 3D coordinate in Model Space",
            "unit": "Coordinate (mm)",
            "affectsOutput": "Determines the physical location of the generated 2D table."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing 'sSelectedProject'",
            "effect": "Triggers a re-fetch of variables from the BOMLink DLL, updates the internal Map, redraws the 2D table with new data, and updates the global Project MapX.",
            "cascade": [
              "_Map",
              "HSB_PROJECTSETTINGS (Global MapX)"
            ]
          },
          {
            "trigger": "Right-click Context Menu 'Update Project Settings'",
            "effect": "Forces a refresh of the variables from the BOMLink database based on the currently selected project, ensuring the CAD model is synced with external changes.",
            "cascade": [
              "_Map",
              "HSB_PROJECTSETTINGS (Global MapX)",
              "Table Geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry / Text",
            "description": "A visual table containing Project Name, Variable Names, and Values. Composed of PLine entities for the grid/border and Text entities for the content.",
            "appliedTo": "Model Space (Visualization layer)"
          },
          {
            "type": "Project Data (MapX)",
            "description": "Updates the global Project MapX storage key 'HSB_PROJECTSETTINGS' with a Map containing the specific variables retrieved from BOMLink. This data is used by other scripts to determine configuration settings.",
            "appliedTo": "Project Properties / Global Context"
          }
        ]
      },
      "tokens_used": 6364,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Load properties and call DotNet assembly to fetch list of available BOMLink projects.",
          "2. Insertion Check: Evaluate if `insertCycleCount() > 1`. If true, erase instance and stop.",
          "3. Catalog Check: Load property values from the execution key if a catalog entry was used.",
          "4. User Input: Prompt user to 'Pick a point' for the table insertion location (`_Pt0`).",
          "5. Data Fetching: Call DotNet function 'AssignVariables' using selected Project and Company path to retrieve global settings.",
          "6. Initial Storage: Save the retrieved settings map to internal `_Map` and exit insertion cycle.",
          "7. Recalc Cycle (Cleanup): Search Model Space for other instances of this script.",
          "8. Duplicate Removal: If other instances exist, delete them to ensure only one settings table exists (Singleton pattern).",
          "9. Context Check: Determine if the recalc was triggered by the 'Update Project Settings' menu or a standard update.",
          "10. [Conditional] Data Refresh: If triggered by menu, re-call DotNet function to refresh variable data.",
          "11. Error Check: Inspect internal `_Map` for 'Errors' key. If found, display message to command line.",
          "12. Geometry Calculation: Parse variable names and values from map, calculate column widths based on text length and dimension style.",
          "13. Visualization: Draw PLine grid and Text entities for the Project Name, Headers (Name/Value), and variable rows.",
          "14. Global Update: Store the final map to Project MapX under key 'HSB_PROJECTSETTINGS'."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count (`insertCycleCount() > 1`)",
            "path1": {
              "name": "Cancel Insertion",
              "steps": [
                "Erase current instance",
                "Return (Stop script)"
              ]
            },
            "path2": {
              "name": "Proceed with Insertion",
              "steps": [
                "Prompt for point",
                "Fetch variables",
                "Save and Return"
              ]
            }
          },
          {
            "condition": "Duplicate Instance Detection (`tsl.scriptName() == scriptName() && tsl.handle() != _ThisInst.handle()`)",
            "path1": {
              "name": "Cleanup Duplicates",
              "steps": [
                "Identify old instance",
                "Execute `dbErase()` on old instance"
              ]
            }
          },
          {
            "condition": "Recalc Trigger Source (`_kExecuteKey == 'Update Project Settings'`)",
            "path1": {
              "name": "Force Refresh",
              "steps": [
                "Construct input map with Company/Project",
                "Call DotNet 'AssignVariables' to get latest data",
                "Update internal `_Map`"
              ]
            },
            "path2": {
              "name": "Standard Redraw",
              "steps": [
                "Use existing internal `_Map`",
                "Skip DotNet call"
              ]
            }
          },
          {
            "condition": "DotNet Result Map Error Check (`_Map` has 'Errors' key)",
            "path1": {
              "name": "Error State",
              "steps": [
                "Extract error message string",
                "Call `reportMessage()`",
                "Continue drawing (likely empty or invalid table)"
              ]
            },
            "path2": {
              "name": "Success State",
              "steps": [
                "Parse 'Variable[]' array",
                "Populate Name/Value arrays for drawing"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "BOMLink Connection / DotNet Result",
            "errorMessage": "Value inside 'Errors' map from DotNet assembly (e.g., connection failure, invalid project).",
            "recovery": "User must fix BOMLink configuration or select a valid project via OPM, then right-click 'Update Project Settings'."
          },
          {
            "check": "Instance Uniqueness",
            "errorMessage": "None (Handled automatically by script).",
            "recovery": "Script automatically erases previous instances found in Model Space to prevent conflicts."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change BOMLink Project",
            "how": "OPM Property 'BOMLink Project' dropdown",
            "effect": "Updates the selected project string, triggers a recalc, refreshes variables from DLL, and redraws the table with new data."
          },
          {
            "action": "Update Visual Style",
            "how": "OPM Properties (Dimension style, Line color, Text colors)",
            "effect": "Triggers a recalc to redraw the table geometry with new colors, fonts, or sizes defined by the selected DimStyle."
          },
          {
            "action": "Refresh Data from Database",
            "how": "Right-click Context Menu -> 'Update Project Settings'",
            "effect": "Forces a fresh call to the DotNet DLL to ensure the local variables match the external database, overwriting current `_Map` values."
          },
          {
            "action": "Move Table",
            "how": "Grip Edit (Insertion Point)",
            "effect": "Moves `_Pt0`, shifting the entire calculated table grid and text to the new location."
          }
        ]
      },
      "tokens_used": 7536,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ProjectSettings.mcr\n\n## Overview\nThis script connects your CAD model to the external BOMLink database by allowing you to select a specific project. It generates a visual table of project variables in Model Space and stores these settings globally so other scripts can access the correct project data.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be placed in Model Space to function. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: None.\n- **Minimum Beam Count**: 0.\n- **Required Settings**:\n  - `hsbSoft.BomLink.Tsl.dll` (DotNet assembly located at your hsbCAD install path).\n  - A valid connection to the BOMLink database.\n  - Dimension Styles defined in the current drawing.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_ProjectSettings.mcr` from the list.\n\n### Step 2: Place the Table\n```\nCommand Line: Pick a point\nAction: Click anywhere in Model Space to set the insertion point (top-left corner) of the project settings table.\n```\n\n### Step 3: Configure Project (Optional)\nIf the default project is not correct:\n1. Select the inserted Project Settings entity.\n2. Open the **Properties Palette** (Ctrl+1).\n3. Locate the **BOMLink Project** property and select the desired project from the dropdown list.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| BOMLink Project | dropdown | *First available* | Selects the active project context from the BOMLink database. This determines which variables are loaded. |\n| Dimension style | dropdown | *Current Style* | Sets the text style (font, height) used for the content inside the generated table. |\n| Line color | number | -1 | Sets the color of the table grid and border lines (-1 = ByBlock). |\n| Text color: Header | number | -1 | Sets the color of the header row text (-1 = ByBlock). |\n| Text color: Content | number | -1 | Sets the color of the variable names and values (-1 = ByBlock). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Update Project Settings | Forces a refresh of the project variables from the BOMLink database. Use this if the database has changed since the script was last updated. |\n\n## Settings Files\n*None* (This script relies on the BOMLink DotNet assembly and database connection rather than local XML settings files).\n\n## Tips\n- **Single Instance**: This script operates as a singleton. If you insert a second instance into the same model, the script will automatically delete the old one to prevent conflicts.\n- **Global Access**: The data loaded by this script is stored in the Project MapX under the key `HSB_PROJECTSETTINGS`. Other scripts in your project can read this data to automate labels or reports.\n- **Visual Updates**: To change the size of the text, simply change the `Dimension style` property in the palette. The table will redraw automatically.\n\n## FAQ\n- **Q: Why is my table empty or showing an error?**\n  A: Check the AutoCAD command line for specific error messages. This usually indicates a failure to connect to the BOMLink database or an invalid project selection.\n- **Q: Can I have multiple project tables for different projects in one drawing?**\n  A: No. The script is designed to enforce a single project context per drawing to ensure data consistency. Inserting a new one removes the previous one."
      },
      "tokens_used": 5761,
      "error": null
    }
  }
}