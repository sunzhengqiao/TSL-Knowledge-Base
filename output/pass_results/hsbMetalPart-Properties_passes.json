{
  "filename": "hsbMetalPart-Properties.mcr",
  "status": "completed",
  "total_tokens": 48579,
  "processing_time": 407.3054370880127,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "2.2",
            "date": "31jan14",
            "author": "th@hsbCAD.de",
            "changes": "writes dimensions of nested entities, if an ECS Marker could be found or child entity is based on a genbeam "
          },
          {
            "version": "2.1",
            "date": "10jan14",
            "author": "th@hsbCAD.de",
            "changes": "posnums are now also assigned for entities of type beam, sheet or panel if they appear to be the parent entity, emulates the command HSB_ASSIGNPOSNUMS, metal part property set also assigned to genbeams, for genbeams the name property is copied if set for the genBeam"
          },
          {
            "version": "2.0",
            "date": "22mar12",
            "author": "th@hsbCAD.de",
            "changes": "posnums are now also assigned for entities of type beam, sheet or panel"
          },
          {
            "version": "1.9",
            "date": "08feb12",
            "author": "th@hsbCAD.de",
            "changes": "new option to calculate the total surface area of the metalpart. data will be written to property set field named 'surface'"
          },
          {
            "version": "1.8",
            "date": "31jan12",
            "author": "th@hsbCAD.de",
            "changes": "new options to keep existing posnum and part name, new numbering method, requires 17.2.6.0 or higher"
          },
          {
            "version": "1.7",
            "date": "23jan12",
            "author": "th@hsbCAD.de",
            "changes": "optional removal of posnums if execute key contains 'releasePosNum'"
          },
          {
            "version": "1.6",
            "date": "13jan12",
            "author": "th@hsbCAD.de",
            "changes": "cosmetics"
          },
          {
            "version": "1.5",
            "date": "25oct11",
            "author": "th@hsbCAD.de",
            "changes": "upgrade to new methods, requires 17.1.29.0 or higher"
          },
          {
            "version": "1.4",
            "date": "24oct11",
            "author": "th@hsbCAD.de",
            "changes": ""
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8760,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Uses _kModelSpace in 'Group().collectEntities(true,MassGroup(),_kModelSpace)'. Processes 3D entities like MassGroup and GenBeam. Calculates physical properties (volume, surface area) via 'realBody()' and 'volume()'. Erases instance immediately after execution ('eraseInstance()'), indicating a utility command rather than a drawing generator. No references to _Viewport, ShopDrawing, or paper space annotations."
        },
        "prerequisites": {
          "requiredEntities": [
            "MassGroup",
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Property set definitions (hsbMetalPart) containing fields: POSNUM, GROSVOLUME, NAME, GROSWEIGHT, SURFACE, LENGTH, WIDTH, HEIGHT"
          ]
        }
      },
      "tokens_used": 7250,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select a set of metalparts (Massgroups, Beams, Sheets)|",
              "condition": "_bOnInsert && _kExecuteKey != 'ALL' && _kExecuteKey != 'RELEASEPOSNUM'",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nParentStart",
            "type": "PropInt",
            "displayName": "|Start Number Parent|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nChildStart",
            "type": "PropInt",
            "displayName": "|Start Number Child|",
            "defaultValue": "100",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sKeepExisting",
            "type": "PropString",
            "displayName": "|Keep existing PosNum|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sAutoNames",
            "type": "PropString",
            "displayName": "|Automatic Naming|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "ALL",
            "handler": "ALL",
            "action": "Automatically selects all MassGroup entities in ModelSpace for processing.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "releasePosNum",
            "handler": "RELEASEPOSNUM",
            "action": "Prompts user to select entities and removes Position Numbers (PosNum) from them.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 7532,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the assignment of position numbers (PosNum), dimensions, and physical properties (volume, surface area) to metal parts (MassGroups, Beams, Sheets) for fabrication and BIM data management.",
          "category": "Data Management / BIM",
          "typicalUseCase": "Used after designing metal connections or assemblies to label parts for production, calculate weights for logistics, and populate property sets for BOM exports."
        },
        "parameters": [
          {
            "name": "nParentStart",
            "technicalDefault": "1",
            "businessMeaning": "The starting position number for the main or parent metal parts (e.g., the main plate of a connection assembly).",
            "validRange": "1 to 999999",
            "unit": "Integer (Count)",
            "affectsOutput": "Sets the 'POSNUM' value in the hsbMetalPart property set for primary selected entities. Determines the base identifier for the assembly list."
          },
          {
            "name": "nChildStart",
            "technicalDefault": "100",
            "businessMeaning": "The starting position number for child or subordinate parts nested within a MassGroup (e.g., bolts, stiffeners, or welded plates attached to a main plate).",
            "validRange": "1 to 999999 (typically set higher than ParentStart to avoid overlap)",
            "unit": "Integer (Count)",
            "affectsOutput": "Sets the 'POSNUM' value in the hsbMetalPart property set for nested entities. Helps distinguish sub-components in a Bill of Materials."
          },
          {
            "name": "sKeepExisting",
            "technicalDefault": "|No|",
            "businessMeaning": "Determines whether to preserve previously assigned position numbers or overwrite them with new ones.",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean (Option)",
            "affectsOutput": "If 'Yes', the script skips entities that already have a valid PosNum, retaining manual numbering. If 'No', all selected entities are renumbered based on the Start Number parameters."
          },
          {
            "name": "sAutoNames",
            "technicalDefault": "|No|",
            "businessMeaning": "Controls the automatic generation of the 'NAME' property in the property set based on the position number and hierarchy.",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean (Option)",
            "affectsOutput": "If 'Yes', names are generated (e.g., 'Part 1', 'Part 1.1') and written to the property set. It also copies the GenBeam name to the property set if the entity is a GenBeam. If 'No', the NAME field is left unchanged or empty."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sKeepExisting set to |Yes|",
            "effect": "nParentStart and nChildStart are ignored for entities that already possess a valid position number. They are only applied to unnumbered entities.",
            "cascade": [
              "nParentStart",
              "nChildStart"
            ]
          },
          {
            "trigger": "sAutoNames set to |Yes|",
            "effect": "Generates the NAME string using the calculated PosNum (derived from ParentStart/ChildStart) and child indices. If the entity is a GenBeam, the script attempts to use the GenBeam's existing name.",
            "cascade": [
              "nParentStart",
              "nChildStart"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Property Set Data (hsbMetalPart)",
            "description": "Updates non-geometric data attached to entities. Specifically calculates and writes POSNUM, GROSVOLUME, NAME, GROSWEIGHT, SURFACE, LENGTH, WIDTH, and HEIGHT.",
            "appliedTo": "MassGroup, GenBeam, Beam, Sheet, Panel, and Sip elements selected by the user."
          }
        ]
      },
      "tokens_used": 8288,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Insertion (Launch)",
          "Check Insert Cycle Count (if > 1, erase instance and exit)",
          "Determine Execution Mode based on _kExecuteKey (Normal, 'ALL', or 'RELEASEPOSNUM')",
          "Entity Selection (User Prompt or Automatic Collection)",
          "Set Execution Flags in internal Map (e.g., releasePosNum, erase)",
          "Script Returns / Re-enters for Execution Phase",
          "Separate Selected Entities into Parent MassGroups and GenBeams",
          "Process Parent Entities: Assign PosNums (Normal) or Release PosNums (Release Mode)",
          "Process GenBeams Loop:",
          "  - Assign/Release PosNum to GenBeam entity",
          "  - Detect specific type (Beam, Sheet, Sip) for Property Set handling",
          "  - Loop through available Property Sets",
          "  - Attach Property Set if missing (in Add mode)",
          "  - Check for 'POSNUM' field in Property Set",
          "  - Remove Property Set if it lacks 'POSNUM' (cleanup)",
          "  - Update Property Set Data: POSNUM, SURFACE, NAME, GROSVOLUME, dims",
          "  - Calculate Auto-Names if option enabled",
          "Process Parent MassGroups Loop (Iterate through each parent MassGroup):",
          "  - Collect Child Entities of the MassGroup",
          "  - Assign Child PosNums (Normal mode) or skip (Release mode)",
          "  - Iterate through Child Entities (MassGroup, Beam, Sheet, Sip, TslInst):",
          "    - Determine Coordinate System (ECS Marker -> GenBeam -> World)",
          "    - Calculate Dimensions (Length, Width, Height)",
          "    - Loop through available Property Sets",
          "    - Attach/Check/Remove Property Sets as with GenBeams",
          "    - Calculate Child Auto-Names (e.g., 'Part 100.1')",
          "    - Calculate Gross Volume (Volume of Additive parts)",
          "    - Write all properties to Property Set",
          "Check 'Erase' Flag",
          "Erase Script Instance from Drawing"
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Key (_kExecuteKey) check",
            "path1": {
              "name": "Key is 'ALL'",
              "steps": [
                "Skip User Prompt",
                "Automatically collect all MassGroup entities in ModelSpace",
                "Proceed to Execution Phase (Mode = Add)"
              ]
            },
            "path2": {
              "name": "Key is 'RELEASEPOSNUM'",
              "steps": [
                "Prompt user to select entities",
                "Set internal flag 'releasePosNum' to true",
                "Proceed to Execution Phase (Mode = Remove)"
              ]
            },
            "path3": {
              "name": "Normal Insertion (No Key)",
              "steps": [
                "Show Configuration Dialog (Start numbers, Auto-name options)",
                "Prompt user to select entities",
                "Proceed to Execution Phase (Mode = Add)"
              ]
            }
          },
          {
            "condition": "Property Set Compatibility Check",
            "path1": {
              "name": "Property Set has 'POSNUM' field",
              "steps": [
                "Retain Property Set on entity",
                "Update POSNUM and other fields"
              ]
            },
            "path2": {
              "name": "Property Set missing 'POSNUM' field",
              "steps": [
                "Remove Property Set from entity (if it was just attached by this script)",
                "Skip to next Property Set"
              ]
            }
          },
          {
            "condition": "Coordinate System Detection for Dimensions",
            "path1": {
              "name": "EcsMarker found inside MassGroup",
              "steps": [
                "Use EcsMarker X, Y, Z vectors for dimension calculation"
              ]
            },
            "path2": {
              "name": "EcsMarker not found, GenBeam found",
              "steps": [
                "Use GenBeam local coordinate system vectors"
              ]
            },
            "path3": {
              "name": "No EcsMarker or GenBeam",
              "steps": [
                "Use World Coordinate System (XW, YW, ZW)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Silent exit)",
            "recovery": "Script automatically erases itself if the insert cycle is greater than 1 to prevent recursive loops."
          },
          {
            "check": "Entity Selection",
            "errorMessage": "User cancels selection prompt.",
            "recovery": "Script execution halts, instance is erased. No changes made."
          },
          {
            "check": "Property Set Definition",
            "errorMessage": "None explicit in code, but implies Property Set must exist.",
            "recovery": "Script iterates through 'AvailablePropSetNames'. If a set doesn't contain the required fields (like 'POSNUM'), it removes the assignment, preventing data corruption."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify OPM Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Updating 'Start Number Parent', 'Start Number Child', or boolean flags has no effect because the script instance erases itself immediately after running. To run again with new settings, the user must re-insert the script."
          },
          {
            "action": "Right-Click Context Menu",
            "how": "Select Metal Part Entities -> Right Click",
            "effect": "Standard context menus for the entities apply. This script does not attach persistent links to the entities for re-triggering (it is a 'fire and forget' utility)."
          }
        ]
      },
      "tokens_used": 9907,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbMetalPart-Properties\n\n## Overview\nThis script automates the assignment of position numbers (PosNum), names, dimensions, and physical properties (volume, weight, surface area) to metal parts such as MassGroups, GenBeams, and Sheets. It is essential for preparing accurate Bill of Materials (BOM) data and production labels.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script processes 3D entities in the model. |\n| Paper Space | No | Not designed for layout space. |\n| Shop Drawing | No | Not intended for drawing annotations. |\n\n## Prerequisites\n- **Required Entities**: MassGroups, GenBeams, Beams, Sheets, or Panels present in the model.\n- **Property Set Definition**: The drawing catalog must contain a Property Set Definition (e.g., `hsbMetalPart`) with the following fields: `POSNUM`, `GROSVOLUME`, `NAME`, `GROSWEIGHT`, `SURFACE`, `LENGTH`, `WIDTH`, `HEIGHT`.\n- **Minimum Count**: At least one valid entity must be selected.\n\n## Usage Steps\n\n### Step 1: Launch Script\nExecute the command `TSLINSERT` and select `hsbMetalPart-Properties.mcr` from the list.\n\n### Step 2: Configure Options (Optional)\nImmediately after insertion, you can change the numbering settings in the **Properties Palette** (Ctrl+1) before proceeding to the next step.\n- Adjust **Start Number Parent** or **Start Number Child** if needed.\n- Toggle **Keep existing PosNum** to `Yes` if you want to preserve manual numbering.\n\n### Step 3: Select Entities\n```\nCommand Line: Select a set of metalparts (Massgroups, Beams, Sheets)\nAction: Click on the desired entities in the model or drag a selection window. Press Enter to confirm.\n```\n*(Note: The script instance will automatically disappear from the drawing after processing is complete.)*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Start Number Parent | number | 1 | The starting position number for the main or parent metal parts (e.g., the main plate of a connection). |\n| Start Number Child | number | 100 | The starting position number for nested parts (e.g., bolts or stiffeners inside a MassGroup). |\n| Keep existing PosNum | dropdown | No | If set to `Yes`, the script will skip entities that already have a position number. If `No`, all selected entities will be renumbered. |\n| Automatic Naming | dropdown | No | If set to `Yes`, automatically generates the `NAME` property (e.g., \"Part 1\", \"Part 100.1\") based on the position number. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| ALL | Automatically selects all MassGroup entities in the entire Model Space for processing. |\n| releasePosNum | Prompts you to select entities and removes their existing Position Numbers (PosNum). |\n\n## Settings Files\n- **None**: This script does not rely on external XML settings files. It relies on the standard hsbCAD Property Set Definitions configured in your project or catalog.\n\n## Tips\n- **Renumbering Strategy**: Use the **Keep existing PosNum** option set to `Yes` when you have manually numbered critical parts but want to auto-number the rest of the assembly.\n- **Cleaning Data**: Use the **releasePosNum** right-click option to strip all numbering from a selection before running a completely new numbering sequence.\n- **Dimensions Calculation**: The script automatically detects the correct orientation (using ECS Markers or local beams) to calculate accurate Length, Width, and Height for nested parts.\n- **GenBeam Names**: If **Automatic Naming** is enabled and the entity is a GenBeam, the script attempts to copy the GenBeam's name to the property set.\n\n## FAQ\n- **Q: Why did the script icon disappear immediately?**\n  - A: This is a \"utility\" script. It runs once to update the data and then automatically erases itself from the drawing to keep your model clean.\n- **Q: The properties were not updated. What went wrong?**\n  - A: Check if the correct Property Set Definition is attached to the entities and contains the required fields (specifically `POSNUM`). The script removes property sets that do not contain the required fields.\n- **Q: Can I number beams and panels with this script?**\n  - A: Yes, the script supports numbering for Beams, Sheets, and Panels if they are identified as parent entities."
      },
      "tokens_used": 6842,
      "error": null
    }
  }
}