{
  "filename": "hsb_DrawFoundationLine.mcr",
  "status": "completed",
  "total_tokens": 44406,
  "processing_time": 280.8209629058838,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8087,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to interactively select ElementWall entities and processes their geometry (plOutlineWall, PlaneProfile) to generate foundation lines. It uses the Display class for drawing and lacks #Type E, sd_ functions, _Viewport checks, or Multipage logic characteristic of ShopDrawing or Paper Space scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing ElementWall entities.",
          "requiredSettings": []
        }
      },
      "tokens_used": 5583,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Please select Walls",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialogOnce",
            "trigger": "During script insertion if _kExecuteKey is empty",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDispRep",
            "type": "PropString",
            "displayName": "Show in Disp Rep",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sLineType",
            "type": "PropString",
            "displayName": "Line Type",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_LineTypes",
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dim style",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color Foundation Lines",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "psExtType",
            "type": "PropString",
            "displayName": "Code External Walls",
            "defaultValue": "A;B;",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Please type the codes of the external walls separate by ; "
          },
          {
            "index": 0,
            "variable": "dOffsetFrontExt",
            "type": "PropDouble",
            "displayName": "Offset Front External Walls",
            "defaultValue": 300,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dOffsetBackExt",
            "type": "PropDouble",
            "displayName": "Offset Back External Walls",
            "defaultValue": 250,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "psIntType",
            "type": "PropString",
            "displayName": "Code Internal Walls",
            "defaultValue": "D;E;",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Please type the codes of the internal walls separate by ; "
          },
          {
            "index": 2,
            "variable": "dOffsetFrontInt",
            "type": "PropDouble",
            "displayName": "Offset Front Internal Walls",
            "defaultValue": 300,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dOffsetBackInt",
            "type": "PropDouble",
            "displayName": "Offset Back Internal Walls",
            "defaultValue": 250,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dOffsetFrontParty",
            "type": "PropDouble",
            "displayName": "Offset Front Party Walls",
            "defaultValue": 300,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "dOffsetBackParty",
            "type": "PropDouble",
            "displayName": "Offset Back Party Walls",
            "defaultValue": 250,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6735,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the generation of 2D foundation lines from selected wall geometry, applying different offsets and styles based on wall types (external, internal, party walls).",
          "category": "Drafting/Annotation",
          "typicalUseCase": "Used during the design phase to quickly create concrete layout lines or footing outlines based on the timber wall model, often for site plans or foundation engineering drawings."
        },
        "parameters": [
          {
            "name": "sDispRep",
            "technicalDefault": "",
            "businessMeaning": "Controls which model display representation the generated foundation lines will be visible in (e.g., 'Presentation', 'Drafting').",
            "validRange": "Any valid Display Rep name in the drawing.",
            "unit": "string",
            "affectsOutput": "Visibility of the generated lines in different CAD view modes."
          },
          {
            "name": "sLineType",
            "technicalDefault": "_LineTypes",
            "businessMeaning": "Sets the CAD line style (e.g., continuous, dashed, hidden) used to draw the foundation outlines.",
            "validRange": "Available LineTypes in the drawing template.",
            "unit": "enum",
            "affectsOutput": "Visual appearance (dash/dot pattern) of the foundation lines."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Assigns a specific dimension style to the geometry, potentially used for automatic dimensioning or scaling properties.",
            "validRange": "Available DimStyles in the drawing template.",
            "unit": "enum",
            "affectsOutput": "Dimensioning standards applied if dimensions are generated or referenced."
          },
          {
            "name": "nColor",
            "technicalDefault": 3,
            "businessMeaning": "Sets the CAD color index for the foundation lines to distinguish them from other model elements.",
            "validRange": "1-255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Visual color of the drawn lines."
          },
          {
            "name": "psExtType",
            "technicalDefault": "A;B;",
            "businessMeaning": "Identifies which wall 'Codes' constitute 'External' walls to apply specific foundation offsets. Uses ';' as a separator.",
            "validRange": "String of wall codes (e.g., 'EXT;OUT;').",
            "unit": "string",
            "affectsOutput": "Determines which walls are categorized as External and thus receive the 'External' offset values."
          },
          {
            "name": "dOffsetFrontExt",
            "technicalDefault": 300,
            "businessMeaning": "The distance to offset the foundation line from the 'Front' face of External walls.",
            "validRange": "0 - 2000 (Depending on footing width)",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge relative to the wall exterior."
          },
          {
            "name": "dOffsetBackExt",
            "technicalDefault": 250,
            "businessMeaning": "The distance to offset the foundation line from the 'Back' face of External walls.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge relative to the wall interior."
          },
          {
            "name": "psIntType",
            "technicalDefault": "D;E;",
            "businessMeaning": "Identifies which wall 'Codes' constitute 'Internal' (load-bearing) walls.",
            "validRange": "String of wall codes (e.g., 'INT;PART;').",
            "unit": "string",
            "affectsOutput": "Determines which walls are categorized as Internal."
          },
          {
            "name": "dOffsetFrontInt",
            "technicalDefault": 300,
            "businessMeaning": "The distance to offset the foundation line from the 'Front' face of Internal walls.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge for internal walls."
          },
          {
            "name": "dOffsetBackInt",
            "technicalDefault": 250,
            "businessMeaning": "The distance to offset the foundation line from the 'Back' face of Internal walls.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge for internal walls."
          },
          {
            "name": "dOffsetFrontParty",
            "technicalDefault": 300,
            "businessMeaning": "The distance to offset the foundation line from the 'Front' face of Party walls (walls not matching External or Internal codes).",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge for party walls."
          },
          {
            "name": "dOffsetBackParty",
            "technicalDefault": 250,
            "businessMeaning": "The distance to offset the foundation line from the 'Back' face of Party walls.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Position of the foundation line edge for party walls."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "psExtType or psIntType content",
            "effect": "Classifies the selected walls into External, Internal, or Party groups.",
            "cascade": [
              "dOffsetFrontExt",
              "dOffsetBackExt",
              "dOffsetFrontInt",
              "dOffsetBackInt",
              "dOffsetFrontParty",
              "dOffsetBackParty"
            ]
          },
          {
            "trigger": "dOffset... values",
            "effect": "Calculates the specific grip point movements for the generated PlaneProfile outlines.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Graphical Representation (PLine/PlaneProfile)",
            "description": "2D lines representing the foundation footprint, created by offsetting the selected wall outlines.",
            "appliedTo": "Model Space (non-associative graphics derived from ElementWall entities)"
          }
        ]
      },
      "tokens_used": 8004,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Catalog loads properties if database created; parses wall type codes (External/Internal) from property strings into string arrays.",
          "2. Insertion Cycle Check: If 'insertCycleCount > 1', script erases itself and stops. (Prevents multiple executions on single drag-drop).",
          "3. OPM Properties: If _kExecuteKey is empty, OPM Properties dialog is forced to display once.",
          "4. Entity Selection: User is prompted to select ElementWall entities via 'PrEntity'.",
          "5. Validation: If selection is successful (user didn't cancel), selected entities are appended to the script's internal element list. Script execution halts (returns) to wait for next event or calculation.",
          "6. Calculation Phase (Post-Selection/Recalc): Script segregates valid ElementWalls into External, Internal, or Party arrays based on their 'Code' matching the parsed code arrays.",
          "7. Geometry Unification: Outline polylines (plOutlineWall) are extracted for each group, shrunk by 15mm, and unified into temporary PlaneProfiles (ppExternalTemp, ppInternalTemp, ppPartyTemp) to merge overlapping wall outlines.",
          "8. Profile Smoothing: Temporary profiles are further shrunk (Internal/Party by 5mm). The script then iterates through all rings, filtering out collinear vertices (angle check < 0.99 dot product) to clean up the geometry before rebuilding final PlaneProfiles.",
          "9. Offset Calculation (External Walls): For every External wall, script calculates the projected 'Front' and 'Back' edge points. It finds the nearest edge midpoint on the unified foundation profile and moves that grip point outward by the defined 'dOffsetFrontExt' and 'dOffsetBackExt' distances.",
          "10. Offset Calculation (Internal Walls): Similar to External, script finds nearest edge midpoints on the Internal unified profile and moves them by 'dOffsetFrontInt' and 'dOffsetBackInt'.",
          "11. Drawing: The final PlaneProfiles (ppExternal, ppInternal) are drawn using the Display settings (Color, LineType, DimStyle, DispRep) defined in the properties."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Proceed to OPM/Selection"
              ]
            }
          },
          {
            "condition": "Execute Key (_kExecuteKey)",
            "path1": {
              "name": "Key is Empty",
              "steps": [
                "Show OPM Dialog (ShowDialogOnce)"
              ]
            },
            "path2": {
              "name": "Key has Value",
              "steps": [
                "Skip OPM Dialog"
              ]
            }
          },
          {
            "condition": "Entity Selection (PrEntity.go())",
            "path1": {
              "name": "Selection Successful",
              "steps": [
                "Append Elements to _Element",
                "Exit Insert Phase (Return)"
              ]
            },
            "path2": {
              "name": "Selection Cancelled",
              "steps": [
                "Script pauses/terminates without geometry"
              ]
            }
          },
          {
            "condition": "Wall Code Classification",
            "path1": {
              "name": "Code found in External List",
              "steps": [
                "Append to elExternal",
                "Union to ppExternalTemp",
                "Apply External Offsets"
              ]
            },
            "path2": {
              "name": "Code found in Internal List",
              "steps": [
                "Append to elInternal",
                "Union to ppInternalTemp",
                "Apply Internal Offsets"
              ]
            },
            "path3": {
              "name": "Code not found in either",
              "steps": [
                "Append to elParty",
                "Union to ppPartyTemp",
                "No specific offset logic applied (Profile just drawn)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selected Entity Type",
            "errorMessage": "None explicit in script, but PrEntity filter restricts selection to ElementWall.",
            "recovery": "User must select valid walls."
          },
          {
            "check": "Polygon Vertex Count",
            "errorMessage": "None explicit (Code checks 'arPtAll.length() > 2').",
            "recovery": "Script silently ignores walls with fewer than 3 vertices."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Offset Distances",
            "how": "OPM Properties (dOffsetFrontExt, dOffsetBackInt, etc.)",
            "effect": "Re-running the script updates the grip point positions of the foundation profiles."
          },
          {
            "action": "Change Wall Codes/Types",
            "how": "Editing 'psExtType' or 'psIntType' properties, or changing the actual ElementWall code in the model.",
            "effect": "Walls are reclassified into different groups (External/Internal/Party), causing them to be drawn in different profiles with different offsets."
          },
          {
            "action": "Modify Visual Style",
            "how": "OPM Properties (nColor, sLineType, sDimStyle, sDispRep)",
            "effect": "Updates the color, linetype, dimension style, or display representation visibility of the drawn lines immediately."
          },
          {
            "action": "Regenerate Geometry",
            "how": "Selecting the script entity and choosing 'Recalculate' or moving it.",
            "effect": "Re-runs the selection logic (if dynamic) and offset calculations based on current wall positions."
          }
        ]
      },
      "tokens_used": 9067,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_DrawFoundationLine.mcr\n\n## Overview\nThis script automates the creation of 2D foundation lines by deriving geometry from your selected wall elements. It applies specific offset distances to External, Internal, and Party walls based on their assigned codes, helping you quickly generate concrete or footing layouts.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script is designed for use in the 3D model. |\n| Paper Space | No | Not supported for layout generation. |\n| Shop Drawing | No | Not supported for manufacturing drawings. |\n\n## Prerequisites\n- **Required entities**: `ElementWall` entities must exist in the model.\n- **Minimum beam count**: 0 (This script operates on walls).\n- **Required settings**: None specific, though standard hsbCAD wall properties are used for classification.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Browse to and select `hsb_DrawFoundationLine.mcr`\n\n### Step 2: Configure Properties (Initial Run)\n```\nAction: The Properties Palette will automatically open upon insertion.\nAction: Configure Wall Codes and Offsets before selecting walls (see Properties Panel below).\n```\n\n### Step 3: Select Walls\n```\nCommand Line: Please select Walls\nAction: Click on individual walls or use a window selection to choose the walls you want to generate foundation lines for.\nAction: Press Enter to confirm selection.\n```\n*Once selected, the script will process the geometry and draw the foundation lines.*\n\n## Properties Panel Parameters\n\n### General Settings\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Show in Disp Rep | text | \"\" | The display representation name (e.g., 'Presentation') where these lines will be visible. |\n| Line Type | dropdown | _LineTypes | The CAD line style (e.g., Continuous, Dashed) to use for the foundation lines. |\n| Dim style | dropdown | _DimStyles | The dimension style to assign to the foundation lines. |\n| Color Foundation Lines | number | 3 | The CAD color index (1-255) for the drawn lines. |\n\n### External Walls\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Code External Walls | text | \"A;B;\" | The wall codes (separated by `;`) that define an External wall. |\n| Offset Front External Walls | number | 300 | The offset distance (mm) from the Front face of external walls. |\n| Offset Back External Walls | number | 250 | The offset distance (mm) from the Back face of external walls. |\n\n### Internal Walls\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Code Internal Walls | text | \"D;E;\" | The wall codes (separated by `;`) that define an Internal wall. |\n| Offset Front Internal Walls | number | 300 | The offset distance (mm) from the Front face of internal walls. |\n| Offset Back Internal Walls | number | 250 | The offset distance (mm) from the Back face of internal walls. |\n\n### Party Walls (Other)\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Offset Front Party Walls | number | 300 | The offset distance (mm) from the Front face of walls that do not match the External or Internal codes. |\n| Offset Back Party Walls | number | 250 | The offset distance (mm) from the Back face of walls that do not match the External or Internal codes. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | This script does not add specific items to the right-click context menu. Use the standard Properties palette to modify parameters. |\n\n## Settings Files\n- **None**: This script does not require external settings files.\n\n## Tips\n- **Code Separators**: Always use a semicolon `;` to separate multiple wall codes (e.g., `A;B;EXT;`).\n- **Classification**: Any wall code *not* listed in the External or Internal lists will be treated as a \"Party Wall\" and use the Party offset settings.\n- **Updating Geometry**: If you move your walls after drawing the foundation lines, select the script entity and choose **Recalculate** (or use the `TSLUPDATE` command) to update the foundation positions.\n- **Visibility**: If the lines disappear, check the **Show in Disp Rep** property to ensure it matches your current view mode (e.g., if you are in \"Drafting\" mode, the property must be set to \"Drafting\").\n\n## FAQ\n- **Q: My foundation lines are not drawing where I expect.**\n  A: Check that the Wall Codes in your ElementWall properties match exactly with the **Code External Walls** or **Code Internal Walls** fields in the script properties (including semicolons).\n- **Q: How do I change the width of the foundation line?**\n  A: The total width is calculated by the sum of the Front and Back offsets. Adjust **Offset Front** and **Offset Back** values in the Properties panel.\n- **Q: What defines the \"Front\" vs \"Back\" of a wall?**\n  A: This is determined by the wall's local coordinate system/creation direction in hsbCAD. If offsets appear reversed, try swapping the Front and Back values."
      },
      "tokens_used": 6930,
      "error": null
    }
  }
}