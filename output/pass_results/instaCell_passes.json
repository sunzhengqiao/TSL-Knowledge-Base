{
  "filename": "instaCell.mcr",
  "status": "completed",
  "total_tokens": 46935,
  "processing_time": 328.1885461807251,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8952,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly creates entities and collects instances in '_kModelSpace' (e.g., `tslDialog.dbCreate(..., _kModelSpace, ...)` and `Group().collectEntities(true, TslInst(), _kModelSpace)`). It manages block definitions in DWG files stored on disk. There are no references to ShopDrawing prefixes (sd_), Multipage constructs, or Viewport handling associated with Paper Space."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst",
            "Element (optional - supported if type is stickframe wall or roof)",
            "GenBeam (optional - implied by 'loose genbeams' bugfix)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "instaCombination.xml (optional, looks in Company or Install path)",
            "Block definitions from 'hsbCompany\\Block\\insta' or custom BlockPath"
          ]
        }
      },
      "tokens_used": 5454,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowNotice",
            "trigger": "During script insertion (_bOnDbCreated) if settings version mismatch is detected.",
            "title": null,
            "dataSource": "Internal comparison between 'mapSetting' version and 'mapSettingInstall' version.",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowDialog",
            "trigger": "When '_kExecuteKey' matches '|Set block definition|' (DialogMode == 1) during the block creation process.",
            "title": null,
            "dataSource": "Internal mapTsl containing Blockname, Category, and Sub Category properties.",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowNotice",
            "trigger": "When '_kExecuteKey' matches '|Show all Commands for UI Creation|'.",
            "title": null,
            "dataSource": "Hardcoded string listing command lines for UI creation.",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowNotice",
            "trigger": "When '_kExecuteKey' matches '|Set block definition|' and block.writeToDwg returns an error code.",
            "title": null,
            "dataSource": "Error code returned by block.writeToDwg.",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDefinition",
            "type": "PropString",
            "displayName": "|Blockname|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the name of the block|"
          },
          {
            "index": 1,
            "variable": "sCategory",
            "type": "PropString",
            "displayName": "|Category|",
            "defaultValue": "|Electra|",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the category, which will contribute to the ordering of the entries.|"
          },
          {
            "index": 2,
            "variable": "sSubCategory",
            "type": "PropString",
            "displayName": "|Sub Category|",
            "defaultValue": "|Switches|",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the sub category, which will contribute to the ordering of the entries.|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Hide Tools|",
            "handler": "|Hide Tools|",
            "action": "Hides potential CNC tools (drill, mortise, beamcut).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Show Tools|",
            "handler": "|Show Tools|",
            "action": "Shows potential CNC tools (drill, mortise, beamcut).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Swap Width <-> Height|",
            "handler": "|Swap Width <-> Height|",
            "action": "Swaps the width and height dimensions (specific to mortise or beamcut tools).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Set block definition|",
            "handler": "|Set block definition|",
            "action": "Opens a dialog to define the block name, category, and sub-category, and saves the block to a DWG file.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Store hardware in block definition|",
            "handler": "|Store hardware in block definition|",
            "action": "Clones hardware from the current instance and stores it into the block definition.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Show all Commands for UI Creation|",
            "handler": "|Show all Commands for UI Creation|",
            "action": "Displays a list of command strings available for creating tool buttons.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "instaCombination.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings",
              "_kPathHsbInstall\\Content\\General\\TSL\\Settings\\"
            ],
            "purpose": "Configuration file for script settings including display styles, block paths, and version control.",
            "required": true
          }
        ]
      },
      "tokens_used": 7731,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts and manages installation 'cells' (e.g., electrical boxes, service penetrations) that combine visual representations (blocks) with physical CNC machining (drilling/mortising) and hardware.",
          "category": "Installation / MEP / Milling",
          "typicalUseCase": "Placing an electrical switch or socket box into a timber wall panel or beam, requiring both a visual symbol and a corresponding hole or recess."
        },
        "parameters": [
          {
            "name": "sDefinition",
            "technicalDefault": "",
            "businessMeaning": "The specific identifier name of the block definition (DWG file) representing this installation item. It acts as the part number or catalog code.",
            "validRange": "Any valid filename string (typically alphanumeric without special characters)",
            "unit": "String",
            "affectsOutput": "Determines which specific block geometry is loaded and displayed for the instance, and which associated machining tools (drill/cut) are applied."
          },
          {
            "name": "sCategory",
            "technicalDefault": "|Electra|",
            "businessMeaning": "The primary classification group used to organize block definitions into folders (e.g., Electrical, Plumbing, HVAC).",
            "validRange": "Any valid folder name string",
            "unit": "String",
            "affectsOutput": "Determines the root directory path where the block definition is stored or retrieved from."
          },
          {
            "name": "sSubCategory",
            "technicalDefault": "|Switches|",
            "businessMeaning": "The secondary classification group used for finer organization within a category (e.g., Switches, Sockets, Lights).",
            "validRange": "Any valid folder name string",
            "unit": "String",
            "affectsOutput": "Determines the sub-directory path where the block definition is stored or retrieved from."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Saving a block definition via the 'Set block definition' context menu command.",
            "effect": "The script constructs the file path for saving the DWG block by concatenating the base BlockPath, Category, SubCategory, and Blockname.",
            "cascade": [
              "sCategory",
              "sSubCategory",
              "sDefinition"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInst",
            "description": "The script instance itself that maintains the logic and properties of the installation cell.",
            "appliedTo": "Model Space (referencing a Host Element/Beam)"
          },
          {
            "type": "Block",
            "description": "Visual 2D/3D representation (DWG block) of the installation item.",
            "appliedTo": "Model Space"
          },
          {
            "type": "Drill/Mortise/BeamCut",
            "description": "CNC machining operations (holes, slots, cuts) required to fit the installation item into the timber.",
            "appliedTo": "Host GenBeam or Element"
          },
          {
            "type": "Hardware",
            "description": "Connectors or fasteners associated with the installation cell (e.g., mounting screws).",
            "appliedTo": "Host GenBeam or Element"
          }
        ]
      },
      "tokens_used": 9125,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization and Constants Definition",
          "2. Check for DialogMode triggered by context menu command '|Set block definition|' (nDialogMode == 1)",
          "3. Load Settings (instaCombination.xml) from Company path or Install path",
          "4. Validate Settings Version against installation default (only on _bOnDbCreated)",
          "5. Read User Properties (sDefinition, sCategory, sSubCategory) from OPM",
          "6. Determine Host Entity (Element or GenBeam) based on selection or existing link",
          "7. Calculate Coordinates and Transformations based on insertion point and host geometry",
          "8. Load or Generate Block Definition (DWG) based on sDefinition property",
          "9. Execute '_kExecuteKey' checks for Context Menu commands (e.g., '|Hide Tools|', '|Swap Width <-> Height|')",
          "10. Generate CNC Tools (Drill, Mortise, BeamCut) based on block data and settings",
          "11. Attach Hardware (if stored in block or instance)",
          "12. Generate Visual Representation (Block instance in Model Space)",
          "13. Apply Display Rules (Color, Layer, Scaling) based on Plan vs. Element view"
        ],
        "conditionalBranches": [
          {
            "condition": "Check '_kExecuteKey' for '|Set block definition|' command",
            "path1": {
              "name": "Define New Block Workflow",
              "steps": [
                "Enter DialogMode 1",
                "Show Dialog prompting for Blockname, Category, and Sub Category",
                "Validate folder structure in 'hsbCompany\\Block\\insta'",
                "Create folders for Category/Sub Category if missing",
                "Clone hardware from current instance to block definition (set as TSL driven)",
                "Write Block entity to DWG file at constructed path",
                "Update all existing instances in Model Space referencing this block",
                "Recalculate script (setExecutionLoops(2))"
              ]
            },
            "path2": {
              "name": "Standard Insert/Update Workflow",
              "steps": [
                "Skip DialogMode",
                "Process standard properties and host element geometry",
                "Generate visualization and tooling"
              ]
            }
          },
          {
            "condition": "Validation of Settings Version on Instance Creation",
            "path1": {
              "name": "Version Match",
              "steps": [
                "Proceed silently without notice",
                "Use existing settings"
              ]
            },
            "path2": {
              "name": "Version Mismatch",
              "steps": [
                "Trigger ShowNotice dialog",
                "Display current version vs. install version file path",
                "User acknowledges difference"
              ]
            }
          },
          {
            "condition": "Host Element Type Selection",
            "path1": {
              "name": "GenBeam Host",
              "steps": [
                "Collect single or multiple GenBeams",
                "Apply tools directly to beam coordinate system"
              ]
            },
            "path2": {
              "name": "Element Host (Stickframe Wall or Roof)",
              "steps": [
                "Verify Element type is stickframe wall or roof",
                "Apply tools to the Element"
              ]
            },
            "path3": {
              "name": "No Host (Standalone/Loose)",
              "steps": [
                "Insert cell at World coordinates",
                "Create block visual but no machining tools"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Block definition write to DWG operation",
            "errorMessage": "|Error code| A: <errCode>",
            "recovery": "Check file write permissions or disk space. Ensure the folder path is valid and accessible."
          },
          {
            "check": "Settings file existence (instaCombination.xml)",
            "errorMessage": "Implied failure if not found in Company or Install path",
            "recovery": "Ensure instaCombination.xml exists in '_kPathHsbCompany\\TSL\\Settings' or '_kPathHsbInstall\\Content\\General\\TSL\\Settings'."
          },
          {
            "check": "Folder structure for Block Definitions",
            "errorMessage": "None explicit (script creates folders automatically using makeFolder)",
            "recovery": "Script automatically recovers by creating missing 'insta', Category, and SubCategory folders."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Block Definition",
            "how": "OPM Property 'Blockname' or Context Menu '|Set block definition|'",
            "effect": "Updates the visual geometry and associated machining tools to the new block type. If using context menu, prompts for details and writes to file."
          },
          {
            "action": "Toggle CNC Tools Visibility",
            "how": "Context Menu '|Hide Tools|' or '|Show Tools|'",
            "effect": "Toggles the display of generated drill, mortise, and beamcut tools without deleting the logic."
          },
          {
            "action": "Swap Tool Dimensions",
            "how": "Context Menu '|Swap Width <-> Height|'",
            "effect": "Swaps width and height parameters for mortise or beamcut tools."
          },
          {
            "action": "Store Hardware",
            "how": "Context Menu '|Store hardware in block definition|'",
            "effect": "Clones hardware components from the specific instance into the global block definition DWG, making them standard for all cells of that type."
          },
          {
            "action": "Get UI Commands",
            "how": "Context Menu '|Show all Commands for UI Creation|'",
            "effect": "Displays a dialog with LISP command strings for creating custom toolbuttons or ribbon commands."
          }
        ]
      },
      "tokens_used": 9466,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# instaCell.mcr\n\n## Overview\nInserts and manages installation \"cells\" (e.g., electrical boxes, switches, service penetrations) that combine visual block representations with physical CNC machining operations (drilling, mortising, cutting).\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Primary environment for inserting cells and generating machining. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: A host `Element` (Stickframe Wall or Roof) or `GenBeam` is optional but recommended for machining. If no host is selected, the cell acts as a standalone block.\n- **Settings Files**: `instaCombination.xml` (Located in Company or Install path).\n- **Block Library**: Access to the folder `hsbCompany\\Block\\insta` (or custom path defined in settings) to read/write block definitions.\n\n## Usage Steps\n\n### Step 1: Launch Script\n```\nCommand Line: TSLINSERT\nAction: Select 'instaCell.mcr' from the list of available scripts.\n```\n\n### Step 2: Define Placement\n```\nCommand Line: Select Element or [Pick Point]:\nAction: Click on a timber beam or wall element to host the cell, or press Enter to place it in free space (Model Space only).\n```\n\n### Step 3: Configure Properties\n```\nAction: Select the inserted instance and open the Properties (OPM) palette.\nDetails: Enter the Blockname, Category, and Sub Category to load the correct visual block and machining tools.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Blockname | String | Empty | The specific name of the block definition (DWG file) to use (e.g., \"Socket_1G\"). |\n| Category | String | Electra | The main group for organizing blocks (e.g., \"Electra\", \"Plumbing\"). Used for folder structure. |\n| Sub Category | String | Switches | The subgroup for organizing blocks (e.g., \"Switches\", \"Lights\"). Used for sub-folder structure. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Hide Tools | Hides all CNC tools (drills, mortises, cuts) in the model view. |\n| Show Tools | Displays all CNC tools associated with the cell. |\n| Swap Width <-> Height | Swaps the width and height dimensions for mortise or beamcut tools. |\n| Set block definition | Opens a dialog to define or update the current block, saving it to the DWG library. |\n| Store hardware in block definition | Clones hardware from this specific instance and saves it into the block definition, making it standard for all instances of this block. |\n| Show all Commands for UI Creation | Displays a list of command strings used to create custom tool buttons for this script. |\n\n## Settings Files\n- **Filename**: `instaCombination.xml`\n- **Location**: `_kPathHsbCompany\\TSL\\Settings` or `_kPathHsbInstall\\Content\\General\\TSL\\Settings\\`\n- **Purpose**: Controls script settings including display styles, block file paths, and version management.\n\n## Tips\n- **Folder Management**: When using the \"Set block definition\" command, the script automatically creates the Category and Sub Category folders in your block library if they do not exist.\n- **Visualizing Machining**: Use the \"Show Tools\" context menu option to verify that the correct holes or cuts are generated in the host timber.\n- **Batch Updates**: If you modify a block definition using the context menu, all existing instances in the model referencing that block name can be updated.\n- **Creating UI**: Use \"Show all Commands for UI Creation\" to get the specific strings needed to add buttons to your toolbars or ribbon for quick insertion of specific cells.\n\n## FAQ\n- **Q: Why did I get a notice about version mismatch when inserting?**\n  **A:** The script detected that the version of `instaCombination.xml` in your Company folder differs from the default installation version. Review the settings to ensure compatibility.\n- **Q: Can I use this without a beam?**\n  **A:** Yes, you can pick a point in free space to insert the visual block, but no machining tools will be generated without a host beam or element.\n- **Q: How do I add standard screws to this electrical box?**\n  **A:** Insert the screws as hardware on the instance, then right-click and select \"Store hardware in block definition\" to save them as part of the block for future use."
      },
      "tokens_used": 6207,
      "error": null
    }
  }
}