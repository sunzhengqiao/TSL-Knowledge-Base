{
  "filename": "ObjectNester.mcr",
  "status": "completed",
  "total_tokens": 52967,
  "processing_time": 400.8950226306915,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 6,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates a nesting of ObjectClones, requires TSL ObjectClone",
        "versionHistory": [
          {
            "version": "1.6",
            "date": "30.10.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22194 new settings for minimal range, new display of minimal range"
          },
          {
            "version": "1.5",
            "date": "18/09/2023",
            "author": "Anno Sportel",
            "changes": "HSB-20086 Adjust transformation when alignment changes."
          },
          {
            "version": "1.4",
            "date": "01.08.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 objectNester enhanced to accept uniform visible height and uniform width per row, supports grip based dragging"
          },
          {
            "version": "1.3",
            "date": "24.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 Polyline dependency removed, new grips to modify size, only one unique height per nesting"
          },
          {
            "version": "1.2",
            "date": "07.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 parent/child grouping fixed"
          },
          {
            "version": "1.1",
            "date": "05.07.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 supports parent/child grouping"
          },
          {
            "version": "1.0",
            "date": "22.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18900 initial version of ObjectNester"
          }
        ],
        "settingsFiles": [
          "ObjectClone.xml"
        ],
        "dependencies": [
          "ObjectClone"
        ]
      },
      "tokens_used": 8492,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `_kModelSpace` in entity collection (`Group().collectEntities(true, TslInst(), _kModelSpace);`) and instance creation (`tslDialog.dbCreate(..., _kModelSpace, ...);`). There are no references to `_kPaperSpace`, `_Viewport`, `sd_*` prefixes, or `#Type E` structures."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing TslInst entities (specifically 'ObjectClone' instances).",
          "requiredSettings": [
            "ObjectClone.xml"
          ]
        }
      },
      "tokens_used": 6091,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getString\",\n        \"promptOriginal\": \"T(\\\"|Are you sure to overwrite existing settings?|\\\") + \\\" [\\\" + T(\\\"|No|\\\") +\\\"/\\\"+T(\\\"|Yes|\\\")+\\\"]\\\"\",\n        \"condition\": \"_bOnRecalc && _kExecuteKey == T(\\\"|Export Settings|\\\") && findFile(sFullPath).length()>0\",\n        \"required\": false\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"PropertySheet\",\n      \"trigger\": \"Right-click menu: '|Settings|'\",\n      \"title\": \"ObjectNester\",\n      \"dataSource\": \"Temporary TSL Instance (DialogMode=1)\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dXRange\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"T(\\\"|Min X-Range|\\\")\",\n      \"defaultValue\": \"U(0)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"T(\\\"|Nester Range|\\\")\",\n      \"description\": \"T(\\\"|Defines the required X-Range of the nester.| \\\")\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dYRange\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"T(\\\"|Min Y-Range|\\\")\",\n      \"defaultValue\": \"U(0)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"T(\\\"|Nester Range|\\\")\",\n      \"description\": \"T(\\\"|Defines the required Y-Range of the nester.| \\\")\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"T(\\\"|Color|\\\")\",\n      \"defaultValue\": 150,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"T(\\\"|Nester Range|\\\")\",\n      \"description\": \"T(\\\"|Defines the color of the min range|\\\")\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"nTransparency\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"T(\\\"|Transparency|\\\")\",\n      \"defaultValue\": 150,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"T(\\\"|Nester Range|\\\")\",\n      \"description\": \"T(\\\"|Defines the transparency of the required min range|\\\")\"\n    }\n  ],\n  \"contextMenu\": [\n    {\n      \"menuItem\": \"T(\\\"|Settings|\\\")\",\n      \"handler\": \"_kExecuteKey == T(\\\"|Settings|\\\")\",\n      \"action\": \"Opens a dialog to set X-Range, Y-Range, Color, and Transparency for the nester visualization.\",\n      \"alsoTriggeredBy\": null\n    },\n    {\n      \"menuItem\": \"T(\\\"|Import Settings|\\\")\",\n      \"handler\": \"_kExecuteKey == T(\\\"|Import Settings|\\\")\",\n      \"action\": \"Reads settings from ObjectClone.xml file"
      },
      "tokens_used": 10402,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically arranges and groups multiple ObjectClone instances (timber parts or assemblies) into a nested layout, ensuring they fit within specific physical dimensions for transport or packaging.",
          "category": "Production / Logistics",
          "typicalUseCase": "Used to batch wall panels, floor cassettes, or component sets into a single bundle or crate that meets truck loading dimensions or machine bed size limits."
        },
        "parameters": [
          {
            "name": "dXRange",
            "technicalDefault": "U(6300)",
            "businessMeaning": "The target maximum length (X-axis) of the nesting bundle. This typically represents the length of a truck bed, shipping container, or production line limit.",
            "validRange": "2000 - 24000",
            "unit": "mm",
            "affectsOutput": "Determines how many ObjectClones can be placed in a single row. If items exceed this length, the script attempts to wrap them to the next row (depending on implementation logic) or indicates an overflow visually."
          },
          {
            "name": "dYRange",
            "technicalDefault": "U(860)",
            "businessMeaning": "The target maximum width (Y-axis) of the nesting bundle. This typically represents the width of a transport vehicle or a standard packaging width.",
            "validRange": "500 - 4000",
            "unit": "mm",
            "affectsOutput": "Defines the width constraint. If the accumulated height of the nested rows exceeds this value, the visual indicator will flag the bundle as 'too large' or invalid for transport."
          },
          {
            "name": "nColor",
            "technicalDefault": "150",
            "businessMeaning": "The display color of the bounding box that represents the target range limits.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "ACI",
            "affectsOutput": "Visual only. Changes the color of the filled profile drawn in the model to indicate the boundary area. High visibility colors (e.g., Red, Magenta) are often used to indicate limit violations."
          },
          {
            "name": "nTransparency",
            "technicalDefault": "150",
            "businessMeaning": "The opacity level of the bounding box visualization.",
            "validRange": "0 - 255",
            "unit": "Alpha Level",
            "affectsOutput": "Visual only. Allows the user to see the nested timber parts 'inside' the bounding box. A value of 0 is opaque, while higher values allow the underlying geometry to be seen clearly."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Modification of dXRange or dYRange",
            "effect": "The script recalculates the intersection of the nested items against the new bounding box. If items exceed the new range, the visual warning (filled profile) changes appearance (e.g., turns on or changes color) to indicate the constraint is breached.",
            "cascade": [
              "Visual Geometry (PlaneProfile)",
              "Nesting Validity Status"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Logical Group (Parent/Child)",
            "description": "Establishes a parent-child relationship between the ObjectNester instance and the nested ObjectClone instances, treating them as a single assembly for selection and manipulation.",
            "appliedTo": "Selected ObjectClone TslInsts"
          },
          {
            "type": "PlaneProfile (Visualization)",
            "description": "Draws a filled 3D/2D profile representing the defined X/Y Range boundaries. Used for visual verification that the nesting fits within the target dimensions.",
            "appliedTo": "Model Space (at Nester origin)"
          }
        ]
      },
      "tokens_used": 10123,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: Initialize constants (Units, Colors, Keys).",
          "2. Dialog Mode Check: Check if 'DialogMode' is active (triggered by context menu).",
          "   [Branch] If DialogMode == 1: Define OPM properties (X-Range, Y-Range, Color, Transparency) and terminate execution.",
          "   [Branch] If DialogMode == 0: Continue to execution logic.",
          "3. Settings Initialization: Connect to 'hsbTSL' MapObject.",
          "   [Check] If MapObject invalid: Load settings from 'ObjectClone.xml' (Company or Install path).",
          "   [Check] If _bOnDbCreated: Compare MapObject version with XML version; report mismatch if found.",
          "4. Read Parameters: Extract dXMinRange, dYMinRange, nRangeColor, nRangeTransparency.",
          "5. Entity Processing: (Truncated code implies this) Filter/Select 'ObjectClone' TSL instances.",
          "6. Nesting Logic: Group instances into rows (getNestedRow) based on uniform height and X-range limits.",
          "7. Transformation & Grouping: Calculate relative CoordSys for children based on Alignment (Y+/Y-/Z+/Z-).",
          "8. Parent/Child Linking: Store nesting metadata in 'Hsb_NestingChild' SubMaps for all entities.",
          "9. Validation: Intersect calculated nesting profile (ppMaster) with Minimum Range profile (ppMinRange).",
          "   [Check] If geometry exceeds dXMinRange or dYMinRange: Set validity flag to false.",
          "10. Visualization: Draw filled profile (ppMinRange) in specified Color/Transparency if validity check fails.",
          "11. Finalization: Update 'Hsb_NestingParent' SubMap on the Nester instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution Mode (DialogMode)",
            "path1": {
              "name": "Configuration Mode",
              "steps": [
                "User right-clicks and selects 'Settings'.",
                "Script runs with DialogMode=1.",
                "Properties X-Range, Y-Range, Color, Transparency are exposed.",
                "Values saved back to MapObject and XML on confirmation."
              ]
            },
            "path2": {
              "name": "Calculation Mode",
              "steps": [
                "Script runs normally (insert or recalc).",
                "Geometry is calculated based on current properties.",
                "Parent/Child relationships are updated.",
                "Visual validation is performed."
              ]
            }
          },
          {
            "condition": "Exporting Settings: File Existence",
            "path1": {
              "name": "Overwrite Existing",
              "steps": [
                "User selects 'Export Settings'.",
                "Script finds existing file at path.",
                "Prompt: 'Are you sure to overwrite existing settings? [No/Yes]'.",
                "If 'Yes': MapObject is written to XML."
              ]
            },
            "path2": {
              "name": "Create New",
              "steps": [
                "User selects 'Export Settings'.",
                "Script finds no existing file.",
                "MapObject is written directly to XML without prompt."
              ]
            }
          },
          {
            "condition": "Nesting Alignment",
            "path1": {
              "name": "Y-Axis Alignment",
              "steps": [
                "Check if Alignment is Y+ or Y-.",
                "Child CoordinateSystem Z/Y axes are swapped relative to Parent.",
                "Sign determined by Positive/Negative direction."
              ]
            },
            "path2": {
              "name": "Z-Axis Alignment",
              "steps": [
                "Check if Alignment is Z+ or Z-.",
                "Child CoordinateSystem Y/Z axes are swapped relative to Parent.",
                "Sign determined by Positive/Negative direction."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Settings Version Mismatch",
            "errorMessage": "Notice reported to console: 'A different Version of the settings has been found...'",
            "recovery": "User should review the ObjectClone.xml file or update the MapObject via Import Settings."
          },
          {
            "check": "Nesting Range Limits",
            "errorMessage": "Visual feedback only (Filled Red/Colored Box appears). No text error.",
            "recovery": "User adjusts dXRange or dYRange in OPM or 'Settings' dialog, or rearranges nested objects."
          },
          {
            "check": "Uniform Height per Row",
            "errorMessage": "Implicit (Items skipped in loop). 'getNestedRow' only accepts items with width (dY) matching the first item of the row.",
            "recovery": "Ensure nested ObjectClones have compatible dimensions or sorting order allows grouping by height."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Nesting Dimensions",
            "how": "OPM Properties (dXRange, dYRange) or Context Menu -> Settings",
            "effect": "Updates the Min Range bounding box; triggers visual re-validation (warning box appears/disappears)."
          },
          {
            "action": "Change Visual Style",
            "how": "Context Menu -> Settings",
            "effect": "Changes Color and Transparency of the range visualization profile."
          },
          {
            "action": "Import/Export Configuration",
            "how": "Context Menu -> Import Settings / Export Settings",
            "effect": "Loads parameters from XML or saves current MapObject to XML (persistent storage)."
          },
          {
            "action": "Child Entity Manipulation",
            "how": "Standard hsbCAD Entity Move/Rotate",
            "effect": "Because of parent/child grouping (SubMapX), moving the Nester likely moves the children (depending on hsbCAD version implementation of SubMapX constraints), or re-running the script realigns them."
          }
        ]
      },
      "tokens_used": 10696,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ObjectNester\n\n## Overview\nThis script automatically arranges and groups `ObjectClone` instances (such as wall panels or roof cassettes) into a nested layout. It ensures that the grouped bundle fits within specific physical dimensions (Length/Width) required for transport or production, providing visual feedback if the limits are exceeded.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be inserted and runs within the Model Space to organize `ObjectClone` entities. |\n| Paper Space | No | Not designed for Paper Space or layout views. |\n| Shop Drawing | No | This is a production/logistics script, not a detailing tool for drawings. |\n\n## Prerequisites\n- **Required Entities**: `ObjectClone` instances (TslInst) must be present in the Model Space.\n- **Minimum Beam Count**: 0 (This script organizes other TSL instances, not beams).\n- **Required Settings**: `ObjectClone.xml` (Used to store and load default configuration parameters).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `ObjectNester.mcr`\n\n### Step 2: Insert and Organize\n```\nCommand Line: [Click insertion point]\nAction: Click in the Model Space to place the ObjectNester instance. \nThe script will automatically detect surrounding ObjectClone entities and calculate the nesting layout.\n```\n*Note: The script establishes a parent/child relationship, treating the selected clones as a single assembly.*\n\n### Step 3: Configure Dimensions\n```\nAction: Select the inserted ObjectNester instance.\n```\n1. Open the **Properties Palette** (Ctrl+1).\n2. Adjust **Min X-Range** and **Min Y-Range** to match your transport or packaging limits.\n3. Observe the visual indicator: a colored box appears indicating the boundary limits.\n\n### Step 4: Validation\n```\nAction: Check the visual feedback in the model.\n```\n- **Green/Standard/Invisible**: The nested objects fit within the specified X and Y ranges.\n- **Colored Filled Box**: The current layout exceeds the specified range. You must adjust the dimensions, remove items, or rearrange the nesting.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Min X-Range | Number | U(0) | Defines the maximum allowed length (X-axis) of the nesting bundle (e.g., truck bed length). |\n| Min Y-Range | Number | U(0) | Defines the maximum allowed width (Y-axis) of the nesting bundle (e.g., transport width). |\n| Color | Integer | 150 | Sets the display color of the bounding box visualization (AutoCAD Color Index). |\n| Transparency | Integer | 150 | Sets the opacity of the bounding box (0 = Opaque, 255 = Fully Transparent). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Settings** | Opens a configuration dialog to quickly set X-Range, Y-Range, Color, and Transparency. |\n| **Import Settings** | Loads previously saved configuration parameters from the `ObjectClone.xml` file. |\n| **Export Settings** | Saves the current configuration parameters to `ObjectClone.xml`. If the file exists, you will be prompted to confirm overwriting it. |\n\n## Settings Files\n- **Filename**: `ObjectClone.xml`\n- **Location**: Company or Install path (detected automatically by the script).\n- **Purpose**: Stores the default values for Range, Color, and Transparency, ensuring consistency across different projects or users.\n\n## Tips\n- **Visual Checking**: Use the **Color** property to set a highly visible color (like Red) for the bounding box. If the box appears, you immediately know the bundle is too large for the truck or machine.\n- **Transparency**: Adjust the **Transparency** to a higher value if you need to see the timber parts clearly inside the bounding box.\n- **Uniform Rows**: The script groups items by uniform height. Ensure your ObjectClones have compatible dimensions for optimal row generation.\n- **Grips**: You can use grips to drag and modify the size of the nester visually in newer versions (v1.4+).\n\n## FAQ\n- **Q: Why do I see a solid box around my nested items?**\n  A: This indicates that your current configuration (X/Y Range) is smaller than the actual size of the nested items. Increase the `Min X-Range` or `Min Y-Range` in the properties panel.\n- **Q: Can I save my transport dimensions for future projects?**\n  A: Yes. Configure your dimensions, right-click the script, and select **Export Settings**. This saves the values to the XML file.\n- **Q: The script isn't picking up my elements.**\n  A: Ensure the elements you are trying to nest are valid `ObjectClone` TSL instances. This script specifically nests other TSL instances, not raw beams or polylines."
      },
      "tokens_used": 7163,
      "error": null
    }
  }
}