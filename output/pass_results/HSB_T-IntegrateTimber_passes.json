{
  "filename": "HSB_T-IntegrateTimber.mcr",
  "status": "completed",
  "total_tokens": 53584,
  "processing_time": 301.6380708217621,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n"
      },
      "tokens_used": 9411,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit use of Group().collectEntities(true, Beam(), _kModelSpace). The script performs 3D geometric operations including BeamCut creation, volume interference checks using realBody(), and vector calculations. No usage of ShopDrawing (sd_) functions, viewports, or 2D drawing generation logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space (3D environment)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7095,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeparator01",
            "type": "PropString",
            "displayName": "Filter female beams",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sFemaleFilterBC",
            "type": "PropString",
            "displayName": "Filter female beams with beamcode",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Filter female beams",
            "description": null
          },
          {
            "index": 2,
            "variable": "sFemaleFilterLabel",
            "type": "PropString",
            "displayName": "Filter female beams with label",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Filter female beams",
            "description": null
          },
          {
            "index": 3,
            "variable": "sFemaleFilterMaterial",
            "type": "PropString",
            "displayName": "Filter female beams with material",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Filter female beams",
            "description": null
          },
          {
            "index": 4,
            "variable": "sFemaleFilterHsbID",
            "type": "PropString",
            "displayName": "Filter female beams with hsbID",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Filter female beams",
            "description": null
          },
          {
            "index": 5,
            "variable": "sSeparator02",
            "type": "PropString",
            "displayName": "Tool",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "Depth",
            "defaultValue": "3 (unit dependent)",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": null
          },
          {
            "index": 1,
            "variable": "dMinimumMillWidth",
            "type": "PropDouble",
            "displayName": "Minimum mill width",
            "defaultValue": "25 (unit dependent)",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": null
          },
          {
            "index": 2,
            "variable": "dGapW",
            "type": "PropDouble",
            "displayName": "Gap width",
            "defaultValue": "1 (unit dependent)",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": "Extra milling width"
          },
          {
            "index": 3,
            "variable": "dGapL",
            "type": "PropDouble",
            "displayName": "Gap length",
            "defaultValue": "200 (unit dependent)",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": "Extra milling length"
          },
          {
            "index": 4,
            "variable": "extraWidthForAdjacentConnections",
            "type": "PropDouble",
            "displayName": "Extra width for adjacent connections",
            "defaultValue": "0 (unit dependent)",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": null
          },
          {
            "index": 6,
            "variable": "sSeparator03",
            "type": "PropString",
            "displayName": "Marking",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sApplyMarking",
            "type": "PropString",
            "displayName": "Apply marking",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": "Marking",
            "description": null
          },
          {
            "index": 9,
            "variable": "sMarkingSide",
            "type": "PropString",
            "displayName": "Marking side",
            "defaultValue": "Inside",
            "inputType": "dropdown",
            "options": [
              "Inside",
              "Outside"
            ],
            "category": "Marking",
            "description": null
          },
          {
            "index": 8,
            "variable": "sSeparator04",
            "type": "PropString",
            "displayName": "Visualisation",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "symbolColor",
            "type": "PropInt",
            "displayName": "Symbol color",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": "Visualisation",
            "description": null
          },
          {
            "index": 1,
            "variable": "symbolColorAdjacentConnections",
            "type": "PropInt",
            "displayName": "Symbol color adjacent connections",
            "defaultValue": 72,
            "inputType": "number",
            "options": [],
            "category": "Visualisation",
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Restore connection",
            "handler": "Restore connection",
            "action": "Restores the connection logic (sets ExecuteMode to 1)",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8725,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the creation of T-connection joinery by cutting slots (pockets) into 'female' beams to accommodate intersecting 'male' beams, including clearance gaps and assembly markings.\",\n    \"category\": \"Joinery/Mach"
      },
      "tokens_used": 11057,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initializes properties and parses filter strings (BeamCode, Label, Material, HsbID).",
          "Script checks the attachment context of _Beam0.",
          "Conditional: If _Beam0 has a valid Element, collect beams from that Element; otherwise, collect all beams from ModelSpace.",
          "Filter the collected beams to identify 'Female' beams (targets for cutting) based on the parsed filter strings and dummy status.",
          "Check the Execute Mode.",
          "Conditional: If Execute Mode is 1 (Restore connection/Context Trigger), loop through Female beams, remove tools created by this instance, and erase the script instance.",
          "If Execute Mode is 0 (Standard), iterate through each Female beam (beam1).",
          "For each beam1, detect intersecting beams (arBeam1).",
          "Conditional: If no intersections found, skip to next Female beam.",
          "For each intersection, calculate geometric intersection planes, vectors (X, Y, Z), and angles.",
          "Calculate raw milling width (dWMill) and height (dHMill) based on beam dimensions, depth, and gaps.",
          "Conditional: Check for adjacent connections. If extraWidthForAdjacentConnections > 0 and a neighbor tool exists, double the mill width.",
          "Conditional: Check if cut is at beam end. If close to end, adjust position and double mill width.",
          "Enforce Minimum Mill Width (dMinimumMillWidth) on calculated dimensions.",
          "Create and add BeamCut to beam1.",
          "Conditional: If bApplyMarking is Yes, calculate Mark position and normal vector (Inside/Outside logic), and add Mark tool.",
          "Check for interference with other beams in the collection.",
          "Conditional: If interference detected, apply the current BeamCut to the interfering beam as well.",
          "Draw visualization symbols (Cross and Circle) at intersection points."
        ],
        "conditionalBranches": [
          {
            "condition": "Determination of Processing Scope",
            "path1": {
              "name": "Element Based",
              "steps": [
                "Script is attached to a beam (_Beam0) that belongs to an Element.",
                "Group beams from that specific Element."
              ]
            },
            "path2": {
              "name": "Model Space Global",
              "steps": [
                "Script is not attached to a valid Element.",
                "Group all Beams from the entire ModelSpace."
              ]
            }
          },
          {
            "condition": "Execute Mode Trigger",
            "path1": {
              "name": "Restore Connection (Delete)",
              "steps": [
                "Triggered by 'Restore connection' context menu or ExecuteMode=1.",
                "Clears all tools (cuts/marks) created by this script from the Female beams.",
                "Erases the script instance.",
                "Execution stops."
              ]
            },
            "path2": {
              "name": "Create Integration",
              "steps": [
                "Standard execution flow.",
                "Calculates intersections.",
                "Applies BeamCuts and Markings."
              ]
            }
          },
          {
            "condition": "Adjacent Connection Detection",
            "path1": {
              "name": "Adjacent Found",
              "steps": [
                "Checks for other TSL instances of the same name attached to the beam.",
                "Checks if the other tool's origin is within the calculated mill width.",
                "If found: Updates symbol color, increases mill width by extraWidthForAdjacentConnections, and triggers neighbor recalc."
              ]
            },
            "path2": {
              "name": "No Adjacent",
              "steps": [
                "Proceeds with standard calculated mill width."
              ]
            }
          },
          {
            "condition": "Marking Side Configuration",
            "path1": {
              "name": "Inside",
              "steps": [
                "Calculates marking face normal using negative element Z vector.",
                "Ensures normal points inward."
              ]
            },
            "path2": {
              "name": "Outside",
              "steps": [
                "Calculates marking face normal using positive element Z vector.",
                "Ensures normal points outward."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Intersection Geometry Validity",
            "errorMessage": "None (Silent Exit)",
            "recovery": "If intersection points cannot be ordered (arPtCornersZ.length() == 0), the script instance erases itself immediately."
          },
          {
            "check": "Minimum Mill Width",
            "errorMessage": "None",
            "recovery": "Calculated width/height is compared to 'Minimum mill width'. If calculated value is smaller, it is automatically clamped to the minimum value."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Integration Parameters",
            "how": "OPM (Object Properties Palette)",
            "effect": "Changing Depth, Gaps, Widths, or Filters triggers a recalculation. The cuts update to match new dimensions or filter different beams."
          },
          {
            "action": "Restore Female Beams",
            "how": "Right-click Context Menu -> 'Restore connection'",
            "effect": "Deletes the cuts and markings created by this script and removes the script instance from the drawing."
          },
          {
            "action": "Geometry Updates",
            "how": "Grip Edit / Move Beam",
            "effect": "Moving the beams changes the intersection geometry, triggering an automatic recalculation of the cut size and position."
          }
        ]
      },
      "tokens_used": 11066,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_T-IntegrateTimber\n\n## Overview\nAutomates the creation of T-connection joinery by cutting slots (pockets) into \"female\" beams to accommodate intersecting \"male\" beams, including clearance gaps and optional assembly markings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D geometric operations and beam cutting. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required entities**: GenBeam (Timber beams).\n- **Minimum beam count**: 2 (One \"female\" beam to be cut and one intersecting \"male\" beam).\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Select `HSB_T-IntegrateTimber.mcr` from the file list.\n\n### Step 2: Insert Script\n```\nCommand Line: Select insertion point or [Beam]:\nAction: Click to place the script instance in the drawing, preferably on a beam within the Element you wish to process.\n```\n*Note: If the script is attached to a beam belonging to an Element, it processes only that Element. Otherwise, it attempts to process all beams in Model Space.*\n\n### Step 3: Configure Properties\nAction: Select the inserted script instance and open the **Properties** palette (Ctrl+1).\nAction: Adjust the **Filter female beams** settings to target specific beams (e.g., by BeamCode or Material).\nAction: Set the **Tool** dimensions (Depth, Gaps) according to your manufacturing requirements.\nAction: The script automatically calculates intersections and applies cuts.\n\n## Properties Panel Parameters\n\n### Filter female beams\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Filter female beams with beamcode | Text | | Enter a BeamCode to only cut beams matching this code. |\n| Filter female beams with label | Text | | Enter a Label to only cut beams matching this label. |\n| Filter female beams with material | Text | | Enter a Material name to only cut beams matching this material. |\n| Filter female beams with hsbID | Text | | Enter a specific hsbID to target a single beam. |\n\n### Tool\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Depth | Number | 3 (unit dependent) | The depth of the pocket cut. |\n| Minimum mill width | Number | 25 (unit dependent) | The smallest allowed width for the cut; prevents narrow slivers. |\n| Gap width | Number | 1 (unit dependent) | Extra horizontal clearance added to the cut. |\n| Gap length | Number | 200 (unit dependent) | Extra vertical clearance added to the cut. |\n| Extra width for adjacent connections | Number | 0 (unit dependent) | Additional width added if another T-connection is detected nearby. |\n\n### Marking\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Apply marking | Dropdown | Yes | Adds an assembly mark to the beam. Options: Yes, No. |\n| Marking side | Dropdown | Inside | Determines which face receives the mark. Options: Inside, Outside. |\n\n### Visualisation\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Symbol color | Number | 3 | Color index for the standard connection symbol. |\n| Symbol color adjacent connections | Number | 72 | Color index for symbols when adjacent connections are detected. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Restore connection | Removes all cuts and markings created by this script and deletes the script instance from the drawing. |\n\n## Settings Files\nNone required.\n\n## Tips\n- **Filtering is Key**: If the script cuts beams you don't intend to modify, use the **Filter female beams** properties (e.g., BeamCode) to restrict the operation to specific structural members.\n- **Scope Control**: To process a specific wall or assembly, insert the script onto a beam *within* that Element. To process the entire model, insert it in empty space (Global mode).\n- **Adjacent Connections**: If you have multiple T-joints close to each other along a beam, increase the **Extra width for adjacent connections** parameter to ensure the cuts merge or maintain adequate structural spacing.\n- **Interference**: The script automatically checks for interference with other beams. If a cut affects a neighboring beam, the cut is applied to both.\n\n## FAQ\n- **Q: Why are no cuts appearing?**\n  **A:** Check the \"Filter female beams\" section. If a filter is set (e.g., Material), ensure the target beams actually match that value. If filters are empty, ensure the beams are intersecting correctly in 3D space.\n- **Q: Can I undo the cuts without deleting the script?**\n  **A:** No, use the \"Restore connection\" right-click option. This removes the tooling. To re-run, you must re-insert the script or trigger a recalculation if the logic supports it (though \"Restore\" usually deletes the instance).\n- **Q: The cut width is too small for my machinery.**\n  **A:** Increase the **Minimum mill width** property. The script will automatically enlarge any calculated cuts that fall below this value."
      },
      "tokens_used": 6230,
      "error": null
    }
  }
}