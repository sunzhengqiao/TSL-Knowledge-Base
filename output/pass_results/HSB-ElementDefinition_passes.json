{
  "filename": "HSB-ElementDefinition.mcr",
  "status": "completed",
  "total_tokens": 37468,
  "processing_time": 297.37498474121094,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6515,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script prompts user to select a Viewport using _Viewport.append(getViewport(...)). It retrieves the Element from the selected Viewport via vp.element(). The summary explicitly states the script 'shows the element definition on layouts'."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout) with an active Viewport displaying an Element",
          "requiredSettings": [
            "XML catalog file located at _kPathHsbCompany\\Abbund\\[sFileName].xml"
          ]
        }
      },
      "tokens_used": 4009,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select a position|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 5,
            "variable": "sSeparatorCatalog",
            "type": "PropString",
            "displayName": "|Catalog|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sFileName",
            "type": "PropString",
            "displayName": "     |Catalog name|",
            "defaultValue": "HSB-ElementDefinitionCatalog",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sSeparatorDefinition",
            "type": "PropString",
            "displayName": "|Definition|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sHeader",
            "type": "PropString",
            "displayName": "     |Header|",
            "defaultValue": "TITLE",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDrawEntryName",
            "type": "PropString",
            "displayName": "     |Draw entry name|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sExtraDescription",
            "type": "PropString",
            "displayName": "     |Extra description|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "sSeparatorStyle",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "     |Dimension style|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColorHeader",
            "type": "PropInt",
            "displayName": "     |Color header|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nColorContent",
            "type": "PropInt",
            "displayName": "     |Color content|",
            "defaultValue": "7",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "[sFileName].xml",
            "searchPaths": [
              "_kPathHsbCompany\\Abbund",
              "_kPathHsbCompany\\Content\\Dutch\\Element"
            ],
            "purpose": "Contains the element definitions (Zones, Entry Names) mapped by Element Type and Subtype.",
            "required": true
          }
        ]
      },
      "tokens_used": 6496,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically places a standardized label describing the build-up or composition (zones) of a construction element (wall, floor, or roof) onto a layout viewport.",
          "category": "ShopDrawing/Annotation",
          "typicalUseCase": "Used to annotate production drawings with schematic layer information (e.g., insulation, cladding, framing) derived from a catalog based on the specific element type."
        },
        "parameters": [
          {
            "name": "sFileName",
            "technicalDefault": "HSB-ElementDefinitionCatalog",
            "businessMeaning": "The name of the external XML catalog file containing the library of element definitions (zones, layers) mapped to element types.",
            "validRange": "Valid XML filename found in the company Abbund folder",
            "unit": "string",
            "affectsOutput": "Determines which database of definitions is queried. If the file is missing or incorrect, the script cannot find the element build-up data."
          },
          {
            "name": "sHeader",
            "technicalDefault": "TITLE",
            "businessMeaning": "The main title or caption displayed at the top of the element definition list on the drawing.",
            "validRange": "Any text string (e.g., 'WALL TYPE A', 'ROOF CONFIGURATION')",
            "unit": "string",
            "affectsOutput": "Changes the first line of text displayed in the layout."
          },
          {
            "name": "sDrawEntryName",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Flag to toggle the visibility of the specific catalog entry name (the ID of the definition used) in the output list.",
            "validRange": "Yes/No",
            "unit": "boolean",
            "affectsOutput": "If 'No', the line identifying the specific catalog key (e.g., 'Ext-240') is skipped in the drawing."
          },
          {
            "name": "sExtraDescription",
            "technicalDefault": "",
            "businessMeaning": "Custom text field to add specific notes or details relevant to this specific instance of the element definition.",
            "validRange": "Any text string",
            "unit": "string",
            "affectsOutput": "Inserts an additional line of text below the header if not empty."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The CAD dimension style that controls the font, text height, and appearance of the generated annotation.",
            "validRange": "Any dimension style defined in the current drawing",
            "unit": "style reference",
            "affectsOutput": "Scales the text size and row spacing based on the style settings."
          },
          {
            "name": "nColorHeader",
            "technicalDefault": "1",
            "businessMeaning": "The display color index used for the Header and Extra Description text.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "color index",
            "affectsOutput": "Changes the color of the title rows."
          },
          {
            "name": "nColorContent",
            "technicalDefault": "7",
            "businessMeaning": "The display color index used for the main content list (Entry Name and Zones).",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "color index",
            "affectsOutput": "Changes the color of the build-up description rows."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selected Viewport Element changes (Type/Subtype)",
            "effect": "The script generates a search key (Type - Subtype) to find the corresponding entry in the XML file specified by sFileName.",
            "cascade": [
              "sEntryName",
              "sZone00",
              "sZone01",
              "sZone02",
              "sZone03",
              "sZone04",
              "sZone05",
              "sZone06",
              "sZone07",
              "sZone08",
              "sZone09",
              "sZone10",
              "sOnTopOfZone00",
              "sAtTheBackOfZone00"
            ]
          },
          {
            "trigger": "sDimStyle changes",
            "effect": "Recalculates the text height and row spacing (dRowHeight) used for drawing.",
            "cascade": [
              "Position of all text lines"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text Entities",
            "description": "A vertical list of text strings describing the element build-up (Zones 0-10, OnTop, AtBack) and titles, placed in Paper Space.",
            "appliedTo": "Layout (Paper Space) at the user-selected coordinate (_Pt0)."
          }
        ]
      },
      "tokens_used": 5721,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User initiates script insertion (via command or catalog).",
          "2. System determines XML Catalog file location (New vs Old path).",
          "3. User selects a position in Paper Space.",
          "4. User selects a Viewport linked to a structural Element.",
          "5. System identifies Element Type (Roof vs Wall/Floor) and Subtype.",
          "6. System constructs Search Key (e.g., 'Type - Subtype') and queries XML.",
          "7. System draws Header, Extra Description, and available Zones in layout."
        ],
        "conditionalBranches": [
          {
            "condition": "XML Catalog Location Check",
            "path1": {
              "name": "File found in New Location",
              "steps": [
                "Check _kPathHsbCompany\\Abbund\\[sFileName].xml",
                "If found, proceed with insertion."
              ]
            },
            "path2": {
              "name": "File found in Old Location",
              "steps": [
                "Check fails in new folder.",
                "Check legacy path: _kPathHsbCompany\\Content\\Dutch\\Element\\[sFileName].xml",
                "If found, display Report Notice warning user to move file.",
                "Proceed with insertion using legacy file."
              ]
            }
          },
          {
            "condition": "Insertion Source",
            "path1": {
              "name": "Catalog Execution",
              "steps": [
                "If _kExecuteKey is present (preset used).",
                "Load properties from preset key.",
                "Prompt for point and viewport.",
                "Skip properties dialog."
              ]
            },
            "path2": {
              "name": "Manual Execution",
              "steps": [
                "If _kExecuteKey is empty.",
                "Prompt for point and viewport.",
                "Show properties dialog (showDialog)."
              ]
            }
          },
          {
            "condition": "Element Type Logic",
            "path1": {
              "name": "Roof Element",
              "steps": [
                "Cast element to ElementRoof.",
                "Use Token 1 of the Element Code as Type."
              ]
            },
            "path2": {
              "name": "Wall/Floor Element",
              "steps": [
                "Use the full Element Code as Type."
              ]
            }
          },
          {
            "condition": "Catalog Lookup Result",
            "path1": {
              "name": "Definition Found",
              "steps": [
                "Retrieve Zone data and Entry Name.",
                "Generate text entities for all non-empty zones."
              ]
            },
            "path2": {
              "name": "Definition Not Found",
              "steps": [
                "Display Error Message: 'Definition [Key] not found!'.",
                "Stop script execution (no drawing)."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Integrity",
            "errorMessage": "None (Silent cleanup)",
            "recovery": "If _Viewport array is empty (deleted viewport), the script automatically calls eraseInstance() and deletes itself."
          },
          {
            "check": "Element Validity",
            "errorMessage": "None (Silent exit)",
            "recovery": "If the element inside the viewport is invalid (bIsValid() == false), the script halts execution."
          },
          {
            "check": "Catalog Search Key",
            "errorMessage": "Definition [sSearchKey] not found!",
            "recovery": "User must ensure the selected Element matches a key in the XML catalog, or update the XML catalog to include the Element Type/Subtype."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Annotation",
            "how": "Grip Edit (Drag)",
            "effect": "Updates _Pt0 coordinate, moving the entire block of text to the new location."
          },
          {
            "action": "Update Configuration",
            "how": "OPM (Object Properties Palette)",
            "effect": "Changing 'Header', 'Extra description', 'Colors', or 'Dimension style' immediately regenerates the text. Changing 'Catalog name' triggers a reload of the XML file."
          },
          {
            "action": "Respond to Model Changes",
            "how": "Model Edit (Change Element Subtype/Type)",
            "effect": "Script detects the change in Element Type/Subtype, generates a new Search Key, queries the XML, and updates the drawn definition list automatically."
          }
        ]
      },
      "tokens_used": 8493,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB-ElementDefinition.mcr\n\n## Overview\nThis script automatically generates a label in Paper Space displaying the build-up definition (zones/layers) of a construction element (Wall, Floor, or Roof). It reads the configuration from an external XML catalog based on the Element Type and Subtype visible in a selected Viewport.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is intended for annotations on layouts. |\n| Paper Space | Yes | The script must be inserted on a Layout tab. |\n| Shop Drawing | No | Operates on Layouts/Viewports, not the shop drawing module directly. |\n\n## Prerequisites\n- **Entities**: A Layout (Paper Space) containing a Viewport that displays a structural Element (Wall, Floor, or Roof).\n- **Settings**: A valid XML catalog file (default: `HSB-ElementDefinitionCatalog.xml`) must exist in the company folder (`hsbCompany\\Abbund`).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB-ElementDefinition.mcr` from the list.\n\n### Step 2: Select Location\n```\nCommand Line: Select a position\nAction: Click anywhere in the Paper Space (Layout) where you want the top-left corner of the label to appear.\n```\n\n### Step 3: Select Viewport\n```\nCommand Line: Select a viewport\nAction: Click on the viewport border (or inside the viewport) that displays the element you wish to label.\n```\n\n### Step 4: Configure (If applicable)\nIf not run from a catalog preset, the Properties window will appear automatically. You can adjust the header, visibility options, and style here.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimension style | dropdown | _DimStyles | Select the text style to control font and height for the label. |\n| Header | text | TITLE | The main title text displayed at the top of the label. |\n| Draw entry name | dropdown | Yes | If 'Yes', displays the specific ID/Name of the catalog entry used. |\n| Extra description | text | (Empty) | Optional additional text line to appear below the header. |\n| Color header | number | 1 | Color index (0-255) for the Header and Extra Description lines. |\n| Color content | number | 7 | Color index (0-255) for the Zone/Content description lines. |\n| Catalog name | text | HSB-ElementDefinitionCatalog | The filename of the XML catalog to load (without extension). |\n| Catalog | text | (Empty) | *Visual separator for the properties palette.* |\n| Style | text | (Empty) | *Visual separator for the properties palette.* |\n| Definition | text | (Empty) | *Visual separator for the properties palette.* |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | This script uses standard AutoCAD/TSL grips and properties. No custom context menu items are defined. |\n\n## Settings Files\n- **Filename**: `[Catalog Name].xml` (Default: `HSB-ElementDefinitionCatalog.xml`)\n- **Location**: \n  - Primary: `_kPathHsbCompany\\Abbund\\`\n  - Legacy (Fallback): `_kPathHsbCompany\\Content\\Dutch\\Element\\`\n- **Purpose**: This XML file contains the database of element definitions. It maps Element Types and Subtypes (e.g., \"Ext-240\") to text descriptions for Zones 0-10.\n\n## Tips\n- **Moving the Label**: Click the label to select it. Use the blue square grip point at the insertion point to drag the entire label to a new location.\n- **Updating Content**: If you change the Element Type or Subtype in the model (e.g., change a wall thickness), the script will automatically detect the change and update the label text to match the new XML entry.\n- **Missing Definitions**: If the label displays \"Definition [Key] not found!\", check your XML catalog to ensure the Element Code of the selected viewport exists in the file.\n\n## FAQ\n- **Q: Why did the script show a warning about an old file path?**\n  - **A:** The script found the required XML file in the legacy folder (`Content\\Dutch\\Element`) instead of the new standard folder (`Abbund`). It will still work, but you should move the XML file to the new folder to prevent future warnings.\n- **Q: Can I change the text size?**\n  - **A:** Yes. Select the label and change the **Dimension style** property in the Properties Palette. The text size is derived from the selected dimension style settings.\n- **Q: What happens if I delete the viewport?**\n  - **A:** The script will detect that the linked viewport is missing and will automatically delete itself to prevent errors."
      },
      "tokens_used": 6234,
      "error": null
    }
  }
}