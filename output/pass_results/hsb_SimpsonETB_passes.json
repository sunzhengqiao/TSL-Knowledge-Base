{
  "filename": "hsb_SimpsonETB.mcr",
  "status": "completed",
  "total_tokens": 46151,
  "processing_time": 225.1630084514618,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8054,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script utilizes 3D geometric entities (MetalPart, BeamCut) and references Beam objects directly. It uses coordinate vectors (_X0, _Y0, _Z0) and origin (_Pt0) typical of Model Space operations. There is no presence of 'sd_' prefix, '_Viewport' checks, or '_Entity' array usage that would indicate Paper Space or Shop Drawing environments."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space containing at least two perpendicular beams forming a T-connection.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4445,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity.go\",\n        \"promptOriginal\": \"|Select beams|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"StandardProperties\",\n      \"trigger\": \"_bOnInsert\",\n      \"title\": null,\n      \"dataSource\": \"Prop definitions (sType, sPos, sMill, etc.)\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Type\",\n      \"defaultValue\": \"ETB90-B\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"ETB90-B\",\n        \"ETB120-B\",\n        \"ETB160-B\",\n        \"ETB190-B\",\n        \"ETB230-B\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sPos\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Position\",\n      \"defaultValue\": \"Middle\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Top\",\n        \"Middle\",\n        \"Bottom\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sMill\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Milling\",\n      \"defaultValue\": \"Yes\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Yes\",\n        \"No\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sNY\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Show description\",\n      \"defaultValue\": \"Yes\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dxFlag\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"X-flag\",\n      \"defaultValue\": \"200\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dyFlag\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Y-flag\",\n      \"defaultValue\": \"300\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dSnap\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|IntelliSelect|\",\n      \"defaultValue\": \"2000\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Describes the range where a valid T-Connection could be found|\"\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimstyle\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": \"_DimStyles\",\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color\",\n      \"defaultValue\": \"171\",\n      \"inputType\": \"number\",\n      \""
      },
      "tokens_used": 8766,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts a Simpson Strong-Tie ETB (End Transfer Bracket) type metal connector to join two perpendicular beams at a T-connection.",
          "category": "Hardware/Connection",
          "typicalUseCase": "Connecting floor joists to rim beams or headers using a face-mount bracket, optionally with a flush milling cut."
        },
        "parameters": [
          {
            "name": "sType",
            "technicalDefault": "ETB90-B",
            "businessMeaning": "Selects the specific Simpson Strong-Tie ETB model size, which determines the bracket's physical dimensions (height and width) and screw layout.",
            "validRange": "ETB90-B, ETB120-B, ETB160-B, ETB190-B, ETB230-B",
            "unit": "Model Designation",
            "affectsOutput": "Changes the width of the MetalPart (90mm to 230mm), height (60mm or 75mm), and the quantity/diameter of screws (Hardware) associated with that specific bracket size."
          },
          {
            "name": "sPos",
            "technicalDefault": "Middle",
            "businessMeaning": "Defines the vertical alignment of the bracket on the face of the primary beam.",
            "validRange": "Top, Middle, Bottom",
            "unit": "Alignment",
            "affectsOutput": "Shifts the MetalPart and associated BeamCut/Cut geometry vertically along the beam's cross-section (Z-axis) to align with the top, center, or bottom of the connected member."
          },
          {
            "name": "sMill",
            "technicalDefault": "Yes",
            "businessMeaning": "Determines whether a pocket (milling) is cut into the secondary beam to flush-mount the bracket.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "If 'Yes', adds a volumetric 'BeamCut' to the receiving beam to recess the bracket by its material thickness (approx. 10mm). If 'No', the bracket sits proud of the beam surface."
          },
          {
            "name": "sNY",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the visibility of the text label and leader line in the CAD model.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "If 'Yes', draws a 'Display' entity showing the connector name and a leader line pointing to the flag point."
          },
          {
            "name": "dSnap",
            "technicalDefault": "2000",
            "businessMeaning": "The search radius (tolerance) used during insertion to automatically find a valid perpendicular beam to connect to.",
            "validRange": "500 - 5000",
            "unit": "mm",
            "affectsOutput": "Does not affect geometry, but controls the sensitivity of the 'IntelliSelect' feature when finding T-connections during script execution."
          },
          {
            "name": "dxFlag",
            "technicalDefault": "200",
            "businessMeaning": "Horizontal offset distance for the annotation text/leader line from the connection point.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Moves the grip point and the associated text label horizontally along the beam axis."
          },
          {
            "name": "dyFlag",
            "technicalDefault": "300",
            "businessMeaning": "Vertical/perpendicular offset distance for the annotation text/leader line.",
            "validRange": "0 - 2000",
            "unit": "mm",
            "affectsOutput": "Moves the grip point and the associated text label perpendicularly away from the beam."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "Current CAD Standard",
            "businessMeaning": "Selects the drafting style (text size, arrows) for the connector label.",
            "validRange": "Available DimStyles in the drawing",
            "unit": "Style Name",
            "affectsOutput": "Changes the visual appearance (font, height, arrowheads) of the text label and leader line."
          },
          {
            "name": "nColor",
            "technicalDefault": "171",
            "businessMeaning": "The display color of the connector model and annotation.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Changes the visual color of the MetalPart and the text label."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sType changes",
            "effect": "Updates the geometry dimensions and the screw schedule (Hardware).",
            "cascade": [
              "MetalPart Dimensions",
              "Screw Quantity",
              "Screw Length"
            ]
          },
          {
            "trigger": "sMill is set to 'Yes'",
            "effect": "Enables the generation of a volumetric pocket cut.",
            "cascade": [
              "BeamCut generation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "MetalPart",
            "description": "The physical representation of the Simpson ETB bracket steel plate.",
            "appliedTo": "Inserted at the intersection of two beams."
          },
          {
            "type": "BeamCut",
            "description": "A milled pocket to flush-mount the bracket (if sMill is Yes).",
            "appliedTo": "The secondary beam (the beam being connected)."
          },
          {
            "type": "Cut",
            "description": "A surface cut representing the connection area or interaction with the main beam.",
            "appliedTo": "The primary beam (bm0)."
          },
          {
            "type": "Hardware",
            "description": "Screw entities (CNA or Simpson specific screws) required for the assembly.",
            "appliedTo": "Associated with the MetalPart and generated in reports/lists."
          },
          {
            "type": "Display",
            "description": "Annotation text and leader line labeling the connector.",
            "appliedTo": "Model space visualization."
          }
        ]
      },
      "tokens_used": 8595,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins.",
          "Check if inserting (_bOnInsert).",
          "If Inserting: Show properties dialog (showDialog).",
          "Prompt user to select beams (PrEntity.go).",
          "If selection valid: Initialize local variables and property lists.",
          "Iterate through selected beams (bm).",
          "For each beam, find perpendicular beams within 'dSnap' range using filterBeamsTConnection.",
          "Iterate through found perpendicular beams (bmFemale).",
          "Skip if bmFemale is the same as the current beam.",
          "If perpendicular: Create a new instance of the script at the connection point (dbCreate).",
          "After loop, erase the temporary script instance.",
          "Else (Not Inserting): Execute script body for existing instance.",
          "Verify beam validity (bm0 and bm1 exist).",
          "Check if beams are perpendicular (isPerpendicularTo).",
          "If not perpendicular: Report error, show alert message, and delete instance.",
          "If perpendicular: Determine bracket index (f) based on 'sType'.",
          "Generate Grip Point (_PtG) based on dxFlag and dyFlag.",
          "Calculate Insert Point (ptIns) based on 'sPos' (Top/Middle/Bottom).",
          "Check 'sMill' property (Milling).",
          "If 'Yes': Calculate ptIns offset, create BeamCut (bc) on bm1 (secondary beam) for pocket.",
          "Create Cut (ct) surface on bm0 (primary beam).",
          "Create MetalPart (mp) at ptIns with dimensions from lookup tables.",
          "Check 'sNY' property (Show description).",
          "If 'Yes': Draw Display text and leader line.",
          "Output Hardware data to production list.",
          "Finish execution."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Context (Insert vs. Edit)",
            "path1": {
              "name": "Insertion Routine",
              "steps": [
                "Show Dialog",
                "Select Multiple Beams",
                "Find T-Connections",
                "Create Child Instances",
                "Self-Destruct"
              ]
            },
            "path2": {
              "name": "Execution Routine",
              "steps": [
                "Validate Inputs",
                "Construct Geometry",
                "Apply Tools (Cut/Mill)",
                "Add Hardware/Material"
              ]
            }
          },
          {
            "condition": "sMill Property (Milling)",
            "path1": {
              "name": "Flush Mount",
              "steps": [
                "Offset insert point by depth",
                "Create volumetric BeamCut on bm1"
              ]
            },
            "path2": {
              "name": "Face Mount",
              "steps": [
                "Insert point at surface",
                "No pocket cut on bm1"
              ]
            }
          },
          {
            "condition": "sPos Property (Position)",
            "path1": {
              "name": "Top",
              "steps": [
                "Align bracket top with beam top"
              ]
            },
            "path2": {
              "name": "Middle",
              "steps": [
                "Center bracket on beam"
              ]
            },
            "path3": {
              "name": "Bottom",
              "steps": [
                "Align bracket bottom with beam bottom"
              ]
            }
          },
          {
            "condition": "sNY Property (Show Description)",
            "path1": {
              "name": "Show",
              "steps": [
                "Create Display entity",
                "Draw Text label",
                "Draw Leader line to Grip"
              ]
            },
            "path2": {
              "name": "Hide",
              "steps": [
                "Skip Display generation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Perpendicularity",
            "errorMessage": "Beams are not perpendicular! Tool will be deleted",
            "recovery": "Select two beams that form a 90-degree T-connection."
          },
          {
            "check": "Color Index",
            "errorMessage": "(None - internal reset)",
            "recovery": "Script automatically resets invalid color indices (>255 or <-1) to default 171."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Grip Point",
            "how": "Drag the visual grip point (_PtG) in the model.",
            "effect": "Updates dxFlag and dyFlag properties, moving the text label/leader line location relative to the beam."
          },
          {
            "action": "Change Properties",
            "how": "Select script instance and edit Properties Palette (OPM).",
            "effect": "Changing 'sType', 'sPos', 'sMill', or 'sNY' triggers a recalculation, updating bracket geometry, position, milling, or visibility immediately."
          },
          {
            "action": "Change Dimstyle",
            "how": "Edit 'Dimstyle' property in OPM.",
            "effect": "Updates the visual style (text size, arrows) of the connector label to match the selected CAD dimstyle."
          }
        ]
      },
      "tokens_used": 8763,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_SimpsonETB.mcr\n\n## Overview\nInserts a Simpson Strong-Tie ETB (End Transfer Bracket) to connect two perpendicular beams at a T-connection. It supports vertical positioning adjustment and optional milling to flush-mount the bracket.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model. |\n| Paper Space | No | Not designed for layout or detailing views. |\n| Shop Drawing | No | Not intended for shop drawing generation. |\n\n## Prerequisites\n- **Required Entities**: At least two Beams.\n- **Minimum Beam Count**: 2 beams forming a T-connection (perpendicular).\n- **Required Settings**: None (uses internal dimension tables and standard CAD DimStyles).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_SimpsonETB.mcr` from the list.\n\n### Step 2: Configure Properties\n```\nCommand Line: Properties Palette appears\nAction: Adjust the desired bracket Type, Position, and Milling options before selecting beams.\n```\n*(The Properties Palette will display allowing you to preset the connector specifications.)*\n\n### Step 3: Select Beams\n```\nCommand Line: Select beams:\nAction: Click on the beams you wish to connect (e.g., a rim beam and several joists).\nAction: Press Enter to confirm selection.\n```\n*(The script will automatically search for T-connections within the specified snap range and insert the connectors.)*\n\n### Step 4: Adjust Annotation (Optional)\n```\nAction: Click and drag the square grip point visible near the connector label.\nAction: Move to a clear location to avoid overlapping other text.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Type | dropdown | ETB90-B | Selects the Simpson Strong-Tie model number (ETB90-B to ETB230-B). Determines dimensions and screw layout. |\n| Position | dropdown | Middle | Vertical alignment of the bracket on the beam face: Top, Middle, or Bottom. |\n| Milling | dropdown | Yes | If 'Yes', cuts a pocket into the secondary beam for a flush-mounted bracket. If 'No', the bracket sits on the surface. |\n| Show description | dropdown | Yes | Toggles the visibility of the connector label and leader line. |\n| X-flag | number | 200 | Horizontal offset distance for the annotation text from the connection point (mm). |\n| Y-flag | number | 300 | Vertical offset distance for the annotation text (mm). |\n| IntelliSelect | number | 2000 | The search radius (in mm) used to automatically find intersecting beams when selecting. |\n| Dimstyle | dropdown | *Current* | Selects the CAD dimension style to control text size and arrowheads for the label. |\n| Color | number | 171 | The AutoCAD color index for the connector model and text. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the connector geometry based on current property changes or beam movements. |\n| ShowDialog | Re-opens the properties dialog to quickly edit parameters. |\n\n## Settings Files\n- **Filename**: None specified\n- **Location**: N/A\n- **Purpose**: This script uses internal look-up tables for bracket dimensions. It does not rely on external XML files for configuration.\n\n## Tips\n- **Batch Processing**: You can select multiple beams at once during the selection prompt. The script will loop through them and find valid T-connections automatically.\n- **Grip Editing**: Instead of typing coordinates for `X-flag` and `Y-flag`, simply select the script in the model and drag the blue square grip to move the label.\n- **Milling Depth**: If \"Milling\" is set to \"Yes\", ensure your beam is wide enough to accommodate the pocket without compromising structural integrity.\n\n## FAQ\n- **Q: Why did the connector disappear after I moved a beam?**\n  - A: The script likely detected that the beams are no longer perpendicular. Check the connection angle and use `Recalculate` or ensure the beams meet at 90 degrees.\n- **Q: Can I use this for L-shaped corners?**\n  - A: No, this script is designed specifically for T-connections (end of one beam meeting the face of another).\n- **Q: The text label is too small to read.**\n  - A: Change the `Dimstyle` property to a style with larger text settings, or increase the text size in your active CAD dimension style."
      },
      "tokens_used": 7528,
      "error": null
    }
  }
}