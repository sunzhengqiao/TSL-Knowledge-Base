{
  "filename": "hsbCLT-FreeTextMarker.mcr",
  "status": "completed",
  "total_tokens": 54949,
  "processing_time": 639.6248943805695,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.7",
            "date": "16.01.2025",
            "author": "Marsel Nakuci",
            "changes": "HSB-23245: Add maprequestText for sd"
          },
          {
            "version": "1.6",
            "date": "15dez2020",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-10036 text can depend on grain direction"
          },
          {
            "version": "1.5",
            "date": "26nov2020",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-9489: fix bug at btl export, keep same vecYtxt for both sides"
          },
          {
            "version": "1.4",
            "date": "18nov2020",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-9489: support multiple insertion on text mode"
          },
          {
            "version": "1.3",
            "date": "29oct2020",
            "author": "nils.gregor@hsbcad.com",
            "changes": "Merge issue"
          },
          {
            "version": "1.2",
            "date": "07sep2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "description and version updated"
          },
          {
            "version": "1.1",
            "date": "21aug2020",
            "author": "geoffroy.cenni@hsbcad.com",
            "changes": "cleaned up and added comments"
          },
          {
            "version": "1.0",
            "date": "10aug2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "hsbGrainDirection"
        ]
      },
      "tokens_used": 8866,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly creates instances using '_kModelSpace' in dbCreate. It interacts with 'Sip' objects using 'sip.addTool()', which modifies the 3D element representation. While it generates 'mapRequestText' for Shop Drawings, it executes as an element-level script in the model."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sip"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7230,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getSip",
              "promptOriginal": null,
              "condition": "_bOnInsert && sMode != Text",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity (Select panels)",
              "promptOriginal": "|Select panels|",
              "condition": "_bOnInsert && sMode == Text",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "|Pick base point|",
              "condition": "_bOnInsert && _Sip.length() == 1",
              "required": true
            },
            {
              "step": 4,
              "function": "PrPoint (Select point in direction)",
              "promptOriginal": "|Select point in direction| |<Enter> to align with edge|",
              "condition": "_bOnInsert && _Sip.length() == 1",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "TslUtilities::ShowDialog",
            "trigger": "Insertion (Standard)",
            "title": null,
            "dataSource": "Property Palette (implicit)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "|Mode|",
            "defaultValue": "|Text|",
            "inputType": "dropdown",
            "options": [
              "|Text|",
              "|Marker|",
              "|Text|+|Marker|"
            ],
            "category": "|General|",
            "description": "|Defines the Mode|"
          },
          {
            "index": 1,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "|Face|",
            "defaultValue": "|Reference Face|",
            "inputType": "dropdown",
            "options": [
              "|Reference Face|",
              "|Top Face|",
              "|Both|"
            ],
            "category": "|General|",
            "description": "|Defines the face of the tool|"
          },
          {
            "index": 2,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignemnt|",
            "defaultValue": "|Parallel|",
            "inputType": "dropdown",
            "options": [
              "|Parallel|",
              "|Perpendicular|",
              "|Parallel to grain direction|",
              "|Perpendicular to grain direction|"
            ],
            "category": "|General|",
            "description": "|Defines the alignment of the tool relative to the closest edge or to a custom direction.|"
          },
          {
            "index": 3,
            "variable": "sTextAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|Top-Left|",
            "inputType": "dropdown",
            "options": [
              "|Top-Left|",
              "|Top-Center|",
              "|Top-Right|",
              "|Center-Left|",
              "|Center-Center|",
              "|Center-Right|",
              "|Bottom-Left|",
              "|Bottom-Center|",
              "|Bottom-Right|"
            ],
            "category": "|Text|",
            "description": "|Defines the TextAlignment|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Text|",
            "description": "|Defines the Text Height|"
          },
          {
            "index": 4,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(PosNum)",
            "inputType": "text",
            "options": [],
            "category": "|Text|",
            "description": "|Defines the format of the text|"
          },
          {
            "index": 1,
            "variable": "dMarkerLength",
            "type": "PropDouble",
            "displayName": "|Length|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Marker|",
            "description": "|Defines the length of the marker.|, |0 = length byGrip|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "../|Flip Side|",
            "handler": "../|Flip Side|",
            "action": "Toggles the Face property between Reference Face and Top Face (if Both is not selected).",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "../|Set Alignment|",
            "handler": "../|Set Alignment|",
            "action": "Prompts user to select a point to define the text/marker direction.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "../|Snap To Edge|",
            "handler": "../|Snap To Edge|",
            "action": "Removes the custom direction grip, resetting alignment to default edge behavior.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "../|Set Marker Perpendicular To Edge|",
            "handler": "../|Set Marker Perpendicular To Edge|",
            "action": "Adjusts the marker grip to be perpendicular to the nearest edge at the insertion point.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8918,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "A tool to annotate CLT panels with free text (e.g., position numbers) and/or directional marker lines in the 3D model and on shop drawings.",
          "category": "Annotation / Layout",
          "typicalUseCase": "Placing element numbers or assembly labels on Cross Laminated Timber (CLT) panels to identify them during prefabrication or installation. Markers can indicate grain direction or specific alignment details."
        },
        "parameters": [
          {
            "name": "sMode",
            "technicalDefault": "|Text|",
            "businessMeaning": "Selects the type of annotation to create on the panel.",
            "validRange": "Text, Marker, Text+Marker",
            "unit": "Enumeration",
            "affectsOutput": "Determines whether a FreeText object, a MarkerLine, or both are generated and added to the panel."
          },
          {
            "name": "sFace",
            "technicalDefault": "|Reference Face|",
            "businessMeaning": "Controls which side(s) of the panel the annotation appears on.",
            "validRange": "Reference Face, Top Face, Both",
            "unit": "Enumeration",
            "affectsOutput": "Defines the Z-offset and normal vector for the text and marker placement. If 'Both' is selected, tools are duplicated on opposite sides."
          },
          {
            "name": "sAlignment",
            "technicalDefault": "|Parallel|",
            "businessMeaning": "Sets the rotational orientation of the text and marker relative to the panel geometry.",
            "validRange": "Parallel, Perpendicular, Parallel to grain direction, Perpendicular to grain direction",
            "unit": "Enumeration",
            "affectsOutput": "Calculates the text rotation vector (vecX) and marker direction. Can override edge alignment with grain direction data from hsbGrainDirection."
          },
          {
            "name": "sTextAlignment",
            "technicalDefault": "|Top-Left|",
            "businessMeaning": "Defines the anchor point of the text relative to its insertion point.",
            "validRange": "Standard 9-point alignment (Top-Left, Center-Center, etc.)",
            "unit": "Enumeration",
            "affectsOutput": "Adjusts the coordinate system origin so the text grows away from the anchor point correctly."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "The physical height of the text characters on the panel.",
            "validRange": "10mm - 500mm",
            "unit": "mm (Length)",
            "affectsOutput": "Scales the FreeText geometry. If 0, a default or previous value is often used."
          },
          {
            "name": "sFormat",
            "technicalDefault": "@(PosNum)",
            "businessMeaning": "The string content to display, supporting dynamic tokens.",
            "validRange": "Any string, typically tokens like @(PosNum), @(Length), or static text.",
            "unit": "String",
            "affectsOutput": "Determines the actual characters drawn. Resolved tokens update dynamically if panel properties change."
          },
          {
            "name": "dMarkerLength",
            "technicalDefault": "0",
            "businessMeaning": "The length of the directional marker line.",
            "validRange": "0 (use grip length) to Panel Length",
            "unit": "mm (Length)",
            "affectsOutput": "Defines the endpoint of the MarkerLine geometry. If 0, the distance to the user-placed grip point is used."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMode == '|Text|'",
            "effect": "Allows selection of multiple panels during insertion. Marker specific settings (dMarkerLength) are ignored.",
            "cascade": [
              "dMarkerLength"
            ]
          },
          {
            "trigger": "sAlignment contains 'grain direction'",
            "effect": "Reads data from the 'hsbGrainDirection' script. If that script or its map data is missing, alignment may fallback to panel edges or property defaults.",
            "cascade": [
              "vecX",
              "vecY"
            ]
          },
          {
            "trigger": "User interaction (Grip Point _PtG)",
            "effect": "Overrides the automatic calculation of rotation angle based on 'sAlignment'.",
            "cascade": [
              "sAlignment"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "FreeText",
            "description": "3D text annotation representing the resolved 'sFormat' string.",
            "appliedTo": "Selected Sip (Panel) surfaces."
          },
          {
            "type": "MarkerLine",
            "description": "A line segment indicating direction.",
            "appliedTo": "Selected Sip (Panel) surfaces."
          },
          {
            "type": "MapRequest (DimRequest)",
            "description": "Data passed to the Shop Drawing module to render the text and markers in 2D layouts.",
            "appliedTo": "Shop Drawing generation."
          }
        ]
      },
      "tokens_used": 9432,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script (via Command or Catalog)",
          "2. [Initial Configuration] Load properties from Catalog or show Property Dialog",
          "3. [Entity Selection] Check 'Mode' property",
          "   -> If 'Text': Prompt user to select multiple panels (PrEntity)",
          "   -> If 'Marker' or 'Text+Marker': Prompt user to select single panel (getSip)",
          "4. [Distribution Decision] Check number of selected panels",
          "   -> If > 1 panels selected: Create new TSL instance on each panel center, erase master instance (Workflow Ends)",
          "   -> If 1 panel selected: Continue to placement",
          "5. [Base Point] Prompt user for base point (_Pt0)",
          "6. [Direction Point] Prompt user for optional alignment point (_PtG) to set rotation",
          "7. [Validation/Recalc] Verify SIP attachment and Base Point location",
          "   -> Auto-correct Base Point if outside panel bounds",
          "8. [Geometry Generation] Iterate through faces (1 or 2 based on 'Face' property)",
          "   -> Calculate orientation vectors (vecX, vecY) based on Alignment property and Grip point",
          "   -> Read Grain Direction (if applicable) from hsbGrainDirection TSL",
          "   -> Create Marker Line (if Mode includes Marker)",
          "   -> Create FreeText (if Mode includes Text) and generate MapRequest for Shop Drawings"
        ],
        "conditionalBranches": [
          {
            "condition": "Mode property is 'Text' vs 'Marker'/'Text+Marker'",
            "path1": {
              "name": "Batch Insertion",
              "steps": [
                "Enable PrEntity selection filter",
                "Allow user to select multiple CLT panels",
                "Bypass individual point input",
                "Distribute tool to selected panels automatically"
              ]
            },
            "path2": {
              "name": "Single Insertion",
              "steps": [
                "Force single panel selection (getSip)",
                "Require manual Base Point input",
                "Require optional Direction Point input",
                "Proceed to geometry generation"
              ]
            }
          },
          {
            "condition": "sAlignment property (Parallel/Perpendicular/Grain/Custom)",
            "path1": {
              "name": "Custom Direction (Grip)",
              "steps": [
                "Check if grip point _PtG exists",
                "Calculate vecX/Y based on vector from _Pt0 to _PtG",
                "Override edge alignment logic"
              ]
            },
            "path2": {
              "name": "Geometric/Grain Alignment",
              "steps": [
                "If 'Grain Direction': Search for attached 'hsbGrainDirection' TSL and read vector",
                "If 'Parallel/Perpendicular': Calculate vector based on closest edge of panel envelope",
                "Determine rotation angle"
              ]
            }
          },
          {
            "condition": "Face property (Reference/Top/Both)",
            "path1": {
              "name": "Single Face",
              "steps": [
                "Execute geometry generation loop once",
                "Calculate Z-offset for specified face"
              ]
            },
            "path2": {
              "name": "Both Faces",
              "steps": [
                "Execute geometry generation loop twice",
                "Invert Z-normal and vectors for the second face",
                "Ensure text orientation (readability) is consistent"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "SIP (Panel) Selection",
            "errorMessage": "Invalid reference. Tool will be deleted.",
            "recovery": "User must attach the script to a valid CLT panel element."
          },
          {
            "check": "Base Point Location",
            "errorMessage": "None (Silent Correction)",
            "recovery": "Script automatically projects _Pt0 to the nearest point on the panel's profile envelope if clicked outside the bounds."
          },
          {
            "check": "Text/Format Resolution",
            "errorMessage": "Text and Format could not be resolved. Tool will be deleted.",
            "recovery": "User must ensure the sFormat property resolves to a valid string (e.g., check token availability like @(PosNum))."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Flip Side",
            "how": "Context Menu or Double Click",
            "effect": "Toggles 'sFace' property between Reference Face and Top Face (unless 'Both' is active)."
          },
          {
            "action": "Set Alignment",
            "how": "Context Menu (only if no custom grip is set)",
            "effect": "Prompts user to pick a point, setting a custom direction vector (_PtG) overriding edge alignment."
          },
          {
            "action": "Snap To Edge",
            "how": "Context Menu (only if custom grip is set)",
            "effect": "Removes the custom direction grip, resetting the marker/text to align with the nearest panel edge."
          },
          {
            "action": "Set Marker Perpendicular To Edge",
            "how": "Context Menu",
            "effect": "Calculates the tangent of the nearest edge and rotates the marker/text to be perpendicular to it, updating the grip position."
          },
          {
            "action": "Modify Properties",
            "how": "Object Properties Palette (OPM)",
            "effect": "Real-time update of Text Height, Content (Format), Mode, Alignment, and Marker Length."
          },
          {
            "action": "Grip Edit",
            "how": "Drag Grip Point in Model",
            "effect": "Moves the alignment point, dynamically changing rotation and length (if length is 0/grip-based)."
          }
        ]
      },
      "tokens_used": 11495,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-FreeTextMarker\n\n## Overview\nThis script adds free text labels (such as position numbers) and/or directional marker lines to CLT panels. The annotations are created in the 3D model and automatically included in generated shop drawings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Primary usage environment. Script must be inserted on panels in 3D. |\n| Paper Space | No | Not supported for direct insertion. |\n| Shop Drawing | Yes | Generates text and markers on the panel layout via MapRequest. |\n\n## Prerequisites\n- **Required Entities:** CLT Panels (Sip entities).\n- **Minimum Beams:** 1 (though Text mode supports multiple).\n- **Required Settings Files:** None.\n- **Dependencies:** `hsbGrainDirection` (Optional: only required if using alignment options related to grain direction).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or select from Catalog) â†’ Select `hsbCLT-FreeTextMarker.mcr`\n\n### Step 2: Configure Properties\nThe Properties Palette will appear. Before selecting elements, adjust the **Mode** property:\n- **Text:** Best for adding labels (e.g., Position Numbers) to multiple panels at once.\n- **Marker** or **Text+Marker**: Requires selecting a single panel and defining specific points.\n\n### Step 3: Select Panel(s)\n**If Mode is set to \"Text\":**\n```\nCommand Line: Select panels\nAction: Click on the CLT panels you want to label. You can select multiple panels. Press Enter to confirm.\n```\n*Note: The script will automatically place the text at the center of selected panels.*\n\n**If Mode is set to \"Marker\" or \"Text+Marker\":**\n```\nCommand Line: Select panels\nAction: Click on a single CLT panel.\n```\n\n### Step 4: Pick Base Point\n*(Only appears for single panel selection)*\n```\nCommand Line: Pick base point\nAction: Click on the panel surface where you want the text/marker to start.\n```\n*Note: If you click outside the panel boundaries, the script will automatically project the point onto the panel surface.*\n\n### Step 5: Set Direction (Optional)\n*(Only appears for single panel selection)*\n```\nCommand Line: Select point in direction <Enter> to align with edge\nAction: Click a second point to define the rotation of the text/marker. Alternatively, press Enter to automatically align it with the nearest panel edge.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Mode | dropdown | Text | Selects the type of annotation: \"Text\" only, \"Marker\" only, or both. |\n| Face | dropdown | Reference Face | Determines which side of the panel receives the annotation: Reference Face, Top Face, or Both. |\n| Alignment | dropdown | Parallel | Sets the orientation relative to the panel edge or grain direction. Options include Parallel, Perpendicular, Parallel to grain direction, and Perpendicular to grain direction. |\n| Alignment (Text) | dropdown | Top-Left | Sets the anchor point of the text string (e.g., Top-Left, Center-Center). |\n| Text Height | number | 0 | Defines the height of the text characters in millimeters. If 0, a default height is used. |\n| Format | text | @(PosNum) | The content of the text. Supports dynamic tokens (e.g., `@(PosNum)`, `@(Length)`) or custom strings. |\n| Length (Marker) | number | 0 | Defines the length of the marker line in millimeters. Set to 0 to use the grip point length. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side | Toggles the annotation between the Reference Face and Top Face. (Also available by Double-Clicking the tool). |\n| Set Alignment | Prompts you to click a point to manually set a custom rotation direction for the text/marker. |\n| Snap To Edge | Removes any custom rotation and snaps the annotation back to align with the nearest panel edge. |\n| Set Marker Perpendicular To Edge | Rotates the marker line 90 degrees relative to the nearest panel edge. |\n\n## Settings Files\nNo specific settings files are required for this script.\n\n## Tips\n- **Batch Labeling:** Use the **Text** mode to quickly apply Position Numbers to a selection of multiple panels in one operation.\n- **Dynamic Text:** Use the `Format` property to include tokens like `@(Length)` or `@(Width)` to display panel dimensions that update automatically if the panel changes size.\n- **Grip Editing:** After insertion, select the tool in the model to see a blue grip point. Drag this grip to easily rotate the text/marker or change the marker length without opening the properties menu.\n- **Grain Direction:** To align text with the wood grain, ensure the `hsbGrainDirection` script is applied to the panel and set the **Alignment** property to \"Parallel to grain direction\".\n\n## FAQ\n- **Q: I selected multiple panels, but the tool only appeared on one. Why?**\n- A: Ensure the **Mode** property is set to \"Text\". \"Marker\" and \"Text+Marker\" modes only support single panel selection because they require a specific insertion point.\n- **Q: My text displays as \"0\" or \"Unknown\".**\n- A: Check the **Format** property. If you are using a token (like `@(PosNum)`), ensure that specific property exists and has a value for the selected element.\n- **Q: How do I put the label on the top side of the panel instead of the bottom?**\n- A: Select the tool, right-click, and choose **Flip Side**, or change the **Face** property in the Properties Palette to \"Top Face\"."
      },
      "tokens_used": 9008,
      "error": null
    }
  }
}