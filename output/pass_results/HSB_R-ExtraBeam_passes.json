{
  "filename": "HSB_R-ExtraBeam.mcr",
  "status": "completed",
  "total_tokens": 38625,
  "processing_time": 501.4582860469818,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7296,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly inserts instances using _kModelSpace (tsl.dbCreate(..., _kModelSpace, mapTsl)). It operates on Element and Beam objects (Element el = (Element)_Entity[0]; Beam arBm[] = el.beam();) and creates/modifies 3D geometry using Body and dbCreate methods. It does not contain #Type E, sd_ prefixes, or viewport handling typical of ShopDrawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Beam Codes configured in properties (sFilterBC, sBmCodeExtraBeam)"
          ]
        }
      },
      "tokens_used": 5212,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && _kExecuteKey==\"\"",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select one or more elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertyDialog",
            "trigger": "During insert (_bOnInsert), if _kExecuteKey is empty",
            "title": null,
            "dataSource": "Properties defined in script (sBmCodeExtraBeam, dWExtraBeam, sFilterBC)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "|Extra beam|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator"
          },
          {
            "index": 1,
            "variable": "sBmCodeExtraBeam",
            "type": "PropString",
            "displayName": "     |Beamcode extra beam|",
            "defaultValue": "KLO-01",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Beamcode of beam to replace with extra beams"
          },
          {
            "index": 0,
            "variable": "dWExtraBeam",
            "type": "PropDouble",
            "displayName": "     |Width extra beam|",
            "defaultValue": "45",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "|Filter beams|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator"
          },
          {
            "index": 3,
            "variable": "sFilterBC",
            "type": "PropString",
            "displayName": "     Filter beams with beamcode",
            "defaultValue": "ZKRB-03;ZKRB-04;ZKRH-03;ZKRH-04",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "filter beams with beamcode"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5208,
      "error": null
    },
    "4": {
      "success": true,
      "data": {},
      "tokens_used": 8243,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script: User executes HSB_R-ExtraBeam.",
          "2. Property Configuration: If _kExecuteKey is empty, display Properties dialog (Beam code, Width, Filters).",
          "3. Selection: User selects one or more Elements (PrEntity prompt).",
          "4. Instance Creation: The script creates a satellite instance of itself on each selected Element, passing current properties via a Map.",
          "5. Execution Cycle: The satellite instance starts (cycle count > 1 check passes, erase avoided briefly, logic runs).",
          "6. Property Synchronization: Satellite loads properties from the 'MasterToSatellite' catalog map.",
          "7. Entity Validation: Script checks if attached Entity is a valid Element. If not, erases self.",
          "8. Geometry Analysis: Script retrieves Element CoordinateSystem and calculates start/end detail points (defaulting to Origin + 5000mm).",
          "9. Beam Categorization: Script loops through all beams in the Element.",
          "10. Filtering: Beams matching sFilterBC are ignored. Others are classified as Rafters or Extra Beams based on type/ID/BeamCode.",
          "11. Processing Loop: Script iterates through identified 'Extra Beams'.",
          "12. Profile Extraction: Script slices the Extra Beam body to get its profile geometry.",
          "13. Intersection Logic: For each Extra Beam, check against all found Rafters.",
          "14. Branch (Intersection): If a Rafter intersects the Extra Beam's length (Y-axis projection), generation proceeds.",
          "15. Beam Generation: A new beam is created using the Extra Beam's profile, specified Width, and centered at the Rafter's position.",
          "16. Attribute Assignment: New beam assigned color 32, type Stud, and specified BeamCode. Assigned to Element group.",
          "17. Cleanup: Original 'Extra Beam' (the placeholder) is erased (dbErase).",
          "18. Termination: The script instance erases itself (eraseInstance)."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution Context",
            "path1": {
              "name": "Insert Mode",
              "steps": [
                "Show Dialog (if _kExecuteKey empty)",
                "Prompt Element Selection",
                "Launch Satellite Instances",
                "Erase Self"
              ]
            },
            "path2": {
              "name": "Satellite Mode",
              "steps": [
                "Load Properties from Map",
                "Process Element Geometry",
                "Generate/Modify Beams",
                "Erase Self"
              ]
            }
          },
          {
            "condition": "Beam Classification during Scan",
            "path1": {
              "name": "Filtered Out",
              "steps": [
                "Check if BeamCode exists in sFilterBC",
                "Skip beam"
              ]
            },
            "path2": {
              "name": "Classified as Rafter",
              "steps": [
                "Check type (_kDak...) or HSB ID",
                "Check vertical position relative to Element CS",
                "Add to arBmRafter list"
              ]
            },
            "path3": {
              "name": "Classified as Extra Beam",
              "steps": [
                "Check if BeamCode matches sBmCodeExtraBeam",
                "Check if type is not Stud",
                "Add to arBmExtraBeam list"
              ]
            }
          },
          {
            "condition": "Rafter to Extra Beam Intersection",
            "path1": {
              "name": "No Overlap",
              "steps": [
                "Calculate dot product of Rafter position vs Extra Beam min/max bounds",
                "If product > 0 (same side), skip creation"
              ]
            },
            "path2": {
              "name": "Overlap Detected",
              "steps": [
                "Calculate intersection point",
                "Create new Body (extrude profile)",
                "Create new Beam dbCreate",
                "Set attributes (Color, Type, Code)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Validity",
            "errorMessage": "None (Internal Check)",
            "recovery": "Script erases itself if the attached element is invalid or Entity array is empty."
          },
          {
            "check": "Element contains geometry",
            "errorMessage": "None (Internal Check)",
            "recovery": "Script erases itself if no beams or vertices are found in the element (arPtBm.length() == 0)."
          },
          {
            "check": "Profile Extraction",
            "errorMessage": "None (Internal Check)",
            "recovery": "If slicing the Extra Beam returns no rings (arPlExtraBeam.length() == 0), the script returns (stops processing that beam)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Generated Beams",
            "how": "Standard OPM Properties / Grips",
            "effect": "The script instance is deleted after execution. The resulting 'Extra Beams' (Studs) become standard architectural elements. Users modify them individually as needed."
          }
        ]
      },
      "tokens_used": 7494,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-ExtraBeam\n\n## Overview\nThis script automates the generation of \"extra beams\" (studs) within a timber construction element. It identifies a specific placeholder beam, calculates intersections with rafters, and generates new studs at those intersection points, automatically removing the original placeholder.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D Elements and Beams. |\n| Paper Space | No | Not designed for layout or detailing views. |\n| Shop Drawing | No | This is a generation script for Model Space only. |\n\n## Prerequisites\n- **Required Entities**: An Element containing Beams.\n- **Configuration**: The Element must contain beams with the specific \"Extra Beam\" code (default: KLO-01) acting as placeholders.\n- **Geometry**: The Element must contain Rafters that intersect the longitudinal axis of the placeholder beams.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT`\n**Action**: Browse to the script location and select `HSB_R-ExtraBeam.mcr`.\n\n### Step 2: Configure Properties\n**Action**: Before selecting geometry, check the Properties Palette (OPM) or the initial dialog.\n- Set the **Beamcode extra beam** to match the placeholder beams in your model.\n- Set the **Width extra beam** to the desired width for the new studs.\n- Review the **Filter beams** list to ensure rafters are not excluded.\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or more elements\nAction: Click on the Element(s) (Walls/Roofs) containing the placeholder beams and rafters.\n```\n**Action**: Press **Enter** to confirm selection.\n\n### Step 4: Processing\n**Action**: The script will:\n1. Identify the placeholder beams and rafters.\n2. Generate the new studs at intersections.\n3. Delete the original placeholder beams.\n4. Delete the script instance from the model.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Extra beam | Separator | - | Visual separator for the Extra beam section. |\n| Beamcode extra beam | Text | KLO-01 | The beam code of the placeholder beam to be replaced by the new studs. |\n| Width extra beam | Number | 45 | The width (thickness) for the newly generated studs. |\n| Filter beams | Separator | - | Visual separator for the Filter section. |\n| Filter beams with beamcode | Text | ZKRB-03;ZKRB-04;... | A semicolon-separated list of beam codes to ignore during processing (typically other structural members). |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add persistent context menu options. It runs once and erases itself upon completion. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on Properties and Entity data; external settings files are not used.\n\n## Tips\n- **Check Intersection**: Ensure the placeholder beam overlaps with the rafters along the Element's Y-axis. If they do not visually overlap in length, no studs will be generated.\n- **Profile Source**: The cross-sectional shape (height/profile) of the new studs is taken from the placeholder beam. Only the width is overridden by the script property.\n- **Cleanup**: The script automatically deletes the \"placeholder\" beams. If you need to keep them, do not run this script or duplicate them beforehand.\n- **Post-Processing**: Since the script instance deletes itself after running, use standard AutoCAD/hsbCAD grips and properties to manually tweak the generated studs if necessary.\n\n## FAQ\n- **Q: I ran the script, but no beams appeared.**\n  A: Ensure the \"Beamcode extra beam\" property exactly matches the code of the placeholder beams in your model. Also, verify that the Rafters are not included in the \"Filter beams\" list.\n- **Q: Can I undo the changes?**\n  A: Yes, use the standard AutoCAD `UNDO` command immediately after running the script to revert the generation and restore the placeholder beams.\n- **Q: Where did the script instance go?**\n  A: This is a \"run-once\" script. It automatically erases itself from the element after generating the geometry to keep the drawing clean."
      },
      "tokens_used": 5172,
      "error": null
    }
  }
}