{
  "filename": "hsbCAD_SIP_BOM.mcr",
  "status": "completed",
  "total_tokens": 38381,
  "processing_time": 358.2745051383972,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6214,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "getViewport(...) used to select a viewport, _Viewport array used for storage, vp.coordSys() used to calculate transformation from Model Space to Paper Space, comments explicitly mention 'display in paper space'. The script draws 2D geometry (PLine, Text) at a user-selected point relative to the viewport."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space. Requires an active Layout containing a Viewport that references a valid hsbCAD Element.",
          "requiredSettings": []
        }
      },
      "tokens_used": 5816,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "Select upper left point of rectangle",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "Select the viewport from which the element is taken",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nColorIndex",
            "type": "PropInt",
            "displayName": "Header color",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5330,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a 2D Bill of Materials (BOM) table in Paper Space listing all beams and sheets from a specific hsbCAD Element selected via a viewport.",
          "category": "ShopDrawing",
          "typicalUseCase": "Creating a material schedule or component list on a drawing layout to detail the timber and sheeting components of a wall or floor panel."
        },
        "parameters": [
          {
            "name": "nColorIndex",
            "technicalDefault": "0",
            "businessMeaning": "Controls the display color of the table header text, including the Element number (e.g., 'Elevation Number') and the column titles (e.g., 'Width', 'Material').",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Changes the color of the text entities drawn in the header row and the top title of the BOM table in Paper Space."
          }
        ],
        "parameterDependencies": [],
        "outputEntities": [
          {
            "type": "2D Geometry (PLine/Text)",
            "description": "A formatted table containing an outer border, inner grid lines, and text rows. The table aggregates data by Position Number, Name, Width, Height, Length, and Material, providing a total count for each unique component type.",
            "appliedTo": "Paper Space Layout"
          }
        ]
      },
      "tokens_used": 6983,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User executes the script (Insert command).",
          "2. Script prompts for insertion point (Select upper left point of rectangle).",
          "3. Script prompts for viewport selection (Select the viewport from which the element is taken).",
          "4. Script stores inputs and exits insertion mode.",
          "5. Script retrieves the hsbCAD Element associated with the stored viewport.",
          "6. Validation: Checks if the viewport contains a valid hsbCAD Element.",
          "7. Data Collection: Iterates through all Beams in the element and aggregates identical items.",
          "8. Data Collection: Iterates through all Sheets in the element and aggregates identical items.",
          "9. Sorting: Sorts the combined list of items by Position Number (Bubble sort).",
          "10. Layout Calculation: Calculates column widths based on the longest string in each column.",
          "11. Rendering: Draws the outer border and the main header text.",
          "12. Rendering: Draws the column header row and vertical grid lines.",
          "13. Rendering: Loops through sorted items to draw data rows, horizontal lines, and text values."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution Mode (_bOnInsert)",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Prompt user for insertion point.",
                "Prompt user for viewport.",
                "Store data in script entity.",
                "Return immediately."
              ]
            },
            "path2": {
              "name": "Recalc/Update Mode",
              "steps": [
                "Retrieve stored viewport.",
                "Validate Element.",
                "Process geometry.",
                "Draw BOM table."
              ]
            }
          },
          {
            "condition": "Entity Type during Aggregation",
            "path1": {
              "name": "Beam Entity",
              "steps": [
                "Extract dimensions: Width (dW), Height (dH).",
                "Format Length (solidLength) to string.",
                "Group by: Position, Name, Width, Height, Length, Material, Info."
              ]
            },
            "path2": {
              "name": "Sheet Entity",
              "steps": [
                "Extract dimensions: Width (solidWidth), Height (solidLength).",
                "Set Length column to empty string.",
                "Group by: Position, Name, Width, Height, Material, Info."
              ]
            }
          },
          {
            "condition": "Item Uniqueness Check",
            "path1": {
              "name": "Duplicate Found",
              "steps": [
                "Identify existing item in list based on attributes.",
                "Increment the Count (arCount) for that item."
              ]
            },
            "path2": {
              "name": "Unique Item",
              "steps": [
                "Append new item to all property arrays (arPos, arW, arH, etc.).",
                "Initialize Count (arCount) to 1.",
                "Increment total item counter (nNum)."
              ]
            }
          },
          {
            "condition": "Table Row Rendering (Loop Index 'l')",
            "path1": {
              "name": "Header Row (l == 0)",
              "steps": [
                "Set text color to 'nColorIndex'.",
                "Draw column titles.",
                "Skip drawing the top horizontal grid line."
              ]
            },
            "path2": {
              "name": "Data Row (l > 0)",
              "steps": [
                "Set text color to default (color -1).",
                "Draw item data strings.",
                "Draw horizontal grid line above the text."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport array content",
            "errorMessage": "(Silent failure)",
            "recovery": "Ensure the script was inserted correctly and the viewport selection was not interrupted. Delete and re-insert if necessary."
          },
          {
            "check": "Validity of Element inside Viewport",
            "errorMessage": "(Silent failure - Script returns/draws nothing)",
            "recovery": "Select a viewport that contains a valid hsbCAD Element (e.g., a wall or floor generated with hsbCAD)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Header Color",
            "how": "Modify 'Header color' (nColorIndex) in AutoCAD Properties Palette (OPM).",
            "effect": "Updates the color of the Element Title (e.g., 'Elevation Number') and the Column Headers (e.g., 'Width', 'Material')."
          },
          {
            "action": "Move Table",
            "how": "Grip edit the insertion point (_Pt0).",
            "effect": "Relocates the entire BOM table in Paper Space while maintaining alignment."
          },
          {
            "action": "Update BOM Data",
            "how": "Modify the timber construction (add/remove beams or sheets) in Model Space within the viewport.",
            "effect": "The script regenerates automatically upon refresh/update, recalculating quantities and sorting based on the new Element state."
          }
        ]
      },
      "tokens_used": 8801,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCAD_SIP_BOM.mcr\n\n## Overview\nGenerates a 2D Bill of Materials (BOM) table in Paper Space that lists all timber beams and sheets from a specific hsbCAD Element selected via a viewport.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed to be inserted and viewed in Paper Space. |\n| Paper Space | Yes | The script draws the BOM table on the current layout. |\n| Shop Drawing | No | This is a drafting utility, not an hsbCAD Shop Drawing generation script. |\n\n## Prerequisites\n- **Required Entities**: A Viewport on the current Paper Space layout that references a valid hsbCAD Element (e.g., a Wall or Floor).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCAD_SIP_BOM.mcr` from the file dialog.\n\n### Step 2: Select Insertion Point\n```\nCommand Line: Select upper left point of rectangle\nAction: Click in Paper Space to define where the top-left corner of the BOM table will be placed.\n```\n\n### Step 3: Select Viewport\n```\nCommand Line: Select the viewport from which the element is taken\nAction: Click on the border of the viewport that displays the hsbCAD Element you wish to list in the BOM.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Header color | Number | 0 | Controls the color of the Element Title (e.g., Elevation Number) and the column header text (e.g., Width, Material) within the table. Uses AutoCAD Color Index (0-255). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script has no custom right-click menu options. Use the Properties Palette to adjust settings. |\n\n## Settings Files\n- **Filename**: None used.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Updating the Table**: If you modify the timber or sheets in the model (e.g., add a beam, change a material), update the script to automatically recalculate quantities and regenerate the table.\n- **Moving the Table**: Select the script entity and use the grip point at the top-left corner to move the entire BOM table to a new location.\n- **Organization**: The BOM aggregates identical items. It sorts the list by Position Number to keep components organized logically.\n\n## FAQ\n- **Q: Why did my table appear blank or empty?**\n  A: The selected viewport might not contain a valid hsbCAD Element, or the element might contain no beams or sheets. Ensure the viewport is looking at a generated hsbCAD wall or floor.\n- **Q: Can I change the color of just the data rows?**\n  A: No, currently the script only allows you to change the \"Header color\" via the Properties Panel. The data rows use the current layer or default color settings.\n- **Q: What is the difference between Beams and Sheets in this list?**\n  A: The script processes them differently: Beams list Width, Height, and Length, while Sheets list Width, Height, and Material (Length column is empty for sheets)."
      },
      "tokens_used": 5237,
      "error": null
    }
  }
}