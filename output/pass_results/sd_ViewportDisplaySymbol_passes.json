{
  "filename": "sd_ViewportDisplaySymbol.mcr",
  "status": "completed",
  "total_tokens": 35162,
  "processing_time": 263.8517303466797,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "19.10.2010",
            "author": "th@hsbCAD.de",
            "changes": ""
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6248,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Script name starts with sd_ (sd_ViewportDisplaySymbol.mcr). _Entity usage with ShopDrawView. References to _kOnGenerateShopDrawing and _kViewDataSets. Usage of getShopDrawView() and ShopDrawView class."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView",
            "MetalPartCollectionEnt",
            "TslInst",
            "Beam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be inserted in or associated with a Paper Space ShopDrawing context with a valid ShopDrawView.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3870,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getShopDrawView",
              "promptOriginal": "Select a shopdrawview",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "On Insert (after selecting ShopDrawView and Point)",
            "title": null,
            "dataSource": "Local properties (dScale, nColor, sDimStyle)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dScale",
            "type": "PropDouble",
            "displayName": "Scale",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color -1 = byBlock",
            "defaultValue": 164,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 4984,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Displays 2D symbols for hardware/connectors and labels for perpendicular drill hardware within a specific shop drawing viewport.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used during the creation or update of 2D shop drawings to automatically annotate visible hardware (like bolts or screws) and display specific graphical symbols defined in sub-components (like metal plates or connectors) directly on the layout view."
        },
        "parameters": [
          {
            "name": "dScale",
            "technicalDefault": 1,
            "businessMeaning": "Scale factor applied to the graphical symbols (lines, hatches, text) drawn by this script. It allows the user to resize the annotation to match the viewport scale or drafting standards without modifying the source component definitions.",
            "validRange": "0.1 to 10.0",
            "unit": "Factor (Ratio)",
            "affectsOutput": "Geometric size of symbols and height of text labels. Larger values make symbols bigger; smaller values make them smaller."
          },
          {
            "name": "nColor",
            "technicalDefault": 164,
            "businessMeaning": "The color used for drawing the symbols and hardware labels in the viewport. Setting it to -1 preserves the original colors defined within the component symbol map.",
            "validRange": "-1 (ByBlock/Symbol Color) or 0-255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Visual color of lines, hatches, and text. Used to highlight annotations or match layer colors."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The dimension or text style name used for the hardware labels (e.g., '4x M12'). This ensures the text font and appearance match the drawing's standard.",
            "validRange": "Any valid text style name existing in the current drawing.",
            "unit": "String",
            "affectsOutput": "Font, text height, and aspect ratio of the hardware count/model labels."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nColor set to -1",
            "effect": "The color defined inside the individual component's symbol map takes precedence, ignoring the nColor property for specific elements.",
            "cascade": [
              "Symbol Graphic Colors"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry (PLine, Hatch, Text)",
            "description": "Draws graphical representations of hardware symbols (stored in component maps) and grouped labels for perpendicular drill holes (e.g., '2x Bolt') with leader lines in Paper Space.",
            "appliedTo": "Paper Space Viewport (selected ShopDrawView)"
          }
        ]
      },
      "tokens_used": 6261,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch / Recalculate",
          "2. Check Insert Cycle Count (Abort if > 1 to prevent loops)",
          "3. User Prompt: Select a ShopDrawView (Viewport)",
          "4. User Prompt: Select Insertion Point (Used for fallback display)",
          "5. Show Dynamic Dialog (Configure Scale, Color, DimStyle)",
          "6. Retrieve internal View Data from Instance Map (_kViewDataSets)",
          "7. Match View Data to the selected ShopDrawView ID",
          "8. Verify View Data Validity and Viewport Match",
          "9. Retrieve Entities associated with the Viewport Definition",
          "10. Branch: Entity Collection Check",
          "11. [Path A: No Entities Found] Draw Script Name and Scale factor at the Insertion Point",
          "12. [Path B: Entities Found] Iterate through Entities (Beams, MetalParts, TSLs)",
          "13. Scan Entities for Symbol Maps and Perpendicular Drills",
          "14. Transform Symbols and Drill Points to PaperSpace Coordinates",
          "15. Sort and Group Drills by Diameter",
          "16. Draw 2D Geometry (Symbols, Hatches) and Labels (Leader lines, Text)",
          "17. Finish"
        ],
        "conditionalBranches": [
          {
            "condition": "Entity Type encountered in Viewport",
            "path1": {
              "name": "MetalPartCollectionEnt",
              "steps": [
                "Access MetalPartCollectionDef",
                "Loop through internal TslInst definitions for Symbol[] maps",
                "Loop through internal Beams for AnalysedDrill (Perpendicular) tools",
                "Transform coordinates using Definition CS then Viewport CS"
              ]
            },
            "path2": {
              "name": "Direct TslInst",
              "steps": [
                "Check if instance has Symbol[] map",
                "Add to draw list"
              ]
            },
            "path3": {
              "name": "Direct Beam",
              "steps": [
                "Check for AnalysedDrill (Perpendicular) tools",
                "Check connected tools (eToolsConnected) for TSLs with Symbol[] maps",
                "Transform coordinates using Viewport CS"
              ]
            }
          },
          {
            "condition": "Symbol Orientation Check (For MetalPartCollection)",
            "path1": {
              "name": "Visible",
              "steps": [
                "Symbol 'vecView' is parallel to Viewport Z-Axis",
                "Draw Symbol geometry"
              ]
            },
            "path2": {
              "name": "Hidden/Skipped",
              "steps": [
                "Symbol 'vecView' is NOT parallel to Viewport Z-Axis",
                "Continue to next symbol"
              ]
            }
          },
          {
            "condition": "Drill Direction Check (Perpendicular Holes)",
            "path1": {
              "name": "Process for Labeling",
              "steps": [
                "Drill vector is parallel to Screen Z-Axis (PaperSpace Z)",
                "Add to drill list for sorting and grouping"
              ]
            },
            "path2": {
              "name": "Ignore",
              "steps": [
                "Drill vector is not perpendicular to screen",
                "Exclude from labeling"
              ]
            }
          },
          {
            "condition": "Color Property (nColor)",
            "path1": {
              "name": "Use Map Color",
              "steps": [
                "nColor is set to -1",
                "Use the color integer defined inside the Symbol Map"
              ]
            },
            "path2": {
              "name": "Use Property Color",
              "steps": [
                "nColor is set to specific index (e.g., 164)",
                "Override Symbol Map color with nColor value"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "ShopDrawView Validity",
            "errorMessage": "None (Silent)",
            "recovery": "If selected view is invalid or view cannot be found, the script draws a fallback text block showing the Script Name and Scale at the user-picked point."
          },
          {
            "check": "View Data Set Availability",
            "errorMessage": "None (Silent)",
            "recovery": "If '_kViewDataSets' in the script map does not contain data for the specific viewport ID (nIndFound < 0), the script defaults to drawing the fallback text block."
          },
          {
            "check": "Entity Existence",
            "errorMessage": "None (Silent)",
            "recovery": "If the viewport returns 0 entities to display, the script draws the fallback text block instead of crashing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Scale (dScale)",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Resizes the graphical symbols (PLine dimensions) and text height relative to the Paper Space coordinate system."
          },
          {
            "action": "Modify Color (nColor)",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Changes the color of drawn lines, hatches, and text. If set to -1, it reverts to the component's native symbol colors."
          },
          {
            "action": "Modify DimStyle (sDimStyle)",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Updates the font and style settings used for the hardware labels (e.g., '2x M12')."
          },
          {
            "action": "Viewport Update",
            "how": "Update Shop Drawing / Refresh Layout",
            "effect": "If the underlying model changes (beams moved, hardware added), re-running or updating the script regenerates the symbols based on the new View Data."
          }
        ]
      },
      "tokens_used": 8501,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# sd_ViewportDisplaySymbol.mcr\n\n## Overview\nThis script automates the annotation of shop drawings by displaying 2D symbols for hardware (connectors, plates) and labels for perpendicular drill holes within a selected viewport. It ensures that necessary connection details are clearly visible on the layout.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is intended for layout generation. |\n| Paper Space | Yes | Must be run within a layout tab. |\n| Shop Drawing | Yes | Specifically designed to work with `ShopDrawView` entities. |\n\n## Prerequisites\n- **Required Entities:** A `ShopDrawView` (Viewport) must exist in the Paper Space layout.\n- **Content:** The model view associated with the viewport must contain beams, metal parts, or TSL instances that have symbol maps or perpendicular drill tools defined.\n- **Setting:** A valid Dimension Style (`DimStyle`) must exist in the drawing if you wish to customize text appearance.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse and select `sd_ViewportDisplaySymbol.mcr`.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select a shopdrawview\nAction: Click on the Viewport frame or the boundary of the shop drawing view you wish to annotate.\n```\n\n### Step 3: Select Insertion Point\n```\nCommand Line: (Select Point)\nAction: Click anywhere in the Paper Space.\nNote: This point is used as a fallback location. If the script cannot find data or hardware in the view, it will display the script name and scale at this location.\n```\n\n### Step 4: Configure Properties\nAfter insertion, a dialog appears (or use the Properties Palette) to set the scale, color, and dimension style.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Scale | Number | 1.0 | Determines the size of the symbols and text labels. Increase this value to make annotations larger in Paper Space. |\n| Color -1 = byBlock | Number | 164 | Sets the color for the drawn lines and text. Enter `-1` to use the original colors defined in the component symbol map. |\n| Dimstyle | Dropdown/String | _DimStyles | Specifies the text style used for hardware labels (e.g., \"2x M12\"). The style must exist in the current drawing. |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu options are defined for this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external settings files. It reads configuration from the Properties Palette and the instance map.\n\n## Tips\n- **Visibility:** Symbols are only drawn if their internal \"View Vector\" is parallel to the Viewport's Z-axis. This ensures you only see hardware symbols that are facing \"out\" towards the viewer in 2D.\n- **Troubleshooting:** If you see only the script name and scale number at your selected point, the script likely could not find any entities or hardware data associated with that specific viewport.\n- **Organization:** The script automatically groups perpendicular drills by diameter and creates a single label (e.g., \"4x M12\") for them.\n\n## FAQ\n- **Q: Why are some of my connector symbols missing?**\n  A: The script filters symbols based on orientation. A symbol will only appear if it is defined to be visible from the current viewing direction of the selected viewport.\n- **Q: Can I change the size of the text without changing the lines?**\n  A: No, the `Scale` property acts as a global multiplier for all generated geometry (symbols, hatches, and text).\n- **Q: What does setting Color to -1 do?**\n  A: It respects the colors assigned to the specific hardware in your catalog or sub-scripts. If you set a specific number (e.g., Red), it overrides the catalog colors."
      },
      "tokens_used": 5298,
      "error": null
    }
  }
}