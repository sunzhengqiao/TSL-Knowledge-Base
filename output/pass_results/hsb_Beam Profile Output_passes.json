{
  "filename": "hsb_Beam Profile Output.mcr",
  "status": "completed",
  "total_tokens": 50477,
  "processing_time": 251.1632797718048,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7811,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to select Beam objects directly from the drawing and modifies their properties (setMaterial, setLabel, setGrade). It uses Display to draw the calculated profiles and dimensions at a user-defined point (_Pt0) without using sd_* functions, _Viewport, or Sheet entities. It relies on implicit World Coordinate System variables (_PtW, _XW, etc.) typical of Model Space insertion."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 6792,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Select the point where is going to be located the report\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"Select a set of beams\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dTolerance\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Tolerance\",\n      \"defaultValue\": \"1\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Distance between Profiles\",\n      \"defaultValue\": \"600\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dOffsetText\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Text Offset\",\n      \"defaultValue\": \"300\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"New Material\",\n      \"defaultValue\": \"Profiled Timber\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Beam Properties\",\n      \"description\": null\n    },\n    {\n      \"index\": 8,\n      \"variable\": \"sNewGrade\",\n      \"type\": \"PropString\",\n      \"displayName\": \"New Grade\",\n      \"defaultValue\": \"C24\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Beam Properties\",\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sLabel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"New Label prefix\",\n      \"defaultValue\": \"PT\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Beam Properties\",\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"dAngleTextHeight\",\n      \"type\": \"PropDouble"
      },
      "tokens_used": 9568,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Analyzes selected beams to identify unique cross-section profiles, generates a 2D visual report of these profiles with dimensions and quantities, and updates the beams' material and grade properties to reflect their processing status.",
          "category": "Reporting / Data Management",
          "typicalUseCase": "Used in a timber framing workflow to identify and quantify unique member profiles (e.g., cut rafters or curved beams) for fabrication lists, while visually documenting their geometry in the model."
        },
        "parameters": [
          {
            "name": "dTolerance",
            "technicalDefault": "1",
            "businessMeaning": "The sensitivity threshold used to determine if two vertices are identical. This effectively filters out minor machining discrepancies or modeling errors to group beams into 'identical' profile families.",
            "validRange": "0.1 - 10",
            "unit": "mm",
            "affectsOutput": "Controls how strictly profiles are matched. A larger tolerance may group different profiles together; a smaller tolerance may increase the number of unique profiles reported."
          },
          {
            "name": "dOffset",
            "technicalDefault": "600",
            "businessMeaning": "The vertical spacing (Y-axis in report view) between rows of profile drawings in the generated layout.",
            "validRange": "200 - 1500",
            "unit": "mm",
            "affectsOutput": "Changes the vertical density of the report. Higher values spread profiles out more; lower values compact them."
          },
          {
            "name": "dOffsetText",
            "technicalDefault": "300",
            "businessMeaning": "The vertical distance between the center of a profile drawing and its label text (e.g., 'PT1 (5)').",
            "validRange": "50 - 500",
            "unit": "mm",
            "affectsOutput": "Moves the label text further away or closer to the profile geometry."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "Profiled Timber",
            "businessMeaning": "The new material classification assigned to the processed beams. This is used to segregate 'profiled' or 'processed' beams from raw stock in lists and schedules.",
            "validRange": "Any string name defined in the hsbCAD material catalog",
            "unit": "text",
            "affectsOutput": "Updates the 'Material' property of the selected beam entities in the model database."
          },
          {
            "name": "sNewGrade",
            "technicalDefault": "C24",
            "businessMeaning": "The timber strength grade assigned to the beams. This allows for automatic updating of engineering properties if the processing (e.g., profiling) changes the structural class.",
            "validRange": "Any valid timber grade code (e.g., C24, GL24h, SS)",
            "unit": "text",
            "affectsOutput": "Updates the 'Grade' property of the selected beam entities."
          },
          {
            "name": "sLabel",
            "technicalDefault": "PT",
            "businessMeaning": "The prefix used to name the profile groups (e.g., PT1, PT2). This label is applied to the beam entity and shown in the report.",
            "validRange": "Text string (typically 2-4 characters)",
            "unit": "text",
            "affectsOutput": "Determines the naming convention for the grouped profiles in the report and the Label attribute of the beams."
          },
          {
            "name": "dAngleTextHeight",
            "technicalDefault": "20",
            "businessMeaning": "The height of the text used to display angle values (e.g., '45º') at the corners of the profile.",
            "validRange": "10 - 100",
            "unit": "mm",
            "affectsOutput": "Scales the size of the angle annotations in the drawing."
          },
          {
            "name": "dAngleOffset",
            "technicalDefault": "10",
            "businessMeaning": "The distance the angle text is pushed away from the corner vertex to ensure legibility.",
            "validRange": "5 - 50",
            "unit": "mm",
            "affectsOutput": "Adjusts the position of the angle text relative to the corner."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The specific AutoCAD/hsbCAD dimension style used to format the dimension lines (arrows, text size, units).",
            "validRange": "Existing dimension styles in the current drawing",
            "unit": "enum",
            "affectsOutput": "Determines the visual appearance of the dimensions in the report."
          },
          {
            "name": "nColor",
            "technicalDefault": "90",
            "businessMeaning": "The display color index for the drawn profile geometry and dimensions.",
            "validRange": "1 - 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Changes the color of the generated report graphics."
          },
          {
            "name": "nColumn",
            "technicalDefault": "5",
            "businessMeaning": "The number of unique profiles displayed horizontally in a single row before wrapping to the next line.",
            "validRange": "1 - 10",
            "unit": "count",
            "affectsOutput": "Controls the grid layout of the report (Width vs Height)."
          },
          {
            "name": "sDisplayModeChain",
            "technicalDefault": "Parallel",
            "businessMeaning": "Dictates how dimensions are oriented relative to the segment being measured (Parallel to the segment or Perpendicular to it).",
            "validRange": "Parallel, Perpendicular, None",
            "unit": "enum",
            "affectsOutput": "Changes the orientation of dimension lines in the report."
          },
          {
            "name": "sMessage (and 2,3,4)",
            "technicalDefault": "STEEL, -, ?, ?",
            "businessMeaning": "Filter criteria used to EXCLUDE beams. Beams with a Grade matching these entries are ignored by the script. This is used to skip steel components or non-timber items.",
            "validRange": "Grade codes (semicolon separated in logic)",
            "unit": "text",
            "affectsOutput": "Filters which beams are analyzed and reported. Matching beams are left unchanged."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nColumn",
            "effect": "Determines the horizontal wrap point of the report. Interacts with dOffset to set row positions.",
            "cascade": [
              "dOffset"
            ]
          },
          {
            "trigger": "sDisplayModeChain",
            "effect": "If set to 'None', dimensions are suppressed.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Graphics (PLine/Text)",
            "description": "2D geometry representing the cross-section of each unique profile, plus dimensions, angles, and quantity labels.",
            "appliedTo": "Model Space (at user selected point)"
          },
          {
            "type": "Beam Properties",
            "description": "Updates Material, Grade, and Label attributes on the GenBeam objects.",
            "appliedTo": "Selected GenBeams (that pass filters)"
          }
        ]
      },
      "tokens_used": 8891,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Initialization: Parse OPM properties and construct filter list (sMessage 1-4) for beam exclusion.",
          "2. Insertion Sequence (_bOnInsert): Show properties dialog (if first run).",
          "3. User Input: Prompt for Report Location (getPoint -> _Pt0).",
          "4. User Input: Prompt for Beam Selection (PrEntity -> _Beam).",
          "5. Pause: Script saves state and waits for next execution event.",
          "6. Validation: Check if beam array is empty. If yes, erase script instance and exit.",
          "7. Context Menu Check: If 'Select extra Beams' triggered, append new PrEntity selection to _Beam array.",
          "8. Cleanup: Remove duplicate beam entities from the array.",
          "9. Analysis Loop: Iterate through all selected beams.",
          "10. Filter Check: Compare beam grade against exclusion list. If match, skip to next beam.",
          "11. Geometry Extraction: Extract 2D shadow profile, transform to World UCS, and clean vertices within Tolerance.",
          "12. Geometry Check: Determine if profile is a standard rectangle (4 vertices, orthogonal sides). If yes, skip beam.",
          "13. Storage: If profile is complex, add to processing array (ArrPlBm).",
          "14. Grouping Logic: For each profile, generate X, Y, and Z mirrored variants.",
          "15. Comparison: Check if the profile (or its mirrors) matches an existing unique profile in AllPlToDim within Tolerance.",
          "16. Unique ID Assignment: If no match found, add to AllPlToDim as a new unique type.",
          "17. Property Update Loop: Map all processed beams to their unique profile IDs. Update Material, Grade, and Label on the beam entities.",
          "18. Report Generation Loop: Iterate through unique profiles (AllPlToDim).",
          "19. Layout Calculation: Determine grid position based on nColumn and dOffset.",
          "20. Dimensioning: Calculate bounding box points (Up/Down/Left/Right) and angled segments.",
          "21. Drawing: Render profile geometry, dimensions (if mode is not None), and angle text at corners.",
          "22. Labeling: Draw Label + Quantity text at calculated position."
        ],
        "conditionalBranches": [
          {
            "condition": "Beam Grade Filter",
            "path1": {
              "name": "Exclude Beam",
              "steps": [
                "Grade matches one of the sMessage properties (e.g., 'STEEL').",
                "Beam is ignored in the profile list.",
                "Beam properties are NOT updated."
              ]
            },
            "path2": {
              "name": "Include Beam",
              "steps": [
                "Grade does not match exclusion list.",
                "Profile geometry is extracted.",
                "Proceed to Geometry Check."
              ]
            }
          },
          {
            "condition": "Geometry Type Check",
            "path1": {
              "name": "Standard Beam",
              "steps": [
                "Profile has 4 vertices and 90-degree corners.",
                "Assumed to be standard rectangular stock.",
                "Excluded from report to focus on profiled/complex items."
              ]
            },
            "path2": {
              "name": "Profiled Beam",
              "steps": [
                "Profile is non-rectangular.",
                "Added to ArrPlBm for symmetry matching.",
                "Included in report and property updates."
              ]
            }
          },
          {
            "condition": "Symmetry Matching",
            "path1": {
              "name": "New Profile Found",
              "steps": [
                "Profile and its mirrors do not match any existing entry.",
                "Added to AllPlToDim array as a new row in the report."
              ]
            },
            "path2": {
              "name": "Existing Profile Matched",
              "steps": [
                "Profile matches existing entry within Tolerance.",
                "Not added to drawing again.",
                "Quantity counter incremented for existing entry."
              ]
            }
          },
          {
            "condition": "Dimension Display Mode (sDisplayModeChain)",
            "path1": {
              "name": "None",
              "steps": [
                "Dimensions are suppressed.",
                "Only profile outline and text are drawn."
              ]
            },
            "path2": {
              "name": "Parallel or Perpendicular",
              "steps": [
                "Script calculates segment orientation.",
                "Draws horizontal/vertical dims and separate angled dims."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Selection Count",
            "errorMessage": "None (Implicit)",
            "recovery": "Script calls eraseInstance(). If no beams are selected initially or if all are filtered out, the script deletes itself from the drawing."
          },
          {
            "check": "Color Index Range",
            "errorMessage": "None (Auto-corrected)",
            "recovery": "Script logic checks 'if (nColor > 255 || nColor < -1)'. If invalid, it resets nColor to 171 automatically."
          },
          {
            "check": "Geometry Vertex Count",
            "errorMessage": "None (Implicit)",
            "recovery": "If a profile results in 0 vertices after tolerance cleaning, it is effectively skipped in the drawing loops (empty array)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add Extra Beams",
            "how": "Right-click context menu -> 'Select extra Beams'",
            "effect": "Appends newly selected beams to the existing set, re-runs the duplicate check, re-analyzes profiles, and redraws the report to include new data."
          },
          {
            "action": "Modify Report Layout",
            "how": "Change OPM properties (dOffset, nColumn, dTolerance, etc.)",
            "effect": "Triggers full recalculation. Adjusts spacing, column counts, or matching logic. If Tolerance changes, profile grouping may shift, changing the quantity counts and labels assigned to beams."
          },
          {
            "action": "Update Beam Data",
            "how": "Change sMaterial, sNewGrade, or sLabel in OPM",
            "effect": "Re-applies these new values to all beams currently filtered into the _Beam array."
          }
        ]
      },
      "tokens_used": 10556,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_Beam Profile Output.mcr\n\n## Overview\nThis script analyzes selected beams to identify unique, non-rectangular cross-section profiles. It generates a 2D visual report in Model Space displaying these profiles with dimensions and quantities, while simultaneously updating the material, grade, and label properties of the processed beams.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script inserts into Model Space to generate the report graphics. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: GenBeams (Timber beams).\n- **Minimum Beam Count**: 1.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nExecute the AutoCAD command `TSLINSERT` and select `hsb_Beam Profile Output.mcr` from the file dialog.\n\n### Step 2: Set Report Location\n```\nCommand Line: Select the point where is going to be located the report\nAction: Click in the Model Space to define the top-left origin of the report.\n```\n\n### Step 3: Select Beams\n```\nCommand Line: Select a set of beams\nAction: Select the desired beams from the drawing and press Enter.\n```\n*Note: Once selected, the script processes the beams and generates the report graphics.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Report Layout** |\n| Distance between Profiles | Number | 600 | Vertical spacing (mm) between rows of profile drawings. |\n| Text Offset | Number | 300 | Distance (mm) between the profile center and its label text. |\n| Columns | Number | 5 | Number of unique profiles displayed horizontally before wrapping to a new row. |\n| Color | Number | 90 | AutoCAD Color Index (1-255) for the profile geometry and dimensions. |\n| DimStyle | String | _DimStyles | The dimension style used for the report dimensions. |\n| **Profile Analysis** |\n| Tolerance | Number | 1 | Matching sensitivity (mm). Vertices within this distance are treated as identical. |\n| Display Mode Chain | String | Parallel | Orientation of dimensions (`Parallel`, `Perpendicular`, or `None`). |\n| Angle Text Height | Number | 20 | Text height (mm) for angle annotations. |\n| Angle Offset | Number | 10 | Distance (mm) that angle text is offset from the corner vertex. |\n| **Beam Properties** |\n| New Material | String | Profiled Timber | Assigns this material name to all processed beams. |\n| New Grade | String | C24 | Assigns this grade to all processed beams. |\n| New Label prefix | String | PT | Prefix used to name profile groups (e.g., PT1, PT2). |\n| **Filters** |\n| Filter Message 1 | String | STEEL | Beams with this Grade are excluded from the report. |\n| Filter Message 2 | String | - | Additional Grade filter for exclusion. |\n| Filter Message 3 | String | ? | Additional Grade filter for exclusion. |\n| Filter Message 4 | String | ? | Additional Grade filter for exclusion. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Select extra Beams** | Prompts you to select additional beams from the model. The script adds these to the existing set, re-calculates the unique profiles, updates quantities, and refreshes the report. |\n\n## Settings Files\n- None.\n\n## Tips\n- **Filtering Standard Beams**: This script automatically ignores standard rectangular beams (4 vertices with 90° corners) to focus only on complex or profiled items.\n- **Grouping Logic**: If your report shows too many unique profiles that look identical, try increasing the **Tolerance** value. This helps group beams that have minor modeling discrepancies.\n- **Excluding Non-Timber**: Use the **Filter Message** properties (e.g., set to \"STEEL\") to automatically ignore steel plates or connectors when selecting a large group of entities.\n\n## FAQ\n- **Q: Why did the script delete itself immediately?**\n  - A: This happens if no beams were selected, or if all selected beams were filtered out (e.g., they matched the \"STEEL\" filter or were standard rectangles).\n- **Q: Can I move the report after it is created?**\n  - A: Yes, the report is standard AutoCAD geometry (lines and text). You can use standard AutoCAD Move commands to reposition it. Note that regenerating the script (via right-click menu) will redraw it at the original insertion point unless you move the script instance.\n- **Q: The dimensions are cluttering the drawing.**\n  - A: Change the **Display Mode Chain** property to `None` to suppress dimensions and show only the profile outlines."
      },
      "tokens_used": 6859,
      "error": null
    }
  }
}