{
  "filename": "TaperedInsulation.mcr",
  "status": "completed",
  "total_tokens": 53828,
  "processing_time": 360.5956246852875,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": null,\n  \"versionHistory\": [\n    {\n      \"version\": \"3.7\",\n      \"date\": \"25.09.2024\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"Fix for \\\"Free form\\\" type\"\n    },\n    {\n      \"version\": \"3.6\",\n      \"date\": \"08.03.2023\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-17501: Fix translation\"\n    },\n    {\n      \"version\": \"3.5\",\n      \"date\": \"12.01"
      },
      "tokens_used": 9188,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script creates and manipulates 3D Body objects ('Body bdUnderneath', 'addVolume'), interacts with 3D entities ('Slab', 'TslInst'), and performs 3D geometric calculations ('Plane', 'Vector3d', 'CoordSys'). No Paper Space or Shop Drawing specific commands (sd_, #Type E, _Viewport) are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "Slab",
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space",
          "requiredSettings": [
            "TaperedInsulation.xml (located in _kPathHsbCompany\\\\TSL\\\\Settings or _kPathHsbInstall\\\\Content\\\\General\\\\TSL\\\\Settings)"
          ]
        }
      },
      "tokens_used": 6953,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [],\n    \"keywordOptions\": [],\n    \"runtimeInteractions\": [\n      {\n        \"step\": 1,\n        \"function\": \"getEntity\",\n        \"promptOriginal\": \"T(\\\"|Select Entity|\\\")\",\n        \"condition\": \"_bOnRecalc && _kExecuteKey==sTriggerAlignToEntity\",\n        \"context\": \"Align To Entity\"\n      }\n    ]\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Type|\",\n      \"defaultValue\": \"|Free definition|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Free definition|\",\n        \"|Roof shape|\",\n        \"|Gradient insulation|\"\n      ],\n      \"category\": \"|Type|\",\n      \"description\": \"|Defines the type of the tapered insulation.|\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dZheight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Elevation|\",\n      \"defaultValue\": \"U(0)\",\n      \"inputType\": \"number\",\n      \"category\": \"|Position|\",\n      \"description\": \"|Defines the elevation.|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Thickness|\",\n      \"defaultValue\": \"U(30)\",\n      \"inputType\": \"number\",\n      \"category\": \"|Position|\",\n      \"description\": \"|Defines the height/thickness of insulation.|\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dSlope\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Slope| %\",\n      \"defaultValue\": \"U(0)\",\n      \"inputType\": \"number\",\n      \"category\": \"|Position|\",\n      \"description\": \"|Defines the slope of the insulation in %.|\"\n    },\n    {\n      \"index\": 3,\n"
      },
      "tokens_used": 10164,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates 3D solid geometry representing tapered or flat insulation layers on roofs or floors, including drainage slopes and height restrictions.",
          "category": "Modeling / Accessories",
          "typicalUseCase": "Used to model thermal insulation on flat roof structures where water drainage (fall) is required, or to visualize insulation thicknesses in 3D and section views."
        },
        "parameters": [
          {
            "name": "sType",
            "technicalDefault": "|Free definition|",
            "businessMeaning": "Specifies the geometric logic for generating the insulation volume. 'Free definition' creates a block of uniform thickness based on the outline. 'Roof shape' and 'Gradient insulation' apply slopes to the top surface for drainage.",
            "validRange": "Free definition, Roof shape, Gradient insulation",
            "unit": "Enum",
            "affectsOutput": "Determines how the top surface of the insulation is calculated (flat vs. sloped)."
          },
          {
            "name": "dZheight",
            "technicalDefault": "U(0)",
            "businessMeaning": "The vertical elevation of the bottom surface of the insulation layer relative to the current coordinate system or the construction element it sits on.",
            "validRange": "0 to 10000+",
            "unit": "mm",
            "affectsOutput": "Vertically positions the entire insulation volume in 3D space."
          },
          {
            "name": "dHeight",
            "technicalDefault": "U(30)",
            "businessMeaning": "The nominal thickness of the insulation material at its thinnest or starting point.",
            "validRange": "20 to 500",
            "unit": "mm",
            "affectsOutput": "Defines the thickness of the 3D solid. In gradient types, this acts as the base thickness at the low point."
          },
          {
            "name": "dSlope",
            "technicalDefault": "U(0)",
            "businessMeaning": "The incline of the top surface for water drainage, expressed as a percentage (e.g., 2% slope).",
            "validRange": "0 to 20",
            "unit": "%",
            "affectsOutput": "Modifies the top face of the insulation volume to create a fall direction, increasing thickness towards the high side."
          },
          {
            "name": "dSlopeGrad",
            "technicalDefault": "U(0)",
            "businessMeaning": "The incline of the top surface expressed in degrees.",
            "validRange": "0 to 45",
            "unit": "degrees",
            "affectsOutput": "Alternative input method for defining the drainage fall; creates the same geometric taper as percentage slope."
          },
          {
            "name": "dHeightMax",
            "technicalDefault": "U(0)",
            "businessMeaning": "A constraint that caps the maximum thickness of the insulation. If the slope calculation exceeds this height, the volume is cut off horizontally.",
            "validRange": "0 to 1000",
            "unit": "mm",
            "affectsOutput": "Creates a horizontal 'cut' or step in the insulation volume at the specified height to fit under parapets or structural constraints."
          },
          {
            "name": "sDisplayStyle",
            "technicalDefault": "From XML",
            "businessMeaning": "Determines the visual appearance (color, layer, hatching) of the insulation volume based on company CAD standards defined in the XML settings.",
            "validRange": "Styles defined in TaperedInsulation.xml",
            "unit": "Enum",
            "affectsOutput": "Changes graphical properties (pen color, layer) of the 3D Body and section hatches."
          },
          {
            "name": "sLegend",
            "technicalDefault": "|No|",
            "businessMeaning": "Controls the visibility of the text label or tag identifying the insulation volume.",
            "validRange": "Yes, No",
            "unit": "Enum",
            "affectsOutput": "Toggles the creation and visibility of text labels in the model."
          },
          {
            "name": "sNumber",
            "technicalDefault": "",
            "businessMeaning": "A unique identifier or index for the insulation piece, used for scheduling or BIM data.",
            "validRange": "Alphanumeric string",
            "unit": "String",
            "affectsOutput": "Updates the text content of the legend/label."
          },
          {
            "name": "sName",
            "technicalDefault": "",
            "businessMeaning": "Descriptive name of the material (e.g., 'PIR Board 100mm').",
            "validRange": "Alphanumeric string",
            "unit": "String",
            "affectsOutput": "Updates the text content of the legend/label."
          },
          {
            "name": "sMaterial1",
            "technicalDefault": "",
            "businessMeaning": "Defines the material composition of the first layer.",
            "validRange": "Alphanumeric string",
            "unit": "String",
            "affectsOutput": "Used for labeling and potentially data extraction."
          },
          {
            "name": "sMaterial2",
            "technicalDefault": "",
            "businessMeaning": "Defines the material composition of the second layer (if applicable).",
            "validRange": "Alphanumeric string",
            "unit": "String",
            "affectsOutput": "Used for labeling and potentially data extraction."
          },
          {
            "name": "bShowHatch",
            "technicalDefault": "Yes (Implicit)",
            "businessMeaning": "Toggles the hatching pattern representation of the insulation in views.",
            "validRange": "Yes, No",
            "unit": "Bool",
            "affectsOutput": "Enables or disables hatch patterns on the 3D Body or in section views."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sType is changed to 'Free definition'",
            "effect": "The geometry generation ignores slope calculations (dSlope/dSlopeGrad) and creates a constant thickness volume.",
            "cascade": [
              "dSlope",
              "dSlopeGrad",
              "dHeightMax"
            ]
          },
          {
            "trigger": "dSlope or dSlopeGrad is set > 0",
            "effect": "The insulation becomes tapered (thicker on one side). The 'dHeightMax' parameter becomes active to prevent the insulation from becoming too thick.",
            "cascade": [
              "dHeightMax",
              "Geometry Top Surface"
            ]
          },
          {
            "trigger": "Context command 'Align To Entity' is used",
            "effect": "The script recalculates its base coordinate system (Z-elevation) to match the selected Slab or TslInst.",
            "cascade": [
              "dZheight",
              "Geometry Base Plane"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (3D Solid)",
            "description": "The physical representation of the insulation volume, potentially tapered for drainage.",
            "appliedTo": "Model Space (associated with the insertion point and polyline outline)"
          },
          {
            "type": "Text/Label",
            "description": "Annotation displaying Name, Number, and Material info if Legend is enabled.",
            "appliedTo": "Model Space"
          },
          {
            "type": "Section Hatch",
            "description": "2D hatching representation for section views, controlled by display styles.",
            "appliedTo": "Section Views"
          }
        ]
      },
      "tokens_used": 9806,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Insert Script into Model Space (defining initial position and outline)",
          "Script initializes and loads default properties from XML settings",
          "[Loop] User adjusts properties in Properties Palette (Type, Height, Slope, etc.)",
          "Script recalculates geometry based on current properties and outline",
          "[Conditional] Generate Body (Flat or Tapered) based on 'sType'",
          "[Conditional] Apply 'Max Height' cut-off if 'dHeightMax' is active",
          "Create Visual Representation (Body, Hatching, Legends)",
          "[Conditional] User invokes 'Align To Entity' to reposition relative to Slab/TslInst",
          "[Conditional] User invokes 'Align Faces' to match vertical edges with underlying structure"
        ],
        "conditionalBranches": [
          {
            "condition": "Selection of property 'sType' (Type)",
            "path1": {
              "name": "Free definition",
              "steps": [
                "Ignore slope parameters (dSlope, dSlopeGrad)",
                "Generate a constant thickness volume defined by 'dHeight'",
                "Top surface is parallel to the base plane"
              ]
            },
            "path2": {
              "name": "Roof shape or Gradient insulation",
              "steps": [
                "Calculate top surface slope based on 'dSlope' or 'dSlopeGrad'",
                "Generate tapered volume (thicker on one side)",
                "Apply 'dHeightMax' constraint if the calculated thickness exceeds the limit"
              ]
            }
          },
          {
            "condition": "Usage of 'Align To Entity' command",
            "path1": {
              "name": "Entity Selected (Slab or TslInst)",
              "steps": [
                "Script verifies entity type",
                "Update internal Map to store reference to 'TslAlign'",
                "Remove existing manual plane definition ('ptPlane', 'vecPlane')",
                "Recalculate geometry aligned to the entity's top surface"
              ]
            },
            "path2": {
              "name": "Invalid Entity Selected",
              "steps": [
                "Display error: 'A slab or a tsl RUB-Raum is needed'",
                "Cancel alignment operation"
              ]
            }
          },
          {
            "condition": "Geometric Overlap with Underlying Entity",
            "path1": {
              "name": "Edges Match (Within Epsilon)",
              "steps": [
                "Enable 'Align Faces' context menu command",
                "If executed, toggle vertical face alignment to match underlying entity geometry"
              ]
            },
            "path2": {
              "name": "No Edge Match",
              "steps": [
                "Hide 'Align Faces' context menu command",
                "Retain current vertical wall orientation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity selected during 'Align To Entity'",
            "errorMessage": "A slab or a tsl RUB-Raum is needed",
            "recovery": "Select a valid Slab element or a compatible TSL Instance (e.g., RUB-Raum) and retry the command."
          },
          {
            "check": "Settings XML File",
            "errorMessage": "Notice shown if XML version differs between installation and company path",
            "recovery": "User is informed of version mismatch; usually requires admin to update XML files or accept current defaults."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Geometry Parameters",
            "how": "Properties Palette (OPM)",
            "effect": "Updates thickness, slope, elevation, or max height, triggering a full regeneration of the 3D Body."
          },
          {
            "action": "Change Display Style",
            "how": "Properties Palette (Display Category)",
            "effect": "Updates layer, color, and hatch patterns based on styles defined in TaperedInsulation.xml."
          },
          {
            "action": "Align to Structure",
            "how": "Right-click Context Menu -> 'Align To Entity'",
            "effect": "Prompts user to select a Slab or TSL. The insulation volume moves and rotates to sit on top of the selected element."
          },
          {
            "action": "Align Vertical Faces",
            "how": "Right-click Context Menu -> 'Align Faces' (Only visible if edges overlap)",
            "effect": "Modifies the vertical sides of the insulation volume to match the underlying structure's walls/edges."
          },
          {
            "action": "Edit Shape (Grips)",
            "how": "Drag Grip Points in Model Space",
            "effect": "Modifies the outline polyline (PLine) of the insulation, stretching or reshaping the volume."
          },
          {
            "action": "Edit Labels",
            "how": "Properties Palette (Display Category)",
            "effect": "Updates the text content (Number, Name, Material) if 'Legend' is set to 'Yes'."
          }
        ]
      },
      "tokens_used": 10733,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# TaperedInsulation.mcr\n\n## Overview\nThis script generates 3D solid geometry representing tapered or flat insulation layers on roofs or floors. It allows for the creation of drainage slopes (falls), height restrictions, and material labeling for thermal modeling and detailing.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script creates 3D Body objects and interacts with 3D entities like Slabs. |\n| Paper Space | No | This script does not generate 2D drawings directly in Paper Space. |\n| Shop Drawing | No | Not intended for shop drawing generation. |\n\n## Prerequisites\n- **Required Entities**: A Slab or TslInst (e.g., RUB-Raum) is required if using the \"Align To Entity\" feature.\n- **Minimum Beam Count**: 0 (This script does not require beams).\n- **Required Settings Files**: `TaperedInsulation.xml` (Located in `_kPathHsbCompany\\TSL\\Settings` or `_kPathHsbInstall\\Content\\General\\TSL\\Settings`).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse the script list and select `TaperedInsulation.mcr`.\n\n### Step 2: Insert and Position\n```\nCommand Line: [Insertion point]\nAction: Click in the Model Space to place the insulation instance.\n```\n*Note: Upon insertion, a default rectangular insulation block is created. You can adjust its position and shape immediately using grip points.*\n\n### Step 3: Define Geometry\nAction: Use the **Properties Palette** (Ctrl+1) to adjust the insulation type, thickness, and slope. Use **Grips** on the corners to stretch or reshape the insulation outline to match your roof or floor area.\n\n### Step 4: Align to Structure (Optional)\nAction: Right-click the insulation instance and select **Align To Entity**.\n```\nCommand Line: Select Entity\nAction: Click on the structural Slab or TSL instance you want the insulation to sit on.\n```\n*Result: The insulation moves and rotates to match the top surface of the selected element.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Type** | Dropdown | Free definition | Defines the generation logic. Options: *Free definition* (constant thickness), *Roof shape*, or *Gradient insulation* (sloped). |\n| **Elevation** | Number | 0 | The vertical elevation (Z-height) of the bottom surface of the insulation. |\n| **Thickness** | Number | 30 mm | The nominal height/thickness of the insulation at its lowest or starting point. |\n| **Slope** | Number | 0 % | The incline of the top surface for drainage, expressed as a percentage. |\n| **Slope Grad** | Number | 0 deg | The incline of the top surface expressed in degrees (alternative to %). |\n| **Max Height** | Number | 0 mm | A constraint that caps the maximum thickness. If the slope calculation exceeds this height, the volume is cut off horizontally (useful for parapets). |\n| **Display Style** | Dropdown | From XML | Determines the visual appearance (color, layer, hatching) based on company standards. |\n| **Legend** | Dropdown | No | Toggles the visibility of the text label (Name, Number, Material) in the model. |\n| **Number** | Text | - | Unique identifier or index for the insulation piece. |\n| **Name** | Text | - | Descriptive name of the material (e.g., 'PIR Board 100mm'). |\n| **Material 1** | Text | - | Defines the material composition of the first layer. |\n| **Material 2** | Text | - | Defines the material composition of the second layer (if applicable). |\n| **Show Hatch** | Boolean | Yes | Toggles the hatching pattern representation of the insulation in views. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Align To Entity** | Prompts you to select a Slab or compatible TSL. The insulation will automatically move and rotate to sit on top of the selected element. |\n| **Align Faces** | (Only visible if edges overlap) Modifies the vertical sides of the insulation volume to match the underlying structure's walls or edges. |\n\n## Settings Files\n- **Filename**: `TaperedInsulation.xml`\n- **Location**: `_kPathHsbCompany\\TSL\\Settings` (Company overrides) or `_kPathHsbInstall\\Content\\General\\TSL\\Settings` (Default).\n- **Purpose**: Defines the visual styles (colors, layers, hatch patterns) available in the \"Display Style\" property dropdown.\n\n## Tips\n- **Editing Shape**: Use the grip points on the inserted insulation block to stretch or reshape the outline to fit complex roof perimeters.\n- **Creating Falls**: Set **Type** to \"Roof shape\" or \"Gradient insulation\" and enter a value in **Slope (%)**. The script will automatically calculate the tapered top surface.\n- **Restricting Thickness**: If your slope makes the insulation too thick at the high end, use the **Max Height** property to cut it off flat at the desired level.\n- **Data Extraction**: Fill in the **Number**, **Name**, and **Material** fields to create data-rich labels that can be exported to BIM schedules or visible in 3D views if **Legend** is set to \"Yes\".\n\n## FAQ\n- **Q: Why is the \"Align Faces\" option missing from the right-click menu?**\n  A: This option only appears when the insulation outline edges overlap exactly (within a small tolerance) with the edges of the entity beneath it. Ensure your insulation outline is aligned to the underlying slab edges.\n- **Q: How do I switch between a flat insulation board and a tapered one?**\n  A: Change the **Type** property in the Properties Palette. Select \"Free definition\" for a flat board, or \"Roof shape\" for a tapered drainage slope.\n- **Q: What happens if I see a version mismatch notice?**\n  A: This indicates that the `TaperedInsulation.xml` file in your Company folder differs from the installation default. You generally do not need to fix this, but consult your CAD Manager if default styles are missing."
      },
      "tokens_used": 6984,
      "error": null
    }
  }
}