{
  "filename": "Klingschrot.mcr",
  "status": "completed",
  "total_tokens": 51608,
  "processing_time": 214.1630916595459,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates a logwall connection of type Klingschrot. It requires a special tool with a radius of 175mm and a tool lwidth of 80mm",
        "versionHistory": [
          {
            "version": "1.3",
            "date": "20.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-17520 T-Connection Seat Tolerance increased"
          },
          {
            "version": "1.2",
            "date": "20.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-17520 tool properties set to static values. Seatcuts added as individual tools"
          },
          {
            "version": "1.1",
            "date": "07.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-17520 initial version of log connection of type Klingschrot"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8087,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "int bForceModelSpace = true; found in tslNew.dbCreate call. Script modifies 3D beam geometry using b.addTool() and BeamCut definitions. ElementLog selection via PrEntity."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementLog"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7355,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "!(_kExecuteKey.length()>0 && TslInst().getListOfCatalogNames(scriptName()).findNoCase(_kExecuteKey,-1)>-1)",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Select elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Standard Properties Dialog",
            "trigger": "Insertion (if no ExecuteKey provided)",
            "title": null,
            "dataSource": "PropDouble/PropString declarations",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dBaseHeight",
            "type": "PropDouble",
            "displayName": "Base Height",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the base height of the connection"
          },
          {
            "index": 1,
            "variable": "dEndHeight",
            "type": "PropDouble",
            "displayName": "End Height",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the maximal height of the connection0 = automatic"
          },
          {
            "index": 2,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "Seat width",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Seatcut / Tapering",
            "description": "The width of the seat cut or the diagonal milling."
          },
          {
            "index": 3,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "Seat depth",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Seatcut / Tapering",
            "description": "The width of the seat cut or the diagonal milling, Negative values forcing an additional beamcut."
          },
          {
            "index": 4,
            "variable": "sType",
            "type": "PropString",
            "displayName": "Type",
            "defaultValue": "Concave",
            "inputType": "dropdown",
            "options": [
              "Concave",
              "Convex",
              "Diagonal"
            ],
            "category": "Seatcut / Tapering",
            "description": "Defines the Type"
          },
          {
            "index": 5,
            "variable": "dVerticalOffset",
            "type": "PropDouble",
            "displayName": "Vertical Offset",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Tool",
            "description": "Moves the tool in vertical direction"
          },
          {
            "index": 6,
            "variable": "sOrientation",
            "type": "PropString",
            "displayName": "Orientation T-Connection|",
            "defaultValue": "Positive",
            "inputType": "dropdown",
            "options": [
              "Positive",
              "Negative"
            ],
            "category": "Tool",
            "description": "Defines the orientation on t-connections, which can also be toggle by a double click"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Swap Direction",
            "handler": "Swap Direction",
            "action": "Toggles the orientation of the T-Connection",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "Remove Logs from Connection",
            "handler": "Remove Logs from Connection",
            "action": "Excludes selected logs from the tooling process",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Restore all logs of Connection",
            "handler": "Restore all logs of Connection",
            "action": "Re-includes previously removed logs",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Grip Point Drag",
            "handler": "_Grip",
            "action": "Adjusts connection geometry interactively",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8470,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation of 'Klingschrot' log wall connections, machining complex profiles and seat cuts to join intersecting log walls.",
          "category": "Machining / Joinery",
          "typicalUseCase": "Creating structurally interlocking corners or T-connections in log wall construction using a specific milling tool radius (175mm) and width (80mm)."
        },
        "parameters": [
          {
            "name": "dBaseHeight",
            "technicalDefault": "0",
            "businessMeaning": "Defines the vertical starting point (elevation) for the machining operation relative to the bottom of the log wall.",
            "validRange": "0mm to Wall Height",
            "unit": "mm",
            "affectsOutput": "Determines the lower bound of the tooling. Logs below this height remain uncut."
          },
          {
            "name": "dEndHeight",
            "technicalDefault": "0",
            "businessMeaning": "Defines the vertical stopping point (elevation) for the machining. A value of 0 extends the tooling to the top of the wall automatically.",
            "validRange": "0mm to Wall Height (0 = Auto)",
            "unit": "mm",
            "affectsOutput": "Determines the upper bound of the tooling. Restricts the connection to a specific vertical segment if set."
          },
          {
            "name": "dWidth",
            "technicalDefault": "0",
            "businessMeaning": "Specifies the width of the horizontal seat cut (bearing surface) at the connection, particularly relevant for T-connections.",
            "validRange": "0mm to 200mm (Typically 1/3 of log width)",
            "unit": "mm",
            "affectsOutput": "If > 0, adds a planar BeamCut to create a flat seat for the intersecting log to rest on."
          },
          {
            "name": "dDepth",
            "technicalDefault": "0",
            "businessMeaning": "Specifies the penetration depth of the seat cut or tapering. Negative values force an additional beam cut operation.",
            "validRange": "-50mm to 150mm",
            "unit": "mm",
            "affectsOutput": "Controls how deep the seat cut removes material. Influences the structural bearing area."
          },
          {
            "name": "sType",
            "technicalDefault": "Concave",
            "businessMeaning": "Selects the geometric profile of the log connection: 'Concave' (standard corner), 'Convex', or 'Diagonal' (angled transition).",
            "validRange": "Concave, Convex, Diagonal",
            "unit": "enum",
            "affectsOutput": "Switches the calculation logic for the milling path. 'Concave' is standard for corners; 'Diagonal' creates sloped transitions."
          },
          {
            "name": "dVerticalOffset",
            "technicalDefault": "0",
            "businessMeaning": "Shifts the milling tool vertically up or down from its calculated center position.",
            "validRange": "-50mm to 50mm",
            "unit": "mm",
            "affectsOutput": "Fine-tunes the vertical alignment of the Klingschrot profile without altering the base/end height limits."
          },
          {
            "name": "sOrientation",
            "technicalDefault": "Positive",
            "businessMeaning": "Defines the direction of the T-connection tooling (e.g., which side of the main wall the intersecting log connects to).",
            "validRange": "Positive, Negative",
            "unit": "enum",
            "affectsOutput": "Mirrors the tool geometry across the reference axis. Toggled via double-click or properties."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Script detects a T-Connection (perpendicular intersection)",
            "effect": "Locks 'sType' to 'Concave' and hides 'Convex' and 'Diagonal' options as they are not supported for T-connections.",
            "cascade": [
              "sType"
            ]
          },
          {
            "trigger": "sType changes to 'Diagonal'",
            "effect": "Activates the diagonal seat cutting logic (BeamCut bc0D, bc1D) instead of the standard vertical seat cuts.",
            "cascade": [
              "bHasDiagonalSeat"
            ]
          },
          {
            "trigger": "dWidth > 0 in T-Connection mode",
            "effect": "Generates two parallel BeamCuts (bc0, bc02) to create a defined width seat for the intersecting log.",
            "cascade": [
              "bHasWidth",
              "bc0",
              "bc02"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Milling Operation (Klingschrot)",
            "description": "A specialized 3D profile milled into the logs using a static tool radius (175mm) and width (80mm) to allow logs to interlock.",
            "appliedTo": "Selected Log Walls (ElementLog)"
          },
          {
            "type": "BeamCut (Seatcut)",
            "description": "Planar rectangular or diagonal cuts removing material to create flat bearing surfaces for intersecting logs.",
            "appliedTo": "Selected Log Walls (ElementLog) where dWidth or dDepth is non-zero."
          }
        ]
      },
      "tokens_used": 9355,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Triggered",
          "2. Check Insert Cycle Count (Erase if > 1)",
          "3. Check _kExecuteKey",
          "4. [Branch] Load Catalog Properties OR Show Standard Dialog",
          "5. Prompt User: Select Elements (ElementLog)",
          "6. Set Map 'mode' to 1 (Wall Distribution)",
          "7. Script Recalculation",
          "8. [Mode 1] Iterate Selected Log Walls",
          "9. Check for Perpendicular Intersection between pairs",
          "10. [Branch] If Perpendicular & Intersecting: Create Child TSL Instance (Mode 2) attached to the pair",
          "11. Erase Parent Instance",
          "12. [Mode 2 - Child] Initialize Tool Parameters (Radius 175, Width 80)",
          "13. Detect Connection Type (L vs T)",
          "14. [Branch] Apply Property Restrictions based on T-Connection detection",
          "15. Calculate Seatcut Geometry based on dWidth, dDepth, and sType",
          "16. Iterate through Log Courses",
          "17. [Branch] Check if specific Log is marked for Removal",
          "18. Apply Tools (Klingschrot profile + BeamCuts) to Beams",
          "19. Update Grips and Map Data"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Method (_kExecuteKey presence)",
            "path1": {
              "name": "Catalog Insert",
              "steps": [
                "Detect _kExecuteKey",
                "setPropValuesFromCatalog()",
                "Skip Standard Dialog"
              ]
            },
            "path2": {
              "name": "Manual Insert",
              "steps": [
                "No Key found",
                "Execute showDialog()",
                "User inputs values manually"
              ]
            }
          },
          {
            "condition": "Wall Intersection Geometry (Mode 1)",
            "path1": {
              "name": "Valid Connection",
              "steps": [
                "Walls are Perpendicular",
                "Walls Intersect (Area > Eps)",
                "Create Child Instance (Mode 2)"
              ]
            },
            "path2": {
              "name": "Invalid/Skipped",
              "steps": [
                "Walls are Parallel or Non-Perpendicular",
                "No Intersection Detected",
                "Continue Loop (No TSL created for pair)"
              ]
            }
          },
          {
            "condition": "Connection Type Detection (Mode 2)",
            "path1": {
              "name": "T-Connection",
              "steps": [
                "Set isTConnection flag in Map",
                "Force sType to 'Concave'",
                "Hide sType Property (Read Only)",
                "Calculate specific T-Connection seatcuts"
              ]
            },
            "path2": {
              "name": "L-Connection",
              "steps": [
                "Allow sType: 'Concave', 'Convex', 'Diagonal'",
                "Calculate L-Connection seatcuts"
              ]
            }
          },
          {
            "condition": "Log Exclusion",
            "path1": {
              "name": "Log Included",
              "steps": [
                "Beam not found in bmRemovals list",
                "Calculate Tool position",
                "Apply Klingschrot and BeamCuts"
              ]
            },
            "path2": {
              "name": "Log Excluded",
              "steps": [
                "Beam found in bmRemovals list",
                "Execute continue (Skip Tooling)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selected Entity Type",
            "errorMessage": "Implicit via PrEntity(ElementLog())",
            "recovery": "User must select valid ElementLog entities"
          },
          {
            "check": "Wall Orthogonality",
            "errorMessage": "None (Silent skip)",
            "recovery": "Ensure walls are perpendicular; otherwise, no connection is generated for that pair."
          },
          {
            "check": "Wall Intersection Area",
            "errorMessage": "None (Silent skip if area < 2mm^2)",
            "recovery": "Ensure walls physically touch or overlap sufficiently."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Connection Height",
            "how": "Grip Point Drag (_Grip)",
            "effect": "Updates dBaseHeight and dEndHeight in the Map, recalculating tooling vertical range."
          },
          {
            "action": "Toggle Orientation",
            "how": "Double Click or Context Menu 'Swap Direction'",
            "effect": "Toggles sOrientation between 'Positive' and 'Negative', mirroring the tool geometry."
          },
          {
            "action": "Exclude Specific Logs",
            "how": "Context Menu 'Remove Logs from Connection'",
            "effect": "Adds selected logs to _Map['Log[]']; subsequent recalcs skip tooling on these logs."
          },
          {
            "action": "Modify Seat Geometry",
            "how": "OPM Properties (dWidth, dDepth, sType)",
            "effect": "Updates BeamCut definitions (width, depth, or switching between vertical/diagonal cuts)."
          }
        ]
      },
      "tokens_used": 11358,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Klingschrot.mcr\n\n## Overview\nThis script automates the creation of \"Klingschrot\" log wall connections, machining complex profiles and seat cuts to join intersecting log walls. It utilizes a specialized fixed milling tool (Radius 175mm, Width 80mm) to create structurally interlocking corners or T-connections.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be run in Model Space to modify 3D beam geometry. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | This is a model generation script, not a drawing annotation tool. |\n\n## Prerequisites\n- **Required Entities**: `ElementLog` (Log Walls)\n- **Minimum Beams**: 2 intersecting or touching log walls.\n- **Required Settings**: None (Tool properties are static within the script).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse and select `Klingschrot.mcr`.\n3. Click Open.\n\n### Step 2: Select Log Walls\n```\nCommand Line: Select elements\nAction: Click on the log walls you wish to connect. Press Enter to confirm selection.\n```\n*Note: The script will automatically detect pairs of walls. Connections are only generated if walls are perpendicular and intersecting.*\n\n### Step 3: Configure Properties\n1. After selection, the script instances are created.\n2. Select a connection instance in the model.\n3. Open the **Properties Palette** (Ctrl+1) to adjust parameters such as Base Height, End Height, or Seat Width.\n\n### Step 4: Adjust Geometry\n- Use **Grip Points** to visually drag and adjust the connection height.\n- **Double-click** on a connection to toggle its orientation (Positive/Negative).\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| dBaseHeight | Number | 0 | Defines the vertical starting point (elevation) for the machining operation relative to the bottom of the log wall. |\n| dEndHeight | Number | 0 | Defines the vertical stopping point. A value of 0 extends the tooling to the top of the wall automatically. |\n| dWidth | Number | 0 | Specifies the width of the horizontal seat cut (bearing surface) at the connection. |\n| dDepth | Number | 0 | Specifies the penetration depth of the seat cut. Negative values force an additional beam cut operation. |\n| sType | Dropdown | Concave | Selects the geometric profile: Concave (standard corner), Convex, or Diagonal (angled transition). *Note: Convex and Diagonal are hidden for T-connections.* |\n| dVerticalOffset | Number | 0 | Shifts the milling tool vertically up or down from its calculated center position. |\n| sOrientation | Dropdown | Positive | Defines the direction of the T-connection tooling (which side of the main wall the intersecting log connects to). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Swap Direction | Toggles the orientation of the T-Connection between Positive and Negative. This can also be triggered by double-clicking the instance. |\n| Remove Logs from Connection | Excludes specific selected logs from the tooling process. Useful if a log should not be cut. |\n| Restore all logs of Connection | Re-includes all logs that were previously excluded via the remove option. |\n| Grip Point Drag | Activates interactive adjustment of the connection geometry via grip points in the drawing. |\n\n## Settings Files\n- **Catalog Usage**: The script supports loading properties from a catalog if executed via a specific Execute Key (`_kExecuteKey`).\n- **Location**: Standard hsbCAD Catalog paths.\n- **Purpose**: To apply pre-defined connection configurations (e.g., specific seat depths or heights) automatically without manual input.\n\n## Tips\n- **Perpendicular Walls**: Ensure your log walls are drawn perfectly perpendicular (90 degrees). The script silently skips non-perpendicular intersections.\n- **T-Connection Behavior**: On T-connections, the `sType` is automatically locked to \"Concave\". If you need a Convex or Diagonal profile, ensure you are working on a corner (L-connection).\n- **Grip Editing**: You can visually adjust the `dBaseHeight` and `dEndHeight` by selecting the script instance and dragging the triangular grip points up or down.\n- **Double-Click**: Quickly flip the orientation of a T-connection by double-clicking the script instance, rather than changing the property manually.\n\n## FAQ\n- **Q: I selected the walls, but no tooling appeared. Why?**\n  - A: The script only generates connections for perpendicular, intersecting walls. Ensure your walls cross each other and are not parallel. Also, ensure the intersection area is sufficient.\n- **Q: Can I change the tool radius from 175mm?**\n  - A: No, the tool radius (175mm) and width (80mm) are static values embedded in the script to match the physical \"Klingschrot\" tooling requirements.\n- **Q: What does a negative `dDepth` value do?**\n  - A: A negative depth forces the script to perform an additional beam cut operation, which is sometimes required to clear material completely for specific joint geometries.\n- **Q: How do I stop the connection from cutting the top few logs?**\n  - A: Set the `dEndHeight` property to the specific elevation where you want the cutting to stop."
      },
      "tokens_used": 6983,
      "error": null
    }
  }
}