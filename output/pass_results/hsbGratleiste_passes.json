{
  "filename": "hsbGratleiste.mcr",
  "status": "completed",
  "total_tokens": 28545,
  "processing_time": 607.4905962944031,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.2",
            "date": "15may15",
            "author": "th@hsbCAD.de",
            "changes": "catalog based insertion enabled"
          },
          {
            "version": "1.1",
            "date": "08.07.2010",
            "author": "th@hsbCAD.de",
            "changes": "bugfix"
          },
          {
            "version": "1.0",
            "date": "19.07.2010",
            "author": "th@hsbCAD.de",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4953,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No Paper Space specific calls (e.g., _Viewport, sd_*) found. Script manipulates 3D geometry using GenBeam and Element objects. Uses _bOnInsert logic typical of ModelSpace insertions."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "The script requires Beams assigned to a valid Element to determine coordinate systems (vecX/Y/Z).",
          "requiredSettings": []
        }
      },
      "tokens_used": 2279,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select Beams|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select Insertion Point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Standard Properties Dialog",
            "trigger": "Insertion if _kExecuteKey is empty",
            "title": null,
            "dataSource": "Local script properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dDoveD",
            "type": "PropDouble",
            "displayName": "|Dovetail Depth|",
            "defaultValue": "U(14)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dDoveW",
            "type": "PropDouble",
            "displayName": "|Dovetail Width|",
            "defaultValue": "U(8.7)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "167",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 4952,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a continuous sliding dovetail joint (Gratleiste) connecting multiple sub-beams, generating machining grooves in the beams and a visual representation of the connecting strip.",
          "category": "Connection/Framing",
          "typicalUseCase": "Mechanically connecting floorboards, decking, or roofing layers to supporting joists using a continuous wooden spline strip."
        },
        "parameters": [
          {
            "name": "dDoveD",
            "technicalDefault": "U(14)",
            "businessMeaning": "Depth of the dovetail groove (and thickness of the connecting strip). Determines how deep the machine cuts into the beams.",
            "validRange": "10.0 - 40.0",
            "unit": "mm",
            "affectsOutput": "Changes the depth of the groove tooling on beams and the Z-height/thickness of the visualized strip."
          },
          {
            "name": "dDoveW",
            "technicalDefault": "U(8.7)",
            "businessMeaning": "Width of the dovetail groove at its narrowest point or the width of the connecting strip.",
            "validRange": "6.0 - 20.0",
            "unit": "mm",
            "affectsOutput": "Changes the width of the groove tooling and the Y-width of the visualized strip."
          },
          {
            "name": "nColor",
            "technicalDefault": "167",
            "businessMeaning": "Display color index for the visualized connecting strip.",
            "validRange": "0 - 255",
            "unit": "ACI (AutoCAD Color Index)",
            "affectsOutput": "Alters the color of the drawn strip in the 3D model and 2D drawings."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Increase in dDoveD",
            "effect": "Requires sufficient beam material thickness (dD(vz)). If Depth > BeamThickness, the tooling will fail or cut through the beam completely.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Dove (Machining)",
            "description": "A dovetail groove cut into the selected beams.",
            "appliedTo": "The set of beams selected during insertion (_Beam)."
          },
          {
            "type": "Body (Visualization)",
            "description": "A 3D body representing the physical wooden strip (Gratleiste) inserted into the grooves, subtracted at element openings.",
            "appliedTo": "The Element containing the beams."
          }
        ]
      },
      "tokens_used": 5766,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization and variable declaration",
          "Check Insertion State (_bOnInsert)",
          "Check insertCycleCount to prevent duplicate processing",
          "Check for Catalog Key (_kExecuteKey)",
          "Display Properties Dialog (if no Catalog Key provided)",
          "Prompt User to Select Beams (PrEntity)",
          "Prompt User to Select Insertion Point (getPoint)",
          "Script Recalculation/Execution",
          "Validate Element Assignment of selected Beams",
          "Extract Coordinate System (vecX, vecY, vecZ) from Element",
          "Sort Beams along X-axis to find Start and End points",
          "Sort Beams along Z-axis to find Top surface for positioning",
          "Calculate and Adjust Insertion Point (_Pt0) to Top Surface",
          "Define Dovetail Tools (dv0, dv1)",
          "Apply Dovetail Tools to Beams based on Z-height relative to Insertion Point",
          "Create Visualization Body for the Dovetail Strip",
          "Subtract Element Openings from the Visualization Body",
          "Draw the Visualization Body in 3D Model",
          "Assign Script to Element Group"
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert is True (First Insertion)",
            "path1": {
              "name": "Insertion Routine",
              "steps": [
                "Check insertCycleCount",
                "Load Catalog or Show Dialog",
                "Select Beams",
                "Select Point",
                "Exit and Wait for Recalc"
              ]
            },
            "path2": {
              "name": "Calculation Routine",
              "steps": [
                "Validate Element",
                "Calculate Geometry",
                "Apply Tools",
                "Draw Body"
              ]
            }
          },
          {
            "condition": "_kExecuteKey (Catalog Key) Presence",
            "path1": {
              "name": "Catalog Insertion",
              "steps": [
                "Read properties from Catalog (_kExecuteKey)",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Insertion",
              "steps": [
                "Show standard Properties Dialog",
                "User enters parameters"
              ]
            }
          },
          {
            "condition": "Insertion Point vs Beam Centroid (Z-axis)",
            "path1": {
              "name": "Upper Beam Processing",
              "steps": [
                "Check if (vz.dotProduct(_Pt0-bm[b].ptCenSolid()) > dEps)",
                "Apply Tool dv1 ( Female Side +vz orientation )"
              ]
            },
            "path2": {
              "name": "Lower Beam Processing",
              "steps": [
                "Apply Tool dv0 ( Female Side -vz orientation )"
              ]
            }
          },
          {
            "condition": "Visualization Length vs 750mm Limit",
            "path1": {
              "name": "Short Strip (<= 750mm)",
              "steps": [
                "Create single Body",
                "Apply Tools",
                "No segmentation needed"
              ]
            },
            "path2": {
              "name": "Long Strip (> 750mm)",
              "steps": [
                "Calculate segment count (x)",
                "Create repeating segments of 750mm",
                "Assemble segments",
                "Cut at final End point"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "insertCycleCount() > 1",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases instance and halts to prevent infinite loops."
          },
          {
            "check": "Beam Selection Empty or Element Invalid",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases instance (eraseInstance) if _Beam.length() < 1 or !el.bIsValid()."
          },
          {
            "check": "Beam Filtering Result",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases instance if filterBeamsPerpendicularSort (Z-axis) returns empty set."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Dimensions (Depth/Width/Color)",
            "how": "OPM (Object Properties Palette)",
            "effect": "Updates dDoveD, dDoveW, or nColor, triggering script recalculation to resize grooves or strip color."
          },
          {
            "action": "Move Insertion Point",
            "how": "Grip Edit (likely _Pt0 grip)",
            "effect": "Repositions the dovetail strip vertically (relative to top beam) and horizontally along the beam length."
          },
          {
            "action": "Modify Geometry of Source Beams",
            "how": "Standard CAD Edit",
            "effect": "Script detects changes in Beam positions/lengths during recalculation, adjusting strip length and tooling positions accordingly."
          },
          {
            "action": "Add/Remove Openings in Element",
            "how": "Element Manager / Opening tools",
            "effect": "Script recalculates and subtracts new openings from the visual strip body."
          }
        ]
      },
      "tokens_used": 5328,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbGratleiste.mcr\n\n## Overview\nThis script creates a continuous sliding dovetail joint (Gratleiste) that connects multiple timber beams. It automatically generates the matching dovetail machining grooves on the selected beams and creates a 3D visual representation of the connecting wooden strip.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script manipulates 3D geometry and beam entities. |\n| Paper Space | No | Not designed for 2D layout or detailing views. |\n| Shop Drawing | No | This is a connection/modeling script, not a drawing generator. |\n\n## Prerequisites\n- **Required Entities**: Beams (GenBeams) assigned to a single Element.\n- **Minimum Beam Count**: 1 (Typically used with multiple beams to form a connection).\n- **Required Settings**: None. The script relies on the Element's coordinate system for orientation.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbGratleiste.mcr` from the file list.\n\n### Step 2: Select Beams\n```\nCommand Line: Select Beams\nAction: Select the timber beams you wish to connect with the dovetail strip and press Enter.\n```\n*Note: Ensure all selected beams belong to the same Element construction.*\n\n### Step 3: Select Insertion Point\n```\nCommand Line: Select Insertion Point\nAction: Click in the drawing to define the start position of the strip.\n```\n*Note: While you define the horizontal (X/Y) location, the script automatically snaps the vertical height (Z) to the top surface of the highest selected beam.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dovetail Depth | Number | U(14) | Sets the depth of the groove cut into the beams and the thickness of the connecting strip (in mm). |\n| Dovetail Width | Number | U(8.7) | Sets the width of the dovetail groove and the connecting strip (in mm). |\n| Color | Number | 167 | Determines the display color of the visualized strip in the model (AutoCAD Color Index). |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom context menu items. Standard AutoCAD/hsbCAD options (Move, Erase, Properties) apply. |\n\n## Settings Files\n- **Filename**: None used.\n\n## Tips\n- **Automatic Height Adjustment**: You do not need to calculate the exact Z-height for the insertion point. Simply click near the beams, and the script will project the point up to the top surface of the top-most beam.\n- **Openings**: If your Element has openings (e.g., for windows or doors), the script will automatically detect them and cut (subtract) the visual strip body at those locations.\n- **Material Thickness**: Ensure your `Dovetail Depth` is smaller than the thickness of your beams to avoid cutting completely through the material.\n- **Long Connections**: For visualization performance, strips longer than 750mm are automatically segmented in the 3D view, but the machining remains continuous.\n\n## FAQ\n- **Q: Why did the script disappear after I selected beams?**\n  - A: This happens if the selected beams are not assigned to a valid Element or if the script detected a duplication issue. Check that your beams are grouped in an Element.\n- **Q: Can I change the size of the strip after inserting?**\n  - A: Yes. Select the script instance, open the Properties palette (Ctrl+1), and modify the `Dovetail Depth` or `Dovetail Width`. The machining and visualization will update automatically.\n- **Q: Does this work on curved beams?**\n  - A: The script sorts beams based on their coordinate system. While it may work on slightly curved layouts, it is designed primarily for linear connections where beams share a consistent orientation."
      },
      "tokens_used": 5267,
      "error": null
    }
  }
}