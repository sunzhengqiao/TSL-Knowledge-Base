{
  "filename": "StackHatch.mcr",
  "status": "completed",
  "total_tokens": 52696,
  "processing_time": 239.1111536026001,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 3,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.3",
            "date": "09.01.2025",
            "author": "Thorsten Huck",
            "changes": "HSB-22814 tolerance of orthogonal faces increased. hidden surface removal improved"
          },
          {
            "version": "1.2",
            "date": "11.12.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22814 hidden surface removal further improved, color index property visible on insert"
          },
          {
            "version": "1.1",
            "date": "05.12.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22814 hidden surface removal and perfomance improved, color rule added"
          },
          {
            "version": "1.0",
            "date": "28.11.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22814 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9201,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Script summary explicitly states 'creates hatchings on shopdrawings'. Code iterates using `MultiPage page`, `page.page()`, and `page.views()`. Uses `ShopDrawView` class and `modelToView()` transformations. Implements logic for `assignToGroups(page, 'T')` which is specific to drawing content management (e.g., non-plotable 'painter' layers)."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView",
            "StackEntity",
            "StackPack",
            "StackItem",
            "StackSpacer"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be run within a MultiPage (Shopdrawing) context where views exist.",
          "requiredSettings": []
        }
      },
      "tokens_used": 7240,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|_Origin of hatchings|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getGenBeam",
              "promptOriginal": "|_Select MultiPage view or single view for hatchings|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "_Pt0",
            "type": "PropPoint",
            "displayName": "|_Origin|",
            "defaultValue": "_Pt0",
            "inputType": "point",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sDisplaySet",
            "type": "PropString",
            "displayName": "|_DisplaySet|",
            "defaultValue": "|_Default|",
            "inputType": "dropdown",
            "options": [
              "|_Default|",
              "|_All Solids|",
              "|_Selection|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 2,
            "variable": "sColor",
            "type": "PropString",
            "displayName": "|_Color|",
            "defaultValue": "|_Entity Color|",
            "inputType": "dropdown",
            "options": [
              "|_Entity Color|",
              "|_By Parent|",
              "|_By Index|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 3,
            "variable": "nColorIndex",
            "type": "PropInt",
            "displayName": "|_Color Index|",
            "defaultValue": 7,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 4,
            "variable": "nTransparency",
            "type": "PropInt",
            "displayName": "|_Transparency|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 5,
            "variable": "bDrawEdge",
            "type": "PropInt",
            "displayName": "|_Draw Edge|",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 6,
            "variable": "nColorEdge",
            "type": "PropInt",
            "displayName": "|_Edge Color|",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 7,
            "variable": "bViewAll",
            "type": "PropInt",
            "displayName": "|_View All|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 8,
            "variable": "bViewOrtho",
            "type": "PropInt",
            "displayName": "|_View Ortho|",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7925,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the creation of 2D hatching and shading for stacked timber elements (packages, pallets) on shop drawings, handling hidden line removal to correctly display overlapping stacks.\",\n    \"category\": \"ShopDrawing\",\n    \"typicalUseCase\": \"Generating clear production drawings for logistics/transport views where stacks of timber need to be visually distinguished or shaded to represent volume, often used in delivery notes or layout plans.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"_Pt0\",\n      \"technicalDefault\": \"_Pt0\",\n      \"businessMeaning\": \"The insertion point/origin for the script logic within the PaperSpace layout. It is automatically updated to the center of the selected view.\",\n      \"validRange\": \"Any 2D coordinate in PaperSpace\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Sets the reference location for the script instance and error messaging.\"\n    },\n    {\n      \"name\": \"sDisplaySet\",\n      \"technicalDefault\": \"|_Default|\",\n      \"businessMeaning\": \"Controls which elements of the stacking structure are included in the hatching process.\",\n      \"validRange\": \"[|_Default|, |_All Solids|, |_Selection|]\",\n      \"unit\": \"Enumeration\",\n      \"affectsOutput\": \"Determines if only individual items are hatched, or if the stack/package containers themselves are also shaded.\"\n    },\n    {\n      \"name\": \"sColor\",\n      \"technicalDefault\": \"|_Entity Color|\",\n      \"businessMeaning\": \"Defines the coloring rule used to fill the hatched areas.\",\n      \"validRange\": \"[|_Entity Color|, |_By Parent|, |_By Index|]\",\n      \"unit\": \"Enumeration\",\n      \"affectsOutput\": \"Visual appearance of the hatch. 'By Parent' helps group items visually by their package/pallet.\"\n    },\n    {\n      \"name\": \"nColorIndex\",\n      \"technicalDefault\": 7,\n      \"businessMeaning\": \"The specific CAD color index used when 'Color' is set to 'By Index'.\",\n      \"validRange\": \"0-255 (standard AutoCAD indices)\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Overrides entity colors with a uniform specific color.\"\n    },\n    {\n      \"name\": \"nTransparency\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Controls the opacity of the hatch, allowing underlying details or overlapping stacks to be seen.\",\n      \"validRange\": \"0 (Opaque) to ~90 (Highly Transparent)\",\n      \"unit\": \"Percent\",\n      \"affectsOutput\": \"Visual clarity of overlaps; higher transparency helps distinguish overlapping layers in complex stacks.\"\n    },\n    {\n      \"name\": \"bDrawEdge\",\n      \"technicalDefault\": 1 (Yes),\n      \"businessMeaning\": \"Toggles the drawing of outline polylines around the hatched areas.\",\n      \"validRange\": \"[0, 1]\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Adds or removes boundary lines around the filled areas.\"\n    },\n    {\n      \"name\": \"nColorEdge\",\n      \"technicalDefault\": -1,\n      \"businessMeaning\": \"Sets the color of the boundary edges. A value of -1 matches the edge color to the hatch fill color.\",\n      \"validRange\": \"-1 (Match Fill) or 0-255\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Color of the outline strokes if 'Draw Edge' is active.\"\n    },\n    {\n      \"name\": \"bViewAll\",\n      \"technicalDefault\": 0 (No),\n      \"businessMeaning\": \"Determines whether the hatching is applied to all views in the document or only the one selected during insertion.\",\n      \"validRange\": \"[0, 1]\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Scope of the script; affects multiple views if Yes.\"\n    },\n    {\n      \"name\": \"bViewOrtho\",\n      \"technicalDefault\": 1 (Yes),\n      \"businessMeaning\": \"Filters the processing to only Orthogonal (2D plan/elevation) views, skipping Isometric/3D views.\",\n      \"validRange\": \"[0, 1]\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Prevents hatching calculation on ISO views where 2D projection logic may not be desired.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sColor == '|_By Index|'\",\n      \"effect\": \"Activates the use of nColorIndex to determine hatch color.\",\n      \"cascade\": [\n        \"nColorIndex\"\n      ]\n    },\n    {\n      \"trigger\": \"bDrawEdge == 1 (Yes)\",\n      \"effect\": \"Activates the use of nColorEdge to determine edge color.\",\n      \"cascade\": [\n        \"nColorEdge\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"2D Hatching (Filled Region)\",\n      \"description\": \"PlanarProfiles filled with color representing the projection of stacked timber items, with hidden surface removal applied.\",\n      \"appliedTo\": \"PaperSpace views (ShopDrawViews).\"\n    },\n    {\n      \"type\": \"Polylines (Edges)\",\n      \"description\": \"Outline geometry defining the boundaries of the stacked items.\",\n      \"appliedTo\": \"PaperSpace views (ShopDrawViews) - if Draw Edge is enabled.\"\n    }\n  ]\n}\n```"
      },
      "tokens_used": 9501,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script (Insert TSL)",
          "2. Command Line Prompt: Select Origin Point (_Pt0)",
          "3. Command Line Prompt: Select ShopDrawView (getGenBeam) or element",
          "4. Process Selection: Identify specific view or prepare to iterate all views based on properties",
          "5. Scan Current Page/ShowSet: Find StackEntity, StackPack, StackItem, StackSpacer instances",
          "6. Filter Entities: Include/Exclude Stack/Pack containers based on 'DisplaySet' property",
          "7. Validation: Check if valid solid entities exist",
          "8. Iterate through Target Views (Single Selected or All on Page)",
          "9. Filter Views: Skip Isometric views if 'View Ortho' is enabled",
          "10. Geometric Calculation: Transform 3D bodies to 2D PaperSpace profiles",
          "11. Profile Processing: Remove profiles perpendicular to view and perform hidden surface removal",
          "12. Color Assignment: Apply color based on 'Color' property (Entity, Index, or Parent)",
          "13. Render: Draw Filled Hatch (with optional Transparency) and Edges (if enabled)"
        ],
        "conditionalBranches": [
          {
            "condition": "bViewAll or bViewOrtho enabled vs. Specific View Selected",
            "path1": {
              "name": "Specific View Mode",
              "steps": [
                "Uses the MultiPageView selected during insertion (getGenBeam)",
                "Calculates modelToView transform for that specific view",
                "Processes hatching only for that view"
              ]
            },
            "path2": {
              "name": "Global View Mode",
              "steps": [
                "Ignores specific selection if pd (element) is invalid",
                "Retrieves all views from the MultiPage (page.views())",
                "Iterates through all views applying hatching rules"
              ]
            }
          },
          {
            "condition": "Value of 'DisplaySet' Property",
            "path1": {
              "name": "Default",
              "steps": [
                "Filters OUT StackEntity and StackPack (containers)",
                "Only hatches StackItem and StackSpacer (individual items)"
              ]
            },
            "path2": {
              "name": "All Solids / Selection",
              "steps": [
                "Includes StackEntity and StackPack in the entity list",
                "Hatches both containers and individual items"
              ]
            }
          },
          {
            "condition": "Value of 'View Ortho' Property",
            "path1": {
              "name": "Yes",
              "steps": [
                "Calculates dot product of view direction",
                "If view is NOT orthogonal (Isometric/3D), skip to next view"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Process all views regardless of projection type"
              ]
            }
          },
          {
            "condition": "Entity Availability Validation",
            "path1": {
              "name": "Entities Found",
              "steps": [
                "Generate bodies from entities",
                "Assign script instance to plotable groups",
                "Proceed to hatching logic"
              ]
            },
            "path2": {
              "name": "No Entities",
              "steps": [
                "Assign script instance to non-plotable group ('T')",
                "Draw warning text '<scriptname> no solids found' at origin",
                "Exit script early"
              ]
            }
          },
          {
            "condition": "Value of 'Color' Property",
            "path1": {
              "name": "By Index",
              "steps": [
                "Override entity color with nColorIndex property value"
              ]
            },
            "path2": {
              "name": "By Parent",
              "steps": [
                "Identify parent TSL (Pack/Stack)",
                "Inherit color from parent entity"
              ]
            },
            "path3": {
              "name": "Entity Color",
              "steps": [
                "Use the native color of the stacked element"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selected View Bounds Validity",
            "errorMessage": "Unexpected error (Internal check: ppView.dX() < tolerance)",
            "recovery": "Ensure a valid ShopDrawView is selected; script erases instance on failure."
          },
          {
            "check": "Existence of Stack Entities",
            "errorMessage": "'<scriptname> no solids found' (Text drawn in ModelSpace)",
            "recovery": "Ensure the current view/showset contains StackItem, StackSpacer, or related Stack TSL instances."
          },
          {
            "check": "Orthogonality Filter",
            "errorMessage": "None (Silent skip)",
            "recovery": "If 'View Ortho' is Yes, ensure the shopdrawing contains Orthogonal views to see output."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Origin Point",
            "how": "Grip edit or OPM property '_Pt0'",
            "effect": "Updates the reference location; if '_Pt0' is the last changed property, it snaps to the center of the selected view again."
          },
          {
            "action": "Change Display Mode",
            "how": "OPM Property 'DisplaySet' (Default vs All Solids)",
            "effect": "Recalculates hatching to include or exclude Package/Stack containers."
          },
          {
            "action": "Adjust Visual Style",
            "how": "OPM Properties 'Color', 'Color Index', 'Transparency', 'Draw Edge'",
            "effect": "Immediately regenerates the hatch patterns with new colors/opacity or redraws/removes boundary lines."
          },
          {
            "action": "Modify View Scope",
            "how": "OPM Properties 'View All', 'View Ortho'",
            "effect": "Toggles processing between single selected view and all page views, or filters out ISO views."
          }
        ]
      },
      "tokens_used": 11555,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# StackHatch.mcr\n\n## Overview\nAutomates the creation of 2D hatching and shading for stacked timber elements (packages, pallets) on shop drawings, handling hidden line removal to correctly display overlapping stacks.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | Script operates on PaperSpace views. |\n| Paper Space | Yes | Specifically for Shop Drawings. |\n| Shop Drawing | Yes | Requires a MultiPage context. |\n\n## Prerequisites\n- **Required Entities**: `ShopDrawView`, `StackEntity`, `StackPack`, `StackItem`, `StackSpacer`.\n- **Minimum Beams**: 0 (This script processes stacking entities, not standard beams).\n- **Required Settings**: Must be run within a MultiPage (Shopdrawing) context where views exist.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `StackHatch.mcr`\n\n### Step 2: Select Origin Point\n```\nCommand Line: |_Origin of hatchings|\nAction: Click a point in the PaperSpace layout near the view you wish to process.\nNote: The script will automatically snap this origin to the center of the selected view.\n```\n\n### Step 3: Select View\n```\nCommand Line: |_Select MultiPage view or single view for hatchings|\nAction: Click on the border of the Shopdrawing View you want to hatch.\nNote: You can also select the view element from the model tree if preferred.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| _Pt0 | Point | Current | Origin point of the script. If this property is modified, it automatically snaps to the center of the selected view. |\n| DisplaySet | dropdown | Default | Determines which elements are hatched. <br>• **Default**: Hatches only individual items (StackItem, StackSpacer). <br>• **All Solids**: Hatches everything including containers (StackEntity, StackPack). |\n| Color | dropdown | Entity Color | Sets the coloring rule for the hatch. <br>• **Entity Color**: Uses the native color of the element. <br>• **By Parent**: Inherits the color of the parent package/pallet. <br>• **By Index**: Uses a fixed color index. |\n| Color Index | number | 7 | The specific CAD color index (0-255) used when 'Color' is set to 'By Index'. |\n| Transparency | number | 0 | Controls opacity. 0 is solid/opaque; higher values increase transparency to help visualize overlapping layers. |\n| Draw Edge | dropdown | Yes | Toggles the drawing of boundary polylines around the hatched areas. |\n| Edge Color | number | -1 | Color of the boundary lines. A value of -1 matches the edge color to the hatch fill color. |\n| View All | dropdown | No | If set to 'Yes', applies hatching to all views on the current page, not just the one selected during insertion. |\n| View Ortho | dropdown | Yes | If set to 'Yes', only Orthogonal (2D) views are processed. Isometric/3D views are skipped. |\n\n## Right-Click Menu Options\nNo specific custom menu options defined. Standard hsbCAD context options (Recalculate, Delete, etc.) apply.\n\n## Settings Files\nNo external settings files required.\n\n## Tips\n- **Visual Grouping**: Use the **Color** property set to **\"By Parent\"** to visually distinguish different packages or pallets within the same stack.\n- **Complex Overlaps**: Increase the **Transparency** value if you have complex stacks where items obscure one another; this allows you to see the volume of items hidden behind others.\n- **Batch Processing**: To hatch an entire layout quickly, set **View All** to \"Yes\" after inserting the script on the first view.\n- **Origin Snapping**: If you move the script instance manually, simply click the `_Pt0` property in the properties palette and reset it to snap it back to the view center automatically.\n\n## FAQ\n- **Q: Why do I see the text \"no solids found\" in my drawing?**\n  **A**: This warning appears if the selected view does not contain any StackItem, StackSpacer, or related stack entities, or if the **DisplaySet** filter is excluding the available entities.\n- **Q: The script works in my plan view but not my ISO view. Why?**\n  **A**: By default, the **View Ortho** property is set to \"Yes\". Change this to \"No\" to allow the script to process Isometric or 3D views.\n- **Q: How can I make the hatch look like a solid solid wood fill?**\n  **A**: Set **Transparency** to 0, **Color** to \"Entity Color\" (or a specific Index), and **Draw Edge** to \"No\"."
      },
      "tokens_used": 7274,
      "error": null
    }
  }
}