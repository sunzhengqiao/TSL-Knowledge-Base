{
  "filename": "HSB_T-GrainDirection.mcr",
  "status": "completed",
  "total_tokens": 32333,
  "processing_time": 285.2284731864929,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 2,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "05.01.2017",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "25.01.2018",
            "author": "RP",
            "changes": "Set conventions for export extension (set sheet ucs convention)"
          },
          {
            "version": "1.02",
            "date": "25.01.2018",
            "author": "RP",
            "changes": "Bug with setting of mapx boleean -1"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5897,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly instantiates tslNew.dbCreate into _kModelSpace. It operates on Sheet entities in the 3D model, creating a PLine visualization in the model view. It lacks '#Type E', _Viewport, or sd_* prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Property set 'hsbGeometryData' attached to the Sheet"
          ]
        }
      },
      "tokens_used": 2643,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select sheets|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Generic Properties Dialog",
            "trigger": "_bOnInsert",
            "title": null,
            "dataSource": "PropInt/PropString declarations",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "colorGrainDirection",
            "type": "PropInt",
            "displayName": "|Color grain direction|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "propMarkViewSde",
            "type": "PropString",
            "displayName": "|Mark view side|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "propMarkText",
            "type": "PropString",
            "displayName": "|Mark text|",
            "defaultValue": "Z",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Swap grain direction|",
            "handler": "recalcTriggers[0]",
            "action": "Toggles the GrainDirection property between 1 and 2.",
            "alsoTriggeredBy": "Double-click"
          },
          {
            "menuItem": "|Swap view side|",
            "handler": "recalcTriggers[1]",
            "action": "Inverts the ZDirectionSwitch property (flips the normal vector).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove grain direction|",
            "handler": "recalcTriggers[2]",
            "action": "Sets GrainDirection to 0 and erases the script instance.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 5671,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Visualizes the grain direction (fiber orientation) and 'Z-side' (visible face) of timber panels (sheets) in the 3D model to ensure correct manufacturing and assembly.",
          "category": "Annotation / DataManagement",
          "typicalUseCase": "Used during detailing of CLT (Cross Laminated Timber) or panelized walls to visually indicate to the factory and installer how the panel should be oriented and which surface is the finished side."
        },
        "parameters": [
          {
            "name": "colorGrainDirection",
            "technicalDefault": 1,
            "businessMeaning": "Sets the CAD display color (Color Index) for the grain direction arrow symbol to ensure visibility against the sheet geometry.",
            "validRange": "1-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Changes the visual color of the grain direction arrow in the model view. Does not affect CNC output."
          },
          {
            "name": "propMarkViewSde",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Toggles the display of a text marker (typically 'Z') indicating the 'view side' or 'good side' of the sheet (the side facing the camera or outward).",
            "validRange": "|Yes|, |No|",
            "unit": "Boolean/Option",
            "affectsOutput": "If 'Yes', a Mark entity is created on the sheet face. If 'No', the marker is removed."
          },
          {
            "name": "propMarkText",
            "technicalDefault": "Z",
            "businessMeaning": "Defines the specific text content used to label the view side (e.g., 'Z', 'Top', 'A').",
            "validRange": "Short alphanumeric string",
            "unit": "Text",
            "affectsOutput": "Updates the label content of the Mark entity attached to the sheet."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "propMarkViewSde is set to '|No|'",
            "effect": "The propMarkText parameter is ignored, and the visual Mark entity is not generated.",
            "cascade": [
              "propMarkText"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PLine",
            "description": "A graphical arrow shape indicating the direction of the grain (fiber orientation) on the sheet surface.",
            "appliedTo": "Model Space (visual overlay on the Sheet)"
          },
          {
            "type": "Mark",
            "description": "A text label (default 'Z') indicating the visible or 'good' side of the panel.",
            "appliedTo": "Sheet geometry"
          },
          {
            "type": "PropertySet Update",
            "description": "Updates 'hsbGeometryData' with GrainDirection (1 or 2) and ZDirectionSwitch for CNC export logic.",
            "appliedTo": "Sheet entity data"
          }
        ]
      },
      "tokens_used": 5699,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins",
          "Check for Insertion state (_bOnInsert)",
          "[Insertion Branch] Show Properties Dialog (if no catalog key used)",
          "[Insertion Branch] Prompt user to Select Sheets (PrEntity)",
          "[Insertion Branch] Iterate through selected entities and validate Sheet validity",
          "[Insertion Branch] Create new script instance for each valid Sheet (dbCreate)",
          "[Insertion Branch] Erase original command instance",
          "[Instance Branch] Verify Sheet entity is attached to instance",
          "[Instance Branch] Retrieve 'GrainDirection' property from 'hsbGeometryData'",
          "[Instance Branch] Check for Recalc Triggers (Double-click or Context Menu)",
          "[Conditional] Update Sheet Properties if triggers were detected (Swap grain, Swap side, or Remove)",
          "[Conditional] If 'Remove grain direction' triggered, erase instance and exit",
          "Calculate visual geometry (Arrow position and vector based on grain direction)",
          "Draw PLine arrow symbol in Model Space",
          "Check 'Mark view side' property (propMarkViewSde)",
          "[Conditional] If 'Yes', create and attach Mark text entity to Sheet",
          "Update MapX export data for 'GrainDirection' and 'hsbGeometryData'"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Initialization State",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Show Dialog",
                "Select Sheets",
                "Spawn Instances",
                "Erase Self"
              ]
            },
            "path2": {
              "name": "Instance Mode",
              "steps": [
                "Validate Sheet",
                "Process Triggers",
                "Draw Visualization",
                "Update Data"
              ]
            }
          },
          {
            "condition": "Recalc Trigger / User Interaction",
            "path1": {
              "name": "Swap Grain Direction (Double-click or Menu)",
              "steps": [
                "Read current GrainDirection (1 or 2)",
                "Invert value (1->2 or 2->1)",
                "Update PropertySet 'hsbGeometryData'",
                "Refresh Geometry"
              ]
            },
            "path2": {
              "name": "Swap View Side (Menu)",
              "steps": [
                "Read current ZDirectionSwitch (1 or -1)",
                "Invert value (1->-1 or -1->1)",
                "Update PropertySet 'hsbGeometryData'",
                "Refresh Geometry"
              ]
            },
            "path3": {
              "name": "Remove Grain Direction (Menu)",
              "steps": [
                "Set GrainDirection to 0",
                "Update PropertySet 'hsbGeometryData'",
                "Erase Script Instance"
              ]
            }
          },
          {
            "condition": "Property 'Mark view side' (propMarkViewSde)",
            "path1": {
              "name": "Yes",
              "steps": [
                "Create Mark entity",
                "Position based on grain direction and normal",
                "Add Tool to Sheet"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip Mark entity creation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Sheet Entity Attached",
            "errorMessage": "|invalid or no sheet selected.|",
            "recovery": "Script instance erases itself; user must re-run command and select a valid sheet."
          },
          {
            "check": "Sheet Validity during Loop",
            "errorMessage": "None (Silent)",
            "recovery": "If `selectedSheet.bIsValid()` returns false, the loop skips that specific sheet without creating an instance."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Arrow Color",
            "how": "OPM (Properties Palette) -> colorGrainDirection",
            "effect": "Updates the display color index of the PLine arrow."
          },
          {
            "action": "Toggle Text Label",
            "how": "OPM -> propMarkViewSde (Yes/No)",
            "effect": "Adds or removes the Mark text entity on the sheet surface."
          },
          {
            "action": "Change Label Text",
            "how": "OPM -> propMarkText",
            "effect": "Updates the string content of the Mark entity."
          },
          {
            "action": "Swap Grain Direction",
            "how": "Double-click entity or Right-click -> '|Swap grain direction|'",
            "effect": "Toggles the grain direction property (X/Y axis) and rotates the arrow."
          },
          {
            "action": "Swap View Side",
            "how": "Right-click -> '|Swap view side|'",
            "effect": "Flips the normal vector used to position the arrow/mark to the opposite face of the sheet."
          },
          {
            "action": "Remove Script",
            "how": "Right-click -> '|Remove grain direction|'",
            "effect": "Resets property to 0 and deletes the script instance from the drawing."
          }
        ]
      },
      "tokens_used": 6953,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_T-GrainDirection\n\n## Overview\nThis script visualizes the grain direction (fiber orientation) and marks the visible \"view side\" (Z-side) of timber sheets in the 3D model. It is used to ensure panels are manufactured and installed with the correct orientation and surface finish.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script creates visual overlays (PLine and Mark) on Sheet entities in the 3D model. |\n| Paper Space | No | This script does not function in Layout views. |\n| Shop Drawing | No | This is for detailing the 3D model, not generating 2D drawings directly. |\n\n## Prerequisites\n- **Required Entities**: An existing **Sheet** entity (e.g., CLT panel or timber wall).\n- **Minimum Beam Count**: 0 (This script operates on Sheets, not Beams).\n- **Required Settings**: The Sheet must have the property set `hsbGeometryData` attached (standard in hsbCAD).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Select `HSB_T-GrainDirection.mcr` from the file browser.\n\n### Step 2: Configure Properties (Optional)\nA dialog may appear upon insertion. You can modify:\n- **Color grain direction**: The color index for the arrow (Default: 1/Red).\n- **Mark view side**: Set to \"Yes\" to show the text label (Default: Yes).\n- **Mark text**: The character to display (Default: Z).\n\n### Step 3: Select Sheets\n```\nCommand Line: |Select sheets|\nAction: Click on one or more Sheet entities in the model, then press Enter.\n```\n*The script will automatically attach a visual arrow and text label to each selected sheet.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Color grain direction | Number | 1 | Sets the CAD color (Index 1-255) of the grain direction arrow. |\n| Mark view side | Dropdown | Yes | Determines if the \"View Side\" text label (e.g., \"Z\") is displayed on the sheet. Options: Yes / No. |\n| Mark text | Text | Z | The text content for the view side label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Swap grain direction | Toggles the grain orientation (e.g., switching between major and minor strength axes). Can also be triggered by double-clicking the script instance. |\n| Swap view side | Flips the visual arrow and text to the opposite face of the sheet. |\n| Remove grain direction | Removes the visual symbols and resets the grain direction property on the Sheet. |\n\n## Settings Files\n- **None required**: This script does not rely on external XML or configuration files.\n\n## Tips\n- **Quick Swap**: You can double-click the grain direction arrow in the model to quickly toggle the grain direction without opening the right-click menu.\n- **Visibility**: If the arrow is hard to see against the sheet material, select the script instance and change the \"Color grain direction\" property in the Properties Palette to a contrasting color (e.g., Yellow or Magenta).\n- **Facing**: Use the \"Swap view side\" option if the arrow is pointing into the wall rather than outwards.\n\n## FAQ\n- **Q: The arrow is pointing to the wrong face of the panel.**\n  - A: Right-click the script instance and select \"|Swap view side|\". This flips the normal vector so the arrow moves to the other side.\n- **Q: I don't want to see the text label, only the arrow.**\n  - A: Select the instance in the model, open the Properties Palette (Ctrl+1), and change \"Mark view side\" to \"|No|\".\n- **Q: How does this affect manufacturing/CNC?**\n  - A: This script updates the `hsbGeometryData` property set. The grain direction setting is often used by CAM modules to determine how a panel should be nested or processed."
      },
      "tokens_used": 5470,
      "error": null
    }
  }
}