{
  "filename": "hsb_AssignOpeningWeight.mcr",
  "status": "completed",
  "total_tokens": 35465,
  "processing_time": 198.11449933052063,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6838,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script operates on `Opening` and `ElementWall` entities. It calculates physical attributes (`dWeight`) based on 3D dimensions (`op.width()`, `op.height()`) and writes data to the model entity using `op.setSubMapX()`. Visualization is performed using `PLine` and `Display` objects relative to the Opening's coordinate system. No usage of `sd_` APIs, `_Viewport`, or ShopDrawing specific prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "Opening",
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing an Opening entity within an external ElementWall",
          "requiredSettings": []
        }
      },
      "tokens_used": 4556,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select one or More Openings",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Insertion when _kExecuteKey is empty",
            "title": "Default Property Dialog",
            "dataSource": "Script Properties (sGlassType, sWindowFrameType, sFitted, dNewScale)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sGlassType",
            "type": "PropString",
            "displayName": "Glass Type",
            "defaultValue": "|SG 4mm|",
            "inputType": "dropdown",
            "options": [
              "|SG 4mm|",
              "|SG 6.4mm|",
              "|DG 2 x 4mm|",
              "|DG 4mm + 6.4mm|",
              "|DG 2 x 6.4mm|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sWindowFrameType",
            "type": "PropString",
            "displayName": "Window frame type",
            "defaultValue": "|Redwood|",
            "inputType": "dropdown",
            "options": [
              "|Redwood|",
              "|Sapele|",
              "|Meranti|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sFitted",
            "type": "PropString",
            "displayName": "Factory Fitted",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dNewScale",
            "type": "PropDouble",
            "displayName": "Symbol Scale",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Recalculate weight",
            "handler": "Recalculate weight",
            "action": "Resets ExecutionMode to 0 to trigger weight recalculation",
            "alsoTriggeredBy": "Modification of 'Factory Fitted' property"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 4698,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates and assigns the physical weight to window and door openings based on frame material and glazing type, while providing visual annotation for factory-fitted status.",
          "category": "Data/Calculation",
          "typicalUseCase": "Used during detailing or scheduling to determine lifting requirements for pre-assembled wall panels or to estimate shipping weights based on specific window configurations."
        },
        "parameters": [
          {
            "name": "sGlassType",
            "technicalDefault": "|SG 4mm|",
            "businessMeaning": "Specifies the glazing specification used in the opening, which determines the weight per square meter of the glass component.",
            "validRange": "List selection only: SG 4mm, SG 6.4mm, DG 2 x 4mm, DG 4mm + 6.4mm, DG 2 x 6.4mm",
            "unit": "N/A (List)",
            "affectsOutput": "Directly modifies the calculated 'TotalWeight' stored in the opening entity. Heavier or double-glazed options increase the total weight."
          },
          {
            "name": "sWindowFrameType",
            "technicalDefault": "|Redwood|",
            "businessMeaning": "Defines the timber species used for the window frame, which dictates the density factor used in the weight calculation.",
            "validRange": "List selection only: Redwood, Sapele, Meranti",
            "unit": "N/A (List)",
            "affectsOutput": "Directly modifies the calculated 'TotalWeight'. Hardwoods (Sapele, Meranti) result in a heavier frame weight than softwoods (Redwood)."
          },
          {
            "name": "sFitted",
            "technicalDefault": "No",
            "businessMeaning": "Indicates whether the window is fully assembled and glazed in the factory (Factory Fitted) or supplied as a kit for site assembly.",
            "validRange": "List: No, Yes",
            "unit": "N/A (List)",
            "affectsOutput": "Updates the 'FactoryFitted' flag in the entity data. Changes the visual symbol drawn in the model (Color and PLine shape) to distinguish between fitted and unfitted status."
          },
          {
            "name": "dNewScale",
            "technicalDefault": 1,
            "businessMeaning": "Controls the visual size of the status symbol (annotation) drawn in the model view.",
            "validRange": "0.5 to 3.0",
            "unit": "Multiplier",
            "affectsOutput": "Scales the geometry of the visual symbol (PLine). Does not affect the calculated weight."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Modification of 'Factory Fitted' (sFitted) property",
            "effect": "Forces the script to recalculate (reset ExecutionMode to 0) to update the visual symbol and data map immediately.",
            "cascade": [
              "nExecutionMode"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "SubMap Data (HSB_OpeningInfo)",
            "description": "Writes calculated weight ('TotalWeight') and assembly status ('FactoryFitted') to the Opening entity.",
            "appliedTo": "Selected Opening entities"
          },
          {
            "type": "Visual Annotation (PLine)",
            "description": "Draws a dynamic symbol in the model representing the window status. Different shapes and colors (Red/Green) are used for 'Fitted' vs 'Not Fitted'.",
            "appliedTo": "Model Space (relative to Opening location)"
          }
        ]
      },
      "tokens_used": 6256,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Set sequence number and units.",
          "2. Property Initialization: Load properties (sGlassType, sWindowFrameType, sFitted, dNewScale).",
          "3. Insertion Flow (Trigger: _bOnInsert):",
          "   3a. Check insertCycleCount: If > 1, erase instance and exit.",
          "   3b. Check ExecuteKey: If empty, show dynamic property dialog.",
          "   3c. Prompt User: Select one or more Opening entities.",
          "   3d. Iterate through selected entities:",
          "       - Verify entity is a valid Opening.",
          "       - Retrieve parent ElementWall (must be valid).",
          "       - Clone script instance to the Opening (dbCreate) with current properties and ExecutionMode=0.",
          "   3e. Cleanup: Erase original script instance.",
          "4. Processing Flow (Trigger: Post-insertion/Update):",
          "   4a. Verify Integrity: Check if Opening exists, if Opening is valid, and if parent ElementWall is valid. Erase/Exit on failure.",
          "   4b. Check Exposure: Verify ElementWall is external. If internal, erase instance.",
          "   4c. Event Handling:",
          "       - Add Context Menu 'Recalculate weight'.",
          "       - Check for Recalc trigger or 'Factory Fitted' property change or Element construction: Reset ExecutionMode to 0.",
          "   4d. Execution Mode Logic:",
          "       - If ExecutionMode == 0 (Recalculate Phase):",
          "           - Cleanup: Remove duplicate script instances attached to the same Opening.",
          "           - Calculate Position: Determine symbol origin (_Pt0) based on Opening center and Wall plane.",
          "           - Calculate Weight:",
          "               - If Door: Fixed weight of 65.",
          "               - If Window/Opening/Assembly: Calculate based on dimensions, glass type factor, and timber factor.",
          "           - Write Data: Update 'HSB_OpeningInfo' SubMap with 'TotalWeight' and 'FactoryFitted'.",
          "           - Set ExecutionMode to 1 (Drawing Phase).",
          "       - If ExecutionMode == 1 (Drawing Phase):",
          "           - Draw Symbol: Render PLine (plYes or plNo) based on 'Factory Fitted' status.",
          "           - Set Color: Green (3) for Fitted, Red (1) for Not Fitted.",
          "           - Scale Symbol: Apply dNewScale factor.",
          "           - Assign instance to Element Group."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Primary Insertion",
              "steps": [
                "Proceed with prompt and entity selection",
                "Clone instances to selected openings"
              ]
            },
            "path2": {
              "name": "Subsequent Cycle (Auto-regeneration)",
              "steps": [
                "Erase instance immediately",
                "Stop execution"
              ]
            }
          },
          {
            "condition": "Parent Wall Exposure (nExternal)",
            "path1": {
              "name": "External Wall",
              "steps": [
                "Proceed to weight calculation and drawing"
              ]
            },
            "path2": {
              "name": "Internal Wall",
              "steps": [
                "Erase instance",
                "Stop execution (No processing on internal walls)"
              ]
            }
          },
          {
            "condition": "ExecutionMode State",
            "path1": {
              "name": "Calculation Mode (0)",
              "steps": [
                "Clean duplicates",
                "Compute weight based on type (Door vs Window)",
                "Write SubMap",
                "Switch to Mode 1"
              ]
            },
            "path2": {
              "name": "Visualization Mode (1)",
              "steps": [
                "Draw geometry",
                "Apply colors",
                "Skip calculation"
              ]
            }
          },
          {
            "condition": "Opening Type (Weight Calculation)",
            "path1": {
              "name": "Door",
              "steps": [
                "Set fixed weight: 65"
              ]
            },
            "path2": {
              "name": "Window / Opening / Assembly",
              "steps": [
                "Calculate Timber Volume (Sides, Top, Bottom, Borders)",
                "Calculate Glass Area",
                "Apply Material Factors (Timber/Glass)",
                "Sum weights"
              ]
            }
          },
          {
            "condition": "Factory Fitted Status (Visualization)",
            "path1": {
              "name": "Yes (Fitted)",
              "steps": [
                "Draw plYes shape",
                "Set Color Green (3)"
              ]
            },
            "path2": {
              "name": "No (Unfitted)",
              "steps": [
                "Draw plNo shape",
                "Set Color Red (1)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection / Integrity",
            "errorMessage": "(Implicit)",
            "recovery": "Script erases itself if no Opening selected, Opening is invalid, or parent ElementWall is invalid/missing."
          },
          {
            "check": "Wall Location",
            "errorMessage": "(Implicit)",
            "recovery": "Script erases itself if the parent ElementWall is internal (nExternal == false), ensuring only external walls are processed."
          },
          {
            "check": "Duplicate Instances",
            "errorMessage": "(Implicit)",
            "recovery": "Script automatically finds and erases other instances of itself attached to the same Opening handle during the Calculation phase."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Factory Fitted Status",
            "how": "OPM Property Palette (Change 'Factory Fitted' dropdown)",
            "effect": "Resets ExecutionMode to 0, triggers immediate redraw of symbol (Color/Shape change), and updates 'FactoryFitted' flag in SubMap."
          },
          {
            "action": "Update Weight Parameters",
            "how": "OPM Property Palette (Change 'Glass Type' or 'Window Frame type')",
            "effect": "Changes calculation variables, but weight is only recalculated if 'Recalculate weight' context menu is used."
          },
          {
            "action": "Resize Symbol",
            "how": "OPM Property Palette (Change 'Symbol Scale')",
            "effect": "Adjusts the scale multiplier (dNewScale) used in the visual PLine drawing in real-time."
          },
          {
            "action": "Recalculate Weight",
            "how": "Right-click Context Menu > 'Recalculate weight'",
            "effect": "Forces ExecutionMode to 0, triggering a fresh calculation of weight based on current dimensions and properties."
          },
          {
            "action": "Wall Reconstruction",
            "how": "Modify or Reconstruct the ElementWall",
            "effect": "_bOnElementConstructed event triggers, resetting ExecutionMode to 0 to ensure weight/symbols are updated after wall geometry changes."
          }
        ]
      },
      "tokens_used": 7389,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_AssignOpeningWeight.mcr\n\n## Overview\nCalculates the physical weight of window and door openings based on frame material and glazing specifications. It assigns this data to the opening entity for scheduling and draws a visual symbol to indicate if the unit is factory-fitted.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script attaches to Opening entities within ElementWalls. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | Not applicable. |\n\n## Prerequisites\n- **Required entities**: An `Opening` (Window or Door) that is part of an `ElementWall`.\n- **Minimum beam count**: 0.\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse to and select `hsb_AssignOpeningWeight.mcr`.\n\n### Step 2: Configure Properties\n1. Upon selection, a \"Default Property Dialog\" will appear.\n2. Set the default values for **Glass Type**, **Window Frame Type**, **Factory Fitted**, and **Symbol Scale**.\n3. Click **OK** to proceed.\n\n### Step 3: Select Openings\n```\nCommand Line: Select one or More Openings\nAction: Click on one or more window/door openings in the model to assign the script and calculated weight.\n```\n4. Press **Enter** to finalize the selection.\n\n### Step 4: Modify Individual Openings (Optional)\n1. Select an opening that has the script assigned.\n2. Open the **Properties Palette** (Ctrl+1).\n3. Change parameters (e.g., change Glass Type) as needed.\n4. Right-click the opening and select **Recalculate weight** to update the weight data based on new parameters.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Glass Type | dropdown | \\|SG 4mm\\| | Select the glazing specification (e.g., Single Glazing 4mm, Double Glazing). This affects the calculated weight. |\n| Window frame type | dropdown | \\|Redwood\\| | Select the timber species for the frame (e.g., Redwood, Sapele, Meranti). Heavier woods increase the total weight. |\n| Factory Fitted | dropdown | No | Determines if the window is assembled in the factory. **Yes** draws a green symbol; **No** draws a red symbol. |\n| Symbol Scale | number | 1 | Adjusts the visual size of the fitted/unfitted symbol drawn in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate weight | Forces the script to re-evaluate the weight based on the current dimensions and property settings. Use this after changing Glass Type or Window Frame Type. |\n\n## Settings Files\n- None required.\n\n## Tips\n- **External Walls Only**: This script automatically erases itself if attached to an opening in an internal wall. It only processes external walls.\n- **Visual Indicators**:\n    - **Green Symbol**: The unit is marked as \"Factory Fitted\" (Yes).\n    - **Red Symbol**: The unit is not factory fitted (No).\n- **Updating Weight**: Changing the \"Factory Fitted\" status automatically updates the visual symbol. However, changing material properties (Glass/Frame) requires you to right-click and select \"Recalculate weight\" to update the stored weight data.\n- **Symbol Visibility**: If the symbol is too small or large, adjust the \"Symbol Scale\" property in the Properties Palette.\n\n## FAQ\n- **Q: Why did the symbol disappear after I inserted the script?**\n  - A: The script may have detected that the opening is located in an internal wall, in which case it automatically removes itself.\n- **Q: I changed the Glass Type, but the weight didn't update in my reports.**\n  - A: You must right-click the opening and select \"Recalculate weight\" to apply the new material factors to the calculated weight.\n- **Q: What does the number written to the entity represent?**\n  - A: The script writes a property named `TotalWeight` (in the HSB_OpeningInfo submap) to the opening entity, representing the weight in kilograms (or the current project mass unit)."
      },
      "tokens_used": 5728,
      "error": null
    }
  }
}