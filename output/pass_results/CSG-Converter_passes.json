{
  "filename": "CSG-Converter.mcr",
  "status": "completed",
  "total_tokens": 49494,
  "processing_time": 509.275954246521,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "02.06.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-19105 Initial version of CSG-Converter to convert solids into beams with drills"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7621,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit usage of '_kModelSpace' in Group().collectEntities() and tslNew.dbCreate(). No 'sd_' prefix, no '_Viewport' handling, and no #Type comments indicating a ShopDrawing macro. The script interacts with 'PainterDefinition' and creates 'Beam' and 'TslInst' objects, which are construction activities."
        },
        "prerequisites": {
          "requiredEntities": [
            "Solid3d",
            "Beam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "PainterDefinitions (The script attempts to locate or create defaults in 'TSL\\Conversion\\')"
          ]
        }
      },
      "tokens_used": 6750,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 9851,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Converts 'dumb' 3D solids (e.g., from DWG/IFC imports) into intelligent hsbCAD Beams and associative FreeDrills, parsing layer names to automatically assign material properties.",
          "category": "Import/Conversion",
          "typicalUseCase": "Converting architectural models from Revit or AutoCAD into structural timber elements for detailing, where solids represent timber parts and cylindrical voids represent drill holes."
        },
        "parameters": [
          {
            "name": "sPainter",
            "technicalDefault": "\"|Beam Conversion|\"",
            "businessMeaning": "Selects the Painter Definition (rule set) used to identify which solids in the model should be converted into structural Beams. It allows filtering by Layer, Color, or other properties.",
            "validRange": "List of available Painter Definitions in folder 'TSL\\Conversion\\', or '<Disabled>', or '<bySelection>'",
            "unit": "Selection",
            "affectsOutput": "Determines which source solids are transformed into Beam entities. If '<bySelection>', the user must manually pick the solids."
          },
          {
            "name": "sPainterDrill",
            "technicalDefault": "\"|Drill Conversion|\"",
            "businessMeaning": "Selects the Painter Definition used to identify which solids represent holes/drills. These are typically cylindrical solids that need to be applied as machining to the beams.",
            "validRange": "List of available Painter Definitions in folder 'TSL\\Conversion\\', or '<Disabled>', or '<bySelection>'",
            "unit": "Selection",
            "affectsOutput": "Determines which source solids are converted into 'FreeDrill' TSL instances applied to intersecting beams."
          },
          {
            "name": "sSeparator",
            "technicalDefault": "\"_\"",
            "businessMeaning": "The character delimiter used to split the source entity's Layer Name into distinct segments (tokens) for data extraction.",
            "validRange": "Any string (e.g., '_', '-', '.')",
            "unit": "String",
            "affectsOutput": "Controls how the script parses the layer name. If the layer is 'GL28_240x60' and separator is '_', it splits into 'GL28' and '240x60'."
          },
          {
            "name": "sToken1",
            "technicalDefault": "\"|Name|\"",
            "businessMeaning": "Maps the first segment of the split layer name (Token 1) to a specific property of the new Beam (e.g., Name, Material, Grade).",
            "validRange": "<Disabled>, Name, Material, Grade, Information, Label, SubLabel, SubLabel2",
            "unit": "Mapping",
            "affectsOutput": "Populates the mapped property of the generated Beam with the text found in the first segment of the source layer name."
          },
          {
            "name": "sToken2",
            "technicalDefault": "\"|Material|\"",
            "businessMeaning": "Maps the second segment of the split layer name (Token 2) to a specific property of the new Beam.",
            "validRange": "<Disabled>, Name, Material, Grade, Information, Label, SubLabel, SubLabel2",
            "unit": "Mapping",
            "affectsOutput": "Populates the mapped property of the generated Beam with the text found in the second segment of the source layer name."
          },
          {
            "name": "sToken3",
            "technicalDefault": "\"|Grade|\"",
            "businessMeaning": "Maps the third segment of the split layer name (Token 3) to a specific property of the new Beam.",
            "validRange": "<Disabled>, Name, Material, Grade, Information, Label, SubLabel, SubLabel2",
            "unit": "Mapping",
            "affectsOutput": "Populates the mapped property of the generated Beam with the text found in the third segment of the source layer name."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sSeparator is changed",
            "effect": "The parsing logic for sToken1, sToken2, and sToken3 changes immediately, potentially breaking data mapping if the new separator does not exist in the layer names.",
            "cascade": [
              "sToken1",
              "sToken2",
              "sToken3"
            ]
          },
          {
            "trigger": "sPainter or sPainterDrill is set to '<bySelection>'",
            "effect": "The script bypasses Painter filtering and prompts the user on the command line to manually select the specific solids to convert.",
            "cascade": [
              "_Entity"
            ]
          },
          {
            "trigger": "sPainter is set to '<Disabled>'",
            "effect": "No beams will be created. If sPainterDrill is active, the script will look for existing beams to apply the drills to.",
            "cascade": [
              "bCreateBeams"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Structural timber elements created from the geometry of the selected source solids.",
            "appliedTo": "Model Space (New entities created based on input solids)."
          },
          {
            "type": "FreeDrill",
            "description": "Machining operations (holes) created from cylindrical solids, automatically applied to beams that spatially intersect with the source drill solid.",
            "appliedTo": "Beams (intersects with existing or newly created beams)."
          },
          {
            "type": "PainterDefinition",
            "description": "Default configuration entries ('Solid To Beam' and 'Solid To Drill') may be generated in the 'TSL\\Conversion\\' folder if they do not exist.",
            "appliedTo": "Drawing Database."
          }
        ]
      },
      "tokens_used": 8195,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Validate Environment: Check for existing Painter Definitions in 'TSL\\\\Conversion\\\\'. If missing, create defaults ('Solid To Beam', 'Solid To Drill'). Abort if folder/definitions cannot be established.\",\n    \"2. Display Dialog: Show Properties Palette allowing user to select 'Beam Conversion' painter, 'Drill Conversion' painter, and Layer Mapping rules.\",\n    \"3. Selection Phase (Branching based on Painter settings):\",\n    \"   - If Painters are active: Prompt user to select a generic set of entities.\",\n    \"   - If 'Beam Conversion' set to '<bySelection>': Prompt specifically for beam solids.\",\n    \"   - If 'Drill Conversion' set to '<bySelection>': Prompt specifically for drill solids.\",\n    \"   - If 'Beam Conversion' is <Disabled> but 'Drill Conversion' is active: Prompt user to select existing Beams to apply drills to.\",\n    \"4. Filter Entities: Apply Painter Definition filters to the selected entities to identify valid source solids.\",\n    \"5. Convert Beams: Iterate through identified beam solids. Check for 'CSG-Conversion' tag to prevent duplicates. Create hsbCAD Beam from solid geometry. Parse Layer Name using Separator and map tokens to Beam properties (Name, Material, Grade, etc.). Store mapping link.\",\n    \"6. Convert Drills: Iterate through identified drill solids.\",\n    \"   - Analyze Geometry: If solid has 2 grip points (cylinder), calc axis directly. If complex solid, create temporary Beam to extract axis/length, then delete temp beam.\",\n    \"   - Detect Intersections: Find which Beams (created or existing) spatially intersect the drill solid.\",\n    \"   - Create Machining: Insert 'FreeDrill' TSL instance onto intersecting beams.\",\n    \"7. Completion: Report summary of created beams and drills to command line.\",\n    \"8. Cleanup: Erase the script instance from the model (unless in Debug mode).\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Selection Mode Configuration (sPainter and sPainterDrill values)\",\n      \"path1\": {\n        \"name\": \"Painter Filter Mode\",\n        \"steps\": [\n          \"User selects a generic set of entities.\",\n          \"Script uses 'filterAcceptedEntities' to find solids matching the selected Painter Definition (e.g., specific Layers).\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Manual Selection Mode ('<bySelection>')\",\n        \"steps\": [\n          \"User is prompted with specific instructions (e.g., 'Select solids for beam conversion').\",\n          \"Script bypasses Painter filtering and trusts the user's explicit selection.\"\n        ]\n      },\n      \"path3\": {\n        \"name\": \"Drill-Only Mode (Beams Disabled)\",\n        \"steps\": [\n          \"Script prompts user to select existing Beams.\",\n          \"Skips solid-to-beam conversion entirely.\",\n          \"Proceeds directly to converting solids to drills on the selected beams.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Source Solid Geometry Complexity\",\n      \"path1\": {\n        \"name\": \"Simple Cylinder\",\n        \"steps\": [\n          \"Grip points count == 2.\",\n          \"Script calculates Vector and Length directly from the grip points.\",\n          \"Calculates diameter from volume and length.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Complex Solid\",\n        \"steps\": [\n          \"Grip points count != 2.\",\n          \"Script creates a temporary Beam object using 'dbCreate'.\",\n          \"Extracts Vector X and Length from the temporary Beam.\",\n          \"Immediately deletes the temporary Beam ('dbErase').\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Drill Intersection Test\",\n      \"path1\": {\n        \"name\": \"Intersection Found\",\n        \"steps\": [\n          \"'filterGenBeamsIntersect' returns target beams.\",\n          \"Script creates 'FreeDrill' TSL instance linked to target beams.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"No Intersection\",\n        \"steps\": [\n          \"No beams found overlapping the solid.\",\n          \"Script draws a visualization line ('pl.vis(1)') to indicate a 'loose' drill.\",\n          \"No TSL is created.\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Painter Definitions Existence\",\n      \"errorMessage\": \"This tool is based on painter definitions of groups, but this drawing does not contain any valid definition. The definitions need to be created in folder named TSL\\\\Conversion\\\\\",\n      \"recovery\": \"Script auto-creates defaults ('Solid To Beam', 'Solid To Drill'). If that fails, user must manually create Painter Definitions in the specified folder.\"\n    },\n    {\n      \"check\": \"Solid Validity\",\n      \"errorMessage\": \"None (Silent Skip)\",\n      \"recovery\": \"Script skips entities where 'realBody()' is null or if the entity is a simple 2-point description (likely not a volume).\"\n    },\n    {\n      \"check\": \"Duplicate Conversion\",\n      \"errorMessage"
      },
      "tokens_used": 10649,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# CSG-Converter\n\n## Overview\nConverts \"dumb\" 3D solids (e.g., imported DWG or IFC models) into intelligent hsbCAD Beams and associative FreeDrills. It automatically parses layer names to assign properties like Material, Grade, and Name to the new timber elements.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in Model Space. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | This is a construction/modeling tool, not a detailing script. |\n\n## Prerequisites\n- **Required Entities:** 3D Solids (AcDb3dSolid) representing timber parts, and optionally cylindrical solids representing holes. If creating drills only, existing Beams are required.\n- **Required Settings:** Painter Definitions located in the folder `TSL\\Conversion\\`. If these are missing, the script will attempt to auto-generate default definitions named \"Solid To Beam\" and \"Solid To Drill\".\n- **Layer Naming:** Source solids should be on layers with structured names (e.g., `GL28_240x60_C24`) to allow the script to extract data.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `CSG-Converter.mcr`\nThe script inserts into the drawing. If Painter Definitions are missing, it will automatically create default ones.\n\n### Step 2: Configure Conversion Settings\nBefore selecting objects, configure the script parameters in the Properties Palette (Ctrl+1).\n1.  **Beam Painter:** Choose a Painter Definition (e.g., `|Beam Conversion|`) to filter which solids become beams. Set to `<bySelection>` to pick manually, or `<Disabled>` to skip beam creation.\n2.  **Drill Painter:** Choose a Painter Definition (e.g., `|Drill Conversion|`) for identifying holes.\n3.  **Layer Separator:** Enter the character that separates data in your layer names (e.g., `_`).\n4.  **Token Mapping:** Assign the split parts of the layer name to Beam properties.\n    *   *Example:* If Layer is `GL24h_200x45`, Separator is `_`:\n        *   Token 1 = `GL24h` → Set `sToken1` to **Material**.\n        *   Token 2 = `200x45` → Set `sToken2` to **Name**.\n\n### Step 3: Select Entities\nThe prompts vary based on your Painter settings in Step 2.\n\n**Scenario A: Using Painter Definitions**\n```\nCommand Line: Select entities:\nAction: Select a window of all objects (solids) you want to process. The script will use the Painter to filter them automatically.\n```\n\n**Scenario B: Manual Selection (<bySelection>)**\n```\nCommand Line: Select solids for beam conversion:\nAction: Click specifically on the solids that represent timber beams.\nCommand Line: Select solids for drill conversion:\nAction: Click specifically on the solids that represent drill holes.\n```\n\n**Scenario C: Drills Only (Beam Painter set to <Disabled>)**\n```\nCommand Line: Select beams to apply drills to:\nAction: Select the existing hsbCAD Beams that you want to add machining to.\n```\n\n### Step 4: Processing\n1.  The script converts valid solids into Beams.\n2.  It calculates the axis and dimensions for drill solids.\n3.  It detects intersections and applies FreeDrills to the appropriate beams.\n4.  A summary is printed to the command line (e.g., \"5 Beams created, 12 Drills added\").\n5.  The script instance automatically removes itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **sPainter** | Selection | `|Beam Conversion|` | Determines which solids are converted into Beams. Select a specific Painter Definition, `<bySelection>` for manual picking, or `<Disabled>` to skip beam creation. |\n| **sPainterDrill** | Selection | `|Drill Conversion|` | Determines which solids are converted into Drills. Select a specific Painter Definition, `<bySelection>` for manual picking, or `<Disabled>` to skip drill creation. |\n| **sSeparator** | String | `_` | The delimiter character used to split the layer name (e.g., `_`, `-`, or `.`). |\n| **sToken1** | Mapping | `|Name|` | Maps the first segment of the layer name to a Beam property (Name, Material, Grade, etc.). |\n| **sToken2** | Mapping | `|Material|` | Maps the second segment of the layer name to a Beam property. |\n| **sToken3** | Mapping | `|Grade|` | Maps the third segment of the layer name to a Beam property. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script executes immediately upon configuration and entity selection. It does not remain in the model as a persistent interactive object. |\n\n## Settings Files\n- **Filename:** `Solid To Beam.xml`, `Solid To Drill.xml` (Auto-generated defaults)\n- **Location:** `TSL\\Conversion\\` (in your Company or hsbCAD Install path)\n- **Purpose:** These Painter Definition files store the rules (Layer, Color, etc.) used to identify which imported solids correspond to structural beams vs. drill holes.\n\n## Tips\n- **Layer Organization:** Rename your import layers to a structured format (e.g., `Material_Width-Height_Grade`) before running this script to automate data entry.\n- **Visualizing Loose Drills:** If a drill solid does not intersect any beam, the script will draw a temporary line to show its location. Check the command line for warnings if drills are missed.\n- **Complex Geometry:** If a drill solid is not a perfect cylinder, the script automatically creates a temporary beam to calculate its axis vector.\n\n## FAQ\n- **Q: I get an error about missing Painter Definitions.**\n  A: The script tries to create default definitions in `TSL\\Conversion\\`. Ensure you have write permissions to this folder, or manually create the Painter Definitions named \"Solid To Beam\" and \"Solid To Drill\".\n- **Q: My beams were created, but they have no material info.**\n  A: Check your `sSeparator` and `sToken` settings. If your layer is `Beam_240x60` and your separator is `_`, ensure you have mapped `sToken1` or `sToken2` to the correct property.\n- **Q: The drills didn't attach to the beams.**\n  A: Drills require a physical volume intersection with the beam. Ensure the cylindrical solids in your import overlap the beam solids sufficiently."
      },
      "tokens_used": 6428,
      "error": null
    }
  }
}