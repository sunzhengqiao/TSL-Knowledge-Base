{
  "filename": "hsb-E-CombinationText.mcr",
  "status": "completed",
  "total_tokens": 51074,
  "processing_time": 299.6437397003174,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.6",
            "date": "20oct2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "HSB-9338 internal naming bugfix"
          },
          {
            "version": "1.5",
            "date": "19mar2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "default format added"
          },
          {
            "version": "1.4",
            "date": "19mar2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix debug"
          },
          {
            "version": "1.3",
            "date": "19mar2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix orientation on insert"
          },
          {
            "version": "1.2",
            "date": "19mar2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "duplicates will be purged"
          },
          {
            "version": "1.1",
            "date": "26feb2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "new commands to modify text, new display modes"
          },
          {
            "version": "1.0",
            "date": "26feb2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [
          "hsbInstallationPointSettings.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 8540,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly uses `_kModelSpace` within the `dbCreate` function during insertion. No usage of `_Viewport`, `_kPaperSpace`, `sd_*` function prefixes, or Multipage specific patterns found. The script creates annotative geometry relative to the coordinate system of the parent entity."
        },
        "prerequisites": {
          "requiredEntities": [
            "hsb-E-Combination (TslInst)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "hsbInstallationPointSettings.xml"
          ]
        }
      },
      "tokens_used": 7595,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 10387,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates dynamic, multi-line text labels attached to 'hsb-E-Combination' elements in the 3D model to display specific properties (e.g., dimensions, labels) directly on the structure.",
          "category": "Annotation / Model Information",
          "typicalUseCase": "Tagging complex wall or floor panels (Combinations) with aggregated data like overall dimensions or material grades for visual verification in the 3D model without generating drawings."
        },
        "parameters": [
          {
            "name": "Format",
            "technicalDefault": "@(Text 1)\\@(Text 2)\\@(Text 3)\\@(Text 4)\\@(Text 5)",
            "businessMeaning": "Defines the content and layout of the label. Uses tokens (e.g., '@(Width)', '@(Label)') to pull data from the parent Combination element. The backslash character '\\' separates text lines.",
            "validRange": "String containing valid property tokens and text delimiters.",
            "unit": "String",
            "affectsOutput": "Alters the text displayed on the label. Adding or removing tokens changes which data points are visible. Modifying separators changes line breaks."
          },
          {
            "name": "TextHeight",
            "technicalDefault": "U(80)",
            "businessMeaning": "The physical height of the text characters in the model.",
            "validRange": "10mm - 500mm (depending on model scale and visibility requirements)",
            "unit": "mm",
            "affectsOutput": "Scales the size of the text characters and the surrounding border box."
          },
          {
            "name": "Color (nc)",
            "technicalDefault": "ByBlock/Parent",
            "businessMeaning": "The display color of the text and border lines.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Changes the visual color of the annotation in the CAD viewport."
          },
          {
            "name": "FillColor (ncFill)",
            "technicalDefault": "-1 (ByBlock)",
            "businessMeaning": "The background color of the label box to mask underlying geometry for better readability.",
            "validRange": "-1 (ByBlock) or specific color index",
            "unit": "Index",
            "affectsOutput": "Fills the background of the text label with a solid color."
          },
          {
            "name": "Transparency (nt)",
            "technicalDefault": "70",
            "businessMeaning": "The opacity level of the background fill, allowing geometry behind the label to remain partially visible.",
            "validRange": "0 (Opaque) - 90 (Transparent)",
            "unit": "Percentage/Integer",
            "affectsOutput": "Adjusts how see-through the background fill box is."
          },
          {
            "name": "BorderMode",
            "technicalDefault": "1",
            "businessMeaning": "Controls whether a rectangular border is drawn around the text.",
            "validRange": "0 (No Border), 1 (Border)",
            "unit": "Boolean/Integer",
            "affectsOutput": "Toggles the visibility of the outline box around the text."
          },
          {
            "name": "DimStyle",
            "technicalDefault": "_DimStyles[0]",
            "businessMeaning": "The text style (font) used for the label.",
            "validRange": "Any existing AutoCAD Text Style",
            "unit": "String",
            "affectsOutput": "Changes the font typeface of the displayed text."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Format string contains invalid tokens",
            "effect": "The script will display the raw token string (e.g., '@(BadProp)') or an empty value instead of data.",
            "cascade": [
              "Text Content"
            ]
          },
          {
            "trigger": "TextHeight increase",
            "effect": "Border box size and line spacing increase proportionally.",
            "cascade": [
              "BorderMode",
              "Geometry Size"
            ]
          },
          {
            "trigger": "Parent Combination property changes",
            "effect": "The text displayed on the label updates automatically to reflect the new values (e.g., width changes).",
            "cascade": [
              "Format"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation / 3D Geometry",
            "description": "Creates a group of graphical entities in ModelSpace consisting of Text (MText/Text), a PLine (Border), and a PlaneProfile (Background Fill).",
            "appliedTo": "Linked to 'hsb-E-Combination' instances. The text is positioned relative to the parent's coordinate system."
          }
        ]
      },
      "tokens_used": 8694,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User launches script (TSLCONTENT command or run from catalog).",
          "2. Script checks execution context (_bOnInsert vs _bOnRecalc).",
          "3. [Insertion Phase] Script reads settings from 'hsbInstallationPointSettings.xml' (MapObject).",
          "4. [Insertion Phase] Script checks execution key (_kExecuteKey).",
          "5. [Insertion Phase - Key Found] If key matches a catalog entry, properties are set from catalog; otherwise, defaults are used.",
          "6. [Insertion Phase - No Key] Dialog (showDialog) is displayed for user configuration.",
          "7. [Insertion Phase] User selects entities (PrEntity prompt).",
          "8. [Insertion Phase] Script filters selection to allow only 'hsb-E-Combination' instances.",
          "9. [Insertion Phase] Script iterates through valid entities and creates a new script instance (dbCreate) attached to each parent Combination.",
          "10. [Insertion Phase] Original temporary script instance is erased.",
          "11. [Recalc/Generation Phase] Script validates parent TslInst reference from _Entity array.",
          "12. [Recalc/Generation Phase] Script checks for duplicate scripts attached to the same parent and erases self if duplicate found.",
          "13. [Recalc/Generation Phase] Script establishes dependency and group assignment to parent.",
          "14. [Recalc/Generation Phase] Script retrieves parent's coordinate system.",
          "15. [Recalc/Generation Phase] Script handles 'Add/Remove Format' context command (if triggered).",
          "16. [Recalc/Generation Phase] Script resolves attributes in the Format string using tslParent.formatObject().",
          "17. [Recalc/Generation Phase] Script splits content into lines based on '\\\\' delimiter.",
          "18. [Recalc/Generation Phase] Script calculates text geometry (size, alignment) relative to parent.",
          "19. [Recalc/Generation Phase] Script draws leader line (if applicable), text, border, and background fill.",
          "20. Script execution completes."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion vs. Recalculation",
            "path1": {
              "name": "Insertion",
              "steps": [
                "Read Settings XML",
                "Check Execute Key",
                "Show Dialog (if no key)",
                "Prompt Entity Selection",
                "Filter Entities (hsb-E-Combination)",
                "Create Child Instance",
                "Erase Temporary Instance"
              ]
            },
            "path2": {
              "name": "Recalculation",
              "steps": [
                "Validate Parent Reference",
                "Check for Duplicates",
                "Process Context Menu Commands",
                "Resolve Attribute Tokens",
                "Draw Geometry (Text, Border, Fill)"
              ]
            }
          },
          {
            "condition": "Duplicate Detection during Recalculation",
            "path1": {
              "name": "Duplicate Found",
              "steps": [
                "Iterate parent's element group",
                "Identify other instances of same script",
                "Check if linked to same parent",
                "Report Message",
                "Erase Self",
                "Stop Execution"
              ]
            },
            "path2": {
              "name": "Unique Instance",
              "steps": [
                "Set Dependency on Parent",
                "Assign to Parent Group",
                "Proceed to Drawing"
              ]
            }
          },
          {
            "condition": "Execution Key (Add/Remove Format)",
            "path1": {
              "name": "Key Active",
              "steps": [
                "List available properties from parent",
                "Display list with indices",
                "Prompt user for index",
                "Toggle property in Format string",
                "Set new Format string",
                "Loop Execution (2)"
              ]
            },
            "path2": {
              "name": "Normal Recalc",
              "steps": [
                "Skip Key Processing",
                "Proceed to Attribute Resolution"
              ]
            }
          },
          {
            "condition": "Resolved Text Content",
            "path1": {
              "name": "Content Empty/Invalid",
              "steps": [
                "Check sLines length",
                "Report 'no values to display'",
                "Erase Instance",
                "Stop"
              ]
            },
            "path2": {
              "name": "Valid Content",
              "steps": [
                "Calculate Text Box Size",
                "Draw Leader Line (optional)",
                "Draw Text",
                "Draw Border (optional)",
                "Draw Fill (optional)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Parent Entity Type",
            "errorMessage": "Implicit (Entity removed from selection set during insertion)",
            "recovery": "User must select a valid 'hsb-E-Combination' instance."
          },
          {
            "check": "Parent Validity (Recalc)",
            "errorMessage": "None (Silent erase)",
            "recovery": "Ensure parent Combination is not deleted; script self-erases if parent is missing."
          },
          {
            "check": "Duplicate Script",
            "errorMessage": "Script Name: duplicate found and erased.",
            "recovery": "System automatically purges duplicates. No user action required."
          },
          {
            "check": "Text Content Availability",
            "errorMessage": "Script Name: no values to display",
            "recovery": "Modify the 'Format' property to include valid tokens that return values."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Text Format (Add/Remove Properties)",
            "how": "Context Menu -> Add/Remove Format",
            "effect": "Opens a command line list of properties to add or remove from the current label string."
          },
          {
            "action": "Modify Text Format (Direct Edit)",
            "how": "Properties Palette (OPM) -> Format",
            "effect": "Manually type or paste a new format string with tokens."
          },
          {
            "action": "Change Visual Style",
            "how": "Properties Palette (OPM) -> TextHeight, Color, FillColor, BorderMode",
            "effect": "Updates the size, color, border visibility, and background fill of the label immediately."
          },
          {
            "action": "Move Label",
            "how": "Grip Edit (typically _Pt0 or similar grip points if exposed, though code calculates relative to parent)",
            "effect": "Repositions the text label relative to the parent coordinate system."
          }
        ]
      },
      "tokens_used": 9707,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb-E-CombinationText.mcr\n\n## Overview\nThis script attaches a dynamic, multi-line text label to `hsb-E-Combination` elements (such as wall or floor panels) within the 3D model. It automatically displays specific properties—like dimensions, material codes, or labels—directly on the structure, updating automatically if the parent element changes.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script generates annotation geometry in the 3D model. |\n| Paper Space | No | Not intended for layout views. |\n| Shop Drawing | No | Not intended for 2D manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities:** An existing `hsb-E-Combination` (TslInst) in the drawing.\n- **Minimum Beam Count:** 0\n- **Required Settings:** `hsbInstallationPointSettings.xml` (must be present in the hsbCAD configuration path).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLCONTENT` (or select the script from the hsbCAD Catalogue)\nAction: Select `hsb-E-CombinationText.mcr` from the list.\n\n### Step 2: Initial Configuration (if applicable)\n```\nDialog: [Dynamic Dialog]\nAction: If no execution key (catalog preset) is found, a dialog appears. \nSelect the desired text style or visual settings, or click OK to accept defaults.\n```\n\n### Step 3: Select Parent Entity\n```\nCommand Line: Select entity:\nAction: Click on the desired hsb-E-Combination (wall/floor panel) you wish to label.\n```\n\n### Step 4: Confirmation\nThe script attaches to the selected Combination and generates the text label based on the default Format string. The text is positioned relative to the parent element's coordinate system.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | String | @(Text 1)\\\\@(Text 2)\\\\... | Defines the text content. Use tokens (e.g., `@(Width)`, `@(Label)`) to pull data from the parent element. Use a backslash `\\` to create line breaks. |\n| TextHeight | Double | U(80) | The physical height of the text characters in the model. |\n| Color (nc) | Integer | ByBlock | The color of the text lines and the border. |\n| FillColor (ncFill) | Integer | -1 (ByBlock) | The background color of the label box. Use `-1` for transparent/ByBlock. |\n| Transparency (nt) | Integer | 70 | The opacity level of the background fill (0 = Opaque, 90 = Transparent). |\n| BorderMode | Integer | 1 | Toggles the border box around the text (0 = No Border, 1 = Border). |\n| DimStyle | String | _DimStyles[0] | The AutoCAD Text Style (font) used for the label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add/Remove Format | Opens a list of available properties from the parent element. Selecting an item adds or removes it from the Format string automatically. |\n\n## Settings Files\n- **Filename**: `hsbInstallationPointSettings.xml`\n- **Location**: hsbCAD Company or Install directory\n- **Purpose**: Provides default configuration values and execution keys for the script during insertion.\n\n## Tips\n- **Quick Line Breaks:** To manually add a line break in the Format property, type a backslash `\\` where you want the text to wrap.\n- **Troubleshooting Text:** If the label displays raw code like `@(UnknownProp)`, the parent Combination does not have that specific property, or the name is spelled incorrectly.\n- **Duplicate Prevention:** The script automatically detects and purges duplicate labels on the same element. If you run the script on a labeled element again, it updates the existing label rather than creating a new one.\n- **Visual Clarity:** Use the `FillColor` and `Transparency` properties to make the text readable over busy geometry.\n\n## FAQ\n- **Q: My text disappeared. How do I get it back?**\n  A: Check the Properties Palette for the `Format` string. If the tokens inside evaluate to empty values (e.g., the parent element has no length), the text will not display. Try adding a static label or a different property.\n- **Q: Can I move the text to a different spot on the wall?**\n  A: Yes. Select the text in the model and use the standard AutoCAD **Move** command or drag the grips to reposition it relative to the parent element.\n- **Q: How do I change the font?**\n  A: In the Properties Palette, change the `DimStyle` parameter to any valid Text Style defined in your drawing."
      },
      "tokens_used": 6151,
      "error": null
    }
  }
}