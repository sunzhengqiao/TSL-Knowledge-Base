{
  "filename": "hsbDACH_ConfigureDensities.mcr",
  "status": "completed",
  "total_tokens": 27177,
  "processing_time": 185.7118101119995,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 0,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.0",
            "date": "24.04.2012",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "First version"
          },
          {
            "version": "1.2",
            "date": "23.06.2021",
            "author": "Marsel Nakuci",
            "changes": "HSB-10308: change the dll path"
          },
          {
            "version": "1.1",
            "date": "11.06.2012",
            "author": null,
            "changes": "Add default density"
          }
        ],
        "settingsFiles": [
          "Materials.xml",
          "hsbGenBeamDensityConfig.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 4369,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No usage of sd_* or Multipage prefixes. No usage of _Viewport or #Type E. Script uses _kPathHsbCompany and _kPathHsbInstall to access file system and DLLs. It runs immediately on insert (_bOnInsert), performs file operations (XML generation/reading), calls a .NET DLL via callDotNetFunction2, and then executes eraseInstance(). It creates no geometry or entities within the drawing."
        },
        "prerequisites": {
          "requiredEntities": [],
          "minimumBeams": 0,
          "requiredSpace": "Must be run in an environment where TSL scripts can be inserted and callDotNetFunction2 is supported (hsbCAD AutoCAD environment).",
          "requiredSettings": [
            "Materials.xml (in Company path, generated if missing)",
            "hsbGenBeamDensityConfig.xml (legacy, optional for migration)",
            "hsbMaterialDensityTable.dll (in Utilities path) or hsbMaterialTable.dll (legacy in Content path)"
          ]
        }
      },
      "tokens_used": 2466,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "insertCycleCount",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowNotice",
            "trigger": "Validation failure of DotNet output",
            "title": null,
            "dataSource": "Hardcoded message",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowNotice",
            "trigger": "DotNet function returns a result string",
            "title": null,
            "dataSource": "DotNet Return Map",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "Materials.xml",
            "searchPaths": [
              "_kPathHsbCompany\\Abbund"
            ],
            "purpose": "Primary configuration file containing material names and densities. Generated if missing.",
            "required": true
          },
          {
            "filename": "hsbGenBeamDensityConfig.xml",
            "searchPaths": [
              "_kPathHsbCompany\\Abbund"
            ],
            "purpose": "Legacy configuration file used for migrating density data if Materials.xml is missing.",
            "required": false
          }
        ]
      },
      "tokens_used": 3379,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "A utility script used to generate or repair the Materials.xml configuration file, which defines material names and their corresponding densities for structural calculations. It also invokes a .NET interface allowing the user to manage (add/edit/delete) these material mappings via an external dialog.",
          "category": "System/Configuration",
          "typicalUseCase": "Used when the 'Materials.xml' file is missing, corrupted, or needs to be updated with new material types and densities (e.g., changing from C24 to GL24h or adding concrete types)."
        },
        "parameters": [
          {
            "name": "sDefaultNames[]",
            "technicalDefault": "[\"D30\",\"D35\",\"D40\",\"D60\",\"GL24c\",\"GL28c\",\"GL32c\",\"GL36c\",\"GL24h\",\"GL28h\",\"GL32h\",\"GL36h\", \"KVH\", \"C24\", \"C30\", \"C40\", \"OSB\", \"Fermacell\", \"Aluminium\", \"Steel\", \"Stainless Steel\", \"Beton\", \"Gasbeton\", \"Kiesbeton\", \"Leichtbeton\", \"Schwerbeton\", \"Schwerstbeton\", \"Window\", \"Door\", \"DEFAULT\"]",
            "businessMeaning": "The list of standard material names predefined by hsbCAD to populate the configuration file if it doesn't exist. These names correspond to timber grades (GL, C, KVH), sheet materials (OSB), and structural materials (Steel, Concrete).",
            "validRange": "Standard construction material designators (e.g., C14-C40, GL24-GL48, generic names).",
            "unit": "String (Text)",
            "affectsOutput": "Populates the dropdown options available in the .NET DLL dialog. If the XML is missing, these become the initial database."
          },
          {
            "name": "dDefaultDensities[]",
            "technicalDefault": "[900,900,900,900,500,500,500,500,500,500,500,500,500,500,500,500,800,2500,2500,7700,7800,1200,700,2100,900,2500,5000,2000,600, 500]",
            "businessMeaning": "The mass density (kg/m³) associated with each default material name. This is critical for calculating the weight of beams and elements for structural analysis, transport planning, and lifting calculations.",
            "validRange": "300 kg/m³ (very soft wood/light materials) to 8000 kg/m³ (heavy metals). Typically 350-800 for timber, 2400-2500 for concrete, 7850 for steel.",
            "unit": "kg/m³",
            "affectsOutput": "Determines the weight properties of elements in the hsbCAD model and downstream reports (e.g., BOM, transport weights)."
          },
          {
            "name": "sPath",
            "technicalDefault": "_kPathHsbCompany + \"\\Abbund\\Materials.xml\"",
            "businessMeaning": "The file system location where the material configuration database is stored. This ensures the settings are project or company-wide rather than local to a single drawing.",
            "validRange": "Valid file path string (network or local drive).",
            "unit": "String (Path)",
            "affectsOutput": "Defines where the script looks for existing settings and where it saves new configurations."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "hsbGenBeamDensityConfig.xml exists",
            "effect": "The script reads legacy density values from the old file and merges them into the new Materials.xml structure to prevent data loss during the upgrade process.",
            "cascade": [
              "sNames",
              "dDensities"
            ]
          },
          {
            "trigger": "Materials.xml exists",
            "effect": "The script skips the generation of default data and proceeds directly to opening the .NET management dialog using the existing data.",
            "cascade": [
              "mapMaterials"
            ]
          },
          {
            "trigger": "hsbMaterialDensityTable.dll is missing",
            "effect": "The script falls back to the legacy DLL path (hsbMaterialTable.dll) to maintain compatibility with older hsbCAD versions.",
            "cascade": [
              "strAssemblyPath",
              "strType"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "XML File",
            "description": "Creates or updates 'Materials.xml' containing a structured list of Material Names and Density values.",
            "appliedTo": "Company/Project configuration folder (_kPathHsbCompany\\Abbund)"
          },
          {
            "type": "Dialog Window",
            "description": "Launches an external .NET GUI (from hsbMaterialDensityTable.dll) allowing the user to interactively view, add, edit, or delete material entries.",
            "appliedTo": "User Interface"
          }
        ]
      },
      "tokens_used": 4733,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User inserts the script (hsbDACH_ConfigureDensities) into the drawing",
          "Script detects insertion event (_bOnInsert)",
          "Script checks insertCycleCount; if > 1, it erases itself to prevent duplicate execution",
          "Script defines the target path for 'Materials.xml' in the Company folder",
          "Script checks if 'Materials.xml' already exists on the disk",
          "[Conditional] If missing, script generates 'Materials.xml':",
          "  - Checks for legacy 'hsbGenBeamDensityConfig.xml' to import existing data",
          "  - Loads hardcoded defaults (e.g., C24, GL24h, Steel, Concrete)",
          "  - Merges legacy and default data (avoiding duplicates)",
          "  - Writes the combined Map structure to 'Materials.xml'",
          "Script defines the path to the .NET DLL (hsbMaterialDensityTable.dll)",
          "[Conditional] If the new DLL is not found, script falls back to legacy DLL (hsbMaterialTable.dll)",
          "Script calls the DotNet function 'LoadMaterialTable' passing the XML path",
          "Script validates the Map returned by the DotNet function",
          "[Conditional] If validation fails, script reports 'No Valid dll or path not found'",
          "[Conditional] If validation succeeds, script reports the result string returned by DLL",
          "Script erases itself (eraseInstance) and terminates"
        ],
        "conditionalBranches": [
          {
            "condition": "Configuration file existence check (sFind)",
            "path1": {
              "name": "File Missing (Initialization Mode)",
              "steps": [
                "Search for legacy 'hsbGenBeamDensityConfig.xml'",
                "If legacy file exists, read densities and names into arrays",
                "Define internal default names (D30, GL24h, etc.) and densities",
                "Loop through defaults: Append to array only if not already present (case-insensitive check)",
                "Construct Map object with 'Material' and 'Density' keys for each entry",
                "Save Map to XML file at _kPathHsbCompany\\Abbund\\Materials.xml"
              ]
            },
            "path2": {
              "name": "File Exists (Edit Mode)",
              "steps": [
                "Skip generation logic",
                "Proceed directly to DLL invocation"
              ]
            }
          },
          {
            "condition": "DotNet DLL availability (sFindDll)",
            "path1": {
              "name": "Standard DLL Found",
              "steps": [
                "Set path to _kPathHsbInstall\\Utilities\\hsbMaterialDensityTable\\hsbMaterialDensityTable.dll",
                "Set Type to 'hsbCad.Tsl.Insertion.MapTransaction'"
              ]
            },
            "path2": {
              "name": "Standard DLL Missing (Legacy Fallback)",
              "steps": [
                "Set path to _kPathHsbInstall\\Content\\General\\MaterialTable\\hsbMaterialTable.dll",
                "Set Type to 'hsbSoft.Tsl.Insertion.MapTransaction'"
              ]
            }
          },
          {
            "condition": "DotNet Return Validation (mapOut)",
            "path1": {
              "name": "Valid Result",
              "steps": [
                "Extract 'Result' string from Map",
                "Display string via reportNotice (usually success or specific error from DLL)",
                "Continue to cleanup"
              ]
            },
            "path2": {
              "name": "Invalid/Empty Result",
              "steps": [
                "Display 'No Valid dll or path not found'",
                "Continue to cleanup"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Map returned by callDotNetFunction2 (mapOut)",
            "errorMessage": "No Valid dll or path not found",
            "recovery": "Ensure the correct hsbMaterialDensityTable.dll (or legacy hsbMaterialTable.dll) exists in the hsbCAD installation directories (Utilities or Content folders). Check that the user has write permissions to create/edit the Materials.xml file."
          }
        ],
        "postInsertionActions": []
      },
      "tokens_used": 6874,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbDACH_ConfigureDensities.mcr\n\n## Overview\nThis script manages the material density database used by hsbCAD for weight and structural calculations. It automatically generates or repairs the `Materials.xml` configuration file and launches a .NET interface that allows you to add, edit, or delete material definitions and their densities.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be run in the Model Space. |\n| Paper Space | No | Not supported in Paper Space layouts. |\n| Shop Drawing | No | Not intended for use within shop drawing contexts. |\n\n## Prerequisites\n- **Required Entities:** None.\n- **Minimum Beam Count:** 0.\n- **Required Settings/Files:**\n    - `hsbMaterialDensityTable.dll` (located in the `hsbCAD\\Utilities` folder).\n    - Write access to the Company folder (`_kPathHsbCompany\\Abbund`) to create or modify the XML files.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbDACH_ConfigureDensities.mcr`\n\n### Step 2: Automatic Execution\n**Action:** Upon insertion, the script runs automatically.\n- If the `Materials.xml` file is missing in your Company folder, the script will generate it using built-in defaults (e.g., C24, GL24h, Steel, Concrete).\n- If a legacy configuration file (`hsbGenBeamDensityConfig.xml`) exists, the script will migrate your old data into the new format.\n\n### Step 3: Manage Materials\n**Action:** A dialog window will appear displaying the current material table.\n- Use this interface to **Add** new materials, **Edit** existing densities, or **Delete** entries.\n- Changes are saved immediately to the `Materials.xml` file.\n\n### Step 4: Completion\n**Action:** Close the dialog window.\n- The script will display a result message indicating success or reporting an error.\n- The script instance will automatically erase itself from the drawing to keep your project clean.\n\n## Properties Panel Parameters\nThis script does not expose any user-editable parameters in the Properties Palette (OPM). All configuration is handled via the external dialog window launched upon insertion.\n\n## Right-Click Menu Options\nThere are no custom right-click menu options associated with this script.\n\n## Settings Files\n- **Filename:** `Materials.xml`\n  - **Location:** `_kPathHsbCompany\\Abbund\\`\n  - **Purpose:** Stores the list of material names and their corresponding densities (kg/m³). This file is used by other scripts to calculate element weights.\n\n- **Filename:** `hsbGenBeamDensityConfig.xml`\n  - **Location:** `_kPathHsbCompany\\Abbund\\`\n  - **Purpose:** Legacy file used to import old density settings if `Materials.xml` is not found. Safe to delete after migration.\n\n## Tips\n- **Automatic Cleanup:** Do not be alarmed if the script entity disappears immediately after insertion; this is intended behavior to prevent drawing clutter.\n- **Default Values:** The script comes pre-loaded with common timber grades (C24, GL24h, KVH) and structural materials (Steel, Concrete) so the file is usable immediately.\n- **Unit Consistency:** Densities are stored in kg/m³. Ensure you enter values in this unit for correct weight calculations in BOMs and transport reports.\n\n## FAQ\n- **Q: Why did the script disappear after I inserted it?**\n  - A: This is a utility script that performs a setup task and then self-destructs (`eraseInstance`). It does not represent a physical object in your building model.\n\n- **Q: I received the error \"No Valid dll or path not found\". What does this mean?**\n  - A: The script cannot locate the required interface DLL. Check your hsbCAD installation folder to ensure `hsbMaterialDensityTable.dll` exists in the `Utilities` subfolder. You may also need to check your user permissions for the Company folder.\n\n- **Q: How do I share my material list with colleagues?**\n  - A: Since the data is stored in `Materials.xml` in the shared Company folder, your changes are automatically available to anyone using the same company configuration path."
      },
      "tokens_used": 5356,
      "error": null
    }
  }
}