{
  "filename": "hsbBlockVisualizer.mcr",
  "status": "completed",
  "total_tokens": 23851,
  "processing_time": 197.88543581962585,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.2",
            "date": "24-6-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Add scaling for blockrefs which have been inserted with a scale."
          },
          {
            "version": "1.1",
            "date": "17-6-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Fix check whether the block is found in the libarary in the drawing."
          },
          {
            "version": "1.0",
            "date": "26-3-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Initial version."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4401,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script prompts for BlockRef entities and uses Block.visualize() to render geometry in the display composer. It assigns instances to Element groups and operates on _Entity[0] containing a BlockRef. There are no references to Sheets, Viewports, or SD-specific prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "BlockRef"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 3078,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select blockref entities|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 2396,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Visualizes standard AutoCAD Block References within the hsbCAD environment (Display Composer) by attaching a TSL instance to selected blocks.",
          "category": "Visualization / Utility",
          "typicalUseCase": "A user imports an architectural DWG containing non-hsbCAD blocks (e.g., windows, furniture, or equipment) and needs these elements to be visible in the 3D model and generated reports/views within hsbCAD."
        },
        "parameters": [
          {
            "name": "BlockRef Selection",
            "technicalDefault": "N/A (Interactive Prompt)",
            "businessMeaning": "The selection of standard AutoCAD block entities that require visualization in the hsbCAD display system.",
            "validRange": "Any valid BlockRef entity existing in the Model Space.",
            "unit": "Entity",
            "affectsOutput": "Determines the geometry, location, orientation, and scale of the object displayed in the hsbCAD Composer."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "BlockRef Entity Attributes (Scale X/Y/Z, Definition Name, Coordinate System)",
            "effect": "The script reads the properties of the selected BlockRef to generate the visualization. If the block definition is missing from the internal library, visualization fails.",
            "cascade": [
              "Block Visualization Geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Block Visualization",
            "description": "Visual representation of the AutoCAD block geometry rendered in the display composer via Block.visualize().",
            "appliedTo": "The coordinate system of the selected BlockRef entity."
          }
        ]
      },
      "tokens_used": 4609,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launched via command or catalog.",
          "2. Check insertion cycle count. If count > 1 (e.g., copy/array operation), erase instance immediately.",
          "3. Prompt user 'Select blockref entities'.",
          "4. [Conditional] User completes selection.",
          "5. Iterate through all selected BlockRef entities.",
          "6. For each BlockRef, generate a new TSL instance linked to that specific entity (passing origin and entity as parameters).",
          "7. Erase the initial 'launcher' instance.",
          "8. [Child Instance Execution] Validate that the linked BlockRef entity is valid.",
          "9. Extract coordinate system, scale factors (X/Y/Z), and Element assignment from the BlockRef.",
          "10. Assign TSL instance to the Element group of the BlockRef.",
          "11. Check if the Block's definition exists in the current drawing's block library (_BlockNames).",
          "12. [Conditional] Visualization or Error Reporting.",
          "13. Script finishes and returns."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count (insertCycleCount)",
            "path1": {
              "name": "Copy/Array Detected (> 1)",
              "steps": [
                "Erase current instance immediately.",
                "Return (stop execution)."
              ]
            },
            "path2": {
              "name": "Initial Insert (= 1)",
              "steps": [
                "Proceed to prompt user for BlockRef selection."
              ]
            }
          },
          {
            "condition": "User Selection (ssBlockRefs.go())",
            "path1": {
              "name": "Selection Made",
              "steps": [
                "Retrieve set of entities.",
                "Loop through selection.",
                "Create TSL instances.",
                "Erase launcher."
              ]
            },
            "path2": {
              "name": "Selection Cancelled/Empty",
              "steps": [
                "Erase launcher.",
                "Return."
              ]
            }
          },
          {
            "condition": "Linked Entity Integrity (blockref.bIsValid())",
            "path1": {
              "name": "Valid Entity",
              "steps": [
                "Extract geometry data (CS, Scale).",
                "Proceed to definition check."
              ]
            },
            "path2": {
              "name": "Invalid Entity",
              "steps": [
                "Erase instance.",
                "Return."
              ]
            }
          },
          {
            "condition": "Block Definition Availability (_BlockNames.find)",
            "path1": {
              "name": "Definition Found in Library",
              "steps": [
                "Create Block object using definition name.",
                "Execute Block.visualize with extracted origin and scaled vectors."
              ]
            },
            "path2": {
              "name": "Definition Missing",
              "steps": [
                "Execute reportMessage warning user block is not loaded.",
                "No geometry generated."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "BlockRef Entity Validity",
            "errorMessage": "None (Silent failure/erasure)",
            "recovery": "Ensure the selected entity is a valid BlockRef that has not been deleted from the database."
          },
          {
            "check": "Block Definition in Drawing Library",
            "errorMessage": "Block is not loaded in the drawing, load block [Name] again.",
            "recovery": "User must insert or reload the specific block definition into the AutoCAD drawing for the TSL to visualize it."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Geometry",
            "how": "Move, Rotate, or Scale the source BlockRef using standard AutoCAD grips.",
            "effect": "On recalculation, the TSL reads the new coordinate system and scale, updating the visualization accordingly."
          },
          {
            "action": "Change Element Assignment",
            "how": "Change the Element/Layer of the source BlockRef.",
            "effect": "The TSL instance updates its element group assignment to match the BlockRef."
          }
        ]
      },
      "tokens_used": 5122,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbBlockVisualizer.mcr\n\n## Overview\nThis script enables standard AutoCAD Block References to be visualized within the hsbCAD Display Composer. It is useful for displaying non-hsbCAD elements (such as imported architectural windows, furniture, or equipment) in 3D views and generated reports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script functions in the model environment. |\n| Paper Space | No | Not supported in Layouts. |\n| Shop Drawing | No | Not intended for manufacturing views. |\n\n## Prerequisites\n- **Required Entities**: Standard AutoCAD Block References (`BlockRef`).\n- **Minimum Beam Count**: 0 (This script works independently of beams).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `hsbBlockVisualizer.mcr` from the list.\n\n### Step 2: Select Block References\n```\nCommand Line: |Select blockref entities|\nAction: Click on one or more standard AutoCAD blocks in your drawing that you wish to visualize in hsbCAD.\n```\n\n### Step 3: Complete Selection\n```\nCommand Line: (Press Enter to finish selection)\nAction: Press Enter or Right-click to confirm the selection.\n```\n*Note: The script will automatically attach itself to the selected blocks and make them visible in the hsbCAD 3D view.*\n\n## Properties Panel Parameters\n\nThere are no user-editable properties in the AutoCAD Properties Palette for this script. All visualization data is derived directly from the selected Block Reference entity.\n\n## Right-Click Menu Options\n\nThere are no specific custom right-click menu options added by this script.\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Scaling Support**: If you scale a Block Reference using AutoCAD grips or properties, the hsbCAD visualization will automatically update to match the new scale.\n- **Element Assignment**: If you change the Element (Layer) of the original Block Reference, the visualization will update its assignment to match.\n- **Visibility**: To hide the visualization in hsbCAD views, you can simply turn off the layer of the original Block Reference.\n\n## FAQ\n\n- **Q: Why do I see the warning \"Block is not loaded in the drawing\"?**\n  **A**: The script cannot find the block definition in the current drawing's block table. You may need to insert the block definition into the drawing again or ensure it has not been purged.\n\n- **Q: Can I use this on dynamic blocks?**\n  **A**: This script is designed for standard Block References. While it may work on some dynamic blocks, results depend on how the dynamic block geometry is calculated by AutoCAD.\n\n- **Q: What happens if I delete the original block?**\n  **A**: The hsbCAD visualization instance detects that the linked entity is invalid and will automatically erase itself to prevent errors."
      },
      "tokens_used": 4245,
      "error": null
    }
  }
}