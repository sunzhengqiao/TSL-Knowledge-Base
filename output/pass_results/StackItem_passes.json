{
  "filename": "StackItem.mcr",
  "status": "completed",
  "total_tokens": 53246,
  "processing_time": 307.29813742637634,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 4,\n    \"minorVersion\": 4,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"4.4\",\n      \"date\": \"18.06.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-24005 grip move behaviour imrpoved\"\n    },\n    {\n      \"version\": \"4.3\",\n      \"date\": \"28.02.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22730 new component display, now also supporting MetalPartCollections\"\n    },\n    {\n      \"version\": \"4.2\",\n      \"date\": \"12.02.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22730 display compon"
      },
      "tokens_used": 9044,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script utilizes 3D spatial commands such as PrPoint (jigging), getPoint, AlignCoordSysView, and Body.shadowProfile. It performs 3D rotations and transformations on the TSL instance. While it contains a property to 'Hide in Shopdrawing', its core logic is for 3D logistics and stacking in the model environment. No 'sd_' API calls or 'Multipage' prefixes were detected."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Beam",
            "Sheet",
            "Panel",
            "Element",
            "Wall",
            "RoofFloor",
            "MetalPart"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space for interactive placement and rotation of stack items.",
          "requiredSettings": [
            "TslUtilities.dll",
            "TruckDefinition configurations",
            "Parent scripts: StackPack, StackEntity"
          ]
        }
      },
      "tokens_used": 7634,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select origin point [Vertical/Horizontal]|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "SelectFromList",
              "promptOriginal": "Select entities to create a flattened child representation",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "|Pick point to place item|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": [
            {
              "prompt": "|Select origin point [Vertical/Horizontal]|",
              "options": [
                "|Vertical|",
                "|Horizontal|"
              ]
            },
            {
              "prompt": "|Pick point to rotate [Angle/Basepoint/ReferenceLine]|",
              "options": [
                "|Angle|",
                "|Basepoint|",
                "|ReferenceLine|"
              ]
            },
            {
              "prompt": "|Enter angle in degrees|",
              "options": []
            },
            {
              "prompt": "|Select base point|",
              "options": []
            },
            {
              "prompt": "|Select point on reference line|",
              "options": []
            }
          ]
        },
        "dialogs": [
          {
            "type": "SelectFromList",
            "trigger": "Insertion",
            "title": null,
            "dataSource": "Entity Types (GenBeam, Beam, Sheet, Panel, Element, Wall, RoofFloor, MetalPart)",
            "features": {
              "searchable": true,
              "multiSelect": true
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 1,
            "variable": "bVisible",
            "type": "PropInt",
            "displayName": "|Visible|",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 2,
            "variable": "nItemMode",
            "type": "PropInt",
            "displayName": "|Item Mode|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|Edit|",
              "|Hidden|",
              "|Hide in Shopdrawing|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 3,
            "variable": "bShowBodies",
            "type": "PropInt",
            "displayName": "|Show 3D Bodies|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|General|",
            "description": null
          },
          {
            "index": 4,
            "variable": "sFilter",
            "type": "PropString",
            "displayName": "|Filter|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "Exclude items from stacking by this filter"
          },
          {
            "index": 5,
            "variable": "dHeight",
            "type": "PropDouble",
            "displayName": "|Spacer Height|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Stacking|",
            "description": null
          },
          {
            "index": 6,
            "variable": "bProjectionDisplay",
            "type": "PropInt",
            "displayName": "|Projection Display|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              "|None|",
              "|Top|",
              "|Bottom|",
              "|Top + Bottom|",
              "|Front|",
              "|Back|",
              "|Front + Back|",
              "|Right|",
              "|Left|",
              "|Left + Right|",
              "|All|"
            ],
            "category": "|Stacking|",
            "description": "Show item boundaries"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Flip Face|",
            "handler": "|Flip Face|",
            "action": "Rotates the item 180 degrees around the X-axis.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Rotate 90°|",
            "handler": "|Rotate 90°|",
            "action": "Rotates the item 90 degrees around the Z-axis.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Rotate 180°|",
            "handler": "|Rotate 180°|",
            "action": "Rotates the item 180 degrees around the Z-axis.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Flip + Rotate|",
            "handler": "|Flip + Rotate|",
            "action": "Rotates the item 180 degrees around X and Z axes.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Rotate Item|",
            "handler": "Rotate Item",
            "action": "Interactive jig rotation around selected axis.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "TslUtilities.dll",
            "searchPaths": [
              "_kPathHsbInstall"
            ],
            "purpose": "Provides dialog services (SelectFromList, etc.).",
            "required": true
          },
          {
            "filename": "TruckDefinition",
            "searchPaths": [
              "hsbCAD Configuration"
            ],
            "purpose": "Configuration for truck dimensions and stacking rules.",
            "required": false
          }
        ]
      },
      "tokens_used": 8824,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a virtual container (pack) for construction elements (beams, panels, walls) to manage logistics, truck loading, and site delivery organization.",
          "category": "Logistics / Production Management",
          "typicalUseCase": "Used during the pre-production phase to group specific elements into a 'lift' or 'pack' that will be loaded onto a truck together, ensuring correct spacing and orientation for transport."
        },
        "parameters": [
          {
            "name": "sName",
            "technicalDefault": "\"\"",
            "businessMeaning": "User-defined identifier for the specific stack item or pack (e.g., 'Pack A', 'Floor 1 Walls').",
            "validRange": "Text string (alphanumeric)",
            "unit": "Text",
            "affectsOutput": "Updates the label displayed in the model and used in data exports/listings for identification."
          },
          {
            "name": "bVisible",
            "technicalDefault": "1",
            "businessMeaning": "Controls the visibility of the stack item representation in the 3D model.",
            "validRange": "0 (No), 1 (Yes)",
            "unit": "Boolean",
            "affectsOutput": "Hides or shows the item in the 3D view without deleting the logical grouping data."
          },
          {
            "name": "nItemMode",
            "technicalDefault": "0",
            "businessMeaning": "Determines how the stack item behaves in different project environments (3D Model vs. 2D Shop Drawings).",
            "validRange": "0 (Edit), 1 (Hidden), 2 (Hide in Shopdrawing)",
            "unit": "Enumeration",
            "affectsOutput": "If set to 'Hide in Shopdrawing', the item is visible in the 3D logistics model but automatically excluded from 2D production drawings and CNC exports, preventing confusion between structural parts and transport packaging."
          },
          {
            "name": "bShowBodies",
            "technicalDefault": "0",
            "businessMeaning": "Toggles between showing the full 3D geometry of the contents versus a simplified representation.",
            "validRange": "0 (No), 1 (Yes)",
            "unit": "Boolean",
            "affectsOutput": "When 'No', improves performance by displaying only boundaries or outlines. When 'Yes', renders the actual heavy timber geometries inside the pack."
          },
          {
            "name": "sFilter",
            "technicalDefault": "\"\"",
            "businessMeaning": "Exclusion rule to prevent specific entities from being included in the stack (e.g., ignoring sheathing or small metal hardware).",
            "validRange": "String matching entity properties or names",
            "unit": "Text",
            "affectsOutput": "Filters the list of selected entities during calculation, removing matches from the visual and logical stack."
          },
          {
            "name": "dHeight",
            "technicalDefault": "0",
            "businessMeaning": "The physical thickness of the wooden sticks/spacers placed between layers of the stack.",
            "validRange": "0 - 200 mm (Typically 20-50mm)",
            "unit": "mm",
            "affectsOutput": "Increases the calculated total height of the stack for truck loading verification and collision detection."
          },
          {
            "name": "bProjectionDisplay",
            "technicalDefault": "0",
            "businessMeaning": "Visualizes the bounding box outlines of the stack item from specific orthographic directions.",
            "validRange": "0 (None) to 10 (All)",
            "unit": "Enumeration",
            "affectsOutput": "Draws polylines representing the Top, Bottom, Front, Back, Left, or Right extents of the item, useful for checking packing density or creating 2D loading diagrams."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nItemMode set to 'Hide in Shopdrawing'",
            "effect": "Suppresses the item in all 2D generation processes, regardless of 'bVisible' setting.",
            "cascade": [
              "View Generation",
              "Plotting"
            ]
          },
          {
            "trigger": "dHeight change",
            "effect": "Shifts the vertical placement of subsequent items stacked on top of this one.",
            "cascade": [
              "StackEntity calculations",
              "Truck Load Height"
            ]
          },
          {
            "trigger": "Context Menu 'Rotate' commands",
            "effect": "Modifies the internal transformation matrix of the TSL instance.",
            "cascade": [
              "ProjectionDisplay orientation",
              "Stacking footprint"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TSL Instance (StackItem)",
            "description": "The logical container object holding the references to the construction elements.",
            "appliedTo": "Model Space (as a parent/grouping node)"
          },
          {
            "type": "PLine / Visual Geometry",
            "description": "Temporary or graphical lines representing the stack boundaries (Projection Display) or rotation jigs.",
            "appliedTo": "Current View / Model Space"
          }
        ]
      },
      "tokens_used": 9636,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User launches the StackItem script (Command or Catalog).",
          "2. Script enters '_bOnInsert' state.",
          "3. Command Line Prompt: 'Select origin point [Vertical/Horizontal]'.",
          "4. User picks a point OR selects a Keyword ('Vertical' or 'Horizontal') to define initial orientation.",
          "5. Dialog opens: 'Select entities to create a flattened child representation'.",
          "6. User selects Entity Types (Beam, Panel, etc.) and selects objects in the model.",
          "7. Command Line Prompt: 'Pick point to place item'.",
          "8. User selects the final location for the StackItem.",
          "9. Script calculates Bounding Box and visual representation based on properties.",
          "10. StackItem TSL instance is created in Model Space."
        ],
        "conditionalBranches": [
          {
            "condition": "Input at 'Select origin point' prompt (Step 3)",
            "path1": {
              "name": "Standard Placement",
              "steps": [
                "User picks a point.",
                "Coordinate system (CS) is set based on current UCS/View."
              ]
            },
            "path2": {
              "name": "Vertical Orientation",
              "steps": [
                "User types 'Vertical' or selects keyword.",
                "Script forces item orientation to vertical Z-axis alignment."
              ]
            },
            "path3": {
              "name": "Horizontal Orientation",
              "steps": [
                "User types 'Horizontal' or selects keyword.",
                "Script forces item orientation to lay flat."
              ]
            }
          },
          {
            "condition": "User executes 'Rotate Item' context menu command",
            "path1": {
              "name": "Interactive Rotation",
              "steps": [
                "Jig displays axis selection (X/Y/Z).",
                "User selects an axis.",
                "Script aligns view to the selected axis.",
                "User drags cursor to rotate item visually.",
                "Script applies transformation matrix to the instance."
              ]
            },
            "path2": {
              "name": "Explicit Angle Input",
              "steps": [
                "Jig active.",
                "User types 'Angle'.",
                "Command Line prompt: 'Enter angle in degrees'.",
                "User inputs numeric value.",
                "Script applies exact rotation."
              ]
            },
            "path3": {
              "name": "Change Basepoint",
              "steps": [
                "Jig active.",
                "User types 'Basepoint'.",
                "Prompt: 'Select base point'.",
                "User picks new origin.",
                "Rotation axis/jig relocates to new point."
              ]
            },
            "path4": {
              "name": "Align to Reference Line",
              "steps": [
                "Jig active.",
                "User types 'ReferenceLine'.",
                "Prompt: 'Select point on reference line'.",
                "User picks two points or a line geometry.",
                "Script calculates rotation to align local X-axis with the reference line."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "User Cancellation during Rotation Jig",
            "errorMessage": "None (Silent Cancel)",
            "recovery": "If 'Esc' is pressed or '_kCancel' returned, the script sets 'bCancel=true', breaks the jig loop, and does NOT apply the transformation. The item remains in its previous state."
          },
          {
            "check": "Entity Selection Filter",
            "errorMessage": "None",
            "recovery": "If 'sFilter' property is set, the script internally excludes matching entities from the stack calculation without prompting the user."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Item",
            "how": "Grip Edit (Point)",
            "effect": "Moves the StackItem instance. Script attempts to update parent-child relationships (e.g., dragging into a StackPack) based on 'dSnapTolerance'."
          },
          {
            "action": "Quick Rotate",
            "how": "Context Menu -> 'Rotate 90°', 'Rotate 180°', 'Flip Face', 'Flip + Rotate'",
            "effect": "Immediately applies a fixed 90 or 180-degree rotation transformation around the instance's Center of Gravity or local axes."
          },
          {
            "action": "Complex Rotate",
            "how": "Context Menu -> 'Rotate Item'",
            "effect": "Initiates the full rotation jig workflow allowing axis selection, reference line alignment, and angle input."
          },
          {
            "action": "Toggle Visibility",
            "how": "OPM Property 'bVisible'",
            "effect": "Hides or Shows the item in the 3D model."
          },
          {
            "action": "Adjust Stack Settings",
            "how": "OPM Property 'dHeight' (Spacer Height) or 'bProjectionDisplay'",
            "effect": "Updates the physical height calculation and toggles the display of bounding box outlines (Top/Bottom/Side views)."
          }
        ]
      },
      "tokens_used": 11196,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# StackItem.mcr\n\n## Overview\nCreates a virtual container (pack) to group construction elements like beams, panels, and walls for logistics, truck loading, and site delivery organization. It allows you to visualize and manage how items are stacked and transported without modifying the structural model.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used for 3D logistics planning and placement. |\n| Paper Space | No | Not intended for 2D annotation. |\n| Shop Drawing | No | While it can be hidden in shop drawings, the script operates in the 3D model. |\n\n## Prerequisites\n- **Required Entities**: GenBeam, Beam, Sheet, Panel, Element, Wall, RoofFloor, or MetalPart.\n- **Minimum Beam Count**: 0 (Can represent a single item or a group).\n- **Required Settings**: `TslUtilities.dll` (must be present in hsbCAD installation path).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `StackItem.mcr` from the catalog.\n\n### Step 2: Set Origin and Orientation\n```\nCommand Line: |Select origin point [Vertical/Horizontal]|\nAction: Click in the model to set the base point, or type a keyword:\n- Type \"Vertical\" to align the item upright.\n- Type \"Horizontal\" to lay the item flat.\n```\n\n### Step 3: Select Content\n```\nCommand Line: (Dialog appears)\nAction: A selection dialog opens.\n1. Check the boxes for the entity types you wish to include (e.g., \"Beam\", \"Panel\").\n2. Select the specific objects in the drawing that belong in this stack.\n3. Confirm the selection.\n```\n\n### Step 4: Place Item\n```\nCommand Line: |Pick point to place item|\nAction: Click the final location in the model where the stack item should be positioned.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Name | Text | \"\" | User-defined name for the stack (e.g., \"Pack A\", \"Floor 1 Walls\"). |\n| Visible | Dropdown | Yes | Controls visibility of the stack in the 3D model (Yes/No). |\n| Item Mode | Dropdown | Edit | Controls behavior in drawings. Select \"Hide in Shopdrawing\" to keep logistics data out of production layouts. |\n| Show 3D Bodies | Dropdown | No | If \"No\", shows a simplified representation for performance. If \"Yes\", renders the full geometry of the contents. |\n| Filter | Text | \"\" | Excludes items from the stack based on this name/text filter. |\n| Spacer Height | Number | 0 | Physical thickness of spacers (sticks) between layers in mm. Used for calculating total stack height. |\n| Projection Display | Dropdown | None | Displays bounding box outlines (Top, Bottom, Front, etc.) to visualize the footprint and volume. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Face | Rotates the item 180 degrees around the X-axis (top becomes bottom). |\n| Rotate 90° | Rotates the item 90 degrees around the Z-axis. |\n| Rotate 180° | Rotates the item 180 degrees around the Z-axis. |\n| Flip + Rotate | Combines a Flip Face and 180° rotation. |\n| Rotate Item | Opens an advanced rotation jig with the following sub-options:<br>- **Angle**: Enter a specific degree value.<br>- **Basepoint**: Pick a new pivot point for rotation.<br>- **ReferenceLine**: Align the item to a selected line in the model. |\n\n## Settings Files\n- **Filename**: `TslUtilities.dll`\n- **Location**: `_kPathHsbInstall` (hsbCAD installation directory)\n- **Purpose**: Provides the selection dialog interface and interaction services.\n\n## Tips\n- **Truck Loading**: Use the *Spacer Height* property to account for wooden dunnage between layers. This ensures your calculated stack height matches real-world truck dimensions.\n- **Clean Drawings**: Set *Item Mode* to \"Hide in Shopdrawing\". This keeps your logistics organization visible in the 3D model but prevents it from cluttering your 2D production plans.\n- **Visualization**: Toggle *Projection Display* to \"All\" to see exactly how much volume the pack occupies. This is useful for checking if items will fit through doors or in specific transport bays.\n- **Grip Editing**: You can drag the StackItem using its grip point. If you drop it onto a `StackPack`, it may automatically snap into the parent container.\n\n## FAQ\n- **Q: How do I prevent specific small parts (like metal plates) from appearing in my stack?**\n  A: Use the **Filter** property in the Properties Palette. Enter the name or property of the items you want to exclude, and they will be filtered out of the stack representation.\n  \n- **Q: Can I align the stack exactly with a wall or other line?**\n  A: Yes. Right-click the stack, select **Rotate Item**, and choose the **ReferenceLine** option. Then select two points on the line you want to align with.\n\n- **Q: Why is my stack visible in the model but not in the layouts?**\n  A: Check the **Item Mode** property. It is likely set to \"Hide in Shopdrawing\". Change it to \"Edit\" if you need it to appear in the layout."
      },
      "tokens_used": 6912,
      "error": null
    }
  }
}