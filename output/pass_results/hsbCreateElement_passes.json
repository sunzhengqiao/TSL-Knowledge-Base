{
  "filename": "hsbCreateElement.mcr",
  "status": "completed",
  "total_tokens": 52891,
  "processing_time": 298.3080368041992,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 0,\n    \"minorVersion\": 0,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"2.5\",\n      \"date\": \"10.01.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-17018 wording improved\"\n    },\n    {\n      \"version\": \"2.4\",\n      \"date\": \"05.08.2022\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-16199 Major update, new properties allow faster and more specific creation of elements\"\n    },\n    {\n      \"version\": \"2.3\",\n      \"date\": \"15.03.2022\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-14836: no translation for options\"\n    },\n    {\n      \"version\": \"2.2\",\n      \"date\": \"15.09.2021\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"HSB-13188: fix the options at the prompt\"\n    },\n    {\n      \"version\": \"2.1\",\n      \"date\": \"09.04.2021\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-11500 - Zone 0 assignment corrected\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"date\": \"08.04.2021\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-11489 new command line options DrawContour and createRectangle added\"\n    },\n    {\n      \"version\": \"1.9\",\n      \"date\": \"08.04.2021\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-11464 various options added to allow shape modifications during insert. Zone assignment enhanced, new preview during insert.\"\n    },\n    {\n      \"version\": \"1.8\",\n      \"date\": \"23nov2020\",\n      \"author\": \"alberto.jena@hsbcad.com\",\n      \"changes\": \"SetPanhand of the selected beams\"\n    },\n    {\n      \"version\": \"1.7\",\n      \"date\": \"10jan2020\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-6318 accepting trusses which overlap zone 0\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"09jan2020\",\n      \"author\": \"thorsten.huck@"
      },
      "tokens_used": 9326,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script creates 'ElementRoof' objects via 'dbCreate', processes 'GenBeam' entities, uses '_bOnJig' for interactive insertion, and sets 'bForceModelSpace = true' for plugin TSLs. No 'sd_' prefixes or Viewport usage found."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Sheet",
            "Panel"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space",
          "requiredSettings": [
            "Building and Floor group definitions",
            "Element naming strategy (Prefix/Format)"
          ]
        }
      },
      "tokens_used": 7462,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9629,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a structural ElementRoof (or floor) from selected loose entities (beams, panels), defining its 3D contour, zone thickness, and organizational grouping (Building/Floor) for production.",
          "category": "Framing/Modeling",
          "typicalUseCase": "Assembling a set of rafters, purlins, and sheathing into a single production unit 'Roof Element' to generate drawings, BOMs, and CNC data."
        },
        "parameters": [
          {
            "name": "House Group",
            "technicalDefault": "Undefined",
            "businessMeaning": "The specific building or project phase the element belongs to (e.g., 'MainHouse', 'Garage'). Used for filtering in lists and exports.",
            "validRange": "Text string matching existing project groups",
            "unit": "String",
            "affectsOutput": "Determines the parent folder in the project tree and the group path for the element."
          },
          {
            "name": "Floor Group",
            "technicalDefault": "Undefined",
            "businessMeaning": "The level or story the element resides on (e.g., 'GroundFloor', 'Roof').",
            "validRange": "Text string matching existing project groups",
            "unit": "String",
            "affectsOutput": "Nest elements under the specific level in the project browser."
          },
          {
            "name": "Element Number/Prefix",
            "technicalDefault": "\"\"",
            "businessMeaning": "The unique identifier or naming pattern for the element (supports format variables like counters).",
            "validRange": "Alphanumeric strings, often including prefixes like 'R-' or 'F-'",
            "unit": "String",
            "affectsOutput": "Sets the Element Name visible in tags, drawings, and production lists."
          },
          {
            "name": "Contour Mode",
            "technicalDefault": "Default",
            "businessMeaning": "Algorithm used to calculate the outer boundary of the element (e.g., exact shadow of beams, bounding box, or drawn rectangle).",
            "validRange": "Default, Bounding Shadow, Purge Contour, Draw Rectangle",
            "unit": "Enum",
            "affectsOutput": "Defines the geometric shape of the ElementRoof used for dimensioning and collision checks."
          },
          {
            "name": "Reference Plane",
            "technicalDefault": "Default",
            "businessMeaning": "Defines how the element aligns vertically relative to the selected entities (e.g., bottom-most beam, top-most, or specific panel face).",
            "validRange": "Default, ByPanel",
            "unit": "Enum",
            "affectsOutput": "Determines the Z-elevation and orientation of the element's local coordinate system."
          },
          {
            "name": "Element Thickness (dZ)",
            "technicalDefault": "0",
            "businessMeaning": "The overall structural depth of the element used for zone calculation and volume estimation.",
            "validRange": "50mm - 1000mm (Typical rafter/joist depths)",
            "unit": "mm",
            "affectsOutput": "Sets the D-BeamWidth of the ElementRoof; influences how zones are sliced."
          },
          {
            "name": "Exclusive Assignment",
            "technicalDefault": "Yes",
            "businessMeaning": "Determines if the selected beams belong ONLY to this new element or can be shared with other elements (e.g., a wall top plate shared with a floor).",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "Controls the entity assignment logic (exclusive vs. non-exclusive zones) and prevents double-counting in BOMs if Yes."
          },
          {
            "name": "Plugin Scripts",
            "technicalDefault": "Empty",
            "businessMeaning": "List of additional TSL scripts to run automatically after creation (e.g., add sheathing, generate gable cuts).",
            "validRange": "List of valid .mcr filenames",
            "unit": "String (List)",
            "affectsOutput": "Instantiates sub-components or applies further processing automatically."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Contour Mode set to 'Draw Rectangle'",
            "effect": "Enables interactive Jig/Polygon drawing tools, ignoring the automatic shadow calculation of selected beams.",
            "cascade": [
              "ptsContour"
            ]
          },
          {
            "trigger": "Element Number/Prefix contains format variables",
            "effect": "Triggers the numbering logic to parse strings and increment counters based on previous elements.",
            "cascade": [
              "sComposedNumber"
            ]
          },
          {
            "trigger": "House/Floor Groups are changed",
            "effect": "Updates the Group path where the ElementRoof is stored in the database.",
            "cascade": [
              "sElementGroupName"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElementRoof",
            "description": "The main structural assembly object containing geometry, zones, and metadata.",
            "appliedTo": "New group defined by House/Floor inputs."
          },
          {
            "type": "TslInst",
            "description": "Instances of plugin scripts specified in the 'Plugin Scripts' parameter.",
            "appliedTo": "The newly created ElementRoof."
          }
        ]
      },
      "tokens_used": 9422,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization: Load constants, colors, view vectors, and read debug settings.",
          "User Selection: Prompts user to select loose entities (GenBeams, Sheets, Panels, Collections, Trusses) using the filter '(filter Entity (type GenBeam) (type Sheet) (type Panel) (type Collection) (type Truss))'.",
          "Filter Selection: Filters out entities already assigned to an existing element, keeping only 'loose' entities.",
          "Coordinate System Setup: Establishes origin and vectors based on the 'ReferencePlane' property.",
          "Interactive Jig (_bOnJig): User interacts dynamically to position the element contour, thickness, and rotation using keyboard options (Rectangle, Polygon, Rotate, Swap).",
          "Jig Termination: User presses Enter/Space to confirm the previewed position and geometry.",
          "Zone Calculation: Iterates through entities to calculate their Z-height relative to the element plane, aggregating them into zones.",
          "Contour Generation: Determines the outer boundary (Default, Bounding Shadow, Purge, or User Drawn Rectangle/Polygon).",
          "Element Numbering: Generates a name based on the user-specified format/prefix and existing elements.",
          "Group Creation: Creates the logical group structure (House\\Floor\\ElementNumber).",
          "Element Creation: Instantiates the ElementRoof entity within the group, applying the calculated VecZ, VecY, and Thickness.",
          "Entity Assignment: Assigns all selected loose entities to the new ElementRoof's respective zones.",
          "Plugin Execution: Executes any secondary scripts defined in the 'Plugin Scripts' list (OnDbCreated event).",
          "Cleanup: Erases the script instance and finalizes."
        ],
        "conditionalBranches": [
          {
            "condition": "Is a 'Reference' entity selected to define orientation?",
            "path1": {
              "name": "Single Entity Reference",
              "steps": [
                "Extracts CoordSys directly from the single defining entity.",
                "Uses entity's local Z as Element Z (unless ReferencePlane is 'byPanel')."
              ]
            },
            "path2": {
              "name": "Multiple/No Entity Reference",
              "steps": [
                "Calculates a derived coordinate system (usually lowest Z or centroid).",
                "Defaults view direction if no specific orientation is found."
              ]
            }
          },
          {
            "condition": "User selects 'Draw Rectangle' or 'Draw Polygon' (Jig option)",
            "path1": {
              "name": "Manual Contour Definition",
              "steps": [
                "Enters Jig mode with Point3d array collection.",
                "Ignores automatic shadow calculation of selected beams.",
                "User clicks points to define shape dynamically."
              ]
            },
            "path2": {
              "name": "Automatic Contour Calculation",
              "steps": [
                "Calculates shadow profile of selected entities.",
                "Applies 'Bounding Shadow' or 'Purge Contour' logic based on property.",
                "Merges overlapping profiles."
              ]
            }
          },
          {
            "condition": "Zone Detection Logic",
            "path1": {
              "name": "Direct Assignment",
              "steps": [
                "Entity touches the base face of the current zone segment.",
                "Assigned immediately to that zone."
              ]
            },
            "path2": {
              "name": "Post-Collection Assignment",
              "steps": [
                "Entity does not touch base face but fits within Z-bounds.",
                "Assigned to zone after primary loop finishes."
              ]
            },
            "path3": {
              "name": "Zone 0/Unassigned",
              "steps": [
                "Entity falls outside calculated thickness or overlaps strangely.",
                "Assigned to Zone 0 (default/overflow)."
              ]
            }
          },
          {
            "condition": "Is 'bDebug' flag active?",
            "path1": {
              "name": "Production Mode",
              "steps": [
                "Creates ElementRoof in database.",
                "Assigns entities and plugins.",
                "Erases script instance."
              ]
            },
            "path2": {
              "name": "Debug Mode",
              "steps": [
                "Skips database creation.",
                "Draws visual text tags at entity centers showing Type and Zone index.",
                "Keeps script instance for inspection."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selection of loose entities",
            "errorMessage": "No entities selected or all entities already belong to an element.",
            "recovery": "User must select new or unassigned entities."
          },
          {
            "check": "Contour Area Validity",
            "errorMessage": "Calculated contour area is zero or invalid.",
            "recovery": "Script falls back to convex hull or largest ring; user may need to redraw contour or check input geometry."
          },
          {
            "check": "Element Number Uniqueness",
            "errorMessage": "Potential duplicate element name (handled by ElemNumber class logic).",
            "recovery": "Script automatically increments counter based on prefix."
          },
          {
            "check": "Plugin Script Availability",
            "errorMessage": "TSL script listed in properties not found in search path.",
            "recovery": "Script logs error (implied) and skips that specific plugin execution."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Geometry",
            "how": "Grip edit the ElementRoof entity",
            "effect": "Updates the contour and potentially re-triggers assignments if plugins are listening."
          },
          {
            "action": "Change Organizational Data",
            "how": "Properties Palette (OPM) - Element Number, Group",
            "effect": "Renames the element or moves it to a different Building/Folder (requires logic in ElementRoof, not this TSL post-insert)."
          },
          {
            "action": "Run Additional Scripts",
            "how": "Manual insertion of TSLs onto the ElementRoof",
            "effect": "Adds manufacturing details (e.g., hsbSheathing, hsbRouting)."
          },
          {
            "action": "Regenerate Zones",
            "how": "Right-click context menu (AddRecalcTrigger) or Property change",
            "effect": "Re-calculates entity assignments based on current geometry and zone settings."
          }
        ]
      },
      "tokens_used": 10134,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCreateElement.mcr\n\n## Overview\nThis script creates a structural production element (Roof or Floor) by assembling selected loose entities (beams, panels, sheets) into a single unit. It automatically calculates the element's 3D contour, defines zone thickness, and organizes the component under specific Building and Floor groups.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates exclusively in 3D Model Space to create ElementRoof entities. |\n| Paper Space | No | Not applicable for 3D element creation. |\n| Shop Drawing | No | This script is for modeling, not generating 2D views. |\n\n## Prerequisites\n- **Required Entities**: At least one loose GenBeam, Sheet, Panel, Collection, or Truss.\n- **Assignment Status**: Entities must not currently be assigned to another existing element (they must be \"loose\").\n- **Project Structure**: Building and Floor groups should be defined in the project browser to correctly organize the new element.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCreateElement.mcr`\n*Alternatively, run the script from your custom toolbar or ribbon.*\n\n### Step 2: Select Entities\n```\nCommand Line: Select entities (GenBeam, Sheet, Panel, Collection, Truss):\nAction: Click on the beams, panels, or sheets you want to include in the new element. Press Enter to confirm selection.\n```\n*Note: The script filters out entities that are already part of another element.*\n\n### Step 3: Define Element Geometry (Interactive Preview)\nA preview of the element appears. You can now adjust the orientation and contour using keyboard options:\n```\nCommand Line: [Rectangle/Polygon/Rotate/Swap] <Enter to confirm>:\nAction:\n- Rotate: Press 'R' to rotate the element orientation.\n- Swap: Press 'S' to flip the direction.\n- Rectangle: Press 'Rec' to manually draw a rectangular contour.\n- Polygon: Press 'Pol' to manually draw a polygon contour.\n```\n*Move your mouse to position the element origin. Press **Enter** or **Space** when satisfied.*\n\n### Step 4: Finalize Creation\nThe script generates the element number, calculates zones, assigns the selected beams to the new element, and executes any specified plugin scripts.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **House Group** | String | Undefined | The specific building or project phase (e.g., \"MainHouse\") for the element. |\n| **Floor Group** | String | Undefined | The level or story (e.g., \"GroundFloor\", \"Roof\") where the element resides. |\n| **Element Number** | String | (Auto) | The unique name or ID for the element. Supports format variables. |\n| **Contour Mode** | Enum | Default | Method for calculating the outer boundary. Options: Default, Bounding Shadow, Purge Contour, Draw Rectangle. |\n| **Reference Plane** | Enum | Default | Defines vertical alignment relative to selected entities (e.g., by Panel, Default lowest Z). |\n| **Element Thickness** | Double | 0 mm | The structural depth (dZ) of the element used for zone calculations. |\n| **Exclusive Assignment** | Boolean | Yes | If \"Yes\", selected beams belong only to this element. If \"No\", they can be shared (e.g., with walls). |\n| **Plugin Scripts** | String | Empty | List of additional TSL scripts to run automatically after creation (e.g., sheathing tools). |\n\n## Right-Click Menu Options\n*Note: These options appear as command line keywords during the insertion Jig phase.*\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Rectangle** | Switches to manual mode to define the element contour by drawing a rectangle. |\n| **Polygon** | Switches to manual mode to define the element contour by drawing a custom polygon. |\n| **Rotate** | Rotates the element coordinate system 90 degrees. |\n| **Swap** | Flips the local Y-axis direction of the element. |\n\n## Settings Files\nNo specific external settings files (XML) are required for this script. It relies on the current hsbCAD Project defaults and Group structure.\n\n## Tips\n- **Manual Contours**: If the automatic shadow calculation picks up unwanted geometry (like overhangs you want to exclude), set the **Contour Mode** to \"Draw Rectangle\" or \"Polygon\" to manually define exactly where the element starts and ends.\n- **Loose Entities Only**: If the script seems to \"ignore\" beams you selected, check if they are already part of another element. Use the \"Remove from Element\" function first if you want to move them.\n- **Automation**: Use the **Plugin Scripts** property to automatically run post-processing tasks. For example, add a sheathing script to this list so sheathing is generated immediately after the roof element is created.\n\n## FAQ\n- **Q: Why did my element create with a thickness of 0?**\n  A: The script defaults to 0 if no thickness is detected or set. Ensure you enter a valid value in the **Element Thickness** property (in the Properties Palette) before or immediately after running the script.\n- **Q: Can I include beams from different floors?**\n  A: While the script allows selecting entities from various locations, they are grouped under a single **Floor Group** assignment. It is best practice to create elements per floor for organizational clarity.\n- **Q: What happens if I select a Truss?**\n  A: The script accepts Trusses. It will calculate the bounding geometry and include the truss within the element zones, provided the truss is not already assigned to another element."
      },
      "tokens_used": 6918,
      "error": null
    }
  }
}