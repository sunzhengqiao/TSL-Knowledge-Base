{
  "filename": "hsbCLT-CornerCleanUp.mcr",
  "status": "completed",
  "total_tokens": 52592,
  "processing_time": 345.709272146225,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 0,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.6",
            "date": "27/06/2024",
            "author": "Marsel Nakuci",
            "changes": "Add distance to line check at cleanup function"
          },
          {
            "version": "1.5",
            "date": "07/06/2024",
            "author": "Marsel Nakuci",
            "changes": "Update cornerCleanUp function"
          },
          {
            "version": "1.4",
            "date": "24/05/2024",
            "author": "Marsel Nakuci",
            "changes": "When analysing plEnvelope, cleanup pline, remove possible points along a line"
          },
          {
            "version": "1.3",
            "date": "02.06.2022",
            "author": "Marsel Nakuci",
            "changes": "distinguish sides for \"custom drill\" like hsbPanelDrill. Add double click command flip side"
          },
          {
            "version": "1.2",
            "date": "25.05.2022",
            "author": "Marsel Nakuci",
            "changes": "support side PLine of the realbody with tooling for the mode \"Custom Single drill\""
          },
          {
            "version": "1.1",
            "date": "13.05.2022",
            "author": "Marsel Nakuci",
            "changes": "Add \"Custom single drill\" at insertion modes"
          },
          {
            "version": "1.0",
            "date": "04jul14",
            "author": "th@hsbCAD.de",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9278,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicitly targets _kModelSpace in dbCreate(). Uses Sip/GenBeam methods (plEnvelope, addTool) to generate 3D Drill geometry. No ShopDrawing sd_ functions, Viewport handling, or Paper Space constants found."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7454,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && insertCycleCount()==1 && _kExecuteKey.length()==0",
              "required": false
            },
            {
              "step": 2,
              "function": "getSip",
              "promptOriginal": "|Select panel|",
              "condition": "nInsertMode != 0 && nInsertMode != 2 && nInsertMode != 4",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity",
              "promptOriginal": "|Select CLT panels|",
              "condition": "nInsertMode == 0 || nInsertMode == 2 || nInsertMode == 4",
              "required": true
            },
            {
              "step": 4,
              "function": "getPoint",
              "promptOriginal": "|Pick point inside opening|",
              "condition": "nInsertMode == 1",
              "required": true
            },
            {
              "step": 5,
              "function": "getPoint",
              "promptOriginal": "|Pick point|",
              "condition": "nInsertMode == 3 || nInsertMode == 5",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Insertion (if no ExecuteKey provided)",
            "title": null,
            "dataSource": "Script Properties (sInsertMode, sSide, dDiameter, dDepth)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dDiameter",
            "type": "PropDouble",
            "displayName": "|Diameter|",
            "defaultValue": "U(40)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "|Sets the diameter of the drill|"
          },
          {
            "index": 0,
            "variable": "sInsertMode",
            "type": "PropString",
            "displayName": "|Insert Mode|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|All Openings|",
              "|Opening|",
              "|Outer Contour|",
              "|Single drill|",
              "|All|",
              "|Custom Single drill|"
            ],
            "category": null,
            "description": "|Sets the insertion mode. Certain modes support multiple panel selection or require the input of a location.|"
          },
          {
            "index": 1,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "|Side|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|Reference|",
              "|Opposite|"
            ],
            "category": null,
            "description": "|Defines the Side of the drill|"
          },
          {
            "index": 1,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "|Depth|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "|Defines the Depth of the drill|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "TslDoubleClick",
            "handler": "TslDoubleClick",
            "action": "Flip Side",
            "alsoTriggeredBy": "Double-click"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8360,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically creates corner relief (dogbone) drills at concave corners of CLT panels to accommodate CNC router bit radius.",
          "category": "Machining/Tooling",
          "typicalUseCase": "Used during manufacturing preparation to ensure internal corners of CLT panels are machined correctly, allowing the circular saw/router bit to pass without over-cutting the material."
        },
        "parameters": [
          {
            "name": "dDiameter",
            "technicalDefault": "U(40)",
            "businessMeaning": "The diameter of the drill hole to be cut at the corner. This should match or exceed the diameter of the cutting tool used to machine the contour to prevent tool collision.",
            "validRange": "10mm to 60mm (Typically matches tooling diameter, e.g., 12mm, 16mm, 25mm, 40mm)",
            "unit": "mm",
            "affectsOutput": "Determines the size of the circular drill geometry and the offset distance of the drill center from the actual corner point."
          },
          {
            "name": "sInsertMode",
            "technicalDefault": "null",
            "businessMeaning": "Defines the scope of where the corner cleanup is applied. It allows the user to target specific openings, the outer contour, or pick specific corners manually.",
            "validRange": "List: [All Openings, Opening, Outer Contour, Single drill, All, Custom Single drill]",
            "unit": "Enumeration",
            "affectsOutput": "Controls the logic used to detect corners (e.g., scanning all openings vs. scanning a single user-selected opening). Dictates whether user point input is required during insertion."
          },
          {
            "name": "sSide",
            "technicalDefault": "null",
            "businessMeaning": "Specifies which face of the panel the drilling operation originates from. Essential for blind holes or when tooling accessibility differs from top to bottom.",
            "validRange": "List: [Reference, Opposite]",
            "unit": "Enumeration",
            "affectsOutput": "Reverses the direction of the drill vector (Z-axis). In 'Custom Single drill' mode, it determines which side's geometry is analyzed for the corner location."
          },
          {
            "name": "dDepth",
            "technicalDefault": "U(0)",
            "businessMeaning": "The depth of penetration for the drill operation. In standard modes, this defaults to the full panel thickness. In 'Custom Single drill' mode, it allows for blind holes (partial depth).",
            "validRange": "0mm (Through) to Panel Thickness",
            "unit": "mm",
            "affectsOutput": "Sets the Z-length of the Drill entity. If 0 in standard modes, code often defaults to through-cut logic. In Custom mode, it physically limits the drill length."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sInsertMode is set to 'Custom Single drill' (Value 5)",
            "effect": "Enables the logic for the 'Side' parameter and uses the explicit 'Depth' value instead of the full panel thickness. Requires the user to pick a point near the specific corner.",
            "cascade": [
              "sSide",
              "dDepth"
            ]
          },
          {
            "trigger": "sInsertMode is set to 'Opening' or 'Single drill'",
            "effect": "Requires the user to select or pick a point inside a specific geometry to define the scope.",
            "cascade": [
              "_Pt0 (User Input)"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Drill",
            "description": "Cylindrical drill holes positioned at concave corners (internal angles < 180 degrees). The center is calculated by offsetting from the corner vertex along the angle bisector by half the diameter.",
            "appliedTo": "The selected GenBeam (CLT Panel)"
          }
        ]
      },
      "tokens_used": 9950,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Start: Initialize properties (Diameter, Insert Mode, Side, Depth).",
          "2. Insert Check: Verify if _bOnInsert is true.",
          "3. Cycle Check: If insertCycleCount() > 1, erase duplicate instance and exit.",
          "4. Dialog/Input Phase: Check for _kExecuteKey. If present, load catalog values. If not, ShowDynamicDialog.",
          "5. Determine Insert Mode: Parse 'sInsertMode' to get integer index (0-5).",
          "6. Entity Selection (Branch on Insert Mode):",
          "   - If Mode 0 (All Openings), 2 (Outer Contour), or 4 (All): Prompt for multiple CLT panel selection (PrEntity).",
          "   - If Mode 1, 3, or 5: Prompt for single panel selection (getSip).",
          "7. Point Selection (Branch on Insert Mode):",
          "   - If Mode 1 (Opening): Prompt for point inside opening.",
          "   - If Mode 3 (Single drill) or 5 (Custom Single drill): Prompt for general point near corner.",
          "8. Instance Creation Loop: Iterate through selected panels.",
          "   - Determine origin point (User point for modes 1,3,5; Panel centroid for others).",
          "   - Create script instance on panel (dbCreate).",
          "9. Calculation Phase (Run on each new instance):",
          "   - Verify link to Sip (GenBeam). If invalid, erase and exit.",
          "   - Get Envelope PLine and Opening PLines.",
          "   - Execute cleanUpPline() to remove collinear vertices.",
          "   - Transform picked point to local coordinates if necessary.",
          "10. Geometry Analysis (Branch on Insert Mode):",
          "    - Modes 0, 1, 2, 4: Loop through specific plines (Envelope or Openings). Calculate bisectors at concave corners to find drill locations.",
          "    - Modes 3, 5: Find closest vertex to the picked point. Validate concavity using PointInProfile check.",
          "      (Mode 5 specific: Extract side profile including existing tools like BeamCuts/Cuts).",
          "11. Tooling Generation: Create Drill entities at calculated locations.",
          "    - Mode 5 (Custom): Use explicit 'dDepth' and reverse vector if 'Side' is Opposite.",
          "    - Other Modes: Drill through full thickness (dZ).",
          "12. Validation/Completion:",
          "    - If no valid drill locations found: Report message and erase instance.",
          "    - If locations found: Draw visualization and save."
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Mode Selection (Modes 0, 2, 4 vs Modes 1, 3, 5)",
            "path1": {
              "name": "Batch Panel Processing",
              "steps": [
                "Prompt user to select Multiple Entities (PrEntity)",
                "Skip point input (uses panel centroid)",
                "Instance loop processes each panel in the set"
              ]
            },
            "path2": {
              "name": "Single Panel Processing",
              "steps": [
                "Prompt user to select Single Entity (getSip)",
                "Prompt for Point input (_Pt0)",
                "Instance loop runs once for the single panel"
              ]
            }
          },
          {
            "condition": "Custom Single Drill (Mode 5) vs Standard Modes (0-4)",
            "path1": {
              "name": "Standard Geometry Analysis",
              "steps": [
                "Analyzes plEnvelope and plOpenings only",
                "Drill depth defaults to Panel Thickness (dZ)",
                "Drill direction is standard Z-axis"
              ]
            },
            "path2": {
              "name": "Custom Tooling Analysis",
              "steps": [
                "Extracts complex side profile using bdSipTools (includes BeamCuts, Cuts, Mortises)",
                "Uses explicit 'dDepth' property for drill length",
                "Respects 'sSide' property (Reference vs Opposite) for vector direction"
              ]
            }
          },
          {
            "condition": "Corner Concavity Check",
            "path1": {
              "name": "Concave Corner (<180 deg)",
              "steps": [
                "PointInProfile check returns Inside (for envelope) or Outside (for opening)",
                "Drill location added to array"
              ]
            },
            "path2": {
              "name": "Convex Corner or Invalid",
              "steps": [
                "PointInProfile check fails",
                "Drill location skipped"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Sip Link (_Sip)",
            "errorMessage": "Implicit (Script erases itself silently or console log)",
            "recovery": "Re-link the script to a valid GenBeam panel."
          },
          {
            "check": "Valid Drill Locations Found",
            "errorMessage": "could not find any cleanup locations in panel [PosNum]. Tool will be deleted.",
            "recovery": "Check that the panel has concave corners (internal angles < 180). For 'Single drill' modes, ensure the picked point is near a valid concave corner."
          },
          {
            "check": "Single Mode Point Selection",
            "errorMessage": "Implicit (Script erases itself if bOk remains false in single mode logic)",
            "recovery": "Ensure the picked point (_Pt0) is close enough to a vertex on the envelope or an opening."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Flip Side",
            "how": "Double-click or Context Menu 'TslDoubleClick'",
            "effect": "In 'Custom Single drill' mode, toggles the 'sSide' property between Reference and Opposite. This reverses the drill direction vector and moves the drill start point to the opposite face of the panel."
          },
          {
            "action": "Modify Parameters",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Changing Diameter, Depth, or Side triggers a recalculation (update) of the drill geometry on the associated panel."
          }
        ]
      },
      "tokens_used": 10661,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-CornerCleanUp.mcr\n\n## Overview\nAutomatically creates corner relief (dogbone) drills at concave corners of CLT panels. This ensures CNC router bits can cut internal corners without over-cutting the material.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be run in the 3D model. |\n| Paper Space | No | Not applicable for layouts. |\n| Shop Drawing | No | Tooling is applied in the model environment. |\n\n## Prerequisites\n- **Required Entities**: `GenBeam` (CLT Panels).\n- **Minimum Beam Count**: 1.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nRun the command `TSLINSERT` and select `hsbCLT-CornerCleanUp.mcr`.\n\n### Step 2: Configure Properties\nA dynamic dialog will appear upon insertion.\n- **Insert Mode**: Select how you want to apply the cleanup (e.g., all openings, outer contour, or a single custom drill).\n- **Diameter**: Set the drill diameter (typically matching your tool diameter).\n- **Side**: Select \"Reference\" or \"Opposite\" (Mainly for \"Custom Single drill\" mode).\n- **Depth**: Set the drill depth (0 defaults to through-cut).\n\nClick **OK** to confirm.\n\n### Step 3: Select Panels\nDepending on the **Insert Mode** chosen in Step 2, the selection prompt varies:\n\n- **If \"All Openings\", \"Outer Contour\", or \"All\" is selected**:\n  ```\n  Command Line: Select CLT panels\n  Action: Select one or multiple CLT panels in the model and press Enter.\n  ```\n\n- **If \"Opening\", \"Single drill\", or \"Custom Single drill\" is selected**:\n  ```\n  Command Line: Select panel\n  Action: Click on a single CLT panel to process.\n  ```\n\n### Step 4: Pick Location (If Required)\nIf you selected a single-panel mode, you must specify the location:\n\n- **If \"Opening\" mode**:\n  ```\n  Command Line: Pick point inside opening\n  Action: Click inside the specific opening you wish to clean up.\n  ```\n\n- **If \"Single drill\" or \"Custom Single drill\" mode**:\n  ```\n  Command Line: Pick point\n  Action: Click near the specific corner vertex where you want the dogbone drill.\n  ```\n\nThe script will automatically calculate the corner position and add the drill geometry.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Insert Mode | dropdown | - | Sets the scope of the operation: **All Openings** (all openings in selected panels), **Opening** (specific opening in one panel), **Outer Contour** (panel edges), **Single drill** (pick specific corner), **All** (entire panel), or **Custom Single drill** (advanced single drill with depth control). |\n| Diameter | Number | 40 mm | The diameter of the relief drill. This should match or exceed your CNC tool diameter. |\n| Side | dropdown | - | Defines which face the drill originates from. Options are **Reference** or **Opposite**. Used primarily in \"Custom Single drill\" mode to determine direction. |\n| Depth | Number | 0 mm | The depth of the drill. A value of 0 (default) creates a through-hole. In \"Custom Single drill\" mode, this defines a blind hole depth. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side | Switches the drill direction between the Reference side and the Opposite side. This is particularly useful for \"Custom Single drill\" instances. |\n\n## Settings Files\n- No external settings files are required for this script.\n\n## Tips\n- **Default Diameter**: Ensure the diameter is set correctly for your machinery (e.g., 12mm, 16mm, 25mm, or 40mm) before running the script on multiple panels.\n- **Custom Single Drill**: Use the \"Custom Single drill\" mode if you have complex intersections or existing cuts; this mode analyzes the resulting profile including other tooling.\n- **Visualization**: The script draws a preview of the drill. If the script erases itself immediately, it usually means no valid concave corners were found at the picked location.\n\n## FAQ\n- **Q: The script deleted itself after I picked a point. Why?**\n  **A**: This usually happens if the point you picked was not near a valid concave (internal) corner, or if the corner angle does not require cleanup. Try picking closer to the vertex.\n  \n- **Q: What is the difference between \"Single drill\" and \"Custom Single drill\"?**\n  **A**: \"Single drill\" calculates based on the raw panel geometry. \"Custom Single drill\" calculates based on the panel geometry *plus* any existing cuts or tooling, and allows you to set a specific depth and side.\n\n- **Q: How do I change the drill size after insertion?**\n  **A**: Select the script instance in the model, open the **Properties** palette (Ctrl+1), and modify the **Diameter** value. The script will update automatically."
      },
      "tokens_used": 6889,
      "error": null
    }
  }
}