{
  "filename": "FLR_BlockingLine.mcr",
  "status": "completed",
  "total_tokens": 55210,
  "processing_time": 569.835423707962,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8257,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly collects entities using `_kModelSpace` (e.g., `g.collectEntities(TRUE, Beam(), _kModelSpace)`), creates 3D `Beam` objects via `dbCreate`, and operates on `ElementRoof` and `TrussEntity` objects. No ShopDrawing or PaperSpace specific keywords found."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementRoof",
            "Beam or TrussEntity"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7835,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "\\nSelect start point",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrPoint",
              "promptOriginal": "\\nSelect next point",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getElementRoof",
              "promptOriginal": "\\nSelect a reference Element",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 1,
            "variable": "stBeam",
            "type": "PropString",
            "displayName": "Beam type",
            "defaultValue": "First available profile",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "stLoose",
            "type": "PropString",
            "displayName": "All Material Loose",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "stAddEnds",
            "type": "PropString",
            "displayName": "Do Ends",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dMinLength",
            "type": "PropDouble",
            "displayName": "Minimum Length",
            "defaultValue": "6 inch",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "stStagger",
            "type": "PropString",
            "displayName": "Staggered",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "stJoistFind",
            "type": "PropString",
            "displayName": "Joist to use",
            "defaultValue": "All Floor Joists",
            "inputType": "dropdown",
            "options": [
              "All Floor Joists",
              "Only Element Joists"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "stKeepSquare",
            "type": "PropString",
            "displayName": "Keep Cuts Square",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "stDim",
            "type": "PropString",
            "displayName": "DimStyle",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 8,
            "variable": "stVerticalJustification",
            "type": "PropString",
            "displayName": "Vertical Justification",
            "defaultValue": "Center",
            "inputType": "dropdown",
            "options": [
              "Top",
              "Center",
              "Bottom"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 9,
            "variable": "stLateralJustification",
            "type": "PropString",
            "displayName": "Lateral Justification",
            "defaultValue": "Center",
            "inputType": "dropdown",
            "options": [
              "Left",
              "Center",
              "Right"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dBlockingGap",
            "type": "PropDouble",
            "displayName": "Blocking Gap",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Generate Pieces",
            "handler": "stReCreateBeams",
            "action": "Regenerates the blocking beams based on current properties",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9442,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates blocking or solid bridging between floor joists along a user-defined path, automatically calculating intersections and fitting to roof/floor slopes.",
          "category": "Framing",
          "typicalUseCase": "Used to add blocking lines for load distribution, stiffening, or backing for finish materials in a floor system."
        },
        "parameters": [
          {
            "name": "stBeam",
            "technicalDefault": "First available profile",
            "businessMeaning": "The cross-sectional profile (e.g., 2x4, 2x6, I-Joist rim) of the blocking material to be generated.",
            "validRange": "Any profile available in the hsbCAD catalog",
            "unit": "String (Profile Name)",
            "affectsOutput": "Determines the width, height, and name of the solid timber beams created."
          },
          {
            "name": "stLoose",
            "technicalDefault": "No",
            "businessMeaning": "Determines if the generated blocking pieces are tagged as 'Loose' material (often dropped from the main structural element for shipping lists).",
            "validRange": "Yes, No",
            "unit": "String",
            "affectsOutput": "Sets the 'Information' property of the beam to 'Loose', impacting material reports and production filtering."
          },
          {
            "name": "stAddEnds",
            "technicalDefault": "Yes",
            "businessMeaning": "Controls whether blocking pieces are created at the extreme start and end points of the drawn line.",
            "validRange": "Yes, No",
            "unit": "String",
            "affectsOutput": "If 'No', the script skips the first and last intersection bay, which is often required if the line extends slightly beyond the joist bay."
          },
          {
            "name": "dMinLength",
            "technicalDefault": "6 inch",
            "businessMeaning": "The shortest allowable length for a piece of blocking to be physically created.",
            "validRange": "0 - 24 inches",
            "unit": "Length (inch)",
            "affectsOutput": "Blocking segments calculated to be shorter than this value are suppressed and not generated."
          },
          {
            "name": "stStagger",
            "technicalDefault": "No",
            "businessMeaning": "Alternates the vertical position of adjacent blocking pieces.",
            "validRange": "Yes, No",
            "unit": "String",
            "affectsOutput": "If 'Yes', every other block is offset vertically to allow nailing access or ventilation through the bay."
          },
          {
            "name": "stJoistFind",
            "technicalDefault": "All Floor Joists",
            "businessMeaning": "Specifies the scope of beams to intersect with. 'All Floor Joists' includes any beam in the model/group; 'Only Element Joists' restricts it to the specific selected element.",
            "validRange": "All Floor Joists, Only Element Joists",
            "unit": "String",
            "affectsOutput": "Filters which beams in the model are recognized as valid targets for the blocking to intersect."
          },
          {
            "name": "stKeepSquare",
            "technicalDefault": "Yes",
            "businessMeaning": "Controls the end cut geometry of the blocking.",
            "validRange": "Yes, No",
            "unit": "String",
            "affectsOutput": "If 'Yes', ends are cut square (90 deg). If 'No', blocking is stretched and cut to match the slope of adjacent roof/floor members (e.g., sloped top chords)."
          },
          {
            "name": "stDim",
            "technicalDefault": "null",
            "businessMeaning": "The Dimension Style used for the text label indicating the blocking run.",
            "validRange": "Available DimStyles in the drawing",
            "unit": "String",
            "affectsOutput": "Controls the visual appearance of the 'BLK RUN' annotation text."
          },
          {
            "name": "stVerticalJustification",
            "technicalDefault": "Center",
            "businessMeaning": "Aligns the blocking vertically relative to the joist depth.",
            "validRange": "Top, Center, Bottom",
            "unit": "String",
            "affectsOutput": "Offsets the blocking beam to align with the top, center, or bottom of the intersected joists."
          },
          {
            "name": "stLateralJustification",
            "technicalDefault": "Center",
            "businessMeaning": "Aligns the blocking laterally relative to the insertion path.",
            "validRange": "Left, Center, Right",
            "unit": "String",
            "affectsOutput": "Offsets the blocking laterally along the Y-axis of the generated beam."
          },
          {
            "name": "dBlockingGap",
            "technicalDefault": "0",
            "businessMeaning": "Creates a clearance gap between the blocking ends and the intersecting joists.",
            "validRange": "0 - 1 inch",
            "unit": "Length (inch)",
            "affectsOutput": "Shortens the blocking length or adds a cut offset so the timber does not physically touch the adjacent joist."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "stKeepSquare == 'No'",
            "effect": "The script attempts to detect the slope of intersecting beams and rotates the blocking to match.",
            "cascade": [
              "stJoistFind"
            ]
          },
          {
            "trigger": "stStagger == 'Yes'",
            "effect": "The vertical offset (iSideFlag) alternates between -1 and 1 for each sequential block.",
            "cascade": [
              "stVerticalJustification"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Timber blocking pieces created at each intersection of the user-defined line and the target joists.",
            "appliedTo": "Generated and added to the construction model (Model Space)."
          },
          {
            "type": "Text",
            "description": "Annotation label displaying the blocking profile (e.g., 'BLK RUN (2x4)').",
            "appliedTo": "Model Space."
          }
        ]
      },
      "tokens_used": 10097,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script initialization: Load available Timber profiles from catalog or hardcoded list.",
          "2. Display Properties Dialog (showDialog) to configure blocking parameters.",
          "3. Prompt user for Start Point (getPoint).",
          "4. Prompt user for Next Point (PrPoint) to define the blocking line.",
          "5. Prompt user to select a Reference Element (getElementRoof).",
          "6. Validate Reference Element: If invalid, report error and erase instance.",
          "7. Project user points onto the plane defined by the Reference Element's elevation.",
          "8. Calculate local coordinate system (vBmX, vBmY, vBmZ) based on points and element orientation.",
          "9. Apply Vertical and Lateral Justification offsets to the insertion line.",
          "10. Collect Target Beams: Based on 'Joist to use' property, gather Beams/Trusses from the Model Space or specific Element Group.",
          "11. Intersection Analysis: Intersect the generated line body with target beams to determine blocking locations.",
          "12. Loop through intersections:",
          "   a. Filter out segments shorter than 'Minimum Length'.",
          "   b. Filter out start/end segments if 'Do Ends' is No.",
          "   c. Create Beam entity at calculated center.",
          "   d. Apply Vertical Staggering if enabled.",
          "   e. Detect Slope: Analyze surrounding geometry to determine if blocking must be rotated.",
          "   f. Apply 'Keep Cuts Square' logic: Stretch to adjacent members or cut square.",
          "   g. Apply 'Blocking Gap': Shorten beam length using cut tools if gap > 0.",
          "   h. Assign to Element or Group based on spatial containment.",
          "   i. Set 'Loose' status if enabled.",
          "13. Draw visual representation of line and label text.",
          "14. Store generated beams in Map for future cleanup."
        ],
        "conditionalBranches": [
          {
            "condition": "Profile List Initialization",
            "path1": {
              "name": "Use Filtered List",
              "steps": [
                "Check if arProfilesUsed array has entries.",
                "If yes, load only those specific profiles from the catalog."
              ]
            },
            "path2": {
              "name": "Use All Catalog Profiles",
              "steps": [
                "Check if arProfilesUsed is empty.",
                "If yes, iterate all ExtrProfile entries in the database.",
                "Exclude 'RECTANGULAR' and 'ROUND' generic types."
              ]
            }
          },
          {
            "condition": "stJoistFind (Joist Selection Scope)",
            "path1": {
              "name": "All Floor Joists",
              "steps": [
                "Collect entities from the main group derived from the element.",
                "Include all Beams and TrussEntities found in Model Space."
              ]
            },
            "path2": {
              "name": "Only Element Joists",
              "steps": [
                "Restrict search to the specific ElementGroup of the selected Reference Element.",
                "Only intersect with beams belonging to that specific element."
              ]
            }
          },
          {
            "condition": "stAddEnds (End Segment Generation)",
            "path1": {
              "name": "Yes (Default)",
              "steps": [
                "Include the first and last intersection bays.",
                "Create blocking pieces up to the extreme points of the line."
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Increment Start Index and decrement Stop Index.",
                "Skip the creation of the very first and very last blocking pieces."
              ]
            }
          },
          {
            "condition": "stKeepSquare (End Cut Geometry)",
            "path1": {
              "name": "Yes (Square Cuts)",
              "steps": [
                "Keep generated beam length as calculated from intersection body.",
                "Do not perform 'stretchStaticTo' operations."
              ]
            },
            "path2": {
              "name": "No (Match Slope/Plane)",
              "steps": [
                "Find the closest intersecting beams on both ends of the blocking.",
                "Call bm.stretchStaticTo() to fit the blocking tight against the adjacent member geometry.",
                "Handle dBlockingGap separately if needed."
              ]
            }
          },
          {
            "condition": "Slope Detection (Geometric Analysis)",
            "path1": {
              "name": "Slope Detected",
              "steps": [
                "Analyze Truss top chords or Beam body decomposition.",
                "Calculate height difference (Zdiff) between chord intersections.",
                "If Zdiff is significant, calculate rotation vectors (ax, ay, az).",
                "Rotate the blocking beam to match the roof plane.",
                "Translate beam vertically to align with the calculated slope intersection."
              ]
            },
            "path2": {
              "name": "Flat / No Slope",
              "steps": [
                "Use default coordinate system based on the insertion line and World Z.",
                "Create blocking with horizontal orientation."
              ]
            }
          },
          {
            "condition": "dBlockingGap (Clearance)",
            "path1": {
              "name": "Gap > 0",
              "steps": [
                "Retrieve static cuts generated by stretching.",
                "Transform cuts inward by the gap distance along the cut normal.",
                "Re-apply modified cuts to the beam."
              ]
            },
            "path2": {
              "name": "Gap = 0",
              "steps": [
                "Skip cut modification.",
                "Leave cuts as generated (either square or stretched)."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Reference Element Validity",
            "errorMessage": "No valid element for TSL 'FLR_BlockingLine.mcr'",
            "recovery": "Script self-erases. User must select a valid ElementRoof during insertion."
          },
          {
            "check": "Point Count",
            "errorMessage": "Implicit (Script Erases)",
            "recovery": "Script checks if _PtG.length != 2. If points are missing during recalc, it erases the instance."
          },
          {
            "check": "Selected Beam Profile Existence",
            "errorMessage": "None (Handled automatically)",
            "recovery": "If the currently selected profile name (stBeam) is not found in the updated profile list (e.g., catalog changed), the script resets the property to the first available profile in the list."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Blocking Line",
            "how": "Grip Edit (Dragging _Pt0)",
            "effect": "Triggers recalculation. Updates the start/end points (_PtG), re-projects them to the element plane, regenerates intersections, and moves all generated blocking pieces to the new location."
          },
          {
            "action": "Change Properties",
            "how": "Object Properties Palette (OPM)",
            "effect": "Changing properties like 'Beam type', 'Do Ends', 'Staggered', or 'Minimum Length' triggers the generation loop, deleting old beams and creating new ones with updated parameters."
          },
          {
            "action": "Regenerate Pieces",
            "how": "Right-click Context Menu",
            "effect": "Explicitly triggers the beam generation logic (_kExecuteKey == stReCreateBeams), useful if the underlying joists have moved but the script itself hasn't been moved."
          },
          {
            "action": "Change Justification",
            "how": "OPM (Vertical/Lateral Justification)",
            "effect": "Updates offset variables (iZOff, iYOff). Re-projects the master line and re-positions the generated blocking vertically or laterally relative to the joists."
          }
        ]
      },
      "tokens_used": 12096,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# FLR_BlockingLine.mcr\n\n## Overview\nGenerates blocking or solid bridging between floor joists along a user-defined path. It automatically calculates intersections, fits to roof/floor slopes, and provides options for staggering, justification, and material tagging.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model environment. |\n| Paper Space | No | Not applicable for layout views. |\n| Shop Drawing | No | Not applicable for manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities**:\n  - An existing ElementRoof or ElementFloor (Reference Element).\n  - Floor Joists (Beams or TrussEntities) in the model space.\n- **Minimum Beam Count**: 0 (Script creates new beams, does not require existing selection).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `FLR_BlockingLine.mcr`\n\n### Step 2: Define Start Point\n```\nCommand Line: \\nSelect start point\nAction: Click in the model to set the beginning of the blocking line.\n```\n\n### Step 3: Define End Point\n```\nCommand Line: \\nSelect next point\nAction: Click to set the end point of the blocking line.\n```\n\n### Step 4: Select Reference Element\n```\nCommand Line: \\nSelect a reference Element\nAction: Click on the floor or roof element that this blocking belongs to. This defines the working plane and elevation.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Beam type | Dropdown | First available profile | Select the timber profile (e.g., 2x4) to use for the blocking pieces. |\n| All Material Loose | Dropdown | No | If \"Yes\", marks all generated blocking as \"Loose\" material for production lists. |\n| Do Ends | Dropdown | Yes | If \"No\", skips creating blocking pieces at the very start and end of the line (useful if the line extends past the joists). |\n| Minimum Length | Number | 6 inch | Blocking pieces shorter than this value will not be generated. |\n| Staggered | Dropdown | No | If \"Yes\", alternates the vertical position of adjacent blocks for nailing or ventilation. |\n| Joist to use | Dropdown | All Floor Joists | Sets whether to intersect with all joists in the model or only those belonging to the selected Element. |\n| Keep Cuts Square | Dropdown | Yes | If \"No\", the ends of the blocking will be cut to match the slope of adjacent members (e.g., for vaulted ceilings). |\n| DimStyle | Dropdown | [None] | Selects the dimension style for the annotation text label. |\n| Vertical Justification | Dropdown | Center | Aligns the blocking vertically relative to the joist: Top, Center, or Bottom. |\n| Lateral Justification | Dropdown | Center | Aligns the blocking laterally along the insertion line: Left, Center, or Right. |\n| Blocking Gap | Number | 0 | Adds a clearance gap between the ends of the blocking and the intersecting joists. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Generate Pieces | Regenerates the blocking beams based on current properties and geometry. Use this if joists have moved or properties were changed. |\n\n## Settings Files\nNo specific external settings files are required for this script. It relies on the hsbCAD catalog for profiles.\n\n## Tips\n- **Moving the Line**: Select the script instance in the model and drag the blue grip points to move the start or end of the blocking line. The blocking will update automatically.\n- **Sloped Roofs**: If installing blocking on a sloped roof or ceiling, set **Keep Cuts Square** to \"No\" to ensure the blocking sits tight against the sloped chords.\n- **Nailing Access**: Turn **Staggered** to \"Yes\" to offset blocks, which often provides better access for nailing or allows ventilation between bays.\n- **Overshoot Correction**: If your line extends slightly beyond the outer joists and creates tiny unwanted offcuts, set **Do Ends** to \"No\".\n\n## FAQ\n- **Q: Why are some blocking pieces missing in the middle of the bay?**\n  - **A**: Check the **Minimum Length** property. If the gap between joists is smaller than this value (e.g., tight spacing), the script will suppress that piece.\n- **Q: How do I update the blocking if I move my floor joists?**\n  - **A**: Select the blocking line script instance, right-click, and choose **Generate Pieces**. This will recalculate intersections based on the new joist positions.\n- **Q: The blocking is floating above/below the joists.**\n  - **A**: Check the **Vertical Justification** property. Ensure it is set to \"Top\" or \"Center\" depending on where you want the blocking to sit relative to the joist height."
      },
      "tokens_used": 7483,
      "error": null
    }
  }
}