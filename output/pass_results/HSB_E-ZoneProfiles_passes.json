{
  "filename": "HSB_E-ZoneProfiles.mcr",
  "status": "completed",
  "total_tokens": 28880,
  "processing_time": 440.06622862815857,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": 1,\n    \"minorVersion\": 0,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"This tsl shows the zone profiles of the selected element."
      },
      "tokens_used": 6043,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly creates instances in _kModelSpace via dbCreate(). It modifies the Element's geometry using el.setProfNetto(), which is a 3D modeling database operation. No sd_ prefixes, Viewport logic, or ShopDrawing specific entities found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model",
          "requiredSettings": []
        }
      },
      "tokens_used": 3681,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select one or more elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "_bOnInsert && (no execute key or key invalid)",
            "title": null,
            "dataSource": "Native TSL Property Dialog",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "Zone",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Read-only separator"
          },
          {
            "index": 0,
            "variable": "nHsbZoneIndex",
            "type": "PropInt",
            "displayName": "     |Zone index|",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7",
              "8",
              "9",
              "10"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sGripType",
            "type": "PropString",
            "displayName": "     |Active grippoints|",
            "defaultValue": "|Edge|",
            "inputType": "dropdown",
            "options": [
              "|Edge|",
              "|Corner|"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 3585,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Allows the user to visualize and interactively modify the contour profiles of specific material zones within an Element using on-screen grips.",
          "category": "Modeling/Geometry",
          "typicalUseCase": "When a user needs to manually adjust the raw or processed shape of a wall, floor, or roof element's sub-zones (e.g., creating a notch or modifying a complex shape) without using standard joinery tools."
        },
        "parameters": [
          {
            "name": "sSeperator01",
            "technicalDefault": "",
            "businessMeaning": "A visual grouping label in the properties palette, categorizing the subsequent settings as related to the 'Zone'.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None (UI organization only)."
          },
          {
            "name": "nHsbZoneIndex",
            "technicalDefault": "1",
            "businessMeaning": "Selects which construction zone (e.g., specific layer or material sub-region) of the element to visualize and modify.",
            "validRange": "1 to 10",
            "unit": "Index/Count",
            "affectsOutput": "Determines which set of geometry profiles is displayed and which internal coordinate system is used for the calculation. Switching this updates the visible grips to the new zone's geometry."
          },
          {
            "name": "sGripType",
            "technicalDefault": "|Edge|",
            "businessMeaning": "Defines the type of control points (grips) displayed on the profile for manipulation.",
            "validRange": "Edge, Corner",
            "unit": "Option",
            "affectsOutput": "If 'Edge' is selected, grips appear at the middle of profile edges, allowing edge stretching. If 'Corner' is selected, grips appear at vertices, allowing corner repositioning."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nHsbZoneIndex changes",
            "effect": "The displayed profile and the list of grip points are recalculated for the new zone.",
            "cascade": [
              "_PtG",
              "Display dpZone"
            ]
          },
          {
            "trigger": "sGripType changes",
            "effect": "The grips are reset from edge-midpoints to vertices (or vice versa) based on the new selection.",
            "cascade": [
              "_PtG",
              "arPtGrip"
            ]
          },
          {
            "trigger": "_PtG (Grip Point) is moved by user",
            "effect": "The underlying PlaneProfile geometry is updated, and the Element's Netto profile for the specific zone is modified in the 3D model.",
            "cascade": [
              "el.setProfNetto()"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Geometry/Display",
            "description": "Visual representation of the Zone profile and interactive grip points in the 3D model.",
            "appliedTo": "The selected Element."
          },
          {
            "type": "PlaneProfile",
            "description": "The modified profile shape stored in the element's database.",
            "appliedTo": "The specific Zone (nZoneIndex) of the selected Element."
          }
        ]
      },
      "tokens_used": 4164,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User executes HSB_E-ZoneProfiles command.",
          "[Insertion] Script checks insertCycleCount to prevent duplicate execution.",
          "[Insertion] Script checks for a valid Execute Key (catalog preset).",
          "[Insertion] If no valid key, the native Properties Dialog is displayed.",
          "[Insertion] User is prompted to select one or more Elements.",
          "[Insertion] Loop iterates through selected Elements. Existing script instances on these Elements are erased.",
          "[Insertion] New script instances (Satellites) are created and attached to each selected Element using dbCreate.",
          "[Insertion] The temporary 'Master' instance is erased and the command reports the number of inserted TSLs.",
          "[Runtime - Satellite] The instance validates that it is attached to an Element.",
          "[Runtime - Satellite] The script retrieves the 'Zone index' and 'Active grippoints' properties.",
          "[Runtime - Satellite] The script extracts the PlaneProfile (profNetto) for the specified zone.",
          "[Runtime - Satellite] The script generates grip points based on the selected Grip Type (Edge midpoints or Vertices).",
          "[Runtime - Satellite] If the user modified a property, grips are recalculated/reset.",
          "[Runtime - Satellite] If the user dragged a grip, the profile geometry is updated and applied to the Element.",
          "[Runtime - Satellite] The updated Zone Profile is drawn in the 3D model."
        ],
        "conditionalBranches": [
          {
            "condition": "Is this the initial Insertion cycle?",
            "path1": {
              "name": "Insertion Phase (Master)",
              "steps": [
                "Check Execute Key",
                "Show Dialog if needed",
                "Prompt Entity Selection",
                "Spawn Satellite Instances",
                "Erase Master Instance"
              ]
            },
            "path2": {
              "name": "Runtime Phase (Satellite)",
              "steps": [
                "Check Element Existence",
                "Map Properties from Master",
                "Extract Profile Geometry",
                "Handle Grip Events",
                "Draw Visuals"
              ]
            }
          },
          {
            "condition": "How did the modification occur?",
            "path1": {
              "name": "Property Change (OPM)",
              "steps": [
                "Detect 'Zone index' or 'Active grippoints' change",
                "Clear internal grip array (_PtG)",
                "Recalculate grips for new configuration"
              ]
            },
            "path2": {
              "name": "Grip Manipulation (On-screen)",
              "steps": [
                "Detect '_PtG' property change",
                "Project moved point to Zone Plane",
                "Apply move to PlaneProfile (Edge or Vertex)",
                "Update Element Netto Profile"
              ]
            }
          },
          {
            "condition": "What is the selected Grip Type?",
            "path1": {
              "name": "Edge Grips",
              "steps": [
                "Get grip points via getGripEdgeMidPoints()",
                "Move logic uses moveGripEdgeMidPointAt()"
              ]
            },
            "path2": {
              "name": "Corner Grips",
              "steps": [
                "Get grip points via getGripVertexPoints()",
                "Move logic uses moveGripVertexPointAt()"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases itself immediately if insertCycleCount > 1 to prevent recursion."
          },
          {
            "check": "Element Attachment",
            "errorMessage": "|Invalid selection|!",
            "recovery": "Script erases the satellite instance if _Element.length() is 0."
          },
          {
            "check": "Zone Index Range",
            "errorMessage": "None",
            "recovery": "If nZoneIndex > 5, it is re-mapped using logic: nZoneIndex = 5 - nZoneIndex."
          },
          {
            "check": "Grip Projection",
            "errorMessage": "None",
            "recovery": "Moved grip points are mathematically projected back onto the Zone's Z-Plane (pnZoneZ) to ensure valid geometry before updating the profile."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Switch Active Zone",
            "how": "OPM Property: 'Zone index'",
            "effect": "Resets the display to show the profile of the newly selected zone (e.g., Zone 2). Grips are recalculated for the new shape."
          },
          {
            "action": "Change Grip Interaction Mode",
            "how": "OPM Property: 'Active grippoints'",
            "effect": "Toggles grips between Edge-midpoints (stretching) and Corners (moving vertices). The existing grip array is cleared and regenerated."
          },
          {
            "action": "Modify Zone Geometry",
            "how": "Drag On-screen Grips (_PtG)",
            "effect": "The PlaneProfile is updated locally. The function el.setProfNetto() is called, permanently modifying the Element's geometry in the 3D model for that zone."
          }
        ]
      },
      "tokens_used": 6208,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-ZoneProfiles.mcr\n\n## Overview\nThis script allows you to visualize and interactively modify the contour profiles of specific material zones (layers) within an Element. It provides on-screen grips to stretch edges or move corners, updating the Element's geometry in real-time.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates within the 3D model to modify Element geometry. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | This is a modeling tool, not a detailing tool. |\n\n## Prerequisites\n- **Required Entities**: An existing Element (Wall, Floor, or Roof).\n- **Minimum Beam Count**: 0 (Operates on the Element level).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-ZoneProfiles.mcr`\n*(Alternatively, click the custom toolbar button assigned to this script.)*\n\n### Step 2: Select Elements\n```\nCommand Line: Select one or more elements\nAction: Click on the Element(s) you wish to modify and press Enter.\n```\n*The script will attach itself to the selected Element(s). If run multiple times on the same Element, old instances are automatically replaced.*\n\n### Step 3: Configure Zone and Grips\nSelect the Element (or the script instance if visible) to open the **Properties Palette**.\n1.  **Zone Index**: Set the dropdown to the specific material layer (1-10) you want to edit.\n2.  **Active Grippoints**: Choose `|Edge|` to stretch walls or `|Corner|` to move specific vertices.\n\n### Step 4: Modify Geometry\n```\nAction: Click and drag the blue square grips displayed on the Element profile.\n```\n*Moving a grip updates the shape of the selected Zone immediately.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone | Text | - | **(Read-only)** Visual category separator for Zone settings. |\n| Zone index | Dropdown | 1 | Selects which material zone (layer) of the element to visualize and edit (Range 1-10). |\n| Active grippoints | Dropdown | \\|Edge\\| | Determines how the profile is modified: <br> - `|Edge|`: Grips appear at edge midpoints to stretch the profile.<br> - `|Corner|`: Grips appear at vertices to move corners. |\n\n## Right-Click Menu Options\nNone. The script is controlled via the Properties Palette and on-screen grips.\n\n## Settings Files\nNone.\n\n## Tips\n- **Multiple Zones**: If your Element has multiple layers (e.g., Studs + Insulation), change the **Zone index** to switch between editing the Stud layer or the Insulation layer without re-inserting the script.\n- **Switching Modes**: Changing the **Active grippoints** from `|Edge|` to `|Corner|` (or vice versa) will reset the grip positions to match the new logic.\n- **Selection**: You can select multiple Elements during the insertion prompt to apply the tool to several parts at once.\n\n## FAQ\n- **Q: Why don't I see any grips?**\n  A: Ensure you have selected the correct **Zone index**. If the selected zone has no geometry or is invalid, grips may not appear. Also, check if your Element is frozen or on a locked layer.\n- **Q: Can I use this to create a complex shape from scratch?**\n  A: This tool is designed to modify *existing* zone profiles (e.g., creating a notch or adjusting a diagonal cut). You generally start with a standard Element and deform it using the grips.\n- **Q: What happens if I change the Zone index?**\n  A: The script immediately clears the current grips and recalculates them based on the shape of the new Zone selected. The visual display updates to show the new profile."
      },
      "tokens_used": 5199,
      "error": null
    }
  }
}