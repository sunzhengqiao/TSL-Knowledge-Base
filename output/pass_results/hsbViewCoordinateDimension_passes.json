{
  "filename": "hsbViewCoordinateDimension.mcr",
  "status": "completed",
  "total_tokens": 53341,
  "processing_time": 273.28437423706055,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": null,\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"All tsls attached to the element are dimensioned at their origin point unless a filter rule (A) applies and/or tsl based dimension points are published (B).\\n\\nThe tool supports @(<Format>) definitions as an apendix to the cordinate dimension\\nThe dimension can be grouped as global dimension (image vertical dim) or placed nearby the dimension point as local dimension (image horizontal dim)\\n\\n(A) Filter rules can be created by a settings xml file, see attached sample. Settings file to be imported/exported by hsbTslSettingsIO, path = <company>\\\\tsl\\\\settings\\n(B) as default the origin of a tsl is taken. TSL Authors may publish custom dimension points by map\\n// publish coordinate dimensions\\nMap mapCoordinateDimension;\\nmapCoordinateDimension.setPoint3dArray(\\\"Points\\\", ptLocs);\\n_Map.setMap(\\\"CoordinateDimension\\\", mapCoordinateDimension);\\n\\nOther entities then tsl are foreseen to be supported, but not implemented yet.\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.5\",\n      \"date\": \"20oct2020\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-9338 internal naming bugfix\"\n    },\n    {\n      \"version\": \"1.4\",\n      \"date\": \"11oct2019\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-5749  enhanced to snap dimpoionts to the reference zone if not a solid, default filter definition deployed\"\n    },\n    {\n      \"version\": \"1.3\",\n      \"date\": \"23sep2019\",\n      \"author\": \"thorsten.huck@hsbcad.com\",\n      \"changes\": \"HSB-5455 property 'reference' added to specify reference zone\"\n    },\n    {\n      \"version\": \"1.2\",\n      \"date\": \"11jul2019\",\n      \"author\": \"thor"
      },
      "tokens_used": 8811,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly checks Viewport().inLayoutTab() to switch logic. It collects ShopDrawView entities using Group().collectEntities() when not in a layout tab. It collects Viewport entities using getViewport() when in a layout tab. It also supports Section2d entities in model space. It uses DrawingPlane (dp) and matrix transforms (ms2ps) to render 2D dimensions based on the view context."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView",
            "Viewport",
            "Section2d"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires a valid drawing view context, either a ShopDrawing View (ShopDrawView), a Layout Viewport, or a Model Space Section.",
          "requiredSettings": [
            "hsbViewCoordinateDimension.xml"
          ]
        }
      },
      "tokens_used": 8233,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "bInLayoutTab == true",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select Section2d|",
              "condition": "bInLayoutTab == false",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "_bOnInsert && _kExecuteKey is empty",
            "title": "Properties",
            "dataSource": "Standard Property Palette",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sAttribute",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Content|",
            "description": "|Defines the text and/or attributes.| |Multiple lines are separated by '\\P'| |Attributes can also be added or removed by context commands.|"
          },
          {
            "index": 1,
            "variable": "sRule",
            "type": "PropString",
            "displayName": "|Filter Rule|",
            "defaultValue": "|<Disabled>|",
            "inputType": "dropdown",
            "options": [
              "|<Disabled>|",
              "Populated from XML Settings"
            ],
            "category": "|Content|",
            "description": "|Specifies a filter rule.|"
          },
          {
            "index": 4,
            "variable": "sReference",
            "type": "PropString",
            "displayName": "|Reference|",
            "defaultValue": "|byElement|",
            "inputType": "dropdown",
            "options": [
              "|byElement|",
              "|Zone| -5",
              "|Zone| -4",
              "|Zone| -3",
              "|Zone| -2",
              "|Zone| -1",
              "|Zone| 0",
              "|Zone| 1",
              "|Zone| 2",
              "|Zone| 3",
              "|Zone| 4",
              "|Zone| 5"
            ],
            "category": "|Content|",
            "description": "|Defines the reference of the dimension.| |In case the specified reference is invalid the reference will fall back to zone 0 or the element outline.|"
          },
          {
            "index": 2,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|Horizontal Local|",
            "inputType": "dropdown",
            "options": [
              "|Horizontal Local|",
              "|Horizontal Global|",
              "|Vertical Local|",
              "|Vertical Global|"
            ],
            "category": "|Display|",
            "description": "|Defines the Alignment|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Text Height| |0 = byDimstyle|"
          },
          {
            "index": 3,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": "Sorted DimStyles",
            "inputType": "dropdown",
            "options": [
              "Current Drawing DimStyles"
            ],
            "category": "|Display|",
            "description": "|Defines the Dimstyle|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Export Default Settings|",
            "handler": "sTriggerExportDefaultRule",
            "action": "Writes current mapSetting to XML file at <company>\\TSL\\Settings\\hsbViewCoordinateDimension.xml",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "hsbViewCoordinateDimension.xml",
            "searchPaths": [
              "<company>\\TSL\\Settings",
              "<install>\\Content\\General\\TSL\\Settings"
            ],
            "purpose": "Stores default filter rules and script configuration",
            "required": false
          }
        ]
      },
      "tokens_used": 9072,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates coordinate dimensions (elevations/positions) for specific TSL components (connectants, addons) within 2D production drawings, referencing either the element or structural zones.",
          "category": "ShopDrawing / Annotation",
          "typicalUseCase": "A detailing engineer needs to label the heights of wall plates or the position of specific connection hardware relative to a reference line (e.g., 0.00 level) in an elevation view."
        },
        "parameters": [
          {
            "name": "sAttribute",
            "technicalDefault": "",
            "businessMeaning": "Defines the template for the dimension text content, allowing the user to display specific coordinate values (X, Y, Z) or custom attributes.",
            "validRange": "Text strings combined with valid attribute keys (e.g., 'Height: @(Z)', 'X-Coord: @(X)')",
            "unit": "string",
            "affectsOutput": "Determines the actual text label displayed next to the dimension point (e.g., '2400' vs 'Level: 2400')."
          },
          {
            "name": "sRule",
            "technicalDefault": "|<Disabled>|",
            "businessMeaning": "Filters which specific TSL objects or elements receive dimensions based on definitions stored in the external settings XML file.",
            "validRange": "List of rule names from the XML configuration file or '|<Disabled>|' (dimension all detected objects).",
            "unit": "string",
            "affectsOutput": "Controls the quantity and selection of dimensions generated in the view."
          },
          {
            "name": "sReference",
            "technicalDefault": "|byElement|",
            "businessMeaning": "Sets the origin (Zero point) for the dimension calculation. It can be relative to the element itself or specific structural zones (grid lines/levels).",
            "validRange": "'|byElement|' or specific Zone indices ('|Zone| -5' to '|Zone| 5').",
            "unit": "enum",
            "affectsOutput": "Changes the calculated numerical value of the dimension and the visual starting point of the leader line."
          },
          {
            "name": "sAlignment",
            "technicalDefault": "|Horizontal Local|",
            "businessMeaning": "Controls the orientation of the dimension text and leader lines relative to the view or world coordinate system.",
            "validRange": "'|Horizontal Local|', '|Horizontal Global|', '|Vertical Local|', '|Vertical Global|'",
            "unit": "enum",
            "affectsOutput": "Rotates the text and positions the leader line (e.g., Global keeps text horizontal regardless of view rotation)."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Overrides the text size defined in the CAD dimstyle for these specific dimensions.",
            "validRange": "0 (use Dimstyle default) or positive values in drawing units (e.g., 2.5 for 2.5mm).",
            "unit": "mm/drawing units",
            "affectsOutput": "The visual size of the dimension text in the drawing."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "Current Drawing DimStyles",
            "businessMeaning": "Assigns a specific CAD dimension style to control arrowheads, color, and fonts, ensuring consistency with drawing standards.",
            "validRange": "Any valid Dimstyle name loaded in the current drawing.",
            "unit": "string",
            "affectsOutput": "The graphical appearance (color, line type, arrows) of the dimension."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight is set to '0'",
            "effect": "The text height is determined by the 'sDimStyle' setting.",
            "cascade": [
              "sDimStyle"
            ]
          },
          {
            "trigger": "sRule is changed",
            "effect": "The options available depend on the 'hsbViewCoordinateDimension.xml' file located in the company or installation path.",
            "cascade": []
          },
          {
            "trigger": "sReference is set to a specific Zone",
            "effect": "If the specified Zone does not exist in the current context, the script falls back to 'Zone 0' or the element outline.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "2D Dimension / Text",
            "description": "Creates annotation text (coordinate values) and leader lines in the 2D view (Layout or Model Space).",
            "appliedTo": "TSL Instances found within the selected ShopDrawView, Viewport, or Section."
          },
          {
            "type": "Protection Range (PLine)",
            "description": "Invisible or visual boundary used to prevent other annotations from overlapping these dimensions.",
            "appliedTo": "The area surrounding the generated dimension text."
          }
        ]
      },
      "tokens_used": 9352,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launched via command line or catalog insertion.",
          "2. Load settings from XML ('hsbViewCoordinateDimension.xml') located in <company>\\TSL\\Settings or <install> directory.",
          "3. Define properties (sAttribute, sRule, sReference, sAlignment, dTextHeight, sDimStyle) and load defaults.",
          "4. Determine execution context (Model Space vs. Layout Tab).",
          "5. [Branch A] If in Layout Tab: Prompt user to 'Select a viewport'.",
          "6. [Branch B] If in Model Space: Search for ShopDrawView entities. If found, use active view. If not, prompt user to 'Select Section2d'.",
          "7. Initialize Drawing Plane (dp) and transformation matrices based on selected view/section.",
          "8. Determine Reference Zone based on 'sReference' property (Element outline or specific Zone index).",
          "9. Collect entities (Beams) to scan for TSLs.",
          "10. Loop through collected Beams to find attached TSL instances (TslInst).",
          "11. For each TSL, check against 'Filter Rule' (sRule).",
          "12. [Conditional] If filter is enabled and rule matches/does not match (depending on operation), skip processing TSL.",
          "13. Retrieve dimension points from TSL's internal map ('CoordinateDimension') or default to TSL origin.",
          "14. Determine alignment vectors (Local vs. Global, Horizontal vs. Vertical) based on 'sAlignment' property.",
          "15. Loop through dimension points.",
          "16. Calculate coordinate value relative to the Reference Zone.",
          "17. Check if point is within Viewport/Section bounds. If outside, skip.",
          "18. [Conditional] If 'Local' alignment, dimension point is not a solid, and point is outside Reference Zone profile: Snap point to Reference Zone outline.",
          "19. Format dimension text string using 'sAttribute' template (handling @(Variable) replacements).",
          "20. Calculate leader line end point (offset by dXOffset + dXLeader).",
          "21. Draw dimension text and leader line on Drawing Plane.",
          "22. Create and store 'Protection Range' (PLine) to prevent annotation overlap.",
          "23. Publish Protection Range map ('ViewProtect')."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Environment (Model vs. Layout)",
            "path1": {
              "name": "Layout Tab (Paper Space)",
              "steps": [
                "Check Viewport().inLayoutTab() returns true.",
                "Run getViewport('|Select a viewport|') to get user selection.",
                "Extract view parameters (VP origin, scale, rotation) from selected Viewport."
              ]
            },
            "path2": {
              "name": "Model Space",
              "steps": [
                "Check Viewport().inLayoutTab() returns false.",
                "Attempt to find ShopDrawView entities via Group().collectEntities().",
                "If ShopDrawView exists: use it.",
                "If no ShopDrawView: Run PrEntity to prompt user for Section2d.",
                "Extract view parameters from ShopDrawView or Section2d."
              ]
            }
          },
          {
            "condition": "Filter Rule Application",
            "path1": {
              "name": "Rule Disabled or Empty",
              "steps": [
                "sRule equals '|<Disabled>|' or no rules defined.",
                "Process all detected TSLs attached to the element."
              ]
            },
            "path2": {
              "name": "Active Filter Rule",
              "steps": [
                "sRule matches a name in FilterRule[] map.",
                "Check TSL properties against the 'Format' strings defined in the rule.",
                "If rule Operation is 'Exclude' and match found: Skip dimension.",
                "If rule Operation is 'Include' and no match found: Skip dimension."
              ]
            }
          },
          {
            "condition": "Point Snapping (Local Alignment)",
            "path1": {
              "name": "Snap to Reference Zone",
              "steps": [
                "Alignment is Local ('Horizontal Local' or 'Vertical Local').",
                "Dimension point is NOT a solid body.",
                "Point lies outside the Reference Zone Profile.",
                "Script projects point onto the nearest edge of the Reference Zone Profile."
              ]
            },
            "path2": {
              "name": "Keep Original Point",
              "steps": [
                "Alignment is Global.",
                "OR Point is inside Reference Zone Profile.",
                "OR Point represents a solid body.",
                "Original TSL point is used for dimensioning."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport or Section2d Selection",
            "errorMessage": "Implicitly handled by standard prompts. If user cancels selection (Esc), insertion halts.",
            "recovery": "User must re-run command and complete entity selection."
          },
          {
            "check": "Settings File Existence",
            "errorMessage": "None explicitly shown in code, but falls back to installation path if company path is missing.",
            "recovery": "Ensure 'hsbViewCoordinateDimension.xml' exists in <company>\\TSL\\Settings or <install>\\Content\\General\\TSL\\Settings."
          },
          {
            "check": "Reference Zone Validity",
            "errorMessage": "None explicitly displayed to user.",
            "recovery": "Script automatically falls back to 'Zone 0' or 'Element Outline' if specified Zone (-5 to 5) is invalid/missing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Dimension Content/Format",
            "how": "OPM Properties Palette -> Format (sAttribute)",
            "effect": "Updates the text label (e.g., changes 'Elev: @(Z)' to 'Y: @(Y)')."
          },
          {
            "action": "Filter Dimensioned Objects",
            "how": "OPM Properties Palette -> Filter Rule (sRule)",
            "effect": "Adds or removes dimensions based on TSL names/types defined in the XML settings."
          },
          {
            "action": "Adjust Reference Level",
            "how": "OPM Properties Palette -> Reference (sReference)",
            "effect": "Recalculates coordinate values relative to a different structural zone or element outline."
          },
          {
            "action": "Change Alignment",
            "how": "OPM Properties Palette -> Alignment (sAlignment)",
            "effect": "Rotates dimension text and leader lines; switches between local (view-relative) and global (world-relative) orientation."
          },
          {
            "action": "Export Default Settings",
            "how": "Right-Click Context Menu -> '|Export Default Settings|'",
            "effect": "Writes the current default rule map to the XML file in the company settings path."
          }
        ]
      },
      "tokens_used": 10641,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbViewCoordinateDimension.mcr\n\n## Overview\nThis script automatically generates coordinate dimensions (labels) for TSL components (connectors, addons) within 2D production drawings. It displays elevation or position data relative to a reference zone or element, with options for custom formatting and alignment.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Works with ShopDrawViews or Section2d entities. |\n| Paper Space | Yes | Works with Layout Viewports. |\n| Shop Drawing | Yes | Designed for detailing views. |\n\n## Prerequisites\n- **Required Entities**: A valid view context is required. This can be a `ShopDrawView` or `Section2d` in Model Space, or a `Viewport` in a Layout tab.\n- **Minimum Beam Count**: 0 (It scans attached TSLs on existing elements).\n- **Required Settings**: Optional `hsbViewCoordinateDimension.xml` for advanced filter rules.\n\n## Usage Steps\n\n### Step 1: Launch Script\nExecute the command `TSLINSERT` (or `hsbTslInsert`) and select `hsbViewCoordinateDimension.mcr` from the catalog.\n\n### Step 2: Select View Context\nThe script prompts for input based on your current workspace:\n\n**If in a Layout Tab (Paper Space):**\n```\nCommand Line: |Select a viewport|\nAction: Click on the viewport border where you want to generate dimensions.\n```\n\n**If in Model Space:**\n```\nCommand Line: |Select Section2d|\nAction: \n1. The script attempts to automatically detect a ShopDrawView. \n2. If none is found, click on a Section2d entity to define the view.\n```\n\n### Step 3: Configure Properties\nOnce inserted, select the script instance and open the **Properties Palette** (Ctrl+1) to adjust labels, references, and filters.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Format** | Text | Empty | Defines the text content. Use `@(X)`, `@(Y)`, or `@(Z)` to display coordinates (e.g., \"Level: @(Z)\"). Separate multiple lines with `\\P`. |\n| **Filter Rule** | Dropdown | \\|<Disabled>\\| | Specifies a filter rule to limit which TSLs are dimensioned. Rules are loaded from the external XML settings file. |\n| **Reference** | Dropdown | \\|byElement\\| | Sets the zero point for the dimension. Choose \"byElement\" or a specific \"Zone\" (-5 to 5). If the zone is invalid, it falls back to Zone 0 or the element outline. |\n| **Alignment** | Dropdown | \\|Horizontal Local\\| | Defines orientation. \"Local\" rotates with the view; \"Global\" stays fixed to world coordinates. Options include Horizontal/Vertical variants. |\n| **Text Height** | Number | 0 | Defines the text size. Set to `0` to use the height defined by the Dimstyle. |\n| **Dimstyle** | Dropdown | Sorted DimStyles | Selects the CAD dimension style to control arrows, color, and font. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Export Default Settings** | Writes the current configuration map to an XML file (`hsbViewCoordinateDimension.xml`) located in your company settings folder. |\n\n## Settings Files\n- **Filename**: `hsbViewCoordinateDimension.xml`\n- **Location**: `<company>\\TSL\\Settings` or `<install>\\Content\\General\\TSL\\Settings`\n- **Purpose**: Stores custom filter rules. Allows you to define complex logic to include or exclude specific TSLs based on their properties or names.\n\n## Tips\n- **Snapping**: If using \"Local\" alignment and the dimension point is not on a solid body, the script will automatically snap the dimension leader to the nearest reference zone outline. This keeps drawings clean.\n- **Formatting**: You can combine static text with attributes. For example, enter `Elev: @(Z) mm` in the **Format** field to display \"Elev: 2400 mm\".\n- **Global vs Local**: Use **Global** alignment if you want text to remain perfectly horizontal regardless of the view angle (common for elevation labels). Use **Local** for text aligned with specific structural members.\n\n## FAQ\n- **Q: My dimensions are showing 0.00. How do I fix this?**\n  A: Check your **Reference** property. If it is set to a Zone that does not exist in the current view, the value may calculate incorrectly. Try setting it to `|byElement|` or `|Zone| 0`.\n\n- **Q: Can I dimension only specific connectors (e.g., only screws)?**\n  A: Yes. Create a filter rule in the `hsbViewCoordinateDimension.xml` settings file (or export defaults and edit it), then select that rule in the **Filter Rule** property.\n\n- **Q: The text is too small to read.**\n  A: Set the **Text Height** property to a specific value (e.g., `2.5`) instead of `0`. Ensure your units (mm/inches) match your drawing standards."
      },
      "tokens_used": 7232,
      "error": null
    }
  }
}