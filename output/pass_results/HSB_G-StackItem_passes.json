{
  "filename": "HSB_G-StackItem.mcr",
  "status": "completed",
  "total_tokens": 29551,
  "processing_time": 481.2778012752533,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6275,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly targets _kModelSpace in dbCreate() and Group().collectEntities(). Logic creates and transforms 3D Body objects and Element coordinate systems rather than generating 2D drawings."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Parent script 'HSB_G-Stack' must exist in the model to define the stacking volume"
          ]
        }
      },
      "tokens_used": 3957,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select a set of elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "On Insert (if _kExecuteKey is empty or not found in catalog)",
            "title": null,
            "dataSource": "Properties Palette",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": null,
            "variable": "N/A",
            "type": "N/A",
            "displayName": "N/A",
            "defaultValue": "N/A",
            "inputType": "N/A",
            "options": [],
            "category": null,
            "description": "Properties are handled via Catalogs (_kExecuteKey) but are not explicitly defined in this script."
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Double Click",
            "handler": "TslDoubleClick",
            "action": "Rotates the instance 90 degrees around the X-axis.",
            "alsoTriggeredBy": "Double Click"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 3465,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Defines a single item within a stacking configuration, linking it visually and logically to a parent stack for transport and logistics management.",
          "category": "Logistics / Management",
          "typicalUseCase": "When generating packing lists or transport loads, this script attaches individual timber elements to specific stacks or crates defined by the parent 'HSB_G-Stack' script."
        },
        "parameters": [
          {
            "name": "stackScriptName",
            "technicalDefault": "\"HSB_G-Stack\"",
            "businessMeaning": "The specific name of the parent stacking script (TSL) that defines the volume or area where elements are stacked.",
            "validRange": "Valid TSL filename present in the catalog",
            "unit": "String",
            "affectsOutput": "Determines which parent entities the script searches for to calculate relative positioning. If incorrect, the element will not link to a stack."
          },
          {
            "name": "distanceBetweenStackingChilds",
            "technicalDefault": "U(3000)",
            "businessMeaning": "The offset distance used when manually inserting multiple stacking items in a sequence via command line.",
            "validRange": "500 - 10000 mm",
            "unit": "mm",
            "affectsOutput": "Controls the spacing of temporary insertion points during the manual creation phase."
          },
          {
            "name": "stackingChildColor",
            "technicalDefault": "140",
            "businessMeaning": "The display color used to visualize the element volume within the stack context.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Changes the visual color of the 3D representation in the model."
          },
          {
            "name": "_kExecuteKey (Double Click)",
            "technicalDefault": "\"TslDoubleClick\"",
            "businessMeaning": "Triggers a 90-degree rotation of the instance around its X-axis.",
            "validRange": "Fixed Internal Keyword",
            "unit": "N/A",
            "affectsOutput": "Rotates the coordinate system of the stack item instance."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Parent Stack Script ('HSB_G-Stack') Movement",
            "effect": "The relative position of this child item updates to remain attached to the parent stack volume.",
            "cascade": [
              "Hsb_StackingChild Map"
            ]
          },
          {
            "trigger": "Element Geometry Change",
            "effect": "The visual representation of the stack item updates to match the new Element dimensions.",
            "cascade": [
              "stackingChild Body"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (Visualization)",
            "description": "A 3D bounding box representing the timber element, transformed relative to the stack coordinate system.",
            "appliedTo": "Model Space"
          },
          {
            "type": "Element Map Data",
            "description": "Stores 'Hsb_StackingChild' data (ParentUID, relative origin, and vectors) on the Element entity.",
            "appliedTo": "Selected Elements"
          },
          {
            "type": "Visual Axes",
            "description": "Draws the local X, Y, and Z axes at the stack item's origin for orientation reference.",
            "appliedTo": "Model Space"
          }
        ]
      },
      "tokens_used": 4465,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initialized.",
          "Check if execution is during Insert (_bOnInsert).",
          "[Insert Mode] Check insertCycleCount to prevent duplicate execution.",
          "[Insert Mode] Verify _kExecuteKey against catalog list.",
          "[Insert Mode] If key invalid/empty, showDialog (Properties Palette).",
          "[Insert Mode] Prompt user to select Elements (PrEntity).",
          "[Insert Mode] Iterate through selected elements.",
          "[Insert Mode] Create new TSL instances (dbCreate) attached to each Element at calculated location.",
          "[Insert Mode] Erase original 'tool' instance.",
          "[Calc/Update Mode] Validate that an Element is attached to the instance.",
          "[Calc/Update Mode] Retrieve Element geometry (CSys, bounding box dimensions).",
          "[Calc/Update Mode] Create 3D Body representing the stack item.",
          "[Calc/Update Mode] Check for Double Click command (_kExecuteKey).",
          "[Calc/Update Mode] Search Model Space for parent 'HSB_G-Stack' instances.",
          "[Calc/Update Mode] Test for intersection between this item and parent Stack bodies.",
          "[Calc/Update Mode] If intersecting, calculate relative vectors (PtRelOrg, VecX/Y/Z) and write 'Hsb_StackingChild' map to Element.",
          "[Calc/Update Mode] Visualize Element number and local axes.",
          "[Calc/Update Mode] If intersecting, visualize GenBeams projected relative to parent Stack coordinate system."
        ],
        "conditionalBranches": [
          {
            "condition": "Check execution context (_bOnInsert).",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Verify insertCycleCount",
                "Check Catalog Key validity",
                "Show Properties Dialog (if needed)",
                "Select Elements",
                "Batch create instances",
                "Erase temporary instance"
              ]
            },
            "path2": {
              "name": "Calculation/Update Mode",
              "steps": [
                "Validate attached Element",
                "Construct visualization Body",
                "Handle rotation logic",
                "Detect parent Stack",
                "Update Map data",
                "Draw projection"
              ]
            }
          },
          {
            "condition": "Parent Stack Intersection detection.",
            "path1": {
              "name": "Intersection Found",
              "steps": [
                "Retrieve Parent UID from 'Hsb_StackingParent' map",
                "Calculate relative transformation matrix",
                "Write 'Hsb_StackingChild' map to Element",
                "Visualize GenBeams in Stack context"
              ]
            },
            "path2": {
              "name": "No Intersection",
              "steps": [
                "Skip map writing",
                "Visualize only local bounding box and axes"
              ]
            }
          },
          {
            "condition": "Double Click Trigger (_kExecuteKey == 'TslDoubleClick').",
            "path1": {
              "name": "Double Click Detected",
              "steps": [
                "Create 90-degree rotation CoordSys around X-axis",
                "Transform _ThisInst"
              ]
            },
            "path2": {
              "name": "Normal Execution",
              "steps": [
                "Skip rotation logic"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Entity Attachment",
            "errorMessage": "Invalid or no element selected.",
            "recovery": "Script erases itself. User must re-insert and select a valid Element."
          },
          {
            "check": "insertCycleCount",
            "errorMessage": "None (Internal logic).",
            "recovery": "Script terminates immediately if cycle > 1 to prevent recursion."
          },
          {
            "check": "Parent Stack Existence",
            "errorMessage": "None (Silent failure).",
            "recovery": "If no parent 'HSB_G-Stack' is found or intersected, the script continues but does not update the 'Hsb_StackingChild' map. The item remains an orphaned visual box until moved into a stack volume."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Rotate Item",
            "how": "Double Click",
            "effect": "Rotates the instance 90 degrees around its local X-axis, updating orientation."
          },
          {
            "action": "Update Link Data",
            "how": "Move instance (Grip edit) or Move Parent Stack",
            "effect": "Recalculates the 'Hsb_StackingChild' map (Relative Origin and Vectors) on the attached Element, maintaining the logical link to the parent stack volume."
          },
          {
            "action": "Change Visual Appearance",
            "how": "Properties Palette (OPM)",
            "effect": "Updates color index and text height immediately."
          }
        ]
      },
      "tokens_used": 6338,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-StackItem\n\n## Overview\nThis script is used to define individual timber elements as items within a transport stack. It links selected elements to a parent stacking volume (created by `HSB_G-Stack`) for logistics and packing list generation.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be inserted in Model Space to interact with 3D stack volumes. |\n| Paper Space | No | Not designed for 2D drawings. |\n| Shop Drawing | No | Not used for detailing views. |\n\n## Prerequisites\n- **Required Entities**: At least one hsbCAD Element (e.g., a beam or wall).\n- **Parent Script**: The parent script `HSB_G-Stack` must exist in the model to define the stacking volume.\n- **Required Space**: Model Space only.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse and select `HSB_G-StackItem.mcr`.\n\n### Step 2: Configure Properties (If Prompted)\n```\nCommand Line: [Dialog Appears]\nAction: If the execute key is not set, the Properties Palette will open. Review the default settings (e.g., Stack Script Name) and click OK.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on the timber elements (beams, walls, etc.) you want to include as stack items and press Enter.\n```\n\n### Step 4: Position Items\n```\nAction: The script will attach an instance to each selected element. \nMove these elements (or the script instances) so that they physically intersect with the parent Stack volume.\nNote: The logical link is only established when the item intersects with the parent Stack body.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| stackScriptName | String | HSB_G-Stack | The name of the parent TSL script that defines the stack volume. This must match the filename of the parent script. |\n| distanceBetweenStackingChilds | Double | 3000 mm | The spacing distance used when inserting multiple items in sequence via the command line. |\n| stackingChildColor | Integer | 140 | The color index (0-255) used to display the stack item bounding box in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Double Click | Rotates the stack item instance 90 degrees around its local X-axis. Use this to orient the element correctly within the stack. |\n\n## Settings Files\n- **Filename**: None specified\n- **Location**: N/A\n- **Purpose**: This script relies on the parent `HSB_G-Stack` script configuration rather than its own separate settings file.\n\n## Tips\n- **Establishing Links**: The script writes data to the Element only when it detects a collision with the parent Stack volume. If the element appears as an \"orphaned box,\" move it closer or inside the stack volume.\n- **Visualizing Orientation**: Use the **Double Click** feature to quickly rotate the element orientation if it is not lying flat or oriented correctly in the stack.\n- **Color Coding**: Change the `stackingChildColor` property to visually distinguish between different types of items or layers in your stack.\n\n## FAQ\n- **Q: The script attached to my element, but it doesn't seem to be part of the stack.**\n- **A:** Ensure the element (or the visualization box) physically overlaps with the parent `HSB_G-Stack` volume. The link is calculated based on 3D intersection.\n\n- **Q: How do I change the orientation of the item inside the stack?**\n- **A:** Simply double-click on the stack item instance. It will rotate 90 degrees around its X-axis.\n\n- **Q: What happens if I delete the parent Stack?**\n- **A:** The child items will remain in the model but will lose their logical connection (the relative position map will no longer update)."
      },
      "tokens_used": 5051,
      "error": null
    }
  }
}