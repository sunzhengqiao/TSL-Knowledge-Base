{
  "filename": "StackCreator.mcr",
  "status": "completed",
  "total_tokens": 26148,
  "processing_time": 180.97814273834229,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "16.07.2019",
            "author": "AS",
            "changes": "First revision"
          },
          {
            "version": "1.01",
            "date": "18.09.2019",
            "author": "AS",
            "changes": "Rename StackingSequencer to StackSequencer"
          },
          {
            "version": "1.02",
            "date": "31.10.2019",
            "author": "AS",
            "changes": "Rename to StackCreator."
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "StackSequencer",
          "HSB_I-ShowGroupingInformation",
          "Batch & Stack Info"
        ]
      },
      "tokens_used": 4475,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly uses _kModelSpace in Group().collectEntities() calls and the dbCreate() method. It uses PrEntity to prompt for Element selection which occurs in the 3D model. No references to _kPaperSpace, Viewport, or sd_ prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space with existing Elements to group.",
          "requiredSettings": [
            "StackSequencer",
            "HSB_I-ShowGroupingInformation",
            "Batch & Stack Info"
          ]
        }
      },
      "tokens_used": 3262,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 3517,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Assigns selected Elements to a specific transport stack and defines their sequence order for production logistics.",
          "category": "Production/Logistics",
          "typicalUseCase": "Grouping timber elements (walls, floors) into batches for factory transport and delivery sequencing."
        },
        "parameters": [
          {
            "name": "elementSet",
            "technicalDefault": "Empty",
            "businessMeaning": "The specific timber elements (walls, roofs, floors) selected by the user to be grouped into the next available stack.",
            "validRange": "1 or more existing Elements in the model",
            "unit": "Selection",
            "affectsOutput": "Assigns the new Stack ID and Sequence Number to the selected elements. The order in which elements are selected determines their stack sequence (0, 1, 2...)."
          },
          {
            "name": "GroupName",
            "technicalDefault": "1 (or Max Existing Stack ID + 1)",
            "businessMeaning": "The unique identifier number for the transport stack (batch) being created.",
            "validRange": "Integer > 0 (Auto-incremented based on existing model data)",
            "unit": "Count",
            "affectsOutput": "Written to the 'ParentUID' field in the element's map data. This ID links the elements to a specific transport pile."
          },
          {
            "name": "Seq",
            "technicalDefault": "0",
            "businessMeaning": "The loading position of the element within the stack (e.g., bottom layer, top layer).",
            "validRange": "0 to N-1 (determined by selection order)",
            "unit": "Index",
            "affectsOutput": "Written to the 'Content' map of the element. Used by the StackSequencer to physically arrange the elements in the 3D model."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User Selection (elementSet)",
            "effect": "The script iterates through the selection set to assign sequential 'Seq' numbers starting at 0.",
            "cascade": [
              "Seq"
            ]
          },
          {
            "trigger": "Existing Model Data",
            "effect": "Scans all entities for existing 'Hsb_StackingChild' maps to calculate the next available 'GroupName'.",
            "cascade": [
              "GroupName"
            ]
          },
          {
            "trigger": "Script Execution",
            "effect": "Forces the recalculation of 'HSB_I-ShowGroupingInformation' and 'Batch & Stack Info' TSLs, and triggers 'StackSequencer'.",
            "cascade": [
              "StackSequencer",
              "HSB_I-ShowGroupingInformation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Map Data (Hsb_StackingChild)",
            "description": "Creates or updates the 'Hsb_StackingChild' sub-map on selected elements containing the ParentUID (Stack ID) and Seq (Order).",
            "appliedTo": "Elements selected by the user"
          },
          {
            "type": "TslInst Trigger",
            "description": "Initiates the 'StackSequencer' script to process the new stacking arrangement.",
            "appliedTo": "Model Space"
          }
        ]
      },
      "tokens_used": 5317,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Insertion: User executes StackCreator in Model Space.",
          "2. Initialization: Script collects all entities in Model Space.",
          "3. Data Scan: Script iterates through all entities to find existing 'Hsb_StackingChild' sub-maps matching the group type 'STACKING'.",
          "4. ID Calculation: Extracts existing ParentUIDs, sorts them numerically, and determines the next available ID (Existing Max + 1, defaulting to 1).",
          "5. User Prompt: Command line prompts 'Select elements' for the user to pick timber elements (Walls, Roofs, etc.).",
          "6. Selection Processing: Script validates that elements were selected and stores them in the _Element array.",
          "7. Assignment Loop: For each selected element:",
          "   a. Constructs a 'Hsb_StackingChild' map.",
          "   b. Sets 'ParentUID' to the calculated group name (e.g., '001', '002').",
          "   c. Sets 'Seq' (Content) to the selection index (0, 1, 2...).",
          "   d. Writes the map to the Element.",
          "8. Dependency Update: Script scans Model Space for TslInst entities named 'HSB_I-ShowGroupingInformation' or 'Batch & Stack Info' and forces them to recalc.",
          "9. Sequencer Trigger: Script creates a new instance of 'StackSequencer' via dbCreate to process the stacking arrangement.",
          "10. Cleanup: Script executes eraseInstance() to remove itself from the model."
        ],
        "conditionalBranches": [
          {
            "condition": "User cancels the 'Select elements' prompt (elementSet.go() returns false)",
            "path1": {
              "name": "Successful Selection",
              "steps": [
                "_Element array is populated with selected Elements.",
                "Map data assignment proceeds.",
                "Triggers sequencer and cleans up."
              ]
            },
            "path2": {
              "name": "Cancellation/No Selection",
              "steps": [
                "Script returns immediately.",
                "No maps are written.",
                "No sequencer is triggered.",
                "Instance is erased (implied by default TSL behavior on return during insert, though explicit eraseInstance is at end)."
              ]
            }
          },
          {
            "condition": "Existing Stacking Data Found in Model",
            "path1": {
              "name": "Existing Data",
              "steps": [
                "ParentUIDs array is populated.",
                "Numeric sort performed.",
                "GroupName set to Max ID + 1."
              ]
            },
            "path2": {
              "name": "No Existing Data",
              "steps": [
                "ParentUIDs array remains empty.",
                "GroupName defaults to '1'."
              ]
            }
          },
          {
            "condition": "TslInst Scan for Info Scripts",
            "path1": {
              "name": "Info Script Found",
              "steps": [
                "TslInst.recalc() is called on the specific instance to update labels."
              ]
            },
            "path2": {
              "name": "Info Script Not Found",
              "steps": [
                "No action taken for that specific script type.",
                "Loop continues to next TslInst."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Entity Selection",
            "errorMessage": "Implicit. If no entities are selected, the logic inside 'if (elementSet.go())' is skipped, effectively cancelling the operation.",
            "recovery": "User must re-run the script and select elements."
          },
          {
            "check": "Model Space Requirement",
            "errorMessage": "None (internal), but script uses _kModelSpace.",
            "recovery": "User must ensure they are working in Model Space."
          }
        ],
        "postInsertionActions": [
          {
            "action": "View Updated Stacking Info",
            "how": "Visual refresh (dependent on 'HSB_I-ShowGroupingInformation' and 'Batch & Stack Info' scripts active in the model).",
            "effect": "Text labels or visual indicators update to show the new Stack ID (ParentUID) and Sequence Number on the elements."
          },
          {
            "action": "Run StackSequencer",
            "how": "Automatic (triggered by this script).",
            "effect": "The selected elements are physically arranged or visually represented according to their new stack sequence."
          },
          {
            "action": "Script Removal",
            "how": "Automatic (eraseInstance).",
            "effect": "The StackCreator instance is removed from the model immediately after execution, leaving only the modified map data on the elements."
          }
        ]
      },
      "tokens_used": 4748,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# StackCreator.mcr\n\n## Overview\nAutomates the assignment of timber elements to transport stacks. It calculates the next available Stack ID, assigns sequential loading numbers to selected elements, and triggers the physical stacking arrangement.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in the 3D model where elements exist. |\n| Paper Space | No | Not designed for layout views or drawings. |\n| Shop Drawing | No | Not intended for manufacturing detailing views. |\n\n## Prerequisites\n- **Required Entities:** Elements (Walls, Roofs, Floors) must exist in the model.\n- **Minimum Beams:** 0 (Script runs, but requires selection of at least 1 Element to function).\n- **Required Settings/Scripts:** \n    - `StackSequencer` (Required to visualize/process the stack).\n    - `HSB_I-ShowGroupingInformation` (Optional, for displaying labels).\n    - `Batch & Stack Info` (Optional, for displaying labels).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `StackCreator.mcr` from the file browser.\n\n### Step 2: Select Elements\n```\nCommand Line: Select elements\nAction: Click on the timber elements (Walls, Roofs, Floors) you wish to group into a stack.\n```\n*Note: The order in which you click the elements determines their loading sequence (0, 1, 2...). Press Enter to confirm selection.*\n\n### Step 3: Automatic Processing\nUpon confirmation, the script will:\n1. Calculate the new Stack ID (based on existing stacks in the model + 1).\n2. Assign this Stack ID and a Sequence Number to the selected elements.\n3. Trigger the `StackSequencer` to update the model.\n4. Remove itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| N/A | N/A | N/A | This script does not have editable properties. It runs as a single-use command and deletes itself upon completion. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| N/A | No context menu options are available. |\n\n## Settings Files\nThis script does not use external settings files (`.xml`). It relies on data existing within the model entities and the presence of other TSL scripts (Dependencies) to function.\n\n## Tips\n- **Selection Order Matters:** The first element you click becomes position 0 (usually the bottom layer), the next becomes position 1, and so on. Select elements in the exact order you want them loaded onto the truck.\n- **Auto-Increment:** You do not need to manually type in the Stack Number. The script scans the model, finds the highest existing number, and assigns the next number in sequence to your new selection.\n- **Visual Feedback:** Ensure the `StackSequencer` and/or `HSB_I-ShowGroupingInformation` scripts are active in your project to visualize the changes immediately after running `StackCreator`.\n\n## FAQ\n- **Q: Why did the script disappear after I used it?**\n- **A:** `StackCreator` is a \"command script\" designed to perform a specific task and then clean up after itself. It modifies the element data and removes its instance from the model to keep your project clean.\n\n- **Q: How do I change the Stack ID number it generated?**\n- **A:** The script automatically finds the next available number. To change a specific ID, you would typically need to edit the map data properties of the elements or manually adjust existing stack numbers in the model so the auto-calculation picks up your desired number.\n\n- **Q: What happens if I select no elements?**\n- **A:** The script will cancel the operation, assign no data, and erase itself without making changes to the model."
      },
      "tokens_used": 4829,
      "error": null
    }
  }
}