{
  "filename": "HSB_R-AngleForFlatRoof.mcr",
  "status": "completed",
  "total_tokens": 54315,
  "processing_time": 383.1216332912445,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 4,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "03.07.2014",
            "author": "AS",
            "changes": "Pilot version."
          },
          {
            "version": "1.01",
            "date": "03.07.2014",
            "author": "AS",
            "changes": "Add sheeting distribution."
          },
          {
            "version": "1.02",
            "date": "10.09.2014",
            "author": "AS",
            "changes": "Report infinite loops."
          },
          {
            "version": "1.03",
            "date": "15.09.2014",
            "author": "AS",
            "changes": "First row and column were not created."
          },
          {
            "version": "1.04",
            "date": "16.10.2014",
            "author": "AS",
            "changes": "Ignore small sheet sizes. Create first and last lath."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8276,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script targets ElementRoof() entities and generates physical construction geometry (GenBeams and Sheets) using 3D CoordSys and Vector3d calculations. No 'sd_' prefixes, Viewport handling, or #Type E / _Entity[] patterns characteristic of ShopDrawing or Paper Space scripts are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space with Roof Elements",
          "requiredSettings": []
        }
      },
      "tokens_used": 5736,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select a set of elements|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"|Select start point for distribution|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"showDialog\",\n      \"trigger\": \"_bOnInsert\",\n      \"title\": \"Properties\",\n      \"dataSource\": \"Generated from OPM Properties\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 3,\n      \"variable\": \"sSeparatorLathDistribution\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath distribution\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath distribution\",\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dLathSpacing\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Spacing\",\n      \"defaultValue\": \"U(1250)/3\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Lath distribution\",\n      \"description\": \"Sets the spacing between the laths.\"\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"dLathW\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Beam width\",\n      \"defaultValue\": \"U(40)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Lath distribution\",\n      \"description\": \"Sets the width of the laths.\"\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"dLathStartH\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Maximum beam height\",\n      \"defaultValue\": \"U(220)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Lath distribution\",\n      \"description\": \"Sets the height of the heighest lath.\"\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"dSlopePercentage\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Slope [%]\",\n      \"defaultValue\": 2,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Lath distribution\",\n      \"description\": \"Sets the slope [%].\"\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sSeparatorLathProperties\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath properties\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"nLathColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Lath color\",\n      \"defaultValue\": 52,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": \"Sets the color of the laths.\"\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sLathName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath name\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": \"Sets the name of the laths.\"\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sLathMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath material\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": \"Sets the material of the laths.\"\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"sLathGrade\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath grade\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": \"Sets the grade of the laths.\"\n    },\n    {\n      \"index\": 8,\n      \"variable\": \"sLathInformation\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath information\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Lath properties\",\n      \"description\": \"Sets the information of the laths.\"\n    },\n    {\n      \"index\": 9,\n      \"variable\": \"sLathLabel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Lath label\",\n      \"defaultValue\":"
      },
      "tokens_used": 10098,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Generates tapered laths and tilted sheeting on flat roof elements to create drainage slopes, creating a 'fall' for water runoff.\",\n    \"category\": \"Modeling/Framing\",\n    \"typicalUseCase\": \"Used on flat roof constructions where a physical slope is required for drainage, typically by varying the height of laths and tilting the sheeting boards above them.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dLathSpacing\",\n      \"technicalDefault\": \"U(1250)/3\",\n      \"businessMeaning\": \"The distance between the centerlines of the tapered laths.\",\n      \"validRange\": \"300mm - 1500mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines the frequency of the laths across the roof element. Closer spacing supports thinner sheeting or heavier loads.\"\n    },\n    {\n      \"name\": \"dLathW\",\n      \"technicalDefault\": \"U(40)\",\n      \"businessMeaning\": \"The width (thickness) of the tapered lath perpendicular to the slope direction.\",\n      \"validRange\": \"30mm - 100mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Defines the physical width of the lath beam geometry.\"\n    },\n    {\n      \"name\": \"dLathStartH\",\n      \"technicalDefault\": \"U(220)\",\n      \"businessMeaning\": \"The height of the lath at the start point (_Pt0). This is the maximum height where the slope begins.\",\n      \"validRange\": \"40mm - 300mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Sets the base height for the lathing system. The laths slope down from this height based on the percentage.\"\n    },\n    {\n      \"name\": \"dSlopePercentage\",\n      \"technicalDefault\": \"2\",\n      \"businessMeaning\": \"The pitch or fall angle of the roof, expressed as a percentage (e.g., 2% slope).\",\n      \"validRange\": \"0.5% - 5.0%\",\n      \"unit\": \"%\",\n      \"affectsOutput\": \"Calculates the height difference of each lath and the rotation angle of the sheets to ensure water runoff. Higher values create steeper roofs.\"\n    },\n    {\n      \"name\": \"nLathColor\",\n      \"technicalDefault\": \"52\",\n      \"businessMeaning\": \"The CAD display color used for the generated lath beams.\",\n      \"validRange\": \"0 - 255\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Visual representation in the CAD model only; does not affect geometry.\"\n    },\n    {\n      \"name\": \"sLathName\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The name or designation assigned to the lath entities.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Entity property used for BIM data and lists.\"\n    },\n    {\n      \"name\": \"sLathMaterial\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The material classification of the laths (e.g., C24, GL24h).\",\n      \"validRange\": \"Catalog material name\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Structural calculation and material listing properties.\"\n    },\n    {\n      \"name\": \"sLathGrade\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The strength grade of the timber used for laths.\",\n      \"validRange\": \"Grade code\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Structural properties and reporting.\"\n    },\n    {\n      \"name\": \"sLathInformation\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Additional user-defined comments or details for the laths.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Information fields in reports or labels.\"\n    },\n    {\n      \"name\": \"sLathLabel\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The primary label (mark number) for the laths.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Identification labels in drawings and CAM data.\"\n    },\n    {\n      \"name\": \"sLathSubLabel\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The secondary label for grouping or sub-assembly identification.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Secondary identification in lists.\"\n    },\n    {\n      \"name\": \"sLathSubLabel2\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"A tertiary label field for further classification.\",\n      \"validRange\": \"Text string\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Tertiary identification in lists.\"\n    },\n    {\n      \"name\": \"sLathCode\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"The beam code or production code associated with the laths.\",\n      \"validRange\": \"Production code\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Machine settings or production workflow identifiers.\"\n    },\n    {\n      \"name\": \"dSheetW\",\n      \"technicalDefault\": \"U(1250)\",\n      \"businessMeaning\": \"The width of the sheeting boards (perpendicular to the fall direction).\",\n      \"validRange\": \"600mm - 2500mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines the coverage width of the sheeting layer. Affects the number of sheets generated.\"\n    },\n    {\n      \"name\": \"dSheetL\",\n      \"technicalDefault\": \"U(1430)\",\n      \"businessMeaning\": \"The length of the sheeting boards (along the fall direction).\",\n      \"validRange\": \"1000mm - 6000mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines how far the sheeting runs along the slope before another sheet starts.\"\n   "
      },
      "tokens_used": 10990,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script initializes and checks for catalog settings matching _kExecuteKey.",
          "2. If _bOnInsert is true (First run):",
          "   a. Check insertCycleCount(). If > 1, erase instance and exit.",
          "   b. If no valid catalog key found, display Properties Dialog.",
          "   c. Prompt user to select Roof Elements (ElementRoof).",
          "   d. Prompt user to select a Start Point for distribution.",
          "   e. Exit and wait for recalculation.",
          "3. Validate that elements are selected. If array is empty, report error and erase instance.",
          "4. Iterate through each selected Element:",
          "   a. Establish Element Coordinate System (CS). Project Start Point to Element plane.",
          "   b. [Zone 1 - Laths]",
          "      i. Erase existing GenBeams assigned to Zone 1.",
          "      ii. Calculate bounding box and align distribution grid to Start Point.",
          "      iii. Loop along Slope Direction (Y): Calculate tapered height based on slope %.",
          "      iv. Create GenBeams at intersection with Zone 1 profile.",
          "   c. [Zone 2 - Sheets]",
          "      i. Erase existing GenBeams assigned to Zone 2.",
          "      ii. Calculate bounding box and align distribution grid.",
          "      iii. Nested Loop: Iterate Rows (Y) then Columns (X).",
          "      iv. Check intersection with Zone 2 profile and minimum dimensions (>10mm).",
          "      v. Create Sheet entity.",
          "      vi. Apply Rotation based on distance from Start Point.",
          "5. Draw Slope Symbol and Text at Start Point."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Return (Stop)"
              ]
            },
            "path2": {
              "name": "Cycle = 1",
              "steps": [
                "Check Catalog Key",
                "Show Dialog (if needed)",
                "Prompt User Input"
              ]
            }
          },
          {
            "condition": "Catalog Key Validity",
            "path1": {
              "name": "Valid Key Found",
              "steps": [
                "Load Properties from Catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "No Valid Key",
              "steps": [
                "Execute showDialog()"
              ]
            }
          },
          {
            "condition": "Sheet Rotation Direction",
            "path1": {
              "name": "Sheet is 'downhill' (Y > Start)",
              "steps": [
                "Calculate Angle",
                "Multiply by -1 (Negative Rotation)",
                "Transform Sheet"
              ]
            },
            "path2": {
              "name": "Sheet is 'uphill' (Y <= Start)",
              "steps": [
                "Calculate Angle",
                "Apply Positive Rotation",
                "Transform Sheet"
              ]
            }
          },
          {
            "condition": "Sheet Validity Check",
            "path1": {
              "name": "Valid Size & Intersection",
              "steps": [
                "Set bCreateSheet = true",
                "Generate Sheet Geometry",
                "Assign Properties"
              ]
            },
            "path2": {
              "name": "Invalid Size or No Intersection",
              "steps": [
                "Set bCreateSheet = false",
                "Skip Sheet Creation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "There are no elements selected.",
            "recovery": "Select appropriate Roof Elements and re-run or modify selection via grips/properties."
          },
          {
            "check": "Zone Geometry Validity",
            "errorMessage": "Invalid zone outline for element [Number].",
            "recovery": "Check if the selected element has valid geometry for the specified zone (1 or 2). Script skips the element."
          },
          {
            "check": "Loop Execution Limit (Infinite Loop)",
            "errorMessage": "Infinite loop detected in [ScriptName].",
            "recovery": "Check Spacing/Sheet Length vs Element Size. A limit of 100 iterations is enforced before breaking."
          },
          {
            "check": "Sheet Size (Minimum Extents)",
            "errorMessage": "(Silent failure)",
            "recovery": "Sheets smaller than 10mm in X or Y direction are automatically ignored to prevent geometry errors."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Distribution Parameters",
            "how": "OPM Properties Palette",
            "effect": "Changing Spacing, Width, Height, or Slope % triggers a full recalculation of laths and sheets."
          },
          {
            "action": "Move Start Point",
            "how": "Grip Edit the Symbol (Start Point)",
            "effect": "Shifts the origin of the lath grid and changes the pivot point for the sheet rotation calculations."
          },
          {
            "action": "Update Roof Geometry",
            "how": "Modify underlying Element Roof",
            "effect": "Script automatically regenerates laths and sheets to fit the new roof profile and openings."
          }
        ]
      },
      "tokens_used": 11388,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-AngleForFlatRoof.mcr\n\n## Overview\nThis script generates tapered laths and tilted sheeting on flat roof elements to create drainage slopes (falls). It is typically used on flat roof constructions where a physical slope is required for water runoff by varying the height of laths and rotating the sheeting boards.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script creates physical GenBeam and Sheet geometry. |\n| Paper Space | No | Not a layout or annotation script. |\n| Shop Drawing | No | Does not generate views or dimensions. |\n\n## Prerequisites\n- **Required Entities**: At least one Roof Element (`ElementRoof`) must exist in the model.\n- **Minimum Beam Count**: N/A (Script generates new laths, does not require existing beams).\n- **Required Settings**: None (Uses internal defaults or OPM properties).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `HSB_R-AngleForFlatRoof.mcr`.\n\n### Step 2: Select Roof Elements\n```\nCommand Line: |Select a set of elements|\nAction: Select the roof elements (ElementRoof) you wish to apply the lathing and sheeting to. Press Enter to confirm selection.\n```\n\n### Step 3: Define Start Point\n```\nCommand Line: |Select start point for distribution|\nAction: Click on the roof surface to define the starting point (usually the highest point) for the lath distribution and slope calculation.\n```\n\n### Step 4: Configure Properties (If Required)\nAction: If no catalog settings are found, a Properties dialog may appear automatically. You can also adjust parameters later via the Properties Palette (OPM).\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Lath distribution** | | | |\n| Spacing | Number | `U(1250)/3` | The distance between the centerlines of the tapered laths. |\n| Beam width | Number | `U(40)` | The width (thickness) of the tapered lath perpendicular to the slope direction. |\n| Maximum beam height | Number | `U(220)` | The height of the lath at the start point. The laths slope down from this height. |\n| Slope [%] | Number | `2` | The pitch or fall angle of the roof expressed as a percentage (e.g., 2%). |\n| **Lath properties** | | | |\n| Lath color | Number | `52` | The CAD display color index for the generated lath beams. |\n| Lath name | String | `\"\"` | The name or designation assigned to the lath entities. |\n| Lath material | String | `\"\"` | The material classification of the laths (e.g., C24). |\n| Lath grade | String | `\"\"` | The strength grade of the timber used for laths. |\n| Lath information | String | `\"\"` | Additional user-defined comments or details. |\n| Lath label | String | `\"\"` | The primary label (mark number) for the laths. |\n| Lath sub label | String | `\"\"` | Secondary label for grouping. |\n| Lath sub label2 | String | `\"\"` | Tertiary label for further classification. |\n| Lath code | String | `\"\"` | The beam code or production code associated with the laths. |\n| **Sheeting** (Inferred) | | | |\n| Sheet Width | Number | `U(1250)` | The width of the sheeting boards (perpendicular to the fall direction). |\n| Sheet Length | Number | `U(1430)` | The length of the sheeting boards (along the fall direction). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Regenerates the laths and sheets based on current property values or geometry changes. |\n| Erase | Removes the script instance and the generated laths/sheets from the model. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies on OPM (Object Properties Model) settings rather than external XML files.\n\n## Tips\n- **Adjusting the Fall**: Modify the **Slope [%]** parameter in the Properties palette to increase or decrease the steepness of the drainage angle.\n- **Moving the High Point**: Use the **Grip** on the start point symbol to move the origin of the lath grid. This shifts where the \"highest\" lath is located.\n- **Performance**: The script automatically ignores sheet sizes smaller than 10mm to prevent geometry errors and maintain performance.\n- **Editing**: If you modify the underlying roof geometry, the script will automatically update the laths and sheets to fit the new profile.\n\n## FAQ\n- **Q: Why are some sheets missing?**\n  A: The script automatically filters out sheets that are smaller than 10mm in width or length to avoid invalid geometry.\n- **Q: How do I change the material for production lists?**\n  A: Update the **Lath material** property in the Properties Palette. This ensures correct data for BIM lists and CAM exports.\n- **Q: The laths are sloping the wrong way.**\n  A: You likely need to move the **Start Point** grip to the opposite side of the roof, or check the orientation of your input elements."
      },
      "tokens_used": 7827,
      "error": null
    }
  }
}