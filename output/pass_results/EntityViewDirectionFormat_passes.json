{
  "filename": "EntityViewDirectionFormat.mcr",
  "status": "completed",
  "total_tokens": 52760,
  "processing_time": 269.5204451084137,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl shows properties by resolving format variables.\nAlthough it is defined to work with any entity type it is mainly targeted for CLT panels. For these it provides two additional format instructions\n@(LoadingInfo)\n    strictly available only for panels with floor/roof association and not being drawn upright liek a wall in model\n    It displays loading info of the panel in dependency of the view direction compared to the most aligned Z-World direction of the panel.\n    If the view direction matches world it shows 'Loading Top Side', else it will display 'Flip for Loading'.\n    One could use alias definitions to alter / abbreviate the string\n @(SurfaceQuality)\n    strictly available if the view direction matches positive or negatrive Z-axis of the panel",
        "versionHistory": [
          {
            "version": "1.4",
            "date": "08.06.2022",
            "author": "Thorsten Huck",
            "changes": "HSB-15678 bugfix offset value"
          },
          {
            "version": "1.3",
            "date": "01.10.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-13291 automatic vertical text placement for any view not being parallel to Z-Direction of a panel will be set to top loading side if main view can be found. Requires usage of new option to select main view in block space. In modelspace this is detected automatically."
          },
          {
            "version": "1.2",
            "date": "30.09.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-13291 Dimstyle property added"
          },
          {
            "version": "1.1",
            "date": "30.09.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-13291 automatic detection of potential main view direction"
          },
          {
            "version": "1.0",
            "date": "28.09.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-13291 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8582,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "The script checks 'Viewport().inLayoutTab()' and 'Viewport().inPaperSpace()'. In '_bOnInsert', it logic splits into two paths: collecting 'ShopDrawView' entities for BlockSpace/PaperSpace usage, or prompting for 'MultiPage' entities for ModelSpace usage. The comment explicitly states: 'The tsl provides two insertion modes: as blockspace TSL to be attached to a shopdrawviewport as model TSL to be attached to a multipage'."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView",
            "MultiPage"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be attached to a ShopDrawView in Layout/PaperSpace or a MultiPage in ModelSpace.",
          "requiredSettings": []
        }
      },
      "tokens_used": 7914,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": \"Standard Properties Dialog\",\n        \"condition\": \"_bOnInsert && _kExecuteKey empty\",\n        \"required\": false\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select main viewport (optional)|\",\n        \"condition\": \"BlockSpace/PaperSpace mode (viewEnts found)\",\n        \"required\": false\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Specify point\",\n        \"condition\": \"BlockSpace/PaperSpace mode\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select multipages|\",\n        \"condition\": \"ModelSpace mode\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Specify point\",\n        \"condition\": \"ModelSpace mode (single multipage selected)\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"PrPoint.goJig\",\n        \"promptOriginal\": \"|Select view|\",\n        \"condition\": \"ModelSpace mode (multiple multipages selected)\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sFormat\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Format|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"|General|\",\n      \"description\": \"|Defines the format to be resolved with properties of the defining entity|\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dTextHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Textheight|\",\n"
      },
      "tokens_used": 10352,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates and positions text labels for CLT panels or other entities in drawings, resolving dynamic properties like loading info and surface quality based on the view direction relative to the panel.",
          "category": "ShopDrawing",
          "typicalUseCase": "Annotating floor or roof CLT panels in production layouts to indicate the 'Loading Top Side', 'Flip for Loading', or specific surface qualities, ensuring the text orientation updates automatically if the view changes."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "",
            "businessMeaning": "Defines the content of the label using format keys (e.g., @(Name), @(Length)). It specifically supports @(LoadingInfo) to show loading side instructions (based on view direction) and @(SurfaceQuality) to display quality grades.",
            "validRange": "Any string containing valid hsbCAD format keys.",
            "unit": "String",
            "affectsOutput": "Determines the textual information displayed. If format keys are invalid or missing, the text may appear blank or show default values."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "75",
            "businessMeaning": "Sets the height of the text annotation on the drawing.",
            "validRange": "2.0 to 500.0 (depending on plot scale and units)",
            "unit": "mm",
            "affectsOutput": "Visual size of the text label. Larger values make the text more readable but may clutter small details."
          },
          {
            "name": "nColor",
            "technicalDefault": "40",
            "businessMeaning": "Sets the AutoCAD color index for the text.",
            "validRange": "0 to 256 (AutoCAD Color Index)",
            "unit": "Index",
            "affectsOutput": "Visual appearance (color) of the text."
          },
          {
            "name": "sHorizontalAlignment",
            "technicalDefault": "|Automatic|",
            "businessMeaning": "Controls the horizontal alignment of the text relative to the insertion point or viewport center. 'Automatic' calculates the best side based on the position relative to the viewport center.",
            "validRange": "|Automatic|, |Left|, |Center|, |Right|",
            "unit": "Enumeration",
            "affectsOutput": "Horizontal positioning of the text block."
          },
          {
            "name": "sVerticalAlignment",
            "technicalDefault": "|Automatic|",
            "businessMeaning": "Controls the vertical alignment of the text. 'Automatic' positions the text to the 'Top' or 'Bottom' relative to the viewport or panel shadow depending on the view orientation and Z-axis alignment.",
            "validRange": "|Automatic|, |Bottom|, |Center|, |Top|",
            "unit": "Enumeration",
            "affectsOutput": "Vertical positioning of the text block. Critical for ensuring loading info labels do not overlap the panel geometry in certain views."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "Sorted list of DimStyles",
            "businessMeaning": "Assigns a specific dimension style to the text, ensuring font and standard compliance with the project drafting settings.",
            "validRange": "Any existing Dimension Style in the current drawing.",
            "unit": "String",
            "affectsOutput": "Font type, text style, and other visual properties defined in the DimStyle."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selection of Entity (ShopDrawView or MultiPage)",
            "effect": "Determines the valid context for resolving @(LoadingInfo) and @(SurfaceQuality) format variables.",
            "cascade": [
              "sFormat"
            ]
          },
          {
            "trigger": "Change of View Direction (Model rotation or Viewport selection)",
            "effect": "Recalculates the output of @(LoadingInfo) (e.g., toggling between 'Loading Top Side' and 'Flip for Loading') and potentially re-aligns text if 'Automatic' alignment is used.",
            "cascade": [
              "sFormat",
              "sHorizontalAlignment",
              "sVerticalAlignment"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation / Text",
            "description": "A text string containing resolved property information, intelligently positioned relative to the selected viewport or entity geometry.",
            "appliedTo": "Model Space (attached to MultiPage) or Paper Space/Block Space (attached to ShopDrawView)."
          }
        ]
      },
      "tokens_used": 9181,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched via command or catalog",
          "[Conditional] Check if _kExecuteKey is set (Catalog usage)",
          "Display standard Properties Dialog (unless silent insert)",
          "Detect current space (BlockSpace/PaperSpace vs ModelSpace)",
          "[Branch] If PaperSpace/BlockSpace: Collect ShopDrawView entities",
          "[Branch] If PaperSpace/BlockSpace: Prompt user for insertion point (getPoint)",
          "[Branch] If PaperSpace/BlockSpace: Optional prompt for 'Main Viewport' (PrEntity)",
          "[Branch] If ModelSpace: Prompt user for MultiPages (PrEntity)",
          "[Branch] If ModelSpace (1 MultiPage): Prompt for insertion point (getPoint)",
          "[Branch] If ModelSpace (>1 MultiPage): Invoke Jig (goJig) to select specific view",
          "Calculate Viewport geometry and Entity transformations",
          "Determine Text Orientation (Reading direction X/Y based on View direction)",
          "[Conditional] Resolve Text String from Format properties",
          "[Conditional] Validate text content (Auto-delete if empty in MultiPage)",
          "Draw Text and display geometry",
          "Store relative location in _Map (if MultiPage)"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution Context (Space)",
            "path1": {
              "name": "PaperSpace / BlockSpace",
              "steps": [
                "Collect ShopDrawView entities in current space",
                "Append the first valid ShopDrawView to _Entity",
                "Request insertion point via getPoint",
                "Optionally allow selection of a second ShopDrawView as 'Main View'",
                "Set bIsSetup flag in _Map"
              ]
            },
            "path2": {
              "name": "ModelSpace",
              "steps": [
                "Prompt user to select MultiPage entities",
                "Filter valid MultiPages into an array",
                "Check count of selected MultiPages"
              ]
            }
          },
          {
            "condition": "ModelSpace MultiPage Selection Count",
            "path1": {
              "name": "Single MultiPage Selected",
              "steps": [
                "Request insertion point via getPoint",
                "Append MultiPage to _Entity"
              ]
            },
            "path2": {
              "name": "Multiple MultiPages Selected",
              "steps": [
                "Generate outlines for all views in the first MultiPage",
                "Invoke 'SelectViewport' Jig to graphically pick a view",
                "Calculate insertion point based on Jig selection",
                "Append MultiPage to _Entity"
              ]
            }
          },
          {
            "condition": "Vertical Alignment Setting",
            "path1": {
              "name": "Automatic (Default)",
              "steps": [
                "Compare insertion point relative to Viewport midpoint",
                "Check if panel shadow area is valid",
                "Determine 'Top' or 'Bottom' loading side based on Z-axis alignment",
                "Snap text position to shadow boundary"
              ]
            },
            "path2": {
              "name": "Fixed (Top/Center/Bottom)",
              "steps": [
                "Use fixed alignment index derived from property",
                "Skip geometric snapping logic"
              ]
            }
          },
          {
            "condition": "Text Resolution Result",
            "path1": {
              "name": "Text Valid",
              "steps": [
                "Proceed to draw text using Display()",
                "Apply color, DimStyle, and Height"
              ]
            },
            "path2": {
              "name": "Text Empty (MultiPage only)",
              "steps": [
                "Report warning message",
                "Execute eraseInstance() to remove script from model"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Cycle Count",
            "errorMessage": "N/A (Silent)",
            "recovery": "Script erases itself if insertCycleCount > 1 to prevent duplicate execution on double-click."
          },
          {
            "check": "Catalog Key Validity",
            "errorMessage": "N/A (Fallback)",
            "recovery": "If _kExecuteKey is not found in the catalog list, the script attempts to load values from 'LastInserted' catalog entry instead."
          },
          {
            "check": "MultiPage Text Generation",
            "errorMessage": "No text found - Tool will be deleted.",
            "recovery": "If format variables resolve to an empty string in ModelSpace, the instance is automatically deleted. User must fix Format properties and re-insert."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Format Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Updates the text string, height, color, or alignment immediately upon recalculation."
          },
          {
            "action": "Add/Remove Format Variables",
            "how": "Right-click Context Menu -> 'Add/Remove Format'",
            "effect": "Opens a command-line interface listing available properties. User can enter an index to toggle its presence in the Format string, updating the display."
          },
          {
            "action": "Move Insertion Point",
            "how": "Grip Edit / Point Move",
            "effect": "Updates _Pt0. Script recalculates relative position to the MultiPage or Viewport and redraws the text."
          }
        ]
      },
      "tokens_used": 10373,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# EntityViewDirectionFormat.mcr\n\n## Overview\nThis script automatically generates and positions text labels for CLT panels (or other entities) in drawings. It resolves dynamic format strings to display properties like \"Loading Top Side\" or \"Surface Quality,\" intelligently adjusting the text content and position based on the view direction relative to the panel.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Attaches to MultiPage entities. Auto-deletes if text resolves to empty. |\n| Paper Space | Yes | Attaches to ShopDrawView entities (Layouts). |\n| Shop Drawing | Yes | Specifically designed for shop drawing annotations. |\n\n## Prerequisites\n- **Required Entities:**\n  - **Paper Space:** A `ShopDrawView` entity (Viewport) must be present.\n  - **Model Space:** A `MultiPage` entity must be selected.\n- **Minimum Beam Count:** 0 (This script works on entities/panels, not beams).\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `EntityViewDirectionFormat.mcr` from the list.\n\n### Step 2: Configure Properties (Optional)\nUpon insertion, the Properties Palette may appear. You can accept defaults or set the **Format**, **Text Height**, or **Color** now.\n\n### Step 3: Select Context\nThe script prompts differ based on your current space:\n\n**In Paper Space / Layout Tab:**\n```\nCommand Line: Select main viewport (optional)\nAction: Click on a viewport to define the \"main\" view, or press Enter to skip.\n```\n```\nCommand Line: Specify point\nAction: Click where you want the text label to appear within the viewport.\n```\n\n**In Model Space:**\n```\nCommand Line: Select multipages\nAction: Select one or more MultiPage entities from the drawing and press Enter.\n```\n\n*If multiple MultiPages were selected:*\n```\nCommand Line: Select view\nAction: Use the mouse (Jig) to hover over and select the specific view representation you want to annotate.\n```\n\n```\nCommand Line: Specify point\nAction: Click to place the text in the selected view.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Format** | String | `\"\"` | Defines the text content using hsbCAD keys. Supports standard keys (e.g., `@(Name)`) and special keys: `@(LoadingInfo)` (shows \"Loading Top Side\" or \"Flip for Loading\") and `@(SurfaceQuality)`. |\n| **Textheight** | Double | `75` | Sets the height of the text annotation (in current drawing units). |\n| **Color** | Integer | `40` | Sets the AutoCAD color index (0-256) for the text. |\n| **Horizontal Alignment** | String | `Automatic` | Controls horizontal text placement. Options: Automatic, Left, Center, Right. \"Automatic\" calculates the best side based on the viewport center. |\n| **Vertical Alignment** | String | `Automatic` | Controls vertical text placement. Options: Automatic, Bottom, Center, Top. \"Automatic\" positions text relative to the panel shadow or loading side. |\n| **DimStyle** | String | *Sorted List* | Selects the Dimension Style to apply (controls font, text style, etc.). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Add/Remove Format** | Opens a command-line list of available properties. Type the index number to add or remove that property from the Format string. |\n\n## Settings Files\n- **Filename:** N/A\n- **Location:** N/A\n- **Purpose:** This script does not rely on external settings files.\n\n## Tips\n- **CLT Panels:** Use the key `@(LoadingInfo)` in the Format property. It will automatically check if you are looking at the top or bottom of the panel and tell you if it needs to be flipped.\n- **Automatic Alignment:** Keep Horizontal and Vertical Alignment set to \"Automatic\" to let the script snap the text to the clearest area near the panel or viewport center.\n- **Editing Text:** Double-click the text or use the Properties Palette to change the `sFormat` string. You can combine multiple keys, e.g., `@(Name) - @(LoadingInfo)`.\n\n## FAQ\n- **Q: Why did my text disappear immediately after inserting it in Model Space?**\n- **A:** The script automatically erases itself if the Format string resolves to an empty text string. Check your `sFormat` property and ensure the selected entity actually has the properties you are requesting.\n- **Q: The \"Surface Quality\" text isn't showing up.**\n- **A:** The `@(SurfaceQuality)` key only works if the view direction matches the positive or negative Z-axis of the panel. If viewing from an isometric angle, this data may be suppressed.\n- **Q: What does \"Flip for Loading\" mean?**\n- **A:** When using `@(LoadingInfo)`, the script compares your view direction to the panel's \"World\" Z direction. If you are looking at the back side (or a non-standard orientation for a floor/roof), it prompts you to flip the element to ensure the correct loading side is face up."
      },
      "tokens_used": 6358,
      "error": null
    }
  }
}