{
  "filename": "HSB_E-RecalculateSheetOrientation.mcr",
  "status": "completed",
  "total_tokens": 38644,
  "processing_time": 313.0884675979614,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7456,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit use of '_kModelSpace' in dbCreate calls. Direct manipulation of 'Sheet' entities (sh.setXAxisDirectionInXYPlane) based on geometry. Absence of ShopDrawing specific tokens (sd_, _Viewport, Drawing)."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sheet",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 4718,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select a set of elements",
              "condition": "_bOnInsert && nSelectionMode == 0",
              "required": true
            },
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select a set of sheets",
              "condition": "_bOnInsert && nSelectionMode == 1",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 2,
            "variable": "sSeparator01",
            "type": "PropString",
            "displayName": "Filter",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sMaterial",
            "type": "PropString",
            "displayName": "    Material to recalculate",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Leave this filter empty if all selected sheets must be analysed."
          },
          {
            "index": 0,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "    Zone to recalculate",
            "defaultValue": "-100",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "Leave this filter -100 if all selected sheets must be analysed."
          },
          {
            "index": 3,
            "variable": "sSeparator02",
            "type": "PropString",
            "displayName": "Selection",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sSelectionMode",
            "type": "PropString",
            "displayName": "    Selection mode",
            "defaultValue": "Elements",
            "inputType": "dropdown",
            "options": [
              "Elements",
              "Sheets"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6801,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically optimizes the orientation (X and Y axis) of sheeting materials to align with the longest edge of their outline, minimizing bounding box area.",
          "category": "Optimization",
          "typicalUseCase": "Used after generating floor or wall sheeting to ensure panels are oriented efficiently, typically so the sheet 'length' runs along the longest physical edge of the panel."
        },
        "parameters": [
          {
            "name": "sMaterial",
            "technicalDefault": "",
            "businessMeaning": "A filter to specify which material type (e.g., OSB, Plywood) should be processed. Only sheets with this exact material name will be analyzed and re-oriented.",
            "validRange": "Any valid material string from the hsbCAD catalog (e.g., 'OSB18', 'PLY22'). Empty string processes all materials.",
            "unit": "String",
            "affectsOutput": "Determines which subset of sheets are candidates for rotation. If non-empty, sheets of other materials are ignored even if selected."
          },
          {
            "name": "nZone",
            "technicalDefault": "-100",
            "businessMeaning": "A filter to restrict processing to sheets assigned to a specific construction zone or floor level.",
            "validRange": "-100 (All Zones) or any positive integer representing a specific zone index.",
            "unit": "Integer",
            "affectsOutput": "Limits the optimization to sheets belonging to the defined zone index. -100 ensures the filter is inactive."
          },
          {
            "name": "sSelectionMode",
            "technicalDefault": "Elements",
            "businessMeaning": "Defines the target of the manual selection process: whether the user selects the structural elements (Walls/Floors) or the individual Sheet entities.",
            "validRange": "Elements, Sheets",
            "unit": "Enum",
            "affectsOutput": "Controls the command-line prompt and the scope of the selection. 'Elements' aggregates all sheets within the selected elements, while 'Sheets' processes only exactly what is clicked."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sSelectionMode changes",
            "effect": "Alters the command line prompt from 'Select a set of elements' to 'Select a set of sheets'.",
            "cascade": [
              "_Element",
              "_Sheet"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Sheet Orientation",
            "description": "The local coordinate system of the sheet is updated. The X-axis is rotated to align with the longest edge of the sheet's outline, provided it reduces the bounding box area.",
            "appliedTo": "Sheets associated with selected Elements (if Mode=Elements) or directly selected Sheets (if Mode=Sheets), respecting the Material and Zone filters."
          }
        ]
      },
      "tokens_used": 5400,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Start / Initialization",
          "[Check: Is _bOnInsert?]",
          "[Yes] -> [Check: insertCycleCount > 1?] -> [Yes: EraseInstance and Return]",
          "[Yes] -> [Check: _kExecuteKey == \"\"?] -> [Yes: Show Dialog]",
          "[Yes] -> [Check: sSelectionMode?]",
          "[Mode: Elements] -> Prompt: Select Elements",
          "[Mode: Elements] -> [Loop Selected Elements] -> Remove existing TSL instances of same script",
          "[Mode: Elements] -> Create new 'Satellite' script instances attached to selected Elements",
          "[Mode: Elements] -> Erase Master Instance and Return",
          "[Mode: Sheets] -> Prompt: Select Sheets",
          "[Mode: Sheets] -> Set Map Flag 'ManualInserted'",
          "[No] -> [Check: Map contains 'MasterToSatellite'?] -> [Yes: Load Properties from Catalog, Remove Map Flag]",
          "[No] -> [Check: Map contains 'ManualInserted'?] -> [Yes: Load Flag, Remove Map Flag]",
          "[No] -> Determine Sheet Source (Element Sheets vs Direct Sheet Selection)",
          "[No] -> [Check: Element exists?] -> [Yes: Get Sheets from Element[0]]",
          "[No] -> [Else: Check Sheet Set] -> [Yes: Use _Sheet set]",
          "[No] -> [Else: No input] -> EraseInstance and Return",
          "Execution Phase (Triggered by _bOnElementConstructed or manual flag)",
          "[Loop: For each Sheet in Collection]",
          "[Filter 1] -> Check Material (Skip if sMaterial set and doesn't match)",
          "[Filter 2] -> Check Zone (Skip if nZone != -100 and doesn't match)",
          "Calculate Solid Dimensions (Length, Width, Height)",
          "Extract Outline Geometry (RealBody, PlaneProfile, Rings)",
          "Isolate Envelope PLine (Skip Openings)",
          "[Analysis Loop: For each Edge Segment in Outline]",
          "Calculate potential X-Axis (Edge Vector) and Y-Axis (Cross Product with Sheet Z)",
          "Project Vertices onto new X/Y Axes",
          "Calculate Bounding Box Area for this orientation",
          "Store Candidate (Area, Segment Length, Vector X)",
          "[Post-Loop Analysis]",
          "Sort Candidates by Segment Length (Longest First)",
          "Sort Candidates by Area (Smallest First)",
          "[Special Case: 3 Edges?] -> Ensure orthogonal corner is preferred as origin",
          "Select Best Candidate (vxNew[0])",
          "[Validation] -> Is Sheet Geometry Valid? (vxNew.length < 1) -> Report Message, Skip",
          "[Validation] -> Is New Direction different from Current? (Dot Product Check) -> Skip if aligned",
          "Apply New Orientation: sh.setXAxisDirectionInXYPlane()",
          "End Loop",
          "Erase Script Instance",
          "End"
        ],
        "conditionalBranches": [
          {
            "condition": "Selection Mode (sSelectionMode) during Insert",
            "path1": {
              "name": "Select Elements",
              "steps": [
                "Prompt user to select Elements",
                "For each Element, erase existing 'HSB_E-RecalculateSheetOrientation' TSLs",
                "Create new 'Satellite' TSL instance on each Element",
                "Erase the 'Master' TSL instance immediately"
              ]
            },
            "path2": {
              "name": "Select Sheets",
              "steps": [
                "Prompt user to select Sheets directly",
                "Set 'ManualInserted' flag in internal Map",
                "Proceed to processing the selected Sheet set"
              ]
            }
          },
          {
            "condition": "Source of Geometry during Execution",
            "path1": {
              "name": "Attached to Element",
              "steps": [
                "Read _Element[0]",
                "Retrieve all Sheets contained within that Element",
                "Process all found Sheets"
              ]
            },
            "path2": {
              "name": "Direct Sheet Selection",
              "steps": [
                "Read _Sheet set",
                "Process exactly those Sheets selected by user"
              ]
            }
          },
          {
            "condition": "Number of Edges in Sheet Outline (during optimization)",
            "path1": {
              "name": "Triangular Sheet (3 Edges)",
              "steps": [
                "Calculate dot products of the 3 edge vectors",
                "If any pair is orthogonal (approx 90 deg), prioritize that alignment",
                "Swap vectors in candidate list if necessary to align with right angle"
              ]
            },
            "path2": {
              "name": "Polygonal Sheet (4+ Edges)",
              "steps": [
                "Proceed with standard Area/Length sorting",
                "No special orthogonal check performed"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Geometric Analyzability",
            "errorMessage": "Sheet: [PosNum] could not be analysed",
            "recovery": "Script skips this specific sheet and continues to the next in the list. Usually caused by corrupted geometry or zero-area outlines.",
            "trigger": "if (vxNew.length() < 1)"
          },
          {
            "check": "Material Filter Match",
            "errorMessage": "None (Silent Skip)",
            "recovery": "Ensure 'Material to recalculate' property matches the sheet material name exactly, or leave it empty.",
            "trigger": "if( sMaterial != \"\" && sh.material() != sMaterial )"
          },
          {
            "check": "Zone Filter Match",
            "errorMessage": "None (Silent Skip)",
            "recovery": "Ensure 'Zone to recalculate' is -100 (All) or matches the sheet's assigned zone index.",
            "trigger": "if (nZone != -100 && sh.myZoneIndex() != nZone)"
          },
          {
            "check": "Orientation Change Necessity",
            "errorMessage": "None (Silent Skip)",
            "recovery": "The calculated optimal orientation is already the current orientation. No action taken.",
            "trigger": "if (abs(vxSh.dotProduct(vxNew[0])) > 1 - dEps)"
          },
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Auto-Exit)",
            "recovery": "N/A (Internal System Check)",
            "trigger": "if( insertCycleCount()>1 )"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Run Optimization Again",
            "how": "Right-click context menu (addRecalcTrigger - though code shows immediate execution on construct, context menus are typically available for TSLs)",
            "effect": "Re-runs the geometric analysis based on current property filters (Material/Zone)."
          },
          {
            "action": "Change Material Filter",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Next time the script runs (or if manually triggered), only sheets of the new material will be processed."
          },
          {
            "action": "Change Zone Filter",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Restricts processing to a specific floor/zone index during the next run."
          },
          {
            "action": "Modify Selection Mode",
            "how": "AutoCAD Properties Palette (OPM) - Requires re-insertion of the script to take full effect on prompts",
            "effect": "Switches between selecting structural elements vs individual sheets for future insertions."
          }
        ]
      },
      "tokens_used": 7985,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-RecalculateSheetOrientation\n\n## Overview\nThis script automatically optimizes the orientation of sheeting materials (like OSB or Plywood) within your model. It analyzes the geometry of selected sheets and rotates them so the X-axis aligns with the longest edge, optimizing the bounding box area.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This is the primary environment for running the script. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | Not intended for 2D drawing generation. |\n\n## Prerequisites\n- **Required Entities**: Existing Sheets (either individually or contained within Wall/Floor Elements).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n```\nCommand: TSLINSERT\nAction: Select the file 'HSB_E-RecalculateSheetOrientation.mcr' from the file dialog.\n```\n\n### Step 2: Configure Filters\nOnce inserted, the **Properties Palette** (OPM) will display the script settings. Adjust these before proceeding to selection.\n- **Selection mode**: Choose whether to select structural Elements (Walls/Floors) or individual Sheets.\n- **Material to recalculate**: (Optional) Type a specific material name (e.g., \"OSB18\") to only process that material. Leave empty to process all.\n- **Zone to recalculate**: (Optional) Set a specific zone index number. Keep as `-100` to process all zones.\n\n### Step 3: Select Entities\nThe command line prompt will change based on your \"Selection mode\" setting:\n\n**If Mode = Elements:**\n```\nCommand Line: Select a set of elements\nAction: Click on the Wall or Floor elements that contain the sheeting you want to optimize. Press Enter to confirm.\n```\n*Note: The script will automatically attach itself to these elements, process all internal sheets, and then self-delete.*\n\n**If Mode = Sheets:**\n```\nCommand Line: Select a set of sheets\nAction: Click directly on the specific sheet entities in the model. Press Enter to confirm.\n```\n\n### Step 4: Execution\n- The script will iterate through the sheets, applying the Material and Zone filters.\n- It calculates the optimal rotation for each valid sheet.\n- The sheet local coordinate system is updated.\n- The script instance erases itself automatically from the drawing once processing is complete.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Filter** | Group | - | Visual separator for filter settings. |\n| Material to recalculate | Text | Empty | Enter a material name to filter which sheets are processed (e.g., \"PLY22\"). If left empty, all materials are included. |\n| Zone to recalculate | Integer | -100 | Enter a specific zone index to process only sheets in that zone. Use `-100` to ignore zone filtering. |\n| **Selection** | Group | - | Visual separator for selection settings. |\n| Selection mode | Dropdown | Elements | Choose how you select objects in the model.<br>**Elements**: Select Walls/Floors (processes all sheets inside them).<br>**Sheets**: Select individual sheet entities. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Re-runs the optimization logic based on the currently selected sheets and property settings. (Note: This script is designed to erase itself after running, so this option is primarily relevant if the script is interrupted or attached as a satellite). |\n\n## Settings Files\n- None required.\n\n## Tips\n- **Bulk Processing**: Use the **Elements** selection mode to quickly optimize all sheathing on an entire floor or wall assembly without picking every single panel.\n- **Targeted Fixes**: If you only need to fix specific rotated panels, switch to **Sheets** mode and select only the problematic panels.\n- **Triangle Handling**: The script includes special logic to detect right-angled corners on triangular sheets to ensure logical orientation.\n- **Cleanup**: Don't worry if the script \"disappears\" after you run it; this is intended behavior to keep your drawing clean.\n\n## FAQ\n- **Q: Why didn't my sheet rotate?**\n  - **A**: Check your **Material** and **Zone** filters. If a sheet does not match the specific material name or zone index entered in the properties, it will be skipped silently.\n- **Q: Can I undo the changes?**\n  - **A**: Yes, use the standard AutoCAD `UNDO` command immediately after running the script if you are unhappy with the new orientations.\n- **Q: The script reported an error \"Sheet could not be analysed\".**\n  - **A**: This indicates the sheet geometry is invalid or has zero area. You may need to check the source element or redraw the sheet manually."
      },
      "tokens_used": 6284,
      "error": null
    }
  }
}