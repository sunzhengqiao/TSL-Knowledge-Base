{
  "filename": "hsbTenonOnBeamcut.mcr",
  "status": "completed",
  "total_tokens": 47401,
  "processing_time": 286.3673520088196,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8505,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script performs 3D solid operations (Body intersectWith, addTool Mortise/Cut) on Beam objects. No ShopDrawing (sd_) or Paper Space (_Viewport) logic, prefixes, or entity types found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "ModelSpace",
          "requiredSettings": []
        }
      },
      "tokens_used": 5531,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "ShowDialog",
              "promptOriginal": "showDialog",
              "condition": "_bOnInsert && _kExecuteKey == \"\"",
              "required": false
            },
            {
              "step": 2,
              "function": "getGenBeam",
              "promptOriginal": "|Select male beam(s)|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getGenBeam",
              "promptOriginal": "|Select female beam(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "On Insert (if not run from catalog)",
            "title": null,
            "dataSource": "TSL Properties (PropDouble/PropString)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "|Width|",
            "defaultValue": "U(40)",
            "inputType": "number",
            "options": [],
            "category": "|Geometry|",
            "description": "|Defines the Width|"
          },
          {
            "index": 1,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "|Depth|",
            "defaultValue": "U(50)",
            "inputType": "number",
            "options": [],
            "category": "|Geometry|",
            "description": "|Defines the Depth|"
          },
          {
            "index": 1,
            "variable": "sShape",
            "type": "PropString",
            "displayName": "|Shape|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|Rectangular|",
              "|Round|",
              "|Rounded|"
            ],
            "category": "|Geometry|",
            "description": "|Defines the Shape|"
          },
          {
            "index": 2,
            "variable": "dOff1",
            "type": "PropDouble",
            "displayName": "|Offset| 1",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Alignment|",
            "description": "|Defines the Off1|"
          },
          {
            "index": 3,
            "variable": "dOff2",
            "type": "PropDouble",
            "displayName": "|Offset| 2",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Alignment|",
            "description": "|Defines the Off2|"
          },
          {
            "index": 5,
            "variable": "dOffsetAxis",
            "type": "PropDouble",
            "displayName": "|Offset from axis|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Alignment|",
            "description": "|Defines the OffsetAxis|"
          },
          {
            "index": 0,
            "variable": "sOrientation",
            "type": "PropString",
            "displayName": "|Orientation|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|Parallel female beam|",
              "|Perpendicular female beam|",
              "|Parallel with projected Z-axis of tenon beam|",
              "|Perpedicular to projected Z-axis of tenon beam|"
            ],
            "category": "|Alignment|",
            "description": "|Defines the Orientation|"
          },
          {
            "index": 7,
            "variable": "dToleranceLengthLeft",
            "type": "PropDouble",
            "displayName": "|Tolerance length left|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Tolerances|",
            "description": "|Defines the Tolerance on left side|"
          },
          {
            "index": 8,
            "variable": "dToleranceLengthRight",
            "type": "PropDouble",
            "displayName": "|Tolerance length right|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Tolerances|",
            "description": "|Defines the Tolerance on right side|"
          },
          {
            "index": 4,
            "variable": "dGap",
            "type": "PropDouble",
            "displayName": "|Tolerance depth|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Tolerances|",
            "description": "|Defines the Gap|"
          },
          {
            "index": 6,
            "variable": "dGapLength",
            "type": "PropDouble",
            "displayName": "|Gap on Length|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Tolerances|",
            "description": "|Defines the Gap on length|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8512,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automatically generates a tenon and mortise connection between two beams (Male and Female), calculating the intersection geometry based on the solid bodies. It is specifically designed to handle complex intersections like cuts on hip rafters or half-logs where standard centerline logic fails.\",\n    \"category\": \"Joinery/Carpentry\",\n    \"typicalUseCase\": \"Creating T-connections between wall plates and joists, posts and beams, or joining hip rafters where the intersection face is not perpendicular to the beam axis.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dWidth\",\n      \"technicalDefault\": \"U(40)\",\n      \"businessMeaning\": \"The width (thickness) of the tenon cheek. Typically a fraction of the male beam's width.\",\n      \"validRange\": \"20 - 150\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Modifies the width of the tenon on the male beam and the width of the slot on the female beam.\"\n    },\n    {\n      \"name\": \"dDepth\",\n      \"technicalDefault\": \"U(50)\",\n      \"businessMeaning\": \"The length of the tenon (how far it penetrates into the female beam).\",\n      \"validRange\": \"20 - "
      },
      "tokens_used": 9944,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch: Initiated via command line or catalog insertion",
          "Insertion Check (_bOnInsert): True",
          "Cycle Guard: If insertCycleCount > 1, erase instance and exit to prevent recursion",
          "Catalog Check: If _kExecuteKey is empty, ShowDynamicDialog(); else setPropValuesFromCatalog()",
          "User Input 1: Select Male beam(s) (beam set bm)",
          "User Input 2: Select Female beam(s) (beam set bmFemale)",
          "Filtering Logic: Iterate through Male beams",
          "T-Connection Check: Filter Female beams using filterBeamsTConnection()",
          "Batch Processing: For every valid pair, create a new TSL instance (dbCreate)",
          "Cleanup: Erase the original temporary instance",
          "Execution Phase (_bOnInsert = False): New instance starts",
          "Beam Validation: If _Beam.length() < 2, report error and erase",
          "Property Initialization: Map OPM properties to local variables (Width, Depth, Shape, Orientation, Offsets, Tolerances)",
          "Coordinate Calculation: Determine local vectors (vx, vy, vz) based on selected Orientation",
          "Solid Intersection: Create intersection body (bdInt) between Male envelope and Female real body",
          "Cut Analysis (HSB-9074): Check for cuts perpendicular to Male beam axis on Female beam",
          "Reference Point Calc: Determine ptRef based on intersection geometry or cut plane",
          "Apply Male Tools: Add Cut (stretch) and Mortise to Male beam",
          "Apply Female Tools: Add Mortise (slot) to Female beam with tolerances",
          "Visualization: Draw result ppTool"
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Check cycle count",
                "Show/Load Dialog",
                "Select Beams",
                "Filter/Generate Instances",
                "Erase Self"
              ]
            },
            "path2": {
              "name": "Calculation Mode",
              "steps": [
                "Validate Inputs",
                "Compute Geometry",
                "Modify Solids",
                "Update Preview"
              ]
            }
          },
          {
            "condition": "Beam Selection Validation",
            "path1": {
              "name": "Valid Selection (>=2 Beams)",
              "steps": [
                "Proceed to coordinate calculation",
                "Generate joinery"
              ]
            },
            "path2": {
              "name": "Invalid Selection (<2 Beams)",
              "steps": [
                "Report Error: 'This tool requires at least two beams.'",
                "Erase Instance",
                "Stop Execution"
              ]
            }
          },
          {
            "condition": "sOrientation Property Value",
            "path1": {
              "name": "Parallel female beam",
              "steps": [
                "Standard vector calculation"
              ]
            },
            "path2": {
              "name": "Perpendicular female beam",
              "steps": [
                "Swap vz and vy vectors"
              ]
            },
            "path3": {
              "name": "Parallel with projected Z-axis",
              "steps": [
                "Project vz onto Male beam's D-direction",
                "Recalculate vy"
              ]
            },
            "path4": {
              "name": "Perpendicular to projected Z-axis",
              "steps": [
                "Project vy onto Male beam's D-direction",
                "Invert and recalculate vz"
              ]
            }
          },
          {
            "condition": "Geometry Validity (dLength, dWidth, dDepth)",
            "path1": {
              "name": "Positive Dimensions",
              "steps": [
                "Create Cut and Mortise tools",
                "Apply to beams"
              ]
            },
            "path2": {
              "name": "Non-Positive Dimensions",
              "steps": [
                "Skip tool creation",
                "Display shadow profile only (or blank)"
              ]
            }
          },
          {
            "condition": "Cut Detection (HSB-9074)",
            "path1": {
              "name": "Relevant Cut Found",
              "steps": [
                "Align tenon X-axis to cut normal",
                "Calculate reference point from cut plane"
              ]
            },
            "path2": {
              "name": "No Cut Found",
              "steps": [
                "Use intersection shadow profile",
                "Calculate reference point from centroid/extent"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Input Beam Count",
            "errorMessage": "This tool requires at least two beams.",
            "recovery": "Ensure the script instance is linked to 2 beams (1 Male, 1 Female) before execution."
          },
          {
            "check": "T-Connection Logic",
            "errorMessage": "(Implicit failure - no instance created)",
            "recovery": "During insertion, ensure selected Female beams actually intersect the Male beam body within the 500mm tolerance."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Dimensions",
            "how": "OPM Properties Palette",
            "effect": "Changing Width/Depth/Shape updates the Male tenon and Female slot geometry immediately."
          },
          {
            "action": "Adjust Offsets",
            "how": "OPM Properties Palette (Offset 1/2, Offset from axis)",
            "effect": "Slides the tenon laterally or vertically along the intersection face."
          },
          {
            "action": "Change Orientation",
            "how": "OPM Properties (Orientation dropdown)",
            "effect": "Rotates the tenon profile relative to the beams (e.g., from Parallel to Perpendicular)."
          },
          {
            "action": "Apply Tolerances",
            "how": "OPM Properties (Gap, Tolerance lengths)",
            "effect": "Adds clearance to the slot dimensions without altering the nominal tenon size."
          },
          {
            "action": "Move Beams",
            "how": "CAD Grips/Move Commands",
            "effect": "Script recalculates intersection (bdInt) and repositions tools to match the new beam locations."
          }
        ]
      },
      "tokens_used": 8939,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbTenonOnBeamcut.mcr\n\n## Overview\nAutomatically generates a tenon (male) and mortise (female) connection between two beams using solid intersection logic. This script is particularly useful for complex intersections, such as cuts on hip rafters or half-logs, where standard centerline calculations may fail.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script performs 3D solid operations on beams. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Does not generate 2D views or labels. |\n\n## Prerequisites\n- **Required Entities**: At least 2 Beams (GenBeam).\n- **Minimum Beam Count**: 2 (One male, one female).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `hsbTenonOnBeamcut.mcr`.\n\n### Step 2: Configure Parameters (Optional)\nDialog: Dynamic Properties Dialog\nAction: Adjust default values for Width, Depth, and Orientation before selecting beams if desired. You can also change these later in the Properties Palette.\n\n### Step 3: Select Male Beam(s)\n```\nCommand Line: Select male beam(s)\nAction: Click on the beam(s) that will have the tenon (protrusion) created.\n```\n\n### Step 4: Select Female Beam(s)\n```\nCommand Line: Select female beam(s)\nAction: Click on the beam(s) that will have the mortise (slot/recess) cut into it.\n```\n\n### Step 5: Finish Selection\nAction: Press `Enter` or `Right-click` to confirm selection. The script will automatically detect intersections and create the joinery.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Width** | Number | 40 | Defines the width (thickness) of the tenon cheek. |\n| **Depth** | Number | 50 | Defines the length of the tenon (how far it penetrates into the female beam). |\n| **Shape** | Dropdown | Rectangular | Sets the profile shape of the tenon. Options: Rectangular, Round, Rounded. |\n| **Offset 1** | Number | 0 | Aligns the tenon laterally along the primary axis of the intersection. |\n| **Offset 2** | Number | 0 | Aligns the tenon laterally along the secondary axis. |\n| **Offset from axis** | Number | 0 | Shifts the tenon position relative to the beam's centerline axis. |\n| **Orientation** | Dropdown | Parallel female beam | Determines how the tenon is rotated relative to the beams. Options: Parallel female beam, Perpendicular female beam, Parallel with projected Z-axis of tenon beam, Perpendicular to projected Z-axis of tenon beam. |\n| **Tolerance length left** | Number | 0 | Adds clearance to the left side of the mortise slot. |\n| **Tolerance length right** | Number | 0 | Adds clearance to the right side of the mortise slot. |\n| **Tolerance depth** | Number | 0 | Adds clearance (gap) to the depth of the mortise slot. |\n| **Gap on Length** | Number | 0 | Adds an additional gap along the length of the connection. |\n\n## Right-Click Menu Options\nNo specific context menu options are added by this script. Standard hsbCAD element options apply.\n\n## Settings Files\nNo external settings files are required for this script.\n\n## Tips\n- **Complex Geometry**: This script calculates the connection based on the actual 3D solid bodies of the beams. If your beams are already cut (e.g., hip rafters with purlin cuts), this script will align the tenon to the cut face automatically.\n- **Adjusting Orientation**: If the tenon appears rotated 90 degrees incorrectly, use the **Orientation** dropdown in the Properties Palette to switch between Parallel and Perpendicular modes.\n- **Moving Beams**: You can move the beams after insertion using AutoCAD grips or move commands. The script will detect the change and recalculate the intersection geometry automatically.\n- **Batch Processing**: You can select multiple male beams and multiple female beams during the insertion prompts. The script will attempt to find valid T-connections between all selected pairs.\n\n## FAQ\n- **Q: The script ran, but no tenon appeared.**\n- **A: Ensure the beams physically touch or overlap in 3D space. This script relies on solid body intersections; if there is a gap between the beams, no tool is generated.\n- **Q: Can I use this for curved beams?**\n- **A: Yes, provided the solid bodies of the beams intersect.\n- **Q: How do I make the slot looser?**\n- **A: Increase the **Tolerance depth** or **Tolerance length** properties in the Properties Palette. This increases the size of the female slot without changing the male tenon size."
      },
      "tokens_used": 5970,
      "error": null
    }
  }
}