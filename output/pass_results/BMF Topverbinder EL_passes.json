{
  "filename": "BMF Topverbinder EL.mcr",
  "status": "completed",
  "total_tokens": 47466,
  "processing_time": 424.6051940917969,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6060,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script constructs 3D geometry (Body, Drill, Cut), modifies beam geometry using bm.addTool(), and creates Hardware objects. It lacks 'sd_' prefix, _Viewport usage, and _Entity array handling characteristic of ShopDrawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 5811,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getBeam\",\n        \"promptOriginal\": \"Select first beam\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getBeam\",\n        \"promptOriginal\": \"Select second beam\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"BMF Topverbinder EL\",\n      \"defaultValue\": \"30/BMF-Nr:348030\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"30/BMF-Nr:348030\",\n        \"40  BMF-Nr:348040\",\n        \"60  BMF-Nr:348060\",\n        \"80  BMF-Nr:348080\",\n        \"100 BMF-Nr:348100\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sConType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Connection Type\",\n      \"defaultValue\": \"Milled in female beam\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Milled in female beam\",\n        \"Milled in male beam\",\n        \"visible gap\",\n        \"concrete\",\n        \"Steel\",\n        \"Element\",\n        \"L-bearing\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sHWType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"HW Type\",\n      \"defaultValue\": \"Screw\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sHWDesc\",\n      \"type\": \"PropString\",\n      \"displayName\": \"HW Description\",\n      \"defaultValue\": \"ABC Spax\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sHWModel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"HW Model\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sHWMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"HW Material\",\n      \"defaultValue\": \"Aluminium\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sHWNotes\",\n      \"type\": \"PropString\",\n      \"displayName\": \"HW Notes\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"dHWLength\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"HW Length\",\n      \"defaultValue\": \"70\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category"
      },
      "tokens_used": 9082,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a steel top-connector plate (BMF type) with variable geometry to join two beams in T- or L-configurations, including automatic milling for recessed connections and integration with wall Elements.",
          "category": "Connection/Hardware",
          "typicalUseCase": "Connecting a perpendicular joist/rafter to a main beam or wall plate using a specific BMF steel bracket, where the joint might be recessed (milled) or surface-mounted."
        },
        "parameters": [
          {
            "name": "sType",
            "technicalDefault": "\"30/BMF-Nr:348030\"",
            "businessMeaning": "Selects the specific BMF connector model/size, defining the plate width and associated pre-drilling pattern.",
            "validRange": "30, 40, 60, 80, 100 (Corresponds to BMF part numbers 348030-348100)",
            "unit": "mm (Plate Width)",
            "affectsOutput": "Changes the width of the steel plate, the number of pre-drilled holes, and the minimum required beam depth."
          },
          {
            "name": "sConType",
            "technicalDefault": "\"Milled in female beam\"",
            "businessMeaning": "Defines the structural configuration and how the plate interacts with the timber (e.g., fully recessed, visible, or attached to a wall element).",
            "validRange": "Milled in female beam, Milled in male beam, visible gap, concrete, Steel, Element, L-bearing",
            "unit": "Enumeration",
            "affectsOutput": "Switches logic between creating deep milling slots (House), simple cuts, or handling Element/Sheet intersections. Controls which beam receives the cut vs. the slot."
          },
          {
            "name": "dOffsetV",
            "technicalDefault": "0",
            "businessMeaning": "Vertical adjustment for the connection height (primarily for L-bearing configurations where beams are not coplanar).",
            "validRange": "± Beam Height",
            "unit": "mm",
            "affectsOutput": "Shifts the steel plate and associated machining vertically along the secondary beam's axis."
          },
          {
            "name": "dOffsetH",
            "technicalDefault": "0",
            "businessMeaning": "Horizontal adjustment to shift the connection point along the main beam axis.",
            "validRange": "± Beam Length",
            "unit": "mm",
            "affectsOutput": "Moves the intersection point and all associated geometry along the primary beam's length."
          },
          {
            "name": "dAddWidth",
            "technicalDefault": "2",
            "businessMeaning": "Tolerance allowance added to the width of the milled slot to ensure easy fit of the steel plate.",
            "validRange": "0 - 5",
            "unit": "mm",
            "affectsOutput": "Widens the milling slot (House) relative to the steel plate width."
          },
          {
            "name": "dAddDepth",
            "technicalDefault": "5",
            "businessMeaning": "Additional length added to the milled slot beyond the plate's vertical height.",
            "validRange": "0 - 20",
            "unit": "mm",
            "affectsOutput": "Lengthens the milling operation in the beam's longitudinal direction."
          },
          {
            "name": "sHWType",
            "technicalDefault": "\"Screw\"",
            "businessMeaning": "Category of the fastener used for production listings.",
            "validRange": "Text (e.g., Screw, Bolt, Nail)",
            "unit": "String",
            "affectsOutput": "Updates the BOM/Hardware listing attributes."
          },
          {
            "name": "dHWLength",
            "technicalDefault": "70",
            "businessMeaning": "Length of the fasteners used to attach the plate.",
            "validRange": "40 - 300",
            "unit": "mm",
            "affectsOutput": "Determines the length of pre-drilled holes in the steel plate and populates hardware data."
          },
          {
            "name": "dHWDiam",
            "technicalDefault": "5",
            "businessMeaning": "Diameter of the fasteners.",
            "validRange": "4 - 12",
            "unit": "mm",
            "affectsOutput": "Used for hardware reporting; drill diameter in the plate is fixed at 2.7mm in script logic."
          },
          {
            "name": "sHWMaterial",
            "technicalDefault": "\"Aluminium\"",
            "businessMeaning": "Material specification of the connector/hardware.",
            "validRange": "Text (e.g., Steel, Stainless Steel, Aluminium)",
            "unit": "String",
            "affectsOutput": "Updates material properties in the BOM."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Beam Alignment Check (Geometric)",
            "effect": "Forces connection type to L-bearing",
            "cascade": [
              "sConType"
            ]
          },
          {
            "trigger": "Element Detection",
            "effect": "Auto-sets connection type to 'Element' if second beam belongs to a wall element on insert.",
            "cascade": [
              "sConType"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (MetalPart)",
            "description": "The main BMF steel connector plate consisting of a base plate and a perpendicular stiffening rib.",
            "appliedTo": "Model Space (Generated at intersection)"
          },
          {
            "type": "Drill",
            "description": "Pre-drilled holes in the steel plate aligned at 45 degrees relative to plate surface.",
            "appliedTo": "Body (Steel Plate)"
          },
          {
            "type": "House (Milling)",
            "description": "A slot milled into the timber to recess the steel plate (toggled by sConType).",
            "appliedTo": "Beam 1 (Secondary Beam) or Beam 0 depending on Connection Type"
          },
          {
            "type": "Cut",
            "description": "A trimming operation on the beam end to facilitate the connection.",
            "appliedTo": "Beam 0 (Primary Beam)"
          },
          {
            "type": "Hardware",
            "description": "Data object for BOM generation representing the screws/bolts.",
            "appliedTo": "N/A (Data Output)"
          }
        ]
      },
      "tokens_used": 8984,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script starts; Unit set to mm; Execution loops set to 2.",
          "Properties initialized (Type, Connection, Hardware, Offsets, etc.).",
          "[Insert Mode] _bOnInsert check: True?",
          "[Insert Mode] Select First Beam (bm0).",
          "[Insert Mode] Select Second Beam (bm1).",
          "[Insert Mode] Check if bm1 belongs to an Element.",
          "[Insert Mode] If Element found, set 'Connection Type' to 'Element' automatically.",
          "[Insert Mode] Show Properties Dialog.",
          "[Insert Mode] Return (End of Insert sequence).",
          "Check if 2 beams exist in _Beam array. If not, exit.",
          "Assign bm0 and bm1 from _Beam array.",
          "Calculate intersection point (pt0) and coordinate system vectors (vx, vy, vz) based on beam alignment.",
          "Apply Vertical (dOffsetV) and Horizontal (dOffsetH) offsets to pt0.",
          "Check beam alignment: Are XY-planes parallel?",
          "[Alignment Check] If NOT parallel AND Connection Type != L-bearing, Force Connection Type to 'L-bearing'.",
          "Create Base Steel Plate (Body bd) and Stiffening Rib (bd1) and merge.",
          "Generate Drill holes in Plate based on 'Type' (width) and 'HW Length'.",
          "Branch based on Connection Type (sConType).",
          "Apply Cut tool to Primary Beam (bm0).",
          "Add Machining tools (House/BeamCut) to Primary (bm0) and/or Secondary (bm1) beams based on logic.",
          "[Element Mode] If 'Element' type selected but beam is not valid element, revert Connection Type to 'Milled in female beam'.",
          "Draw 3D visualization and Plan view labels.",
          "Generate Hardware objects (BOM) based on screw/bolt data.",
          "Finish Execution."
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Sequence (_bOnInsert)",
            "path1": {
              "name": "New Insert",
              "steps": [
                "Prompt Select First Beam",
                "Prompt Select Second Beam",
                "Detect Element membership of 2nd beam",
                "Auto-set Connection Type if needed",
                "Show Dialog",
                "Stop and Recalculate"
              ]
            },
            "path2": {
              "name": "Update/Recalc",
              "steps": [
                "Load existing beams from _Beam array",
                "Recalculate geometry based on new parameters or beam positions"
              ]
            }
          },
          {
            "condition": "Beam Alignment (Planes)",
            "path1": {
              "name": "Standard T-Connection (Coplanar)",
              "steps": [
                "Proceed with selected Connection Type (Milled, Visible, etc.)",
                "Standard Tooling application"
              ]
            },
            "path2": {
              "name": "Non-Coplanar (L-Bearing forced)",
              "steps": [
                "Report message: Beams not in same plane",
                "Force 'sConType' to 'L-bearing'",
                "Execute L-bearing logic (Rotated plate, offset vertical, BeamCut on bm0)"
              ]
            }
          },
          {
            "condition": "Connection Type (sConType) Logic",
            "path1": {
              "name": "0: Milled in female beam",
              "steps": [
                "Cut at plate edge on bm0",
                "Shift plate into bm1 (thickness + top offset)",
                "House (slot) in bm1"
              ]
            },
            "path2": {
              "name": "1: Milled in male beam",
              "steps": [
                "Cut at plate edge on bm0",
                "Shift plate to top of bm1",
                "House (slot) in bm1",
                "House (slot) in bm0 (interaction side)"
              ]
            },
            "path3": {
              "name": "2, 3, 4: Visible gap / concrete / Steel",
              "steps": [
                "Cut shifted by thickness on bm0",
                "Shift plate up by thickness",
                "No House in bm1",
                "(Steel only: Check lower edge distance and display warning if < 40mm)"
              ]
            },
            "path4": {
              "name": "5: Element",
              "steps": [
                "Shift plate to top of bm1",
                "Get Element CoordSys from bm1",
                "Calculate offset to Outline Wall / Zone",
                "Create House in bm1",
                "Apply BeamCut to Sheets of the Element",
                "Cut bm0 shifted by Element offset"
              ]
            },
            "path5": {
              "name": "6: L-bearing",
              "steps": [
                "Cut at edge on bm0",
                "Rotate Plate 180deg X and 180deg Z (flips orientation)",
                "Shift plate to match bm0 height minus plate height",
                "Apply dOffsetV (Vertical) to Plate and BeamCut",
                "BeamCut on bm0"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Count",
            "errorMessage": "(Implicit exit) Script requires exactly 2 beams.",
            "recovery": "Select valid beams on insertion or ensure script instance is not deleted."
          },
          {
            "check": "Element Type Integrity",
            "errorMessage": "I-Beam is not a beam of an element. The Connection Type will be changed to: Milled in female beam",
            "recovery": "Script auto-corrects to 'Milled in female beam'. User selects correct beam or accepts change."
          },
          {
            "check": "Lower Edge Distance (Steel Connection)",
            "errorMessage": "Warning [ScriptName]: Beam [Pos0]/[Pos1] Distance to lower egdge invalid!",
            "recovery": "User must adjust beam position or geometry manually; visual red line indicates error area."
          },
          {
            "check": "Beam Alignment",
            "errorMessage": "I-Beam is not in same plane with -Beam. The Connection Type will be changed to: L-bearing",
            "recovery": "Script auto-forces 'L-bearing' type to handle non-coplanar geometry."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Parameters",
            "how": "OPM (Object Properties Palette)",
            "effect": "Changing 'Type', 'Connection Type', offsets, or dimensions triggers full geometry recalculation of steel plate and machining."
          },
          {
            "action": "Move/Stretch Beams",
            "how": "AutoCAD Grips / Move commands",
            "effect": "Script recalculates intersection point (pt0) and updates plate position and drilling alignment to follow the beam intersection."
          },
          {
            "action": "Change Hardware Data",
            "how": "OPM (Hardware props)",
            "effect": "Updates the BOM/Hardware listing (Length, Diameter, Qty) and drill depth/position in the plate."
          }
        ]
      },
      "tokens_used": 9927,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# BMF Topverbinder EL\n\n## Overview\nGenerates a variable BMF steel top-connector plate to join two beams in T- or L-configurations. It supports various connection styles (recessed, visible, or wall elements) and handles automatic milling and drilling.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be inserted in 3D model. |\n| Paper Space | No | Not applicable for 2D drawings. |\n| Shop Drawing | No | Does not generate 2D layouts directly. |\n\n## Prerequisites\n- **Required Entities**: 2 GenBeams (or 1 GenBeam + 1 Element beam).\n- **Minimum Beam Count**: 2.\n- **Required Settings**: None (uses internal catalog/part numbers).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT`\n**Action**: Select `BMF Topverbinder EL.mcr` from the file dialog.\n\n### Step 2: Select First Beam\n```\nCommand Line: Select first beam\nAction: Click on the main beam (e.g., the wall plate or primary bearer) in the 3D model.\n```\n\n### Step 3: Select Second Beam\n```\nCommand Line: Select second beam\nAction: Click on the secondary beam (e.g., the joist or rafter) intersecting the first beam.\n```\n*Note: If the second beam belongs to a wall Element, the script will automatically detect this and adjust settings.*\n\n### Step 4: Configure Connection\nAfter selection, the Properties Palette will open automatically. Select the appropriate BMF size and connection type to generate the geometry.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| BMF Topverbinder EL | dropdown | 30/BMF-Nr:348030 | Selects the connector size (plate width). Options range from 30mm to 100mm. |\n| Connection Type | dropdown | Milled in female beam | Defines how the plate interacts with the timber (e.g., recessed milled slots, visible gap, or element connections). |\n| HW Type | text | Screw | Fastener category (e.g., Screw, Bolt). |\n| HW Description | text | ABC Spax | Description of the hardware for reports. |\n| HW Model | text | | Specific model name/number. |\n| HW Material | text | Aluminium | Material of the connector/hardware. |\n| HW Notes | text | | Additional notes for production lists. |\n| HW Length | number | 70 | Length of the fasteners (mm). |\n| HW Diameter | number | 5 | Diameter of the fasteners (mm). |\n| Offset V | number | 0 | Vertical adjustment of the connection height. |\n| Offset H | number | 0 | Horizontal adjustment along the main beam axis. |\n| Add Width | number | 2 | Tolerance added to the milling slot width (mm). |\n| Add Depth | number | 5 | Extra length added to the milling slot (mm). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the connector geometry if beams have moved or properties have changed. |\n| Properties | Opens the Properties Palette to edit parameters. |\n| Delete | Removes the script and associated machining/tools. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script uses internal logic and hard-coded BMF part numbers; no external XML settings file is required.\n\n## Tips\n- **L-Bearing Logic**: If the two beams selected are not in the same vertical plane (non-coplanar), the script automatically forces the \"Connection Type\" to **L-bearing** to ensure the steel plate fits correctly.\n- **Element Integration**: If you select a secondary beam that is part of a wall Element, the script defaults the Connection Type to **Element**, which applies cuts to the element sheets/outline.\n- **Steel Plate Visuals**: If \"Steel\" is chosen as the connection type, check the preview. A red warning line will appear if the distance to the lower edge of the beam is too small (< 40mm).\n\n## FAQ\n- **Q: Why did my Connection Type change to \"L-bearing\" automatically?**\n  A: The script detected that the two beams are not perfectly aligned in the same plane. It switches to L-bearing mode to handle the vertical offset between the beams.\n- **Q: What happens if I select a beam inside a wall element?**\n  A: The script detects the Element membership and automatically switches to \"Element\" mode, ensuring the steel plate and cuts are compatible with the wall structure.\n- **Q: How do I adjust the fit of the plate in the beam?**\n  A: Use the `Add Width` and `Add Depth` properties to increase the size of the milled slot (House) if the timber is swelling or for easier assembly."
      },
      "tokens_used": 7602,
      "error": null
    }
  }
}