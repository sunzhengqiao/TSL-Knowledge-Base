{
  "filename": "Attach Beam to Wall - Pocket & Point Load.mcr",
  "status": "completed",
  "total_tokens": 54148,
  "processing_time": 438.0501413345337,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6188,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses getBeam() and PrEntity() to select 3D entities during _bOnInsert. Performs 3D geometric calculations using Body, Plane, Vector3d, and Point3d. Modifies element geometry by adding tools (SolidSubtract, ElemMill) and setting specials (POCKETC, BALK). No 'sd_' prefixes, '#Type E' entity filters, or viewport manipulations found."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 6775,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getBeam\",\n        \"promptOriginal\": \"Select a beam\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity.go\",\n        \"promptOriginal\": \"\\nSelect a set of elements\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"ShowDynamicDialog (Auto-generated)\",\n      \"trigger\": \"On Insert (via showDialogOnce)\",\n      \"title\": \"Attach Beam to Wall - Pocket & Point Load\",\n      \"dataSource\": \"Script Properties\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dSpace\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Space\",\n      \"defaultValue\": \"0.5 mm\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nToolingIndex\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Tooling index\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"strMill\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Milling\",\n      \"defaultValue\": \"Apply milling\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Apply milling\",\n        \"Do not mill\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"strSide\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Side\",\n      \"defaultValue\": \"Left\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Left\",\n        \"Right\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"strTurn\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Turning direction\",\n      \"defaultValue\": \"Against course\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Against course\",\n        \"With course\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"strOShoot\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Overshoot\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"strVacuum\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Vacuum\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Text Style\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": \"_DimStyles\",\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sDispRep\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Show in Disp Rep\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"pStrPocketCParam\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Pocket-C parameters\",\n      \"defaultValue\": \"Set width & height based on beam\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Set width & height based on beam\",\n        \"Set width & height manually\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n"
      },
      "tokens_used": 10111,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the connection of a beam to a wall by creating a receiving pocket in the top-most wall element and calculating point loads (BALK) on the supporting elements below.\",\n    \"category\": \"Joinery/Framing\",\n    \"typicalUseCase\": \"Used when attaching a floor joist or rafter into a top plate or rim beam of a timber frame wall, ensuring CNC milling data and structural load indicators are generated.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dSpace\",\n      \"technicalDefault\": \"0.5\",\n      \"businessMeaning\": \"Clearance gap around the beam within the pocket. Allows for dimensional tolerances and timber movement (swelling/shrinkage) so the beam fits without force.\",\n      \"validRange\": \"0.0 mm to 5.0 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Expands or contracts the width of the pocket geometry (POCKETC) and the milling cut volume.\"\n    },\n    {\n      \"name\": \"nToolingIndex\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Identifier for the specific CNC machine tool (cutter/saw) to be used for the milling operation.\",\n      \"validRange\": \"Integer matching CNC configuration\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Determines which toolpath instruction is output to the production machine.\"\n    },\n    {\n      \"name\": \"strMill\",\n      \"technicalDefault\": \"Apply milling\",\n      \"businessMeaning\": \"Toggles whether the script generates physical machining operations (CNC cuts) or merely draws the geometry for visualization.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Switches between adding ElemMill tools (production) and Display objects (drafting only).\"\n    },\n    {\n      \"name\": \"strSide\",\n      \"technicalDefault\": \"Left\",\n      \"businessMeaning\": \"Determines the side of the contour where the tool radius is compensated (inside/outside pocket) or the machining direction relative to the wall.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Offsets the milling path slightly to the left or right, affecting the final cut dimensions.\"\n    },\n    {\n      \"name\": \"strTurn\",\n      \"technicalDefault\": \"Against course\",\n      \"businessMeaning\": \"Specifies the milling strategy: Climb Milling (Against course) or Conventional Milling (With course). Affects surface finish and tool wear.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Changes the G-code direction generated for the CNC machine.\"\n    },\n    {\n      \"name\": \"strOShoot\",\n      \"technicalDefault\": \"No\",\n      \"businessMeaning\": \"Controls whether the milling tool should overrun (cut through slightly beyond the geometry) to ensure a clean corner cut.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Extends the milling path geometry slightly beyond the theoretical intersection points.\"\n    },\n    {\n      \"name\": \"strVacuum\",\n      \"technicalDefault\": \"No\",\n      \"businessMeaning\": \"Toggles the vacuum hold-down table valves for the specific area being machined.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Adds or removes vacuum activation commands in the CNC output for this operation.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Selects the visual style (text size, arrow style) for dimensions and labels in the CAD drawing.\",\n      \"validRange\": \"List of available Dimension Styles\",\n      \"unit\": \"Style Name\",\n      \"affectsOutput\": \"Appearance of point load labels in the model/drawing.\"\n    },\n    {\n      \"name\": \"sDispRep\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Filters in which drawing views or representation levels the TSL graphics (pockets, point loads) are visible.\",\n      \"validRange\": \"String\",\n      \"unit\": \"Filter Name\",\n      \"affectsOutput\": \"Visibility of the script's generated graphics in different CAD views.\"\n    },\n    {\n      \"name\": \"pStrPocketCParam\",\n      \"technicalDefault\": \"Set width & height based on beam\",\n      \"businessMeaning\": \"Mode selector to either automatically size the pocket based on the selected beam's dimensions or manually override them.\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Determines whether pDPCHeight and pDPCWidth are calculated automatically or locked for user input.\"\n    },\n    {\n      \"name\": \"pDPCHeight\",\n      \"technicalDefault\": \"<Calculated>\",\n      \"businessMeaning\": \"The depth/height of the pocket cut relative to the element's coordinate system (how deep the beam sits).\",\n      \"validRange\": \"0 mm to Element Height\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Vertical size of the pocket (POCKETC) and the visual cut.\"\n    },\n    {\n      \"name\": \"pDPCWidth\",\n      \"technicalDefault\": \"<Calculated>\",\n      \"businessMeaning\": \"The length of the pocket along the wall. This width determines how many studs are included in the structural point load calculation.\",\n      \"validRange\": \"Beam Width to Wall Length\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Horizontal size of the pocket and the calculated number of studs for the BALK (Point Load) special.\"\n    },\n    {\n      \"name\": \"pDPCBraceheight\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"The height of material remaining at the top of the pocket (lip/brace) or a reinforcement parameter for the pocket geometry.\",\n      \"validRange\": \"0 mm to Pocket Height\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Modifies the shape of the POCKETC special, potentially creating a 'notch' look if > 0.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"pStrPocketCParam changes to 'Set width & height manually'\",\n      \"effect\": \"Unlocks pDPCHeight and pDPCWidth for user editing.\",\n      \"cascade\": [\n        \"pDPCHeight\",\n        \"pDPCWidth\"\n      ]\n    },\n    {\n      \"trigger\": \"pDPCWidth is modified\",\n      \"effect\": \"Changes the width of the pocket and recalculates the number of studs (dPLNrOfB) included in the BALK special.\",\n      \"cascade\": [\n        \"BALK Special (Width argument)\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"Special POCKETC\",\n      \"description\": \"A parametric pocket operation applied to the top-most selected element (highest Z) to receive the beam.\",\n      \"appliedTo\": \"The element with the highest Z coordinate in the user selection set.\"\n    },\n    {\n      \"type\": \"Special BALK\",\n      \"description\": \"A point load indicator added to the remaining selected elements. It calculates the number of studs (dPLNrOfB) affected by the load based on the pocket width.\",\n      \"appliedTo\": \"All selected elements except the one receiving the pocket.\"\n    },\n    {\n      \"type\": \"ElemMill\",\n      \"description\": \"CNC milling operations for the front and back faces of the wall element to cut the pocket through the cladding/sheets.\",\n      \"appliedTo\": \"Front and Back sheets of the element receiving the pocket.\"\n    },\n    {\n      \"type\": \"SolidSubtract\",\n      \"description\": \"Boolean subtraction geometry used to visually cut the wall element in the 3D model.\",\n      \"appliedTo\": \"The element receiving the pocket.\"\n    },\n    {\n      \"type\": \"Display\",\n      \"description\": \"Visual representation of the point load area (rectangle) and labels in the CAD model.\",\n      \"appliedTo\": \"All selected elements (annotation"
      },
      "tokens_used": 10854,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution starts (Insert or Recalc)",
          "Check execution state (_bOnInsert)",
          "If inserting: Show Dynamic Dialog for user configuration",
          "Prompt user to 'Select a beam' (getBeam)",
          "Prompt user to 'Select a set of elements' (PrEntity loop)",
          "Validate inputs: Check if Beam and Elements arrays are populated",
          "Identify target element: Find element with highest Z-coordinate (indexElPC) for the pocket",
          "Establish Coordinate System (csEl) from the target element",
          "Calculate intersection point (_Pt0) between beam and element",
          "Calculate Pocket Dimensions: Determine width/height based on beam geometry or manual property settings",
          "Generate Geometry: Define polylines for Front, Back, and Pocket contours based on beam angle and wall thickness",
          "Apply Pocket: Add POCKETC special to target element",
          "Apply Solid Subtraction: Cut the pocket volume from the element body",
          "Branch: Check 'Milling' property (strMill)",
          "If 'Apply milling': Add ElemMill tools to front and back sheets",
          "If 'Do not mill': Add Display objects for visualization only",
          "Calculate Point Loads: Determine number of studs (dPLNrOfB) based on pocket width",
          "Loop through selected elements to apply Point Loads",
          "Skip target element (indexElPC) in the loop",
          "Apply BALK special and Draw Point Load visualization on remaining elements",
          "Assign TSL to Element Group (Zone E0)",
          "Script finishes"
        ],
        "conditionalBranches": [
          {
            "condition": "Milling Option (strMill)",
            "path1": {
              "name": "Apply Milling",
              "steps": [
                "Generate Body objects for front and back milling",
                "Add SolidSubtract tools to element sheets",
                "Create and add ElemMill tools with tooling index, side, and turn settings",
                "Set Vacuum settings if enabled"
              ]
            },
            "path2": {
              "name": "Do Not Mill",
              "steps": [
                "Skip tool creation",
                "Create Display objects for front and back polylines",
                "Visual representation only (no CNC output)"
              ]
            }
          },
          {
            "condition": "Pocket Parameter Mode (pStrPocketCParam)",
            "path1": {
              "name": "Automatic Sizing",
              "steps": [
                "Calculate pDPCWidth based on beam width and angle",
                "Calculate pDPCHeight based on beam height and position",
                "Override properties with calculated values"
              ]
            },
            "path2": {
              "name": "Manual Sizing",
              "steps": [
                "Read pDPCWidth and pDPCHeight from user input",
                "Use fixed values regardless of beam geometry"
              ]
            }
          },
          {
            "condition": "Element Processing (Point Load Loop)",
            "path1": {
              "name": "Target Element (Highest Z)",
              "steps": [
                "Skip BALK special assignment",
                "Retain POCKETC and milling operations"
              ]
            },
            "path2": {
              "name": "Supporting Elements (Lower Z)",
              "steps": [
                "Calculate Point Load width",
                "Assign BALK special to element",
                "Draw visual indicators for load distribution"
              ]
            }
          },
          {
            "condition": "Beam Angle vs Wall Coordinates",
            "path1": {
              "name": "Standard Angle (Angle < 90 logic)",
              "steps": [
                "Calculate Front/Back vertices using specific offset logic",
                "Adjust for sheet thickness (dShFrontH/dShBackH)"
              ]
            },
            "path2": {
              "name": "Complementary Angle (Angle > 90 logic)",
              "steps": [
                "Invert vertex calculation logic for Front/Back faces",
                "Apply offsets in opposite direction to ensure correct pocket orientation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Selection",
            "errorMessage": "(No explicit message, instance erases)",
            "recovery": "User must re-insert the script and select a valid GenBeam."
          },
          {
            "check": "Element Selection",
            "errorMessage": "(No explicit message, instance erases)",
            "recovery": "User must re-insert the script and select at least one Element (Wall)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties",
            "how": "Object Properties Palette (OPM)",
            "effect": "Changing 'Space', 'Tooling index', 'Milling', or 'Side' triggers an immediate recalculation of the geometry and CNC tools."
          },
          {
            "action": "Adjust Pocket Size",
            "how": "OPM -> 'Pocket-C parameters' dropdown",
            "effect": "Switching to 'Set width & height manually' unlocks the Width and Height fields, allowing precise overrides of the automatic beam sizing."
          },
          {
            "action": "Move or Resize Host Entities",
            "how": "Grip edits or standard AutoCAD commands on the Beam or Wall Elements",
            "effect": "The TSL is dependent on the beam and elements. Moving the beam changes the intersection point (_Pt0). Changing the wall height updates the envelope calculation and pocket depth."
          }
        ]
      },
      "tokens_used": 12106,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Attach Beam to Wall - Pocket & Point Load\n\n## Overview\nAutomates the connection of a beam to a wall by creating a receiving pocket in the top-most wall element and calculating point loads (BALK) on the supporting elements below.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required. Script performs 3D geometric calculations on GenBeams and Elements. |\n| Paper Space | No | Script does not support 2D layout or shop drawing generation. |\n| Shop Drawing | No | Script operates directly on the 3D model entities. |\n\n## Prerequisites\n- **Required entities**: \n  - 1 `GenBeam` (e.g., floor joist or rafter).\n  - 1 or more `Element` (e.g., top plates, studs, or rim beams).\n- **Minimum beam count**: 1\n- **Required settings**: None (uses internal script properties).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT` â†’ Select `Attach Beam to Wall - Pocket & Point Load.mcr`\n\n### Step 2: Select Beam\n```\nCommand Line: Select a beam\nAction: Click on the beam (e.g., joist/rafter) that you want to insert into the wall.\n```\n\n### Step 3: Select Wall Elements\n```\nCommand Line: Select a set of elements\nAction: Select the wall elements (top plates and studs) that will support the beam. You can select multiple elements.\nNote: The script will automatically identify which element is the \"Top\" element (highest Z-value) to place the pocket.\n```\n\n### Step 4: Configure Properties\n**Action**: A dynamic dialog appears on insert. Adjust parameters such as the clearance gap (Space), milling options, and pocket dimensions. Click **OK** to generate.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Space | Number | 0.5 mm | Clearance gap around the beam within the pocket to allow for tolerances and swelling. |\n| Tooling index | Number | 0 | CNC machine tool identifier to be used for the milling operation. |\n| Milling | Dropdown | Apply milling | Determines if CNC milling data is generated (\"Apply milling\") or if geometry is visual only (\"Do not mill\"). |\n| Side | Dropdown | Left | Specifies the side of the contour for tool radius compensation (Left/Right). |\n| Turning direction | Dropdown | Against course | Milling strategy: \"Against course\" (Climb Milling) or \"With course\" (Conventional Milling). |\n| Overshoot | Dropdown | No | If \"Yes\", the milling tool overruns slightly beyond the geometry for cleaner corner cuts. |\n| Vacuum | Dropdown | No | If \"Yes\", activates vacuum hold-down commands for the CNC machine in this area. |\n| Text Style | Dropdown | *Empty* | Sets the dimension style for point load labels and annotations. |\n| Show in Disp Rep | Text | *Empty* | Filter name controlling which drawing views the script graphics are visible in. |\n| Pocket-C parameters | Dropdown | Set width & height based on beam | Switches between automatic sizing based on the selected beam or manual user input. |\n| Pocket Height | Number | *Calculated* | Depth/height of the pocket cut. Only editable if \"Set width & height manually\" is selected. |\n| Pocket Width | Number | *Calculated* | Length of the pocket along the wall. Only editable if \"Set width & height manually\" is selected. |\n| Braceheight | Number | 0 | Height of material remaining at the top of the pocket (lip). |\n\n## Right-Click Menu Options\n*(No custom menu items defined)*\nStandard hsbCAD context menu options apply:\n- **Recalculate**: Updates the script geometry based on current property values or beam movement.\n- **Delete**: Removes the script instance.\n\n## Settings Files\nNone. The script uses internal properties and does not rely on external XML settings files.\n\n## Tips\n- **Selection Order**: When selecting wall elements, select all relevant members (studs + top plate). The script automatically sorts them and applies the pocket only to the highest one.\n- **Adjusting Dimensions**: If the automatic pocket size based on the beam isn't suitable (e.g., you need a deeper seat), change \"Pocket-C parameters\" to \"Set width & height manually\" in the Properties Palette.\n- **Performance**: During the design phase, set \"Milling\" to \"Do not mill\". This skips CNC calculation and keeps the model lighter. Switch it back to \"Apply milling\" only when preparing for production.\n\n## FAQ\n- **Q: How is the number of studs for the point load determined?**\n  A: The script calculates the number of studs (Point Load) based on the \"Pocket Width\" and the stud spacing of the selected elements.\n- **Q: I moved the beam, but the pocket didn't move.**\n  A: Right-click the script instance (or the wall element) and select \"Recalculate\". The script updates the intersection point automatically.\n- **Q: Can I use this for CLT (Cross Laminated Timber) panels?**\n  A: Yes, as long as the target is a valid hsbCAD `Element`. The script will apply the pocket and point load logic regardless of the material type.\n- **Q: What does \"Turning direction: Against course\" mean?**\n  A: This refers to Climb Milling, where the cutter rotates against the direction of feed. It often results in a better finish but requires specific machine capabilities. \"With course\" is Conventional Milling."
      },
      "tokens_used": 8114,
      "error": null
    }
  }
}