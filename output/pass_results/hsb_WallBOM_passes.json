{
  "filename": "hsb_WallBOM.mcr",
  "status": "completed",
  "total_tokens": 56087,
  "processing_time": 240.54321551322937,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9454,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "PropString sSpace allows user selection between '|paper space|' and '|shopdraw multipage|'. Script contains logic for both: getViewport() with _Viewport array for Paper Space, and getShopDrawView() with _Entity array for Shopdraw Space. Retrieves Element context from these views to generate 2D tables."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be inserted in either a Paper Space Layout (linked to a Viewport) or a Shopdrawing Page (linked to a View Entity).",
          "requiredSettings": [
            "DimStyles"
          ]
        }
      },
      "tokens_used": 7784,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Pick a point where the bottom horizontal dim will reference to",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getViewport",
              "promptOriginal": "Select the viewport from which the element is taken",
              "condition": "_bOnInsert && sSpace == '|paper space|'",
              "required": true
            },
            {
              "step": 3,
              "function": "getShopDrawView",
              "promptOriginal": "|Select the view entity from which the module is taken|",
              "condition": "_bOnInsert && sSpace == '|shopdraw multipage|'",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 2,
            "variable": "sSpace",
            "type": "PropString",
            "displayName": "|Drawing space|",
            "defaultValue": "|paper space|",
            "inputType": "dropdown",
            "options": [
              "|paper space|",
              "|shopdraw multipage|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dim Style",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "strMaterial",
            "type": "PropString",
            "displayName": "Materials to exclude from the BOM",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Please fill the materials that you dont need to be list on the BOM, use ';' if you want to filter more that 1 material"
          },
          {
            "index": 5,
            "variable": "sCompAngle",
            "type": "PropString",
            "displayName": "|Switch to Complementary Angle|",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "sDoSheets",
            "type": "PropString",
            "displayName": "|Show Sheets in the BOM|",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sDoBeams",
            "type": "PropString",
            "displayName": "|Show Beams in the BOM|",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sDimStylePosnum",
            "type": "PropString",
            "displayName": "Dim Style Posnum",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nColorPosnum",
            "type": "PropInt",
            "displayName": "Color Posnum",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sShowBmPosnum",
            "type": "PropString",
            "displayName": "Show Beam Posnum",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": ""
          },
          {
            "index": 2,
            "variable": "nZones",
            "type": "PropInt",
            "displayName": "Show Posnum Zone, 0=none",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              0,
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10
            ],
            "category": null,
            "description": null
          },
          {
            "index": 8,
            "variable": "strShowLabel",
            "type": "PropString",
            "displayName": "Show Label Column",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9539,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a detailed Bill of Materials (BOM) table and position number labels for timber wall assemblies in shop drawings.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used by detailers to automatically create a parts list (stud count, sheeting sizes) on a 2D drawing layout, linked to a specific wall elevation view."
        },
        "parameters": [
          {
            "name": "sSpace",
            "technicalDefault": "|paper space|",
            "businessMeaning": "Defines the drawing environment context, determining if the script links to a standard AutoCAD Viewport or a hsbCAD Shopdrawing View Entity.",
            "validRange": [
              "|paper space|",
              "|shopdraw multipage|"
            ],
            "unit": "enum",
            "affectsOutput": "Alters the selection prompt (Viewport vs View Entity) and the coordinate transformation logic used to project the 2D table into the correct location."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Sets the dimension style (text size, precision, units) for the measurements inside the BOM table.",
            "validRange": "Any valid DimStyle in the current drawing.",
            "unit": "string",
            "affectsOutput": "Controls the visual format of width, height, and length columns (e.g., metric mm vs imperial fractions)."
          },
          {
            "name": "nColor",
            "technicalDefault": 3,
            "businessMeaning": "Assigns the AutoCAD color for the lines and text of the BOM table.",
            "validRange": "1-255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Visual color of the generated table."
          },
          {
            "name": "strMaterial",
            "technicalDefault": "",
            "businessMeaning": "Specifies a semicolon-separated list of materials to exclude from the schedule (e.g., 'GLAS;STEEL' to remove glass and steel hardware).",
            "validRange": "String of material names.",
            "unit": "string",
            "affectsOutput": "Filters out specific elements from the BOM calculation and table display."
          },
          {
            "name": "sCompAngle",
            "technicalDefault": "No",
            "businessMeaning": "Switches the angle reporting method between the direct wall angle and its complementary angle (90 minus the angle).",
            "validRange": [
              "No",
              "Yes"
            ],
            "unit": "enum",
            "affectsOutput": "Changes the calculated value displayed in the angle/dimension column of the table."
          },
          {
            "name": "sDoSheets",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the inclusion of sheet materials (e.g., OSB, Plywood) in the BOM.",
            "validRange": [
              "No",
              "Yes"
            ],
            "unit": "enum",
            "affectsOutput": "If 'No', the script skips processing Sheet entities and does not render the sheeting section of the table."
          },
          {
            "name": "sDoBeams",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the inclusion of timber beams (studs, plates, headers) in the BOM.",
            "validRange": [
              "No",
              "Yes"
            ],
            "unit": "enum",
            "affectsOutput": "If 'No', the script skips processing GenBeam entities and does not render the timber section of the table."
          },
          {
            "name": "sDimStylePosnum",
            "technicalDefault": "",
            "businessMeaning": "Sets the dimension style specifically for the position number labels (callouts) placed on the drawing view.",
            "validRange": "Any valid DimStyle in the current drawing.",
            "unit": "string",
            "affectsOutput": "Controls the text height and style of the individual beam tags placed on the elevation."
          },
          {
            "name": "nColorPosnum",
            "technicalDefault": 3,
            "businessMeaning": "Assigns the AutoCAD color for the position number labels (callouts).",
            "validRange": "1-255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Visual color of the posnum text and leader lines."
          },
          {
            "name": "sShowBmPosnum",
            "technicalDefault": "No",
            "businessMeaning": "Activates the generation of position number labels (tags) on the wall beams in the drawing view.",
            "validRange": [
              "No",
              "Yes"
            ],
            "unit": "enum",
            "affectsOutput": "If 'Yes', draws text labels on the beams corresponding to the PosNum column in the table."
          },
          {
            "name": "nZones",
            "technicalDefault": 0,
            "businessMeaning": "Filters the BOM based on specific wall construction zones (e.g., Left, Right, Gable). 0 shows all. Negative values indicate inverse selection or specific logic for label placement.",
            "validRange": "0 to 10",
            "unit": "index",
            "affectsOutput": "Filters which beams are listed in the table and determines the placement direction of the posnum labels."
          },
          {
            "name": "strShowLabel",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the visibility of a 'Label' column in the timber section of the BOM, often used for grouping or specific notes.",
            "validRange": [
              "No",
              "Yes"
            ],
            "unit": "enum",
            "affectsOutput": "Adds or removes a data column from the generated table."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sSpace == '|shopdraw multipage|'",
            "effect": "Changes the selection prompt to use getShopDrawView and retrieves Element data from a View Entity instead of a Viewport.",
            "cascade": [
              "_Entity",
              "getShopDrawView"
            ]
          },
          {
            "trigger": "nZones != 0",
            "effect": "Forces the calculation and display of position numbers (bShowShPosnum becomes true), regardless of other visual settings.",
            "cascade": [
              "bShowShPosnum",
              "Position Number Geometry"
            ]
          },
          {
            "trigger": "sDoSheets == 'No' || sDoBeams == 'No'",
            "effect": "Script skips the respective data collection loop (Sheet or GenBeam array processing), reducing the size of the output table.",
            "cascade": [
              "arSheet",
              "arBeam"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Text and Lines",
            "description": "A tabular schedule listing Material, PosNum, Dimensions (Length x Width), Thickness, and Quantity, grouped by beam type (Stud, Plate, etc.).",
            "appliedTo": "Paper Space or Shopdrawing Layout."
          },
          {
            "type": "2D Annotation",
            "description": "Position number labels placed on the wall elevation view, with logic to prevent overlapping text.",
            "appliedTo": "Specific Beams within the selected Element/View."
          }
        ]
      },
      "tokens_used": 10102,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch script from TSL Palette or Command Line.",
          "System executes properties initialization and sets internal flags (e.g., nZone, bShowShPosnum).",
          "Dialog shown (via showDialog) to allow initial configuration of properties.",
          "Prompt user: 'Pick a point where the bottom horizontal dim will reference to' (Input: Point3d -> _Pt0).",
          "Branch: Check property 'sSpace' (Drawing space).",
          "Path A (Paper Space): Prompt user: 'Select the viewport from which the element is taken'. (Input: Viewport -> _Viewport).",
          "Path B (Shopdraw Multipage): Prompt user: 'Select the view entity from which the module is taken'. (Input: Entity -> _Entity).",
          "Establish Coordinate Systems (ms2ps/ps2ms) based on selected Viewport or Entity.",
          "Retrieve Element context and Active Zone Index from the selection.",
          "Generate internal lists: Beam Types map to Levels (e.g., Stud -> 4), Nominal sizes lookup.",
          "Process Element Data: Collect all GenBeams and Sheets from the Element.",
          "Branch: Filter Materials based on 'strMaterial' property (exclude matched items).",
          "Branch: Filter by Zone if 'nZones' is active (collect only beams in specified zone).",
          "Branch: Should 'sDoBeams' be 'Yes'?",
          "Path Yes: Loop through filtered Beams, group by Level (Stud, Plate, etc.), aggregate quantities, calculate dimensions.",
          "Path No: Skip beam processing.",
          "Branch: Should 'sDoSheets' be 'Yes'?",
          "Path Yes: Loop through filtered Sheets, group by Material, aggregate quantities, calculate dimensions.",
          "Path No: Skip sheet processing.",
          "Draw 2D Geometry: Render BOM table rows in Paper Space using calculated text heights/widths and '_Pt0' as origin.",
          "Branch: Should position numbers be shown? (Check 'bShowShPosnum' derived from 'nZones' or 'sShowBmPosnum').",
          "Path Yes: Calculate posnum locations in Model Space, transform to Paper Space. Run collision detection loop (shifting text if overlap occurs). Draw labels.",
          "Path No: Skip posnum drawing.",
          "Script execution completes. Script instance remains linked to Viewport/Entity for subsequent recalcs."
        ],
        "conditionalBranches": [
          {
            "condition": "Evaluation of 'sSpace' property during insertion.",
            "path1": {
              "name": "Paper Space Workflow",
              "steps": [
                "Prompt for Viewport selection.",
                "Get Viewport Coordinate System (ms2ps).",
                "Retrieve Element from Viewport (vp.element()).",
                "Get activeZoneIndex from Viewport."
              ]
            },
            "path2": {
              "name": "Shopdraw Multipage Workflow",
              "steps": [
                "Prompt for Entity selection.",
                "Get Entity Coordinate System.",
                "Cast Entity to Element.",
                "Determine Zone (logic truncated in snippet, assumes similar retrieval)."
              ]
            }
          },
          {
            "condition": "User request for Position Numbers (Posnums).",
            "path1": {
              "name": "Show Posnums",
              "steps": [
                "Set bShowShPosnum = true.",
                "Collect beam positions and posnum strings.",
                "Transform points to Paper Space.",
                "Execute interference check loop (while intersection > 0, move label).",
                "Draw text labels on drawing."
              ]
            },
            "path2": {
              "name": "Hide Posnums",
              "steps": [
                "Skip posnum collection and geometry generation.",
                "Only render the table."
              ]
            }
          },
          {
            "condition": "Content filtering ('sDoBeams' and 'sDoSheets').",
            "path1": {
              "name": "Full BOM",
              "steps": [
                "Process Timber Beams (loop, sort, group).",
                "Process Sheets (loop, sort, group).",
                "Draw both sections of the table."
              ]
            },
            "path2": {
              "name": "Partial BOM (Beams Only)",
              "steps": [
                "Process Timber Beams.",
                "Skip Sheet processing.",
                "Draw Timber section only."
              ]
            },
            "path3": {
              "name": "Partial BOM (Sheets Only)",
              "steps": [
                "Skip Beam processing.",
                "Process Sheets.",
                "Draw Sheeting section only."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Element validity (Paper Space mode).",
            "errorMessage": "None explicit in snippet, but 'if (!vp.element().bIsValid()) return;' implies silent failure.",
            "recovery": "User must select a viewport that is actually linked to an hsbCAD Element."
          },
          {
            "check": "Array lengths for Viewport/Entity.",
            "errorMessage": "None explicit.",
            "recovery": "Script calls eraseInstance() and returns if array is empty or selection failed."
          },
          {
            "check": "Beam Count in Element.",
            "errorMessage": "None explicit.",
            "recovery": "If 0 beams found, script likely generates an empty table (no rows rendered)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Table Configuration",
            "how": "Properties Palette (OPM)",
            "effect": "Changing properties (e.g., 'sDoSheets', 'nColor', 'strMaterial') triggers a recalc. The script clears existing geometry and redraws the table based on new settings."
          },
          {
            "action": "Move Table Location",
            "how": "Grip Edit (Move)",
            "effect": "Moving the script insertion point (_Pt0) triggers a recalc, moving the entire BOM table to the new location while maintaining association with the Viewport."
          },
          {
            "action": "Change Linked View",
            "how": "Properties Palette (Select new Viewport/Entity)",
            "effect": "Updating the reference (viewport or entity) causes the script to fetch data from the new source and regenerate the BOM accordingly."
          },
          {
            "action": "Filter Output",
            "how": "Edit 'strMaterial' or 'nZones' in OPM",
            "effect": "Recalculates the list of included items, potentially removing rows or changing labels without moving the table."
          }
        ]
      },
      "tokens_used": 11355,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_WallBOM.mcr\n\n## Overview\nGenerates a detailed Bill of Materials (BOM) table and optional position number labels for timber wall assemblies directly in your shop drawings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | The script generates 2D output based on 3D model data, but is placed in layouts. |\n| Paper Space | Yes | Links to a standard AutoCAD Viewport. |\n| Shop Drawing | Yes | Links to a hsbCAD Shopdrawing View Entity (Multipage). |\n\n## Prerequisites\n- **Required Entities**: A Viewport or Shopdrawing View entity that is linked to a valid hsbCAD Element (e.g., a Wall).\n- **Minimum Beam Count**: 0 (The script will generate a header even if the wall is empty).\n- **Required Settings**: Dimension Styles must be configured in the drawing to control text size.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_WallBOM.mcr`\n\n### Step 2: Configure Properties\n```\nAction: The Properties configuration dialog appears.\nAction: Adjust settings (e.g., BOM content, Dimension Styles) and click OK.\n```\n\n### Step 3: Set Table Origin\n```\nCommand Line: Pick a point where the bottom horizontal dim will reference to\nAction: Click in the layout (Paper Space or Shopdrawing page) to set the bottom-left corner of the BOM table.\n```\n\n### Step 4: Select Source View\n*(The prompt depends on the \"Drawing space\" property selected in Step 2)*\n\n**Option A: Paper Space**\n```\nCommand Line: Select the viewport from which the element is taken\nAction: Click the border of the viewport displaying the wall elevation you wish to list.\n```\n\n**Option B: Shopdraw Multipage**\n```\nCommand Line: |Select the view entity from which the module is taken|\nAction: Click the view entity frame representing the wall elevation.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Drawing space** | dropdown | \\|paper space\\| | Select the environment: Paper Space (Viewport) or Shopdraw Multipage (View Entity). |\n| **Dim Style** | dropdown | *Current* | Dimension style used for the text and dimensions inside the BOM table. |\n| **Color** | number | 3 | AutoCAD color index (1-255) for the table lines and text. |\n| **Materials to exclude from the BOM** | text | | Enter material names to hide, separated by a semicolon (e.g., `NAIL;GLUE`). |\n| **Switch to Complementary Angle** | dropdown | No | If \"Yes\", calculates angles as (90 - Angle). |\n| **Show Sheets in the BOM** | dropdown | Yes | Toggles the listing of sheet materials (e.g., OSB, Plywood). |\n| **Show Beams in the BOM** | dropdown | Yes | Toggles the listing of timber beams (studs, plates, etc.). |\n| **Dim Style Posnum** | dropdown | *Current* | Dimension style used specifically for the position number labels on the drawing. |\n| **Color Posnum** | number | 3 | AutoCAD color index for the position number labels. |\n| **Show Beam Posnum** | dropdown | No | If \"Yes\", draws position number labels (tags) on the wall beams in the view. |\n| **Show Posnum Zone, 0=none** | dropdown | 0 | Filters the BOM to specific construction zones (0 = All). Enables label placement logic if set > 0. |\n| **Show Label Column** | dropdown | Yes | Toggles the visibility of the \"Label\" column in the timber section of the table. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *Standard TSL Menu* | Erase, Update, etc. (No specific custom menu items added by this script). |\n\n## Settings Files\n- None required (Standard hsbCAD DimStyles are used).\n\n## Tips\n- **Filtering Materials**: Use the \"Materials to exclude\" property to remove hardware or small consumables from your cut list to keep it clean.\n- **Moving the Table**: Select the BOM table and use the **Grip** at the insertion point (bottom-right of the first selection box usually) to drag the table to a new location. The table will automatically regenerate.\n- **Table Size**: To change the text height or width of columns, modify the **Dim Style** settings in AutoCAD, then update the script properties to use that new Dim Style.\n- **Zone Filtering**: If you only want to list studs for the left side of a complex wall, set \"Show Posnum Zone\" to the index number corresponding to that wall layer/zone.\n\n## FAQ\n- **Q: Why is my table empty?**\n  **A:** Ensure the Viewport or View Entity you selected is actually linked to a valid hsbCAD Element (Wall) and that the \"Show Beams\" and \"Show Sheets\" options are set to \"Yes\".\n- **Q: How do I remove specific steel parts from the wood list?**\n  **A:** Type the material name (e.g., \"STEEL\") into the \"Materials to exclude from the BOM\" property.\n- **Q: The text is too small/large.**\n  **A:** Do not scale the script entity. Instead, create a new AutoCAD Dimension Style with the desired text height and assign it to the \"Dim Style\" property in the palette."
      },
      "tokens_used": 7853,
      "error": null
    }
  }
}