{
  "filename": "hsbIfcAnnotation.mcr",
  "status": "completed",
  "total_tokens": 21379,
  "processing_time": 506.9391624927521,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 3137,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses `Display dp(-1)` and `_Pt0`, `_XU`, `_YU` for drawing without checking for `_Viewport` or using `sd_` prefixes. It retrieves data via `_ThisInst.map()` rather than `_Entity[]` arrays typical of ShopDrawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element/Entity with IFC annotation map"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (requires the script instance to exist with 'ifcAnnotation' map data)",
          "requiredSettings": []
        }
      },
      "tokens_used": 1436,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 2853,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Visualizes IFC (Industry Foundation Classes) annotation data such as dimensions, text labels, and reference points directly in the 3D model.",
          "category": "Annotation / BIM Integration",
          "typicalUseCase": "Used to display architectural or structural annotations imported from IFC files or generated by other BIM tools, ensuring that non-geometric data is visible to the timber detailer."
        },
        "parameters": [
          {
            "name": "pointSize",
            "technicalDefault": "U(50)",
            "businessMeaning": "The visual size of the crosshair marker used to represent IFC Point entities in the model.",
            "validRange": "20 - 100 mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the length of the lines making up the 'X' or cross symbol at point locations, making them easier or harder to see depending on scale."
          },
          {
            "name": "defaultTextHeight",
            "technicalDefault": "U(150)",
            "businessMeaning": "The text size used for the fallback label (script name) if no valid IFC annotation data is found attached to the script instance.",
            "validRange": "50 - 300 mm",
            "unit": "mm",
            "affectsOutput": "Determines the size of the diagnostic text drawn at the origin when the script cannot find the required 'ifcAnnotation' map data."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Presence of 'ifcAnnotation' map data",
            "effect": "Switches rendering between diagnostic fallback text and the actual IFC geometry (Points, Lines, Text).",
            "cascade": [
              "pointSize",
              "defaultTextHeight"
            ]
          },
          {
            "trigger": "TextLiteral item SizeY property",
            "effect": "Overrides the global Display textHeight for specific IFC text items.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Graphical Annotation",
            "description": "2D/3D geometry including Polylines (for lines/curves), Crosshairs (for points), and Text strings placed according to IFC coordinates.",
            "appliedTo": "Model Space (referenced to the script insertion point and local coordinate system)"
          }
        ]
      },
      "tokens_used": 3809,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution triggered (Insert or Recalculation)",
          "Check if current state is '_bOnInsert'",
          "[Conditional] If inserting, exit script immediately (no action)",
          "[Conditional] If recalculating, initialize Display context",
          "Attempt to retrieve 'ifcAnnotation' map from the script instance",
          "Access 'items' sub-map within the annotation data",
          "Iterate through all keys in the 'items' map",
          "[Loop] Check item type key ('Pline', 'Point', 'TextLiteral')",
          "[Conditional] Execute specific drawing routine based on type",
          "Update flag 'bSomethingDrawn' to true if geometry was rendered",
          "[Post-Loop] Check flag 'bSomethingDrawn'",
          "[Conditional Fallback] If flag is false (no data found), draw script name at origin"
        ],
        "conditionalBranches": [
          {
            "condition": "Script State: Insertion vs. Recalculation",
            "path1": {
              "name": "On Insert",
              "steps": [
                "Detect _bOnInsert is true",
                "Execute 'return' statement",
                "Terminate script without drawing anything"
              ]
            },
            "path2": {
              "name": "On Recalculation",
              "steps": [
                "Proceed to map retrieval",
                "Draw annotation geometry or fallback text"
              ]
            }
          },
          {
            "condition": "Map Item Type",
            "path1": {
              "name": "Pline",
              "steps": [
                "Retrieve PLine geometry from map",
                "Draw Polyline in 3D space"
              ]
            },
            "path2": {
              "name": "Point",
              "steps": [
                "Retrieve Point3d coordinates",
                "Calculate crosshair endpoints using hardcoded size U(50)",
                "Draw two LineSegs forming an 'X' at the point location"
              ]
            },
            "path3": {
              "name": "TextLiteral",
              "steps": [
                "Retrieve Map containing text properties (Literal, Location, Vectors, SizeY)",
                "Calculate local Y-axis using cross product of vecZ and vecX",
                "Override display textHeight with map's SizeY value",
                "Draw text string with specific orientation and alignment flags"
              ]
            }
          },
          {
            "condition": "Data Validity (bSomethingDrawn flag)",
            "path1": {
              "name": "Valid Data Present",
              "steps": [
                "Loop successfully processes at least one item",
                "Flag set to 1",
                "Skip fallback drawing at end of script"
              ]
            },
            "path2": {
              "name": "Missing or Invalid Data",
              "steps": [
                "Loop finds no items or map is missing",
                "Flag remains 0",
                "Execute fallback: draw scriptName() at _Pt0 using default textHeight U(150)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Presence of 'ifcAnnotation' map on script instance",
            "errorMessage": "None (Visual fallback provided)",
            "recovery": "The script automatically defaults to drawing its own name at the origin if the map is missing, acting as a visual placeholder for the user."
          },
          {
            "check": "Valid geometry keys in items map",
            "errorMessage": "None (Ignored)",
            "recovery": "Any keys not matching 'Pline', 'Point', or 'TextLiteral' are ignored within the loop. Only recognized types are rendered."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Visual Update / Recalculation",
            "how": "Regenerate drawing or change properties of the linked Element (if applicable)",
            "effect": "Re-runs the map retrieval and drawing loop, updating the 3D annotation to reflect changes in the underlying IFC data map."
          },
          {
            "action": "Move/Rotate Script Instance",
            "how": "Standard CAD Grips/Move commands",
            "effect": "Shifts the entire annotation group (_Pt0, _XU, _YU reference), moving the IFC data visualization in the model space."
          }
        ]
      },
      "tokens_used": 4723,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbIfcAnnotation.mcr\n\n## Overview\nThis script visualizes IFC (Industry Foundation Classes) annotation data, such as dimensions, text labels, and reference points, directly in the 3D model. It acts as a display container for non-geometric BIM data, ensuring architectural or structural annotations are visible within the timber detailing environment.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script runs exclusively in Model Space to visualize 3D annotations. |\n| Paper Space | No | Not supported for layout generation. |\n| Shop Drawing | No | Not intended for use in 2D shop drawings. |\n\n## Prerequisites\n- **Required Entities:** An Element or Entity with `ifcAnnotation` map data attached to it.\n- **Minimum Beam Count:** 0 (The script functions independently of beams).\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Select `hsbIfcAnnotation.mcr` from the file selection dialog and click **Open**.\n\n### Step 2: Place Instance\nAction: Click in the Model Space to set the insertion point (`_Pt0`) for the annotation group.\n- **Note:** The script does not prompt for further input during insertion. Upon placement, it will immediately attempt to read the attached IFC map data to generate the visualization.\n\n### Step 3: Verify Visualization\n- If valid IFC data is found in the map, the script will draw the specific geometry (Lines, Points as crosshairs, or Text).\n- If no data is found, the script will display its own name (`hsbIfcAnnotation`) at the insertion point as a diagnostic placeholder.\n\n## Properties Panel Parameters\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| *None* | N/A | N/A | This script does not expose user-editable parameters in the Properties palette. The visualization is driven entirely by the attached `ifcAnnotation` map data. |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | No custom context menu items are added by this script. Standard options (Move, Rotate, Erase, Recalculate) apply. |\n\n## Settings Files\n- **Filename:** None required.\n- **Location:** N/A\n- **Purpose:** N/A\n\n## Tips\n- **Diagnostic Mode:** If you see the script name written at the insertion point instead of IFC geometry, it indicates the required `ifcAnnotation` map data is missing or empty on that instance.\n- **Moving Annotations:** You can move or rotate the entire group of annotations using standard AutoCAD grips or commands on the script instance. The geometry is drawn relative to the script's local coordinate system.\n- **Point Representation:** IFC Points are visualized as crosshairs (\"X\") with a fixed size to ensure they are visible in the 3D model.\n\n## FAQ\n- **Q: Why do I only see the text \"hsbIfcAnnotation\" in my model?**\n  **A:** This is the fallback behavior. It means the script cannot find the `ifcAnnotation` map data on the instance. This usually happens if the script is inserted manually without the accompanying BIM data generation process, or if the data map was deleted.\n\n- **Q: Can I change the size of the text or the crosshairs?**\n  **A:** No, these values are hardcoded internal defaults designed to ensure visibility. The script renders the data exactly as provided in the map (with text size overrides if specified in the IFC data).\n\n- **Q: How do I update the annotation if the BIM data changes?**\n  **A:** Use the **Recalculate** command (or right-click and select Recalculate) on the script instance. This forces the script to re-read the map data and redraw the geometry."
      },
      "tokens_used": 5421,
      "error": null
    }
  }
}