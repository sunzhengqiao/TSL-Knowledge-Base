{
  "filename": "hsbParallelLapJoint.mcr",
  "status": "completed",
  "total_tokens": 51678,
  "processing_time": 210.5908703804016,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.2",
            "date": "05mar2020",
            "author": "david.delombaerde@hsbcad.com",
            "changes": "setting boundaries when moving the grippoint. And resetting the value when grip is out of bounds."
          },
          {
            "version": "1.1",
            "date": "25apr2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "alignment property added, visualisation of alignment improved"
          },
          {
            "version": "1.0",
            "date": "24apr2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7771,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses 'dbCreate' with the '_kModelSpace' argument. It uses 'PrEntity' to select 'Beam()' entities. It applies 'Cut' tools directly to beams ('bm0.addTool') and performs 3D geometry operations. There are no 'sd_' function calls, '_Viewport' checks, or '#Type E' entity selections, which are characteristic of Paper Space or Shop Drawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7722,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select split location|",
              "condition": "sHandles.length()<1 (i.e., no couples found)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dLength",
            "type": "PropDouble",
            "displayName": "|Length|",
            "defaultValue": "60 mm",
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Length|"
          },
          {
            "index": 0,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "|Side|",
            "defaultValue": "|Top|",
            "inputType": "dropdown",
            "options": [
              "|Top|",
              "|Left|",
              "|Bottom|",
              "|Right|"
            ],
            "category": "|Alignment|",
            "description": "|The alignment is dependent from the UCS at the time of insertion.| |You can also toggle sides by double clicking.|"
          },
          {
            "index": 1,
            "variable": "dAxisOffset",
            "type": "PropDouble",
            "displayName": "|Axis Offset|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Alignment|",
            "description": "|Defines the Axis Offset|"
          },
          {
            "index": 2,
            "variable": "dGapTop",
            "type": "PropDouble",
            "displayName": "|Top|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Gaps|",
            "description": "|Defines the gap on the positive Z-Side of the tool.|"
          },
          {
            "index": 3,
            "variable": "dGapCenter",
            "type": "PropDouble",
            "displayName": "|Center|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Gaps|",
            "description": "|Defines the the center gap.|"
          },
          {
            "index": 4,
            "variable": "dGapBottom",
            "type": "PropDouble",
            "displayName": "|Bottom|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Gaps|",
            "description": "|Defines the gap on the negative Z-Side of the tool.|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Rotate around X-Axis|",
            "handler": "|Rotate around X-Axis|",
            "action": "Cycles the Side property (Top -> Left -> Bottom -> Right -> Top).",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "|Flip X Axis|",
            "handler": "|Flip X Axis|",
            "action": "Swaps the connected beams and updates the Side property (Top <-> Bottom, Left <-> Right).",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Join + Erase|",
            "handler": "|Join + Erase|",
            "action": "Joins the two beams into one and removes the tool instance.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8186,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Creates a parallel lap joint (splice) between two beams, automatically splitting them if they don't overlap, to join them end-to-end in a linear fashion.\",\n    \"category\": \"Framing/Joinery\",\n    \"typicalUseCase\": \"Joining two parallel timber beams to extend their length, typically used in top plates, bottom plates, or lintels where continuity is required.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dLength\",\n      \"technicalDefault\": \"60 mm\",\n      \"businessMeaning\": \"The length of the overlap (lap) where the two beams are joined. This determines the structural contact area of the splice.\",\n      \"validRange\": \"40 mm to 600 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Defines the distance along the beam's axis that is cut away. Longer length provides stronger structural connection but removes more material.\"\n    },\n    {\n      \"name\": \"sSide\",\n      \"technicalDefault\": \"|Top|\",\n      \"businessMeaning\": \"Determines the orientation of the lap joint cut relative to the beam cross-section (which side of the beam is reduced).\",\n      \"validRange\": \"Top, Left, Bottom, Right\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Rotates the cutting tool 90 degrees around the beam's longitudinal axis, changing whether the top, bottom, or sides of the beams are coplanar after the joint.\"\n    },\n    {\n      \"name\": \"dAxisOffset\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Offsets the center of the joint vertically (or horizontally depending on Side) from the beam's central axis.\",\n      \"validRange\": \"-Width/2 to +Width/2\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Shifts the cut deeper into one beam and shallower into the other, or aligns specific faces (e.g., keeping the top face flush) when joining beams of different heights or asymmetrically.\"\n    },\n    {\n      \"name\": \"dGapTop\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Creates a clearance gap on the positive Z-side of the tool (relative to the joint orientation) between the two beams.\",\n      \"validRange\": \"0 mm to 10 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Prevents the timber surfaces from touching on the specified side, accommodating manufacturing tolerances, glue expansion, or insulation material.\"\n    },\n    {\n      \"name\": \"dGapCenter\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Creates a clearance gap in the center of the joint between the two beams.\",\n      \"validRange\": \"0 mm to 10 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Adds space between the overlapping material volumes, effectively preventing full contact in the middle of the splice.\"\n    },\n    {\n      \"name\": \"dGapBottom\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Creates a clearance gap on the negative Z-side of the tool (relative to the joint orientation) between the"
      },
      "tokens_used": 11072,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch Script (hsbParallelLapJoint)",
          "Check if insertion cycle (bOnInsert): YES -> Continue; NO -> Load existing state",
          "Check for Catalog Key (_kExecuteKey)",
          "Load Properties: Use Key, LastInserted, or Dialog (if no Key)",
          "Prompt User for Beam Selection (Select beam(s))",
          "Analyze Selection: Find parallel couples and check overlap",
          "Branch: Valid Overlap Couples Found?",
          "  YES -> Loop through couples: Create TSL Instance for each pair (Mode 1). Script ends.",
          "  NO -> Prompt User: 'Select split location'. Set 'splitBeams' map flag. Script ends.",
          "Instance Execution (Mode 1) / Recalculation:",
          "  Retrieve Beam Entities (_Beam[0], _Beam[1])",
          "  Validate Beams: Check alignment and overlap validity",
          "  Branch: Is geometry invalid?",
          "    YES -> Report error, apply static cuts, Erase Instance. End.",
          "    NO -> Continue",
          "  Calculate Joint Geometry (Reference point, Vectors based on Side property)",
          "  Apply Tools to Beams (Cuts and BeamCuts for lap and gaps)",
          "  Draw Visualization (Gaps, Axes)",
          "  Check for Context Triggers (Rotate, Flip, Join)",
          "  End Script Cycle"
        ],
        "conditionalBranches": [
          {
            "condition": "Detection of overlapping parallel beams during selection",
            "path1": {
              "name": "Automatic Batch Generation",
              "steps": [
                "User selects multiple beams",
                "Script filters for parallel pairs with sufficient overlap (> -dLength)",
                "Script spawns a new TSL instance for every valid pair found",
                "Parent 'Mode 0' script finishes"
              ]
            },
            "path2": {
              "name": "Manual Split/Single Mode",
              "steps": [
                "User selects beams (either non-overlapping, non-parallel, or only 1 beam)",
                "No valid couples detected automatically",
                "Script prompts 'Select split location'",
                "Script spawns a single TSL instance at that point",
                "The instance will attempt to intersect/cut beams at that location"
              ]
            }
          },
          {
            "condition": "Recalculation Triggered (Context Menu/Double Click)",
            "path1": {
              "name": "Rotate around X-Axis",
              "steps": [
                "Trigger: _kExecuteKey == '|Rotate around X-Axis|' OR Double Click",
                "Increment 'sSide' index (Top->Left->Bottom->Right)",
                "Force Loop 2 to update geometry immediately"
              ]
            },
            "path2": {
              "name": "Flip X Axis",
              "steps": [
                "Trigger: _kExecuteKey == '|Flip X Axis|'",
                "Swap _Beam[0] and _Beam[1]",
                "Adjust 'sSide' (Top<->Bottom, Left<->Right)",
                "Force Loop 2 to update geometry immediately"
              ]
            },
            "path3": {
              "name": "Join + Erase",
              "steps": [
                "Trigger: _kExecuteKey == '|Join + Erase|'",
                "Execute bm0.dbJoin(bm1)",
                "Erase current TSL instance"
              ]
            }
          },
          {
            "condition": "Grip Point (_Pt0) Movement",
            "path1": {
              "name": "Valid Move",
              "steps": [
                "User drags _Pt0 along beam axis",
                "Recalculates cut locations",
                "Updates display"
              ]
            },
            "path2": {
              "name": "Out of Bounds",
              "steps": [
                "User drags _Pt0 past start or end of combined beams",
                "Script detects d0 < 0 or d1 < 0",
                "Resets _Pt0 to previous valid position",
                "Geometry remains unchanged"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Alignment (Y and Z axis deviation)",
            "errorMessage": "ScriptName: not possible to join beams.",
            "recovery": "The script erases itself and applies simple static cuts. The user must ensure beams are parallel and aligned in the cross-section before running."
          },
          {
            "check": "Beam Overlap",
            "errorMessage": "None (handled by workflow split prompt)",
            "recovery": "If beams do not overlap initially, the user is prompted to select a split location, which effectively creates an overlap by splitting the beams at the desired joint point."
          },
          {
            "check": "Minimum Beam Count",
            "errorMessage": "None explicit (script logic handles 1 beam by asking for split point)",
            "recovery": "Select at least one beam. If only one is selected, the split point defines the location for the virtual second half."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Joint Length",
            "how": "OPM Property |Length| or Grip Edit (_Pt0)",
            "effect": "Adjusts the overlap distance (dLength) along the beam axis. Grip moves the center point; Property changes the size of the lap."
          },
          {
            "action": "Rotate Joint Orientation",
            "how": "Context Menu '|Rotate around X-Axis|' or Double Click",
            "effect": "Cycles the 'Side' property (Top->Left->Bottom->Right), rotating the cutting plane 90 degrees around the beam axis."
          },
          {
            "action": "Swap Beams (Flip)",
            "how": "Context Menu '|Flip X Axis|'",
            "effect": "Swaps Beam 0 and Beam 1 in the internal logic and adjusts the Side orientation to maintain visual consistency (e.g., Top stays Top, but which beam is cut changes)."
          },
          {
            "action": "Adjust Gaps",
            "how": "OPM Properties (Top, Center, Bottom)",
            "effect": "Modifies the BeamCut dimensions to add clearance between the two timber parts in the specified direction."
          },
          {
            "action": "Offset Axis",
            "how": "OPM Property |Axis Offset|",
            "effect": "Shifts the joint reference point perpendicular to the beam axis (in Z direction of the tool), moving the cut deeper into one beam and shallower into the other."
          },
          {
            "action": "Merge Beams",
            "how": "Context Menu '|Join + Erase|'",
            "effect": "Joins the two beam entities into a single GenBeam entity in the database and deletes the TSL script instance."
          }
        ]
      },
      "tokens_used": 10630,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbParallelLapJoint\n\n## Overview\nCreates a parallel lap joint (splice) between two beams to join them end-to-end. This script automatically detects overlapping beams to batch-create joints or prompts for a split location to join non-overlapping beams.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in the 3D model. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Does not generate 2D drawings directly. |\n\n## Prerequisites\n- **Required entities**: GenBeam (Timber beams).\n- **Minimum beam count**: 1 or 2.\n  - *Note:* If two overlapping beams are selected, they are joined automatically. If beams do not overlap or only one is selected, the script will split the beams at a user-defined location.\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbParallelLapJoint.mcr`\n\n### Step 2: Select Beams\n```\nCommand Line: Select beam(s)\nAction: Click on the beams you want to join. Press Enter to confirm selection.\n```\n\n### Step 3: Define Location (Conditional)\n*Scenario A: Beams overlap*\nIf the selected beams are parallel and overlap, the script automatically creates the joint instances and finishes.\n\n*Scenario B: Beams do not overlap (or single beam)*\n```\nCommand Line: Select split location\nAction: Click in the drawing where you want the lap joint to occur. The script will split the beams at this point and create the overlap.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Length | number | 60 mm | Defines the length of the overlap (lap) where the two beams connect. |\n| Side | dropdown | Top | Determines which side of the beam cross-section is reduced (Top, Left, Bottom, or Right). This is relative to the UCS at insertion. |\n| Axis Offset | number | 0 | Offsets the joint center from the beam's central axis. Use this to align specific faces (e.g., top flush) when joining beams. |\n| Top | number | 0 | Defines a clearance gap on the positive Z-side of the tool (relative to the joint orientation). |\n| Center | number | 0 | Defines a clearance gap in the middle of the joint between the two beams. |\n| Bottom | number | 0 | Defines a clearance gap on the negative Z-side of the tool (relative to the joint orientation). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Rotate around X-Axis | Cycles the \"Side\" property (Top → Left → Bottom → Right). Useful for rotating the cut orientation 90 degrees. |\n| Flip X Axis | Swaps the two connected beams. It also adjusts the \"Side\" property (e.g., Top ↔ Bottom) to maintain the visual alignment. |\n| Join + Erase | Joins the two separate beam entities into a single GenBeam and removes this script instance. |\n\n## Settings Files\nNone required.\n\n## Tips\n- **Quick Rotate:** You can double-click the joint instance to cycle through the \"Side\" orientations (Top/Left/Bottom/Right) instead of using the Right-Click menu.\n- **Grip Edit:** Use the grip point to slide the joint along the beam axis. The script prevents the grip from moving outside the beam boundaries.\n- **Splitting Long Beams:** To join two long beams that touch end-to-end but do not overlap, simply select them both. When prompted for a \"split location,\" click the point where they meet.\n\n## FAQ\n- **Q: Why did the script ask me to \"Select split location\"?**\n  **A:** The selected beams did not overlap sufficiently. The script needs you to define where to cut the beams so they can overlap and form the lap joint.\n- **Q: Can I change the overlap length after inserting?**\n  **A:** Yes, select the joint and change the \"Length\" property in the Properties Palette, or use the grip point to adjust the position interactively.\n- **Q: What happens if I use \"Join + Erase\"?**\n  **A:** The two beams become one single beam entity in the database, and the joint parameters (length, gaps) are no longer editable as they are \"burned in\" to the new beam geometry."
      },
      "tokens_used": 6297,
      "error": null
    }
  }
}