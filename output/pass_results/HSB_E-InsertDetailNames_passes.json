{
  "filename": "HSB_E-InsertDetailNames.mcr",
  "status": "completed",
  "total_tokens": 56251,
  "processing_time": 363.7647125720978,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 17,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl places detail texts at a given position The catalog from this tsl can be set from the DSP parameters. The tsl reads a specific variable.",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "20.01.2012",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "23.01.2012",
            "author": "AS",
            "changes": "Erase this tsl after execution"
          },
          {
            "version": "1.02",
            "date": "25.01.2012",
            "author": "AS",
            "changes": "Trim spaces from detailname"
          },
          {
            "version": "1.03",
            "date": "30.01.2012",
            "author": "AS",
            "changes": "Check if tsl is valid"
          },
          {
            "version": "1.04",
            "date": "05.03.2012",
            "author": "AS",
            "changes": "Add support for sem-colon seperated details"
          },
          {
            "version": "1.05",
            "date": "25.03.2012",
            "author": "AS",
            "changes": "Position detail on frame"
          },
          {
            "version": "1.06",
            "date": "07.05.2012",
            "author": "AS",
            "changes": "Reposition detail"
          },
          {
            "version": "1.07",
            "date": "14.05.2012",
            "author": "AS",
            "changes": "Only use beams which are not aligned with detail"
          },
          {
            "version": "1.08",
            "date": "21.11.2012",
            "author": "AS",
            "changes": "Add support for element mirror."
          },
          {
            "version": "1.09",
            "date": "30.08.2013",
            "author": "AS",
            "changes": "Add offset."
          },
          {
            "version": "1.10",
            "date": "02.10.2013",
            "author": "AS",
            "changes": "Change name of satelite tsl. TODO: Make the name of the satelite a property."
          },
          {
            "version": "1.11",
            "date": "03.03.2014",
            "author": "AS",
            "changes": "Check fro point in profile has now a 50 mm margin."
          },
          {
            "version": "1.12",
            "date": "18.03.2014",
            "author": "AS",
            "changes": "Correct typo in name of detail tsl."
          },
          {
            "version": "1.13",
            "date": "28.03.2014",
            "author": "AS",
            "changes": "Increase direction check"
          },
          {
            "version": "1.14",
            "date": "04.04.2014",
            "author": "AS",
            "changes": "Direction check nog based on intersect on plane profile."
          },
          {
            "version": "1.15",
            "date": "23.06.2014",
            "author": "AS",
            "changes": "Insert default detail"
          },
          {
            "version": "1.16",
            "date": "19.10.2016",
            "author": "AS",
            "changes": "Also collect openingRoofs from element groups."
          },
          {
            "version": "1.17",
            "date": "17.11.2016",
            "author": "AS",
            "changes": "Remove beam with invalid sizes."
          },
          {
            "version": "1.18",
            "date": "24.10.2017",
            "author": "AS",
            "changes": "Option to specify default detail name."
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "HSB_E-DetailName"
        ]
      },
      "tokens_used": 8376,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses dbCreate(..., _kModelSpace, ...) for all entity insertions. It targets Element objects (ElementRoof, ElementWallSF) and performs 3D geometric calculations using CoordSys, Vector3d, and PlaneProfile to determine placement positions. The script triggers on _bOnElementConstructed and erases itself after execution, which is characteristic of a 3D model generation/processing script. There are no references to _Viewport, Sheet, or sd_ drawing functions."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "HSB_E-DetailName (Satellite script)",
            "Catalog definitions for HSB_E-InsertDetailNames",
            "Catalog definitions for HSB_E-DetailName",
            "DSP variables assigned to Element Roof edges and openings"
          ]
        }
      },
      "tokens_used": 8165,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select one or more elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertyDialog",
            "trigger": "_bOnInsert && (_kExecuteKey == \"\" || arSCatalogNames.find(_kExecuteKey) == -1)",
            "title": null,
            "dataSource": "PropDouble/PropInt/PropString definitions",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Roof|/|Floor|",
            "description": null
          },
          {
            "index": 0,
            "variable": "nVarIndex",
            "type": "PropInt",
            "displayName": "|Variable index|",
            "defaultValue": 60,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "defaultDetailName",
            "type": "PropString",
            "displayName": "|Default detail name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "|Sets the detail name with the specified value, if it can't be found in the list of DSP variables.|"
          },
          {
            "index": 1,
            "variable": "sCatEdgeDetails",
            "type": "PropString",
            "displayName": "|Catalog edge details|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Catalog entries from 'HSB_E-DetailName'",
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sCatOpeningDetails",
            "type": "PropString",
            "displayName": "|Catalog opening details|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Catalog entries from 'HSB_E-DetailName'",
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sCatSupportingDetails",
            "type": "PropString",
            "displayName": "|Catalog supporting details|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Catalog entries from 'HSB_E-DetailName'",
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Position|",
            "description": null
          },
          {
            "index": 0,
            "variable": "dOffsetDetail",
            "type": "PropDouble",
            "displayName": "|Offset detail|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Catalog entries from 'HSB_E-InsertDetailNames'",
            "handler": "_kExecuteKey",
            "action": "Set properties from catalog and insert details onto selected element",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 10478,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically places detail name labels (annotations) on Element edges, openings, and supporting structures based on the Element's assigned construction detail variables.",
          "category": "Annotation / Automation",
          "typicalUseCase": "Used during model generation or detailing to automatically visualize and label specific construction methods (e.g., fascia types, rafter connections) on roofs and floors without manual text placement."
        },
        "parameters": [
          {
            "name": "nVarIndex",
            "technicalDefault": 60,
            "businessMeaning": "The index of the DSP (Design Specific Parameter) variable slot within the element's construction detail string that contains the detail name to be displayed. It tells the script which part of the detailed parameter string to read.",
            "validRange": "1 - 100 (Integer)",
            "unit": "index",
            "affectsOutput": "Determines the text content of the label. If the index does not match the data structure in the element properties, the label may be empty or display incorrect data."
          },
          {
            "name": "defaultDetailName",
            "technicalDefault": "",
            "businessMeaning": "A fallback text string used if the specific variable defined by 'nVarIndex' is empty, invalid, or cannot be found in the element's properties.",
            "validRange": "String (Text)",
            "unit": "text",
            "affectsOutput": "Provides a default label for details where the primary variable is missing, ensuring consistent annotation."
          },
          {
            "name": "sCatEdgeDetails",
            "technicalDefault": "",
            "businessMeaning": "Selects a visual configuration (catalog entry) from the 'HSB_E-DetailName' script to be applied specifically to labels placed on Element edges (outlines).",
            "validRange": "Catalog Entries from 'HSB_E-DetailName'",
            "unit": "selection",
            "affectsOutput": "Controls the visual appearance (font size, layer, color, style) of edge labels via the satellite script."
          },
          {
            "name": "sCatOpeningDetails",
            "technicalDefault": "",
            "businessMeaning": "Selects a visual configuration (catalog entry) from the 'HSB_E-DetailName' script to be applied specifically to labels placed on roof openings (e.g., dormers, skylights).",
            "validRange": "Catalog Entries from 'HSB_E-DetailName'",
            "unit": "selection",
            "affectsOutput": "Controls the visual appearance of opening labels via the satellite script."
          },
          {
            "name": "sCatSupportingDetails",
            "technicalDefault": "",
            "businessMeaning": "Selects a visual configuration (catalog entry) from the 'HSB_E-DetailName' script to be applied specifically to labels placed on horizontal supporting structures (e.g., knee walls, wall plates, struts).",
            "validRange": "Catalog Entries from 'HSB_E-DetailName'",
            "unit": "selection",
            "affectsOutput": "Controls the visual appearance of support labels via the satellite script."
          },
          {
            "name": "dOffsetDetail",
            "technicalDefault": 0,
            "businessMeaning": "A linear offset distance to move the generated detail text away from the edge or object it describes, measured along the normal vector.",
            "validRange": "-500 to 500 mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the position of the text label in 3D space to prevent overlapping with geometry or other annotations."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nVarIndex",
            "effect": "Changes the data source for the label text.",
            "cascade": [
              "defaultDetailName"
            ]
          },
          {
            "trigger": "Catalog selection (sCatEdgeDetails, etc.)",
            "effect": "Updates the properties of the generated 'HSB_E-DetailName' instances.",
            "cascade": [
              "Visual style of output entities"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TSL Instance (HSB_E-DetailName)",
            "description": "Instances of the 'HSB_E-DetailName' satellite script are created at calculated positions on edges, openings, and supports. These instances handle the actual text display.",
            "appliedTo": "ElementRoof, ElementFloor, ElementWallSF"
          }
        ]
      },
      "tokens_used": 10206,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization: Check if element is deleted (_bOnElementDeleted).",
          "[Conditional] Check Insertion Mode: Determine if script is being inserted manually or triggered by construction event.",
          "[Manual Insertion Branch] Check Duplicate Insertion: Abort if insertCycleCount() > 1.",
          "[Manual Insertion Branch] Load Catalog Settings: If an execute key is provided, load properties from catalog; otherwise, show Property Dialog.",
          "[Manual Insertion Branch] Select Elements: Prompt user to select one or more Elements.",
          "[Manual Insertion Branch] Cleanup Existing TSLs: Erase existing instances of this script attached to the selected elements.",
          "[Manual Insertion Branch] Create Satellite Instances: Create new 'HSB_E-InsertDetailNames' instances attached to selected elements with 'MasterToSatellite' map flag.",
          "[Manual Insertion Branch] Self-Destruct: Erase the initial script instance.",
          "[Satellite / Event Branch] Load Master Properties: Check for 'MasterToSatellite' map flag and load properties from the master catalog entry.",
          "[Manual / Event Branch] Validate Selection: Check if valid Element (ElementRoof or ElementWallSF) is attached.",
          "[Manual / Event Branch] Cleanup Detail Scripts: Erase existing 'HSB_E-DetailName' satellite scripts on the element.",
          "[Conditional] Element Type Check: Determine if element is Roof/Floor or Wall.",
          "[Roof/Floor Path] Geometry Preparation: Create shadow profile of the element and subtract beams/holes to determine valid placement zones.",
          "[Roof/Floor Path] Process Edges: Iterate through roof edges, extract detail name from 'constrDetail' string using 'nVarIndex', and calculate label position.",
          "[Roof/Floor Path] Process Openings: Iterate through roof openings (dormers/skylights), determine specific edge details (left/right/top/bottom), and calculate label positions.",
          "[Roof/Floor Path] Process Supports: Check for knee walls, wall plates, and struts; calculate intersection with roof plane; place detail labels.",
          "[Common Path] Insert Detail Scripts: Create 'HSB_E-DetailName' TSL instances at calculated positions with correct orientation and name.",
          "[Common Path] Self-Destruct: Erase the processing script instance after execution.",
          "[Wall Path] Currently no implementation for wall elements."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion Context",
            "path1": {
              "name": "Manual Insert (_bOnInsert)",
              "steps": [
                "Prevent multiple insertion cycles.",
                "Load catalog or show dialog.",
                "Prompt user for Element selection.",
                "Attach processed script instances to selected elements.",
                "Erase temporary instance."
              ]
            },
            "path2": {
              "name": "Automatic Event Trigger (_bOnElementConstructed / bManualInsert)",
              "steps": [
                "Read properties from parent/master instance.",
                "Process attached element geometry.",
                "Generate detail labels.",
                "Erase processing instance."
              ]
            }
          },
          {
            "condition": "Detail Name Source (for Edges/Openings)",
            "path1": {
              "name": "Map Format",
              "steps": [
                "Parse 'constrDetail' string as Map.",
                "Read specific variable index (DVAR/STRVAR)."
              ]
            },
            "path2": {
              "name": "Token Format (Legacy)",
              "steps": [
                "Parse 'constrDetail' string using token delimiters.",
                "Extract value at index 'nVarIndex'."
              ]
            },
            "path3": {
              "name": "Default Fallback",
              "steps": [
                "Use 'defaultDetailName' property if other methods fail or return empty strings."
              ]
            }
          },
          {
            "condition": "Element Type",
            "path1": {
              "name": "Roof or Floor",
              "steps": [
                "Process Outline Edges.",
                "Process Opening Roofs.",
                "Process Horizontal Supports (if Roof)."
              ]
            },
            "path2": {
              "name": "Wall (ElementWallSF)",
              "steps": [
                "Script currently does nothing for wall elements."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Deletion",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases itself automatically."
          },
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script prevents re-execution and erases itself if insertCycleCount() > 1."
          },
          {
            "check": "Element Selection",
            "errorMessage": "Invalid selection!",
            "recovery": "Script erases itself; user must select a valid Element (Roof/Floor/Wall)."
          },
          {
            "check": "Element Type",
            "errorMessage": "Invalid element type!",
            "recovery": "Script erases itself; user must select a supported element type (Roof/Floor)."
          },
          {
            "check": "Beam Geometry Validity",
            "errorMessage": "None (Internal Check)",
            "recovery": "Invalid beams (0 volume) are erased during profile calculation."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Detail Labels",
            "how": "Edit properties of the generated 'HSB_E-DetailName' instances via OPM (Properties Palette).",
            "effect": "Changes to the text content (Name), visual style, or position of individual labels."
          },
          {
            "action": "Regenerate Labels",
            "how": "Right-click on the Element or run the script again manually.",
            "effect": "The script erases old 'HSB_E-DetailName' instances and creates new ones based on current parameters and geometry."
          },
          {
            "action": "Change Default/Catalog Settings",
            "how": "Edit 'HSB_E-InsertDetailNames' properties in the Element's TSL list or in the Catalog.",
            "effect": "Updates which DSP variable is read or the visual catalog used for future insertions/regenerations."
          }
        ]
      },
      "tokens_used": 11179,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-InsertDetailNames\n\n## Overview\nThis script automates the placement of detail text labels (annotations) on Element edges, openings, and supporting structures. It reads specific construction variables from the selected Roofs or Floors and generates the appropriate text markers using a satellite script.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates entirely within the 3D model to generate annotation entities. |\n| Paper Space | No | Not designed for 2D layout or drawing views. |\n| Shop Drawing | No | This is a model detailing tool. |\n\n## Prerequisites\n- **Required Entities**: Element (Roof, Floor, or Wall).\n- **Minimum Beam Count**: 0 (This script operates at the Element level).\n- **Required Settings**:\n  - The satellite script `HSB_E-DetailName` must be present in your TSL folder.\n  - Catalog definitions must exist for both `HSB_E-InsertDetailNames` and `HSB_E-DetailName`.\n  - Elements must have valid DSP (Design Specific Parameter) data assigned to their edges or openings.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-InsertDetailNames.mcr`\n\n### Step 2: Configure Properties (Optional)\n**Action**: \n- If you select a **Catalog Entry** from the right-click menu during insertion, the settings are pre-loaded.\n- If you insert the script directly without a preset, the **Properties Palette** will open. Configure the following:\n  - **Roof/Floor Category**: Set the `Variable index` (default 60) to match the DSP slot holding your detail names.\n  - **Catalog Options**: Select the visual style catalogs for Edges, Openings, and Supporting details.\n  - **Position Category**: Set an offset if text needs to be moved away from the element.\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or more elements\nAction: Click on the desired Roofs or Floors in the 3D model and press Enter.\n```\n\n### Step 4: Execution\n**Action**: \n- The script will scan the selected elements.\n- It erases any old detail labels.\n- It calculates positions for edges, openings (dormers/skylights), and supports.\n- It places new `HSB_E-DetailName` scripts at these locations.\n- **Note**: The `HSB_E-InsertDetailNames` script will automatically erase itself after running, leaving only the new detail labels behind.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Variable index** (`nVarIndex`) | Integer | 60 | The index of the DSP variable slot that contains the detail name to be displayed. |\n| **Catalog edge details** (`sCatEdgeDetails`) | Dropdown | - | Selects the visual style catalog for labels placed on element outlines. |\n| **Catalog opening details** (`sCatOpeningDetails`) | Dropdown | - | Selects the visual style catalog for labels placed on roof openings (dormers, skylights). |\n| **Catalog supporting details** (`sCatSupportingDetails`) | Dropdown | - | Selects the visual style catalog for labels placed on supports (knee walls, plates). |\n| **Default detail name** (`defaultDetailName`) | String | \"\" | A fallback text used if the specific variable cannot be found or is empty. |\n| **Offset detail** (`dOffsetDetail`) | Double | 0 | Distance (mm) to move the text label away from the edge or object along the normal vector. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Catalog Entries** | Allows you to insert the script with a specific configuration preset (e.g., \"Standard Edge Labels\"). This bypasses the manual property entry step. |\n\n## Settings Files\n- **Catalog Definitions**: `HSB_E-InsertDetailNames` and `HSB_E-DetailName`\n- **Location**: Defined in your hsbCAD configuration path.\n- **Purpose**: These store the visual presets (font, layer, size) for the generated labels and the configuration settings for the insertion script.\n\n## Tips\n- **Script Disappears**: It is normal for the `HSB_E-InsertDetailNames` script to vanish from the element list after insertion. It is a \"one-time run\" script that leaves the `HSB_E-DetailName` instances behind as the persistent labels.\n- **Offsetting**: If your labels are clipping into the beams or geometry, increase the `Offset detail` value to push the text outward.\n- **DSP Data**: Ensure your Element construction details actually have data in the variable index specified (default is 60). If the labels are blank, check the DSP string in the Element properties.\n\n## FAQ\n- **Q: The script disappeared after I ran it. Did it fail?**\n  - **A:** No. The script is designed to run once, generate the labels, and then erase itself to keep the element clean. The labels you see are separate \"satellite\" scripts.\n- **Q: Why are some labels blank?**\n  - **A:** The script looks for a specific variable index (default 60). If that slot is empty in your Element's construction details, the label will be blank unless you have filled in the `Default detail name` property.\n- **Q: Does this work on Walls?**\n  - **A:** Currently, the logic for Wall elements is not implemented. It is designed for Roofs and Floors."
      },
      "tokens_used": 7847,
      "error": null
    }
  }
}