{
  "filename": "hsbCLT-PrintText.mcr",
  "status": "completed",
  "total_tokens": 35972,
  "processing_time": 948.5387585163116,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "14dec2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5387,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script operates on a single Sip (Single Insertion Point) object reference (_Sip). No usage of 'sd_' prefixes, Multipage*, _Viewport, _Entity[], or _kPaperSpace found. Script prompts for point input (_Pt0) which is typical for model space interaction. 'assignToGroups' is called with the Sip object, linking it to the 3D model entity."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sip (Element/GenBeam)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires a reference to a valid 3D element (Sip). The script must be inserted onto a panel or beam in the model.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3325,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getSip",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "@(Posnum) @(SolidLength)",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the format of the composed value.||Samples|   |We love CLT| |any text with not variables|   @(Label)@(SubLabel)   @(Label:L2) |the first two characters of Label|   @(Label:T1; |the second part of Label if value is separated by blanks, i.e. 'EG AW 2' will return AW'|)   @(Width:RL1) |the rounded value of width with one decimal.|R |Right: Takes the specified number of characters from the right of the string.|L |Left: Takes the specified number of characters from the left of the string.|S |SubString: Given one number will take all characters starting at the position (zero based).| |Given two numbers will start at the first number and take the second number of characters.|T |​Tokeniser: Returns the member of a delimited list using the specified index (zero based). A delimiter can be specified as an optional parameter with the default delimiter being the semcolon character..|# |Rounds a number. Specify the number of decimals to round to. Trailing zero's are removed.|RL |​Round Local: Rounds a number using the local regional settings..|"
          },
          {
            "index": 1,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|Reference Side|",
            "inputType": "dropdown",
            "options": [
              "|Reference Side|",
              "|Opposite Side|"
            ],
            "category": "|Alignment|",
            "description": "|Defines the Alignment|"
          },
          {
            "index": 2,
            "variable": "sTextPosition",
            "type": "PropString",
            "displayName": "|Text Position|",
            "defaultValue": "|bottom| |left|",
            "inputType": "dropdown",
            "options": [
              "|bottom| |left|",
              "|bottom| |center|",
              "|bottom| |right|",
              "|center| |left|",
              "|center| |center|",
              "|center| |right|",
              "|top| |left|",
              "|top| |center|",
              "|top| |right|"
            ],
            "category": "|Alignment|",
            "description": "|Defines the TextPosition|"
          },
          {
            "index": 3,
            "variable": "sTextOrientation",
            "type": "PropString",
            "displayName": "|Text Orientation|",
            "defaultValue": "|Positive X-Axis|",
            "inputType": "dropdown",
            "options": [
              "|Positive X-Axis|",
              "|Positive Y-Axis|",
              "|Negative X-Axis|",
              "|Negative Y-Axis|"
            ],
            "category": "|Alignment|",
            "description": "|Defines the TextOrientation|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "U(50)",
            "inputType": "number",
            "options": [],
            "category": "|Alignment|",
            "description": "|Defines the TextHeight|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Flip Side|",
            "handler": "|Flip Side|",
            "action": "Toggles the Alignment between Reference Side and Opposite Side",
            "alsoTriggeredBy": "TslDoubleClick"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6609,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Places dynamic text labels on CLT panels or beams in the 3D model based on element properties, primarily for fabrication or installation identification.",
          "category": "Annotation / CLT Processing",
          "typicalUseCase": "Labeling a CLT wall panel with its Position Number and Length (e.g., 'W1 2500') directly on the panel face so it appears in shop drawings and CNC exports."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(Posnum) @(SolidLength)",
            "businessMeaning": "Defines the content of the label using dynamic placeholders (macros) to pull data like Position Number, Length, Material, or custom strings from the element properties.",
            "validRange": "String supporting TSL macro syntax (e.g., @(Label), @(Width), static text).",
            "unit": "string",
            "affectsOutput": "The textual content displayed on the panel and included in export data."
          },
          {
            "name": "sAlignment",
            "technicalDefault": "|Reference Side|",
            "businessMeaning": "Determines which face of the panel the text is placed on. 'Reference Side' is usually the 'Top' or 'Front' face based on the element's local coordinate system.",
            "validRange": "Dropdown: Reference Side, Opposite Side",
            "unit": "enum",
            "affectsOutput": "The physical location (Z-axis direction) where the text is projected onto the panel geometry."
          },
          {
            "name": "sTextPosition",
            "technicalDefault": "|bottom| |left|",
            "businessMeaning": "Controls the justification of the text relative to the insertion point (snapped point on the panel edge).",
            "validRange": "Dropdown: 9 options (Top/Center/Bottom combined with Left/Center/Right)",
            "unit": "enum",
            "affectsOutput": "The offset of the text block relative to the selected point on the panel edge."
          },
          {
            "name": "sTextOrientation",
            "technicalDefault": "|Positive X-Axis|",
            "businessMeaning": "Sets the rotation/reading direction of the text relative to the element's local axes.",
            "validRange": "Dropdown: Positive X-Axis, Positive Y-Axis, Negative X-Axis, Negative Y-Axis",
            "unit": "enum",
            "affectsOutput": "The angle at which the text is drawn on the panel."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "U(50)",
            "businessMeaning": "The physical size of the text on the panel.",
            "validRange": "10mm to 200mm (Typically 30mm-80mm for legibility)",
            "unit": "mm",
            "affectsOutput": "The scale of the text characters."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing 'sAlignment' (or using 'Flip Side' context menu)",
            "effect": "Recalculates the target face. The projection of the insertion point moves from the Reference Side face to the Opposite Side face (or vice versa).",
            "cascade": [
              "Text Location",
              "Marker Position"
            ]
          },
          {
            "trigger": "User Pick Point (_Pt0) during insertion",
            "effect": "The script snaps this point to the nearest edge of the panel on the face defined by 'sAlignment'.",
            "cascade": [
              "Text Anchor Point"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mark (Annotation)",
            "description": "A text entity attached to the Sip (Element). It includes the formatted text but suppresses the standard leader line, effectively floating text on the 3D solid.",
            "appliedTo": "The selected Sip (Element/GenBeam)."
          }
        ]
      },
      "tokens_used": 6647,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Define constants, properties (Format, Alignment, Position, Orientation, Height), and debug flags.",
          "2. Insertion Check (_bOnInsert):",
          "   2a. Verify insertCycleCount. If > 1, erase duplicate instance and exit.",
          "   2b. Check for Execution Key (_kExecuteKey):",
          "       - If Key exists: Search catalog for match. If found, load catalog props; else load '_LastInserted' props.",
          "       - If Key is empty: Show Properties Dialog.",
          "   2c. Prompt User to Select Entity (Sip) using getSip().",
          "   2d. Prompt User to Pick Location (_Pt0) using getPoint().",
          "   2e. Exit (Wait for recalculation).",
          "3. Validation & Setup:",
          "   3a. Check if _Sip reference exists. If not, report 'Invalid reference', erase instance, and exit.",
          "   3b. Extract coordinate vectors (vecX, vecY, vecZ) and geometry from the Sip.",
          "   3c. Map user-friendly property strings to internal integer indices for alignment and orientation.",
          "   3d. Set text height (using default if invalid value provided).",
          "4. Recalculation/Update Check (_bOnRecalc):",
          "   4a. Detect 'Flip Side' context menu trigger or Double Click.",
          "   4b. Toggle 'nAlignment' index (Reference Side <-> Opposite Side).",
          "   4c. Update 'sAlignment' property.",
          "   4d. Set execution loops to 2 and restart calculation.",
          "5. Geometry Processing:",
          "   5a. Determine Face Vector (vecFace) based on alignment (Reference or Opposite).",
          "   5b. Project user's picked point (_Pt0) onto the center plane of the panel face along X-axis.",
          "   5c. Extract the panel face profile (PlaneProfile) at the projected location.",
          "   5d. Shrink profile by text height (to ensure text stays inside bounds).",
          "   5e. Split profile segments to find the specific edge location closest to the user's pick point.",
          "6. Text Generation & Placement:",
          "   6a. Resolve the 'sFormat' string using Sip properties (e.g., replace @(Posnum) with actual data).",
          "   6b. Create Mark entity on the Sip at calculated point, using determined normal and orientation. Suppress leader line.",
          "   6c. Generate Display graphics for the text in the model, adjusting reading vectors based on orientation settings."
        ],
        "conditionalBranches": [
          {
            "condition": "Duplicate Insertion Detected (insertCycleCount > 1)",
            "path1": {
              "name": "Cleanup Path",
              "steps": [
                "Erase current instance",
                "Return immediately"
              ]
            }
          },
          {
            "condition": "Execution Key (_kExecuteKey) presence during insertion",
            "path1": {
              "name": "Catalog/Key Insert",
              "steps": [
                "Convert key to uppercase",
                "Search script catalogs for match",
                "Apply properties from matched catalog OR '_LastInserted' default"
              ]
            },
            "path2": {
              "name": "Standard Insert",
              "steps": [
                "Open Properties Dialog for user input",
                "Wait for user confirmation"
              ]
            }
          },
          {
            "condition": "Valid Sip Reference found",
            "path1": {
              "name": "Valid Execution",
              "steps": [
                "Extract geometry",
                "Calculate text position",
                "Draw text and create mark"
              ]
            },
            "path2": {
              "name": "Failure Mode",
              "steps": [
                "Report 'Invalid reference' message",
                "Erase instance",
                "Exit"
              ]
            }
          },
          {
            "condition": "Trigger: 'Flip Side' or Double Click",
            "path1": {
              "name": "Modify Alignment",
              "steps": [
                "Invert nAlignment variable (0<->1)",
                "Update sAlignment property",
                "Force script recalculation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Sip (Element/GenBeam) existence",
            "errorMessage": "\"\\n\" + scriptName() + \": \" + \"|Invalid reference.|\" + \" \" + \"|Tool will be deleted|\"",
            "recovery": "Script self-destructs. User must re-insert the script on a valid panel or beam."
          },
          {
            "check": "Text Height validity",
            "errorMessage": "None (Silent correction)",
            "recovery": "If dTextHeight <= 0, script defaults to U(50) for display text. Note: Mark text height becomes 0 if dTextHeight <= 0, potentially hiding exported text."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Text Content",
            "how": "OPM Properties Palette (Format field)",
            "effect": "Updates the displayed string and exported marker text based on new macro definition."
          },
          {
            "action": "Move Text",
            "how": "Grip edit the insertion point (_Pt0)",
            "effect": "Text projects to the nearest edge on the new face location."
          },
          {
            "action": "Flip Text Side",
            "how": "Right-click Context Menu -> 'Flip Side' OR Double-Click the script instance",
            "effect": "Toggles the text between 'Reference Side' and 'Opposite Side' of the panel."
          },
          {
            "action": "Change Orientation/Position",
            "how": "OPM Properties Palette (Text Position, Text Orientation)",
            "effect": "Adjusts the rotation and justification of the text relative to the insertion point."
          },
          {
            "action": "Resize Text",
            "how": "OPM Properties Palette (Text Height)",
            "effect": "Scales the text size in the model and in the exported marker."
          }
        ]
      },
      "tokens_used": 7640,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-PrintText\n\n## Overview\nThis script places dynamic text labels on CLT panels or beams in the 3D model. It is primarily used to display fabrication information, such as position numbers or dimensions, directly on the element surface for identification in drawings and exports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be inserted onto a valid 3D panel or beam. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: A CLT panel or beam (Element/GenBeam).\n- **Minimum Beam Count**: 0 (Uses Element reference).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbCLT-PrintText.mcr`\n\n### Step 2: Select Element\n```\nCommand Line: Select Element\nAction: Click on the CLT panel or beam you wish to label.\n```\n\n### Step 3: Pick Text Location\n```\nCommand Line: Pick Location\nAction: Click a point on the panel face or edge to define where the text will be placed.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | text | @(Posnum) @(SolidLength) | Defines the content of the text using dynamic macros (e.g., @(Label), @(Length)). You can mix static text with variables. |\n| Alignment | dropdown | Reference Side | Determines which face of the panel the text is placed on (Reference Side or Opposite Side). |\n| Text Position | dropdown | bottom left | Sets the justification of the text relative to the picked point (e.g., Top Left, Center Center, Bottom Right). |\n| Text Orientation | dropdown | Positive X-Axis | Sets the rotation angle of the text relative to the element's local axes (X or Y axis directions). |\n| Text Height | number | U(50) | Defines the physical height of the text characters on the panel. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side | Immediately toggles the text between the \"Reference Side\" and the \"Opposite Side\" of the panel. This can also be triggered by double-clicking the script instance. |\n\n## Settings Files\nNo external settings files are required.\n\n## Tips\n- **Dynamic Macros**: Use the `Format` property to pull real data from the model. For example, `@(Posnum)` pulls the element's position number, and `@(Width:RL1)` pulls the width rounded to 1 decimal.\n- **Moving Text**: You can grip-edit the insertion point in the model to slide the text along the panel edge. The text will automatically snap to the nearest edge on the current face.\n- **Quick Flip**: Double-click the text in the model to instantly flip it to the other side of the panel without opening the properties palette.\n\n## FAQ\n- **Q: Why did my text disappear?**\n- **A:** Check if the \"Text Height\" is set too small or if the script was moved to a location where it cannot project onto the geometry. Also, ensure the referenced element has not been deleted.\n- **Q: How do I display the material name?**\n- **A:** Enter `@(Material)` (or similar property name) into the `Format` field in the properties palette.\n- **Q: Can I change the text rotation?**\n- **A:** Yes, use the \"Text Orientation\" dropdown in the properties to rotate the text 90 degrees or align it with the panel's local Y-axis."
      },
      "tokens_used": 6364,
      "error": null
    }
  }
}