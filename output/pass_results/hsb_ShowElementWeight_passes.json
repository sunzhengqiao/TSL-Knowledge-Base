{
  "filename": "hsb_ShowElementWeight.mcr",
  "status": "completed",
  "total_tokens": 48804,
  "processing_time": 202.84635710716248,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "20.04.2012",
            "author": "Alberto Jena",
            "changes": "First version"
          },
          {
            "version": "1.1",
            "date": "30.04.2012",
            "author": "",
            "changes": "Add default weight and improve the report notice"
          },
          {
            "version": "1.2",
            "date": "01.05.2012",
            "author": "",
            "changes": "Bugfix"
          },
          {
            "version": "1.4",
            "date": "01.06.2012",
            "author": "",
            "changes": "Add a report notice in case it can not find the materials.xml"
          },
          {
            "version": "1.5",
            "date": "08.06.2012",
            "author": "",
            "changes": "Check if the material has a first token of \"-\" and use the the prefix to that token as the material for SIPs.  Also added sips to the calculation."
          },
          {
            "version": "1.7",
            "date": "26.02.2013",
            "author": "",
            "changes": "Change the Element array so it wont be populated when the viewport option is selected."
          },
          {
            "version": "1.8",
            "date": "13.03.2013",
            "author": "",
            "changes": "Improved accuracy of SIP weight by extracting each component and working out the weight of the panel"
          },
          {
            "version": "1.10",
            "date": "10.09.2015",
            "author": "",
            "changes": "Ignored dummy beams, sheets and sips"
          },
          {
            "version": "1.13",
            "date": "08.08.2018",
            "author": "",
            "changes": "Add support for weight in lb"
          },
          {
            "version": "1.16",
            "date": "22.11.2018",
            "author": "",
            "changes": "Change no material found from reportnotice to reportmessage (RP)"
          }
        ],
        "settingsFiles": [
          "Materials.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 7398,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "PropString sMode (0, sModes,\"Insert in:\") where sModes={\"Model\", \"Viewport\"}; _Viewport.append(getViewport(T(\"Select a viewport\"))); logic handling nMode==1 to calculate CoordSys ms2ps = vp.coordSys() and transform vectors using Viewport context."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (for Model mode) or Paper Space (for Viewport mode)",
          "requiredSettings": [
            "Materials.xml (must exist in _kPathHsbCompany\\Abbund\\)"
          ]
        }
      },
      "tokens_used": 6758,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "\nSelect a set of elements",
              "condition": "nMode==0",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Pick a Point",
              "condition": "nMode==1",
              "required": true
            },
            {
              "step": 3,
              "function": "getViewport",
              "promptOriginal": "Select a viewport",
              "condition": "nMode==1",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Property Dialog",
            "trigger": "_bOnInsert",
            "title": "Properties",
            "dataSource": "showDialogOnce()",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Insert in:",
            "defaultValue": "Model",
            "inputType": "dropdown",
            "options": [
              "Model",
              "Viewport"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dim Style",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nRotation",
            "type": "PropInt",
            "displayName": "Rotation",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dMaxWeight",
            "type": "PropDouble",
            "displayName": "Max weight",
            "defaultValue": 100,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "Displays as 'Max weight (kg)' or 'Max weight (lb)' depending on drawing units"
          },
          {
            "index": 2,
            "variable": "sPrefix",
            "type": "PropString",
            "displayName": "Prefix:",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "Materials.xml",
            "searchPaths": [
              "_kPathHsbCompany\\Abbund\\"
            ],
            "purpose": "Provides material density values (kg/m^3) to calculate the weight of beams, sheets, and SIPs.",
            "required": true
          }
        ]
      },
      "tokens_used": 9557,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically calculates the total weight of timber elements (panels, walls, roofs) based on material densities and displays it as an annotation label.",
          "category": "Annotation / Reporting",
          "typicalUseCase": "Used during detailing or production planning to ensure panels are within lifting limits, calculate shipping weights, or display engineering data on shop drawings."
        },
        "parameters": [
          {
            "name": "sMode",
            "technicalDefault": "Model",
            "businessMeaning": "Specifies the context where the weight label is displayed: either attached to the 3D model element or placed within a 2D viewport on a layout sheet.",
            "validRange": "Model, Viewport",
            "unit": "Selection",
            "affectsOutput": "Determines if the label moves with the 3D model (Model) or stays fixed on a 2D drawing view (Viewport). Changes how coordinates are calculated."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Selects the drafting standard (font, size, arrow style) to be used for the weight text, ensuring it matches project visual standards.",
            "validRange": "Any valid Dimension Style defined in the CAD drawing.",
            "unit": "String (Style Name)",
            "affectsOutput": "Visual appearance of the text label (height, font, layer properties)."
          },
          {
            "name": "nRotation",
            "technicalDefault": 0,
            "businessMeaning": "Sets the rotation angle of the weight label relative to the insertion point, allowing the user to align text with walls or horizontal axes.",
            "validRange": "0 - 360",
            "unit": "Degrees",
            "affectsOutput": "Orientation of the displayed text."
          },
          {
            "name": "dMaxWeight",
            "technicalDefault": 100,
            "businessMeaning": "Defines a safety or handling threshold. If the calculated weight exceeds this value, the label changes color (typically to red) to warn that the element may require machinery (crane/forklift) to lift.",
            "validRange": "Dependent on lifting capacity limits (e.g., 20kg for manual handling, >2000kg for crane requirements).",
            "unit": "kg or lb (Based on drawing units)",
            "affectsOutput": "Color of the text label. If Weight > dMaxWeight, text turns Red; otherwise, it uses the default color."
          },
          {
            "name": "sPrefix",
            "technicalDefault": "",
            "businessMeaning": "Adds custom text before the numeric weight value to provide context (e.g., 'Panel Wt:', 'Total:', 'Est.').",
            "validRange": "Any alphanumeric string.",
            "unit": "String",
            "affectsOutput": "Text content displayed before the weight value."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dMaxWeight parameter changes",
            "effect": "Updates the threshold for the visual warning indicator on the label.",
            "cascade": [
              "Text Color"
            ]
          },
          {
            "trigger": "Drawing Units (Metric vs Imperial)",
            "effect": "Changes the default unit label from 'kg' to 'lb' and recalculates the volume conversion factor used in weight calculations.",
            "cascade": [
              "dMaxWeight (Scale of value)",
              "Weight Result Display"
            ]
          },
          {
            "trigger": "sMode set to 'Viewport'",
            "effect": "Changes the coordinate system reference from World/Model Space to the selected Viewport's coordinate system.",
            "cascade": [
              "Label Position",
              "Text Rotation alignment"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation Text",
            "description": "A text entity displaying the formatted weight (e.g., '245 kg') at the selected location.",
            "appliedTo": "Model Space (on Element) or Paper Space (in Viewport)."
          },
          {
            "type": "ElemItem (Data Attribute)",
            "description": "A logical data item named 'PANELWEIGHT' attached to the element, containing the numeric weight value for export to reports or CAM software.",
            "appliedTo": "Selected Element (Wall/Floor/Roof)."
          },
          {
            "type": "Element SubMap (Internal Data)",
            "description": "Writes the calculated 'TotalWeight' into the Element's 'HSB_ElementInfo' submap for use by other scripts or processes.",
            "appliedTo": "Selected Element."
          }
        ]
      },
      "tokens_used": 8429,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script starts and initializes units (Metric/Imperial) based on drawing settings.",
          "User triggers insertion; Properties Dialog is displayed (if not run via execute key).",
          "User selects 'Insert in:' mode (Model or Viewport) and confirms.",
          "Script determines insertion path based on selection mode.",
          "If 'Model': User selects Elements (Walls/Floors) -> Script spawns a new instance on each Element -> Original instance erases.",
          "If 'Viewport': User picks a point -> User selects a Viewport -> Script attaches to Viewport.",
          "Execution phase: Script validates target Element exists.",
          "Script locates and loads 'Materials.xml' to retrieve density values.",
          "Script collects all sub-entities (Beams, Sheets, Sips, Openings, Truss definitions) within the Element.",
          "Script iterates through all entities to calculate volume and look up material density.",
          "Script sums total weight and applies unit conversion (kg or lb).",
          "Script generates text label at insertion point, applying rotation and dimension style.",
          "Script checks weight against 'dMaxWeight': sets text color to Red if exceeded, otherwise Default.",
          "Script writes 'TotalWeight' to Element SubMap ('HSB_ElementInfo') and creates an invisible 'PANELWEIGHT' export item.",
          "Script finishes."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Mode selection (nMode)",
            "path1": {
              "name": "Model Mode (nMode=0)",
              "steps": [
                "Prompt user to select Elements using PrEntity.",
                "Loop through selected elements.",
                "For each element, call dbCreate to attach a new TSL instance.",
                "Set new instance position to element origin + Z offset.",
                "Erase the original 'command' TSL instance."
              ]
            },
            "path2": {
              "name": "Viewport Mode (nMode=1)",
              "steps": [
                "Prompt user to pick a point (getPoint).",
                "Prompt user to select a viewport (getViewport).",
                "Store viewport reference and point.",
                "Retrieve Element reference directly from the selected Viewport later in execution."
              ]
            }
          },
          {
            "condition": "Materials.xml file found",
            "path1": {
              "name": "Found",
              "steps": [
                "Parse XML file into Map.",
                "Populate Material and Density arrays.",
                "Proceed with weight calculation."
              ]
            },
            "path2": {
              "name": "Not Found",
              "steps": [
                "Display Report Notice: 'hsbMaterial Table not found'.",
                "If in Model mode: Erase instance and exit.",
                "If in Viewport mode: Exit without erasing (leaving invalid instance)."
              ]
            }
          },
          {
            "condition": "Specific Material Lookup in XML",
            "path1": {
              "name": "Material Exists",
              "steps": [
                "Use specific density from XML.",
                "Calculate Entity Weight = Volume * Density."
              ]
            },
            "path2": {
              "name": "Material Not Found",
              "steps": [
                "Display Report Message: Material not available.",
                "Check for 'DEFAULT' density in XML.",
                "If Default exists: Calculate Weight using Default density.",
                "If Default missing: Display Report Notice: Default density not available (Entity contributes 0 weight)."
              ]
            }
          },
          {
            "condition": "Element List Modified (e.g., Wall Split)",
            "path1": {
              "name": "Modified & >1 Element",
              "steps": [
                "Keep only the first element in the _Element array.",
                "Discard others to prevent duplicate processing/ghosting."
              ]
            },
            "path2": {
              "name": "Normal State",
              "steps": [
                "Process all elements in the array (usually 1 in Model mode, or 0 in Viewport mode)."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of Materials.xml",
            "errorMessage": "hsbMaterial Table not found, please set the right company folder",
            "recovery": "Ensure XML file exists in _kPathHsbCompany\\Abbund\\ and re-run script."
          },
          {
            "check": "Element Validity",
            "errorMessage": "No selected walls. TSL will be deleted (Model Mode) or Silent Exit (Viewport Mode).",
            "recovery": "Ensure a valid Element is selected (Model) or the Viewport refers to a valid Element (Viewport)."
          },
          {
            "check": "Entity Dimensions (Dummy/Small check)",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script silently ignores beams, sheets, or SIPs with H, W, or L < 0.5mm or marked as 'bIsDummy'."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Text Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'Prefix', 'Rotation', 'Dim Style', or 'Max weight' triggers an immediate recalculation/redraw of the text label."
          },
          {
            "action": "Update Calculation Data",
            "how": "Modify Element Geometry (e.g., resize wall, add/remove beams)",
            "effect": "The script detects changes (via standard TSL events), recalculates the total weight, and updates the text label and the 'PANELWEIGHT' export item."
          },
          {
            "action": "Split Element",
            "how": "CAD Split Command",
            "effect": "The script detects the split via '_bOnElementListModified', detaches from the split-off parts, and remains attached to the primary element, ensuring only one label exists per element."
          }
        ]
      },
      "tokens_used": 10066,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ShowElementWeight\n\n## Overview\nThis script automatically calculates the total weight of timber construction elements (walls, floors, and roofs) based on their material composition and dimensions. It displays the weight as an annotation label that updates dynamically if the element geometry changes.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The label is attached directly to the 3D element. |\n| Paper Space | Yes | The label is placed inside a selected viewport on a layout sheet. |\n| Shop Drawing | No | This is for model annotation and element reporting. |\n\n## Prerequisites\n- **Required Entities:** An existing Element (Wall, Floor, or Roof).\n- **Minimum Beam Count:** 0 (Calculates based on all content within the element).\n- **Required Settings:** `Materials.xml` must exist in your company folder (`..._kPathHsbCompany\\Abbund\\`) containing density values for the materials used in your project.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsb_ShowElementWeight.mcr`\n\n### Step 2: Configure Properties\nThe Properties Palette will appear automatically upon insertion.\n1.  **Insert in:** Choose \"Model\" to place the label on the 3D object, or \"Viewport\" to place it on a 2D drawing view.\n2.  Set your preferred **Dim Style**, **Rotation**, and **Max Weight** limit.\n3.  Close the Properties Palette to proceed.\n\n### Step 3: Select Location (Based on Mode)\n**If \"Model\" mode is selected:**\n```\nCommand Line: Select a set of elements\nAction: Click on the desired Wall, Floor, or Roof elements in the drawing. Press Enter to confirm.\n```\n*The script will attach a weight label to each selected element.*\n\n**If \"Viewport\" mode is selected:**\n```\nCommand Line: Pick a Point\nAction: Click inside the layout where you want the weight text to appear.\n```\n```\nCommand Line: Select a viewport\nAction: Click on the viewport border that displays the element you wish to label.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Insert in | dropdown | Model | Determines if the label is placed in the 3D Model or a 2D Viewport. |\n| Dim Style | dropdown | <Current> | Selects the text style (font, size) for the weight label from the drawing's dimension styles. |\n| Rotation | number | 0 | Sets the rotation angle of the text label (in degrees). |\n| Max weight | number | 100 | The weight threshold. If the element weight exceeds this value, the text turns red. |\n| Prefix | text | | Custom text added before the weight value (e.g., \"Total: \"). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the weight calculation if the element has been modified. |\n| Erase | Removes the script instance and the weight label. |\n\n## Settings Files\n- **Filename**: `Materials.xml`\n- **Location**: `_kPathHsbCompany\\Abbund\\`\n- **Purpose**: This file maps material names (used in the Element) to density values (kg/m³). The script uses this data to calculate the physical weight of beams, sheets, and structural insulated panels (SIPs).\n\n## Tips\n- **Color Warning:** If the weight text appears red, the element exceeds the \"Max weight\" value set in properties, indicating it may require machinery for lifting.\n- **Unit Support:** The script automatically detects the drawing units. It will calculate and display in **kg** for metric drawings or **lb** for imperial drawings.\n- **Automatic Updates:** If you add or remove beams from a wall, or resize a panel, run the \"Recalculate\" option (or update the element) to refresh the displayed weight.\n- **Element Splitting:** If you split an element (e.g., a wall) into two parts, the script will automatically handle the split, ensuring the correct weight remains assigned to the original part and removing the reference from the new part.\n\n## FAQ\n- **Q: Why does the label show \"Material not found\"?**\n  **A:** The material assigned to a beam or sheet in the element does not exist in the `Materials.xml` file. The script will use a default density if available, or you must add the specific material to the XML file.\n- **Q: Why did the script fail to insert?**\n  **A:** Ensure the `Materials.xml` file exists in the correct company folder (`Abbund`). The script cannot function without the material density definitions.\n- **Q: Can I use this for individual beams?**\n  **A:** No, this script is designed to calculate the total weight of an entire Element (like a Wall or Floor assembly) containing multiple beams and sheets."
      },
      "tokens_used": 6596,
      "error": null
    }
  }
}