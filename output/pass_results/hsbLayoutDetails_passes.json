{
  "filename": "hsbLayoutDetails.mcr",
  "status": "completed",
  "total_tokens": 33437,
  "processing_time": 279.09620475769043,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 3810,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Viewport vp = getViewport(); _Viewport.append(vp); if (_Viewport.length()==0) return; vp.setCoordSys(csMs2Ps);"
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout)",
          "requiredSettings": []
        }
      },
      "tokens_used": 4188,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getViewport\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sScale\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Scale\",\n      \"defaultValue\": \"10:1\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"10:1\",\n        \"8:1\",\n        \"4:1\",\n        \"2:1\",\n        \"1:1\",\n        \"1:2\",\n        \"1:5\",\n        \"1:10\",\n        \"1:20\",\n        \"1:50\",\n        \"1:100\"\n      ],\n      \"category\": null,\n      \"description\": \"Scale of the selected viewport\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimstyle\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"The appearance of all written information is dependent from the dimstyle\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"nDetailNo\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Detail Number\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Numbers the detail when more than one will be used in the same layout\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color\",\n      \"defaultValue\": 251,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Sets the color of the detail information\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sShowForSetup\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Show setup graphics\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": \"Shows a rectangle of 100 drawing units to setup the tsl. Should be turned off after setup.\"\n    }\n  ],\n  \"contextMenu\": [],\n  \"settings"
      },
      "tokens_used": 6824,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates and manages 2D detail viewports in Paper Space, linking them to specific 3D model coordinates or joint details to generate accurate shop drawings.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used when creating manufacturing drawings to zoom into specific connections or wall sections, labeling them with the correct scale and detail number for the factory floor."
        },
        "parameters": [
          {
            "name": "sScale",
            "technicalDefault": "\"10:1\"",
            "businessMeaning": "The zoom ratio of the viewport relative to model size, determining how large the timber components appear on the printed page.",
            "validRange": "10:1 to 1:100 (Standard architectural scales)",
            "unit": "Ratio",
            "affectsOutput": "Adjusts the Model Space to Paper Space transformation matrix of the viewport, zooming the view in or out."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "Current Drawing Dimstyle",
            "businessMeaning": "The visual standard (font, text size, arrowheads) applied to the label text identifying the detail.",
            "validRange": "Any Dimstyle loaded in the CAD template",
            "unit": "Style Name",
            "affectsOutput": "Changes the graphical appearance of the text labels (Detail Number and Scale) drawn in Paper Space."
          },
          {
            "name": "nDetailNo",
            "technicalDefault": "0",
            "businessMeaning": "The ID number that links this viewport label to a specific 3D construction detail or joint defined elsewhere in the model.",
            "validRange": "Integer >= 0",
            "unit": "Count",
            "affectsOutput": "If a match is found in the model's attached TSLs, the viewport centers on that specific detail's location; otherwise, it defaults to a standard position."
          },
          {
            "name": "nColor",
            "technicalDefault": "251",
            "businessMeaning": "The display color of the detail label text in Paper Space.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Changes the color of the generated text entities."
          },
          {
            "name": "sShowForSetup",
            "technicalDefault": "\"No\"",
            "businessMeaning": "A toggle to display a temporary layout guide box to help the user position the detail label correctly during initial setup.",
            "validRange": "Yes/No",
            "unit": "Boolean (String)",
            "affectsOutput": "When 'Yes', draws a reference rectangle and label indicating the viewport boundary. When 'No', hides this helper geometry."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sScale is changed",
            "effect": "Recalculates the zoom level of the viewport. If setup graphics are active, the size of the reference rectangle updates to reflect the new scale.",
            "cascade": [
              "Viewport Zoom",
              "Setup Graphics Size"
            ]
          },
          {
            "trigger": "nDetailNo matches a 3D Detail ID",
            "effect": "The viewport coordinate system is re-aligned to center specifically on the 3D coordinates of that detail.",
            "cascade": [
              "Viewport Center Point",
              "Viewport Rotation"
            ]
          },
          {
            "trigger": "sShowForSetup is set to 'Yes'",
            "effect": "Enables the drawing of the layout helper rectangle and text, which scales according to the sScale parameter.",
            "cascade": [
              "Helper Geometry Visibility"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Viewport",
            "description": "Modifies the view transformation (Center and Scale) of a selected Paper Space viewport to frame a specific model detail.",
            "appliedTo": "Paper Space Layout"
          },
          {
            "type": "Text Annotation",
            "description": "Generates a text label displaying the Detail Number and Scale in Paper Space.",
            "appliedTo": "Paper Space Layout"
          },
          {
            "type": "Polyline (Debug)",
            "description": "Optionally draws a 100-unit rectangle to assist in positioning the script during setup.",
            "appliedTo": "Paper Space Layout"
          }
        ]
      },
      "tokens_used": 5043,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script (hsbLayoutDetails)",
          "2. Show Dialog/Properties Palette (User sets Scale, Detail Number, DimStyle)",
          "3. Prompt: 'Select point' (User picks location for label in Paper Space -> _Pt0)",
          "4. Prompt: 'Select viewport' (User clicks a Viewport entity)",
          "5. Validate Selections (Check if Viewport exists and has a valid Element)",
          "6. Search Element's attached TSLs for 'hsbElementDetails' matching 'nDetailNo'",
          "7. Calculate Viewport Transformation (Model Space to Paper Space) based on Detail search result",
          "8. Update Viewport Zoom/Center",
          "9. Draw Text Label (Detail No & Scale) at _Pt0",
          "10. Draw Setup Graphics (Rectangle & Labels) if 'sShowForSetup' is 'Yes'"
        ],
        "conditionalBranches": [
          {
            "condition": "Does 'nDetailNo' match a detail in 'hsbElementDetails' attached to the element?",
            "path1": {
              "name": "Detail Match Found",
              "steps": [
                "Extract 'ptMid' (Midpoint) from the attached detail script",
                "Calculate new CoordSys: Align Model 'ptMid' to Paper Space 'ptCen' (Viewport Center)",
                "Apply Scale factor (e.g., 10:1) to the transformation",
                "Draw Label: 'Detail No. X Scale: Y:Z' at _Pt0"
              ]
            },
            "path2": {
              "name": "No Detail Match",
              "steps": [
                "Calculate default CoordSys: Align generic Model point (0,0,100000) to Paper Space 'ptCen'",
                "Apply Scale factor of 1:1 (or default) to transformation",
                "Skip drawing the main 'Detail No...' label text",
                "Only draw Setup Graphics if enabled"
              ]
            }
          },
          {
            "condition": "Value of 'sShowForSetup' property",
            "path1": {
              "name": "Yes",
              "steps": [
                "Draw a rectangle in Paper Space representing 100 drawing units (scaled by view scale)",
                "Draw text indicating size and 'Show setup graphics = Yes'",
                "Draw script name at center"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Suppress drawing of the helper rectangle and auxiliary text",
                "Only draw the main Detail label if applicable"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Color Index (nColor) range",
            "errorMessage": "No visible error message, but automatic correction occurs.",
            "recovery": "Script automatically resets nColor to 251 if value is >255 or <-1."
          },
          {
            "check": "Viewport Selection",
            "errorMessage": "Script halts silently or with no geometry generation.",
            "recovery": "User must select a valid Viewport entity during insertion."
          },
          {
            "check": "Element Validity",
            "errorMessage": "Script halts if Viewport is not viewing a valid Element.",
            "recovery": "User must ensure the selected Viewport is linked to a 3D Model Element."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Detail Number (nDetailNo)",
            "how": "OPM (Properties Palette)",
            "effect": "Script re-scans the element for the new Detail ID. If found, the viewport re-centers and zooms to the new detail location; if not, the view defaults."
          },
          {
            "action": "Change Scale (sScale)",
            "how": "OPM (Properties Palette)",
            "effect": "Updates the zoom factor of the viewport. Recalculates the size of the 'Show setup graphics' rectangle if visible."
          },
          {
            "action": "Move Label Location",
            "how": "Grip Edit (Dragging the _Pt0 grip)",
            "effect": "The text label (Detail No/Scale) moves to the new cursor location. The Viewport view itself remains unchanged."
          },
          {
            "action": "Toggle Setup Graphics",
            "how": "OPM (Properties Palette)",
            "effect": "Shows or hides the 100-unit reference rectangle used for aligning the view on the sheet."
          }
        ]
      },
      "tokens_used": 7480,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbLayoutDetails.mcr\n\n## Overview\nThis script creates and manages 2D detail viewports in Paper Space. It automatically zooms a viewport to a specific 3D model detail (defined by a Detail Number) and labels it with the correct scale for shop drawings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script operates only in Paper Space (Layouts). |\n| Paper Space | Yes | Requires an existing viewport to function. |\n| Shop Drawing | Yes | Designed for creating manufacturing details and connection views. |\n\n## Prerequisites\n- **Required Entities**: A valid Viewport in the current Layout that is linked to a 3D Element.\n- **Minimum Beam Count**: 0 (It reads Element data, not individual beams).\n- **Required Settings**: The 3D Element must have the `hsbElementDetails` script attached if you wish to link to specific joint details.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbLayoutDetails.mcr`\n\n### Step 2: Configure Properties\nUpon insertion, the Properties Palette (OPM) will display the script parameters. Adjust the **Scale** (e.g., 10:1) and **Detail Number** before proceeding to ensure the view zooms correctly.\n\n### Step 3: Select Label Location\n```\nCommand Line: (Implicit cursor prompt)\nAction: Click in the Paper Space layout where you want the Detail Label text to appear.\n```\n\n### Step 4: Select Viewport\n```\nCommand Line: Select viewport\nAction: Click on the border of the viewport you wish to control.\n```\n*Note: The script will verify if the selected viewport contains a valid Element. If valid, it will search for the Detail Number.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Scale | dropdown | 10:1 | Sets the zoom level of the viewport (e.g., 10:1 enlarges the view 10 times). |\n| Dimstyle | dropdown | *Current* | The visual style (font, size) applied to the detail label text. |\n| Detail Number | number | 0 | The ID of the 3D detail to zoom into. Must match a detail ID defined in the model's `hsbElementDetails` script. |\n| Color | number | 251 | The AutoCAD color index for the detail label text. |\n| Show setup graphics | dropdown | No | If set to \"Yes\", draws a 100-unit reference rectangle to help position the label. Turn off after finalizing. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Refreshes the script. Use this after changing the Detail Number or Scale in the properties to update the viewport view. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: This script relies on the standard hsbCAD environment and properties defined in the `hsbElementDetails` attached to the model element.\n\n## Tips\n- **Positioning**: Set **Show setup graphics** to \"Yes\" while placing the label. This draws a box representing the drawing area, helping you align the text. Switch it back to \"No\" when you are done.\n- **Linking Details**: Ensure the **Detail Number** in the properties matches the specific detail ID assigned to a joint or component in the 3D model (via `hsbElementDetails`). If they don't match, the viewport may zoom to a default location.\n- **Adjusting Views**: You can grip-edit the label text location in Paper Space without affecting the zoomed view of the viewport.\n\n## FAQ\n- **Q: Why is my viewport showing the wrong part of the model?**\n  A: Check the **Detail Number** property. If it is set to 0 or a number that doesn't exist on the element, the script cannot find the specific detail location to center on.\n- **Q: Can I change the scale after I insert the script?**\n  A: Yes. Select the script in Paper Space, open the Properties Palette, change the **Scale**, and right-click to **Recalculate**.\n- **Q: What does the rectangle appear when I insert?**\n  A: This is the \"Setup Graphics\" (100-unit reference box). Change the **Show setup graphics** property to \"No\" to hide it."
      },
      "tokens_used": 6092,
      "error": null
    }
  }
}