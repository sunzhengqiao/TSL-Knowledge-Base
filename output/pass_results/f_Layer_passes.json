{
  "filename": "f_Layer.mcr",
  "status": "completed",
  "total_tokens": 49778,
  "processing_time": 205.13521909713745,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9214,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script calculates 3D geometry using Body and PlaneProfile objects, and operates on Model Space coordinates (_Pt0, _PtW). While it reads properties from PlotViewports associated with a 'Truck' entity to determine contour thickness, it generates its own display (Layer/Stack visualization) in the 3D model. The summary explicitly mentions showing the stack in 'XY World'."
        },
        "prerequisites": {
          "requiredEntities": [
            "Stackable Items (ChildPanel/TslInst)",
            "Truck Entity (Optional)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "_kPathHsbCompany\\TSL\\Settings\\f_Stacking.xml"
          ]
        }
      },
      "tokens_used": 7350,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dSpacing",
            "type": "PropDouble",
            "displayName": "|Spacing|",
            "defaultValue": 0,
            "inputType": "number",
            "category": "|Nesting|",
            "description": "|Defines the Spacing|",
            "condition": "nDialogmode==1"
          },
          {
            "index": 0,
            "variable": "sNestInOpening",
            "type": "PropString",
            "displayName": "|NestInOpening|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Nesting|",
            "description": "|Defines the NestInOpening|",
            "condition": "nDialogmode==1"
          },
          {
            "index": 1,
            "variable": "dHeightBedding",
            "type": "PropDouble",
            "displayName": "|Height| ",
            "defaultValue": 80,
            "inputType": "number",
            "category": "|Bedding|",
            "description": "|Defines the Height|"
          },
          {
            "index": 2,
            "variable": "sNesterType",
            "type": "PropString",
            "displayName": "|Nester Type|",
            "defaultValue": "|Rectangular Nester|",
            "inputType": "dropdown",
            "options": [
              "|Disabled|",
              "|Autonester|",
              "|Rectangular Nester|"
            ],
            "category": "|Nester|",
            "description": "|Defines the Nester Type|"
          },
          {
            "index": 3,
            "variable": "sRotation",
            "type": "PropString",
            "displayName": "|Rotation|",
            "defaultValue": "|any angle|",
            "inputType": "dropdown",
            "options": [
              "|forbidden|",
              "|90°|",
              "|180°|",
              "|any angle|"
            ],
            "category": "|Nester|",
            "description": null
          },
          {
            "index": 4,
            "variable": "sInformation",
            "type": "PropString",
            "displayName": "|Text|",
            "defaultValue": "",
            "inputType": "text",
            "category": "|Information|",
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Nesting|",
            "handler": "Nesting",
            "action": "Sets DialogMode to 1 to show Nesting properties (Spacing, NestInOpening).",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "f_Stacking.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings"
            ],
            "purpose": "Provides stacking defaults, truck dimensions, and specific company settings (e.g., contour thickness for KLH).",
            "required": true
          }
        ]
      },
      "tokens_used": 7238,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates and manages a stacking 'Layer' of timber panels or elements (packs) in 3D model space, often to visualize how items fit on a transport truck or pallet.",
          "category": "Logistics/Packaging",
          "typicalUseCase": "Planning the loading of prefabricated timber panels onto trucks for transport, ensuring efficient nesting and collision detection."
        },
        "parameters": [
          {
            "name": "dSpacing",
            "technicalDefault": "0",
            "businessMeaning": "The required clearance distance between stacked items when nesting. It ensures there is space for handling, packaging straps, or air circulation between elements.",
            "validRange": "0 to 100 mm (typically 0-50 mm)",
            "unit": "mm",
            "affectsOutput": "Increases the gap between nested elements in the visualized layer, potentially affecting the total number of items that fit in a given area."
          },
          {
            "name": "sNestInOpening",
            "technicalDefault": "|No|",
            "businessMeaning": "Determines whether smaller items are allowed to be placed ('nested') inside the openings (cutouts for windows/doors) of larger items within the stack.",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean/Selection",
            "affectsOutput": "If 'Yes', the script utilizes the empty space within panel cutouts, optimizing packing density. If 'No', items are treated as solid rectangles and cannot overlap with these voids."
          },
          {
            "name": "dHeightBedding",
            "technicalDefault": "80",
            "businessMeaning": "The vertical height of the bedding layer (e.g., timber battens or blocks) placed between the truck floor and the stack, or between stack layers.",
            "validRange": "50 to 150 mm (depending on transportation regulations and beam sizes)",
            "unit": "mm",
            "affectsOutput": "Visually offsets the entire stack layer vertically above the reference point (e.g., truck bed) to represent the physical support materials."
          },
          {
            "name": "sNesterType",
            "technicalDefault": "|Rectangular Nester|",
            "businessMeaning": "Selects the algorithm used to arrange the items within the layer boundaries.",
            "validRange": "|Disabled|, |Autonester|, |Rectangular Nester|",
            "unit": "Selection",
            "affectsOutput": "Controls how the script automatically positions the items. 'Rectangular Nester' aligns items orthogonally, 'Autonester' may attempt more complex fits, and 'Disabled' leaves them in their original relative positions or requires manual placement."
          },
          {
            "name": "sRotation",
            "technicalDefault": "|any angle|",
            "businessMeaning": "Restricts the rotation of items during the nesting process to facilitate handling or respect structural grain direction preferences.",
            "validRange": "|forbidden|, |90°|, |180°|, |any angle|",
            "unit": "degrees/angle logic",
            "affectsOutput": "Limits the orientation options available to the nester, potentially reducing packing efficiency if rotation is restricted."
          },
          {
            "name": "sInformation",
            "technicalDefault": "",
            "businessMeaning": "Custom text annotation added to the layer visualization for labeling purposes.",
            "validRange": "Free text string",
            "unit": "text",
            "affectsOutput": "Displays the custom text in the 3D model view adjacent to the layer info."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Context Menu Item '|Nesting|' executed",
            "effect": "Toggles the Properties Palette to show nesting-specific settings (dSpacing, sNestInOpening) by setting DialogMode to 1.",
            "cascade": [
              "dSpacing",
              "sNestInOpening"
            ]
          },
          {
            "trigger": "sNesterType is set to '|Disabled|'",
            "effect": "Nesting parameters (Spacing, Rotation) are effectively ignored as no automatic arrangement occurs.",
            "cascade": [
              "dSpacing",
              "sRotation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Body (Visualization)",
            "description": "A composite body representing the stacked items, used for interference checking and visual representation of the load.",
            "appliedTo": "The TSL Instance itself (Layer)"
          },
          {
            "type": "PLine (Contour)",
            "description": "A 2D polyline representing the bounding box of the entire layer's footprint, often drawn on the XY plane.",
            "appliedTo": "The TSL Instance"
          },
          {
            "type": "Hatch/Filled Region",
            "description": "A filled region indicating interference (collision) between stacked items or between items and the truck bed.",
            "appliedTo": "The TSL Instance"
          }
        ]
      },
      "tokens_used": 8316,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Execution Started (Insert or Recalculation).",
          "2. Initialize Constants and Load Settings from 'f_Stacking.xml'.",
          "3. Check DialogMode State (stored in Map).",
          "4. [Conditional] Is DialogMode == 1 (Nesting Mode)?",
          "5. [Branch True] Set OPM Key to 'Nesting', expose 'Spacing' and 'NestInOpening' properties, and Exit script.",
          "6. [Branch False] Load Standard Properties (Bedding, Nester Type, Rotation, Information).",
          "7. Collect Child Entities (Stackable Items) and identify Linked Truck.",
          "8. [Conditional] Is Project Special 'KLH'?",
          "9. [Conditional] Is a Linked Truck found?",
          "10. Calculate Geometry: Collect Profiles, Sort by Area, and Detect Interferences.",
          "11. Generate Visuals: Draw Stack Body, Interference Hatching, and Contour.",
          "12. [Conditional] Is Contour Thickness defined in XML?",
          "13. Apply Contour Thickness (Logic differs for KLH vs Standard).",
          "14. Draw Text Info and Set Entity Dependencies.",
          "15. Store Grips (Origin and Truck Alignment) and Map Data."
        ],
        "conditionalBranches": [
          {
            "condition": "User executes 'Nesting' context menu item (sets DialogMode to 1).",
            "path1": {
              "name": "Nesting Mode",
              "steps": [
                "Script detects DialogMode==1.",
                "Sets OPM category to '|Nesting|'.",
                "Displays 'dSpacing' and 'sNestInOpening' properties.",
                "Returns immediately to allow property editing without full recalculation."
              ]
            },
            "path2": {
              "name": "Standard Mode",
              "steps": [
                "Script detects DialogMode!=1.",
                "Displays General, Bedding, and Nester properties.",
                "Proceeds to calculate geometry and visual representation."
              ]
            }
          },
          {
            "condition": "Linked Truck Entity found vs. No Truck.",
            "path1": {
              "name": "Truck Linked",
              "steps": [
                "Calculate transformation from Layer coordinates to Truck coordinates.",
                "Set Grip 1 location relative to truck bed for vertical alignment.",
                "Read PlotViewport from Truck entity for specific contour thickness settings."
              ]
            },
            "path2": {
              "name": "No Truck",
              "steps": [
                "Use World XY coordinate system.",
                "Grip 1 is not created or ignored for alignment.",
                "Ignore Truck-specific settings."
              ]
            }
          },
          {
            "condition": "Project Special variable is 'KLH'.",
            "path1": {
              "name": "KLH Logic",
              "steps": [
                "Skip default PlotViewport contour check.",
                "Write 'L' (Layer separation) to child mapX.",
                "Apply contour thickness purely on the inside of the profile (shrink inner profile)."
              ]
            },
            "path2": {
              "name": "Standard Logic",
              "steps": [
                "Check for PlotViewport on Truck to determine contour validity.",
                "Apply contour thickness centered (shrink outer half, expand inner half)."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Settings file existence at '_kPathHsbCompany\\TSL\\Settings\\f_Stacking.xml'.",
            "errorMessage": "No explicit error message, but defaults may be missing if file is absent.",
            "recovery": "Script attempts to create the 'Settings' folder if missing during insertion; otherwise, it runs with internal hardcoded defaults."
          },
          {
            "check": "Valid Child Entities (ChildPanel or TslInst).",
            "errorMessage": "None explicit, invalid items are skipped.",
            "recovery": "Loop filters out invalid entities; user must ensure correct entities are assigned to the layer."
          },
          {
            "check": "KLH Contour Thickness configuration.",
            "errorMessage": "Contour might not display if 'Thickness' in MapContour is <= 0.",
            "recovery": "User must configure 'Thickness' > 0 in the XML settings or via properties to see the contour visualization."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Nesting Parameters",
            "how": "Context Menu -> '|Nesting|' or Properties Palette",
            "effect": "Switches OPM to show Spacing and NestInOpening properties, allowing adjustment of item arrangement."
          },
          {
            "action": "Move Layer",
            "how": "Grip Edit (Grip 0)",
            "effect": "Translates the entire layer stack in 3D space."
          },
          {
            "action": "Align to Truck Vertically",
            "how": "Grip Edit (Grip 1 - Only visible if Truck is linked)",
            "effect": "Adjusts the vertical position of the layer relative to the truck bed (Z-axis alignment)."
          },
          {
            "action": "Adjust Bedding Height",
            "how": "Properties Palette -> '|Bedding|' -> '|Height|'",
            "effect": "Changes the vertical offset of the stack from its origin (simulates thicker/thinner support battens)."
          },
          {
            "action": "Change Nester Algorithm",
            "how": "Properties Palette -> '|Nester|' -> '|Nester Type|'",
            "effect": "Swaps the layout algorithm (e.g., from Rectangular to Autonester), triggering a re-arrangement of items."
          }
        ]
      },
      "tokens_used": 11030,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# f_Layer\n\n## Overview\nThis script creates and visualizes a stacking \"Layer\" of timber panels or elements in the 3D model. It is primarily used for logistics planning, allowing you to simulate how items fit onto a transport truck or pallet, including automatic nesting (arrangement) and collision detection.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model to visualize the stack. |\n| Paper Space | No | Does not generate 2D shop drawing views directly. |\n| Shop Drawing | No | This is a logistical tool, not a detailing script. |\n\n## Prerequisites\n- **Required Entities**: Stackable Items (ChildPanels or other TslInstances).\n- **Minimum Beam Count**: 0 (This script handles panels and assemblies, not just beams).\n- **Required Settings**: `_kPathHsbCompany\\TSL\\Settings\\f_Stacking.xml` (Required for default truck dimensions and nesting logic).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `f_Layer.mcr` from the list.\n\n### Step 2: Define Location\n```\nCommand Line: Select insert point:\nAction: Click in the Model Space to place the layer origin.\n```\n*(Note: Depending on your hsbCAD configuration, you may be prompted to select the elements to stack immediately after insertion, or you may need to assign them as child entities manually).*\n\n### Step 3: Configure Properties\nSelect the inserted `f_Layer` entity and open the **Properties Palette** (Ctrl+1).\n1.  Under **Nester**, select the **Nester Type** (e.g., \"Rectangular Nester\") to arrange items.\n2.  Under **Bedding**, set the **Height** to simulate the thickness of support battens.\n3.  Use the **Nesting** right-click menu option to access spacing and cutout settings.\n\n### Step 4: Align to Truck (Optional)\nIf you have a truck entity in the model:\n1.  Select the Layer entity.\n2.  Use the **Grip** (usually the second grip) to snap or align the layer vertically to the truck bed height.\n\n## Properties Panel Parameters\n\n| Parameter | Category | Type | Default | Description |\n|-----------|----------|------|---------|-------------|\n| **Spacing** | Nesting | Number | 0 | Defines the clearance distance between stacked items in millimeters. (Only visible when Nesting Mode is active). |\n| **NestInOpening** | Nesting | Dropdown | No | If \"Yes\", allows smaller items to be placed inside the cutouts (openings) of larger items. (Only visible when Nesting Mode is active). |\n| **Height** | Bedding | Number | 80 | The vertical height (mm) of the bedding material (e.g., battens) placed between layers or the truck floor. |\n| **Nester Type** | Nester | Dropdown | Rectangular Nester | Selects the arrangement algorithm: Disabled, Autonester, or Rectangular Nester. |\n| **Rotation** | Nester | Dropdown | any angle | Restricts how items can be rotated during nesting (forbidden, 90°, 180°, any angle). |\n| **Text** | Information | Text | - | Custom text annotation that appears next to the layer in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Nesting** | Switches the Properties Palette to \"Nesting Mode\", revealing the **Spacing** and **NestInOpening** parameters. |\n\n## Settings Files\n- **Filename**: `f_Stacking.xml`\n- **Location**: `_kPathHsbCompany\\TSL\\Settings\\`\n- **Purpose**: Stores project-specific defaults such as truck dimensions, maximum loading heights, and specific nesting rules (e.g., contour thickness for different manufacturers like KLH).\n\n## Tips\n- **Interference Checking**: The script generates a red hatch pattern where stacked items overlap or collide. Use this to ensure your load is physically stable.\n- **Visualizing Gaps**: If items are touching but you need space for straps, right-click the layer and select **Nesting**. Set **Spacing** to 10mm or 20mm, and the stack will update automatically.\n- **Truck Alignment**: Link the layer to a truck entity to use the truck's vertical position as a reference. This is done by selecting the layer and using the specific alignment grip or setting the relationship in the project structure.\n- **Efficiency**: Use the \"Rectangular Nester\" for organized, block-style packing, or \"Autonester\" to try and squeeze more items into the available space.\n\n## FAQ\n- **Q: I cannot see the \"Spacing\" or \"NestInOpening\" properties in the palette.**\n- **A: These are hidden by default. Right-click the `f_Layer` entity in the model and select **Nesting** from the context menu. They will then appear in the Properties Palette.\n\n- **Q: Why is there a red hatched area on my stack?**\n- **A: The red hatch indicates a collision or interference between two items in the stack. You need to adjust the position of the items or increase the spacing to resolve the conflict.\n\n- **Q: How do I change the vertical offset of the whole stack?**\n- **A: Modify the **Height** property under the **Bedding** category in the Properties Palette. This raises or lowers the stack relative to its insertion point."
      },
      "tokens_used": 6630,
      "error": null
    }
  }
}