{
  "filename": "HSB_E-TimberPercentage.mcr",
  "status": "completed",
  "total_tokens": 45457,
  "processing_time": 452.3437931537628,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": 4,\n    \"minorVersion\": 0,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"4.0\",\n      \"date\": \"15/07/2025\",\n      \"author\": \"Robert Pol\",\n      \"changes\": \"Redo tsl using timberpercentagearea tsls\"\n    },\n    {\n      \"version\": \"3.4\",\n      \"date\": \"16/06/2025\",\n      \"author\": \"Robert Pol\",\n      \"changes\": \"Make sure extended properties are maintained\"\n    },\n    {\n      \"version"
      },
      "tokens_used": 8573,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script targets Element entities (Wall/ElementRoof) and uses assignToElementGroup(), which is characteristic of Element-level scripts running in the model. It does not use ShopDrawing specific APIs (Sheet, sd_*) or _Viewport logic. The filename prefix 'HSB_E-' indicates an Element script. It retrieves the element coordinate system (element.coordSys()) and creates TslInst instances attached to the element."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (Must be attached to an Element)",
          "requiredSettings": [
            "TSL script 'HSB_E-TimberPercentageArea' must exist in the catalogs"
          ]
        }
      },
      "tokens_used": 6834,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Shown on Insert if no execute key is used, or on MapIO if a property map exists.",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sProfile",
            "type": "PropString",
            "displayName": "|Profile name(s)|",
            "defaultValue": "|PLINE|",
            "inputType": "text",
            "options": [],
            "category": "|Filter|",
            "description": "|Specify the name of the profile to be used, if empty the zone0 profile will be used, use a ; as delimeter for multiple profiles|"
          },
          {
            "index": 1,
            "variable": "timberPercentageAreaTslCatalog",
            "type": "PropString",
            "displayName": "|Area catalog|",
            "defaultValue": "First available catalog entry",
            "inputType": "dropdown",
            "options": "Retrieved dynamically from TslInst().getListOfCatalogNames",
            "category": "|Filter|",
            "description": "|The Area catalog.| |Use| HSB_E-TimberPercentageArea |to define the catalogs|."
          },
          {
            "index": 2,
            "variable": "sDepth",
            "type": "PropString",
            "displayName": "|Profile depth(s)|",
            "defaultValue": "|-1|",
            "inputType": "text",
            "options": [],
            "category": "|Dimensions|",
            "description": "|Specify the depths of the profiles, if empty or smaller then 0, the center of teh element will be used, use a ; as delimeter for multiple profile depths|"
          },
          {
            "index": 3,
            "variable": "sOverrideZone0",
            "type": "PropString",
            "displayName": "|Override Name Zone 0|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Name|",
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Reset Profiles|",
            "handler": "|Reset Profiles|",
            "action": "Recalculates zones and profiles, deletes existing 'HSB_E-TimberPercentageArea' instances, and regenerates them based on current settings.",
            "alsoTriggeredBy": "_bOnElementConstructed"
          },
          {
            "menuItem": "|Delete|",
            "handler": "|Delete|",
            "action": "Deletes all associated 'HSB_E-TimberPercentageArea' TSL instances and erases the current script instance.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6834,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates and visualizes the ratio of timber volume to total element volume based on specific structural zones or the element net area.",
          "category": "Analysis/Reporting",
          "typicalUseCase": "Used during the design phase to verify the percentage of solid timber material within a wall or roof element (e.g., for fire resistance calculations, carbon footprint estimation, or structural efficiency checks)."
        },
        "parameters": [
          {
            "name": "sProfile",
            "technicalDefault": "|PLINE|",
            "businessMeaning": "Filter to select specific structural zones (stored as ZoneAreas) within the element to include in the calculation. It allows targeting specific layers or groups (like studs) rather than the whole wall.",
            "validRange": "Names of existing ZoneArea profiles in the element; multiple names can be separated by a semicolon (;).",
            "unit": "Text",
            "affectsOutput": "Determines which specific profiles trigger the creation of a calculation instance. If empty, defaults to the element's net outline (Zone 0)."
          },
          {
            "name": "timberPercentageAreaTslCatalog",
            "technicalDefault": "First available catalog entry",
            "businessMeaning": "Selects the visual style preset (defined in the 'HSB_E-TimberPercentageArea' script) to be used for displaying the resulting area and percentage labels.",
            "validRange": "List of catalog entries defined in the 'HSB_E-TimberPercentageArea' script.",
            "unit": "Catalog Name",
            "affectsOutput": "Controls the graphical appearance (layer, color, text size, etc.) of the percentage labels generated by the child script."
          },
          {
            "name": "sDepth",
            "technicalDefault": "|-1|",
            "businessMeaning": "Defines the thickness (depth) of the timber profile to use for volume calculation. If the profile depth in the element map is incorrect or missing, this overrides it.",
            "validRange": "-1 (use default/center) or a positive number representing the timber depth in millimeters. Multiple depths can be separated by semicolons to match multiple profiles.",
            "unit": "mm",
            "affectsOutput": "Directly impacts the calculated volume (Area * Depth) and thus the final percentage value. If -1, the script attempts to use the element center or existing profile data."
          },
          {
            "name": "sOverrideZone0",
            "technicalDefault": "",
            "businessMeaning": "Allows renaming of the default 'Zone 0' profile label when no other specific profiles are found or selected.",
            "validRange": "Any text string.",
            "unit": "Text",
            "affectsOutput": "Updates the text label associated with the default element contour calculation."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sProfile or sDepth changes",
            "effect": "The user must trigger 'Reset Profiles' to delete old calculation instances and generate new ones reflecting the filters.",
            "cascade": [
              "TslInst Generation",
              "Volume Calculation"
            ]
          },
          {
            "trigger": "Element Geometry Changes",
            "effect": "The script detects element reconstruction (_bOnElementConstructed) and automatically regenerates calculation zones.",
            "cascade": [
              "Area Recalculation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInst",
            "description": "Spawns child instances of 'HSB_E-TimberPercentageArea' which perform the actual area calculation and text labeling for each valid profile zone.",
            "appliedTo": "Element (Wall/ElementRoof)"
          },
          {
            "type": "Visualization Symbol",
            "description": "Draws a 3D symbol and plan view leader lines indicating the anchor point of the calculation script on the element.",
            "appliedTo": "Element"
          }
        ]
      },
      "tokens_used": 8296,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initialization",
          "Event Handling: Check for dbCreated, MapIO, or ElementDeletion",
          "Branch: Insert Mode (_bOnInsert)",
          "Check insertCycleCount (Erase if > 1)",
          "Check ExecuteKey: If catalog exists, load properties; else, show Dialog",
          "Prompt User for Entity Selection (PrEntity)",
          "Loop through selected elements: Remove existing script instances, create new attached TslInst using dbCreate",
          "Erase temporary insertion instance",
          "Branch: Attached Mode (Normal Execution)",
          "Validate Element Reference (Erase if missing)",
          "Check Trigger: Is it a Regeneration Event? (_bOnElementConstructed OR 'Reset Profiles')",
          "Cleanup: Delete all existing child 'HSB_E-TimberPercentageArea' instances and duplicate self",
          "Parse Input Properties: Tokenize 'sProfile' and 'sDepth' strings",
          "Geometry Analysis: Query Element SubMapX ('ZoneArea[]')",
          "Branch: Profile Matching Logic",
          "Result: Generate 'profilesMap' containing rings and depths",
          "Loop through profilesMap: Create child 'HSB_E-TimberPercentageArea' instances via dbCreate",
          "Branch: Deletion Event? (_kExecuteKey == 'Delete')",
          "Visualization: Draw 3D and Plan view symbols at Element origin",
          "End"
        ],
        "conditionalBranches": [
          {
            "condition": "Profile Name Matching (During Reset/Construct)",
            "path1": {
              "name": "Specific Profiles Found",
              "steps": [
                "Iterate through Element's ZoneArea map",
                "Check if Zone name exists in 'sProfile' property",
                "Extract Polylines (rings/openings) for matching zones",
                "Assign corresponding depth from 'sDepth' list",
                "Create child TslInst for each specific profile"
              ]
            },
            "path2": {
              "name": "No Profiles Found (Default)",
              "steps": [
                "Check if 'profilesMap' is empty",
                "Retrieve Element Netto Profile (Zone 0) or Envelope",
                "Assign depth from first entry in 'sDepth' or default",
                "Rename profile to 'sOverrideZone0' if provided",
                "Create single child TslInst for Zone 0"
              ]
            }
          },
          {
            "condition": "Insertion Method (_bOnInsert)",
            "path1": {
              "name": "Catalog/Macro Insert",
              "steps": [
                "Detect _kExecuteKey",
                "Set properties from catalog entry matching the key"
              ]
            },
            "path2": {
              "name": "Manual Insert",
              "steps": [
                "No _kExecuteKey found or no match",
                "Execute showDialog()",
                "Wait for user input in properties palette"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases itself if insertCycleCount > 1 to prevent duplicate prompts."
          },
          {
            "check": "Element Reference Existence",
            "errorMessage": "Element reference not found.",
            "recovery": "Script erases itself. User must re-insert and select a valid Element."
          },
          {
            "check": "Zone 0 Area Validity",
            "errorMessage": "None",
            "recovery": "If element.profNetto(0) area is near zero, script automatically falls back to element.plEnvelope()."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Calculation Parameters",
            "how": "OPM Properties (Edit sProfile, sDepth, etc.)",
            "effect": "Changes are stored but visualization does not update until 'Reset Profiles' is triggered."
          },
          {
            "action": "Recalculate Geometry",
            "how": "Context Menu -> 'Reset Profiles'",
            "effect": "Deletes old child instances, re-analyzes element zones, and generates new child TSLs based on current properties."
          },
          {
            "action": "Remove Script",
            "how": "Context Menu -> 'Delete' or Erase command",
            "effect": "Deletes all child 'HSB_E-TimberPercentageArea' instances and removes the main script instance from the element."
          },
          {
            "action": "Element Modification",
            "how": "Modify Element Geometry (e.g., resize wall, add opening)",
            "effect": "Triggers _bOnElementConstructed, automatically regenerating zones and child instances if a property map exists."
          }
        ]
      },
      "tokens_used": 9414,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-TimberPercentage.mcr\n\n## Overview\nThis script calculates and visualizes the percentage of timber volume within a wall or roof element. It filters specific structural zones (profiles) to determine the solid timber ratio and displays the result as text labels in the model.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Must be attached to an Element (Wall/ElementRoof). |\n| Paper Space | No | Not intended for layout views. |\n| Shop Drawing | No | Not intended for manufacturing views. |\n\n## Prerequisites\n- **Required Entities**: An existing Wall or Roof Element in the drawing.\n- **Minimum Beam Count**: N/A (Target is an Element).\n- **Required Settings**: The TSL script `HSB_E-TimberPercentageArea` must exist in your hsbCAD catalogs to display the labels.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Select `HSB_E-TimberPercentage.mcr` from the file dialog.\n\n### Step 2: Select Element\n```\nCommand Line: Select element(s)\nAction: Click on the Wall or Roof element you wish to analyze. You can select multiple elements.\n```\n\n### Step 3: Configure Parameters (Optional)\nAction: Press `Esc` to finish selection. Select the script instance (or the element) and open the **Properties Palette** (Ctrl+1).\n- Adjust filters like **Profile name(s)** or **Profile depth(s)** as needed.\n\n### Step 4: Generate Labels\nAction: Right-click on the script instance and select **Reset Profiles**.\n*Note: Changing properties in the palette does not automatically update the view until \"Reset Profiles\" is clicked.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Profile name(s)** | Text | `PLINE` | Specify the names of the structural zones (ZoneAreas) to include. If empty, the element's net outline is used. Use a semicolon (;) to separate multiple names. |\n| **Area catalog** | Dropdown | First available | Selects the visual style preset (defined in the Area script) for the labels. |\n| **Profile depth(s)** | Text | `-1` | Sets the timber thickness (in mm) for volume calculation. Enter `-1` to use the default/element center depth. Use semicolons to match multiple profiles. |\n| **Override Name Zone 0** | Text | *Empty* | Allows you to rename the default label text if no specific profiles are found. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Reset Profiles** | Recalculates the zones and deletes old labels, regenerating them based on the current property settings. Use this after changing parameters. |\n| **Delete** | Removes all percentage labels and deletes the script instance from the element. |\n\n## Settings Files\n- **Catalog Entry**: `HSB_E-TimberPercentageArea`\n- **Location**: hsbCAD TSL Catalogs\n- **Purpose**: This script is a dependency that handles the actual drawing of the text and visual indicators for the calculated areas.\n\n## Tips\n- **Multiple Profiles**: You can target several different timber layers at once by typing their names separated by semicolons (e.g., `Stud;TopPlate`).\n- **Depths Matching**: If you specify multiple profile names, ensure the **Profile depth(s)** also match the count or order if specific depths are required, otherwise leave it as `-1`.\n- **Auto-Update**: If you change the geometry of the element (e.g., stretch a wall), the labels will automatically regenerate (if a property map exists). However, changing script properties requires a manual \"Reset Profiles\".\n\n## FAQ\n- **Q: I changed the profile name in the properties, but the label didn't update. Why?**\n  A: You must right-click the script instance and select **Reset Profiles** to apply property changes to the generated labels.\n- **Q: What does the depth \"-1\" do?**\n  A: It tells the script to ignore a manual thickness and calculate based on the existing profile data or the element's center axis.\n- **Q: Can I use this on a generic beam?**\n  A: No, this script is designed specifically for hsbCAD Elements (Walls or Roofs)."
      },
      "tokens_used": 5506,
      "error": null
    }
  }
}