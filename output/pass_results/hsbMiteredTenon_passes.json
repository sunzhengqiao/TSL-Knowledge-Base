{
  "filename": "hsbMiteredTenon.mcr",
  "status": "completed",
  "total_tokens": 49597,
  "processing_time": 260.9189965724945,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8676,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script operates on 3D geometry using PrEntity to select Beams and adds Mortise tools directly to the beam bodies (bm0.addTool, bm1.addTool). No 'sd_' prefix, _Viewport, or _Entity[] usage detected."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 6137,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select 1 or 2 beam(s)",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Select insertion point for the tenon connection.",
              "condition": "_bOnInsert && _Beam.length() == 1",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (if _kExecuteKey is empty)",
            "title": "Script Properties",
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "Width",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the Width"
          },
          {
            "index": 1,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "Depth",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the Depth"
          },
          {
            "index": 1,
            "variable": "sShape",
            "type": "PropString",
            "displayName": "Shape",
            "defaultValue": "Rectangular",
            "inputType": "dropdown",
            "options": [
              "Rectangular",
              "Round",
              "Rounded"
            ],
            "category": "Geometry",
            "description": "Defines the Shape"
          },
          {
            "index": 2,
            "variable": "dOff1",
            "type": "PropDouble",
            "displayName": "Offset 1",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the Off1"
          },
          {
            "index": 3,
            "variable": "dOff2",
            "type": "PropDouble",
            "displayName": "Offset 2",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the Off2"
          },
          {
            "index": 4,
            "variable": "dOffsetAxis",
            "type": "PropDouble",
            "displayName": "Offset from Axis",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the OffsetAxis"
          },
          {
            "index": 3,
            "variable": "sOrientation",
            "type": "PropString",
            "displayName": "Orientation",
            "defaultValue": "Parellel to female beam",
            "inputType": "dropdown",
            "options": [
              "Parellel to female beam",
              "Perpendicular to female beam"
            ],
            "category": "Alignment",
            "description": "Defines the Orientation"
          },
          {
            "index": 5,
            "variable": "dToleranceLengthLeft",
            "type": "PropDouble",
            "displayName": "Left",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Tolerance",
            "description": "Defines the tolerance on the left side"
          },
          {
            "index": 6,
            "variable": "dToleranceLengthRight",
            "type": "PropDouble",
            "displayName": "Right",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Tolerance",
            "description": "Defines the tolerance on the right side"
          },
          {
            "index": 7,
            "variable": "dGap",
            "type": "PropDouble",
            "displayName": "Tolerance on depth",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Tolerance",
            "description": "Defines the tolerance in depth"
          },
          {
            "index": 8,
            "variable": "dGapLength",
            "type": "PropDouble",
            "displayName": "Gap on length",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Tolerance",
            "description": "Defines the gap on length"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Flip Side",
            "handler": "|Flip Side|",
            "action": "Swaps the two beams selected (index 0 and 1)",
            "alsoTriggeredBy": "Double-click (TslDoubleClick)"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 7521,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation of timber tenon joints (mortise and tenon), supporting both mitred and parallel beam connections with configurable geometry and machining tolerances.",
          "category": "Joinery/Machining",
          "typicalUseCase": "Connecting two timber beams in timber frame construction where a solid wood joint is required, such as post-to-beam or rafter-to-plate connections."
        },
        "parameters": [
          {
            "name": "dWidth",
            "technicalDefault": "0",
            "businessMeaning": "The width of the tenon (the thickness of the tongue). This should generally match the thickness of the material receiving the tenon.",
            "validRange": "30mm - 150mm",
            "unit": "mm",
            "affectsOutput": "Controls the width of the cut on both the male (tenon) and female (mortise) beams."
          },
          {
            "name": "dDepth",
            "technicalDefault": "0",
            "businessMeaning": "The length of the tenon (how far it penetrates into the female beam).",
            "validRange": "20mm - Beam Depth",
            "unit": "mm",
            "affectsOutput": "Determines the penetration depth of the joint into the female beam and the length of the tenon on the male beam."
          },
          {
            "name": "sShape",
            "technicalDefault": "Rectangular",
            "businessMeaning": "The profile of the corners of the tenon/mortise.",
            "validRange": "Rectangular, Round, Rounded",
            "unit": "enum",
            "affectsOutput": "Changes the tooling path from sharp corners to fully rounded or filleted corners."
          },
          {
            "name": "dOff1",
            "technicalDefault": "0",
            "businessMeaning": "Setback distance from the start of the connection area to the start of the tenon.",
            "validRange": "0mm - Beam Length",
            "unit": "mm",
            "affectsOutput": "Slides the tenon position along the beam axis relative to one side."
          },
          {
            "name": "dOff2",
            "technicalDefault": "0",
            "businessMeaning": "Setback distance from the end of the connection area to the end of the tenon.",
            "validRange": "0mm - Beam Length",
            "unit": "mm",
            "affectsOutput": "Slides the tenon position along the beam axis relative to the other side, effectively controlling placement length."
          },
          {
            "name": "dOffsetAxis",
            "technicalDefault": "0",
            "businessMeaning": "Additional translation of the tenon along the joint's primary axis.",
            "validRange": "-50mm - 50mm",
            "unit": "mm",
            "affectsOutput": "Fine-tunes the center position of the tenon along the intersection line."
          },
          {
            "name": "sOrientation",
            "technicalDefault": "Parellel to female beam",
            "businessMeaning": "Determines if the tenon width is parallel or perpendicular to the female beam's axis.",
            "validRange": "Parellel to female beam, Perpendicular to female beam",
            "unit": "enum",
            "affectsOutput": "Rotates the tenon profile by 90 degrees, essential for aligning the joint correctly relative to grain direction or beam layout."
          },
          {
            "name": "dToleranceLengthLeft",
            "technicalDefault": "0",
            "businessMeaning": "Clearance (play) added to the left side of the mortise.",
            "validRange": "0mm - 3mm",
            "unit": "mm",
            "affectsOutput": "Enlarges the female mortise opening on one side to ensure assembly fit."
          },
          {
            "name": "dToleranceLengthRight",
            "technicalDefault": "0",
            "businessMeaning": "Clearance (play) added to the right side of the mortise.",
            "validRange": "0mm - 3mm",
            "unit": "mm",
            "affectsOutput": "Enlarges the female mortise opening on the opposite side to ensure assembly fit."
          },
          {
            "name": "dGap",
            "technicalDefault": "0",
            "businessMeaning": "Tolerance added to the depth of the mortise (gap at the bottom of the hole).",
            "validRange": "0mm - 5mm",
            "unit": "mm",
            "affectsOutput": "Ensures the male tenon does not bottom out against the female beam."
          },
          {
            "name": "dGapLength",
            "technicalDefault": "0",
            "businessMeaning": "Tolerance added to the length of the cut.",
            "validRange": "0mm - 5mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the total length of the mortise pocket and tenon cut to account for saw kerf or movement."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sOrientation",
            "effect": "Swaps the vector definitions for the mortise profile, effectively rotating the joint geometry 90 degrees.",
            "cascade": [
              "dWidth",
              "dDepth"
            ]
          },
          {
            "trigger": "dOff1 + dOff2",
            "effect": "These offsets are subtracted from the beam depth to calculate the final 'dLength' of the tenon.",
            "cascade": [
              "dLength"
            ]
          },
          {
            "trigger": "dGapLength",
            "effect": "Added to the depth of the female mortise and the 'virtual' depth of the male tool for calculation.",
            "cascade": [
              "msMale",
              "msFemale"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mortise",
            "description": "A solid wood joint (Tenon) added to the first beam (Male) and a pocket (Mortise) subtracted from the second beam (Female).",
            "appliedTo": "Beam 0 (Male), Beam 1 (Female)"
          },
          {
            "type": "Cut",
            "description": "If dimensions are invalid (e.g., negative length), the script falls back to a simple planar cut at the intersection.",
            "appliedTo": "Beam 0, Beam 1"
          },
          {
            "type": "Display Lines",
            "description": "Visual markers indicating the location and depth of the tenon in the 3D model.",
            "appliedTo": "Model Space (Annotation)"
          }
        ]
      },
      "tokens_used": 8972,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"Start Script Insertion (_bOnInsert)\",\n    \"Check for execution key (_kExecuteKey)\",\n    \"[Conditional] Load properties from Catalog or show Properties Dialog\",\n    \"Prompt user to Select 1 or 2 Beams (PrEntity)\",\n    \"[Conditional] Branch based on beam count (1 vs 2)\",\n    \"Calculate initial insertion point (_Pt0)\",\n    \"End Insertion Phase (Return)\",\n    \"Start Recalculation Phase (_bOnRecalc)\",\n    \"Validate minimum beam count (must be >= 2)\",\n    \"Determine beam relationship (Parallel vs Mitered)\",\n    \"[Conditional] Calculate intersection geometry\",\n    \"Construct and validate common area profile between beams\",\n    \"Apply offsets and orientation settings to coordinate system\",\n    \"Validate Tenon fit against beam cross-section\",\n    \"[Conditional] Check dimensions (Width, Depth, Length)\",\n    \"Generate Machining Tools (Mortise/Cut)\",\n    \"Add Display Lines\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Beam Selection Count during Insertion\",\n      \"path1\": {\n        \"name\": \"Single Beam (Split)\",\n        \"steps\": [\n          \"User selects 1 beam\",\n          \"Prompt for insertion point on beam (getPoint)\",\n          \"Script splits the selected beam at that point (dbSplit)\",\n          \"Second segment is added to the beam set\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Two Beams (Existing)\",\n        \"steps\": [\n          \"User selects 2 beams\",\n          \"Script calculates midpoint between beam centers\",\n          \"Insertion point is derived from beam geometry\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Geometric Relationship (bIsParallel)\",\n      \"path1\": {\n        \"name\": \"Mitered Connection\",\n        \"steps\": [\n          \"Calculate intersection of Line(Beam0) and Plane(Beam1)\",\n          \"Set Coordinate System X-axis as bisector of beam angles\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Parallel Connection\",\n        \"steps\": [\n          \"Project closest point onto beam centerline\",\n          \"Set Coordinate System Z-axis to align with beam axis\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Dimension Validity (Width, Depth, Length > 0)\",\n      \"path1\": {\n        \"name\": \"Valid Joint Creation\",\n        \"steps\": [\n          \"Create Male Tenon tool on Beam 0\",\n          \"Create Female Mortise tool on Beam 1\",\n          \"Script remains persistent in model\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Invalid/Fallback\",\n        \"steps\": [\n          \"Create simple Cut planes on both beams\",\n          \"Erase Script Instance (Self-destruct after cut)\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Beam Set Size\",\n      \"errorMessage\": \"This tool requires at least two beams. Tool will be deleted.\",\n      \"recovery\": \"Ensure at least two beams are selected before inserting, or select 1 beam and allow it to split.\"\n    },\n    {\n      \"check\": \"Common Intersection Area\",\n      \"errorMessage\": \"There is no solution for creating a tenon on these two beams.\",\n      \"recovery\": \"Move beams closer together or adjust their rotation so their volumes intersect.\"\n    },\n    {\n      \"check\": \"Tenon Profile Fit\",\n      \"errorMessage\": \"Tenon cannot be created on this cutting edge.\",\n      \"recovery\": \"Reduce the Width, Depth, or Offsets of the tenon so it fits within the overlapping cross-section of the beams.\"\n    }\n  ],\n  \"postInsertionActions\": [\n    {\n      \"action\": \"Flip Side\",\n      \"how\": \"Right-click Context Menu ('Flip Side') or Double-click\",\n      \"effect\": \"Swaps Beam 0"
      },
      "tokens_used": 11500,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbMiteredTenon.mcr\n\n## Overview\nThis script automates the creation of timber tenon joints (mortise and tenon) for connecting two beams. It supports both mitred and parallel connections, allowing users to define geometry, offsets, and machining tolerances for precise wood-to-wood joints.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D beam entities. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities**: \n  - 2 Beams (existing), OR\n  - 1 Beam (which the script will split into two segments at the insertion point).\n- **Minimum Beam Count**: 1 (Script will split it) or 2.\n- **Required Settings**: None specific (uses standard hsbCAD settings).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbMiteredTenon.mcr` from the file dialog.\n\n### Step 2: Select Beams\n```\nCommand Line: Select 1 or 2 beam(s)\nAction: Click on the beams you wish to connect.\n```\n- **Option A**: Select two existing beams that intersect or meet.\n- **Option B**: Select a single beam that you want to split and join.\n\n### Step 3: Define Split Point (If only 1 beam selected)\n```\nCommand Line: Select insertion point for the tenon connection.\nAction: Click on the selected beam where you want the joint to occur.\n```\n*Note: The script will automatically split the single beam into two segments at this location.*\n\n### Step 4: Configure Parameters\nThe Properties Palette will appear automatically. Adjust the dimensions, orientation, and tolerances as needed. The joint updates in real-time.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Geometry** | | | |\n| Width | Number | 0 | The width (thickness) of the tenon tongue. |\n| Depth | Number | 0 | The length of the tenon (penetration depth into the female beam). |\n| Shape | Dropdown | Rectangular | Profile of the tenon corners: Rectangular, Round, or Rounded. |\n| **Alignment** | | | |\n| Offset 1 | Number | 0 | Setback distance from the start of the tenon. |\n| Offset 2 | Number | 0 | Setback distance from the end of the tenon. |\n| Offset from Axis | Number | 0 | Additional translation of the tenon along the joint axis. |\n| Orientation | Dropdown | Parellel to female beam | Sets the tenon rotation relative to the female beam (Parallel or Perpendicular). |\n| **Tolerance** | | | |\n| Left | Number | 0 | Clearance (play) added to the left side of the mortise. |\n| Right | Number | 0 | Clearance (play) added to the right side of the mortise. |\n| Tolerance on depth | Number | 0 | Gap added to the depth of the mortise (prevents bottoming out). |\n| Gap on length | Number | 0 | Tolerance added to the length of the cut (accounts for saw kerf). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side | Swaps the roles of the two beams. The beam containing the tenon becomes the mortise beam, and vice versa. |\n\n## Settings Files\n- **Filename**: None specified.\n- **Location**: N/A\n- **Purpose**: This script relies on manual entry via the Properties Palette; no external settings file is required.\n\n## Tips\n- **Splitting Beams**: If you need to create a joint in the middle of a long continuous beam, select only that single beam during insertion. The script will prompt you to pick a split point.\n- **Orientation**: Use the **Orientation** property if the tenon is being cut in the wrong direction relative to the grain or layout.\n- **Tolerances**: If the joint is too tight for physical assembly, increase the **Tolerance on depth** or **Left/Right** values to create necessary clearance.\n- **Visualizing**: The script draws display lines in the model to show exactly where the tenon starts and ends.\n\n## FAQ\n- **Q: Why did the script disappear after I inserted it?**\n  A: The script requires two beams to intersect properly to create a valid tenon. If the beams do not overlap correctly or if the resulting tenon dimensions are invalid (e.g., negative length), the script will self-destruct. Ensure your beams intersect with sufficient volume.\n  \n- **Q: The tenon is on the wrong beam. How do I fix it without deleting and redoing it?**\n  A: Right-click on the script instance in the model (or select the script entity) and choose **Flip Side** from the context menu. You can also double-click the script to trigger this action.\n\n- **Q: Can I use this on non-90 degree connections?**\n  A: Yes, the script is designed to handle both parallel (in-line) and mitred (angled) connections. It automatically calculates the intersection geometry."
      },
      "tokens_used": 6791,
      "error": null
    }
  }
}