{
  "filename": "StackSequencer.mcr",
  "status": "completed",
  "total_tokens": 48721,
  "processing_time": 412.53189277648926,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates production sequence lines with arrows which indicate the sequence.",
        "versionHistory": [
          {
            "version": "1.06",
            "date": "13.01.2021",
            "author": "AS",
            "changes": "Assign to tooling layer of floorgroup from reference element."
          },
          {
            "version": "1.05",
            "date": "31.10.2019",
            "author": "AS",
            "changes": "Rename to StackSequencer."
          },
          {
            "version": "1.04",
            "date": "30.10.2019",
            "author": "AS",
            "changes": "Add option to resequence stacks"
          },
          {
            "version": "1.03",
            "date": "30.10.2019",
            "author": "AS",
            "changes": "Also make existing stacks a stacking parent."
          },
          {
            "version": "1.02",
            "date": "18.09.2019",
            "author": "AS",
            "changes": "Make this tsl a stacking parent."
          },
          {
            "version": "1.01",
            "date": "18.07.2019",
            "author": "AS",
            "changes": "Add options to 'Add', 'Remove' and 'Resequece' items."
          },
          {
            "version": "1.00",
            "date": "16.07.2019",
            "author": "AS",
            "changes": "Drawsequence as profile."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7497,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses _kModelSpace consistently for collecting entities (e.g., Group().collectEntities(true, Entity(), _kModelSpace) and tslNew.dbCreate(..., _kModelSpace, ...)). It manipulates TslInst and Element entities in the 3D model to draw production sequence indicators (lines/arrows). There are no references to Viewport, sd_ prefixes, or Paper Space contexts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script requires Elements to be present in the Model Space that contain specific MapX keys (specifically keys starting with 'HSB_' and ending with 'CHILD' where the type is 'STACKING') to function fully. Without these elements, the script may run but generate no output.",
          "requiredSettings": []
        }
      },
      "tokens_used": 5719,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "Add elements",
            "handler": "addElementsCommand",
            "action": "Prompts the user to select elements (PrEntity prompt: 'Select elements to add'). Adds selected elements to the current sequence.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove elements",
            "handler": "removeElementsCommand",
            "action": "Prompts the user to select elements (PrEntity prompt: 'Select elements to remove'). Removes selected elements from the current sequence.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Resequence elements",
            "handler": "resequenceElementsCommand",
            "action": "Prompts the user to select elements (PrEntity prompt: 'Select elements to resequence'). Updates the sequence order based on the selection.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Resequence stacks",
            "handler": "resequenceStacksCommand",
            "action": "Prompts the user to select stacks (PrEntity prompt: 'Select stacks to resequence'). Updates the sequence numbering of the stack parents.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9199,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and manages visual production sequence indicators (arrows and lines) to define the assembly order of timber elements within a stack.",
          "category": "Production Management",
          "typicalUseCase": "Used in the 3D model to visually indicate the order in which stacked wall or floor panels should be assembled or processed on the production line."
        },
        "parameters": [
          {
            "name": "Add elements",
            "technicalDefault": "N/A (Action)",
            "businessMeaning": "Appends selected timber elements to the end of the current stack sequence, assigning them the next available sequence number.",
            "validRange": "1 or more selected Elements",
            "unit": "count",
            "affectsOutput": "Extends the visual production line to include the new elements and updates the geometry path."
          },
          {
            "name": "Remove elements",
            "technicalDefault": "N/A (Action)",
            "businessMeaning": "Detaches selected elements from the current stack sequence, effectively removing them from the visual grouping and resetting their sequence data.",
            "validRange": "1 or more selected Elements currently in the sequence",
            "unit": "count",
            "affectsOutput": "Shortens or removes the visual line segments connected to the removed elements and renumbers remaining items."
          },
          {
            "name": "Resequence elements",
            "technicalDefault": "N/A (Action)",
            "businessMeaning": "Reorders the elements within the stack based on the user's new selection order, changing the physical assembly path.",
            "validRange": "1 or more selected Elements",
            "unit": "count",
            "affectsOutput": "Redraws the connecting lines and arrows between elements to reflect the new assembly order."
          },
          {
            "name": "Resequence stacks",
            "technicalDefault": "N/A (Action)",
            "businessMeaning": "Changes the global production number of the stack itself (e.g., changing Stack 5 to Stack 1) relative to other stacks in the model.",
            "validRange": "1 or more selected StackSequencer TSL instances",
            "unit": "count",
            "affectsOutput": "Updates the internal MapX data for the stack sequence number; used by labeling scripts to indicate priority."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Execution of any Context Menu command (Add, Remove, Resequence)",
            "effect": "Forces a full script recalculation by erasing the current instance and re-running the insert logic to rebuild the entire geometry based on the new state.",
            "cascade": [
              "pointsArray",
              "Element list",
              "Hsb_StackingParent MapX"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PlaneProfile (3D Geometry)",
            "description": "A graphical representation consisting of lines, circles (at element positions), and directional arrows indicating the production flow.",
            "appliedTo": "Model Space (drawn at the mid-points of the elements in the sequence)"
          },
          {
            "type": "Text",
            "description": "The Parent UID (Stack ID) label displayed at the start of the sequence.",
            "appliedTo": "Model Space (at the first element location)"
          }
        ]
      },
      "tokens_used": 9681,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"Script is inserted or triggered via context menu action (Add/Remove/Resequence)\",\n    \"Check 'insertCycleCount': If > 1, erase instance and stop (prevents infinite loops)\",\n    \"Enter 'OnInsert' Mode: Collect all entities from ModelSpace\",\n    \"Filter entities: Identify Elements with MapX keys matching 'HSB_..._CHILD' of type 'STACKING'\",\n    \"Extract Data: Parent UID, Sequence Number, and Reference Point (Midpoint) for each valid element\",\n    \"Sort Elements: Primary sort by Parent UID, Secondary sort by Sequence Number\",\n    \"Clean Up: Erase any existing TslInst of this script (StackSequencer) in the model\",\n    \"Group and Create Instances: Loop through sorted elements; detect changes in Parent UID to define stack groups\",\n    \"For each stack group: Create a new TslInst, store coordinate points in MapX, set Parent info, and assign a global Stack Sequence number\",\n    \"Erase the initial 'trigger' instance\",\n    \"New Instance Initialization: Load MapX data (points, UID)\",\n    \"MapX Verification: Ensure 'MyUID' exists in the Stack Parent MapX; if missing, calculate and assign the next available stack index\",\n    \"Drawing Execution: Generate visual geometry (Circles, Connecting Lines, Arrows, Text) based on stored points\",\n    \"Layer Assignment: Assign visual elements to the Tooling layer of the reference element's floor group\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"User Right-Click Context Menu Selection\",\n      \"path1\": {\n        \"name\": \"Add elements\",\n        \"steps\": [\n          \"Prompt user to select Elements ('Select elements to add')\",\n          \"Determine the next available sequence number from current elements\",\n          \"Assign Parent UID and new Sequence Number to selected elements via MapX\",\n          \"Append new elements to the internal list\",\n          \"Trigger refreshDrawProductionSequence (Global Recalc)\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Remove elements\",\n        \"steps\": [\n          \"Prompt user to select Elements ('Select elements to remove')\",\n          \"Clear grouping MapX data from selected elements (remove from stack)\",\n          \"Trigger refreshDrawProductionSequence (Global Recalc)\"\n        ]\n      },\n      \"path3\": {\n        \"name\": \"Resequence elements\",\n        \"steps\": [\n          \"Prompt user to select Elements ('Select elements to resequence')\",\n          \"Assign new sequence numbers: Selected items first (in order of selection), followed by existing unselected items\",\n          \"Update Element MapX with new sequence numbers\",\n          \"Trigger refreshDrawProductionSequence (Global Recalc)\"\n        ]\n      },\n      \"path4\": {\n        \"name\": \"Resequence stacks\",\n        \"steps\": [\n          \"Collect all StackSequencer TSL instances and sort by current sequence\",\n          \"Prompt user to select Stacks ('Select stacks to resequence')\",\n          \"Renumber selected stacks starting from 0\",\n          \"Renumber remaining stacks continuing from the last selected index\",\n          \"Force recalculation of 'Batch & Stack Info' scripts\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Global Refresh Trigger (refreshDrawProductionSequence == true)\",\n      \"path1\": {\n        \"name\": \"Execute Refresh\",\n        \"steps\": [\n          \"Create a temporary new instance of the script with 'OnInsert' argument\",\n          \"Recalculate associated info scripts (Batch & Stack Info)\",\n          \"Erase current instance\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Insert Cycle Count\",\n      \"errorMessage\": \"None (Silent abort)\",\n      \"recovery\": \"Script automatically prevents re-entrancy by erasing the instance if called recursively.\"\n    },\n    {\n      \"check\": \"Entity Selection in Context Menu\",\n      \"errorMessage\": \"User cancels the selection prompt (PrEntity.go() returns false)\",\n      \"recovery\": \"The operation is aborted, and the script continues without modifying data.\"\n    },\n    {\n      \"check\": \"MapX Data Integrity\",\n      \"errorMessage\": \"None explicit, but defaults are applied\",\n      \"recovery\": \"If 'MyUID' is missing from the StackingParent MapX, the script automatically scans all other scripts to find the highest sequence"
      },
      "tokens_used": 10590,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# StackSequencer.mcr\n\n## Overview\nThis script generates visual production sequence indicators (arrows and lines) to define the assembly order of timber elements in the 3D model. It allows users to group elements into stacks and manage their processing sequence through right-click context menu actions.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This is where the script draws the sequence geometry and interacts with Elements. |\n| Paper Space | No | Not designed for Paper Space or shop drawings. |\n| Shop Drawing | No | Not designed for Shop Drawing layouts. |\n\n## Prerequisites\n- **Required Entities**: Timber Elements (walls, floors, etc.) must exist in the model.\n- **Minimum Beam Count**: 0 (The script can be inserted into an empty model to prepare for sequencing).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Insert the Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse to and select `StackSequencer.mcr`.\n3.  The script will initialize. You do not need to click a specific point; it manages data based on existing elements.\n\n### Step 2: Add Elements to a Sequence\n1.  Select the `StackSequencer` instance in the model.\n2.  Right-click and choose **Add elements**.\n3.  **Command Line Prompt**: `Select elements to add`\n4.  Click on the timber elements you want to include in this production stack.\n5.  Press **Enter** to confirm.\n6.  The script will draw a line connecting these elements with circles and arrows indicating the flow.\n\n### Step 3: Resequence Elements (Optional)\n1.  Select the `StackSequencer` instance.\n2.  Right-click and choose **Resequence elements**.\n3.  **Command Line Prompt**: `Select elements to resequence`\n4.  Click the elements in the *exact order* you want them to be processed/assembled.\n5.  Press **Enter** to confirm.\n6.  The visual arrows and lines will update to reflect the new path.\n\n### Step 4: Resequence Stacks (Optional)\n1.  If you have multiple stack sequences in the model, select the `StackSequencer` instance belonging to the stack you want to prioritize.\n2.  Right-click and choose **Resequence stacks**.\n3.  **Command Line Prompt**: `Select stacks to resequence`\n4.  Select the stack instances in the order of priority (e.g., select Stack A, then Stack B to make A #1 and B #2).\n5.  Press **Enter** to confirm.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| N/A | N/A | N/A | This script does not have editable properties in the Properties Palette (OPM). All interaction is performed via the Right-Click Context Menu. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Add elements** | Prompts you to select timber elements to append to the end of the current stack sequence. |\n| **Remove elements** | Prompts you to select elements currently in the sequence to remove them from the stack. |\n| **Resequence elements** | Allows you to change the order of elements within the stack by selecting them in the new desired order. |\n| **Resequence stacks** | Changes the global sequence number of the stack parent (e.g., renaming Stack 5 to Stack 1) relative to other stacks. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external XML settings files.\n\n## Tips\n- **Layer Assignment**: The script automatically assigns the drawn lines and arrows to the Tooling layer associated with the floor group of the reference element.\n- **Visual Feedback**: The script draws circles at element positions and lines with arrows connecting them to visually guide the production flow.\n- **Batch Info**: Changing the stack sequence (\"Resequence stacks\") updates internal data used by labeling or other production management scripts.\n\n## FAQ\n- **Q: How do I change the assembly order of the elements?**\n  A: Use the **Resequence elements** option in the right-click menu. Select the elements one by one in the specific order you want them to be assembled.\n- **Q: What happens if I delete an element that is part of a sequence?**\n  A: The visual line will break. You should use the **Remove elements** command to cleanly detach the element from the sequence data before deleting it, or simply update the sequence afterwards.\n- **Q: Can I use this in a 2D layout?**\n  A: No, this script is designed for the 3D Model Space only."
      },
      "tokens_used": 6035,
      "error": null
    }
  }
}