{
  "filename": "hsb_Opening Description.mcr",
  "status": "completed",
  "total_tokens": 35465,
  "processing_time": 295.47310638427734,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "07.10.2008",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "First version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4137,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses a Manager/Worker pattern: it prompts via PrEntity for an ElementWallSF during _bOnInsert, then clones itself onto Opening objects found within that element. It uses assignToElementGroup() and Display.draw(_kDevice) without utilizing ShopDrawing (sd_*) APIs, PaperSpace (_kPaperSpace), or Viewport logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWallSF",
            "Opening"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires the user to select a Wall Element (ElementWallSF) in the model that contains Opening sub-entities.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4426,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Please select Elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Property Dialog",
            "trigger": "showDialogOnce()",
            "title": null,
            "dataSource": "Properties defined in script",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": "130",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nOffset",
            "type": "PropDouble",
            "displayName": "Offset from Window",
            "defaultValue": "U(250)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nOffsetX",
            "type": "PropDouble",
            "displayName": "Lateral Offset",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dOffset",
            "type": "PropDouble",
            "displayName": "Distance Between Lines",
            "defaultValue": "U(100)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dRotation",
            "type": "PropDouble",
            "displayName": "Set Rotation",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sDimStyleHead",
            "type": "PropString",
            "displayName": "Dimstyle Header",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDispRepHead",
            "type": "PropString",
            "displayName": "Disp Rep Header",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6264,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the annotation of wall openings by displaying text labels with the opening description, dimensions (Width x Height), and header/lintel details.",
          "category": "ShopDrawing/Annotation",
          "typicalUseCase": "Creating floor plan or elevation labels for windows and doors to show schedule markers (e.g., 'W01') and sizes directly on the model."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Defines the visual style (font, text size, layer) for the primary opening description and size labels.",
            "validRange": "Any valid Dimension Style name in the drawing template",
            "unit": "String",
            "affectsOutput": "Changes the appearance of lines 1 and 2 of the label."
          },
          {
            "name": "nColor",
            "technicalDefault": "130",
            "businessMeaning": "Sets the AutoCAD color index for the text annotation.",
            "validRange": "1-255",
            "unit": "Index",
            "affectsOutput": "Changes the color of all text lines drawn by the script."
          },
          {
            "name": "nOffset",
            "technicalDefault": "U(250)",
            "businessMeaning": "The distance the text label is placed away from the wall surface (along the wall's normal vector).",
            "validRange": "0 - 2000 mm",
            "unit": "mm",
            "affectsOutput": "Moves the entire text block closer to or further from the wall face."
          },
          {
            "name": "nOffsetX",
            "technicalDefault": "U(0)",
            "businessMeaning": "Lateral shift of the text label along the length of the wall relative to the opening center.",
            "validRange": "-500 - 500 mm",
            "unit": "mm",
            "affectsOutput": "Moves the text block left or right along the wall."
          },
          {
            "name": "dOffset",
            "technicalDefault": "U(100)",
            "businessMeaning": "The vertical spacing between the three lines of text (Description, Size, Header).",
            "validRange": "50 - 500 mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the gap between the lines of text to prevent overlapping or to condense the label."
          },
          {
            "name": "dRotation",
            "technicalDefault": "0",
            "businessMeaning": "The rotation angle applied to the text label around the insertion point.",
            "validRange": "0 - 360 degrees",
            "unit": "degrees",
            "affectsOutput": "Rotates the text block (e.g., 90 degrees for vertical walls vs horizontal slabs)."
          },
          {
            "name": "sDimStyleHead",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Defines the visual style for the third line of text, specifically the Header/Lintel information.",
            "validRange": "Any valid Dimension Style name",
            "unit": "String",
            "affectsOutput": "Allows the header info to have a different font or size than the opening dimensions."
          },
          {
            "name": "sDispRepHead",
            "technicalDefault": "",
            "businessMeaning": "Filters the visibility of the Header text based on the active Display Representation (e.g., 'Model', 'Plan', 'Section').",
            "validRange": "Empty string (all views) or specific Display Rep name",
            "unit": "String",
            "affectsOutput": "Hides the header information line if the current view does not match the specified Display Rep."
          }
        ],
        "parameterDependencies": [],
        "outputEntities": [
          {
            "type": "Text Annotation (Model Space)",
            "description": "Three lines of text indicating: 1. Opening Description/Code + Head Height, 2. Size (Width x Height), 3. Header/Lintel Detail or Element Text.",
            "appliedTo": "Wall Element (ElementWallSF) via Element Group assignment."
          }
        ]
      },
      "tokens_used": 6939,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script executed (Insert)",
          "Check insertCycleCount; if > 1, erase instance and exit (cleanup loop)",
          "Check Execute Key; if empty, show Properties Dialog once",
          "Prompt user to select Wall Elements (ElementWallSF) via command line",
          "If selection successful: Store selected elements in _Element array",
          "Loop through selected Wall Elements",
          "Find and erase any existing instances of this script attached to the walls",
          "Retrieve all Opening entities found within each Wall Element",
          "Clone script instance for each Opening found (Passing properties and Map)",
          "Erase the original Manager instance",
          "Worker Instance Execution (Cloned scripts attached to Openings)",
          "Retrieve Map 'nExecutionMode' (Value: 0)",
          "Loop through attached Openings",
          "Check if Opening is valid; if not, skip",
          "Determine Opening Type: OpeningSF or OpeningLog",
          "Extract Description, Size (Width x Height), and Header Info based on type",
          "Retrieve Element Texts from the parent Wall",
          "Search for specific text where Code='WINDOW' and SubCode='HEADER'",
          "Calculate distance from Opening to texts to find the closest match",
          "Update Header Info if a matching text is found near the opening",
          "Calculate Drawing Point: Opening Center + Offsets + Rotation",
          "Set Display Style (Color, DimStyle) and DispRep filters",
          "Draw Line 1: Description (e.g., 'W01: 2400')",
          "Draw Line 2: Size (e.g., '1500x2100')",
          "Draw Line 3: Header/Lintel Detail (e.g., 'Lintel 100x50')",
          "Assign drawn text to the Element Group",
          "Set Map 'nExecutionMode' to 1"
        ],
        "conditionalBranches": [
          {
            "condition": "Type of Opening Entity detected",
            "path1": {
              "name": "OpeningSF (Standard Factory Opening)",
              "steps": [
                "Get Description (descrSF)",
                "Append Head Height to description",
                "Format Size string as 'Width x Height'",
                "Get Top Construction Detail (constrDetailTop) for Header"
              ]
            },
            "path2": {
              "name": "OpeningLog (Log/Manual Opening)",
              "steps": [
                "Get Description from Log properties",
                "Skip specific size calculation (uses Log data)",
                "Skip Top Construction Detail (uses Log data)"
              ]
            }
          },
          {
            "condition": "Presence of Header Text in Wall Element",
            "path1": {
              "name": "Header Text Found",
              "steps": [
                "Iterate through Element Texts array",
                "Filter by Code='WINDOW' and SubCode='HEADER'",
                "Calculate projected distance along Wall X-axis",
                "Select text with minimum distance to Opening",
                "Replace Header Info with this text content"
              ]
            },
            "path2": {
              "name": "No Header Text Found",
              "steps": [
                "Retain Header Info derived from OpeningSF properties (or empty if OpeningLog)",
                "Draw the default label without specific element text override"
              ]
            }
          },
          {
            "condition": "Display Representation Filter (sDispRepHead)",
            "path1": {
              "name": "Filter Specified (String not empty)",
              "steps": [
                "Apply showInDispRep() to the Header Display object",
                "Header line only visible if current view matches the string"
              ]
            },
            "path2": {
              "name": "Filter Empty (Default)",
              "steps": [
                "Header line visible in all Display Representations"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection during Insert",
            "errorMessage": "None explicit (Script simply fails to proceed)",
            "recovery": "User must select a valid ElementWallSF when prompted."
          },
          {
            "check": "Opening Validity",
            "errorMessage": "None explicit",
            "recovery": "Script skips drawing for that specific entity if Opening is invalid or cast fails."
          },
          {
            "check": "Map Initialization (nExecutionMode)",
            "errorMessage": "None explicit",
            "recovery": "If Map does not contain 'nExecutionMode' on startup, script assumes Manager role. If present, assumes Worker role."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Label Position/Rotation",
            "how": "OPM Properties Palette",
            "effect": "Changing 'Offset from Window', 'Lateral Offset', or 'Set Rotation' recalculates the text insertion point and angle immediately."
          },
          {
            "action": "Modify Text Appearance",
            "how": "OPM Properties Palette",
            "effect": "Changing 'Dimstyle', 'Dimstyle Header', or 'Color' updates the text font, size, and color for the respective lines."
          },
          {
            "action": "Adjust Text Spacing",
            "how": "OPM Properties Palette",
            "effect": "Changing 'Distance Between Lines' moves the 2nd and 3rd text lines further apart or closer together relative to the first line."
          },
          {
            "action": "Edit Wall Geometry",
            "how": "Grip Edits / Move Wall",
            "effect": "Text updates position automatically due to `setDependencyOnEntity(el)` and coordinate calculation based on Opening center."
          },
          {
            "action": "Update Header Text via Element",
            "how": "Edit Element Properties / Text in Wall",
            "effect": "If the user updates the 'WINDOW/HEADER' text inside the Wall Element, the script re-evaluates the closest text and updates the 3rd line of the label."
          }
        ]
      },
      "tokens_used": 7579,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_Opening Description.mcr\n\n## Overview\nThis script automates the labeling of wall openings (windows and doors) by creating text annotations in the model. It displays the opening code, dimensions (Width x Height), and header/lintel details based on the wall and opening properties.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script attaches to Wall Elements and draws labels in 3D model space. |\n| Paper Space | No | Not intended for layout sheets. |\n| Shop Drawing | No | This is a model annotation tool. |\n\n## Prerequisites\n- **Required Entities**: Wall Elements (`ElementWallSF`) that contain Opening entities (`OpeningSF` or `OpeningLog`).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_Opening Description.mcr` from the file browser.\n\n### Step 2: Select Walls\n```\nCommand Line: Please select Elements\nAction: Click on one or more Wall Elements that contain the openings you wish to label. Press Enter to confirm selection.\n```\n*Note: The script will automatically detect all openings inside the selected walls and place a label on each one.*\n\n### Step 3: Adjust Properties (Optional)\nAfter insertion, select a wall with the script attached to view and modify the label settings in the AutoCAD Properties Palette.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimstyle | dropdown | _DimStyles | Determines the text style (font, size) used for the opening description and size lines. |\n| Color | number | 130 | Sets the AutoCAD color index (1-255) for the text. |\n| Offset from Window | number | 250 | Distance the text block is placed away from the wall face (normal direction). |\n| Lateral Offset | number | 0 | Shifts the text left or right along the length of the wall relative to the opening center. |\n| Distance Between Lines | number | 100 | Vertical spacing between the three lines of text (Description, Size, Header). |\n| Set Rotation | number | 0 | Rotation angle applied to the entire text block. |\n| Dimstyle Header | dropdown | _DimStyles | Determines the text style specifically for the Header/Lintel line (Line 3). |\n| Disp Rep Header | text | (Empty) | Filters the Header line visibility. If empty, it shows in all views. If a Display Rep name is entered (e.g., \"Plan\"), the header only appears in that view. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add specific items to the right-click context menu. Use the Properties palette to make changes. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Smart Header Text**: The script attempts to find \"Element Text\" inside your wall where the Code is `WINDOW` and SubCode is `HEADER`. If these exist in your wall data, the script will automatically use that text for the third line of the label instead of generic construction details.\n- **Dynamic Updates**: If you stretch or move a wall, the labels will automatically update their position to stay relative to the opening center.\n- **View Control**: Use the **Disp Rep Header** property to hide clutter (like lintel sizes) in elevation views while keeping them visible in floor plans.\n\n## FAQ\n- **Q: Can I use this on individual windows without selecting the whole wall?**\n  A: No. The script operates by selecting the Wall Element (`ElementWallSF`). It will process all openings found within that specific wall.\n- **Q: Why is my text appearing in the wrong size?**\n  A: The text size is controlled by the Dimension Style selected in the **Dimstyle** property. Change this to a dimension style with larger text settings in your CAD template.\n- **Q: The text is overlapping my window.**\n  A: Increase the value of **Offset from Window** in the properties palette to push the label further out from the wall face."
      },
      "tokens_used": 6120,
      "error": null
    }
  }
}