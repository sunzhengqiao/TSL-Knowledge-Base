{
  "filename": "f_Lorry.mcr",
  "status": "completed",
  "total_tokens": 48097,
  "processing_time": 201.05393838882446,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "29oct2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "HSB-9499 bugfix inplacement and new jig added"
          },
          {
            "version": "1.0",
            "date": "23sep2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [
          "f_Stacking.xml"
        ],
        "dependencies": [
          "f_LorryPackage"
        ]
      },
      "tokens_used": 7974,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No 'sd_' or 'Multipage' prefixes found. No '_Viewport' usage detected. No '#Type E' or 'sd_' specific logic found. Script defines its own Display objects (dpPlan, dpModel) for visualization in 3D/Plan views rather than generating 2D shop drawings. Uses getPoint() for insertion, typical of Model Space interaction."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst (specifically f_LorryPackage)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D environment)",
          "requiredSettings": [
            "f_Stacking.xml (Expected path: Company\\TSL\\Settings\\ or Install\\Content\\General\\TSL\\Settings\\)",
            "MapObject 'hsbTSL', 'f_Stacking' (created if missing)"
          ]
        }
      },
      "tokens_used": 5564,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert && _kExecuteKey.length()==0\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": [\n      {\n        \"prompt\": \"Select Alignment[.../1Front-Left/2Front-Center/3Front-Right/4Center-Left/5Center-Center/6Center-Right/7Back-Left/8Back-Center/9Back-Right]\",\n        \"options\": [\n          \"1Front-Left\",\n          \"2Front-Center\",\n          \"3Front-Right\",\n          \"4Center-Left\",\n          \"5Center-Center\",\n          \"6Center-Right\",\n          \"7Back-Left\",\n          \"8Back-Center\",\n          \"9Back-Right\"\n        ]\n      }\n    ]\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"showDialog\",\n      \"trigger\": \"Insertion (_bOnInsert)\",\n      \"title\": \"Properties\",\n      \"dataSource\": \"OPM Properties\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dLength\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Length\",\n      \"defaultValue\": \"13600 mm\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Geometry\",\n      \"description\": \"Defines the Length of the Truck\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dWidth\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Width\",\n      \"defaultValue\": \"2500 mm\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Geometry\",\n      \"description\": \"Defines the Width of the Truck\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Height\",\n      \"defaultValue\": \"2700 mm\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Geometry\",\n      \"description\": \"Defines the Height of the Truck\"\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sDescription\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Description\",\n      \"defaultValue\": \"Truck\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Truck\",\n      \"description\": \"Sets the Description of the Truck\"\n    }\n  ],\n  \"contextMenu\": [\n    {\n      \"menuItem\": \"Add Lorry Package\",\n      \"handler\": \"|Add Lorry Package|\",\n      \"action\": \"Prompts user to select TslInst entities (packages) and aligns them on the lorry using"
      },
      "tokens_used": 9874,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a parametric 3D representation of a truck loading bay to visualize, validate, and manage the placement of timber transport packages.",
          "category": "Logistics/Planning",
          "typicalUseCase": "Used by production managers to plan shipment loads by ensuring timber packages fit within the truck dimensions and do not clash with each other during stacking."
        },
        "parameters": [
          {
            "name": "dLength",
            "technicalDefault": "U(13600)",
            "businessMeaning": "The total available loading length of the truck bed.",
            "validRange": "4000 mm - 20000 mm (Common standards: 7500, 9500, 12000, 13600)",
            "unit": "mm",
            "affectsOutput": "Resizes the truck envelope geometry along the X-axis. If reduced, existing packages at the ends may be unlinked from the truck if they fall outside the new boundary."
          },
          {
            "name": "dWidth",
            "technicalDefault": "U(2500)",
            "businessMeaning": "The internal width of the truck available for loading.",
            "validRange": "2000 mm - 2600 mm (Standard width limit is approx 2550 mm)",
            "unit": "mm",
            "affectsOutput": "Resizes the truck envelope geometry along the Y-axis. Determines the lateral boundary for package stacking and collision detection."
          },
          {
            "name": "dHeight",
            "technicalDefault": "U(2700)",
            "businessMeaning": "The maximum vertical stacking height allowed for the load.",
            "validRange": "2500 mm - 4500 mm (Depends on legal height limits and bridge clearance)",
            "unit": "mm",
            "affectsOutput": "Resizes the truck envelope geometry along the Z-axis. Used in volume calculations and clash detection; if a package is stacked higher than this value, it visually clashes (or is considered invalid depending on logic)."
          },
          {
            "name": "sDescription",
            "technicalDefault": "\"Truck\"",
            "businessMeaning": "User-defined identifier for the specific truck instance (e.g., Truck #1, Site A Delivery).",
            "validRange": "String text",
            "unit": "Text",
            "affectsOutput": "Updates the property palette display for identification purposes."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Modification of dLength, dWidth, or dHeight",
            "effect": "The 'bdTruckEnvelope' body is recalculated. The script then iterates through linked packages ('f_LorryPackage') to check if they still physically intersect with the new envelope.",
            "cascade": [
              "Hsb_Package[]",
              "Clash Detection Results"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Representation (Body/PLine)",
            "description": "A 3D wireframe and semi-transparent box representing the physical truck dimensions, viewable in Plan and Model views.",
            "appliedTo": "Model Space (insertion point _Pt0)"
          },
          {
            "type": "Clash Visualization",
            "description": "Red (RGB 209,0,0) transparent volumes drawn where linked packages overlap each other or fall outside the truck envelope.",
            "appliedTo": "Intersecting TslInst entities (f_LorryPackage)"
          },
          {
            "type": "Logical Link (SubMapX)",
            "description": "Creates a data linkage ('Hsb_ParentTruck' / 'Hsb_Package[]') between the truck script and the package scripts to manage hierarchy and dependencies.",
            "appliedTo": "Selected TslInst entities during the 'Add Lorry Package' command"
          }
        ]
      },
      "tokens_used": 8714,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Execution Start (_bOnInsert)",
          "2. Check Insertion Mode (Catalog/Command Key vs Manual)",
          "3. [Conditional] Show Properties Dialog (showDialog) or apply Catalog values",
          "4. User defines Dimensions (Length, Width, Height) and Description",
          "5. User selects Insertion Point (getPoint)",
          "6. Generate Lorry Envelope Geometry (Body, PLines in Plan/Side/Front views)",
          "7. [Post-Insertion] User triggers 'Add Lorry Package' (Context Menu/Double Click)",
          "8. User selects Package Entities (TslInst filter)",
          "9. Loop through selected packages -> Calculate alignment/position",
          "10. User inputs Placement Point (PrPoint with Jig)",
          "11. [Conditional] Adjust Alignment (Keyword 1-9) or Confirm Location (Enter)",
          "12. Transform Package to new location",
          "13. Link Package to Lorry (SubMapX 'Hsb_ParentTruck' / 'Hsb_Package[]')",
          "14. Script Recalculation (Validation Loop)",
          "15. Validate Packages (Check intersection with Lorry Envelope)",
          "16. Perform Clash Detection (Package vs Package intersection)",
          "17. Draw Clash Volumes (Red) if found"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Method",
            "path1": {
              "name": "Catalog/Command Key",
              "steps": [
                "_kExecuteKey is set",
                "Skip Dialog",
                "Apply preset values from Catalog entry",
                "Prompt for insertion point"
              ]
            },
            "path2": {
              "name": "Manual Insertion",
              "steps": [
                "_kExecuteKey is empty",
                "Execute showDialog()",
                "User modifies properties in OPM",
                "Prompt for insertion point"
              ]
            }
          },
          {
            "condition": "Package Placement Interaction (Jig)",
            "path1": {
              "name": "Change Alignment",
              "steps": [
                "User types keyword (1-9) at command line",
                "Jig updates preview offset based on alignment (e.g., Front-Left)",
                "Loop continues for point input"
              ]
            },
            "path2": {
              "name": "Confirm Location",
              "steps": [
                "User clicks point or presses Enter",
                "Package transform finalized",
                "Linkage created",
                "Move to next selected package or finish"
              ]
            },
            "path3": {
              "name": "Cancel",
              "steps": [
                "User presses Esc",
                "Current operation aborted",
                "Script state reset"
              ]
            }
          },
          {
            "condition": "Package Validation Logic",
            "path1": {
              "name": "Valid Placement",
              "steps": [
                "Package Body intersects with Lorry Envelope",
                "Package retained in 'Hsb_Package[]' list",
                "Dependency set on Package entity",
                "Included in Clash Detection"
              ]
            },
            "path2": {
              "name": "Invalid Placement (Outside Truck)",
              "steps": [
                "Package Body does NOT intersect with Lorry Envelope",
                "Package removed from 'Hsb_Package[]' list",
                "Dependency removed",
                "Package effectively unlinked from Truck"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Package Intersection with Lorry Envelope",
            "errorMessage": "None (Silent Unlink)",
            "recovery": "User must move the package closer to the truck or re-attach it using 'Add Lorry Package'. If the truck dimensions (Length/Width) are reduced, packages outside the new boundary are automatically unlinked."
          },
          {
            "check": "Package-to-Package Clash",
            "errorMessage": "Visual Warning (Red Solid)",
            "recovery": "User observes the red clash volumes drawn in the model and must manually adjust the position of the conflicting packages (likely via their own grips or the Lorry script's alignment options)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Lorry Dimensions",
            "how": "OPM Properties (Geometry Category)",
            "effect": "Updates the 3D Body envelope. Triggers validation which automatically unlinks packages that fall outside the new boundaries. Recalculates clash detection."
          },
          {
            "action": "Add/Align Packages",
            "how": "Context Menu 'Add Lorry Package' or Double-Click",
            "effect": "Enters selection mode to pick TslInst entities. Allows re-positioning and aligning (1-9 options) selected packages relative to the truck base point. Re-links them to the truck."
          },
          {
            "action": "Move Lorry Instance",
            "how": "Grip Edit (Point Control)",
            "effect": "Moves the entire lorry geometry. Logic suggests linked packages might not automatically move unless specific dependency logic transforms them, but the code validates intersections relative to the new envelope location (Note: The code validates intersection, but does not explicitly transform packages on simple grip move, only on the specific 'Add Lorry Package' trigger. Thus, moving the lorry might result in packages being unlinked if they don't move with it)."
          }
        ]
      },
      "tokens_used": 9693,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# f_Lorry.mcr\n\n## Overview\nThis script creates a parametric 3D representation of a truck loading bay. It is used to plan and visualize timber shipments, ensuring that transport packages fit within the truck's physical dimensions and do not collide with one another during stacking.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model environment to visualize the truck and packages. |\n| Paper Space | No | Not designed for 2D layout or detailing. |\n| Shop Drawing | No | Does not generate 2D manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities:** `f_LorryPackage` (TslInst entities) are required to add cargo to the truck.\n- **Minimum Beam Count:** 0.\n- **Required Settings:** `f_Stacking.xml` (Expected path: `Company\\TSL\\Settings\\` or `Install\\Content\\General\\TSL\\Settings\\`).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `f_Lorry.mcr` from the catalog.\n\n### Step 2: Configure Truck Properties\n```\nCommand Line: (Dialog appears automatically on first insert)\nAction: Enter the Length, Width, Height, and Description for the truck in the Properties dialog.\n```\n*Note: You can modify these later via the Properties palette.*\n\n### Step 3: Set Insertion Point\n```\nCommand Line: Specify insertion point:\nAction: Click in the Model Space to place the base point of the truck lorry.\n```\n\n### Step 4: Add Packages (Post-Insertion)\n```\nAction: Select the Lorry instance in the model.\nAction: Right-click and select \"Add Lorry Package\" from the context menu (or double-click the element).\n```\n\n### Step 5: Select Cargo\n```\nCommand Line: Select TslInst entities:\nAction: Select the timber package scripts (`f_LorryPackage`) you wish to load onto the truck. Press Enter to confirm selection.\n```\n\n### Step 6: Position Packages\n```\nCommand Line: Specify placement point [Alignment options...]:\nAction: Click to position the package. \nOptional: Type a number (1-9) to snap alignment:\n  1: Front-Left | 2: Front-Center | 3: Front-Right\n  4: Center-Left | 5: Center-Center | 6: Center-Right\n  7: Back-Left | 8: Back-Center | 9: Back-Right\n```\n*Repeat for each selected package.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Length | Number | 13600 mm | Defines the total loading length of the truck bed. |\n| Width | Number | 2500 mm | Defines the internal width of the truck available for loading. |\n| Height | Number | 2700 mm | Defines the maximum vertical stacking height allowed for the load. |\n| Description | Text | Truck | A user-defined label for the truck instance (e.g., \"Site A Delivery\"). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add Lorry Package | Opens the selection filter to pick package entities. Allows you to align and attach selected packages to the truck using the placement jig. |\n\n## Settings Files\n- **Filename**: `f_Stacking.xml`\n- **Location**: `Company\\TSL\\Settings\\` or `Install\\Content\\General\\TSL\\Settings\\`\n- **Purpose**: Provides configuration data for stacking logic and object mapping.\n\n## Tips\n- **Quick Alignment**: While placing a package, type `5` to quickly center it, or `1`-`9` to snap it to specific corners of the placement cursor.\n- **Visual Validation**: The script draws **Red** volumes where packages overlap or clash with each other. Adjust package positions manually to resolve these conflicts.\n- **Resizing Warning**: If you reduce the Length or Width of the truck in the properties, any packages that fall outside the new boundaries will be automatically unlinked from the truck.\n\n## FAQ\n- **Q: What do the numbers 1 through 9 mean during placement?**\n  **A:** These represent the alignment anchor of the package relative to your cursor. For example, \"1\" anchors the Front-Left corner of the package to your cursor, while \"9\" anchors the Back-Right corner.\n  \n- **Q: I see red boxes on my load. What does that mean?**\n  **A:** Red boxes indicate a clash. This means two or more packages are occupying the same physical space, or a package is intersecting incorrectly. You must move the packages to resolve this.\n\n- **Q: My package disappeared when I changed the truck size. Why?**\n  **A:** The script validates that packages fit inside the truck envelope. If you shrink the truck dimensions so a package sits outside the new boundary, it is automatically unlinked (removed) from the truck."
      },
      "tokens_used": 6278,
      "error": null
    }
  }
}