{
  "filename": "HSB_R-OptimizeBattens.mcr",
  "status": "completed",
  "total_tokens": 41710,
  "processing_time": 401.6044292449951,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7655,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `_kModelSpace` during the `dbCreate` call. It does not contain any Paper Space specific patterns such as `sd_` or `Multipage` prefixes, nor does it check for `_Viewport` length. The script manipulates 3D `Element` and `Sheet` objects directly."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 3982,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select one or more elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "|Oriëntation|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sCorrectOrientation",
            "type": "PropString",
            "displayName": "     |Correct oriëntation|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "|Square off|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sSquareOff",
            "type": "PropString",
            "displayName": "     |Make battens squared|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sSeperator03",
            "type": "PropString",
            "displayName": "|Optimize length|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sOptimizeLength",
            "type": "PropString",
            "displayName": "     |Optimize length|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dOptimizedLength",
            "type": "PropDouble",
            "displayName": "     |Optimized length|",
            "defaultValue": "U(10000)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dGap",
            "type": "PropDouble",
            "displayName": "     |Gap|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8146,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Optimizes counter battens by correcting their axis alignment to be straight, squaring off the ends perpendicular to the new axis, and cutting them to standardized lengths to minimize waste.",
          "category": "Framing",
          "typicalUseCase": "Used during the detailing phase to process automatically generated roof battens or sub-purlins so they are straight, have square ends for easy assembly, and are cut to manageable transport lengths."
        },
        "parameters": [
          {
            "name": "sSeperator01",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual group header for the 'Orientation' settings.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None."
          },
          {
            "name": "sCorrectOrientation",
            "technicalDefault": "\"|No|\"",
            "businessMeaning": "Determines if the script calculates the straightest possible axis for the batten based on its longest edge and realigns the batten geometry to this axis.",
            "validRange": "Yes/No",
            "unit": "Boolean",
            "affectsOutput": "Replaces the original batten geometry with a new sheet aligned to the calculated X-axis. If set to No, the original orientation (which might be skewed along a roof slope) is kept."
          },
          {
            "name": "sSeperator02",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual group header for the 'Square off' settings.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None."
          },
          {
            "name": "sSquareOff",
            "technicalDefault": "\"|No|\"",
            "businessMeaning": "Specifies whether the ends of the batten should be cut perpendicular (90°) to the straightened batten axis.",
            "validRange": "Yes/No",
            "unit": "Boolean",
            "affectsOutput": "Uses split operations to remove angled or irregular end geometry, leaving a piece with square ends. If No, ends follow the roof shape or existing cut."
          },
          {
            "name": "sSeperator03",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual group header for the 'Optimize length' settings.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None."
          },
          {
            "name": "sOptimizeLength",
            "technicalDefault": "\"|Yes|\"",
            "businessMeaning": "Activates the logic to cut long continuous battens into multiple pieces of a standard optimized length.",
            "validRange": "Yes/No",
            "unit": "Boolean",
            "affectsOutput": "Splits the batten sheet into separate instances. Only effective if the batten length exceeds the 'Optimized length' parameter."
          },
          {
            "name": "dOptimizedLength",
            "technicalDefault": "U(10000)",
            "businessMeaning": "The target standard length for the batten pieces. Battens longer than this will be cut.",
            "validRange": "1000 - 20000 mm",
            "unit": "Length (mm)",
            "affectsOutput": "Defines where the cut occurs along the batten. The script attempts to keep pieces at this specific length (minus any gap)."
          },
          {
            "name": "dGap",
            "technicalDefault": "U(0)",
            "businessMeaning": "The distance maintained between optimized batten segments, typically used to account for saw blade width (kerf) or expansion joints.",
            "validRange": "0 - 50 mm",
            "unit": "Length (mm)",
            "affectsOutput": "Reduces the effective length of the cut pieces slightly to ensure proper spacing when placed end-to-end."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sOptimizeLength = \"|No|\"",
            "effect": "The length optimization logic is skipped; dOptimizedLength and dGap are ignored.",
            "cascade": [
              "dOptimizedLength",
              "dGap"
            ]
          },
          {
            "trigger": "sSquareOff = \"|No|\"",
            "effect": "The batten geometry is not squared off; the split logic for squaring ends is skipped, preserving the original profile shape.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Sheet",
            "description": "Modified or newly created timber sheet entities representing the battens.",
            "appliedTo": "Zone 4 sheets of the selected Element."
          }
        ]
      },
      "tokens_used": 6566,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Start",
          "Check Insertion State: Is _bOnInsert true?",
          "True: Check if insertCycleCount > 1. If yes, erase instance and exit.",
          "Check if executing from a ToolPalette catalog. If not, show Properties Dialog.",
          "Prompt User: Select one or more Elements (PrEntity).",
          "User Selection Completed? If no, exit.",
          "Iterate through selected Elements.",
          "For each Element: Erase existing instances of this script attached to the element.",
          "Create a new Satellite instance of this script attached to each selected Element.",
          "Store current Property values in a 'MasterToSatellite' catalog within the Satellite instance map.",
          "Set 'ManualInsert' flag in the Satellite instance map.",
          "Master Instance: Report number of tsls inserted and erase itself.",
          "Satellite Instance Start (executed on each selected Element).",
          "Apply properties from the 'MasterToSatellite' catalog.",
          "Retrieve 'ManualInsert' flag from the map.",
          "Validate Input: Check if Element exists. If not, report error and erase instance.",
          "Resolve Property Strings (Yes/No) to Integer flags (1/0).",
          "Check Execution Condition: Is _bOnElementConstructed true OR 'ManualInsert' true?",
          "False: Exit script.",
          "True: Check Element Type. If Element is a RoofPlane, erase instance and exit.",
          "Retrieve all Zone 4 Sheets from the Element.",
          "Iterate through each Zone 4 Sheet.",
          "Calculate the 'Straightest Axis' by finding the longest edge segment of the sheet.",
          "Branch: Check 'Correct Orientation' property.",
          "Branch: Check 'Square Off' property.",
          "Branch: Check 'Optimize Length' property.",
          "Script Complete: Erase the script instance.",
          "End"
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert is true",
            "path1": {
              "name": "Master Insertion Workflow",
              "steps": [
                "Check for ToolPalette execution. If manual, show Dialog.",
                "Prompt user to select Elements.",
                "Loop through selection and erase old script instances.",
                "Create new Satellite script instances on Elements.",
                "Pass current properties to Satellite instances.",
                "Report count and erase Master instance."
              ]
            },
            "path2": {
              "name": "Satellite/Calculation Workflow",
              "steps": [
                "Receive properties from Master.",
                "Wait for Element Construction (_bOnElementConstructed) or Manual Insert trigger.",
                "Perform geometry optimization on Element Sheets.",
                "Erase self upon completion."
              ]
            }
          },
          {
            "condition": "sCorrectOrientation == '|Yes|'",
            "path1": {
              "name": "Reorient Batten",
              "steps": [
                "Calculate new X-axis based on longest edge.",
                "Create a new CoordSys with the new X-axis.",
                "Create a new Sheet using the new profile.",
                "Delete the original Sheet.",
                "Replace reference with the new Sheet."
              ]
            },
            "path2": {
              "name": "Keep Original Orientation",
              "steps": [
                "Skip reorientation logic.",
                "Proceed to Square Off check."
              ]
            }
          },
          {
            "condition": "sSquareOff == '|Yes|'",
            "path1": {
              "name": "Square Off Ends",
              "steps": [
                "Identify start and end points of segments parallel to the batten axis.",
                "Split the Sheet using a Plane at the minimum start point.",
                "Keep the part of the Sheet in the direction of the positive axis; delete the other.",
                "Split the Sheet using a Plane at the maximum end point.",
                "Keep the part of the Sheet in the direction of the negative axis; delete the other."
              ]
            },
            "path2": {
              "name": "Keep Original Ends",
              "steps": [
                "Skip splitting logic for ends.",
                "Proceed to Length Optimization check."
              ]
            }
          },
          {
            "condition": "sOptimizeLength == '|Yes|' AND Sheet Length > dOptimizedLength",
            "path1": {
              "name": "Cut to Length",
              "steps": [
                "Calculate distance along axis to the target optimized length.",
                "Split the Sheet at that point (including dGap offset).",
                "Identify the longest resulting segment (the remaining uncut portion).",
                "Update reference to this longest segment.",
                "Repeat loop if the remaining length still exceeds the target."
              ]
            },
            "path2": {
              "name": "Do Not Cut",
              "steps": [
                "Skip length optimization logic.",
                "Proceed to end of Sheet loop."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Check if insertCycleCount > 1 during _bOnInsert",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases itself to prevent duplicate execution."
          },
          {
            "check": "Check if User provided Element selection (PrEntity.go())",
            "errorMessage": "None (Script ends)",
            "recovery": "User must run the command again and make a selection."
          },
          {
            "check": "Check if _Element array is empty in Satellite instance",
            "errorMessage": "|Invalid selection|!",
            "recovery": "The element linked to the script is invalid; script erases itself."
          },
          {
            "check": "Check if Element is of type ERoofPlane",
            "errorMessage": "None (Silent)",
            "recovery": "Script erases itself because it is not designed for RoofPlane elements."
          },
          {
            "check": "Check if an outline ring exists in the Sheet profile",
            "errorMessage": "None (Silent)",
            "recovery": "Skip current sheet and continue to next in the list."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Optimization Settings",
            "how": "Select the script instance in the model and edit properties in the OPM (Object Properties Model) palette.",
            "effect": "Changing 'Correct orientation', 'Make battens squared', or 'Optimize length' will trigger a recalculation. However, since the script self-erases (eraseInstance()) after execution, these properties must be changed before the script finishes or by selecting the script while it is still active (e.g., during a debug or specific construct phase). In standard usage, the script runs once and deletes itself, so post-insertion editing of the *existing* run is not possible; the script must be re-run on the elements with new settings."
          },
          {
            "action": "Regenerate/Update Model",
            "how": "Automatic or manual update of the Element.",
            "effect": "Since the script uses `_bOnElementConstructed`, modifying the underlying Element (e.g., changing the roof slope) *might* trigger the script again if it were persistent. However, as `eraseInstance()` is called at the end, the script removes itself. To re-optimize, the user must manually execute the script on the elements again."
          }
        ]
      },
      "tokens_used": 8648,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-OptimizeBattens.mcr\n\n## Overview\nThis script optimizes counter battens (Zone 4 sheets) by straightening their axis alignment, squaring off the ends to be perpendicular, and cutting them to standardized lengths to minimize material waste and simplify assembly.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script runs explicitly in 3D Model Space. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | Not a shop drawing generation script. |\n\n## Prerequisites\n- **Required entities**: Elements (walls or roofs) that contain Zone 4 sheet elements (e.g., counter battens or sub-purlins).\n- **Minimum beam count**: N/A (Requires Elements, not specific beams).\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `HSB_R-OptimizeBattens.mcr` from the file dialog or ToolPalette.\n\n### Step 2: Configure Properties\nBefore selecting elements, you can adjust the optimization settings.\n- If executed from the ToolPalette, the properties may default to the last used values.\n- You can select the script instance (if visible) or use the AutoCAD Properties Palette to change settings like orientation, squaring, and target lengths before proceeding to selection.\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or more elements\nAction: Click on the Elements (Roofs or Walls) in the model that contain the battens you wish to optimize. Press Enter to confirm selection.\n```\n\n### Step 4: Processing\nThe script will automatically process the selected elements. It will modify the geometry of the battens and then delete itself from the model upon completion.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Oriëntation** (Group Header) | Text | - | Visual separator for orientation settings. |\n| Correct orientation | Dropdown | No | If Yes, aligns the batten axis to the straightest possible line based on its longest edge. |\n| **Square off** (Group Header) | Text | - | Visual separator for squaring settings. |\n| Make battens squared | Dropdown | No | If Yes, cuts the ends of the battens perpendicular (90°) to their axis. |\n| **Optimize length** (Group Header) | Text | - | Visual separator for length optimization settings. |\n| Optimize length | Dropdown | Yes | If Yes, cuts long battens into multiple pieces of the target optimized length. |\n| Optimized length | Number | 10000 mm | The target length for the cut pieces (e.g., 10000 mm). |\n| Gap | Number | 0 mm | The gap between cut pieces (e.g., for saw blade kerf or spacing). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu items are added by this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external XML settings files.\n\n## Tips\n- **Self-Deleting Script**: The script instance erases itself after running. If you need to change the optimization settings (e.g., different lengths or squaring), you must run the script again on the elements; you cannot simply edit the properties of an old script instance.\n- **Roof Planes**: The script automatically detects and skips RoofPlane elements. It is intended for standard wall or roof elements containing battens.\n- **Kerf Allowance**: Remember to set the `Gap` parameter if you need to account for saw blade thickness when cutting the optimized lengths.\n- **Straightening**: Use \"Correct orientation\" if your generated battens are slightly skewed along a complex roof slope and you need them perfectly straight for fabrication.\n\n## FAQ\n- **Q: Why did the script disappear after I ran it?**\n  A: This is normal behavior. The script is designed as a \"one-time\" operation. It modifies the batten geometry, applies the changes, and then removes itself to keep the drawing clean.\n  \n- **Q: Can I undo the changes?**\n  A: Yes, you can use the standard AutoCAD `UNDO` command to revert the geometry changes if the script result is not as expected.\n\n- **Q: The script didn't modify my battens. Why?**\n  A: Ensure the selected elements actually have \"Zone 4\" Sheets assigned to them. Also, verify that the `Optimize length` is set to a value smaller than the current batten length, or that `Correct orientation`/`Make battens squared` are set to \"Yes\" if those modifications are needed."
      },
      "tokens_used": 6713,
      "error": null
    }
  }
}