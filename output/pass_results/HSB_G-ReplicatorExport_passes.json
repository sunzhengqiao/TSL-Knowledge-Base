{
  "filename": "HSB_G-ReplicatorExport.mcr",
  "status": "completed",
  "total_tokens": 46965,
  "processing_time": 457.9290339946747,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8685,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses Group().collectEntities(..., _kModelSpace) and Entity allEntElements[] = Group().collectEntities(TRUE, Element(), _kModelSpace); which indicates operation in Model Space. It exports Elements and Entities to a delivery/export structure. There are no references to sd_*, _Viewport, _kPaperSpace, or ShopDrawing specific patterns like #Type E."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Entity"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing Elements or Entities to export.",
          "requiredSettings": [
            "ModelMap exporter groups and shortcuts must be defined (ModelMap().exporterGroups() used).",
            "Catalog entries for 'HSB_G-ReplicatorExport' or '_LastInserted' for property presets.",
            "TSL script 'HSB_E-Replicator' may be required on elements if 'Use unique elements' is No."
          ]
        }
      },
      "tokens_used": 5186,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select a set of elements| |or <ENTER> to select entities|",
              "condition": "(insertCycleCount() == 1 && !_Map.hasMap(\"Element[]\")) || (onlySelection == \"|Yes|\") && !_Map.hasMap(\"Element[]\")",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select entities|",
              "condition": "First selection set length is 0",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "After entity selection if not executed via _kExecuteKey",
            "title": "HSB_G-ReplicatorExport Properties",
            "dataSource": "OPM Properties defined in script",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "pGroup",
            "type": "PropString",
            "displayName": "|Exporter group|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "ModelMap().exporterGroups()",
            "category": "|Export|",
            "description": "|Select the group that needs to be exported. If empty the single export is used|"
          },
          {
            "index": 1,
            "variable": "pShortcut",
            "type": "PropString",
            "displayName": "|Single export|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "ModelMap().exporterShortcuts()",
            "category": "|Export|",
            "description": "|Select the single export that needs to be exported. If empty the group export is used|"
          },
          {
            "index": 2,
            "variable": "deliveryName",
            "type": "PropString",
            "displayName": "|Delivery name|",
            "defaultValue": "|New delivery|",
            "inputType": "text",
            "options": [],
            "category": "|Delivery|",
            "description": "|Sets the delivery name|"
          },
          {
            "index": 3,
            "variable": "deliveryDescription",
            "type": "PropString",
            "displayName": "|Description name|",
            "defaultValue": "|New description|",
            "inputType": "text",
            "options": [],
            "category": "|Delivery|",
            "description": "|Sets the delivery description|"
          },
          {
            "index": 4,
            "variable": "onlySelection",
            "type": "PropString",
            "displayName": "|Use unique elements|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Export|",
            "description": "|If this is set to no, the replicated elements are checked. If set to no, or not set, the selected elements are exported|"
          },
          {
            "index": 5,
            "variable": "export",
            "type": "PropString",
            "displayName": "|Export|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Export|",
            "description": "|If this is set to no, the exporter will not run, only the delivery is created|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Catalog Execute Keys",
            "handler": "_kExecuteKey",
            "action": "Sets property values from a specific catalog entry matching the execute key.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8031,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Manages the creation of delivery lists, updates production quantities, and exports timber construction data to external formats (like BTL or Palletizer) for specific project phases or shipments.",
          "category": "Data Management / Production Export",
          "typicalUseCase": "Used when a production manager needs to prepare a specific batch of walls or floors for manufacturing. They define the shipment name, select the relevant elements, and generate the machine files for just that batch."
        },
        "parameters": [
          {
            "name": "pGroup",
            "technicalDefault": "",
            "businessMeaning": "Selects the predefined configuration of export formats (e.g., 'Weinmann', 'Randek', or 'Standard BTL') from the hsbCAD ModelMap. This determines which data and file types are generated for the delivery.",
            "validRange": "Any Exporter Group name defined in the ModelMap settings",
            "unit": "String",
            "affectsOutput": "Determines the format and content of the production files (e.g., BTL, MPR, CSV)."
          },
          {
            "name": "pShortcut",
            "technicalDefault": "",
            "businessMeaning": "Selects a specific, individual export configuration (often used for quick exports) rather than a full group. Useful for exporting to a single specific machine or format without using a broader group.",
            "validRange": "Any Export Shortcut name defined in the ModelMap settings",
            "unit": "String",
            "affectsOutput": "Directs the export engine to use a specific export configuration, bypassing the group selection if necessary."
          },
          {
            "name": "deliveryName",
            "technicalDefault": "|New delivery|",
            "businessMeaning": "The identifying name for the shipment or production batch (e.g., 'Phase 1 - Ground Floor'). This name is stored in the project data and used to track what has been produced.",
            "validRange": "Any alphanumeric string",
            "unit": "String",
            "affectsOutput": "Updates the project metadata and serves as the identifier for the delivery record."
          },
          {
            "name": "deliveryDescription",
            "technicalDefault": "|New description|",
            "businessMeaning": "Provides additional details about the delivery, such as the destination site, floor level, or specific instructions.",
            "validRange": "Any text string",
            "unit": "String",
            "affectsOutput": "Stored in the project delivery notes for reporting and traceability."
          },
          {
            "name": "onlySelection",
            "technicalDefault": "|No|",
            "businessMeaning": "Controls whether the export process treats the selected elements as individual items ('Yes') or expands the selection to include all replicated/linked instances found in the project ('No').",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean",
            "affectsOutput": "If 'No', quantities and exports include all identical elements found in the model. If 'Yes', strictly only the visually selected elements are exported."
          },
          {
            "name": "export",
            "technicalDefault": "|No|",
            "businessMeaning": "Acts as the final 'Go/No-Go' switch. If 'No', the script calculates quantities and updates delivery lists but stops short of creating files. If 'Yes', it triggers the actual generation of machine files.",
            "validRange": "|No|, |Yes|",
            "unit": "Boolean",
            "affectsOutput": "If 'Yes', production files are generated. If 'No', only internal quantity updates and metadata occur."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "pGroup is set to empty",
            "effect": "The script falls back to using pShortcut to determine the export configuration.",
            "cascade": [
              "pShortcut"
            ]
          },
          {
            "trigger": "pShortcut is set to empty",
            "effect": "The script uses pGroup. If both are empty, the single export method is not effectively targeted.",
            "cascade": [
              "pGroup"
            ]
          },
          {
            "trigger": "onlySelection is set to |No|",
            "effect": "The script searches the entire model for elements marked with the 'HSB_E-Replicator' script to include all related identical elements in the export.",
            "cascade": []
          },
          {
            "trigger": "export is set to |Yes|",
            "effect": "Triggers the ModelMap().callExporter function, utilizing the configuration from pGroup or pShortcut.",
            "cascade": [
              "pGroup",
              "pShortcut",
              "onlySelection"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Production Files (BTL/MPR/etc)",
            "description": "Digital files containing geometry and machining data used by CNC machines in the factory.",
            "appliedTo": "The specific elements or entities selected for the delivery."
          },
          {
            "type": "Element Quantities",
            "description": "Updates the manufacturing quantity attribute on elements, resetting non-exported items to 0 if their quantity is not locked.",
            "appliedTo": "All elements in the model (impacted by the reset logic)."
          },
          {
            "type": "Delivery Record (MapX)",
            "description": "Creates a persistent record in the hsbCAD project data storing which elements were in which delivery, along with dates and user info.",
            "appliedTo": "Project Database."
          }
        ]
      },
      "tokens_used": 8117,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initialization and Unit check",
          "Load properties from Catalog (Execute Key or LastInserted)",
          "Check execution context (InsertCycle, Map presence, Debug mode)",
          "Branch: Is this a new insertion or force unique selection?",
          "Branch (New Insertion): Prompt User to select Elements",
          "Branch (User presses Enter): Prompt User to select Entities (non-Elements)",
          "Branch (User selects Elements): Validate selection set is not empty",
          "Display Properties Dialog (if not triggered by execute key)",
          "Reset project-wide element quantities to 0 (for unlocked items)",
          "Scan existing Delivery Maps and remove selected elements from previous deliveries (Reassignment logic)",
          "Branch: Check 'Use unique elements' property",
          "Path (Use unique elements = No): Expand selection to include all linked Replicator elements",
          "Retrieve/Create Delivery Map structure in ProjectX",
          "Calculate and set quantities for elements in current delivery",
          "Update ProjectX Map with Delivery Name, Description, Date, and Export Group",
          "Branch: Check 'Export' property",
          "Path (Export = Yes): Configure ModelMap flags and run Exporter (generate files)",
          "Update all instances of 'HSB_G-ExportInformation' script with current properties",
          "Script self-destruction (eraseInstance)"
        ],
        "conditionalBranches": [
          {
            "condition": "Property Source Determination",
            "path1": {
              "name": "Execute Key",
              "steps": [
                "Check if _kExecuteKey exists in catalog 'HSB_G-ReplicatorExport'",
                "Load property values from specific Execute Key"
              ]
            },
            "path2": {
              "name": "Default / Last Used",
              "steps": [
                "Load property values from '|_LastInserted|' catalog"
              ]
            }
          },
          {
            "condition": "Selection Input Method",
            "path1": {
              "name": "Select Elements",
              "steps": [
                "User selects at least one Element",
                "Append Elements to selection array"
              ]
            },
            "path2": {
              "name": "Select Entities",
              "steps": [
                "User presses ENTER at first prompt (skips Element selection)",
                "Prompt user to select generic Entities",
                "Append Entities to selection array"
              ]
            },
            "path3": {
              "name": "Empty Selection",
              "steps": [
                "User provides no input",
                "Display error/silent fail",
                "Erase script instance and exit"
              ]
            }
          },
          {
            "condition": "Replication Expansion ('Use unique elements' property)",
            "path1": {
              "name": "No (Expand Replicators)",
              "steps": [
                "Iterate through selected elements",
                "Check for 'HSB_E-Replicator' script attached to elements",
                "If found, retrieve all linked elements from the Replicator map",
                "Add all linked elements to the export list"
              ]
            },
            "path2": {
              "name": "Yes (Unique Only)",
              "steps": [
                "Use strictly the visually selected elements/entities",
                "Ignore Replicator links"
              ]
            }
          },
          {
            "condition": "Export Execution ('Export' property)",
            "path1": {
              "name": "Yes (Run Export)",
              "steps": [
                "Configure ModelMapComposeSettings (Solid info, Tool info, etc.)",
                "Execute ModelMap().callExporter",
                "Generate production files (BTL/MPR) to destination folder"
              ]
            },
            "path2": {
              "name": "No (Delivery Only)",
              "steps": [
                "Skip ModelMap().callExporter",
                "Only update ProjectX Delivery records and Element quantities"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selection Set Length",
            "errorMessage": "None (Script exits silently)",
            "recovery": "User must restart script and select valid entities."
          },
          {
            "check": "Element Validity and Lock Status",
            "errorMessage": "Internal logic check",
            "recovery": "Script skips resetting quantity if Element is invalid or 'AmountLocked' is true in MapX."
          },
          {
            "check": "Exporter Configuration",
            "errorMessage": "Tsl::callExporter failed (if export fails)",
            "recovery": "Check ModelMap settings for Group/Shortcut and permissions."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Script Self-Removal",
            "how": "Automatic via code logic",
            "effect": "The script instance erases itself immediately after execution (if _bOnDbCreated). It leaves no graphical trace in the model."
          },
          {
            "action": "Update Information Scripts",
            "how": "Internal Loop",
            "effect": "Finds all 'HSB_G-ExportInformation' scripts in the drawing and updates their properties to match the current export settings, then recalculates them."
          },
          {
            "action": "Project Data Update",
            "how": "MapX",
            "effect": "Persists the delivery record and quantities in the Project database (ProjectX), allowing for later review or re-export."
          }
        ]
      },
      "tokens_used": 10484,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-ReplicatorExport\n\n## Overview\nThis script manages the creation of delivery lists, updates production quantities, and exports timber construction data to external formats (like BTL or Palletizer) for specific project phases or shipments.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be run in Model Space where Elements and Entities exist. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Entities/Elements**: Your drawing must contain Elements or Entities in Model Space to be exported.\n- **ModelMap Configuration**: Exporter Groups and Shortcuts must be defined in your hsbCAD ModelMap settings.\n- **Replicator Script (Optional)**: If you plan to use the \"Use unique elements: No\" option, the target elements should have the `HSB_E-Replicator` script attached to ensure all linked elements are included.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_G-ReplicatorExport.mcr` from the file browser.\n\n### Step 2: Select Elements or Entities\n```\nCommand Line: Select a set of elements or <ENTER> to select entities\nAction: Select the Elements you wish to export. If you want to select generic entities instead, press ENTER.\n```\n\n### Step 3: Select Entities (Optional)\nIf you pressed ENTER in the previous step:\n```\nCommand Line: Select entities\nAction: Select the specific entities (beams, plates, etc.) for the delivery.\n```\n\n### Step 4: Configure Properties\nAfter selection, the Properties dialog will appear.\n1.  Set the **Delivery name** and **Description name** to identify this shipment.\n2.  Select an **Exporter group** or **Single export** from the dropdown lists (populated from your ModelMap settings).\n3.  Toggle **Export** to `|Yes|` to generate files, or `|No|` to only update the delivery list (dry run).\n4.  Click OK to confirm.\n\n### Step 5: Execution\nThe script will automatically:\n1.  Reset project-wide quantities for unlocked items.\n2.  Update quantities for the selected delivery.\n3.  Generate production files (if Export was set to Yes).\n4.  Update the project database with the delivery details.\n5.  Remove itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Exporter group | dropdown | \"\" | Select the predefined export configuration (e.g., 'Weinmann', 'Standard BTL'). If empty, the Single export is used. |\n| Single export | dropdown | \"\" | Select a specific individual export shortcut. Used if the Exporter group is empty. |\n| Delivery name | text | \\|New delivery\\| | The identifying name for this shipment/batch (e.g., 'Phase 1 - Ground Floor'). |\n| Description name | text | \\|New description\\| | Additional details about the delivery (e.g., destination site, floor level). |\n| Use unique elements | dropdown | \\|No\\| | If set to \\|No\\|, the script includes all replicated/linked elements. If set to \\|Yes\\|, only the specific items you clicked are exported. |\n| Export | dropdown | \\|No\\| | If set to \\|Yes\\|, production files are generated. If set to \\|No\\|, only internal quantity updates and metadata occur (dry run). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Catalog Execute Keys | Allows pre-configuring the script properties via a specific Catalog entry before insertion. |\n\n## Settings Files\n- **ModelMap Settings**: Used internally to determine available Exporter Groups and Shortcuts.\n- **Catalog Entries**: Catalog entries for `HSB_G-ReplicatorExport` or `_LastInserted` are used to store default property presets.\n\n## Tips\n- **Dry Run**: Set the **Export** property to `|No|` initially. This updates the delivery list and quantities in the project without creating the actual physical files, allowing you to verify the selection.\n- **Linked Elements**: If your project uses identical elements (replicated), keep **Use unique elements** set to `|No|` to ensure all instances in the model are accounted for in the production count.\n- **Script Removal**: This script is designed to run once and automatically delete itself from the drawing after execution. Do not look for the script instance after running it.\n\n## FAQ\n- **Q: What happens if both \"Exporter group\" and \"Single export\" are empty?**\n  A: The script will update the delivery quantities but will not perform any export operation, effectively acting as a dry run.\n- **Q: Can I undo the delivery creation?**\n  A: You can undo the command (Ctrl+Z) if done immediately, but since it updates ProjectX (database) data, it is recommended to verify the delivery list manually or delete the delivery entry in the project manager if needed.\n- **Q: Why did my quantities reset for other items?**\n  A: The script resets the manufacturing quantity of all unlocked elements to 0 before applying the new quantities for the current delivery. This ensures the delivery list accurately reflects *only* the items currently being exported."
      },
      "tokens_used": 6462,
      "error": null
    }
  }
}