{
  "filename": "ManagePlotViewport.mcr",
  "status": "completed",
  "total_tokens": 44643,
  "processing_time": 316.5695466995239,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.4",
            "date": "15.06.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-12228 when applying to a panel potential masterpanel data is written to the panel"
          },
          {
            "version": "1.3",
            "date": "19.04.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11603 masterpanel data consumed if no submapX data present but nested within current dwg"
          },
          {
            "version": "1.2",
            "date": "09.04.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11305 plotview updated when linked to individual entity"
          },
          {
            "version": "1.1",
            "date": "23.03.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11305 potential masterpanel properties need to be prefixed with 'Masterpanel.', i.e.'Masterpanel.Number'"
          },
          {
            "version": "1.0",
            "date": "23.02.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-10869 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7412,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": true,
          "detectionEvidence": "Script uses PlotViewport.dbCreate(sLayout, _Pt0) and Layout().getAllEntryNames() to create and manage viewports in layouts. Iterates through MultiPage entities to generate corresponding viewports. Uses Group().collectEntities(..., _kModelSpace) only to read defining entity properties (GenBeam/Sip)."
        },
        "prerequisites": {
          "requiredEntities": [
            "MultiPage",
            "PlotViewport"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout)",
          "requiredSettings": []
        }
      },
      "tokens_used": 6684,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select multipages and plot viewports|, |<Enter> to insert a single plot viewport|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getEntity",
              "promptOriginal": null,
              "condition": "_bOnInsert && _Entity.length()<1",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_bOnInsert && _Entity.length()<1",
              "required": true
            },
            {
              "step": 4,
              "function": "PrEntity",
              "promptOriginal": "|Select defining entity||<Empty> to remove existing|",
              "condition": "_bOnRecalc && (_kExecuteKey==|Select defining entity| || _kExecuteKey==TslDoubleClick)",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "@(Name)",
            "inputType": "dropdown",
            "options": [
              "@(Name)"
            ],
            "category": "Naming",
            "description": "Defines the format of the plot viewport naming based on the defining entity"
          },
          {
            "index": 1,
            "variable": "sLayout",
            "type": "PropString",
            "displayName": "Layout",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "Layout().getAllEntryNames().sorted()"
            ],
            "category": "Creation",
            "description": "Defines the layout name of a new plotviewport, if no existing was found or selected"
          },
          {
            "index": 0,
            "variable": "dHorizontalOffset",
            "type": "PropDouble",
            "displayName": "Horizontal Offset",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "Creation",
            "description": "Defines the HorizontalOffset"
          },
          {
            "index": 1,
            "variable": "dVerticalOffset",
            "type": "PropDouble",
            "displayName": "Vertical Offset",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "Creation",
            "description": "Defines the VerticalOffset"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Select defining entity|",
            "handler": "|Select defining entity|",
            "action": "Prompts user to select a defining entity for the selected plot viewport or remove existing assignment.",
            "alsoTriggeredBy": "Double-click (TslDoubleClick)"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8566,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation, naming, and management of plot viewports in Layouts (Paper Space) based on MultiPages or defining entities in Model Space.",
          "category": "ShopDrawing/Documentation",
          "typicalUseCase": "Used when generating production drawings to automatically link Paper Space viewports to specific model entities (like walls or panels), ensuring correct labeling and Position Numbers (PosNum) on the plotted sheets."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(Name)",
            "businessMeaning": "Defines the naming convention for the Plot Viewport. It dynamically pulls properties (like Name, Number) from the linked model entity (e.g., a wall or panel) to label the viewport on the drawing layout.",
            "validRange": "String format tokens (e.g., @(Name), @(Number), Masterpanel.Number)",
            "unit": "String",
            "affectsOutput": "Alters the text label/name assigned to the PlotViewport entity in the layout. Does not change geometry, but changes identification in drawing headers or lists."
          },
          {
            "name": "sLayout",
            "technicalDefault": "Layout().getAllEntryNames().sorted()",
            "businessMeaning": "Specifies the target drawing sheet (Layout tab) where the Plot Viewport should be created or managed.",
            "validRange": "Existing Layout names in the current drawing (e.g., 'A1 Plan', 'Section A')",
            "unit": "String",
            "affectsOutput": "Determines the physical location (Paper Space tab) where the viewport geometry is created."
          },
          {
            "name": "dHorizontalOffset",
            "technicalDefault": "U(0)",
            "businessMeaning": "Adjusts the insertion position of the viewport horizontally from the calculated center of the MultiPage entity.",
            "validRange": "-1000mm to 1000mm (or drawing extents)",
            "unit": "mm",
            "affectsOutput": "Shifts the newly created PlotViewport left or right in Paper Space relative to the model entity's projected position."
          },
          {
            "name": "dVerticalOffset",
            "technicalDefault": "U(0)",
            "businessMeaning": "Adjusts the insertion position of the viewport vertically from the calculated center of the MultiPage entity.",
            "validRange": "-1000mm to 1000mm (or drawing extents)",
            "unit": "mm",
            "affectsOutput": "Shifts the newly created PlotViewport up or down in Paper Space relative to the model entity's projected position."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFormat contains 'Masterpanel.*' references",
            "effect": "Script attempts to resolve Masterpanel properties from nested SIP/XRef data. If the defining entity is a GenBeam/Sip, it looks up the hierarchy to find the Masterpanel info.",
            "cascade": [
              "sFormat"
            ]
          },
          {
            "trigger": "Entity is linked to a GenBeam",
            "effect": "The PlotViewport's PosNum (Position Number) is automatically synchronized with the GenBeam's PosNum.",
            "cascade": [
              "sFormat (implicitly via entity data)"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PlotViewport",
            "description": "A Paper Space viewport representing a view of the model. It is named according to the sFormat rule and positioned based on the entity's extent plus offsets.",
            "appliedTo": "Layouts (Paper Space)"
          }
        ]
      },
      "tokens_used": 6472,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script Insertion: User launches script.\",\n    \"2. Properties Initialization: Dialog appears or catalog values are loaded (based on _kExecuteKey). User confirms settings (Format, Layout, Offsets).\",\n    \"3. Selection Prompt: Command line asks to 'Select multipages and plot viewports' or '<Enter> to insert a single plot viewport'.\",\n    \"4. [Branch] Selection Evaluation:\",\n    \"   - If User presses Enter (No selection): Prompt for Point -> Create single PlotViewport at point -> Set Name -> Finish.\",\n    \"   - If User selects Entities: Filter valid MultiPage and PlotViewport entities.\",\n    \"5. [Branch] Entity Type Processing:\",\n    \"   - If MultiPages found: Iterate through MultiPages -> Get Defining Entity (GenBeam) -> Resolve Masterpanel Data -> Calculate Hull/Geometry -> Find/Create PlotViewport -> Apply Name/PosNum -> Erase Script Instance.\",\n    \"   - If Only PlotViewports found (No MultiPages): Enter 'Management Mode'. Script creates persistent instance linked to PlotViewport.\",\n    \"6. [Management Mode] Update & Display: Script reads PlotViewport position -> Draws preview text -> Updates PlotViewport Name/PosNum based on linked defining entity.\",\n    \"7. [Management Mode] Interaction: User can Double-click or use Right-click menu 'Select defining entity' to re-link the PlotViewport to a different model entity (e.g., a different wall/panel).\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"User input at Selection Prompt (Step 3)\",\n      \"path1\": {\n        \"name\": \"Empty Selection (Single Creation)\",\n        \"steps\": [\n          \"Prompt for Insertion Point (_Pt0).\",\n          \"Execute PlotViewport.dbCreate(sLayout, _Pt0).\",\n          \"Set PlotViewport name using sFormat.\",\n          \"Script finishes (Erase).\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Selection Set (Batch/Management)\",\n        \"steps\": [\n          \"Separate selected entities into MultiPages and PlotViewports.\",\n          \"Proceed to Entity Type Processing (Step 5).\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Content of Selection Set (Step 5)\",\n      \"path1\": {\n        \"name\": \"Contains MultiPages (Batch Generation)\",\n        \"steps\": [\n          \"Extract defining GenBeam from MultiPage.\",\n          \"Check for Masterpanel/Sip relations (nested data).\",\n          \"Calculate Convex Hull of MultiPage geometry.\",\n          \"Search for existing PlotViewport intersecting Hull.\",\n          \"If found: Update Name/PosNum.\",\n          \"If not found: Create new PlotViewport at Hull center + Offsets.\",\n          \"Erase script instance from drawing.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Only PlotViewports (Link Management)\",\n        \"steps\": [\n          \"Create persistent script instance.\",\n          \"Add 'Select defining entity' context menu trigger.\",\n          \"Display formatted text at Viewport location.\",\n          \"Wait for user interaction (Double-click or Recalc).\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Masterpanel Data Resolution (Inside MultiPage loop)\",\n      \"path1\": {\n        \"name\": \"Data available in subMapX\",\n        \"steps\": [\n          \"Read 'Masterpanel' map directly from SIP.\",\n          \"Populate variables (Masterpanel.Number, Masterpanel.Name, etc.).\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Data missing in subMapX (HSB-11603/HSB-12228)\",\n        \"steps\": [\n          \"Iterate ChildPanels to find parent MasterPanel.\",\n          \"Read MasterPanel properties.\",\n          \"Write MasterPanel data back to SIP subMapX.\",\n          \"Populate variables.\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Defining Entity Validity\",\n      \"errorMessage\": \"None (Silent failure)\",\n      \"recovery\": \"If GenBeam is not found in"
      },
      "tokens_used": 9768,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ManagePlotViewport.mcr\n\n## Overview\nThis script automates the creation, naming, and management of plot viewports in Paper Space layouts. It links viewports to model entities (such as walls or panels) to automatically apply labels and Position Numbers (PosNum) based on specific formatting rules.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Partial | Used to read properties from defining entities (GenBeam, Sip) but viewports are created elsewhere. |\n| Paper Space | Yes | Primary workspace for creating and managing PlotViewport entities. |\n| Shop Drawing | Yes | Designed for generating production drawings and plotting layouts. |\n\n## Prerequisites\n- **Required Entities**: `MultiPage` elements (for batch generation) or existing `PlotViewport` entities (for management).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None required internally; relies on standard Layout definitions.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `ManagePlotViewport.mcr`\n\n### Step 2: Select Objects\n```\nCommand Line: Select multipages and plot viewports or <Enter> to insert a single plot viewport\nAction:\n  - To create multiple viewports: Select MultiPage entities in the drawing.\n  - To manage existing viewports: Select existing PlotViewport entities.\n  - To create one viewport manually: Press Enter.\n```\n\n### Step 3: Define Insertion Point (If <Enter> was pressed)\n```\nCommand Line: [Point Prompt]\nAction: Click in the desired Layout (Paper Space) to place the new PlotViewport.\n```\n\n### Step 4: Management Mode (If existing Viewports were selected)\n```\nAction: The script instance will remain attached to the selected viewports. You can now:\n  1. Double-click the viewport to re-link it to a different defining entity (e.g., a different wall).\n  2. Right-click to access context menu options.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | String | @(Name) | Defines the naming convention for the viewport. Uses tokens like `@(Name)`, `@(Number)`, or `Masterpanel.Number` to pull data from the linked model entity. |\n| Layout | String | (Current Layout) | Specifies the target Layout tab where the PlotViewport will be created or managed. |\n| Horizontal Offset | Double | 0 | Shifts the viewport position horizontally (left/right) from the calculated center point. |\n| Vertical Offset | Double | 0 | Shifts the viewport position vertically (up/down) from the calculated center point. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Select defining entity | Prompts you to select a model entity (e.g., a beam or panel). The viewport will update its Name and PosNum to match the selected entity. |\n\n## Settings Files\n- None used.\n\n## Tips\n- **Batch Generation**: Select multiple MultiPages at once to automatically generate viewports for all of them. The script calculates the required view size based on the MultiPage geometry.\n- **Masterpanel Labels**: If your project uses Masterpanels, you can use the Format property `Masterpanel.Number` or `Masterpanel.Name` to label viewports with the parent assembly data rather than the individual part data.\n- **Updating Links**: If a viewport label is incorrect or out of date, select the viewport and use the \"Select defining entity\" context menu option to fix the association.\n\n## FAQ\n- **Q: How do I create a single viewport without selecting a MultiPage?**\n  A: Run the script and press **Enter** immediately when prompted to select objects. Then click the desired location in your layout.\n- **Q: The viewport name isn't updating.**\n  A: Ensure the viewport is linked to the correct defining entity. Select the viewport, right-click, and choose \"Select defining entity\" to re-associate it.\n- **Q: Can I use this to organize views of specific walls?**\n  A: Yes. Select the viewport in Management Mode and link it to the specific GenBeam or Wall element. The viewport will then adopt that entity's properties."
      },
      "tokens_used": 5741,
      "error": null
    }
  }
}