{
  "filename": "hsbViewRequest.mcr",
  "status": "completed",
  "total_tokens": 50439,
  "processing_time": 482.6419725418091,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.1",
            "date": "23.11.2022",
            "author": "Thorsten Huck",
            "changes": "HSB-17135 painter definitions recreated in any dwg"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6591,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script collects a 'Section2d' entity via collectEntity. Uses 'ms2ps' (Model Space to Paper Space) transformation variable. Checks for '_Viewport.length() > 0'. Handles 'PainterDefinition' data and 'Display' drawing in 2D."
        },
        "prerequisites": {
          "requiredEntities": [
            "Section2d"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be attached to or associated with a Section2d entity.",
          "requiredSettings": [
            "PainterDefinition (specifically looking for 'Dimension' collection)",
            "DimStyles"
          ]
        }
      },
      "tokens_used": 9066,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 9862,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Acts as a rendering engine that processes and draws annotation requests (dimensions, text, hatching) generated by 3D model scripts onto 2D sections or layout views.",
          "category": "ShopDrawing",
          "typicalUseCase": "Automating the transfer of dimensional data and labels from 3D timber elements to a specific 2D view, filtering the content so only relevant annotations (e.g., for elevation vs. plan) are displayed."
        },
        "parameters": [
          {
            "name": "sPainter",
            "technicalDefault": "\"<|Disabled|>\"",
            "businessMeaning": "Controls which group of annotation requests is displayed. It uses a Painter Definition to filter the requests generated by other scripts. Only requests associated with this painter (or within the 'Dimension' collection) are rendered.",
            "validRange": "Available Painter Definitions starting with 'Dimension\\', or '<Disabled>'",
            "unit": "Selection (String)",
            "affectsOutput": "Determines the visibility of specific annotation groups. If disabled, all compatible requests might be shown or none, depending on script logic, but typically restricts output to a specific subset defined in the painter."
          },
          {
            "name": "sExcludePainter",
            "technicalDefault": "\"<|Disabled|>\"",
            "businessMeaning": "Defines an exclusion filter to suppress annotation requests generated by specific TSL scripts. Useful for removing unwanted clutter (e.g., specific machining labels) from the current view.",
            "validRange": "Available Painter Definitions, or '<Disabled>'",
            "unit": "Selection (String)",
            "affectsOutput": "Removes annotations generated by TSLs that match the filter criteria defined in the selected Painter."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "\"<|Default|>\"",
            "businessMeaning": "Sets the graphical style (arrowheads, text font, line types) for the dimensions and text drawn by this script.",
            "validRange": "List of DimStyles available in the drawing",
            "unit": "Selection (String)",
            "affectsOutput": "Changes the visual appearance of the drawn lines and text to match the selected CAD DimStyle standard."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Overrides the text height for the annotations. A value of 0 respects the height defined in the originating model script's request; any other value forces a specific text size.",
            "validRange": ">= 0",
            "unit": "mm (Model Space units)",
            "affectsOutput": "Scales the text size of the drawn annotations. If set, it overrides the default height calculated or stored in the request map."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight > 0",
            "effect": "Overrides the text height defined in the individual annotation request ('mapRequests')",
            "cascade": [
              "dp.textHeight()"
            ]
          },
          {
            "trigger": "sPainter selection",
            "effect": "Filters the list of TSLs and requests processed before drawing",
            "cascade": [
              "tsls[]",
              "mapRequests[]"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Display Text",
            "description": "Text labels and dimension strings mapped from the 3D model to the current view.",
            "appliedTo": "The active Section2d or Viewport coordinate system."
          },
          {
            "type": "Display PlaneProfile",
            "description": "Hatched areas or filled polygons (e.g., timber grain shading, surface indicators).",
            "appliedTo": "The active Section2d or Viewport coordinate system."
          },
          {
            "type": "Display PLine",
            "description": "2D Polylines representing dimension lines, leader lines, or other geometry requests.",
            "appliedTo": "The active Section2d or Viewport coordinate system."
          }
        ]
      },
      "tokens_used": 8183,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Define constants, colors, and view vectors.",
          "2. Insert/Construct Phase: Check for '_bOnInsert' or '_bOnElementConstructed' flags.",
          "3. Catalog Processing: If inserting, read script catalogs to find embedded Painter Definition streams.",
          "4. Painter Setup: Restore or create missing PainterDefinitions in the current drawing based on catalog data.",
          "5. Filter Construction: Populate lists of available Painters (specifically looking for 'Dimension\\' collection) and DimStyles.",
          "6. Property Initialization: Set default values for 'Filter', 'Exclude Filter', 'Dimstyle', and 'Text Height'.",
          "7. User Insertion Dialog: Show property dialog to user (or load from catalog key).",
          "8. Context Selection: Attempt to collect a parent 'Section2d' entity.",
          "9. Coordinate System Calculation: Determine 'ms2ps' (Model to Paper Space) transformation based on Section2d or Viewport.",
          "10. Entity Collection: Identify relevant construction entities (Beams, Panels, Sheets, Elements) within the context.",
          "11. TSL Gathering: Collect all TSL scripts attached to the identified entities.",
          "12. Exclusion Filtering: Apply 'Exclude Painter' to remove unwanted TSLs from the list.",
          "13. Request Extraction: Iterate remaining TSLs to extract 'DimRequest[]' maps.",
          "14. View Filtering: Check if the request's 'AllowedView' vector matches the current drawing view.",
          "15. Rendering: Transform valid requests to 2D space and draw geometry (Text, PlaneProfiles, PLines).",
          "16. Debug Output: Display statistics or error message if no requests were found and debug mode is active."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Mode (_bOnInsert) vs Calculation Mode",
            "path1": {
              "name": "Insertion",
              "steps": [
                "Check for duplicate insert (insertCycleCount > 1) and erase if true.",
                "Load properties from catalog if executed via command key.",
                "Show Dialog if not using command key.",
                "Select Parent Entity (Section2d/Beam).",
                "Re-create PainterDefinitions in DWG if missing."
              ]
            },
            "path2": {
              "name": "Calculation/Update",
              "steps": [
                "Re-evaluate parent context (Section/Viewport).",
                "Re-scan attached TSLs.",
                "Re-filter and Re-draw requests."
              ]
            }
          },
          {
            "condition": "Parent Entity Type",
            "path1": {
              "name": "Section2d Context",
              "steps": [
                "Collect Section2d via collectEntity.",
                "Extract Coordinate System (cs) and Scale from Section.",
                "Filter entities visible in that section."
              ]
            },
            "path2": {
              "name": "Element/Beam Context",
              "steps": [
                "Use Element or GenBeam coordinate system.",
                "Map requests relative to the single element's position."
              ]
            }
          },
          {
            "condition": "Exclude Painter Selection (sExcludePainter)",
            "path1": {
              "name": "Filter Active (nExcludePainter > 0)",
              "steps": [
                "Retrieve PainterDefinition for exclusion.",
                "Identify TSLs accepted by the exclusion painter.",
                "Remove identified TSLs from the processing list."
              ]
            },
            "path2": {
              "name": "No Exclusion",
              "steps": [
                "Process all TSLs attached to the entity."
              ]
            }
          },
          {
            "condition": "Request Orientation (AllowedView)",
            "path1": {
              "name": "View Match",
              "steps": [
                "Calculate vector parallelism between Request vector and View Z.",
                "If parallel, add request to draw queue."
              ]
            },
            "path2": {
              "name": "View Mismatch",
              "steps": [
                "Discard request (do not draw in this view)."
              ]
            }
          },
          {
            "condition": "Request Geometry Type",
            "path1": {
              "name": "Text Request",
              "steps": [
                "Extract text string, point, and orientation vectors.",
                "Flip text if readable from 'bottom' logic applies.",
                "Apply DimStyle and TextHeight.",
                "Draw Display Text."
              ]
            },
            "path2": {
              "name": "PlaneProfile Request",
              "steps": [
                "Extract profile geometry.",
                "Union with existing profile.",
                "Apply Transparency and Color.",
                "Draw Display PlaneProfile."
              ]
            },
            "path3": {
              "name": "PLine Request",
              "steps": [
                "Extract Polyline.",
                "Project points to reference plane.",
                "Apply Color.",
                "Draw Display PLine."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Parent Entity Availability",
            "errorMessage": "No statistics or geometry generated; Script effectively idle.",
            "recovery": "Ensure the script is associated with a valid Section2d, Element, or GenBeam."
          },
          {
            "check": "Painter Definition Existence",
            "errorMessage": "N/A (Handled internally)",
            "recovery": "Script automatically recreates missing PainterDefinitions from catalog streams during insertion. If catalog is missing, filter will fail."
          },
          {
            "check": "Attached TSLs with Requests",
            "errorMessage": "Debug text shows 'No display requests could be found'.",
            "recovery": "Ensure the parent beams/elements have TSLs attached that generate 'DimRequest[]' map data."
          },
          {
            "check": "DimStyle Existence",
            "errorMessage": "N/A (Handled internally)",
            "recovery": "Script resets the DimStyle property to the first available style in the drawing if the selected one is not found."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Filter Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Changing 'Filter' or 'Exclude Filter' immediately triggers a recalc, showing or hiding annotation groups dynamically."
          },
          {
            "action": "Change Visual Appearance",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Updating 'Dimstyle' or 'Text Height' changes the font, arrowheads, and size of the drawn annotations instantly."
          },
          {
            "action": "Grip Edit (Move)",
            "how": "Click and drag script grip point",
            "effect": "If in Debug mode or no requests are found, moving the script moves the info text label."
          },
          {
            "action": "Viewport Updates",
            "how": "Change active Layout or Viewport scale",
            "effect": "The script detects the viewport change and re-transforms the annotation geometry to match the new Paper Space alignment."
          }
        ]
      },
      "tokens_used": 10248,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbViewRequest.mcr\n\n## Overview\nThis script acts as a rendering engine that automatically transfers dimension lines, text labels, and hatching from 3D model elements onto 2D sections or layout views. It filters these annotations based on view directions and painter definitions to ensure only relevant information is displayed.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used when attached to a Section2d entity in the model. |\n| Paper Space | Yes | Processes requests and transforms them to layout viewports. |\n| Shop Drawing | Yes | Specifically designed for generating 2D annotation details. |\n\n## Prerequisites\n- **Required Entities**: Must be associated with a `Section2d` entity (section cut) or a construction element (GenBeam/Element).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: \n  - `PainterDefinitions` (specifically those starting with 'Dimension\\') must exist in the drawing or catalog.\n  - `DimStyles` must be available in the current CAD file.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Select `hsbViewRequest.mcr` from the list of available scripts.\n\n### Step 2: Select Parent Entity\n**Command Line:** `Select Section/Element:`\n**Action:** Click on the `Section2d` (section cut) or the construction element (Beam/Panel) you wish to annotate.\n*Note: The script will attempt to automatically detect the coordinate system and scale from this entity.*\n\n### Step 3: Configure Filters (Properties Palette)\n**Action:** The Properties Palette will open automatically upon insertion.\n1. **Filter (`sPainter`)**: Select the Painter Definition (e.g., `Dimension\\Standard`) that groups the annotations you want to see.\n2. **Exclude Filter (`sExcludePainter`)**: Select a Painter if you want to hide specific types of annotations (e.g., `Machining`).\n3. **DimStyle**: Choose the desired visual style for dimensions (arrows, font, etc.).\n4. **Text Height**: Enter a value in mm to force a specific text size, or leave as `0` to use the default sizes.\n\n### Step 4: View Results\n**Action:** The script will scan the model, find valid annotation requests, and draw the text, lines, and hatching in the current view.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Filter** (`sPainter`) | Dropdown | `<Disabled>` | Selects which group of annotation requests (Painter) to display. Only requests matching this filter are drawn. |\n| **Exclude Filter** (`sExcludePainter`) | Dropdown | `<Disabled>` | Selects a Painter to suppress annotations generated by specific TSL scripts (e.g., remove machining labels). |\n| **DimStyle** (`sDimStyle`) | Dropdown | `<Default>` | Sets the graphical style (font, arrows, line type) for the drawn dimensions. |\n| **Text Height** (`dTextHeight`) | Number | `0` | Overrides the text height. Set to `0` to use the height defined in the model request; set > 0 to force a specific height (in mm). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Recalculate** | Refreshes the annotations based on the current model state, viewport settings, and property filters. |\n\n## Settings Files\n- **Filename**: Painter Definitions (Embedded or `.xml`)\n- **Location**: hsbCAD Catalog or Drawing internal dictionary\n- **Purpose**: Stores the logic for which annotations belong to which \"Painter\" or filter group (e.g., Dimension, Elevation, Plan).\n\n## Tips\n- **Dynamic Updates**: You do not need to delete and re-insert the script. Simply change the **Filter** or **DimStyle** in the Properties Palette, and the drawing will update automatically.\n- **View Specifics**: This script checks the \"Allowed View\" vector stored in the annotation request. If a dimension is meant for a \"Plan\" view, it will not appear in an \"Elevation\" view unless the vectors align.\n- **Troubleshooting**: If you see the message \"No display requests could be found\" in debug mode, ensure the parent beams/elements have TSL scripts attached that actually generate `DimRequest` data.\n- **Text Scaling**: If your annotations look too small or too large in Paper Space, try adjusting the `dTextHeight` parameter. Setting it to match your text style standard (e.g., 2.5mm) usually yields the best results for plotted drawings.\n\n## FAQ\n- **Q: Why don't I see any dimensions after inserting?**\n  - A: Ensure the parent entity has other TSL scripts attached (like connection or generation scripts) that create dimension requests. Also, check if your **Filter** (`sPainter`) is set correctly; setting it to `<Disabled>` might hide everything depending on your setup.\n- **Q: How do I hide specific labels (like drill holes) but keep dimensions?**\n  - A: Use the **Exclude Filter** (`sExcludePainter`) property. Select the Painter Definition that corresponds to the labels you want to hide.\n- **Q: The text is upside down or unreadable.**\n  - A: The script attempts to orient text based on view direction. If issues persist, check the underlying `DimStyle` settings or the text orientation vectors in the generating script."
      },
      "tokens_used": 6489,
      "error": null
    }
  }
}