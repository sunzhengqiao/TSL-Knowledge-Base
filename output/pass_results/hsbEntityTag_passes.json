{
  "filename": "hsbEntityTag.mcr",
  "status": "completed",
  "total_tokens": 55919,
  "processing_time": 748.3954050540924,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9131,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Script explicitly utilizes sdModel() and sdPageSet() to detect ShopDrawing contexts. It contains logic to handle _Viewport and checks for 'MultipageSheet' class names. Version history references 'MultiPage in model space', 'Shopdrawing viewport', and 'insert location on sections'. Code includes logic for both bHasPage and bIsBlockCreationMode, indicating operation in Model Space, Paper Space, and Block contexts."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element",
            "MetalPartCollectionEnt",
            "MasterPanel",
            "FastenerAssemblyEnt",
            "MultipageSheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (for 3D model tagging or MultiPage preparation) or Paper Space (for ShopDrawings/Sections).",
          "requiredSettings": [
            "Catalog entry for DimStyle/Tag configuration",
            "Painter definitions (optional, for filtering)"
          ]
        }
      },
      "tokens_used": 7161,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getGenBeam\",\n        \"promptOriginal\": \"Select entity\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Insert location\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getReal\",\n        \"promptOriginal\": \"Text height\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": false\n      },\n      {\n        \"step\": 4,\n        \"function\": \"getKword\",\n        \"promptOriginal\": \"[Painter filter]\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": false\n      }\n    ],\n    \"keywordOptions\": [\n      {\n        \"prompt\": \"[Painter filter]\",\n        \"options\": [\n          \"Painter filter\"\n        ]\n      }\n    ]\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"SelectOption\",\n      \"trigger\": \"During insertion when entities are selected\",\n      \"title\": \"Placement\",\n      \"dataSource\": \"Script internal\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    },\n    {\n      \"type\": \"SelectOption\",\n      \"trigger\": \"During insertion if xRefs or Blocks are found\",\n      \"title\": \"Select XRef/Block content\",\n      \"dataSource\": \"Detected xRefs/Blocks in the model\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": true\n      }\n    },\n    {\n      \"type\": \"SelectFromList\",\n      \"trigger\": \"When user selects 'Painter filter' keyword\",\n      \"title\": \"Select Painter filter\",\n      \"dataSource\": \"hsbPainter\",\n      \"features\": {\n        \"searchable\": true,\n        \"multiSelect\": true\n      }\n    },\n    {\n      \"type\": \"AskYesNo\",\n      \"trigger\": \"During insertion if 'Select XRef/Block content' was used previously\",\n      \"title\": \"Update xRef/Block selection?\",\n      \"dataSource\": \"User input\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    },\n    {\n      \"type\": \"GetText\",\n      \"trigger\": \"During insertion via Property 'TextOverride'\",\n      \"title\": \"Input Text\",\n      \"dataSource\": \"User input\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"pStrKey\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Key\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Visible Set of Entities\",\n        \"Entity Filter\",\n        \"Set of Entities\",\n        \"Manual Selection\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"pStrEntityFilter\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Entity Filter\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Painter filter name\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"pStrShowSet\",\n      \"type\": \"PropString\",\n      \"displayName\": \"ShowSet\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"pStrSet"
      },
      "tokens_used": 9912,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automatically generates smart tags/labels for timber elements (beams, panels, hardware) in 3D models or 2D shop drawings, displaying dynamic data like quantities, dimensions, and custom properties.\",\n    \"category\": \"Shop Drawing / Annotation\",\n    \"typicalUseCase\": \"Labeling a group of studs in a wall elevation to show the total quantity (e.g., 'Qty: 10') and dimensions, or marking specific connection hardware in a section detail.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"pStrKey\",\n      \"technicalDefault\": \"\\\"Visible Set of Entities\\\"\",\n      \"businessMeaning\": \"Defines the scope of entities the tag represents. Determines how the script finds the elements to label (e.g., everything currently visible, everything matching a filter, or a specific pre-defined set).\",\n      \"validRange\": \"Dropdown: Visible Set of Entities, Entity Filter, Set of Entities, Manual Selection\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Controls which entities are analyzed and included in the tag's quantity or data calculation.\"\n    },\n    {\n      \"name\": \"pStrEntityFilter\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"The name of the hsbCAD Painter filter used to select entities if the 'Key' is set to 'Entity Filter'. Allows targeting specific types or classes of elements.\",\n      \"validRange\": \"Any existing Painter filter name in the project\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"Filters the list of entities counted or described by the tag.\"\n    },\n    {\n      \"name\": \"pStrShowSet\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"The name of the ShowSet (Entity Set) used to select entities if the 'Key' is set to 'Set of Entities'. Used for logical grouping in drawings.\",\n      \"validRange\": \"Any existing ShowSet name in the project\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"Restricts the tag's data calculation to only entities belonging to the specified ShowSet.\"\n    },\n    {\n      \"name\": \"pStrPlacement\",\n      \"technicalDefault\": \"\\\"Default\\\"\",\n      \"businessMeaning\": \"Strategy for determining where the tag text and leader are positioned relative to the entity.\",\n      \"validRange\": \"Options defined in script (e.g., Default, Section-aligned, Centroid)\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Changes the insertion point and orientation of the tag graphics.\"\n    },\n    {\n      \"name\": \"pDblTextHeight\",\n      \"technicalDefault\": \"2.5\",\n      \"businessMeaning\": \"The height of the text in the tag.\",\n      \"validRange\": \"1.0 - 100.0 (typical drawing sizes)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Scales the text size and often the leader/shape size proportionally.\"\n    },\n    {\n      \"name\": \"pStrLeaderStyle\",\n      \"technicalDefault\": \"\\\"Standard\\\"\",\n      \"businessMeaning\": \"Visual style of the line connecting the tag to the entity.\",\n      \"validRange\": \"None, Single, Multi, Dot, Arrow\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Draws specific polyline geometry (arrows, dots, or straight lines) pointing to the referenced entity.\"\n    },\n    {\n      \"name\": \"pStrShape\",\n      \"technicalDefault\": \"\\\"None\\\"\",\n      \"businessMeaning\": \"Background shape drawn behind the text for emphasis or visibility.\",\n      \"validRange\": \"None, Rectangle, Revision Cloud, Triangle\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Draws a filled or outlined profile (Polyline/Polygon) around the text.\"\n    },\n    {\n      \"name\": \"pIntTransparency\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Opacity level of the background shape (if any).\",\n      \"validRange\": \"0 (Solid/Opaque) - 100 (Fully Transparent)\",\n      \"unit\": \"percent\",\n      \"affectsOutput\": \"Changes the visual fill style of the tag's background shape.\"\n    },\n    {\n      \"name\": \"pStrEqualityFormat\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Defines the logic for comparing entities to determine if they are 'identical' for grouping and quantity calculation.\",\n      \"validRange\": \"TSL format string (e.g., 'Length', 'Length,Width,Height')\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"Alters the calculated 'Quantity' displayed by determining which entities are grouped together.\"\n    },\n    {\n      \"name\": \"pStrTextOverride\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Manual text string to display instead of the automatic property calculation.\",\n      \"validRange\": \"Any alphanumeric string\",\n      \"unit\": \"string\",\n      \"affectsOutput\": \"Replaces dynamic data tags with static text.\"\n    },\n    {\n      \"name\": \"pIntXRefSelection\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Flag to enable selection of entities nested within External References (XRefs) or Blocks.\",\n      \"validRange\": \"0 (Off), 1 (On)\",\n      \"unit\": \"boolean\",\n      \"affectsOutput\": \"Expands the search scope for taggable entities to include nested XRef geometry.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"pStrKey is set to 'Entity Filter'\",\n      \"effect\": \"Enables and requires pStrEntityFilter to define the filter criteria.\",\n      \"cascade\": [\n        \"pStrEntityFilter\"\n      ]\n    },\n    {\n      \"trigger\": \"pStrKey is set to 'Set of Entities'\",\n      \"effect\": \"Enables and requires pStrShowSet to define the entity set.\",\n      \"cascade\": [\n        \"pStrShowSet\"\n      ]\n    },\n    {\n      \"trigger\": \"pStrShape is set to 'None'\",\n      \"effect\": \"Renders pIntTransparency and background color settings irrelevant as no shape is drawn.\",\n      \"cascade\": [\n        \"pIntTransparency\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type"
      },
      "tokens_used": 10478,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"User launches script (hsbEntityTag.mcr)\",\n    \"System checks Property 'Key' (Selection Mode)\",\n    \"[Conditional] If Key is NOT 'Visible Set of Entities': Prompt 'Select entity' (getGenBeam)\",\n    \"[Conditional] If Key is NOT 'Visible Set of Entities': Prompt 'Insert location' (getPoint)\",\n    \"Prompt 'Text height' (getReal)\",\n    \"[Optional] Command line option '[Painter filter]' appears. If selected: Show dialog 'Select Painter filter' (SelectFromList)\",\n    \"[Conditional] If XRefs/Blocks detected in model and 'XRef Selection' property enabled: Show dialog 'Select XRef/Block content' (SelectOption/Multi-select)\",\n    \"Script calculates entity set based on Key (Filter, ShowSet, Manual, or Visible)\",\n    \"Script applies 'Equality Format' to group entities and calculate quantities\",\n    \"Script resolves text string (using 'Text Override' or DimStyles/Properties)\",\n    \"Script constructs geometry (Shape, Text, Leader, Outline)\",\n    \"Tag is inserted into Model/Paper Space\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Selection Mode defined by Property 'Key'\",\n      \"path1\": {\n        \"name\": \"Manual/Filter/Set Mode\",\n        \"steps\": [\n          \"User must pick a base 'Defining Entity'\",\n          \"User must pick an insertion point\",\n          \"Tag calculates siblings based on filter/set criteria\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Visible Set of Entities Mode\",\n        \"steps\": [\n          \"No entity selection required\",\n          \"No point selection required (Auto-placement based on view logic)\",\n          \"Tag analyzes visible entities in current view/shopdrawing\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Property 'Leader Style' and Sibling count\",\n      \"path1\": {\n        \"name\": \"Multi-Leader\",\n        \"steps\": [\n          \"Script identifies multiple entities in the group sharing the same data/equality\",\n          \"Draws multiple leaders pointing to each distinct entity in the group\",\n          \"Connects leaders to a common junction point\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Single/Standard Leader\",\n        \"steps\": [\n          \"Draws one leader line/arrow/dot\",\n          \"Points from tag text to the defining entity\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Property 'Text Override' usage\",\n      \"path1\": {\n        \"name\": \"Static Text\",\n        \"steps\": [\n          \"If 'Text Override' string is not empty\",\n          \"Tag displays exactly the string entered, ignoring DimStyles/Quantities\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Dynamic Text\",\n        \"steps\": [\n          \"If 'Text Override' is empty\",\n          \"Tag resolves variables, DimStyles, and Quantity based on entity properties\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Entity Type Support\",\n      \"errorMessage\": \"Implicitly ignored if invalid type\",\n      \"recovery\": \"Select a supported GenBeam, Element, Panel, or MetalPart.\"\n    },\n    {\n      \"check\": \"Filter Result Count\",\n      \"errorMessage\": \""
      },
      "tokens_used": 12028,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbEntityTag.mcr\n\n## Overview\nThis script automatically generates smart tags and labels for timber elements (beams, panels, and hardware) in both 3D models and 2D shop drawings. It displays dynamic data such as quantities, dimensions, and custom properties based on your selection criteria.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used for 3D model tagging or preparing MultiPage views. |\n| Paper Space | Yes | Used for creating labels in Shop Drawings and detail views. |\n| Shop Drawing | Yes | Fully supported; detects viewports and section contexts. |\n\n## Prerequisites\n- **Required Entities**: GenBeam, Element, MasterPanel, MetalPartCollectionEnt, FastenerAssemblyEnt, or MultipageSheet.\n- **Minimum Beam Count**: 0 (Can tag single entities or empty sets depending on configuration).\n- **Required Settings**: A valid Catalog entry for DimStyle configuration to format the output text correctly.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Run the `TSLINSERT` command in AutoCAD.\n2.  Select `hsbEntityTag.mcr` from the list of available scripts.\n\n### Step 2: Select Entity (Condition Dependent)\n*If the **Key** property is NOT set to \"Visible Set of Entities\":*\n```\nCommand Line: Select entity\nAction: Click on a beam, panel, or element in the drawing to define the reference for the tag.\n```\n\n### Step 3: Define Insertion Point\n*If the **Key** property is NOT set to \"Visible Set of Entities\":*\n```\nCommand Line: Insert location\nAction: Click in the drawing where you want the tag label to appear.\n```\n\n### Step 4: Set Text Size\n```\nCommand Line: Text height <default>:\nAction: Type a number (in mm) and press Enter, or press Enter to accept the default size.\n```\n\n### Step 5: Apply Filters (Optional)\n```\nCommand Line: [Painter filter]\nAction: Click on the \"[Painter filter]\" keyword in the command line to open a dialog and select specific Painter filters to include in the tag count.\n```\n\n### Step 6: Handle XRefs (Conditional)\n*If External References or Blocks are detected and the **XRef Selection** property is enabled:*\n1.  A dialog titled \"Select XRef/Block content\" will appear.\n2.  Select the desired XRefs or Blocks from the list.\n3.  Confirm the selection.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Key | dropdown | Visible Set of Entities | Determines how the script selects entities to tag (e.g., all visible, by filter, by ShowSet, or manual selection). |\n| Entity Filter | text | \"\" | The name of the Painter filter to use if Key is set to \"Entity Filter\". |\n| ShowSet | text | \"\" | The name of the ShowSet to use if Key is set to \"Set of Entities\". |\n| Placement | dropdown | Default | Strategy for positioning the tag text and leader (e.g., Default, Section-aligned, Centroid). |\n| TextHeight | double | 2.5 | The height of the text in the tag (in mm). |\n| LeaderStyle | dropdown | Standard | Visual style of the leader line (None, Single, Multi, Dot, Arrow). |\n| Shape | dropdown | None | Background shape drawn behind the text (None, Rectangle, Revision Cloud, Triangle). |\n| Transparency | int | 0 | Opacity level of the background shape (0 = Solid/Opaque, 100 = Fully Transparent). |\n| EqualityFormat | string | \"\" | Logic for grouping entities (e.g., \"Length\" to group only beams of the same length). Affects the calculated Quantity. |\n| TextOverride | string | \"\" | Manual text to display instead of automatic data. If empty, the script calculates dynamic data. |\n| XRefSelection | int | 0 | Enables (1) or disables (0) the ability to select entities nested within External References or Blocks. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (Standard TSL Context) | Allows standard script recalculation or property editing via the Properties Palette. |\n\n## Settings Files\n- **Filename**: Catalog Entry (defined in hsbCAD configuration)\n- **Location**: Company or Install path (Varies by setup)\n- **Purpose**: Defines the DimStyle and text formatting used to display the tag content (e.g., how dimensions or quantities are formatted).\n\n## Tips\n- **Dynamic Quantities**: If you want the tag to count all identical items in a view, leave the **Key** as \"Visible Set of Entities\" and ensure the **EqualityFormat** matches the criteria you care about (e.g., \"Length,Width,Height\").\n- **Static Labels**: Use the **TextOverride** property to create static notes or stamps without linking them to specific element data.\n- **Background Shapes**: Use the **Shape** and **Transparency** properties to make tags stand out against complex drawing backgrounds.\n\n## FAQ\n- **Q: My tag shows \"Qty: 1\" but I see 10 identical beams. Why?**\n  - **A**: Check your **EqualityFormat** property. If it is empty, the script might be treating every beam as unique. Add the relevant properties (e.g., \"Length\") to group identical beams together.\n- **Q: How do I tag elements inside an XRef?**\n  - **A**: Set the **XRefSelection** property to `1` before inserting the script. You will then be prompted to select which XRef content to include.\n- **Q: Can I change the tag position without moving the text manually?**\n  - **A**: Yes, change the **Placement** property in the Properties Palette to switch between automatic alignment strategies (e.g., Centroid vs. Section-aligned)."
      },
      "tokens_used": 7209,
      "error": null
    }
  }
}