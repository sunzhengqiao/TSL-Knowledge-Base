{
  "filename": "StackPack.mcr",
  "status": "completed",
  "total_tokens": 48300,
  "processing_time": 321.09523725509644,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"3.4\",\n      \"date\": \"10.04.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB"
      },
      "tokens_used": 8837,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script contains no '#Type E' declarations or 'sd_' prefixes typical of ShopDrawing scripts. It operates on 'GenBeam' and 'Element' objects, creating a 3D stacking package. Display representations ('dpPlan', 'dpModel') use view directions (e.g., 'addViewDirection(_ZW)') consistent with model manipulation. The script uses 'TslUtilities.dll' for dialogs and handles property management ('PropDouble', 'PropString') for OPM interaction, typical of ModelSpace tools. Context commands ('addRecalcTrigger') are used for settings and import/export, not drawing generation."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "ModelSpace with valid timber elements (GenBeams or Elements) to process into stacks.",
          "requiredSettings": [
            "TslUtilities.dll (must be present in hsbCAD Utilities path)",
            "TruckDefinition (Configuration data source queried at runtime)"
          ]
        }
      },
      "tokens_used": 5501,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Function Call (RunDynamicDialog)",
            "title": "Dynamic Dialog",
            "dataSource": "Hardcoded Map definition",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "Property Dialog (tslDialog)",
            "trigger": "Context Menu: Color Rules",
            "title": "Properties Palette / Custom OPM Dialog",
            "dataSource": "PropString definitions in DialogMode 2",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sColorRule",
            "type": "PropString",
            "displayName": "|Color Rule|",
            "defaultValue": "|byLayer|",
            "inputType": "dropdown",
            "options": [
              "|byLayer|",
              "|byPackNumber|",
              "|byStackLayer|"
            ],
            "category": "|Item|",
            "description": "|Defines how items will be colored in model| |The color index which will be returned maybe used as index for sequential color assignments if the correspnding definition exists.|"
          },
          {
            "index": 1,
            "variable": "sColorRulePack",
            "type": "PropString",
            "displayName": "|Color Rule|",
            "defaultValue": "|byPackNumber|",
            "inputType": "dropdown",
            "options": [
              "|byPackNumber|",
              "|byStackLayer|"
            ],
            "category": "|Pack|",
            "description": "|Defines how packs will be colored in model| |The color index which will be returned maybe used as index for sequential color assignments if the correspnding definition exists.|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Color Rules|",
            "handler": "|Color Rules|",
            "action": "Opens a dialog to set the color rule logic for Items and Packs.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Import Settings|",
            "handler": "|Import Settings|",
            "action": "Imports script settings from an external XML file defined in sFullPath.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Export Settings|",
            "handler": "|Export Settings|",
            "action": "Exports current script settings to an external XML file defined in sFullPath.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Defined in sFullPath (Variable definition truncated)",
            "searchPaths": [],
            "purpose": "Import and Export of StackPack configuration settings (Color Rules, etc).",
            "required": false
          }
        ]
      },
      "tokens_used": 9033,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "A logistics and visualization tool for organizing timber elements into transport stacks and packages, verifying dimensions against truck definitions, and managing visual coding for production and shipping.",
          "category": "Logistics / Production Management",
          "typicalUseCase": "Used by production managers or detailers to group individual timber beams (GenBeams/Elements) into logical stack units for shipping, ensuring they fit within transport constraints and are visually distinct in the 3D model for easy identification."
        },
        "parameters": [
          {
            "name": "sColorRule",
            "technicalDefault": "|byLayer|",
            "businessMeaning": "Determines the visual coloring strategy for individual timber items within the stack. It allows the user to switch between standard CAD layer coloring (byLayer) and logistics-based coloring (byPackNumber or byStackLayer) to identify which items belong to which shipping unit or vertical layer.",
            "validRange": [
              "|byLayer|",
              "|byPackNumber|",
              "|byStackLayer|"
            ],
            "unit": "Enumeration (String)",
            "affectsOutput": "Changes the TrueColor property of the individual beam references in the model view. Does not affect physical geometry but significantly affects readability for logistics planning."
          },
          {
            "name": "sColorRulePack",
            "technicalDefault": "|byPackNumber|",
            "businessMeaning": "Determines the visual coloring strategy for the Pack (or Stack container) itself. This helps distinguish different transport units when multiple stacks are generated or placed in the model.",
            "validRange": [
              "|byPackNumber|",
              "|byStackLayer|"
            ],
            "unit": "Enumeration (String)",
            "affectsOutput": "Changes the color of the stack/package visualization geometry (the bounding box or representation of the package)."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Context Menu: 'Color Rules' executed",
            "effect": "Opens a TSL dialog to set sColorRule and sColorRulePack. Upon confirmation, updates the internal MapSetting and forces a recalculation of display properties.",
            "cascade": [
              "nColorRule",
              "nColorRulePack",
              "Item Display Properties",
              "Pack Display Properties"
            ]
          },
          {
            "trigger": "Change in 'sColorRule' or 'sColorRulePack'",
            "effect": "Triggers a refresh of the display pipeline (dpModel/dpPlan) to apply new color indices to the referenced GenBeams and Stack elements.",
            "cascade": [
              "Visual Color of Beams",
              "Visual Color of Stack Box"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Logical Grouping (Map/Link)",
            "description": "Creates data links (hsb_TruckParent/hsb_TruckChild) to associate timber elements with the stack package without physically moving the original geometry in the database, or creates visual representations in a specific location.",
            "appliedTo": "Selected GenBeams and Elements"
          },
          {
            "type": "Visualization Geometry (Body/Polyline)",
            "description": "Generates 3D bounding boxes or outlines representing the physical dimensions of the stack package, calculated based on the 'TruckDefinition' constraints.",
            "appliedTo": "ModelSpace (StackPack Instance)"
          }
        ]
      },
      "tokens_used": 9295,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User executes TSL command to insert StackPack",
          "Script prompts for selection of GenBeams or Elements (Inferred from Prerequisites/Usage)",
          "Script creates StackPack instance and links selected entities",
          "[Optional] User right-clicks StackPack instance to open Context Menu",
          "User selects 'Color Rules' to configure visual coding",
          "User selects 'Import/Export Settings' to manage configuration files",
          "Script updates MapSetting and refreshes display properties"
        ],
        "conditionalBranches": [
          {
            "condition": "User executes Context Menu command '|Color Rules|'",
            "path1": {
              "name": "Open Settings Dialog",
              "steps": [
                "Script sets DialogMode to 2",
                "TSL Dialog opens showing 'Color Rule' for Items and Packs",
                "User selects from options (byLayer, byPackNumber, byStackLayer)",
                "Script updates mapSetting with new integer indices",
                "Script updates MapObject in database"
              ]
            }
          },
          {
            "condition": "User executes Context Menu command '|Import Settings|'",
            "path1": {
              "name": "File Found",
              "steps": [
                "Script reads XML from sFullPath",
                "Populates internal mapSetting",
                "Updates MapObject in database",
                "Displays success message"
              ]
            },
            "path2": {
              "name": "File Not Found",
              "steps": [
                "Trigger condition fails (check in code: findFile(sFullPath).length()>0)",
                "Menu item is likely not shown or action is skipped"
              ]
            }
          },
          {
            "condition": "User executes Context Menu command '|Export Settings|'",
            "path1": {
              "name": "File Exists (Overwrite)",
              "steps": [
                "Script detects existing file at sFullPath",
                "Prompts user for confirmation via Command Line",
                "If confirmed: Overwrites XML file with current mapSetting",
                "If rejected: Aborts operation"
              ]
            },
            "path2": {
              "name": "File Does Not Exist",
              "steps": [
                "Script verifies path/folder existence (creates if needed)",
                "Writes current mapSetting to new XML file",
                "Displays success message"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Dialog Object Creation",
            "errorMessage": "Internal error: tslDialog failed to initialize.",
            "recovery": "Check hsbCAD environment and TSL integrity; script logic prevents execution if dialog is invalid (tslDialog.bIsValid())."
          },
          {
            "check": "Settings Data Availability (Export)",
            "errorMessage": "No settings data found to export.",
            "recovery": "Ensure mapSetting contains data (mapSetting.length() > 0)."
          },
          {
            "check": "File Overwrite Confirmation",
            "errorMessage": "Export cancelled by user to prevent data loss.",
            "recovery": "User must manually rename existing file or confirm overwrite."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Color Rules",
            "how": "Right-click Context Menu -> '|Color Rules|'",
            "effect": "Opens a secondary dialog to change how Items and Packs are colored (byLayer, byPackNumber, byStackLayer) and updates the display immediately."
          },
          {
            "action": "Import Configuration",
            "how": "Right-click Context Menu -> '|Import Settings|'",
            "effect": "Loads script properties from an external XML file into the current instance's MapObject."
          },
          {
            "action": "Export Configuration",
            "how": "Right-click Context Menu -> '|Export Settings|'",
            "effect": "Saves current script properties to an external XML file for reuse on other projects/machines."
          },
          {
            "action": "Rotate Package",
            "how": "Inferred Custom Command (v3.4 history)",
            "effect": "Rotates the stack package geometry."
          }
        ]
      },
      "tokens_used": 9990,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# StackPack\n\n## Overview\nThis script organizes timber elements into transport stacks and packages for logistics planning. It visualizes packing constraints using color coding and manages configuration settings for production and shipping.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used to organize and visualize 3D stacks of timber elements. |\n| Paper Space | No | Not intended for 2D layout or drawing generation. |\n| Shop Drawing | No | Does not generate manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities**: GenBeam or Element objects existing in the model.\n- **Minimum Beam Count**: 1.\n- **Required Settings**:\n  - `TslUtilities.dll` (must be available in the hsbCAD Utilities path).\n  - Truck Definition configurations (required for dimension validation).\n\n## Usage Steps\n\n### Step 1: Launch Script\n```\nCommand: TSLINSERT\nAction: Browse and select 'StackPack.mcr'.\n```\n\n### Step 2: Select Elements\n```\nCommand Line: Select elements / beams\nAction: Select the GenBeams or Elements you wish to group into a stack package from the model.\n```\n\n### Step 3: Place Visualization\n```\nCommand Line: Insertion point\nAction: Click in the Model Space to define the location for the stack visualization or bounding box.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Color Rule (Item) | dropdown | byLayer | Determines how individual timber items are colored. Options: byLayer, byPackNumber, byStackLayer. |\n| Color Rule (Pack) | dropdown | byPackNumber | Determines how the Pack/Stack container is colored. Options: byPackNumber, byStackLayer. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Color Rules | Opens a dialog to configure the visual color coding for both individual Items and Packs (e.g., coloring by layer vs. pack number). |\n| Import Settings | Loads script configuration (Color Rules, etc.) from an external XML file. |\n| Export Settings | Saves the current script configuration to an external XML file for reuse. |\n\n## Settings Files\n- **Filename**: Defined by `sFullPath` (variable inside script).\n- **Location**: User-specified path or default project folder.\n- **Purpose**: Stores and retrieves configuration data (such as Color Rules) to ensure consistency across different StackPack instances or projects.\n\n## Tips\n- Use the **Color Rules** feature to quickly identify which items belong to which shipping layer or package directly in the 3D model.\n- Save your preferred configuration using **Export Settings** and use **Import Settings** to apply the same standards to other StackPack instances in the project.\n- Ensure your Truck Definitions are up to date, as the script uses these to validate stack dimensions.\n\n## FAQ\n- **Q: How do I change the color of the beams in the stack?**\n  A: Select the StackPack object, open the Properties Palette (Ctrl+1), and change the \"Color Rule\" property for Items. Alternatively, right-click and select \"Color Rules\".\n  \n- **Q: Can I share my stack settings with a colleague?**\n  A: Yes. Right-click the StackPack object, choose \"Export Settings\" to create an XML file, and send it to your colleague. They can then use \"Import Settings\" to load your configuration.\n\n- **Q: Why didn't the script generate a stack?**\n  A: Ensure you have selected valid GenBeam or Element objects and that a valid Truck Definition is configured in your environment."
      },
      "tokens_used": 5644,
      "error": null
    }
  }
}