{
  "filename": "hsb_CreateMultielements.mcr",
  "status": "completed",
  "total_tokens": 51050,
  "processing_time": 219.95519161224365,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "23.05.2019",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "24.05.2019",
            "author": "AS",
            "changes": "Only allow one instance of the manager in the drawing. Set bounding box."
          },
          {
            "version": "1.8",
            "date": "5-2-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Move drawing of the multiElementNames outside of the CreateMultiElements loop to make it more flexible."
          },
          {
            "version": "1.7",
            "date": "15-1-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Add property to show multiElement names."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8380,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly uses collectEntities(..., _kModelSpace) for TslInst and ElementMulti. It processes Element objects and creates ElementMulti objects in the 3D model. No 'sd_' prefix, '#Type E' declarations, or Viewport handling found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (containing subMapX 'hsb_Multiwall')"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 6502,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Pick a point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "runtimePrompts": [
            {
              "step": 1,
              "function": "getElementMulti",
              "promptOriginal": "|Select Multielement|",
              "condition": "Context Menu: Refresh selected Multielement",
              "required": true
            }
          ]
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "verticalOffset",
            "type": "PropDouble",
            "displayName": " Vertical offset between multielements",
            "defaultValue": 4000.0,
            "inputType": "number",
            "category": "Spacing",
            "description": null
          },
          {
            "index": 1,
            "variable": "horizontalOffset",
            "type": "PropDouble",
            "displayName": " Horizontal offset between multielements",
            "defaultValue": 0.0,
            "inputType": "number",
            "category": "Spacing",
            "description": null
          },
          {
            "index": 0,
            "variable": "multielementFloorGroupName",
            "type": "PropString",
            "displayName": "Assign to group",
            "defaultValue": "Dynamic List",
            "inputType": "dropdown",
            "options": [],
            "category": "Assignment",
            "description": null
          },
          {
            "index": 2,
            "variable": "singleelementFloorGroupName",
            "type": "PropString",
            "displayName": "Single elements group",
            "defaultValue": "Dynamic List",
            "inputType": "dropdown",
            "options": [],
            "category": "Assignment",
            "description": null
          },
          {
            "index": 1,
            "variable": "groupingFormat",
            "type": "PropString",
            "displayName": "Grouping format",
            "defaultValue": "",
            "inputType": "text",
            "category": null,
            "description": "Specifies the format for grouping the multi-elements"
          },
          {
            "index": 3,
            "variable": "pGroupsToCheck",
            "type": "PropString",
            "displayName": "Groups to check",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|This|"
            ],
            "category": null,
            "description": "Specifies whether to check all groups or just the groups from this tsl"
          },
          {
            "index": 4,
            "variable": "pShowMultiElementNames",
            "type": "PropString",
            "displayName": "Show MultiElement Names",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": "Show the multiElement Names on the left side of the multiElements."
          }
        ],
        "contextMenu": [
          {
            "menuItem": "../Refresh all Multielements",
            "handler": "refreshMulitElementsCommand",
            "action": "Refreshes all multielements in the drawing based on single elements containing 'hsb_Multiwall' map data.",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "../Refresh selected Multielement",
            "handler": "refreshSingleMulitElementCommand",
            "action": "Prompts user to select a multielement, deletes it, and recreates it based on its constituent single elements.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Delete Multielement Metadata",
            "handler": "deleteMultielementMetaData",
            "action": "Removes the 'hsb_Multiwall' map data from all relevant single elements, effectively disassociating them from multielements.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9737,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation and management of 'Multielements' (assemblies of single Elements like walls/floors) by reading metadata attached to single elements and stacking/organizing them in 3D space.",
          "category": "Framing/ProjectManagement",
          "typicalUseCase": "Used in prefab timber construction to group individual walls or floors into transportable building blocks (stacks), visualize them in the model, and manage their assembly positions."
        },
        "parameters": [
          {
            "name": "verticalOffset",
            "technicalDefault": 4000.0,
            "businessMeaning": "The vertical distance (stacking height) between the base points of successive multielements (or floors) during arrangement.",
            "validRange": "1000 - 6000",
            "unit": "mm",
            "affectsOutput": "Positions the next multielement higher or lower in the Z-axis relative to the previous one, effectively simulating vertical stacking or floor separation."
          },
          {
            "name": "horizontalOffset",
            "technicalDefault": 0.0,
            "businessMeaning": "The horizontal spacing between groups of multielements when they are arranged based on grouping keys.",
            "validRange": "0 - 10000",
            "unit": "mm",
            "affectsOutput": "Moves the start position of a new group of multielements along the X-axis, ensuring grouped multielements do not overlap horizontally."
          },
          {
            "name": "multielementFloorGroupName",
            "technicalDefault": "Dynamic List",
            "businessMeaning": "The specific structural group (e.g., '01') to which the generated Multielement entities and their TSL instances are assigned.",
            "validRange": "Existing Group Names",
            "unit": "String",
            "affectsOutput": "Filters which existing multielements are refreshed and determines the group assignment for any newly created multielements or manager instances."
          },
          {
            "name": "singleelementFloorGroupName",
            "technicalDefault": "Dynamic List",
            "businessMeaning": "The specific structural group from which the script reads the source 'single elements' (walls/floors) to create multielements.",
            "validRange": "Existing Group Names",
            "unit": "String",
            "affectsOutput": "Filters the input elements. Only single elements within this group (and containing 'hsb_Multiwall' metadata) will be processed into multielements."
          },
          {
            "name": "groupingFormat",
            "technicalDefault": "",
            "businessMeaning": "A naming mask (e.g., 'Project-Phase') used to logically sort or cluster multielements before positioning.",
            "validRange": "Format Strings",
            "unit": "String",
            "affectsOutput": "Determines how multielements are sorted. If the grouping key changes between multielements, the horizontal offset is applied to start a new 'column' of multielements."
          },
          {
            "name": "pGroupsToCheck",
            "technicalDefault": "|All|",
            "businessMeaning": "Defines the scope of the script's search for elements—either the entire model or restricted to the specific groups selected in the properties.",
            "validRange": "|All|, |This|",
            "unit": "Option",
            "affectsOutput": "Controls filtering. If 'This', only 'multielementFloorGroupName' and 'singleelementFloorGroupName' are scanned. If 'All', the entire ModelSpace is scanned."
          },
          {
            "name": "pShowMultiElementNames",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Toggles the visual display of text labels (names/numbers) next to the generated multielements in the CAD model.",
            "validRange": "|Yes|, |No|",
            "unit": "Option",
            "affectsOutput": "Adds or removes 3D text entities displaying the Element name relative to the multielement's origin."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "pGroupsToCheck set to |This|",
            "effect": "Restricts the scope of multielementFloorGroupName and singleelementFloorGroupName. These properties must be set correctly for the script to find any entities.",
            "cascade": [
              "multielementFloorGroupName",
              "singleelementFloorGroupName"
            ]
          },
          {
            "trigger": "groupingFormat is set",
            "effect": "Enables sorting logic that utilizes horizontalOffset. If the format results in different grouping keys for adjacent multielements, they will be spaced out horizontally.",
            "cascade": [
              "horizontalOffset"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElementMulti",
            "description": "Creates composite elements representing a stack or assembly of single elements.",
            "appliedTo": "Newly generated Multi-elements based on Single Elements with 'hsb_Multiwall' map data."
          },
          {
            "type": "Text (Display)",
            "description": "Draws the MultiElement name next to the element if visualization is enabled.",
            "appliedTo": "Model Space (visualization only)."
          }
        ]
      },
      "tokens_used": 8476,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User inserts TSL instance into Model Space.",
          "2. Script checks for existing manager instances (Singleton enforcement); erases new instance if one exists.",
          "3. Properties are initialized (Floor group lists populated, offsets set).",
          "4. User prompted to select insertion point (_Pt0).",
          "5. Script scans Model Space (or specific group) for Elements containing 'hsb_Multiwall' map data.",
          "6. User invokes an action via Double Click or Right-Click Context Menu.",
          "7. Depending on action, existing ElementMultis are handled: All erased (Refresh All), Specific one erased (Refresh Selected), or Metadata removed (Delete).",
          "8. Script collects Single Elements based on the action scope.",
          "9. Collected elements are sorted: First by MultiElement Number, then by Grouping Key (if format specified).",
          "10. Coordinate System (CS) is calculated for the first multielement based on _Pt0 (or stored positions for updates).",
          "11. Loop through sorted elements: Create ElementMulti if number changes, insert Single Element, and update CS (Vertical offset).",
          "12. If Grouping Key changes between multielements, CS shifts horizontally (Horizontal offset).",
          "13. Script draws visualization text (Names, Last Refreshed)."
        ],
        "conditionalBranches": [
          {
            "condition": "User triggers Context Menu / Double Click",
            "path1": {
              "name": "Refresh All Multielements (Double Click)",
              "steps": [
                "Set 'bUpadteExisting' = true",
                "Collect all existing ElementMultis and erase them",
                "Collect all valid Single Elements (ignoring those in existing multis)",
                "Rebuild all multielements from scratch starting at _Pt0"
              ]
            },
            "path2": {
              "name": "Refresh selected Multielement",
              "steps": [
                "Prompt user to select a specific ElementMulti",
                "Extract and list its constituent Single Elements",
                "Erase the selected ElementMulti and its generated entities",
                "Collect Single Elements matching the extracted list",
                "Recreate the specific ElementMulti at calculated position"
              ]
            },
            "path3": {
              "name": "Delete Multielement Metadata",
              "steps": [
                "Collect all valid Single Elements",
                "Remove 'hsb_Multiwall' submap from all elements",
                "Skip multielement creation geometry update"
              ]
            }
          },
          {
            "condition": "Property 'pGroupsToCheck' value",
            "path1": {
              "name": "|All|",
              "steps": [
                "Scans entire Model Space for relevant Elements and TslInsts"
              ]
            },
            "path2": {
              "name": "|This|",
              "steps": [
                "Restricts scan to the specific 'multielementFloorGroupName' and 'singleelementFloorGroupName' defined in properties"
              ]
            }
          },
          {
            "condition": "Property 'groupingFormat' is populated",
            "path1": {
              "name": "Grouping Active",
              "steps": [
                "Elements are sorted by the formatted grouping key string",
                "When the grouping key changes between multielements, the insertion position shifts horizontally by 'horizontalOffset + previous group width'"
              ]
            },
            "path2": {
              "name": "Grouping Inactive (Empty)",
              "steps": [
                "Elements are only sorted by MultiElement Number",
                "All multielements are stacked vertically in a single column"
              ]
            }
          },
          {
            "condition": "Property 'pShowMultiElementNames' value",
            "path1": {
              "name": "|Yes|",
              "steps": [
                "Iterates all generated ElementMultis",
                "Draws 3D text of the element name at a calculated offset (-X, +Y) from the element origin"
              ]
            },
            "path2": {
              "name": "|No|",
              "steps": [
                "Skips drawing element names"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Single Elements must contain a MapX named 'hsb_Multiwall'",
            "errorMessage": "(Implicit) Elements are ignored silently if map is missing.",
            "recovery": "Ensure upstream scripts have attached the correct metadata to the Single Elements before running this manager."
          },
          {
            "check": "Floor Groups must exist for the selected properties",
            "errorMessage": "Script error or unexpected behavior if group indices are invalid.",
            "recovery": "Ensure the 'Assign to group' and 'Single elements group' properties reference valid existing Groups in the project."
          },
          {
            "check": "Singleton Instance",
            "errorMessage": "(Implicit) Script erases the new instance if a manager already exists.",
            "recovery": "Use the existing instance in the drawing or erase the old one manually before inserting a new one."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Spacing/Assignment",
            "how": "OPM (Object Properties Manager)",
            "effect": "Changing offsets or grouping format requires a manual 'Refresh' command to update geometry."
          },
          {
            "action": "Refresh Geometry",
            "how": "Double Click or Context Menu -> 'Refresh all Multielements'",
            "effect": "Re-calculates positions and rebuilds all multielements based on current property settings and source elements."
          },
          {
            "action": "Repair/Replace Single Multielement",
            "how": "Context Menu -> 'Refresh selected Multielement'",
            "effect": "Rebuilds only the selected multielement, useful if geometry was corrupted or single elements were modified individually."
          },
          {
            "action": "Disassemble Multielements",
            "how": "Context Menu -> 'Delete Multielement Metadata'",
            "effect": "Removes the logical link between single elements and multielements, effectively 'exploding' the logical grouping (though physical geometry remains until manual delete)."
          }
        ]
      },
      "tokens_used": 11021,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_CreateMultielements.mcr\n\n## Overview\nAutomates the creation and management of \"Multielements\" (transportable building blocks) by grouping and stacking single Elements (walls/floors) in 3D space. It visualizes assembly packages and manages their logical grouping based on attached metadata.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model to organize and stack elements. |\n| Paper Space | No | Not designed for layout or detailing views. |\n| Shop Drawing | No | Does not generate 2D drawings directly. |\n\n## Prerequisites\n- **Required Entities:** Single Elements (Walls/Floors) containing the `hsb_Multiwall` submap data (usually applied by a separate preprocessing script).\n- **Minimum Beam Count:** 0 (Works with Element entities).\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT` → Select `hsb_CreateMultielements.mcr`\n\n### Step 2: Set Base Point\n```\nCommand Line: |Pick a point|\nAction: Click in the Model Space to define the origin (0,0,0) for the first multielement stack.\n```\n*Note: Only one instance of this script manager is allowed per drawing.*\n\n### Step 3: Configure Properties\nAfter insertion, select the script instance and open the **Properties Palette**.\n1. Set the **Single elements group** to match the layer containing your source elements.\n2. Set the **Vertical offset** to the desired stacking height (e.g., 4000mm).\n3. (Optional) Set a **Grouping format** if you want to sort stacks into columns based on naming conventions.\n\n### Step 4: Generate Multielements\n**Action:** Double-click the script instance or Right-click → `Refresh all Multielements`.\n*The script will scan the model, collect valid elements, and draw the stacked multielements.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Vertical offset between multielements | Number | 4000.0 | The vertical distance (Z-axis) between the base of one multielement and the next. |\n| Horizontal offset between multielements | Number | 0.0 | The horizontal spacing (X-axis) applied when a new group of multielements starts. |\n| Assign to group | Dropdown | *Dynamic List* | The structural group to which the generated Multielement entities are assigned. |\n| Single elements group | Dropdown | *Dynamic List* | The structural group from which the script reads source elements to create multielements. |\n| Grouping format | Text | | A naming mask (e.g., \"Project-Phase\") used to sort multielements. If the key changes between elements, a new column is started using the horizontal offset. |\n| Groups to check | Dropdown | \\|All\\| | Sets the scope of the search: \\|All\\| scans the whole model; \\|This\\| restricts scanning to the groups defined above. |\n| Show MultiElement Names | Dropdown | \\|Yes\\| | Toggles the visibility of 3D text labels displaying the name of each multielement in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Refresh all Multielements** (Double Click) | Rebuilds all multielements in the drawing. It erases existing multielements and recreates them based on current source elements and property settings. |\n| **Refresh selected Multielement** | Prompts you to select a specific multielement to rebuild. Useful if you only want to update one stack without regenerating the whole model. |\n| **Delete Multielement Metadata** | Removes the logical link (metadata) from source single elements. This disassociates them from the multielement logic without deleting the physical geometry. |\n\n## Settings Files\n- **Filename:** None\n- **Location:** N/A\n- **Purpose:** This script relies on standard hsbCAD element properties and map data, not external settings files.\n\n## Tips\n- **Singleton Manager:** If you try to insert a second instance of this script, it will automatically delete itself. Use the existing instance to change settings.\n- **Grouping Logic:** Use the `Grouping format` property to organize your stacks. For example, if elements are named \"House1-Floor1\" and \"House2-Floor1\", setting the format to separate \"House\" will stack the floors for House1 in one column and House2 in the next column over.\n- **Visualization:** If the model gets too cluttered with text, set `Show MultiElement Names` to `No` in the properties.\n\n## FAQ\n- **Q: Why didn't the script generate any multielements?**\n  **A:** Ensure your single elements have the `hsb_Multiwall` map data attached (usually done via a preprocessing script) and that the `Single elements group` property matches the group where those elements reside.\n- **Q: I changed the offsets, but nothing moved.**\n  **A:** Changes to properties do not update the geometry automatically. You must **Double Click** the script instance or run `Refresh all Multielements` to apply the new spacing.\n- **Q: How do I remove the multielements but keep my walls?**\n  **A:** Use the `Delete Multielement Metadata` context menu option to remove the logical links. You can then manually delete the generated multielement blocks if needed."
      },
      "tokens_used": 6934,
      "error": null
    }
  }
}