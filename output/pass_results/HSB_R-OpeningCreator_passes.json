{
  "filename": "HSB_R-OpeningCreator.mcr",
  "status": "completed",
  "total_tokens": 43004,
  "processing_time": 338.9097945690155,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "22.06.2017",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "23.06.2017",
            "author": "AS",
            "changes": "Always project opening to roof element."
          },
          {
            "version": "1.02",
            "date": "18.07.2017",
            "author": "AS",
            "changes": "Interpret results from opening calculator."
          },
          {
            "version": "1.03",
            "date": "03.10.2017",
            "author": "AS",
            "changes": "Manage zone profiles"
          },
          {
            "version": "1.04",
            "date": "02.11.2017",
            "author": "AS",
            "changes": "Split rafters"
          },
          {
            "version": "1.05",
            "date": "03.11.2017",
            "author": "AS",
            "changes": "Project selected points to same plane."
          },
          {
            "version": "1.06",
            "date": "18.12.2017",
            "author": "AS",
            "changes": "Create dummy element which represents a merged version of the interfering elements."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6996,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses `_kModelSpace` in `collectEntities`. It relies on `_bOnInsert` to define an `OpeningRoof` entity on a selected `ElementRoof` via `getPoint` and `getElement`. No 'sd_' prefix, no Viewport handling, and no '#Type E' logic found."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "hsbOpeningCreator.dll"
          ]
        }
      },
      "tokens_used": 5406,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getElement",
              "promptOriginal": "|Select an element|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select lower lefthand corner|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrPoint",
              "promptOriginal": "|Select upper righthand corner|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "openingRoofCatalog",
            "type": "PropString",
            "displayName": "|Opening roof catalog|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Create opening|",
            "handler": "|Create opening|",
            "action": "Recalculates the opening, restores previous entities, calls the external DLL to calculate the opening structure, and splits interfering rafters.",
            "alsoTriggeredBy": "Double-click"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6336,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates structural openings in timber roof elements by calculating and inserting trimming beams (trimmers/headers) and automatically splitting existing rafters to accommodate the specified void.",
          "category": "Framing/Manufacturing",
          "typicalUseCase": "Adding skylights, dormer windows, or service penetrations to prefabricated roof panels where existing rafters must be cut and supported by new framing."
        },
        "parameters": [
          {
            "name": "selectedElement",
            "technicalDefault": "User Selection",
            "businessMeaning": "The specific roof element or panel into which the opening will be cut. This acts as the host for the opening and the target for rafter splitting.",
            "validRange": "Any valid ElementRoof in the model",
            "unit": "Entity",
            "affectsOutput": "Determines the coordinate system, roof slope, and which specific rafters/beams are candidates for splitting."
          },
          {
            "name": "lowerLefthandCorner",
            "technicalDefault": "User Selection",
            "businessMeaning": "The bottom-left coordinate of the rectangular opening footprint on the roof plane.",
            "validRange": "Must be within or on the edge of the selected roof element",
            "unit": "mm",
            "affectsOutput": "Defines the start boundary for the cut. It influences the placement of the bottom and left trimming beams."
          },
          {
            "name": "upperRighthandCorner",
            "technicalDefault": "User Selection",
            "businessMeaning": "The top-right coordinate of the rectangular opening footprint, completing the dimensions.",
            "validRange": "Must be diagonally opposite to the lower-left corner to form a valid rectangle on the roof plane",
            "unit": "mm",
            "affectsOutput": "Defines the size of the opening. It determines how much of the existing rafters are removed and the span required for header beams."
          },
          {
            "name": "openingRoofCatalog",
            "technicalDefault": "",
            "businessMeaning": "Selects the specific construction standard or preset design for the opening (e.g., standard skylight trimming, eaves detail). This dictates the geometry, profiles, and machining of the trimmer/header beams generated by the external calculator.",
            "validRange": "List of available catalog entries defined in the hsbOpeningCreator configuration",
            "unit": "String",
            "affectsOutput": "Controls the dimensions and properties of the new GenBeams (trimmers/headers) and connection details returned by the calculation DLL."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing openingRoofCatalog",
            "effect": "Updates the OpeningRoof entity properties immediately; however, the physical framing (trimmers/headers) is only regenerated when the 'Create opening' command is triggered.",
            "cascade": [
              "GenBeam dimensions",
              "Connection details"
            ]
          },
          {
            "trigger": "Moving insertion points (lowerLefthandCorner/upperRighthandCorner)",
            "effect": "Updates the outline PLine; triggers recalculation of split points for rafters and the bounding box for the calculator.",
            "cascade": [
              "Rafter split positions",
              "Trimmer locations"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "OpeningRoof",
            "description": "A logical representation of the hole in the roof, storing the outline and catalog selection.",
            "appliedTo": "The selected ElementRoof"
          },
          {
            "type": "GenBeam",
            "description": "New framing members (trimmers, headers, cripple studs) generated by the external DLL based on the selected catalog and opening size.",
            "appliedTo": "The floor/roof group containing the selected element"
          },
          {
            "type": "Beam",
            "description": "Existing rafters that are physically split (cut) at the intersection with the opening boundaries to allow space for the new trimmers.",
            "appliedTo": "Interfering rafters in the selected ElementRoof"
          },
          {
            "type": "Sheet",
            "description": "Sheeting material that has a void cut out of it to match the opening geometry.",
            "appliedTo": "Sheeting zones of the interfering elements"
          }
        ]
      },
      "tokens_used": 9266,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch",
          "Check Insert State: Is this a new insertion (_bOnInsert)?",
          "[If Yes] Check Cycle Count: Is insertCycleCount() > 1?",
          "[If Yes] Erase Instance and Exit (Prevent duplicate runs)",
          "[If No] Execute Insertion Workflow",
          "  -> Select Element (getElement)",
          "  -> Get Lower Left Point (getPoint)",
          "  -> Get Upper Right Point (PrPoint loop)",
          "  -> Calculate Opening Coordinate System (based on Element X/Global Z)",
          "  -> Create OpeningRoof Entity (dbCreate)",
          "  -> Set Catalog Values from Property",
          "  -> Set 'Insert' flag in Map to True",
          "  -> Exit Script",
          "[If No] Execute Update/Recalculation Workflow",
          "  -> Validate Reference Element (Is ElementRoof?)",
          "  -> Validate OpeningRoof Entity (Is Valid?)",
          "  -> Check Alignment: Is OpeningRoof perpendicular to Element?",
          "  -> [If Misaligned] Project OpeningRoof shape to Element Plane",
          "  -> Check Property: Has 'openingRoofCatalog' changed?",
          "  -> [If Changed] Update OpeningRoof catalog values",
          "  -> Calculate Opening Bounds (Sorted Vertices)",
          "  -> Draw Visual Cross (Diagonals)",
          "  -> Identify Interfering Elements (FloorGroup overlap)",
          "  -> Lock Interfering Elements",
          "  -> Determine Execution Trigger: Is 'Insert' flag set, Context Menu 'Create opening' clicked, or Double Click?",
          "  -> [If Triggered] Execute Opening Creation Process",
          "    -> Remove Previously Created Entities (from Map)",
          "    -> Restore Zone Profiles (Brutto/Netto) of interfering elements",
          "    -> Create Dummy Element (Merged representation)",
          "    -> Prepare ModelMap (Ref Element, Opening, Dummy)",
          "    -> Export Map to Temp File (.dxx/.hmm)",
          "    -> Call External DLL (hsbOpeningCreator)",
          "    -> Import Resulting ModelMap",
          "    -> Store New Entities in Map (for future cleanup)",
          "    -> Erase Dummy Element",
          "    -> Split Interfering Rafters (based on new geometry)",
          "  -> [Always] Update Sheeting Zones (Cut opening in sheets)"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion vs Update (_bOnInsert)",
            "path1": {
              "name": "Insertion Path",
              "steps": [
                "Select Host Element",
                "Define Opening Geometry (2 Points)",
                "Initialize Logical Entity (OpeningRoof)",
                "Defer Physical Construction until Trigger"
              ]
            },
            "path2": {
              "name": "Update Path",
              "steps": [
                "Validate Entity Links",
                "Sync Properties (Catalog)",
                "Conditionally Re-run Construction Logic"
              ]
            }
          },
          {
            "condition": "Construction Trigger (Create Opening)",
            "path1": {
              "name": "Construct Opening",
              "steps": [
                "Clean up old beams",
                "Restore element zones",
                "Execute DLL Calculation",
                "Generate new trimmers/headers",
                "Split existing rafters"
              ]
            },
            "path2": {
              "name": "Passive Update",
              "steps": [
                "Update logical properties only",
                "Refresh visual cross",
                "Modify sheeting voids (if geometry changed)"
              ]
            }
          },
          {
            "condition": "Point Input Validation (PrPoint result)",
            "path1": {
              "name": "Valid Point",
              "steps": [
                "Set Upper Right Corner",
                "Proceed to geometry creation"
              ]
            },
            "path2": {
              "name": "Invalid/Cancelled",
              "steps": [
                "Report Warning",
                "Erase Instance",
                "Exit"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Type",
            "errorMessage": "|Selected element is not a roof element.|",
            "recovery": "Script erases instance; user must insert on a valid ElementRoof."
          },
          {
            "check": "OpeningRoof Entity Integrity",
            "errorMessage": "ScriptName + \"|Opening is not valid|\"",
            "recovery": "Script erases instance."
          },
          {
            "check": "Opening Outline Geometry (Sorted Vertices)",
            "errorMessage": "ScriptName + \"|Opening outline is not valid|\"",
            "recovery": "Script erases instance."
          },
          {
            "check": "User Input for Upper Right Point",
            "errorMessage": "|Opening is not valid|!",
            "recovery": "Script erases instance immediately."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Generate Physical Framing",
            "how": "Right-click Context Menu -> '|Create opening|' OR Double-Click",
            "effect": "Calculates trimming beams via DLL, inserts them, and splits existing rafters."
          },
          {
            "action": "Update Construction Standard",
            "how": "OPM Property -> '|Opening roof catalog|'",
            "effect": "Updates logical parameters. Requires 'Create opening' trigger to physically update the framing."
          },
          {
            "action": "Modify Opening Geometry",
            "how": "Edit OpeningRoof Entity Geometry",
            "effect": "Recalculates opening bounds. If 'Create opening' runs, splits rafters at new locations."
          }
        ]
      },
      "tokens_used": 9053,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_R-OpeningCreator.mcr\n\n## Overview\nThis script automates the creation of structural openings in roof elements. It calculates and inserts trimming beams (trimmers/headers), splits existing rafters to fit the opening, and cuts voids in sheeting layers.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script runs exclusively in Model Space. |\n| Paper Space | No | Not supported for Paper Space usage. |\n| Shop Drawing | No | This is a modeling/scripting tool, not a drafting tool. |\n\n## Prerequisites\n- **Required Entities**: A valid `ElementRoof` (Roof panel) must exist in the model.\n- **Minimum Beam Count**: 0.\n- **Required Settings**: `hsbOpeningCreator.dll` (Required for the structural calculation logic).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_R-OpeningCreator.mcr`\n\n### Step 2: Select Roof Element\n```\nCommand Line: |Select an element|\nAction: Click on the roof element (ElementRoof) where you want to create the opening.\n```\n\n### Step 3: Define Opening Corner 1\n```\nCommand Line: |Select lower lefthand corner|\nAction: Click the point on the roof plane that represents the lower-left corner of your future opening.\n```\n\n### Step 4: Define Opening Corner 2\n```\nCommand Line: |Select upper righthand corner|\nAction: Click the diagonally opposite point (upper-right) to complete the rectangular opening outline.\n```\n\n### Step 5: Generate Framing\n**Note**: After insertion, only the outline is visible. You must trigger the creation of the physical beams.\n```\nAction: Select the newly created OpeningRoof entity, then either:\n1. Double-click the entity, OR\n2. Right-click and select \"|Create opening|\"\n```\n*This will generate the trimmers, headers, and split the existing rafters.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Opening roof catalog | dropdown | (Empty) | Selects the construction preset or standard profile to be used for the trimming beams and connection details. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| |Create opening| | Executes the calculation. It removes old framing (if any), restores original zones, calculates new beams via the DLL, inserts them, and splits interfering rafters. |\n\n## Settings Files\n- **Filename**: `hsbOpeningCreator.dll`\n- **Location**: hsbCAD application directory (or defined DLL path).\n- **Purpose**: Performs the structural calculations to determine the size and placement of trimmers and headers based on the selected catalog and opening dimensions.\n\n## Tips\n- **Two-Step Process**: Remember that inserting the script only draws the outline. You must double-click or use the right-click menu to actually cut the beams and add the framing.\n- **Modifying Openings**: If you change the `Opening roof catalog` property in the Properties Palette, you must re-run the \"Create opening\" command to update the physical beams to match the new standard.\n- **Geometry**: Ensure the two points you click form a valid rectangle on the roof plane. The script projects these points to ensure they lie flat on the roof element.\n\n## FAQ\n- **Q: I inserted the script, but I don't see any new beams?**\n  **A**: This is expected behavior. The insertion phase only defines the location (outline). Select the entity and Double-click (or Right-click -> Create opening) to generate the structural framing.\n- **Q: Can I move the opening after creation?**\n  **A**: Yes, you can move or stretch the OpeningRoof entity. After moving it, you must trigger \"Create opening\" again to update the rafter splits and trimmer positions.\n- **Q: What happens to the existing rafters?**\n  **A**: The script automatically splits (cuts) any rafters that intersect with the opening boundaries to make room for the new trimmers."
      },
      "tokens_used": 5947,
      "error": null
    }
  }
}