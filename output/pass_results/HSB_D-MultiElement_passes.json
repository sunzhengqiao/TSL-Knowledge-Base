{
  "filename": "HSB_D-MultiElement.mcr",
  "status": "completed",
  "total_tokens": 41586,
  "processing_time": 220.1179277896881,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6927,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses getViewport() during insertion and relies on _Viewport variable. Logic immediately returns if _Viewport.length() == 0. It extracts an ElementMulti from the viewport (vp.element()). Coordinate transformations use ms2ps (Model Space to Paper Space)."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementMulti"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Paper Space Layout containing a Viewport linked to an ElementMulti.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4602,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select a position|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "|Dimension Object|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator (Read Only)"
          },
          {
            "index": 1,
            "variable": "sObject",
            "type": "PropString",
            "displayName": "     |Dimension object|",
            "defaultValue": "|Single elements|",
            "inputType": "dropdown",
            "options": [
              "|Single elements|",
              "|Single elementnumbers|",
              "|Openings|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sSeperator02",
            "type": "PropString",
            "displayName": "|Positioning|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator (Read Only)"
          },
          {
            "index": 3,
            "variable": "sUsePSUnits",
            "type": "PropString",
            "displayName": "     |Offset in paperspace units|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dDimOff",
            "type": "PropDouble",
            "displayName": "     |Offset dimension line|",
            "defaultValue": "15.0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dTextOff",
            "type": "PropDouble",
            "displayName": "     |Offset description|",
            "defaultValue": "2.0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sPosition",
            "type": "PropString",
            "displayName": "     |Position|",
            "defaultValue": "|Horizontal Bottom|",
            "inputType": "dropdown",
            "options": [
              "|Horizontal Bottom|",
              "|Horizontal Top|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sSeperator03",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator (Read Only)"
          },
          {
            "index": 6,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "     |Dimension style|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "System Generated Sorted List"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColorDimension",
            "type": "PropInt",
            "displayName": "     |Color|",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sDescription",
            "type": "PropString",
            "displayName": "     |Description|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 8,
            "variable": "sSeperator04",
            "type": "PropString",
            "displayName": "|Name and description|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Separator (Read Only)"
          },
          {
            "index": 1,
            "variable": "nColorName",
            "type": "PropInt",
            "displayName": "     |Default name color|",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 9,
            "variable": "sDimStyleName",
            "type": "PropString",
            "displayName": "     |Dimension style name|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "System Generated Sorted List"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 10,
            "variable": "sInstanceDescription",
            "type": "PropString",
            "displayName": "     |Extra description|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6085,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates dimensions and labels for Multi-Elements (walls or floors) directly in Paper Space, based on the contents of a selected viewport.",
          "category": "ShopDrawing",
          "typicalUseCase": "Creating a 2D layout drawing of a timber wall panel where the user needs to dimension the positions of studs, label part numbers, or dimension window/door openings without manually creating dimensions in model space."
        },
        "parameters": [
          {
            "name": "sObject",
            "technicalDefault": "|Single elements|",
            "businessMeaning": "Specifies the target for annotation within the Multi-Element. 'Single elements' dimensions the width/positions of internal studs/beams. 'Single elementnumbers' places Part Marks (e.g., S1, S2) for each component. 'Openings' dimensions the width of windows and doors.",
            "validRange": "Single elements, Single elementnumbers, Openings",
            "unit": "enum",
            "affectsOutput": "Switches the script logic between generating linear dimensions for geometry, generating text labels for marks, or generating dimensions for cut-outs."
          },
          {
            "name": "sUsePSUnits",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Determines if offset distances are fixed in Paper Space (readable size on paper) or scale with the Model Space (viewport scale). 'Yes' ensures consistent text gap regardless of zoom level.",
            "validRange": "Yes, No",
            "unit": "enum",
            "affectsOutput": "Modifies the calculation of `dDimOff` and `dTextOff` by multiplying (or not multiplying) by the Viewport Scale factor."
          },
          {
            "name": "dDimOff",
            "technicalDefault": "15.0",
            "businessMeaning": "The clearance distance between the edge of the element (wall plate) and the dimension line.",
            "validRange": "5.0 to 50.0",
            "unit": "mm (or Paper Space Units)",
            "affectsOutput": "Moves the generated dimension line closer to or further from the element geometry."
          },
          {
            "name": "dTextOff",
            "technicalDefault": "2.0",
            "businessMeaning": "The offset distance between the dimension line and the associated description text.",
            "validRange": "1.0 to 10.0",
            "unit": "mm (or Paper Space Units)",
            "affectsOutput": "Adjusts the vertical spacing of the description label relative to the dimension line."
          },
          {
            "name": "sPosition",
            "technicalDefault": "|Horizontal Bottom|",
            "businessMeaning": "Controls whether the dimensions are placed at the bottom or top edge of the element's bounding box.",
            "validRange": "Horizontal Bottom, Horizontal Top",
            "unit": "enum",
            "affectsOutput": "Flips the vertical origin point of the dimension line and text from the bottom plate to the top plate."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "System Generated Sorted List",
            "businessMeaning": "The CAD standard style (text size, arrowheads, ticks) applied to the dimension lines.",
            "validRange": "Any available DimStyle in the drawing",
            "unit": "string",
            "affectsOutput": "Visual appearance of the dimension lines (arrows, font, precision)."
          },
          {
            "name": "nColorDimension",
            "technicalDefault": "1",
            "businessMeaning": "The CAD color index used for the dimension lines.",
            "validRange": "0 to 256 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Color of the generated dimension lines."
          },
          {
            "name": "sDescription",
            "technicalDefault": "",
            "businessMeaning": "Additional text annotation placed next to the dimension line (e.g., 'Stud spacing 600').",
            "validRange": "Alphanumeric string",
            "unit": "text",
            "affectsOutput": "Adds text label near the dimension line."
          },
          {
            "name": "nColorName",
            "technicalDefault": "-1",
            "businessMeaning": "Color of the script instance name/label displayed in Paper Space.",
            "validRange": "0 to 256 (-1 usually equals ByLayer)",
            "unit": "index",
            "affectsOutput": "Color of the identification text for the script object itself."
          },
          {
            "name": "sDimStyleName",
            "technicalDefault": "System Generated Sorted List",
            "businessMeaning": "The text style used for the script instance name/label.",
            "validRange": "Any available Text/DimStyle",
            "unit": "string",
            "affectsOutput": "Font and height of the script identification label."
          },
          {
            "name": "sInstanceDescription",
            "technicalDefault": "",
            "businessMeaning": "A suffix added to the script name to distinguish this specific instance in the drawing.",
            "validRange": "Alphanumeric string",
            "unit": "text",
            "affectsOutput": "Updates the label text identifying this specific annotation block."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sUsePSUnits changes to 'Yes'",
            "effect": "Offsets (dDimOff, dTextOff) are treated as Paper Space distances and scaled up by the Viewport scale factor to match Model Space coordinates.",
            "cascade": [
              "dDimOff",
              "dTextOff"
            ]
          },
          {
            "trigger": "sObject is set to 'Single elementnumbers'",
            "effect": "The script switches to drawing Part Marks (text) instead of dimension lines. The sPosition parameter is ignored for individual labels (they are placed at the bottom of their specific element), though the description text placement still adheres to global offsets.",
            "cascade": [
              "sDimStyle",
              "nColorDimension"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Dimension Line",
            "description": "Linear dimension lines indicating total length, stud positions, or opening widths.",
            "appliedTo": "Paper Space (Layout)"
          },
          {
            "type": "Text Label",
            "description": "Single Element Numbers (Marks) or user-defined description strings.",
            "appliedTo": "Paper Space (Layout)"
          },
          {
            "type": "PLine / Profile",
            "description": "Visual outline of the Multi-Element profile (optional visualization).",
            "appliedTo": "Paper Space (Layout)"
          }
        ]
      },
      "tokens_used": 7513,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch",
          "2. Show Properties Dialog (showDialogOnce)",
          "3. Prompt User: Select Viewport (getViewport)",
          "4. Prompt User: Select Position for Instance Name (getPoint)",
          "5. Store Viewport and Position Point",
          "6. [Recalculation Phase] Retrieve ElementMulti from Viewport",
          "7. Validate ElementMulti (Check validity and bounding box)",
          "8. Calculate Coordinate Systems (Model Space vs Paper Space)",
          "9. Process OPM Properties (Apply scaling if 'Use PS Units' is Yes)",
          "10. Iterate through Single Elements in the Multi-Element",
          "11. Execute Logic Branch based on 'Dimension Object' (sObject)",
          "12. Draw Instance Name Label at selected position",
          "13. Draw Description Text (if applicable)",
          "14. Completion"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution State (_bOnInsert)",
            "path1": {
              "name": "On Insert",
              "steps": [
                "Show properties dialog",
                "Prompt for Viewport selection",
                "Prompt for Position selection",
                "Store inputs to _Viewport and _Pt0",
                "Exit (return)"
              ]
            },
            "path2": {
              "name": "On Recalculation",
              "steps": [
                "Validate stored Viewport",
                "Generate dimensions/labels based on properties",
                "Update graphics in Paper Space"
              ]
            }
          },
          {
            "condition": "Dimension Object Type (sObject)",
            "path1": {
              "name": "Single Elements (Geometry)",
              "steps": [
                "Extract Netto Profile of elements",
                "Filter vertices based on proximity to dimension line",
                "Append vertices to dimension point array"
              ]
            },
            "path2": {
              "name": "Single Elementnumbers (Labels)",
              "steps": [
                "Get Single Element Number (e.g., S1)",
                "Calculate position relative to specific child element bottom",
                "Draw Text Label immediately",
                "Do NOT populate dimension point array (skips dimension line)"
              ]
            },
            "path3": {
              "name": "Openings",
              "steps": [
                "Collect all Opening entities within the Multi-Element",
                "Append Opening shape vertices to dimension point array"
              ]
            }
          },
          {
            "condition": "Positioning (sPosition)",
            "path1": {
              "name": "Horizontal Bottom",
              "steps": [
                "Set Reference Point to Bottom-Left of bounding box",
                "Project dimension points to Bottom Edge line"
              ]
            },
            "path2": {
              "name": "Horizontal Top",
              "steps": [
                "Set Reference Point to Top-Left of bounding box",
                "Project dimension points to Top Edge line"
              ]
            }
          },
          {
            "condition": "Paper Space Units (sUsePSUnits)",
            "path1": {
              "name": "Yes",
              "steps": [
                "Multiply dDimOff and dTextOff by Viewport Scale (dVpScale)",
                "Result: Offsets remain constant relative to paper size regardless of model zoom"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Use dDimOff and dTextOff values directly",
                "Result: Offsets scale with the model geometry"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Existence",
            "errorMessage": "None (Implicit failure)",
            "recovery": "Script calls eraseInstance() if _Viewport.length() == 0."
          },
          {
            "check": "Element Validity",
            "errorMessage": "None (Silent exit)",
            "recovery": "Script checks if viewport element is valid and casts to ElementMulti. Returns without drawing if invalid."
          },
          {
            "check": "Bounding Box Geometry",
            "errorMessage": "None (Silent exit)",
            "recovery": "Script checks if ordered bounding box points exist. Returns if length is 0."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Annotation Style/Content",
            "how": "OPM (Object Properties Palette)",
            "effect": "Updating sObject, sPosition, Offsets, or Colors triggers a recalculation, instantly redrawing dimensions and labels in Paper Space."
          },
          {
            "action": "Relocate Instance Name",
            "how": "Grip Edit (Move Point _Pt0)",
            "effect": "Moves the text label identifying the script instance (e.g., 'HSB_D-MultiElement - MyDesc') to a new location in Paper Space."
          },
          {
            "action": "Update Linked Model",
            "how": "Modify Model Space Elements (Beams/Openings)",
            "effect": "Since the script reads live data via ElementMulti, changing the wall composition in Model Space will update the dimension points and labels upon the next recalculation."
          }
        ]
      },
      "tokens_used": 9392,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_D-MultiElement.mcr\n\n## Overview\nThis script automatically generates dimensions and labels for Multi-Elements (such as wall panels or floors) directly in Paper Space. It reads the geometry from a selected viewport to create annotations for individual studs, part numbers, or openings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | The script must be inserted in a Layout tab. |\n| Paper Space | Yes | Requires a Layout with a viewport linked to an ElementMulti. |\n| Shop Drawing | Yes | Used for creating production drawings and layouts. |\n\n## Prerequisites\n- **Required Entities**: An `ElementMulti` (e.g., a generated wall or floor) visible in a viewport.\n- **Minimum Beam Count**: N/A (The script dimensions whatever is contained in the element).\n- **Required Settings**: A Paper Space Layout containing at least one viewport showing the Multi-Element.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: Run `TSLINSERT` (or the hsbCAD insert command) and select `HSB_D-MultiElement.mcr`.\n\n### Step 2: Select Viewport\n```\nCommand Line: |Select a viewport|\nAction: Click inside the viewport that displays the wall or floor you wish to dimension.\n```\n\n### Step 3: Select Position\n```\nCommand Line: |Select a position|\nAction: Click in Paper Space to define the location for the script's label/instance name.\n```\n\n## Properties Panel Parameters\n\nThese properties can be edited in the AutoCAD Properties Palette (Ctrl+1) after selecting the script object.\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Dimension Object** | dropdown | |Single elements| | Choose what to dimension: 'Single elements' (studs/beams), 'Single elementnumbers' (Part Marks), or 'Openings' (windows/doors). |\n| **Offset in paperspace units** | dropdown | |Yes| | If 'Yes', offsets are fixed in paper size (readable). If 'No', offsets scale with the model zoom. |\n| **Offset dimension line** | number | 15.0 | Distance between the element edge and the dimension line. |\n| **Offset description** | number | 2.0 | Distance between the dimension line and the description text. |\n| **Position** | dropdown | |Horizontal Bottom| | Places dimensions at the 'Horizontal Bottom' or 'Horizontal Top' of the element. |\n| **Dimension style** | dropdown | System Generated | The AutoCAD dimension style to use for the lines. |\n| **Color** | number | 1 | The color index (1=Red, etc.) for the dimension lines. |\n| **Description** | text | | Additional text annotation placed near the dimension line. |\n| **Default name color** | number | -1 | Color for the script instance name label (-1 = ByLayer). |\n| **Dimension style name** | dropdown | System Generated | The text style used for the script instance name label. |\n| **Extra description** | text | | A suffix added to the script name label to distinguish this instance. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None specific* | This script does not add custom items to the right-click context menu. Use standard AutoCAD/hsbCAD grip edits to move the instance label. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Consistent Text Size**: Keep **Offset in paperspace units** set to \"Yes\" to ensure your text and dimension gaps remain the same physical size on paper, regardless of the viewport scale.\n- **Part Numbering**: Switch **Dimension Object** to \"Single elementnumbers\" to quickly generate a layout of Part Marks (e.g., S1, S2) for the wall components.\n- **Updating**: If you modify the wall layout in Model Space (e.g., add a stud), select the script object in Paper Space and trigger a recalculation (e.g., change a property slightly or use the hsbCAD update command) to refresh the dimensions.\n\n## FAQ\n- **Q: The dimensions seem to be in the wrong location or disappear.**\n  A: Ensure the viewport you selected during insertion still contains the ElementMulti. If the viewport has been moved or the element erased, the script may fail to find the geometry.\n- **Q: Can I dimension the vertical height of the wall?**\n  A: No, this script is specifically designed for horizontal dimensions (widths/spacing) along the bottom or top edge of the element.\n- **Q: What does the \"Extra description\" do?**\n  A: It appends text to the main label of the script instance. For example, if the script name is \"HSB_D-MultiElement\" and you type \"Floor 1\" here, the label in Paper Space will read \"HSB_D-MultiElement - Floor 1\"."
      },
      "tokens_used": 7067,
      "error": null
    }
  }
}