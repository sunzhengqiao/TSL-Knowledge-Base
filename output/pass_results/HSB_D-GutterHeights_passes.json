{
  "filename": "HSB_D-GutterHeights.mcr",
  "status": "completed",
  "total_tokens": 28988,
  "processing_time": 204.46596884727478,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 5686,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script prompts for 'Select a viewport' using getViewport(), validates _Viewport.length(), and transforms coordinates from Model Space to Paper Space using ms2ps = vp.coordSys(). It does not use ShopDrawing specific constructs like #Type E or _Entity[]."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space with a Viewport referencing a valid Element",
          "requiredSettings": [
            "Sheets must have SubMap 'Rotation' or specific SubLabel matching 'sManualRotation' property"
          ]
        }
      },
      "tokens_used": 3425,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "Select a viewport",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Select a point",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "On Insert",
            "title": null,
            "dataSource": "TSL Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sSeperator00",
            "type": "PropString",
            "displayName": "|Gutter dimension|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sPrefix",
            "type": "PropString",
            "displayName": "|Prefix|",
            "defaultValue": "Gooth = ",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dOffset",
            "type": "PropDouble",
            "displayName": "|Offset|",
            "defaultValue": "10.0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sManualRotation",
            "type": "PropString",
            "displayName": "|Sublabel manual rotated sheets|",
            "defaultValue": "Helling",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sSeperator01",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimension style",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 3532,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically annotates the Z-heights (vertical levels) of specific sheets (e.g., roof gutters or slopes) on a 2D drawing layout.",
          "category": "ShopDrawing / Annotation",
          "typicalUseCase": "Used in Paper Space to mark the start and end heights of roof slopes or gutters relative to the element origin, ensuring accurate detailing without manual measurement."
        },
        "parameters": [
          {
            "name": "sSeperator00",
            "technicalDefault": "",
            "businessMeaning": "UI grouping header only. Does not affect geometry.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "sPrefix",
            "technicalDefault": "Gooth = ",
            "businessMeaning": "The text label displayed immediately before the numeric height value on the drawing.",
            "validRange": "Any alphanumeric string (e.g., 'Height: ', 'Z = ', 'Gutter ')",
            "unit": "Text",
            "affectsOutput": "Changes the prefix of the dimension text label."
          },
          {
            "name": "dOffset",
            "technicalDefault": "10.0",
            "businessMeaning": "The distance between the edge of the sheet profile and the text label in the drawing.",
            "validRange": "1.0 to 100.0 (depending on drawing scale)",
            "unit": "mm (Paper Space)",
            "affectsOutput": "Moves the dimension text closer to or further from the sheet geometry to avoid overlap or clutter."
          },
          {
            "name": "sSeperator01",
            "technicalDefault": "",
            "businessMeaning": "UI grouping header only. Does not affect geometry.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Selects the specific CAD dimension style (font, text size, arrow style) used to render the height labels.",
            "validRange": "List of dimension styles loaded in the current drawing.",
            "unit": "Text Style",
            "affectsOutput": "Alters the visual appearance (font, height) of the generated text labels."
          },
          {
            "name": "sManualRotation",
            "technicalDefault": "Helling",
            "businessMeaning": "The SubLabel identifier used to filter which manually rotated sheets should be dimensioned if they do not have the standard 'Rotation' SubMap.",
            "validRange": "Any string matching the SubLabel property of the target sheets.",
            "unit": "Text",
            "affectsOutput": "Determines which sheets are included in the dimensioning process based on their SubLabel property."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sManualRotation",
            "effect": "Acts as a conditional filter. If a sheet lacks the 'Rotation' SubMap, the script checks if the sheet's SubLabel matches sManualRotation.",
            "cascade": [
              "Sheet Selection logic"
            ]
          },
          {
            "trigger": "dOffset",
            "effect": "Requires adjustment based on the Viewport Scale to ensure legible spacing.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Text / Dimension String",
            "description": "Displays the calculated Z-height of the start and end of sheet profiles in Paper Space.",
            "appliedTo": "Paper Space Viewport (annotation layer)"
          }
        ]
      },
      "tokens_used": 4849,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched (On Insert)",
          "Prompt user: 'Select a viewport'",
          "Prompt user: 'Select a point' (Script instance placement)",
          "Open Properties Dialog (showDialog)",
          "Validate Viewport existence (if empty, erase instance)",
          "Validate Viewport Element (if invalid, stop execution)",
          "Retrieve Element and coordinate transformation matrices (Model to Paper Space)",
          "Iterate through all Sheets within the Element",
          "[Conditional] Check Sheet SubMap/SubLabel to determine processing eligibility",
          "Calculate Sheet Profile geometry and shrink by 2mm",
          "Identify Start (highest) and End (lowest) points of the sheet profile along Element Z-axis",
          "Calculate vertical heights relative to Element origin",
          "Calculate Paper Space text orientation and offset direction based on screen vectors and sheet center",
          "Draw Height Labels (Prefix + Value) at calculated Start and End points"
        ],
        "conditionalBranches": [
          {
            "condition": "Sheet Filter Criteria (SubMap vs SubLabel)",
            "path1": {
              "name": "Process Sheet",
              "steps": [
                "Check if Sheet has SubMap 'Rotation'",
                "OR Check if SubLabel matches 'sManualRotation'",
                "If either is true: Calculate geometry and draw height labels"
              ]
            },
            "path2": {
              "name": "Skip Sheet",
              "steps": [
                "If Sheet lacks 'Rotation' SubMap AND SubLabel does not match 'sManualRotation'",
                "Continue to next sheet in loop"
              ]
            }
          },
          {
            "condition": "Sheet Orientation (Length vs Width)",
            "path1": {
              "name": "Standard Orientation",
              "steps": [
                "If solidLength >= solidWidth",
                "Use standard Sheet X/Y vectors"
              ]
            },
            "path2": {
              "name": "Rotated Orientation",
              "steps": [
                "If solidLength < solidWidth",
                "Swap Sheet X and Y vectors to maintain correct text alignment"
              ]
            }
          },
          {
            "condition": "Text Orientation Logic",
            "path1": {
              "name": "Normal Text",
              "steps": [
                "Calculate text vectors based on Sheet Y and Screen coordinates",
                "Ensure text is readable relative to the view"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Assignment",
            "errorMessage": "None (Silent failure)",
            "recovery": "Script calls eraseInstance() automatically. User must re-insert script and select a valid viewport."
          },
          {
            "check": "Viewport Data Validity",
            "errorMessage": "None (Silent failure)",
            "recovery": "Script returns without drawing. User must select a viewport containing a valid hsbCAD Element."
          },
          {
            "check": "Sheet Criteria Existence",
            "errorMessage": "No output generated",
            "recovery": "User must adjust 'sManualRotation' property or ensure target sheets have the 'Rotation' SubMap."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Text Appearance",
            "how": "OPM (Properties Palette) - Edit 'sPrefix', 'sDimStyle'",
            "effect": "Updates the label text prefix and font/size style immediately upon recalculation."
          },
          {
            "action": "Adjust Text Offset",
            "how": "OPM - Edit 'dOffset'",
            "effect": "Moves the dimension text closer to or further from the sheet edge."
          },
          {
            "action": "Change Filtered Sheets",
            "how": "OPM - Edit 'sManualRotation'",
            "effect": "Adds or removes sheets from the dimensioning process based on SubLabel matching."
          },
          {
            "action": "Move Script Instance",
            "how": "Grip Edit / Move Command",
            "effect": "Moves the Script Name tag ('HSB_D-GutterHeights'). Note: The dimension labels are anchored to the sheet geometry and do not move with the script instance point."
          }
        ]
      },
      "tokens_used": 5979,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_D-GutterHeights\n\n## Overview\nThis script automatically annotates the vertical Z-heights (gutter levels) of roof sheets or slopes on a 2D drawing layout. It places dimension labels at the highest and lowest points of sheet profiles relative to the element origin, facilitating accurate detailing in Paper Space.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed for 2D layouts only. |\n| Paper Space | Yes | Script must be inserted on a Layout tab containing a Viewport. |\n| Shop Drawing | No | Works with standard Elements and Sheets. |\n\n## Prerequisites\n- **Required Entities**: An hsbCAD Element containing Sheets (e.g., roof gutter parts) visible in a Viewport.\n- **Minimum Beams**: N/A (Script works with Element/Sheet geometry).\n- **Required Settings**:\n  - Target Sheets must have a SubMap named 'Rotation' OR a SubLabel matching the `sManualRotation` property.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or `Run TSL` depending on your environment configuration)\nAction: Browse and select `HSB_D-GutterHeights.mcr`.\n\n### Step 2: Select a Viewport\n```\nCommand Line: Select a viewport\nAction: Click inside the viewport on your layout that displays the Element (e.g., roof) you wish to annotate.\n```\n\n### Step 3: Place Script Instance\n```\nCommand Line: Select a point\nAction: Click anywhere in the Paper Space to place the script instance marker.\nNote: This point determines where the script object is stored; it does not determine the position of the text labels.\n```\n\n### Step 4: Configure Properties (Optional)\nAction: The Properties Palette will open automatically upon insertion. Adjust settings like text prefix or offset distance if the default placement is not ideal.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **\\|Gutter dimension\\|** | PropString | | Visual separator/header. |\n| Prefix | Text | \"Gooth = \" | The text label appearing before the height value (e.g., \"Height = \", \"Z = \"). |\n| Offset | Number | 10.0 | The distance (in mm) from the sheet edge to the dimension text in Paper Space. Increase if text overlaps geometry. |\n| **\\|Style\\|** | PropString | | Visual separator/header. |\n| Dimension style | Dropdown | _DimStyles | The CAD dimension style (font, size, arrow) applied to the labels. |\n| Sublabel manual rotated sheets | Text | \"Helling\" | Filter used to identify manually rotated sheets if they do not have a standard 'Rotation' SubMap. |\n\n## Right-Click Menu Options\nThis script does not add specific custom actions to the right-click context menu.\n\n## Settings Files\nNo external settings files (XML/INI) are required for this script. All configuration is handled via the Properties Panel.\n\n## Tips\n- **Adjusting Text Position**: If the dimension text is too close to or overlapping the sheet, increase the `Offset` property value in the Properties Palette.\n- **Filtering Sheets**: If the script does not dimension specific gutter sheets, check the SubLabel of those sheets in the Model. Ensure the `sManualRotation` property matches that SubLabel.\n- **Script Placement**: The point you click in Step 3 merely saves the script instance in the drawing. The actual dimension labels are locked to the sheet geometry inside the viewport. Moving the script instance point will not move the text.\n\n## FAQ\n- **Q: Why did the script disappear immediately after insertion?**\n  A: The script requires a valid Viewport containing an Element. If the selected viewport is empty or invalid, the script erases itself automatically. Select a valid viewport and try again.\n- **Q: No height labels appeared on my drawing.**\n  A: Ensure the sheets inside the viewport match the criteria. They must either have a 'Rotation' SubMap or a SubLabel matching the `sManualRotation` property (default: \"Helling\").\n- **Q: Can I change the text from \"Gooth =\" to \"Height =\"?**\n  A: Yes. Select the script instance, open the Properties Palette, and change the `Prefix` text."
      },
      "tokens_used": 5517,
      "error": null
    }
  }
}