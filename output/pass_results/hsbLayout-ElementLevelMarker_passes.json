{
  "filename": "hsbLayout-ElementLevelMarker.mcr",
  "status": "completed",
  "total_tokens": 32793,
  "processing_time": 256.0373332500458,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.1",
            "date": "19dec2017",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "deactivated for multiwalls"
          },
          {
            "version": "1.0",
            "date": "22nov2017",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5075,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Viewport vp = getViewport(T(\"|Select a viewport|\")); check if (_Viewport.length()==0); CoordSys ms2ps = vp.coordSys(); pl.transformBy(ms2ps); prompts user for viewport selection"
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout) with a Viewport linked to a valid hsb Element",
          "requiredSettings": []
        }
      },
      "tokens_used": 3910,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "|Select a viewport|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "On Insert (if _kExecuteKey is empty)",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": "|Display|",
            "description": "|Defines the Dimstyle|"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Text Height| |0 = byDimstyle|"
          },
          {
            "index": 1,
            "variable": "sUnit",
            "type": "PropString",
            "displayName": "|Units|",
            "defaultValue": "m",
            "inputType": "dropdown",
            "options": [
              "mm",
              "cm",
              "m",
              "in",
              "ft"
            ],
            "category": "|Display|",
            "description": "|Defines the Unit|"
          },
          {
            "index": 0,
            "variable": "nDecimal",
            "type": "PropInt",
            "displayName": "|Decimals|",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the Decimals|"
          },
          {
            "index": 2,
            "variable": "sStyle",
            "type": "PropString",
            "displayName": "|Style|",
            "defaultValue": "|Finished Floor|",
            "inputType": "dropdown",
            "options": [
              "|Finished Floor|",
              "|Unfinished Floor|"
            ],
            "category": "|Display|",
            "description": "|Defines the symbol style|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5885,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically annotates the elevation level of an Element (e.g., wall or floor) in Paper Space relative to a user-selected insertion point within a specific Viewport.",
          "category": "ShopDrawing / Annotation",
          "typicalUseCase": "Used during drawing creation to clearly indicate the floor level ( Finished or Unfinished) of structural elements on layout sheets, ensuring dimensions are correctly projected from Model Space to Paper Space."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Selects the CAD dimension style (text font, arrow style, color) used for the level indicator.",
            "validRange": "Any valid dimension style defined in the current CAD drawing template.",
            "unit": "N/A (Style Name)",
            "affectsOutput": "Changes the visual appearance (font, color, layer) of the text and dimension lines drawn in Paper Space."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "0",
            "businessMeaning": "Sets the height of the level text.",
            "validRange": "1.5mm to 5.0mm (standard architectural text sizes)",
            "unit": "Paper Space Units (mm)",
            "affectsOutput": "If > 0, overrides the text height defined in the selected DimStyle. If 0, the DimStyle's default height is used."
          },
          {
            "name": "sUnit",
            "technicalDefault": "m",
            "businessMeaning": "Defines the measurement unit for the level annotation.",
            "validRange": "mm, cm, m, in, ft",
            "unit": "N/A (Enumeration)",
            "affectsOutput": "Converts the calculated Model Space elevation difference into the specified unit for display (e.g., converting 3000mm to 3.00m)."
          },
          {
            "name": "nDecimal",
            "technicalDefault": "3",
            "businessMeaning": "Sets the precision of the numerical level display.",
            "validRange": "0 to 3 (typically 2 or 3 for mm/cm, 3 or 4 for m)",
            "unit": "count (decimal places)",
            "affectsOutput": "Formats the output string (e.g., +3.000 vs +3.00)."
          },
          {
            "name": "sStyle",
            "technicalDefault": "|Finished Floor|",
            "businessMeaning": "Selects the graphic symbol type to denote the reference level (Finished vs Unfinished).",
            "validRange": "Finished Floor, Unfinished Floor",
            "unit": "N/A (Enumeration)",
            "affectsOutput": "Draws either an open triangle symbol (Finished) or a filled triangle symbol (Unfinished) at the insertion point."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight is set to 0",
            "effect": "The text height is automatically determined by the sDimStyle setting.",
            "cascade": [
              "dTextHeight",
              "sDimStyle"
            ]
          },
          {
            "trigger": "sUnit is set to 'm' or 'ft'",
            "effect": "The nDecimal parameter becomes more critical for precision (e.g., requiring 3 decimals for meters).",
            "cascade": [
              "sUnit",
              "nDecimal"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation Geometry (PLine, Text)",
            "description": "Draws a leader line, a triangle symbol (filled or open), and text indicating the relative height (e.g., +2.800) in Paper Space.",
            "appliedTo": "Paper Space Viewport (linked to a specific Model Space Element)"
          }
        ]
      },
      "tokens_used": 4914,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: Triggered via hsbCAD menu or command line.",
          "2. Silent/Dialog Check: Checks _kExecuteKey. If empty, opens OPM Properties dialog for user configuration.",
          "3. Configuration: User selects parameters (DimStyle, Text Height, Units, Decimals, Style).",
          "4. Catalog Check (if Key exists): Applies catalog settings if a valid key is found, otherwise defaults to last used.",
          "5. Viewport Selection: User selects a Viewport in Paper Space.",
          "6. Point Selection: User picks an insertion point in Paper Space for the marker.",
          "7. Entity Check: Script validates the selected Viewport contains a valid hsb Element.",
          "8. Calculation: Calculates transformation from Model Space to Paper Space, determines reference points and elevation.",
          "9. Element Type Check: Checks if Element is a Multiwall.",
          "10. Geometry Construction: Determines marker side, draws leader, triangle, and text based on properties.",
          "11. Completion: Draws the final annotation in Paper Space and ends script execution."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Return (Exit)"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Continue to Dialog/Viewport selection"
              ]
            }
          },
          {
            "condition": "Execute Key (_kExecuteKey)",
            "path1": {
              "name": "Key Exists",
              "steps": [
                "Load Properties from Catalog matching Key",
                "If Key invalid, Load Last Inserted Properties"
              ]
            },
            "path2": {
              "name": "Key Empty",
              "steps": [
                "Show OPM Dialog"
              ]
            }
          },
          {
            "condition": "Viewport Element Validity",
            "path1": {
              "name": "Invalid Element",
              "steps": [
                "Return (Exit without drawing)"
              ]
            },
            "path2": {
              "name": "Valid Element",
              "steps": [
                "Proceed to transformation and calculation"
              ]
            }
          },
          {
            "condition": "Element Type (Multiwall)",
            "path1": {
              "name": "Element is Multiwall",
              "steps": [
                "Return (Exit - Deactivated for multiwalls per v1.1)"
              ]
            },
            "path2": {
              "name": "Standard Element",
              "steps": [
                "Calculate outline and draw marker"
              ]
            }
          },
          {
            "condition": "Marker Style (sStyle)",
            "path1": {
              "name": "Finished Floor (Index 0)",
              "steps": [
                "Draw Open Triangle (PLine)"
              ]
            },
            "path2": {
              "name": "Unfinished Floor (Index 1)",
              "steps": [
                "Draw Filled Triangle (PlaneProfile)"
              ]
            }
          },
          {
            "condition": "Text Height (dTextHeight)",
            "path1": {
              "name": "Text Height > 0",
              "steps": [
                "Use defined dTextHeight"
              ]
            },
            "path2": {
              "name": "Text Height == 0",
              "steps": [
                "Use DimStyle default text height"
              ]
            }
          },
          {
            "condition": "Elevation Value Sign (dZ)",
            "path1": {
              "name": "Zero (abs(dZ) < Epsilon)",
              "steps": [
                "Prefix text with '±'"
              ]
            },
            "path2": {
              "name": "Positive (dZ > Epsilon)",
              "steps": [
                "Prefix text with '+'"
              ]
            },
            "path3": {
              "name": "Negative (dZ < -Epsilon)",
              "steps": [
                "Keep raw negative string"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "N/A (implicit via getViewport function)",
            "recovery": "User must select a valid viewport."
          },
          {
            "check": "Viewport has hsb Element Data",
            "errorMessage": "No error displayed, script fails silently.",
            "recovery": "Select a viewport that is linked to a valid model element."
          },
          {
            "check": "Element is not a Multiwall",
            "errorMessage": "No error displayed, script fails silently.",
            "recovery": "Script does not support multiwalls (deactivated in v1.1). Use on standard walls/floors."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties",
            "how": "OPM Properties Palette (Select script instance)",
            "effect": "Updates DimStyle, Text Height, Units, Decimals, and Style symbol immediately upon recalculation."
          },
          {
            "action": "Move/Scale",
            "how": "Grip Edits (Standard CAD commands)",
            "effect": "Moves the graphical representation. Note: This is a dynamic annotation; moving it might require re-running the script or manual adjustment if the link to the viewport element is purely visual."
          }
        ]
      },
      "tokens_used": 7065,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbLayout-ElementLevelMarker.mcr\n\n## Overview\nThis script annotates the elevation level (Z-height) of a structural element directly in Paper Space. It allows you to place a level marker (Finished or Unfinished floor style) linked to the geometry displayed within a selected viewport.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | The script is intended for Layout/Sheet annotation. |\n| Paper Space | Yes | The script must be run on a Layout tab containing Viewports. |\n| Shop Drawing | No | This is an annotation tool for layout drawings. |\n\n## Prerequisites\n- **Required Entities**: A Viewport in Paper Space that is currently displaying a valid hsbCAD Element (e.g., a Wall or Floor).\n- **Minimum beam count**: 0 (The script targets the Element associated with the viewport, not individual beams).\n- **Required Settings**: None.\n- **Restriction**: The script is deactivated for **Multiwalls** and will not generate output if the selected viewport contains one.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbLayout-ElementLevelMarker.mcr` from the list.\n*Note: Upon first insert, the Properties Palette may open automatically to configure settings.*\n\n### Step 2: Configure Properties (Optional)\nIf the Properties Palette does not open automatically, select the script instance after insertion to adjust settings (Style, Units, Text Height) before placing the marker.\n\n### Step 3: Select Viewport\n```\nCommand Line: |Select a viewport|\nAction: Click on the border of the viewport in Paper Space that shows the element you want to annotate.\n```\n\n### Step 4: Place Marker\n```\nCommand Line: (None specified, usually a point prompt)\nAction: Click a point in Paper Space where you want the level marker leader to point.\n```\n*The script will automatically calculate the elevation based on the model geometry and draw the marker.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimstyle | dropdown | _DimStyles | Selects the CAD dimension style (font, arrows, color) for the text and lines. |\n| Text Height | number | 0 | Defines the height of the text in Paper Space units. **0** uses the height defined in the selected Dimstyle. |\n| Units | dropdown | m | Defines the unit of measurement for the level value (mm, cm, m, in, ft). |\n| Decimals | number | 3 | Sets the number of decimal places for the level value (e.g., 3.000). |\n| Style | dropdown | Finished Floor | Defines the symbol style. <br>**Finished Floor**: Draws an open triangle. <br>**Unfinished Floor**: Draws a filled triangle. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the AutoCAD Properties Palette to adjust Marker Style, Units, and Text formatting. |\n| Erase | Removes the script instance and the drawn annotation. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not use external XML settings files. Configuration is handled via the Properties Panel.\n\n## Tips\n- **Re-calculating Levels**: If the model geometry changes and the floor level moves, select the marker and use the `TSLRECALC` command (or right-click -> Recalculate if available) to update the value.\n- **Text Scaling**: If you want the text size to adjust automatically when you change the Dimstyle, keep `Text Height` set to `0`.\n- **Negative Values**: The script automatically prefixes positive values with `+` and negative values with `-`. Zero values are prefixed with `±`.\n\n## FAQ\n- **Q: I clicked the viewport, but nothing happened. Why?**\n- **A:** The script is likely deactivated for the element type inside that viewport. Check if the element is a **Multiwall**. This script currently only works on standard single walls or floors.\n- **Q: How do I change the unit from meters to millimeters?**\n- **A:** Select the drawn marker, open the Properties palette (Ctrl+1), and change the `Units` dropdown from 'm' to 'mm'.\n- **Q: Can I use this in Model Space?**\n- **A:** No, this script is designed specifically for creating annotations on Layout Sheets (Paper Space)."
      },
      "tokens_used": 5944,
      "error": null
    }
  }
}