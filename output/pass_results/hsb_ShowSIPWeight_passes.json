{
  "filename": "hsb_ShowSIPWeight.mcr",
  "status": "completed",
  "total_tokens": 39120,
  "processing_time": 558.2193431854248,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "15.01.2010",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "Release version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 3490,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses getViewport() to prompt user input and stores it in _Viewport. It validates this with if( _Viewport.length()==0 ). It retrieves the Element using vp.element() and uses a coordinate system transform ms2ps = vp.coordSys() to align the text output for the drawing layout."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Sip",
            "GenBeam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be executed in a Paper Space layout with an active viewport displaying an Element.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3964,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "Pick a Point",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getViewport",
              "promptOriginal": "Select a viewport",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sNameMat1",
            "type": "PropString",
            "displayName": "Name Material 1",
            "defaultValue": "OSB",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Set Color",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dWeightMat1",
            "type": "PropDouble",
            "displayName": "Weight Material 1(Kg/m3)",
            "defaultValue": 450,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sNameMat2",
            "type": "PropString",
            "displayName": "Name Material 2",
            "defaultValue": "Urethane",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dWeightMat2",
            "type": "PropDouble",
            "displayName": "Weight Material 2(Kg/m3)",
            "defaultValue": 450,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sNameMat3",
            "type": "PropString",
            "displayName": "Name Material 3",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dWeightMat3",
            "type": "PropDouble",
            "displayName": "Weight Material 3(Kg/m3)",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sNameMat4",
            "type": "PropString",
            "displayName": "Name Material 4",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dWeightMat4",
            "type": "PropDouble",
            "displayName": "Weight Material 4(Kg/m3)",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sNameMat5",
            "type": "PropString",
            "displayName": "Name Material 5",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dWeightMat5",
            "type": "PropDouble",
            "displayName": "Weight Material 5(Kg/m3)",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "dBmWeight",
            "type": "PropDouble",
            "displayName": "Weight for Standard Beams (Kg/m3)",
            "defaultValue": 450,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 8,
            "variable": "dTextOffset",
            "type": "PropDouble",
            "displayName": "Text Offset",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6437,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates the total physical weight (in Kg) of a Structural Insulated Panel (SIP) element and its associated beams, and annotates this weight on a Paper Space layout.",
          "category": "ShopDrawing",
          "typicalUseCase": "Placing weight labels on production drawings for logistics, crane lifting planning, or transportation load calculations."
        },
        "parameters": [
          {
            "name": "sNameMat1",
            "technicalDefault": "OSB",
            "businessMeaning": "The exact name of the material used for the first SIP layer (typically the outer skin) as defined in the hsbCAD SIP Style database. Used to map the component to a specific density.",
            "validRange": "Any string matching the Material Name in the SIP Style (e.g., 'OSB', 'Plywood').",
            "unit": "text",
            "affectsOutput": "Determines which components of the SIP are calculated using 'Weight Material 1'. If the SIP component name does not match, that layer's weight is ignored (0)."
          },
          {
            "name": "dWeightMat1",
            "technicalDefault": "450",
            "businessMeaning": "The density (mass per unit volume) assigned to Material 1.",
            "validRange": "Typical OSB/Plywood is 600-650 kg/m³. The default 450 is low for OSB but might represent a specific timber type.",
            "unit": "Kg/m3",
            "affectsOutput": "Directly multiplies the volume of matching SIP components to calculate mass. Higher values increase the total weight displayed."
          },
          {
            "name": "sNameMat2",
            "technicalDefault": "Urethane",
            "businessMeaning": "The exact name of the material used for the second SIP layer (typically the insulation core) as defined in the SIP Style.",
            "validRange": "Common names include 'Urethane', 'EPS', 'PUR', 'Mineral Wool'.",
            "unit": "text",
            "affectsOutput": "Maps the core insulation material to 'Weight Material 2'. Critical for accurate total weight as insulation volume is large but density is low."
          },
          {
            "name": "dWeightMat2",
            "technicalDefault": "450",
            "businessMeaning": "The density of the insulation/core material.",
            "validRange": "EPS: 15-30 kg/m³; Urethane/PUR: 30-40 kg/m³; Mineral Wool: 40-140 kg/m³. The default 450 is likely incorrect for insulation (too high).",
            "unit": "Kg/m3",
            "affectsOutput": "Calculates the weight of the core layer. Correct setting is vital as core volume is the largest part of the panel."
          },
          {
            "name": "sNameMat3",
            "technicalDefault": "",
            "businessMeaning": "Optional material name for a third SIP layer (e.g., inner skin, service chases, or additional cladding).",
            "validRange": "String matching SIP Style definition.",
            "unit": "text",
            "affectsOutput": "Enables weight calculation for additional SIP components if defined."
          },
          {
            "name": "dWeightMat3",
            "technicalDefault": "0",
            "businessMeaning": "Density for the third material layer.",
            "validRange": "0 - 1000 kg/m³ depending on material.",
            "unit": "Kg/m3",
            "affectsOutput": "Adds weight for the 3rd layer if present."
          },
          {
            "name": "sNameMat4",
            "technicalDefault": "",
            "businessMeaning": "Optional material name for a fourth SIP layer.",
            "validRange": "String matching SIP Style definition.",
            "unit": "text",
            "affectsOutput": "Enables weight calculation for the 4th layer."
          },
          {
            "name": "dWeightMat4",
            "technicalDefault": "0",
            "businessMeaning": "Density for the fourth material layer.",
            "validRange": "0 - 1000 kg/m³",
            "unit": "Kg/m3",
            "affectsOutput": "Adds weight for the 4th layer if present."
          },
          {
            "name": "sNameMat5",
            "technicalDefault": "",
            "businessMeaning": "Optional material name for a fifth SIP layer.",
            "validRange": "String matching SIP Style definition.",
            "unit": "text",
            "affectsOutput": "Enables weight calculation for the 5th layer."
          },
          {
            "name": "dWeightMat5",
            "technicalDefault": "0",
            "businessMeaning": "Density for the fifth material layer.",
            "validRange": "0 - 1000 kg/m³",
            "unit": "Kg/m3",
            "affectsOutput": "Adds weight for the 5th layer if present."
          },
          {
            "name": "dBmWeight",
            "technicalDefault": "450",
            "businessMeaning": "Density of standard timber beams (GenBeams) contained within the element.",
            "validRange": "400-550 kg/m³ (Softwoods like C24/SPF). Glulam is similar. Heavy timber might be higher.",
            "unit": "Kg/m3",
            "affectsOutput": "Calculates the weight of all standard structural beams (studs, top plates, etc.) in the element and adds it to the SIP total."
          },
          {
            "name": "nColor",
            "technicalDefault": "1",
            "businessMeaning": "The AutoCAD color index for the text label.",
            "validRange": "1-255 (Standard AutoCAD colors). 1=Red, 2=Yellow, 3=Green, 4=Cyan, 5=Blue, 6=Magenta, 7=White/Black.",
            "unit": "Color Index",
            "affectsOutput": "Changes the visible color of the weight text annotation."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The drafting style used for the text annotation, controlling font, height, and text appearance.",
            "validRange": "Any valid DimStyle name loaded in the current drawing.",
            "unit": "text",
            "affectsOutput": "Controls the visual style (font size, type) of the displayed weight label."
          },
          {
            "name": "dTextOffset",
            "technicalDefault": "0",
            "businessMeaning": "Distance to shift the text label vertically (relative to its local Y-axis) from the picked insertion point.",
            "validRange": "0 - 5000 mm (depending on drawing scale and desired spacing).",
            "unit": "mm",
            "affectsOutput": "Adjusts the position of the text to avoid overlapping with other drawing details."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "SIP Style Material Definition",
            "effect": "The values in 'Name Material X' properties MUST exactly match the material names defined in the Element's SIP Styles (case-insensitive). If they do not match, the script assumes 0 density for that layer.",
            "cascade": [
              "dWeightMat1",
              "dWeightMat2",
              "dWeightMat3",
              "dWeightMat4",
              "dWeightMat5"
            ]
          },
          {
            "trigger": "Element Composition",
            "effect": "If the Element contains no Beams, 'dBmWeight' has no effect. If the Element contains no SIPs, the Material 1-5 properties have no effect.",
            "cascade": [
              "dBmWeight"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation Text",
            "description": "A text entity displaying 'SIP Weight: [Value] Kg' placed in Paper Space, aligned to the selected viewport's orientation.",
            "appliedTo": "Paper Space Layout (associated with the selected Model Space Element Viewport)"
          }
        ]
      },
      "tokens_used": 6930,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script: User executes hsb_ShowSIPWeight.mcr.",
          "2. Display Properties: The script properties dialog displays (Material names, Weights, DimStyle, etc.).",
          "3. Pick Insertion Point: Command line prompts 'Pick a Point'. User clicks in Paper Space to define the text location.",
          "4. Select Viewport: Command line prompts 'Select a viewport'. User clicks a viewport containing the Element to calculate.",
          "5. Script Initialization: Script stores inputs and terminates the insertion cycle.",
          "6. Recalculation Trigger: Script executes again (recalc) to process geometry.",
          "7. Validation: Script checks if the selected viewport exists and contains a valid Element. If not, the script erases itself.",
          "8. Build Material Map: Script compiles a list of active material names (Mat 1-5) and their corresponding densities based on Property inputs.",
          "9. Coordinate Transformation: Script calculates the transformation matrix to align text orientation with the viewport's view of the model.",
          "10. Iterate SIPs: Script loops through all Structural Insulated Panels in the Element.",
          "11. Calculate SIP Volume: For each panel, the script determines the profile area (subtracting openings) and multiplies it by component thicknesses.",
          "12. Match SIP Materials: Script compares the internal SIP component material names against the Property-defined Material Names (1-5).",
          "13. Calculate SIP Weight: If a match is found, the volume is multiplied by the specific density (Kg/m3) and added to the total.",
          "14. Iterate Beams: Script loops through all standard beams (GenBeams) in the Element.",
          "15. Calculate Beam Weight: Volume of each beam is calculated and multiplied by the 'Weight for Standard Beams' property density.",
          "16. Finalize Weight: Beam weight is added to SIP weight to create the Total Weight.",
          "17. Generate Text: Script formats the value into a string 'SIP Weight: [Value] Kg'.",
          "18. Draw Annotation: If Total Weight > 0, the text entity is drawn in Paper Space at the selected point (adjusted by offset) using the defined DimStyle and Color."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Detection",
            "path1": {
              "name": "Initial Insert",
              "steps": [
                "Check insertCycleCount() <= 1",
                "Show dialog",
                "Prompt for Point and Viewport",
                "Store data"
              ]
            },
            "path2": {
              "name": "Duplicate/Recalc Event",
              "steps": [
                "Check insertCycleCount() > 1",
                "Erase Instance immediately to prevent duplicate geometry"
              ]
            }
          },
          {
            "condition": "Viewport/Element Validity",
            "path1": {
              "name": "Valid Viewport",
              "steps": [
                "Viewport exists in _Viewport array",
                "Viewport links to a valid Element (element().bIsValid() is true)",
                "Proceed to calculation"
              ]
            },
            "path2": {
              "name": "Invalid/Missing Viewport",
              "steps": [
                "Viewport array is empty OR element is invalid",
                "Erase Instance",
                "Stop execution"
              ]
            }
          },
          {
            "condition": "SIP Material Matching",
            "path1": {
              "name": "Material Match Found",
              "steps": [
                "Sip Component Material Name matches Property Name (Mat 1-5)",
                "Retrieve specific density (Weight Mat 1-5)",
                "Calculate Mass = Volume * Density",
                "Add to Total Weight"
              ]
            },
            "path2": {
              "name": "No Match",
              "steps": [
                "Sip Component Material Name does not match any Property Name",
                "Ignore component weight contribution (0)"
              ]
            }
          },
          {
            "condition": "Text Orientation Logic",
            "path1": {
              "name": "Aligned Orientation",
              "steps": [
                "Transformed Element X-vector has significant projection on Paper Space X-axis (> 0.5)",
                "Use transformed vectors for text rotation"
              ]
            },
            "path2": {
              "name": "Fallback Orientation",
              "steps": [
                "Transformed Element X-vector is nearly perpendicular to Paper Space X-axis (< 0.5)",
                "Force text to align with standard Paper Space X/Y axes (World X/Y)"
              ]
            }
          },
          {
            "condition": "Final Weight Result",
            "path1": {
              "name": "Weight > 0",
              "steps": [
                "Total Weight is calculated",
                "Display 'SIP Weight: [Value] Kg' text"
              ]
            },
            "path2": {
              "name": "Weight = 0",
              "steps": [
                "No geometry or densities resulted in mass",
                "Draw nothing (Text is skipped)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "None (Script fails silently)",
            "recovery": "User must re-run the script and ensure a viewport is selected during the 'Select a viewport' prompt."
          },
          {
            "check": "Element Validity",
            "errorMessage": "None (Script fails silently)",
            "recovery": "Ensure the selected viewport contains a valid hsbCAD Element with data."
          },
          {
            "check": "Material Name Matching",
            "errorMessage": "Weight value is lower than expected or Zero",
            "recovery": "Verify that 'Name Material X' properties exactly match the material names defined in the SIP Style (Case Insensitive). Verify densities are not 0."
          },
          {
            "check": "Total Weight Calculation",
            "errorMessage": "Text label does not appear on drawing",
            "recovery": "Check if calculated weight is 0. Ensure densities (Kg/m3) are entered correctly for both SIP layers and Standard Beams."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties (OPM)",
            "how": "Select the script instance in Paper Space and change values in the AutoCAD Properties Palette (e.g., change Material Names, Densities, Text Offset, Color).",
            "effect": "The script recalculates the weight based on new densities and updates the text label immediately. Changing 'Text Offset' moves the text. Changing 'DimStyle' or 'Color' updates the appearance."
          },
          {
            "action": "Move Text Location",
            "how": "Select the script instance and drag the grip (insertion point).",
            "effect": "The text label moves to the new location in Paper Space."
          },
          {
            "action": "Update Model Geometry",
            "how": "Modify the SIP or Beam geometry in Model Space (e.g., change panel size, add beams, change material assignments in the catalog).",
            "effect": "The script automatically detects the change via the Viewport link, recalculates the weight, and updates the Paper Space text."
          }
        ]
      },
      "tokens_used": 9326,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ShowSIPWeight.mcr\n\n## Overview\nCalculates the total weight (in Kg) of an Element's Structural Insulated Panels (SIPs) and standard beams, and places a text annotation in Paper Space.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | Script must be inserted in Paper Space. |\n| Paper Space | Yes | Intended for layout views. |\n| Shop Drawing | No | This script annotates the drawing layout itself. |\n\n## Prerequisites\n- **Required Entities**: An hsbCAD Element containing SIPs and/or Beams.\n- **Minimum Beam Count**: 0 (Works with just SIPs, just beams, or both).\n- **Required Settings**: The script relies on Material Names defined in the SIP Style database matching the properties in the script.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsb_ShowSIPWeight.mcr`\n\n### Step 2: Pick Insertion Point\n```\nCommand Line: Pick a Point\nAction: Click in the Paper Space layout where you want the weight label to appear.\n```\n\n### Step 3: Select Source Viewport\n```\nCommand Line: Select a viewport\nAction: Click on the viewport that displays the Element you wish to calculate.\n```\n*Note: The script will automatically calculate the weight based on the content of the view.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Name Material 1 | text | OSB | Exact name of the first SIP layer material (e.g., Outer Skin) as defined in the SIP Style. |\n| Weight Material 1(Kg/m3) | number | 450 | Density of Material 1. |\n| Name Material 2 | text | Urethane | Exact name of the second SIP layer material (e.g., Insulation Core). |\n| Weight Material 2(Kg/m3) | number | 450 | Density of Material 2. |\n| Name Material 3 | text | (empty) | Optional name for a third SIP layer material. |\n| Weight Material 3(Kg/m3) | number | 0 | Density of Material 3. |\n| Name Material 4 | text | (empty) | Optional name for a fourth SIP layer material. |\n| Weight Material 4(Kg/m3) | number | 0 | Density of Material 4. |\n| Name Material 5 | text | (empty) | Optional name for a fifth SIP layer material. |\n| Weight Material 5(Kg/m3) | number | 0 | Density of Material 5. |\n| Weight for Standard Beams (Kg/m3) | number | 450 | Density of standard timber beams (GenBeams) within the element. |\n| Set Color | number | 1 | AutoCAD color index for the text label (1=Red, 7=White, etc.). |\n| Dimstyle | dropdown | _DimStyles | The text style used for the annotation. |\n| Text Offset | number | 0 | Vertical offset distance (mm) to shift the text from the picked point. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | No custom context menu options are defined for this script. |\n\n## Settings Files\n- No external settings files are required for this script.\n\n## Tips\n- **Material Names Matter**: The values in \"Name Material X\" **must** match exactly (case-insensitive) with the material names in your SIP Styles. If they don't match, that layer is treated as weightless.\n- **Verify Densities**: The default density for \"Urethane\" (450 kg/m3) is likely incorrect for insulation foam (usually ~30-40 kg/m3). Always verify densities match your real-world materials.\n- **Re-positioning**: You can select the text and drag its grip to move it around the layout after insertion.\n- **Updates**: If you change the model (e.g., resize a panel), the text updates automatically when the drawing is regenerated.\n\n## FAQ\n- **Q: The text says \"SIP Weight: 0 Kg\". Why?**\n  - **A:** Check the \"Name Material\" properties. If the script cannot find a material in the SIP that matches your inputs, the weight is 0. Ensure the names match your hsbCAD SIP Style definitions.\n- **Q: Can I use this for walls that are not SIPs?**\n  - **A:** Yes, as long as the element contains GenBeams. Set \"Weight for Standard Beams\" to the correct timber density, and the script will calculate the weight of the studs/plates.\n- **Q: How do I change the text size?**\n  - **A:** Change the **Dimstyle** property to a text style defined in your drawing with the desired height."
      },
      "tokens_used": 8973,
      "error": null
    }
  }
}