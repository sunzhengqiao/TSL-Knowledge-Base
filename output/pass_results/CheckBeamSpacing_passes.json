{
  "filename": "CheckBeamSpacing.mcr",
  "status": "completed",
  "total_tokens": 49324,
  "processing_time": 285.880352973938,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 1,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl checks the maximum spacing",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "23.07.2019",
            "author": "RVW",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "24.07.2019",
            "author": "RVW",
            "changes": "Calculate max distance if using 0 (element distance between beams) to the distance between the beams minus the half thickness of the beams. And add properties to set to the new created beams."
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7603,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses 'tsl.dbCreate(..., _kModelSpace, ...)' to insert satellite instances. It interacts directly with Element and Beam entities using methods like 'el.beam()', 'dbCopy()', and 'stretchStaticTo()', which are Model Space construction operations. It does not use any ShopDrawing API (sd_*) or Viewport handling."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWallSF",
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing elements with beams",
          "requiredSettings": []
        }
      },
      "tokens_used": 6021,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity.go",
              "promptOriginal": "Select a set of elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "On Insert (if no execute key or catalog key not found)",
            "title": null,
            "dataSource": "Script Properties (OPM)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sequenceNumber",
            "type": "PropInt",
            "displayName": "Sequence number",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "The sequence number is used to sort the list of tsl's during generate construction"
          },
          {
            "index": 6,
            "variable": "sFilterBC",
            "type": "PropString",
            "displayName": "Filter beams with beamcode",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "General",
            "description": "Specify beamcode's that can be excluded from the calculation"
          },
          {
            "index": 1,
            "variable": "dMaxAllowedSpacing",
            "type": "PropDouble",
            "displayName": "Maximum allowed spacing",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Dimensions",
            "description": "This is the maximum spacing allowed between vertical beams. If zero, spacing set in element is checked"
          },
          {
            "index": 2,
            "variable": "SAddBeams",
            "type": "PropString",
            "displayName": "Automatic add beams",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "From left",
              "In center",
              "From right"
            ],
            "category": "Dimensions",
            "description": "Automaticaly add vertical beams from left, in center or from right"
          },
          {
            "index": 7,
            "variable": "sAddCircle",
            "type": "PropString",
            "displayName": "Show circle",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": "Dimensions",
            "description": "Add a circle when exceeding the maximum spacing between the studs"
          },
          {
            "index": 4,
            "variable": "nWrongBeamColor",
            "type": "PropInt",
            "displayName": "Color of the wrong beam",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "Color",
            "description": "Sets the color of all the beams that are at an incorrect spacing distance"
          },
          {
            "index": 5,
            "variable": "nAddedBeamColor",
            "type": "PropInt",
            "displayName": "Color of the added beam",
            "defaultValue": 3,
            "inputType": "number",
            "options": [],
            "category": "Color",
            "description": "Sets the color of all the beams that are added"
          },
          {
            "index": 8,
            "variable": "nColorOfCircle",
            "type": "PropInt",
            "displayName": "Color of the circle",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "Color",
            "description": "Sets the color of the circle"
          },
          {
            "index": 9,
            "variable": "newBeamColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "New beam properties",
            "description": "Set the color of the new beam"
          },
          {
            "index": 10,
            "variable": "newBeamName",
            "type": "PropString",
            "displayName": "Beam name",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "New beam properties",
            "description": "Set the name of the new beam"
          },
          {
            "index": 11,
            "variable": "newBeamType",
            "type": "PropString",
            "displayName": "Beam type",
            "defaultValue": "Stud",
            "inputType": "dropdown",
            "options": [
              "Stud",
              "Beam"
            ],
            "category": "New beam properties",
            "description": "Set the type of the new beam"
          },
          {
            "index": 12,
            "variable": "newBeamMaterial",
            "type": "PropString",
            "displayName": "Beam material",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "New beam properties",
            "description": "Set the material of the new beam"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7478,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically checks the spacing between vertical studs or rafters in wall and roof elements against a maximum allowed distance, highlights violations, and optionally inserts additional beams to correct the spacing.",
          "category": "Framing/DesignValidation",
          "typicalUseCase": "Used during the design phase or generation of timber frame walls/roofs to ensure compliance with building codes (e.g., stud spacing max 600mm) and to automatically infill missing studs in large openings or wide bays."
        },
        "parameters": [
          {
            "name": "sequenceNumber",
            "technicalDefault": 0,
            "businessMeaning": "Controls the execution order of this script relative to other TSLs. Ensures this check runs after the element structure is established but potentially before other operations rely on the final stud count.",
            "validRange": "0 - 1000",
            "unit": "Integer (Priority)",
            "affectsOutput": "Calculation timing within the hsbCAD generate construction process."
          },
          {
            "name": "sFilterBC",
            "technicalDefault": "",
            "businessMeaning": "Defines which specific beams (by their BeamCode) to exclude from the spacing check. Allows users to ignore specific structural elements like trimmers, headers, or special posts that shouldn't trigger spacing errors.",
            "validRange": "Text string, supports wildcards (e.g., 'Rim', '*Post*')",
            "unit": "String",
            "affectsOutput": "Selects which beams are evaluated for spacing violations."
          },
          {
            "name": "dMaxAllowedSpacing",
            "technicalDefault": 0,
            "businessMeaning": "The maximum permissible clear distance between the faces of vertical beams. If set to 0, the script defaults to the spacing already defined in the Element's properties.",
            "validRange": "0 (Use Element Default) or >0 (e.g., 600mm, 24 inch)",
            "unit": "Length (mm/inch)",
            "affectsOutput": "Determines the threshold for triggering an error and adding new beams."
          },
          {
            "name": "SAddBeams",
            "technicalDefault": "No",
            "businessMeaning": "Specifies the automatic remediation strategy when a spacing violation is detected: whether to leave it as an error, or add new beams filling the gap from the left side, centered in the gap, or from the right side.",
            "validRange": "No, From left, In center, From right",
            "unit": "Enum (Option)",
            "affectsOutput": "Triggers the physical insertion of new GenBeams into the model to fix spacing."
          },
          {
            "name": "sAddCircle",
            "technicalDefault": "No",
            "businessMeaning": "Toggles the visual QC marker. If 'Yes', draws a circle in the model location where the spacing between two studs exceeds the allowed maximum.",
            "validRange": "Yes, No",
            "unit": "Enum (Boolean)",
            "affectsOutput": "Creates graphical PLine entities (circles) to visualize error locations."
          },
          {
            "name": "nWrongBeamColor",
            "technicalDefault": 1,
            "businessMeaning": "The display color used to temporarily highlight the existing beams that are too far apart, helping the user identify problem areas visually.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Visual appearance (color) of existing beams in the CAD viewport during error reporting."
          },
          {
            "name": "nAddedBeamColor",
            "technicalDefault": 3,
            "businessMeaning": "The display color assigned to any new beams generated by the script to fix spacing issues, distinguishing them from the original framing.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Visual appearance of newly inserted beams."
          },
          {
            "name": "nColorOfCircle",
            "technicalDefault": 1,
            "businessMeaning": "The color of the visual circle marker indicating a spacing violation.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Visual appearance of the error marker circle."
          },
          {
            "name": "newBeamColor",
            "technicalDefault": 1,
            "businessMeaning": "The permanent CAD color attribute assigned to any new beams created by the script.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Physical property of the generated beam entity."
          },
          {
            "name": "newBeamName",
            "technicalDefault": "",
            "businessMeaning": "The naming convention or specific name assigned to new beams (e.g., 'AddedStud'). Used for filtering in reports or lists.",
            "validRange": "String",
            "unit": "String",
            "affectsOutput": "Name property of the generated beam entity."
          },
          {
            "name": "newBeamType",
            "technicalDefault": "Stud",
            "businessMeaning": "Classifies the type of beam being added. 'Stud' is typically vertical in walls, while 'Beam' is a generic classification. This affects how the software treats the element in lists and exports.",
            "validRange": "Stud, Beam",
            "unit": "Enum",
            "affectsOutput": "Entity classification (Type) of the generated beam."
          },
          {
            "name": "newBeamMaterial",
            "technicalDefault": "",
            "businessMeaning": "Assigns the material grade or species (e.g., 'C24', 'SPF') to the newly added beams, ensuring structural consistency and correct material take-offs.",
            "validRange": "String (Material Code)",
            "unit": "String",
            "affectsOutput": "Material property of the generated beam entity."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dMaxAllowedSpacing set to 0",
            "effect": "The script ignores this property value and reads the 'spacingBeam' property from the Element itself.",
            "cascade": [
              "Element Properties"
            ]
          },
          {
            "trigger": "SAddBeams set to 'From left', 'In center', or 'From right'",
            "effect": "Enables the creation of new beams, making the 'New beam properties' relevant.",
            "cascade": [
              "newBeamColor",
              "newBeamName",
              "newBeamType",
              "newBeamMaterial",
              "nAddedBeamColor"
            ]
          },
          {
            "trigger": "sAddCircle set to 'Yes'",
            "effect": "Activates the visual error marker.",
            "cascade": [
              "nColorOfCircle"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam (Stud/Beam)",
            "description": "Vertical timber elements inserted into the wall or roof element to fill gaps between existing beams where spacing exceeds the maximum limit.",
            "appliedTo": "ElementWallSF or ElementRoof"
          },
          {
            "type": "PLine (Graphical Marker)",
            "description": "A circle drawn in the model space to visually indicate locations where the spacing between beams is incorrect.",
            "appliedTo": "Model Space (Visual Layer)"
          },
          {
            "type": "DimLine",
            "description": "A dimension line indicating the actual measured distance between beams that violate the spacing rule.",
            "appliedTo": "Model Space (Visual Layer)"
          }
        ]
      },
      "tokens_used": 9388,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Execution Start (Master Instance)",
          "2. Check insertCycleCount(); exit if > 1",
          "3. Validate Execute Key / Catalog usage",
          "4. [Conditional] Show Properties Dialog if no valid catalog key found",
          "5. Prompt user to select Elements (Walls or Roofs) via PrEntity",
          "6. Iterate through selected elements",
          "7. Create Satellite Instance for each Element (passing properties)",
          "8. Erase Master Instance and Return",
          "9. [Satellite Instance Start] Initialize properties from Master Map",
          "10. Validate Element reference; exit if invalid",
          "11. Determine Element Type (Wall or Roof) and retrieve default spacing if needed",
          "12. Collect all Beams from the Element",
          "13. Filter Beams: Exclude by BeamCode (if filter set) and separate Vertical from Horizontal",
          "14. Sort Vertical Beams along the Element's X-axis",
          "15. Iterate through pairs of adjacent Vertical Beams",
          "16. Calculate clear spacing between beam faces",
          "17. [Conditional] Evaluate Spacing Violation (Actual > Allowed)",
          "18. [Conditional] Execute Error Handling (Color beams, Draw Circle/Dim)",
          "19. [Conditional] Execute Remediation (Add new beams based on SAddBeams strategy)",
          "20. [Conditional] Stretch newly added beams to intersect horizontal plates",
          "21. Final Status Report",
          "22. [Conditional] Erase Satellite Instance if no violations found (and constructed)"
        ],
        "conditionalBranches": [
          {
            "condition": "User Input during Insert (Catalog vs Manual)",
            "path1": {
              "name": "Catalog Mode",
              "steps": [
                "Check if _kExecuteKey exists in list of catalog names",
                "If found, load properties from catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Mode",
              "steps": [
                "Detect missing or invalid _kExecuteKey",
                "Execute showDialog()",
                "User sets properties manually",
                "Proceed to selection"
              ]
            }
          },
          {
            "condition": "Element Type Detection",
            "path1": {
              "name": "ElementWallSF",
              "steps": [
                "Cast element to ElementWallSF",
                "Retrieve spacingBeam() for default spacing",
                "Set elIsWall = true"
              ]
            },
            "path2": {
              "name": "ElementRoof",
              "steps": [
                "Cast element to ElementRoof",
                "Retrieve dBeamSpacing() for default spacing",
                "Set elIsWall = false"
              ]
            }
          },
          {
            "condition": "Spacing Violation Detected",
            "path1": {
              "name": "Spacing Valid (dSpacing <= allowedSpacing)",
              "steps": [
                "Skip error reporting",
                "Skip visual markers",
                "Skip beam insertion",
                "Proceed to next pair"
              ]
            },
            "path2": {
              "name": "Spacing Exceeded (dSpacing > allowedSpacing)",
              "steps": [
                "Set bMaxExceeded = true",
                "Report notice of violation",
                "Highlight beams in 'nWrongBeamColor'",
                "Draw Circle/Dimension if enabled",
                "Trigger Remediation Logic (Add Beams)"
              ]
            }
          },
          {
            "condition": "Remediation Strategy (SAddBeams)",
            "path1": {
              "name": "No Action (SAddBeams == 'No')",
              "steps": [
                "Skip beam creation loop",
                "Continue to visual markers"
              ]
            },
            "path2": {
              "name": "Add Beams (From Left/Center/Right)",
              "steps": [
                "Enter loop: While dSpacing > allowedSpacing",
                "dbCopy() source beam (This or Next)",
                "Set new beam properties (Color, Name, Material, Type)",
                "Calculate insertion position based on strategy (l-0.5 offset, center, or negative offset)",
                "Transform beam to position",
                "Search for horizontal beams to stretch to (Top/Bottom)",
                "Execute stretchStaticTo() on new beam",
                "Update dSpacing",
                "Repeat until valid or center filled"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Validity",
            "errorMessage": "Invalid element found",
            "recovery": "Script erases instance. User must select valid hsbCAD Element (Wall/Roof)."
          },
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent exit)",
            "recovery": "Script automatically erases duplicate instances during multi-insert operations."
          },
          {
            "check": "Beam Alignment",
            "errorMessage": "None (Implicit Exclusion)",
            "recovery": "Beams not aligned with Element X or Y axes (within 0.01 tolerance) are ignored in spacing calculations."
          },
          {
            "check": "BeamCode Filter",
            "errorMessage": "None",
            "recovery": "Beams matching the sFilterBC string (wildcards supported) are excluded from the check."
          },
          {
            "check": "Stretch Targets",
            "errorMessage": "None (Logged internally)",
            "recovery": "If no horizontal beam is found to stretch the new stud to, the beam retains default length or previous geometry."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties (OPM)",
            "how": "AutoCAD Properties Palette",
            "effect": "Changing 'dMaxAllowedSpacing', 'SAddBeams', or 'sFilterBC' triggers recalculation. Beams added in previous runs are removed/re-generated based on new logic."
          },
          {
            "action": "Geometry Update",
            "how": "Modify Element or Beam Geometry",
            "effect": "Updating the parent Element or moving existing studs triggers the TSL to re-evaluate spacing and re-run the add/check logic."
          },
          {
            "action": "Manual Cleanup",
            "how": "Delete Script Instance",
            "effect": "Deleting the TSL instance removes the visual markers (circles/dims) but keeps the generated beams as permanent elements (unless 'eraseInstance' logic removes them during cleanup)."
          }
        ]
      },
      "tokens_used": 11092,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# CheckBeamSpacing.mcr\n\n## Overview\nThis script automatically checks the spacing between vertical studs or rafters in wall and roof elements. It highlights spacing violations using visual markers and colors, and can optionally insert additional beams to ensure the structure meets maximum spacing requirements.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used for checking element geometry and inserting new beams. |\n| Paper Space | No | Not intended for layout views or annotations. |\n| Shop Drawing | No | Does not generate shop drawing details. |\n\n## Prerequisites\n- **Required Entities**: At least one `ElementWallSF` (Wall) or `ElementRoof` containing vertical beams.\n- **Minimum Beam Count**: Requires at least two vertical beams to calculate the distance between them.\n- **Required Settings**: None required for basic functionality, though default properties should be reviewed for specific building codes.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `CheckBeamSpacing.mcr`.\n\n### Step 2: Configuration (If not using Catalog)\n```\nCommand Line: [Dialog appears if no catalog key is found]\nAction: Configure the maximum spacing, choose whether to add beams automatically, and set visual warning colors. Click OK to proceed.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on the Wall or Roof elements you wish to check. Press Enter to confirm selection.\n```\n\n### Step 4: Review Results\nThe script will process the selected elements.\n- **Spacing OK**: If no issues are found, the script instance may erase itself automatically.\n- **Spacing Issue**: Beams violating the spacing rule will change color. If enabled, circles and dimensions will appear at the violation locations. If \"Automatic add beams\" is enabled, new beams will be inserted into the element.\n\n## Properties Panel Parameters\n\n### General\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Sequence number | number | 0 | Determines the order in which this script runs relative to other TSLs during generation. |\n| Filter beams with beamcode | text | (Empty) | Enter beam codes (e.g., \"Rim\", \"Post\") to exclude specific beams from the spacing check. |\n\n### Dimensions\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Maximum allowed spacing | number | 0 | The maximum distance allowed between beams. Set to 0 to use the spacing defined in the Element's properties. |\n| Automatic add beams | dropdown | No | Strategy for fixing spacing violations: \"No\", \"From left\", \"In center\", or \"From right\". |\n| Show circle | dropdown | No | If \"Yes\", draws a circle at locations where spacing exceeds the maximum. |\n\n### Color\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Color of the wrong beam | number | 1 | The color index used to highlight existing beams that are too far apart. |\n| Color of the added beam | number | 3 | The color index used for beams automatically created by this script. |\n| Color of the circle | number | 1 | The color index for the circle visual marker. |\n\n### New beam properties\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Color | number | 1 | The permanent color assigned to newly added beams. |\n| Beam name | text | (Empty) | The name assigned to newly added beams (e.g., \"AddedStud\"). |\n| Beam type | dropdown | Stud | Classifies the new beam as \"Stud\" or \"Beam\". |\n| Beam material | text | (Empty) | The material code assigned to newly added beams. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No specific context menu items are added by this script. Use the Properties Palette (OPM) to modify settings. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external XML settings files; it uses script properties and/or Catalog entries.\n\n## Tips\n- **Using Defaults**: Keep `Maximum allowed spacing` set to `0` to automatically respect the spacing settings already defined in your Wall or Roof element properties.\n- **Ignoring Openings**: Use the `Filter beams with beamcode` property to exclude trimmers or headers around windows/doors so they don't trigger spacing errors for the rest of the wall.\n- **Visual Checks**: Enable `Show circle` temporarily to quickly identify problem areas in a large model without modifying the geometry (ensure `Automatic add beams` is set to \"No\").\n\n## FAQ\n- **Q: The script disappeared after I ran it. Did it fail?**\n  - A: No. If the script finds no spacing violations (or adds beams and fixes them), it automatically erases its own instance to keep the drawing clean. Check if new beams were added or if your spacing is actually correct.\n  \n- **Q: How do I remove the red circles and dimensions?**\n  - A: Delete the TSL instance from the element, or set the `Show circle` property to \"No\" and update the script.\n\n- **Q: Can I add beams in the middle of a wide bay automatically?**\n  - A: Yes. Set `Automatic add beams` to \"In center\". The script will calculate the required number of beams and place them in the center of the gap."
      },
      "tokens_used": 7742,
      "error": null
    }
  }
}