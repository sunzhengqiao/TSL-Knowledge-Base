{
  "filename": "hsbBrick-CourseDistribution.mcr",
  "status": "completed",
  "total_tokens": 47400,
  "processing_time": 220.53763437271118,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9023,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Uses _kModelSpace in tslNew.dbCreate calls. No sd_ or Multipage prefixes detected. No #Type E + _Entity[] pattern found. Logic manipulates ElementWall objects and generates TSL instances in ModelSpace."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "hsbTSL\\Settings\\hsbBrickFamilyDefinitions.xml"
          ]
        }
      },
      "tokens_used": 5332,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Insertion (if no execute key is provided)",
            "title": null,
            "dataSource": "Internal Properties (Family, Zone, Joints)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFamily",
            "type": "PropString",
            "displayName": "|Family|",
            "defaultValue": "First in list",
            "inputType": "dropdown",
            "options": "Populated from 'hsbBrickFamilyDefinitions.xml'",
            "category": "|General|",
            "description": "|Defines the Family|"
          },
          {
            "index": 0,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "|Zone|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              -5,
              -4,
              -3,
              -2,
              -1,
              0,
              1,
              2,
              3,
              4,
              5
            ],
            "category": "|General|",
            "description": "|Defines the zone of the brick laying|"
          },
          {
            "index": 0,
            "variable": "dCourseJointMin",
            "type": "PropDouble",
            "displayName": "|Minimum|",
            "defaultValue": 9.0,
            "inputType": "number",
            "options": [],
            "category": "|Mortar Course Joint|",
            "description": "|Defines the minmal course joint|"
          },
          {
            "index": 1,
            "variable": "dCourseJointMax",
            "type": "PropDouble",
            "displayName": "|Maximum|",
            "defaultValue": 15.0,
            "inputType": "number",
            "options": [],
            "category": "|Mortar Course Joint|",
            "description": "|Defines the maximal course joint|"
          },
          {
            "index": 2,
            "variable": "dCourseJointProp",
            "type": "PropDouble",
            "displayName": "|calculated|",
            "defaultValue": 0.0,
            "inputType": "number",
            "options": [],
            "category": "|Mortar Course Joint|",
            "description": "|The calculated course joint|"
          },
          {
            "index": 3,
            "variable": "dButtJointMin",
            "type": "PropDouble",
            "displayName": "|Minimum| ",
            "defaultValue": 9.0,
            "inputType": "number",
            "options": [],
            "category": "|Mortar Butt Joint|",
            "description": "|Defines the minmal course joint|"
          },
          {
            "index": 4,
            "variable": "dButtJointMax",
            "type": "PropDouble",
            "displayName": "|Maximum| ",
            "defaultValue": 15.0,
            "inputType": "number",
            "options": [],
            "category": "|Mortar Butt Joint|",
            "description": "|Defines the maximal course joint|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|RecalcKey|",
            "handler": "|RecalcKey|",
            "action": "Executed via command line (hsb_RecalcTslWithKey)",
            "alsoTriggeredBy": "TslDoubleClick"
          }
        ],
        "settingsFiles": [
          {
            "filename": "hsbBrickFamilyDefinitions.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings"
            ],
            "purpose": "Provides Brick Family definitions (dimensions, color) and General DimStyle/TextHeight settings",
            "required": false
          }
        ]
      },
      "tokens_used": 7459,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates the vertical distribution of brick courses (brick height and mortar joints) on selected walls and spawns horizontal distribution sub-scripts.",
          "category": "Cladding/Facade",
          "typicalUseCase": "Used when planning masonry facades to determine the exact vertical mortar joint thickness required to make brick courses fit specific wall heights, ensuring architectural alignment."
        },
        "parameters": [
          {
            "name": "sFamily",
            "technicalDefault": "First in list (from XML)",
            "businessMeaning": "Selects the specific brick type (e.g., M50, M60) which defines the physical dimensions, specifically the brick height, used for the vertical layout calculation.",
            "validRange": "Defined in 'hsbBrickFamilyDefinitions.xml'",
            "unit": "Catalog Selection",
            "affectsOutput": "Changes the brick height reference, which alters the calculated course joint size and triggers regeneration of child scripts."
          },
          {
            "name": "nZone",
            "technicalDefault": "0",
            "businessMeaning": "Defines the vertical alignment zone or building level for the brickwork, used to coordinate the starting course height across different floors or wall segments.",
            "validRange": "-5 to 5",
            "unit": "Index/Count",
            "affectsOutput": "Offsets the vertical reference point to ensure coursing aligns correctly across different storeys or sections of the building."
          },
          {
            "name": "dCourseJointMin",
            "technicalDefault": "9.0",
            "businessMeaning": "The minimum allowable thickness of the mortar bed between horizontal rows (courses) of bricks.",
            "validRange": "5.0 - 20.0",
            "unit": "mm",
            "affectsOutput": "Constraints the calculation: if the wall height requires a smaller joint than this to fit an integer number of bricks, the script will typically cut the last brick or alert the user."
          },
          {
            "name": "dCourseJointMax",
            "technicalDefault": "15.0",
            "businessMeaning": "The maximum allowable thickness of the mortar bed between horizontal rows (courses) of bricks.",
            "validRange": "10.0 - 30.0",
            "unit": "mm",
            "affectsOutput": "Constraints the calculation: if the wall height requires a larger joint than this to fit an integer number of bricks, the script will adjust the joint size or cut the last brick."
          },
          {
            "name": "dCourseJointProp",
            "technicalDefault": "0.0",
            "businessMeaning": "The actual calculated thickness of the vertical mortar joint derived from the wall height, brick height, and min/max constraints.",
            "validRange": "dCourseJointMin to dCourseJointMax",
            "unit": "mm",
            "affectsOutput": "This read-only value is passed to the horizontal distribution scripts to ensure the vertical layout is respected when generating individual brick geometries."
          },
          {
            "name": "dButtJointMin",
            "technicalDefault": "9.0",
            "businessMeaning": "The minimum allowable width of the vertical mortar joint between the ends of bricks (head joints). This setting is passed down to horizontal distribution scripts.",
            "validRange": "5.0 - 20.0",
            "unit": "mm",
            "affectsOutput": "Defines constraints for the child script (hsbBrick-BrickDistributionExterior/Interior) which calculates the brick lengths in a row."
          },
          {
            "name": "dButtJointMax",
            "technicalDefault": "15.0",
            "businessMeaning": "The maximum allowable width of the vertical mortar joint between the ends of bricks (head joints). This setting is passed down to horizontal distribution scripts.",
            "validRange": "10.0 - 30.0",
            "unit": "mm",
            "affectsOutput": "Defines constraints for the child script (hsbBrick-BrickDistributionExterior/Interior) which calculates the brick lengths in a row."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFamily Change",
            "effect": "Updates the brick height reference, causing a recalculation of dCourseJointProp.",
            "cascade": [
              "dCourseJointProp"
            ]
          },
          {
            "trigger": "dCourseJointMin / dCourseJointMax Change",
            "effect": "Re-evaluates the wall height vs. brick height to determine a new valid dCourseJointProp.",
            "cascade": [
              "dCourseJointProp"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInst",
            "description": "hsbBrick-BrickDistributionExterior or hsbBrick-BrickDistributionInterior instances.",
            "appliedTo": "Selected Wall Elements (ElementWall)"
          },
          {
            "type": "VisualAid",
            "description": "Preview graphics indicating the reference point and opening snap regions.",
            "appliedTo": "ModelSpace (Transient)"
          },
          {
            "type": "MapXData",
            "description": "hsbBrickData SubMap containing calculated joint sizes and reference points.",
            "appliedTo": "Script Instance"
          }
        ]
      },
      "tokens_used": 9083,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization",
          "Load Settings: Check for 'hsbBrickFamilyDefinitions' MapObject",
          "[Conditional] Load Settings: If MapObject missing, read XML or create Default",
          "Property Definitions (Family, Zone, Joints)",
          "Insertion Sequence (_bOnInsert): Check for Execute Key",
          "[Conditional] Input: If no key, show Dynamic Dialog; else load from Catalog",
          "Input Prompt: PrEntity for ElementWall selection",
          "Geometric Calculation: Determine Wall Height (Min Z to Max Z)",
          "Calculation: Retrieve Brick Height from selected Family",
          "Calculation: Compute Course Joint (dCourseJointProp) based on Wall Height / (Brick + Joint)",
          "[Conditional] Validation: Check if joint is within Min/Max bounds",
          "Calculation: Determine Reference Point (Building Origin - Min X/Y)",
          "Publication: Write XData 'hsbBrickData' (Joint sizes, RefPoint)",
          "Visuals: Draw Reference Point Circle and Opening Snap lines",
          "[Conditional] Sub-TSL Generation (_bOnDbCreated): Branch based on Exterior/Interior status",
          "Script Completion"
        ],
        "conditionalBranches": [
          {
            "condition": "Settings Availability",
            "path1": {
              "name": "MapObject Exists",
              "steps": [
                "Read existing 'hsbBrickFamilyDefinitions' MapObject"
              ]
            },
            "path2": {
              "name": "MapObject Missing",
              "steps": [
                "Attempt read from 'hsbBrickFamilyDefinitions.xml'",
                "If XML missing, create default Family M50 (188x88x48)",
                "Create new MapObject and XML"
              ]
            }
          },
          {
            "condition": "Insertion Method (_kExecuteKey)",
            "path1": {
              "name": "Command Line / Key Insert",
              "steps": [
                "Check if Key matches catalog entry",
                "Silently load properties from Catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Standard Insert",
              "steps": [
                "Execute ShowDynamicDialog",
                "User selects Family, Zone, Joint settings",
                "User clicks OK"
              ]
            }
          },
          {
            "condition": "Joint Calculation Validity",
            "path1": {
              "name": "Valid Joint Found",
              "steps": [
                "Calculated dCourseJointProp is between Min and Max",
                "Apply calculated joint"
              ]
            },
            "path2": {
              "name": "Impossible Fit",
              "steps": [
                "Wall height prevents valid joint within Min/Max",
                "Set dCourseJointProp to Minimum (dCourseJointMin)",
                "Accept that last brick will be cut"
              ]
            }
          },
          {
            "condition": "Wall Type / Sub-TSL Generation",
            "path1": {
              "name": "Exterior Walls",
              "steps": [
                "Group walls by Planes (Normal Z + Elevation)",
                "Create one 'hsbBrick-BrickDistributionExterior' TSL per Plane",
                "Pass all walls in that plane to the single TSL"
              ]
            },
            "path2": {
              "name": "Interior Walls",
              "steps": [
                "Iterate through each selected wall individually",
                "Create one 'hsbBrick-BrickDistributionInterior' TSL per Wall",
                "Pass current wall + all other walls (for intersections) to the TSL"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection",
            "errorMessage": "Implicitly enforced by PrEntity.go()",
            "recovery": "User must select at least one ElementWall to proceed."
          },
          {
            "check": "Course Joint Range",
            "errorMessage": "None explicit (script auto-adjusts)",
            "recovery": "If strict adherence is required, user must adjust Wall Height or Brick Family. Script defaults to Min Joint + Cut Brick."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Brick Layout Parameters",
            "how": "OPM Properties (Family, Zone, Min/Max Joints)",
            "effect": "Triggers recalculation of vertical distribution (dCourseJointProp) and updates XData."
          },
          {
            "action": "Adjust Reference Origin",
            "how": "Grip Edit (_PtG[1])",
            "effect": "Moves the calculated 'ptRefBuilding' without needing to move the actual walls. Updates XData."
          },
          {
            "action": "Regenerate Distribution",
            "how": "Context Menu -> RecalcKey",
            "effect": "Re-runs the calculation logic (useful if wall geometry changed but script didn't auto-update)."
          },
          {
            "action": "Add/Remove Walls",
            "how": "TSL Instance Selection / Link Editor",
            "effect": "Updates _Element array, triggers recalculation of Reference Point and potentially creates/destroys sub-TSLs."
          }
        ]
      },
      "tokens_used": 10483,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbBrick-CourseDistribution\n\n## Overview\nThis script calculates the vertical distribution of brick courses on selected walls. It determines the optimal mortar joint thickness required to fit whole bricks (or cut bricks) within the wall height and generates sub-scripts to handle the horizontal layout.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script runs in the 3D model. |\n| Paper Space | No | Not applicable for layouts. |\n| Shop Drawing | No | Not applicable for manufacturing views. |\n\n## Prerequisites\n- **Required Entities**: At least one `ElementWall` (Wall).\n- **Minimum Beams**: 0\n- **Required Settings**: `hsbBrickFamilyDefinitions.xml` (If missing, the script creates a default family).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT` â†’ Select `hsbBrick-CourseDistribution.mcr`\n\n### Step 2: Select Walls\n```\nCommand Line: Select element(s)\nAction: Click on the Wall(s) you wish to apply brick coursing to and press Enter.\n```\n\n### Step 3: Configure Settings (Optional)\n*If you insert the script via a catalog entry with a predefined key, this step is skipped.*\n\nA dialog may appear prompting you to define:\n- **Family**: The brick type (e.g., M50).\n- **Zone**: The vertical alignment zone.\n\nClick **OK** to confirm.\n\n### Step 4: Verify Calculation\nAfter insertion, the script automatically calculates the `Course Joint` thickness. You can view this result in the Properties Palette.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Family | dropdown | First in list | Selects the brick type (dimensions loaded from XML). Changing this updates the brick height used for calculations. |\n| Zone | dropdown | 0 | Defines the vertical alignment zone (-5 to 5). Use this to coordinate coursing across different building storeys. |\n| Minimum | number | 9.0 mm | The minimum allowable thickness for the horizontal mortar joint. |\n| Maximum | number | 15.0 mm | The maximum allowable thickness for the horizontal mortar joint. |\n| calculated | number | 0.0 mm | **(Read-Only)** The actual calculated joint thickness derived from the wall height and brick size. |\n| Minimum (Butt) | number | 9.0 mm | The minimum allowable width for the vertical mortar joint (passed to sub-scripts). |\n| Maximum (Butt) | number | 15.0 mm | The maximum allowable width for the vertical mortar joint (passed to sub-scripts). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| RecalcKey | Recalculates the brick distribution and joint sizes. Useful if wall geometry has changed manually. |\n\n## Settings Files\n- **Filename**: `hsbBrickFamilyDefinitions.xml`\n- **Location**: `Company\\TSL\\Settings` or `Install\\TSL\\Settings`\n- **Purpose**: Defines brick dimensions (height/width/length) and visual settings (color/DimStyle). If this file is missing, the script creates a default \"M50\" brick (188x88x48).\n\n## Tips\n- **Adjusting Joints**: If the calculated joint (displayed as \"calculated\" in properties) is outside your Min/Max range, the script defaults to the Minimum value and cuts the last brick to fit the wall height.\n- **Reference Origin**: The script calculates a reference point based on the selected walls. You can grip-edit this point (usually visible as a circle or grip near the origin) to shift the entire vertical alignment without moving the walls.\n- **Sub-Scripts**: This script acts as a manager. It automatically spawns `hsbBrick-BrickDistributionExterior` or `hsbBrick-BrickDistributionInterior` instances to handle the actual brick generation.\n\n## FAQ\n- **Q: The calculated joint shows 0.0, what is wrong?**\n  A: Ensure you have selected a valid **Family** in the properties palette that contains a height definition. Also, ensure the selected Wall has a valid height.\n- **Q: Can I force the brick to start at a specific height?**\n  A: Yes, adjust the **Zone** parameter or use the grip edit on the script's reference point to shift the vertical alignment.\n- **Q: What happens if my wall is too short for a full brick?**\n  A: The script will calculate the joint size. If that size is smaller than your defined Minimum, it will use the Minimum joint size and the brick in that course will be cut (ripped) to fit."
      },
      "tokens_used": 6020,
      "error": null
    }
  }
}