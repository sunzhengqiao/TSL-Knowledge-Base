{
  "filename": "hsbBlocking.mcr",
  "status": "completed",
  "total_tokens": 52076,
  "processing_time": 207.8546166419983,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9273,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script creates 3D geometry (Body/Prism) using bmBlock.createPrism(), assigns elements to groups using assignToGroups(), and adds physical tooling to beams using BeamCut and addTool(). No usage of #Type E, sd_ prefix, or _Viewport objects. Logic targets construction entities (GenBeam, ElementWall)."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "ElementWall"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space",
          "requiredSettings": [
            "SFSettings.xml (referenced via _kPathHsbWallDetail and MapObject 'hsbStickframe')"
          ]
        }
      },
      "tokens_used": 7100,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getGenBeam",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getGenBeam",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": [
            {
              "prompt": "could not be found. Do you want to erase the existing custom settings? NOTE: This can change the existing model!",
              "options": [
                "No",
                "Yes"
              ]
            }
          ]
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dThickness",
            "type": "PropDouble",
            "displayName": "A - Thickness",
            "defaultValue": "U(32)",
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the thickness ogf the blocking"
          },
          {
            "index": 1,
            "variable": "dHeight",
            "type": "PropDouble",
            "displayName": "B - Height",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the height of the raw blocking board, that will be cut to the required size 0 = Automatic"
          },
          {
            "index": 2,
            "variable": "dGapTop",
            "type": "PropDouble",
            "displayName": "C - Top",
            "defaultValue": "U(1)",
            "inputType": "number",
            "options": [],
            "category": "Roofplane offsets",
            "description": "Defines the perpendicular offset to the roofplane"
          },
          {
            "index": 3,
            "variable": "dGapBottom",
            "type": "PropDouble",
            "displayName": "D - Bottom",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Roofplane offsets",
            "description": "Defines the perpendicular offset to the bottom face of the rafter (Only if reference object is a wall)"
          },
          {
            "index": 4,
            "variable": "sReferenceBottom",
            "type": "PropString",
            "displayName": "E - Bottom offset reference",
            "defaultValue": "Outside edge of wall",
            "inputType": "dropdown",
            "options": [
              "Outside edge of wall",
              "Outside edge of blocking beam"
            ],
            "category": "Roofplane offsets",
            "description": "Defines if the bottom offset refers to the wall's outside edge or to the blocking beam's bottom edge"
          },
          {
            "index": 5,
            "variable": "sKerve",
            "type": "PropString",
            "displayName": "Kerve",
            "defaultValue": "Disabled",
            "inputType": "dropdown",
            "options": [
              "Disabled",
              "Outer Zone",
              "Inner Zone",
              "-5",
              "-4",
              "-3",
              "-2",
              "-1",
              "0",
              "1",
              "2",
              "3",
              "4",
              "5"
            ],
            "category": "Element",
            "description": "Defines the Kerve"
          },
          {
            "index": 6,
            "variable": "dGapX",
            "type": "PropDouble",
            "displayName": "Gap X",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the GapX"
          },
          {
            "index": 7,
            "variable": "dGapY",
            "type": "PropDouble",
            "displayName": "Gap Y",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the GapY"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Load Settings",
            "handler": "Load Settings",
            "action": "Loads custom settings from SFSettings.xml into the MapObject",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Write Settings",
            "handler": "Write Settings",
            "action": "Writes current custom settings to the MapObject (referenced as trigger variable)",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "SFSettings.xml",
            "searchPaths": [
              "_kPathHsbWallDetail"
            ],
            "purpose": "Stores and retrieves custom settings for this script and other TSLs via the MapObject 'hsbStickframe'",
            "required": false
          }
        ]
      },
      "tokens_used": 7812,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates blocking boards (stiffeners/filling pieces) between rafters and reference objects (walls or plates) to support roof sheathing or stabilize the structure. It can also generate 'Kerve' (notches) in rafters to accommodate wall zones.",
          "category": "Framing/Structural",
          "typicalUseCase": "Adding nailing supports for roof boarding at eaves or ensuring rafter spacing stability where they meet a wall or top plate."
        },
        "parameters": [
          {
            "name": "dThickness",
            "technicalDefault": "U(32)",
            "businessMeaning": "The width of the blocking board (usually the dimension perpendicular to the wall face or along the rafter run).",
            "validRange": "22mm - 100mm",
            "unit": "mm",
            "affectsOutput": "Defines the width (X or Y dimension depending on orientation) of the generated blocking prism."
          },
          {
            "name": "dHeight",
            "technicalDefault": "0",
            "businessMeaning": "The height of the raw material used for blocking. A value of 0 automatically calculates the exact height required to fit the gap. Any other value simulates cutting a standard sized board to fit.",
            "validRange": "0 (Auto) or standard lumber heights (45, 70, 97, 120mm, etc.)",
            "unit": "mm",
            "affectsOutput": "Determines the vertical size (Z dimension) of the blocking. If non-zero, it implies the blocking is cut to size; if zero, it fits exactly."
          },
          {
            "name": "dGapTop",
            "technicalDefault": "U(1)",
            "businessMeaning": "The clearance distance between the top of the blocking and the roof plane (or bottom of rafter top surface). Useful for avoiding clashes with insulation or sheathing.",
            "validRange": "0mm - 20mm",
            "unit": "mm",
            "affectsOutput": "Moves the top surface of the blocking downward away from the roof plane."
          },
          {
            "name": "dGapBottom",
            "technicalDefault": "0",
            "businessMeaning": "The vertical offset from the bottom reference. It allows the blocking to hang below the top plate or sit flush, depending on the reference.",
            "validRange": "-50mm - 50mm",
            "unit": "mm",
            "affectsOutput": "Adjusts the vertical position of the blocking relative to the wall top plate or rafter bottom."
          },
          {
            "name": "sReferenceBottom",
            "technicalDefault": "Outside edge of wall",
            "businessMeaning": "Defines the anchor point for the bottom offset. Whether the gap is measured from the top edge of the wall plate or from the theoretical bottom edge of the blocking beam itself.",
            "validRange": "List: Outside edge of wall, Outside edge of blocking beam",
            "unit": "Enumeration",
            "affectsOutput": "Changes the calculation origin for the vertical position of the blocking."
          },
          {
            "name": "sKerve",
            "technicalDefault": "Disabled",
            "businessMeaning": "Specifies a 'Kerve' (notch/groove) mode to cut into the rafter. This allows the rafter to slot into specific wall zones (e.g., for insulation integration or structural seating).",
            "validRange": "Disabled, Outer Zone, Inner Zone, -5 to 5",
            "unit": "Zone Index",
            "affectsOutput": "If not Disabled, creates a rectangular BeamCut (notch) in the selected rafter. If Disabled, removes the instance."
          },
          {
            "name": "dGapX",
            "technicalDefault": "U(0)",
            "businessMeaning": "Fine-tuning adjustment for the Kerve notch position along the depth of the wall (perpendicular to the wall surface).",
            "validRange": "-20mm - 20mm",
            "unit": "mm",
            "affectsOutput": "Shifts the Kerve notch location in/out relative to the wall envelope."
          },
          {
            "name": "dGapY",
            "technicalDefault": "U(0)",
            "businessMeaning": "Fine-tuning adjustment for the Kerve notch position vertically.",
            "validRange": "-20mm - 20mm",
            "unit": "mm",
            "affectsOutput": "Shifts the Kerve notch location up/down relative to the calculated zone."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sKerve is set to 'Disabled'",
            "effect": "The TSL instance erases itself from the model as it has no function in Kerve mode if disabled.",
            "cascade": [
              "All parameters"
            ]
          },
          {
            "trigger": "sReferenceBottom changes",
            "effect": "Changes the geometric origin used to calculate the 'dGapBottom' offset.",
            "cascade": [
              "dGapBottom"
            ]
          },
          {
            "trigger": "nMode (Script Mode)",
            "effect": "Switches between Distribution (creating the blocking body) and Kerve (creating tooling on the rafter). Parameters like dGapX and dGapY are only relevant in Kerve mode.",
            "cascade": [
              "sKerve",
              "dGapX",
              "dGapY"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam (Blocking)",
            "description": "A 3D solid body representing the timber blocking/stiffener inserted between the rafter and the wall/plate.",
            "appliedTo": "New entity created at the intersection of the reference plane and the rafter."
          },
          {
            "type": "BeamCut (Kerve)",
            "description": "A rectangular machining operation (notch) cut into the rafter to accept the blocking or wall zone.",
            "appliedTo": "The selected Rafter (GenBeam)."
          }
        ]
      },
      "tokens_used": 10084,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched via command or auto-recalc",
          "Check for MapObject 'hsbStickframe' (SFSettings) validity or 'Load Settings' trigger",
          "If valid MapObject or 'Load Settings' triggered: Read 'SFSettings.xml' from '_kPathHsbWallDetail'",
          "If file found: Update MapObject; if file not found: Prompt user to erase existing MapObject (Yes/No)",
          "Retrieve script-specific settings from the MapObject for 'hsbBlocking'",
          "Read 'nMode' from _Map (0=Distribution, 1=Tooling, 2=Kerve)",
          "Branch based on 'nMode'",
          "[Branch Distribution (nMode=0)]: Define OPM properties (Thickness, Height, Top/Bottom Gaps, etc.)",
          "[Branch Distribution (nMode=0)]: Validate Insert Mode (_bOnInsert)",
          "[Branch Distribution (nMode=0)]: Prompt user for 1st GenBeam (Wall/Plate/Rafter)",
          "[Branch Distribution (nMode=0)]: Prompt user for 2nd GenBeam (Rafter/Plate)",
          "[Branch Distribution (nMode=0)]: Calculate geometry and insert Blocking body",
          "[Branch Distribution (nMode=0)]: If Kerve enabled in Distribution, generate tooling on rafter",
          "[Branch Tooling (nMode=1)]: Set OPM Key to 'Blocking-Tooling' and expose Tooling properties",
          "[Branch Tooling (nMode=1)]: Validate inputs (Reference Entity and Target Beam)",
          "[Branch Tooling (nMode=1)]: Calculate and apply BeamCut tooling to target beam",
          "[Branch Kerve (nMode=2)]: Validate inputs (ElementWall and 2 Beams)",
          "[Branch Kerve (nMode=2)]: Set OPM Key to 'Kerve' and expose Kerve properties",
          "[Branch Kerve (nMode=2)]: If 'Kerve' prop != 'Disabled': Calculate zone and apply BeamCut",
          "[Branch Kerve (nMode=2)]: If 'Kerve' prop == 'Disabled': Erase Instance",
          "Assign generated elements to groups",
          "Finish execution"
        ],
        "conditionalBranches": [
          {
            "condition": "nMode (Script Mode) selection",
            "path1": {
              "name": "Distribution Mode (nMode=0)",
              "steps": [
                "Define Geometry/Plane Offset OPM props",
                "Select Reference Beam (Wall/Plate/Rafter)",
                "Select Rafter Beam",
                "Create Blocking Body (Prism)",
                "Optionally add Kerve tooling if 'bKerve' was previously true"
              ]
            },
            "path2": {
              "name": "Tooling Mode (nMode=1)",
              "steps": [
                "Define Tooling OPM props (Offset, Depth, Width)",
                "Verify Reference Entity (ElementWall/GenBeam) and Target Beam exist",
                "Calculate Tooling Geometry based on Gap/Offset settings",
                "Apply BeamCut to Target Beam"
              ]
            },
            "path3": {
              "name": "Kerve Mode (nMode=2)",
              "steps": [
                "Verify ElementWall and 2 Beams exist (1 Rafter, 1 Blocking)",
                "Define Kerve OPM props (Zone, GapX, GapY)",
                "Check if 'Kerve' prop == 'Disabled'",
                "If Disabled: Erase Instance. Else: Calculate Zone profile and apply BeamCut to Rafter"
              ]
            }
          },
          {
            "condition": "SFSettings.xml availability on Load",
            "path1": {
              "name": "File Found",
              "steps": [
                "Load XML into mapSettings",
                "Update/Create MapObject 'hsbStickframe'"
              ]
            },
            "path2": {
              "name": "File Not Found",
              "steps": [
                "Prompt user: 'Do you want to erase the existing custom settings?'",
                "If Yes: dbErase() MapObject",
                "If No: Keep existing state, Report error message"
              ]
            }
          },
          {
            "condition": "Kerve Property Value (in nMode=2)",
            "path1": {
              "name": "Disabled",
              "steps": [
                "eraseInstance()",
                "return"
              ]
            },
            "path2": {
              "name": "Outer/Inner Zone or Number",
              "steps": [
                "Determine valid Zone (-5 to 5)",
                "Clamp selection to valid Zone range if necessary",
                "Calculate BeamCut profile",
                "bm0.addTool()"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "SFSettings.xml found when loading settings",
            "errorMessage": "[Path] could not be found.",
            "recovery": "User chooses to erase existing MapObject settings or keeps them without update."
          },
          {
            "check": "Entity Reference valid (Tooling/Kerve modes)",
            "errorMessage": "No ElementWall found",
            "recovery": "Script erases instance (eraseInstance) and halts."
          },
          {
            "check": "Beam Reference valid (Tooling/Kerve modes)",
            "errorMessage": "No sparren beam found",
            "recovery": "Script erases instance (eraseInstance) and halts."
          },
          {
            "check": "Kerve Profile Intersection",
            "errorMessage": "None (Silent fail visual)",
            "recovery": "If BeamCut area <= 0, tooling is skipped, but a small visual debug line is drawn."
          },
          {
            "check": "Zone Index bounds (Kerve mode)",
            "errorMessage": "None (Automatic correction)",
            "recovery": "Script automatically clamps user-selected Zone index to the minimum or maximum valid zone found in the ElementWall."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Geometry/Dimensions",
            "how": "OPM (Properties Palette)",
            "effect": "Updates Blocking size (Thickness/Height) and position (Top/Bottom Gaps). Triggers regeneration of the Body/Prism."
          },
          {
            "action": "Change Kerve/Tooling Settings",
            "how": "OPM",
            "effect": "Updates the BeamCut position, size, or depth on the rafter."
          },
          {
            "action": "Disable Kerve",
            "how": "OPM (Set 'Kerve' to 'Disabled')",
            "effect": "Script instance erases itself from the model."
          },
          {
            "action": "Load/Write Settings",
            "how": "Context Menu (Right-click)",
            "effect": "Loads global SFSettings.xml into the instance or writes current instance props to the global map."
          }
        ]
      },
      "tokens_used": 10842,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbBlocking.mcr\n\n## Overview\nThis script creates timber blocking boards (stiffeners) between rafters and structural elements like walls or top plates. It supports roof sheathing, stabilizes rafter spacing, and can optionally generate \"Kerve\" (notches) in rafters to accommodate specific wall zones.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script creates 3D geometry (GenBeam/Prism) and applies tooling. |\n| Paper Space | No | Not designed for 2D layout or detailing views. |\n| Shop Drawing | No | This is a model generation script, not a drawing annotation tool. |\n\n## Prerequisites\n- **Required Entities**: At least two beams (e.g., a Wall/Top Plate and a Rafter).\n- **Minimum Beam Count**: 2\n- **Required Settings Files**:\n    - `SFSettings.xml` (Optional): Used for storing and loading custom presets via the context menu.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Select `hsbBlocking.mcr` from the list.\n\n### Step 2: Select Reference Beam\n```\nCommand Line: Select GenBeam (Wall/Plate/Rafter)\nAction: Click on the first beam (usually the wall, top plate, or reference element).\n```\n\n### Step 3: Select Rafter Beam\n```\nCommand Line: Select GenBeam (Rafter/Plate)\nAction: Click on the rafter or secondary beam where the blocking will be applied.\n```\n\n*Once selected, the script will calculate and insert the blocking based on default properties.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Geometry** | | | |\n| A - Thickness | Number | `32 mm` | Defines the thickness (width) of the blocking board. |\n| B - Height | Number | `0` (Auto) | Defines the height of the raw blocking board. Set to `0` to automatically calculate the exact height required to fit the gap. |\n| **Roofplane offsets** | | | |\n| C - Top | Number | `1 mm` | Defines the perpendicular offset (gap) between the top of the blocking and the roof plane. |\n| D - Bottom | Number | `0 mm` | Defines the offset from the bottom reference. Use to raise or lower the blocking relative to the wall plate. |\n| E - Bottom offset reference | Dropdown | Outside edge of wall | Determines if the bottom offset is measured from the wall's outside edge or the blocking beam's bottom edge. |\n| **Element** | | | |\n| Kerve | Dropdown | `Disabled` | Defines the \"Kerve\" (notch) mode. Options include Disabled, Outer Zone, Inner Zone, or specific zone numbers (-5 to 5). **Note:** If set to \"Disabled\", the script instance will erase itself. |\n| **General** | | | |\n| Gap X | Number | `0 mm` | Fine-tunes the Kerve notch position along the depth of the wall (perpendicular to the wall surface). |\n| Gap Y | Number | `0 mm` | Fine-tunes the Kerve notch position vertically. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Load Settings** | Loads custom settings from the `SFSettings.xml` file into the current instance. If the file is not found, it prompts to erase existing custom settings. |\n| **Write Settings** | Saves the current property settings of the script to the `SFSettings.xml` file for future use. |\n\n## Settings Files\n\n- **Filename**: `SFSettings.xml`\n- **Location`: `_kPathHsbWallDetail` (Company or hsbCAD install path).\n- **Purpose**: Stores and retrieves custom parameter configurations (like thickness, gaps, and Kerve settings) shared between this script and other compatible TSLs (via the MapObject 'hsbStickframe').\n\n## Tips\n- **Automatic Sizing**: Leave **B - Height** set to `0` to let the script automatically calculate the exact height needed to fill the gap between the roof plane and the wall/plate.\n- **Avoiding Clashes**: Use the **C - Top** and **D - Bottom** offsets to create clearance for insulation layers or roof sheathing.\n- **Kerve Warning**: Be careful when setting the **Kerve** property to \"Disabled\". This will cause the script instance to delete itself from the model.\n- **Fine-Tuning**: Use **Gap X** and **Gap Y** to micro-adjust the position of the Kerve notch if the automatic zoning does not align perfectly with your wall details.\n\n## FAQ\n\n- **Q: Why did my blocking disappear when I changed a property?**\n  - **A**: You likely set the **Kerve** property to \"Disabled\". In this script's logic, disabling the Kerve function removes the instance. Change it back to a zone or numeric value before inserting, or re-insert the script.\n\n- **Q: How do I make the blocking fit perfectly between the wall and the rafter?**\n  - **A**: Ensure **B - Height** is set to `0` (Automatic). The script will then measure the distance and cut the blocking to the exact size required.\n\n- **Q: Can I save my specific gap settings for future projects?**\n  - **A**: Yes. Adjust your parameters in the Properties Palette, right-click the script instance, and select **Write Settings**. You can then load these settings later using **Load Settings**."
      },
      "tokens_used": 6965,
      "error": null
    }
  }
}