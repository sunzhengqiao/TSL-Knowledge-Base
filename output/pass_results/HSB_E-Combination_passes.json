{
  "filename": "HSB_E-Combination.mcr",
  "status": "completed",
  "total_tokens": 49018,
  "processing_time": 741.935585975647,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6794,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to select ElementRoof objects, creates new ElementRoof instances using dbCreate(), and performs 3D geometric calculations (PlaneProfile, CoordSys, PLine). It assigns the instance to an ElementGroup. There is no usage of _Viewport, sd_ prefixes, or drawing generation logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementRoof"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 6858,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select one or two elements|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select a position to visualize the combination|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "_bOnInsert",
            "title": null,
            "dataSource": "TSL Properties (showDialog())",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "seperator01",
            "type": "PropString",
            "displayName": "|Combination|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "combinationType",
            "type": "PropString",
            "displayName": "     |Combination type|",
            "defaultValue": "|Length combination|",
            "inputType": "dropdown",
            "options": [
              "|Length combination|",
              "|Width combination|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "gapBetweenElements",
            "type": "PropDouble",
            "displayName": "     |Gap between elements|",
            "defaultValue": "U(40)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "optimizedWidth",
            "type": "PropDouble",
            "displayName": "     |Optimized width|",
            "defaultValue": "U(1020)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "|Optimize the width of the combination to the specified width|.|Zero means that the real width is taken|."
          },
          {
            "index": 3,
            "variable": "extraWidth",
            "type": "PropDouble",
            "displayName": "     |Extra width|",
            "defaultValue": "U(2)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dMaxLength",
            "type": "PropDouble",
            "displayName": "     Maximum length",
            "defaultValue": "U(8000)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "dRoundTo",
            "type": "PropDouble",
            "displayName": "     |Round length to|",
            "defaultValue": "U(250)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "seperator02",
            "type": "PropString",
            "displayName": "|Dimension|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dimensionStyle",
            "type": "PropString",
            "displayName": "     |Dimension style|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "offsetDimensionLine",
            "type": "PropDouble",
            "displayName": "     |Offset dimension lines|",
            "defaultValue": "U(200)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "seperator03",
            "type": "PropString",
            "displayName": "|Visualization|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sShowOutline",
            "type": "PropString",
            "displayName": "     |Show outline|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "sLineTypeBack",
            "type": "PropString",
            "displayName": "     |Linetype back|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "_LineTypes"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7884,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Combines two selected roof elements into a single production or transport unit, calculating optimal dimensions and creating a new ElementRoof to represent the assembly.",
          "category": "Production Planning / Logistics",
          "typicalUseCase": "When two roof panels need to be produced or transported as a single unit (e.g., splicing short elements or joining halves of a gable), this script visualizes the combined footprint and generates the aggregated element data."
        },
        "parameters": [
          {
            "name": "combinationType",
            "technicalDefault": "\"|Length combination|\"",
            "businessMeaning": "Defines the orientation of the join. 'Length' places elements end-to-end (splicing along the ridge/beam), while 'Width' places them side-by-side (joining across the slope).",
            "validRange": "Length combination, Width combination",
            "unit": "enum",
            "affectsOutput": "Determines the coordinate system rotation and alignment direction of the second element relative to the first."
          },
          {
            "name": "gapBetweenElements",
            "technicalDefault": "U(40)",
            "businessMeaning": "The physical space left between the two elements in the combination. Used to account for connection details, lifting straps, or assembly tolerances.",
            "validRange": "0 - 200 mm",
            "unit": "mm",
            "affectsOutput": "Offsets the second element from the first, increasing the total combined length or width."
          },
          {
            "name": "optimizedWidth",
            "technicalDefault": "U(1020)",
            "businessMeaning": "Forces the combined element to a specific manufacturing width. A value of zero uses the exact sum of the selected elements. Useful for standardizing stock widths.",
            "validRange": "0 (auto) - 5000 mm",
            "unit": "mm",
            "affectsOutput": "Overrides the calculated width of the new ElementRoof; if non-zero, creates a rectangular boundary of this width."
          },
          {
            "name": "extraWidth",
            "technicalDefault": "U(2)",
            "businessMeaning": "An additional allowance added to the total calculated width (after optimization). Covers overhangs, sheathing extension, or machining margins.",
            "validRange": "0 - 100 mm",
            "unit": "mm",
            "affectsOutput": "Increases the final width dimension of the combination."
          },
          {
            "name": "dMaxLength",
            "technicalDefault": "U(8000)",
            "businessMeaning": "The maximum allowed length of the combined element. Acts as a constraint for transport limits (e.g., truck trailer length) or factory handling capabilities.",
            "validRange": "2000 - 20000 mm",
            "unit": "mm",
            "affectsOutput": "Used to validate or split the combination; ensures the generated element does not exceed logistical limits."
          },
          {
            "name": "dRoundTo",
            "technicalDefault": "U(250)",
            "businessMeaning": "The modular increment to which the combined length is rounded. Ensures the final length fits standard planning grids (e.g., 125mm, 250mm).",
            "validRange": "1 - 1000 mm",
            "unit": "mm",
            "affectsOutput": "Rounds the calculated length of the combination element to the nearest multiple."
          },
          {
            "name": "dimensionStyle",
            "technicalDefault": "null",
            "businessMeaning": "Selects the CAD drafting standard (text size, arrowheads) for the labels drawn in the visualization.",
            "validRange": "Project Dimension Styles",
            "unit": "string",
            "affectsOutput": "Controls the visual appearance of generated dimensions in the model."
          },
          {
            "name": "offsetDimensionLine",
            "technicalDefault": "U(200)",
            "businessMeaning": "The distance between the combined element outline and the dimension lines.",
            "validRange": "50 - 1000 mm",
            "unit": "mm",
            "affectsOutput": "Visually spaces the dimensions away from the geometry for clarity."
          },
          {
            "name": "sShowOutline",
            "technicalDefault": "\"|Yes|\"",
            "businessMeaning": "Toggles the visualization mode between a simplified 2D outline (from a linked script) or the full 3D geometric bodies of the roof elements.",
            "validRange": "Yes, No",
            "unit": "enum",
            "affectsOutput": "Switches drawing logic between displaying PLine outlines or GenBeam solid bodies."
          },
          {
            "name": "sLineTypeBack",
            "technicalDefault": "null",
            "businessMeaning": "Defines the linetype for the 'back' side or hidden edges of the element outline visualization.",
            "validRange": "Project Line Types",
            "unit": "string",
            "affectsOutput": "Changes the line style (e.g., dashed, hidden) for the back face of the element."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "changing combinationType",
            "effect": "Alters the axis of alignment and rotation calculations for the second element.",
            "cascade": [
              "visualization geometry",
              "total length calculation"
            ]
          },
          {
            "trigger": "setting optimizedWidth > 0",
            "effect": "Overrides the automatic width calculation derived from the input elements.",
            "cascade": [
              "combinationElement width",
              "extraWidth"
            ]
          },
          {
            "trigger": "changing dRoundTo",
            "effect": "Modifies the final length dimension of the combination.",
            "cascade": [
              "length",
              "dimension text"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElementRoof",
            "description": "A new roof element created in a specific '-CMB' group representing the combined footprint and properties of the original two elements.",
            "appliedTo": "Model Space (New Group)"
          },
          {
            "type": "Map Data",
            "description": "Stores the relative coordinates (PtOrg, VecX, Y, Z) of the original elements within the new combination element for downstream processing.",
            "appliedTo": "Script Instance Map"
          },
          {
            "type": "Dimension",
            "description": "Visual dimensions indicating the total width and length of the combination.",
            "appliedTo": "Visualization Display"
          }
        ]
      },
      "tokens_used": 9888,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch Script",
          "Show Dynamic Dialog (Properties Palette)",
          "Prompt User to Select 1 or 2 Elements (PrEntity)",
          "[Validation] Check Selection Count",
          "[Validation] Check Element FloorGroup Membership",
          "[Validation] Check for Existing Combinations on Selected Elements",
          "Prompt User to Select Visualization Position (getPoint)",
          "End Insertion Process",
          "[Recalculation] Verify Element Validity (Count & Group)",
          "[Recalculation] Extract Geometric Profiles (Outlines) from Elements",
          "Calculate Combination Geometry (Nested Loop for Rotations: 0°, 180°)",
          "Calculate Total Length & Width (including Gap and Extra Width)",
          "Apply Optimization Rules (Max Length, Rounding, Fixed Width)",
          "Generate Visuals (2D Outline or 3D GenBeams) based on Settings",
          "Create/Update Combination Element in '-CMB' Group",
          "Draw Dimensions and Store Data in Map"
        ],
        "conditionalBranches": [
          {
            "condition": "User inserts script (_bOnInsert)",
            "path1": {
              "name": "Normal Insertion",
              "steps": [
                "Show Dialog",
                "Select Elements",
                "Select Position",
                "Store Elements in _Element array",
                "Return (Exit Insert Mode)"
              ]
            },
            "path2": {
              "name": "Post-Insertion Recalculation",
              "steps": [
                "Read stored Elements",
                "Re-run logic without prompts",
                "Update visualization"
              ]
            }
          },
          {
            "condition": "Selection Count",
            "path1": {
              "name": "1 Element Selected",
              "steps": [
                "Extract Profile",
                "(Code indicates optimization block exists but logic seems truncated/skipped in favor of the 2-element block)"
              ]
            },
            "path2": {
              "name": "2 Elements Selected",
              "steps": [
                "Extract Profiles for Both",
                "Calculate Combination Vectors",
                "Loop through Rotations (0/180)",
                "Optimize Dimensions",
                "Create Result"
              ]
            },
            "path3": {
              "name": "Invalid Count (>2)",
              "steps": [
                "Report Warning",
                "Erase Instance"
              ]
            }
          },
          {
            "condition": "Combination Type Property",
            "path1": {
              "name": "Length Combination (Default)",
              "steps": [
                "Use Standard X/Y Alignment",
                "Rotate candidates: 0°, 180°"
              ]
            },
            "path2": {
              "name": "Width Combination",
              "steps": [
                "Rotate CoordSys 90° (-Y, X)",
                "Rotate candidates: 0°"
              ]
            }
          },
          {
            "condition": "Visualization Setting (sShowOutline)",
            "path1": {
              "name": "Show Outline (Yes)",
              "steps": [
                "Look for 'UN-ElementOutline' TSL on element",
                "If found: Draw Front/Back PLines with specific styles",
                "If not found: Draw raw profile PLine"
              ]
            },
            "path2": {
              "name": "Show 3D Bodies (No)",
              "steps": [
                "Iterate GenBeams of elements",
                "Draw RealBody transformed to visualization position"
              ]
            }
          },
          {
            "condition": "Existence of Combination Element",
            "path1": {
              "name": "First Run",
              "steps": [
                "dbCreate new ElementRoof",
                "Assign to specific '-CMB' group"
              ]
            },
            "path2": {
              "name": "Update Run",
              "steps": [
                "Retrieve Element from Map",
                "Update visualization properties"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Number of selected elements > 2",
            "errorMessage": "More than two elements selected. The tsl will be erased.",
            "recovery": "Undo and restart script, selecting only 1 or 2 elements."
          },
          {
            "check": "Elements not in same FloorGroup",
            "errorMessage": "The selected elements are not part of the same floorgroup!",
            "recovery": "Ensure selected elements belong to the same floor/group structure."
          },
          {
            "check": "Element already part of a combination (has HSB_E-Combination attached)",
            "errorMessage": "Element [Number] is already part of a combination.",
            "recovery": "Remove the existing combination script from the element or select a different element."
          },
          {
            "check": "Element has invalid outline (no rings)",
            "errorMessage": "Element [Number] has an invalid outline.",
            "recovery": "Check element geometry validity in source."
          },
          {
            "check": "Recalculation with invalid stored element count (0 or >2)",
            "errorMessage": "Invalid number of elements selected!",
            "recovery": "The instance will be erased; user must re-insert."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Combination Parameters",
            "how": "OPM Properties Palette (Double-click script instance)",
            "effect": "Triggers recalculation. Changes gap, width, rounding, or visualization style immediately updates the geometry and dimensions."
          },
          {
            "action": "Move Visualization",
            "how": "Grip Edit (Move script instance)",
            "effect": "Updates _Pt0, moving the entire visualization and combination element reference point."
          },
          {
            "action": "Change Context Menu / Right Click",
            "how": "addRecalcTrigger (Implicit in TSL structure)",
            "effect": "Standard 'Recalc' forces re-evaluation of Element outlines and map data."
          }
        ]
      },
      "tokens_used": 10181,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-Combination.mcr\n\n## Overview\nThis script combines selected roof elements into a single production or transport unit. It calculates optimal dimensions (including gaps and rounding) and visualizes the combined assembly to verify fit and logistics.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be inserted in 3D Model Space. |\n| Paper Space | No | Not applicable for drawing generation. |\n| Shop Drawing | No | This is a planning/modeling tool. |\n\n## Prerequisites\n- **Required Entities**: 1 or 2 `ElementRoof` objects.\n- **Minimum Count**: 1 Element (Optimized for 2).\n- **Requirements**: Selected elements must belong to the same **FloorGroup**.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `HSB_E-Combination.mcr` from the file dialog.\n\n### Step 2: Select Elements\n```\nCommand Line: Select one or two elements\nAction: Click on the first roof element, then optionally click on a second roof element. Press Enter to confirm selection.\n```\n*Note: The script will verify that the selected elements are on the same floor.*\n\n### Step 3: Position Visualization\n```\nCommand Line: Select a position to visualize the combination\nAction: Click anywhere in the empty Model Space to place the visualization marker.\n```\n\n## Properties Panel Parameters\nDouble-click the script instance in the model to open the Properties Palette and modify parameters.\n\n### Combination\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Combination type | Dropdown | Length combination | Choose to join elements end-to-end (Length) or side-by-side (Width). |\n| Gap between elements | Number | 40 mm | Physical space allowed between elements for connections or lifting. |\n| Optimized width | Number | 1020 mm | Target width for the combined unit (0 = use actual calculated width). |\n| Extra width | Number | 2 mm | Additional margin added to the total width. |\n\n### Dimension\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Maximum length | Number | 8000 mm | Maximum allowable length for the combination (transport limit). |\n| Round length to | Number | 250 mm | Rounds the total length to the nearest increment (e.g., modular planning). |\n| Dimension style | Dropdown | *Project Default* | Selects the drafting style for dimension labels. |\n| Offset dimension lines | Number | 200 mm | Distance between the geometry and the dimension lines. |\n\n### Visualization\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Show outline | Dropdown | Yes | **Yes**: Shows a 2D outline. **No**: Shows the full 3D solid bodies. |\n| Linetype back | Dropdown | *Project Default* | Line style used for hidden/back edges of the outline. |\n\n## Right-Click Menu Options\nThe script uses standard TSL context options:\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the geometry based on changes to the source elements or properties. |\n| Erase | Removes the script instance from the model. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external XML settings files. It uses standard AutoCAD Dimension Styles and Line Types.\n\n## Tips\n- **Validation**: If you see an error \"Elements are not part of the same floorgroup\", check your Project Manager to ensure both elements are assigned to the same floor/group.\n- **Existing Combinations**: You cannot combine an element that is already part of another combination. You must remove the existing script instance first.\n- **3D Verification**: Change `Show outline` to **No** if you want to see exactly how the 3D bodies (beams/plates) fit together in the combined layout.\n- **Updating**: If you modify the original roof elements, select the combination script instance and right-click **Recalculate** to update the dimensions.\n\n## FAQ\n- **Q: Can I combine more than two elements?**\n  A: No, this script is designed to combine a maximum of two elements at a time.\n- **Q: What does the \"Optimized width\" do?**\n  A: If set to a value greater than 0, it forces the combined unit to be a perfect rectangle of that width, ignoring the actual width of the source elements. This is useful for standardizing production sizes.\n- **Q: Why did the script disappear after insertion?**\n  A: This usually happens if you selected more than 2 elements, or if the selected elements were invalid (e.g., had no geometry outline). Check the command line history for specific error messages."
      },
      "tokens_used": 7413,
      "error": null
    }
  }
}