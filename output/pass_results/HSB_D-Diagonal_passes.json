{
  "filename": "HSB_D-Diagonal.mcr",
  "status": "completed",
  "total_tokens": 57235,
  "processing_time": 234.25419926643372,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 5,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "05.02.2013",
            "author": "AS",
            "changes": "Pilot version"
          },
          {
            "version": "1.01",
            "date": "13.02.2013",
            "author": "AS",
            "changes": "Increase margin to 5 mm"
          },
          {
            "version": "1.02",
            "date": "18.02.2013",
            "author": "AS",
            "changes": "Make margin available as property."
          },
          {
            "version": "1.03",
            "date": "27.06.2018",
            "author": "DR",
            "changes": "Added use of HSB_G-FilterGenBeams.mcr"
          },
          {
            "version": "1.04",
            "date": "01-10.2018",
            "author": "DR",
            "changes": "Setting arPtDim length to zero when will show both: bottom-left and bottom-right"
          },
          {
            "version": "1.05",
            "date": "14-08.2020",
            "author": "RP",
            "changes": "Do not take dummy beams into account"
          },
          {
            "version": "1.06",
            "date": "16-06.2021",
            "author": "NG",
            "changes": "Corner offset of -1 will create a default result"
          },
          {
            "version": "1.07",
            "date": "17-06.2021",
            "author": "NG",
            "changes": "Adjusted assignment to top/ bottom points"
          },
          {
            "version": "1.08",
            "date": "04-08.2021",
            "author": "NG",
            "changes": "Bugfix check amount of points"
          },
          {
            "version": "1.09",
            "date": "26-08.2021",
            "author": "NG",
            "changes": "HSB-12980 Commit issue"
          }
        ],
        "settingsFiles": [],
        "dependencies": [
          "HSB_G-FilterGenBeams.mcr"
        ]
      },
      "tokens_used": 9143,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses getViewport() to capture user input and stores it in the _Viewport array. It defines a coordinate system transformation ms2ps (Model Space to Paper Space) and transforms geometry (ppArrowHead, ptDimTxt) before drawing. The comment 'dimstyle was adjusted for display in paper space' confirms the drawing context. The script draws dimensions and text overlays on the layout."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space (Layout) with an active Viewport containing a valid hsbCAD Element",
          "requiredSettings": [
            "HSB_G-FilterGenBeams.mcr"
          ]
        }
      },
      "tokens_used": 7763,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 10589,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"This script automatically creates diagonal dimension lines and arrows in Paper Space viewports to display the diagonal length of selected timber elements (e.g., walls or floor panels), ignoring minor manufacturing details at the corners.\",\n    \"category\": \"ShopDrawing\",\n    \"typicalUseCase\": \"A detailer needs to annotate the diagonal length of a gable wall or a rectangular floor deck on a production drawing to ensure fit or calculate bracing requirements.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"genBeamFilterDefinition\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Selects a predefined set of structural beams or sheets to include in the dimension calculation (e.g., only 'ExtWall' beams).\",\n      \"validRange\": \"Any valid HSB_G-FilterGenBeams catalog entry\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Determines which geometry forms the bounding box for the diagonal measurement.\"\n    },\n    {\n      \"name\": \"sFilterBC\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Filters elements based on their Beam Code (e.g., 'STU' for studs, 'PLT' for plates).\",\n      \"validRange\": \"Semicolon-separated list of beam codes\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Excludes beams not matching the specified codes from the diagonal calculation.\"\n    },\n    {\n      \"name\": \"sFilterLabel\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Filters elements based on their Material Label or name (e.g., 'C24', 'GL24h').\",\n      \"validRange\": \"Semicolon-separated list of material labels\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Excludes elements made of different materials from the calculation.\"\n    },\n    {\n      \"name\": \"sFilterZone\",\n      \"technicalDefault\": \"1;7\",\n      \"businessMeaning\": \"Filters elements by their construction Zone ID (e.g., specific floors or building sections).\",\n      \"validRange\": \"Semicolon-separated list of integers\",\n      \"unit\": \"Count\",\n      \"affectsOutput\": \"Only dimensions elements belonging to the specified zones.\"\n    },\n    {\n      \"name\": \"sDimensionMethod\",\n      \"technicalDefault\": \"As arrow\",\n      \"businessMeaning\": \"Determines the visual style of the diagonal indicator.\",\n      \"validRange\": \"As arrow / As dimensionline\",\n      \"unit\": \"Enum\",\n      \"affectsOutput\": \"Switches between drawing a graphical arrow/leader line and a standard CAD dimension line along the diagonal.\"\n    },\n    {\n      \"name\": \"dCornerMargin\",\n      \"technicalDefault\": \"25.0\",\n      \"businessMeaning\": \"Tolerance distance to treat multiple points at a corner as a single 'virtual' corner point. A value of -1 forces a calculation based on the midpoint of the element's height (useful for gables).\",\n      \"validRange\": \"-1 (Auto/Gable) to 100+ mm (depending on detail level)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Controls which points define the start and end of the diagonal. Small values use exact geometry; -1 uses the vertical midpoint to separate top/bottom points.\"\n    },\n    {\n      \"name\": \"sPosition\",\n      \"technicalDefault\": \"Automatic\",\n      \"businessMeaning\": \"Selects which diagonal(s) to display: Bottom-Left to Top-Right, Bottom-Right to Top-Left, or let the script decide based on wall angles.\",\n      \"validRange\": \"Automatic / From bottom-left / From bottom-right\",\n      \"unit\": \"Enum\",\n      \"affectsOutput\": \"Determines the placement and direction of the dimension line on the drawing.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"_DimStyles\",\n      \"businessMeaning\": \"Selects the specific CAD dimension style (text size, arrowheads) to use for the dimension.\",\n      \"validRange\": \"Any dimension style defined in the CAD template\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Visual appearance of the dimension text and ticks.\"\n    },\n    {\n      \"name\": \"nPrecision\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Sets the number of decimal places for the diagonal length text.\",\n      \"validRange\": \"0 to 3 (typically 0 or 1 for timber construction)\",\n      \"unit\": \"Count\",\n      \"affectsOutput\": \"Accuracy of the displayed measurement text.\"\n    },\n    {\n      \"name\": \"dArrowLength\",\n      \"technicalDefault\": \"300.0\",\n      \"businessMeaning\": \"The length of the arrow shaft or dimension line tail.\",\n      \"validRange\": \"100.0 to 1000.0 (scaled by viewport)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Visual size of the indicator on the drawing.\"\n    },\n    {\n      \"name\": \"dxOffsetTxt\",\n      \"technicalDefault\": \"50.0\",\n      \"businessMeaning\": \"Horizontal offset of the dimension text from the start point of the diagonal.\",\n      \"validRange\": \"0 to 200 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Position of the text label relative to the geometry.\"\n    },\n    {\n      \"name\": \"dyOffsetTxt\",\n      \"technicalDefault\": \"15.0\",\n      \"businessMeaning\": \"Vertical offset of the dimension text from the start point of the diagonal.\",\n      \"validRange\": \"0 to 100 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Position of the text label relative to the geometry.\"\n    },\n    {\n      \"name\": \"nDimColor\",\n      \"technicalDefault\": \"-1\",\n      \"businessMeaning\": \"Color index for the dimension line and text.\",\n      \"validRange\": \"0 to 255 (CAD color index), -1 for ByBlock\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Color of the dimension graphics.\"\n    },\n    {\n      \"name\": \"nArrowColor\",\n      \"technicalDefault\": \"3\",\n      \"businessMeaning\": \"Color index for the arrow head or graphical indicator.\",\n      \"validRange\": \"0 to 255 (CAD color index)\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Color of the arrow graphics.\"\n    },\n    {\n      \"name\": \"sShowScriptName\",\n      \"technicalDefault\": \"No\",\n      \"businessMeaning\": \"Toggles the visibility of the script name on the drawing (often used for QA or debugging).\",\n      \"validRange\": \"Yes / No\",\n      \"unit\": \"Enum\",\n      \"affectsOutput\": \"Draws or hides the text label 'HSB_D-Diagonal'.\"\n    },\n    {\n      \"name\": \"sAssignToLayer\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Specifies the CAD layer on which to draw the script name and dimensions.\",\n      \"validRange\": \"Any valid layer name\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Layer assignment of the generated entities.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sPosition is set to 'Automatic'\",\n      \"effect\": \"The script analyzes the corner angles of the selected element envelope. If the top-left is angled (e.g., a gable peak), it may switch to dimension the other diagonal (bottom-left to top-right) or show both if corners are complex.\",\n      \"cascade\": [\n        \"bDimBR2TL\",\n        \"bDimBL2TR\"\n      ]\n    },\n    {\n      \"trigger\": \"dCornerMargin is set to -1\",\n      \"effect\": \"The script ignores the specific corner geometry tolerance and instead calculates the vertical midpoint of the element to define 'Top' and 'Bottom' boundaries. This is essential for dimensioning non-rectangular shapes like gables.\",\n      \"cascade\": [\n        \"arPtTop\",\n        \"arPtBottom\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"Dimension Line / Arrow\",\n      \"description\": \"A graphical representation (either a leader arrow or a dimension line) drawn diagonally across the element envelope in Paper Space.\",\n      \"appliedTo\": \"Viewport (Paper Space)\"\n    },\n    {\n      \"type\": \"Text\",\n      \"description\": \"The calculated diagonal length string formatted according to the specified precision.\",\n     "
      },
      "tokens_used": 10169,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User launches script (Insert)",
          "2. Script checks insert cycle count (if >1, self-destructs)",
          "3. User selects a Viewport",
          "4. User selects a Position Point (origin for script)",
          "5. Properties Dialog is displayed (User can configure filters, style, margin)",
          "6. Script validates Viewport and retrieves underlying Element",
          "7. Script checks Global Filter Map for excluded Elements",
          "8. Script filters Beams within Element (by Code, Label, Zone, Dummy status)",
          "9. Script generates combined Brutto Profile from filtered beams",
          "10. Script identifies and groups Top and Bottom corner points",
          "11. Script determines which diagonal(s) to draw (Automatic or Fixed)",
          "12. Script draws Arrow or Dimension line in Paper Space",
          "13. Script draws optional Script Name text",
          "14. (If Debug Mode) Draws envelope and corner points"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle = 1 (Initial Insert)",
              "steps": [
                "Prompt for Viewport",
                "Prompt for Point",
                "Show Dialog"
              ]
            },
            "path2": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Exit"
              ]
            }
          },
          {
            "condition": "Element in Global Filter Map",
            "path1": {
              "name": "Element Filtered",
              "steps": [
                "Exit Calculation (Draw Nothing)"
              ]
            },
            "path2": {
              "name": "Element Not Filtered",
              "steps": [
                "Proceed to Geometry Collection"
              ]
            }
          },
          {
            "condition": "Corner Margin (dCornerMargin) Value",
            "path1": {
              "name": "Standard Mode (>= 0)",
              "steps": [
                "Identify Top Y points within margin distance of max Y",
                "Identify Bottom Y points within margin distance of min Y"
              ]
            },
            "path2": {
              "name": "Gable/Auto Mode (-1)",
              "steps": [
                "Calculate Midpoint Y of element envelope",
                "Split points strictly above/below Midpoint Y",
                "Balance Top/Bottom arrays if one side is empty"
              ]
            }
          },
          {
            "condition": "Number of Points found per side",
            "path1": {
              "name": "Valid Geometry (>= 2 points per side)",
              "steps": [
                "Calculate TL, TR, BL, BR coordinates",
                "Proceed to Dimension Logic"
              ]
            },
            "path2": {
              "name": "Insufficient Points",
              "steps": [
                "If Margin >= 0: Draw text 'Corner offset to small' at insertion point",
                "If Margin < 0: Report 'Unexpected error'",
                "Exit"
              ]
            }
          },
          {
            "condition": "Position Strategy (sPosition)",
            "path1": {
              "name": "Automatic",
              "steps": [
                "Check nArSquaredCorner flags",
                "If Bottom-Right & Top-Left are square: Draw BR->TL diagonal",
                "Else If Bottom-Left & Top-Right are square: Draw BL->TR diagonal",
                "Else (Complex/Unknown): Draw Both diagonals"
              ]
            },
            "path2": {
              "name": "From bottom-left",
              "steps": [
                "Draw BL->TR diagonal only"
              ]
            },
            "path3": {
              "name": "From bottom-right",
              "steps": [
                "Draw BR->TL diagonal only"
              ]
            }
          },
          {
            "condition": "Dimension Method (sDimensionMethod)",
            "path1": {
              "name": "As Arrow",
              "steps": [
                "Draw filled triangular arrow head",
                "Draw line tail",
                "Draw text label offset from line"
              ]
            },
            "path2": {
              "name": "As Dimensionline",
              "steps": [
                "Draw standard CAD Dimension line",
                "Draw text label offset from line"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script erases itself if no viewport is attached to instance."
          },
          {
            "check": "Element Validity",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script exits silently if vp.element() is invalid."
          },
          {
            "check": "Profile Point Count",
            "errorMessage": "Unexpected error. No points found",
            "recovery": "Ensure the selected Element contains valid beams that pass the filter criteria (not dummy, correct zone/code)."
          },
          {
            "check": "Corner Margin Grouping",
            "errorMessage": "Corner offset to small",
            "recovery": "Increase 'dCornerMargin' property value (current tolerance is too tight to find corner points), or set to -1 for automatic gable logic."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Geometry Filters",
            "how": "Properties Palette (OPM)",
            "effect": "Updates which beams define the diagonal calculation (real-time update if filters change)."
          },
          {
            "action": "Adjust Appearance",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Arrow Length, Text Position, Colors, Precision, and Dimension Style immediately."
          },
          {
            "action": "Filter Element Globally",
            "how": "Right-click Context Menu -> 'Filter this element'",
            "effect": "Adds current Element to a global map. This script instance will stop drawing dimension for this specific element until removed."
          },
          {
            "action": "Remove Element Filter",
            "how": "Right-click Context Menu -> 'Remove filter for this element'",
            "effect": "Removes current Element from global map. Script will resume drawing dimension."
          },
          {
            "action": "Clear All Filters",
            "how": "Right-click Context Menu -> 'Clear filter for all elements'",
            "effect": "Wipes the global filter map. All script instances on filtered elements will resume drawing."
          },
          {
            "action": "Move Script",
            "how": "Grip Edit / Move",
            "effect": "Updates the insertion point (_Pt0), which repositions the text label and the error message location (if applicable)."
          }
        ]
      },
      "tokens_used": 12015,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_D-Diagonal.mcr\n\n## Overview\nThis script automatically creates diagonal dimension lines and arrows in Paper Space viewports to display the diagonal length of selected timber elements (e.g., walls or floor panels), effectively ignoring minor manufacturing details at the corners.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | Reads geometry from Model Space via the Viewport. |\n| Paper Space | Yes | Draws dimensions and text on the Layout. |\n| Shop Drawing | No | Used for production layouts, not generating CAM data. |\n\n## Prerequisites\n- **Required Entities**: A Layout (Paper Space) with an active Viewport containing a valid hsbCAD Element.\n- **Minimum Beam Count**: 0 (The element must have geometry to measure, but specific beam count requirements vary by design).\n- **Required Settings**: Access to the `HSB_G-FilterGenBeams` catalog/map for filtering elements.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Select `HSB_D-Diagonal.mcr` from the file dialog.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select viewport\nAction: Click on the viewport in Paper Space that displays the timber element you wish to dimension.\n```\n\n### Step 3: Select Position\n```\nCommand Line: Select position\nAction: Click a point in Paper Space. This serves as the insertion point for the script instance (used primarily for positioning error messages if they occur).\n```\n\n### Step 4: Configure Properties\nAction: After insertion, the script properties appear in the AutoCAD Properties Palette (Ctrl+1). Adjust filters, style, and margins as needed. The dimension will update automatically.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Filter Definition** | String | (Empty) | Select a predefined filter set from the HSB_G-FilterGenBeams catalog to determine which beams to include. |\n| **Filter Beam Code** | String | (Empty) | Specify beam codes (e.g., \"STU;PLT\") to include only specific beam types. |\n| **Filter Label** | String | (Empty) | Filter elements by their material label (e.g., \"C24\"). |\n| **Filter Zone** | String | 1;7 | Filter elements by their construction Zone IDs. |\n| **Dimension Method** | Enum | As arrow | Choose between a graphical arrow/leader or a standard dimension line. |\n| **Corner Margin** | Double | 25.0 | Tolerance distance (mm) to treat points as a single corner. Set to **-1** to calculate based on vertical midpoint (Gable Mode). |\n| **Position** | Enum | Automatic | Selects which diagonal to draw: \"Automatic\", \"From bottom-left\", or \"From bottom-right\". |\n| **Dimension Style** | String | _DimStyles | Select the CAD Dimension Style to use for text and arrows. |\n| **Precision** | Int | 0 | Number of decimal places for the length text (e.g., 0 for 5000, 1 for 5000.0). |\n| **Arrow Length** | Double | 300.0 | Visual length of the arrow tail or dimension line extension. |\n| **Offset Text X** | Double | 50.0 | Horizontal offset of the dimension text relative to the line. |\n| **Offset Text Y** | Double | 15.0 | Vertical offset of the dimension text relative to the line. |\n| **Dim Color** | Int | -1 | Color index for the dimension line (-1 = ByBlock). |\n| **Arrow Color** | Int | 3 | Color index for the arrow head. |\n| **Show Script Name** | Enum | No | If \"Yes\", displays the script name \"HSB_D-Diagonal\" on the drawing. |\n| **Assign to Layer** | String | (Empty) | Specifies the CAD layer on which to draw the dimensions and text. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Filter this element** | Hides the diagonal dimension for the specific element selected in this instance. |\n| **Remove filter for this element** | Restores the diagonal dimension for this specific element. |\n| **Clear filter for all elements** | Clears all global filters, making dimensions visible for all filtered elements again. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams.mcr`\n- **Location**: Company or hsbCAD Install path (Catalog/Scripts)\n- **Purpose**: Provides pre-defined logical groups of beams (e.g., \"External Walls\") to automate the selection of geometry to dimension.\n\n## Tips\n- **Gable Walls**: If dimensioning a gable wall where the top corners are not the same height, set the **Corner Margin** property to `-1`. This activates \"Automatic Mode\" which calculates the vertical midpoint to correctly identify top and bottom points.\n- **Missing Dimensions**: If the text \"Corner offset to small\" appears, the **Corner Margin** value is too tight to detect the corners clearly. Increase the value slightly (e.g., from 5 to 20).\n- **Filtering**: Use the **Filter Zone** or **Filter Label** properties if the script is picking up beams you don't want to include in the measurement (like dummy beams or sheathing).\n\n## FAQ\n- **Q: Why do I see \"Unexpected error\" when I insert the script?**\n  A: This usually means the script could not find any valid points in the selected element after applying filters. Check if the Viewport contains a valid Element and that your Beam Code/Label filters aren't excluding everything.\n  \n- **Q: Can I move the text after inserting?**\n  A: The text position is calculated automatically based on the geometry. You can adjust the **Offset Text X/Y** properties in the Properties Palette to shift it relative to the line. Moving the script insertion point (Grip Edit) moves the error message location.\n\n- **Q: How do I dimension the other diagonal?**\n  A: Change the **Position** property from \"Automatic\" to \"From bottom-left\" or \"From bottom-right\" to force a specific direction."
      },
      "tokens_used": 7556,
      "error": null
    }
  }
}