{
  "filename": "BatchShopdrawing.mcr",
  "status": "completed",
  "total_tokens": 49092,
  "processing_time": 248.0890486240387,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": null,\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"3.1\",\n      \"date\": \"03.12.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-23092 max bounding of border fixed\"\n    },\n    {\n      \"version\": \"3.0\",\n      \"date\": \"02.12.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-23092 mew property to enable optional selection of xref entities\"\n    },\n    {\n      \"version\": \"2.9\",\n      \"date\": \"12.11.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22965 plotviewport naming, new command to specidy rectangular border\"\n    },\n    {\n      \"version\": \"2.8\",\n      \"date\": \"17.06.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22271 bugfix header block creation on insert\"\n    },\n    {\n      \"version\": \"2.7\",\n      \"date\": \"17.06.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-22271 smoothening property published on insert\"\n    },\n    {\n      \"version\": \"2.6\",\n      \"date\": \"03.04.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20206 assemblyDefinition supported to create nested\"\n    },\n    {\n      \"version\": \"2.5\",\n      \"date\": \"02.04.2024\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20206 naming of the property of the header clarified\"\n    },\n    {\n      \"version\": \"2.4\",\n      \"date\": \"15.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 renesting of existing pages imrpoved, insert jig and margin grips added\"\n    },\n    {\n      \"version\": \"2.3\",\n      \"date\": \"15.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 bugfix color and margin on creation, smoothing improved\"\n    },\n    {\n      \"version\": \"2.2\",\n      \"date\": \"14.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 list token replaced to ?, simple shape recognition of schedule table added\"\n    },\n    {\n      \"version\": \"2.1\",\n      \"date\": \"14.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 purging redundant dimlines improved, new property and context command for smoothing of bounding border, placement left over pages added, new properties for margin and color\"\n    },\n    {\n      \"version\": \"2.0\",\n      \"date\": \"13.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 purges redundant dimlines on creation\"\n    },\n    {\n      \"version\": \"1.9\",\n      \"date\": \"13.11.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-20550 new subnesting and alignment\"\n    },\n    {\n      \"version\": \"1.8\",\n      \"date\": \"08.08.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-19707 instance will be purged after creation\"\n    },\n    {\n      \"version\": \"1.7\",\n      \"date\": \"09.05.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-18906 catching objectCollectionType on creation for hsbDesign25\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"03.05.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-18884 added support to purge existing plotviewports and blockrefs when running in redistribution mode, new options to toggle styles\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"19.04.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-18681 plotviewports and brefs appended, simple nesting respects bref outline, compatibel V25\"\n    },\n    {\n      \"version\": \"1.4\",\n      \"date\": \"18.04.2023\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-18681 plotviewports and brefs appended, simple nesting respects bref outline\"\n    },\n    {\n      \"version\": \"1.3\",\n      \"date\": \"10.03.2023\",\n"
      },
      "tokens_used": 9306,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": true,
          "detectionEvidence": "Explicit usage of _kModelSpace in dbCreate and collectEntities. Script operates on MultiPage and PlotViewport entities found in ModelSpace. No direct manipulation of Paper Space layout entities or sd_ prefixed ShopDrawing entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "MultiPage",
            "PlotViewport"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space with existing MultiPages or valid Element/GenBeam collections to generate them.",
          "requiredSettings": []
        }
      },
      "tokens_used": 6863,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": null,
            "variable": "color",
            "type": "PropInt",
            "displayName": "color",
            "defaultValue": null,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": null,
            "variable": "margin",
            "type": "PropDouble",
            "displayName": "margin",
            "defaultValue": null,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": null,
            "variable": "smoothing",
            "type": "PropDouble",
            "displayName": "smoothing",
            "defaultValue": null,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7459,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the batch layout and nesting of multiple shop drawings (MultiPages) onto master sheets or PlotViewports in Model Space, optimizing for paper usage.",
          "category": "ShopDrawing / Automation / Layout",
          "typicalUseCase": "Used to take many individual component or assembly drawings and arrange them efficiently onto large format sheets for printing or PDF export."
        },
        "parameters": [
          {
            "name": "color",
            "technicalDefault": "null",
            "businessMeaning": "Controls the visual color of the border polyline drawn around the nested drawings.",
            "validRange": "0 - 255 (AutoCAD Color Index)",
            "unit": "ACI",
            "affectsOutput": "Visual appearance of the layout borders in the CAD model. Does not affect geometry."
          },
          {
            "name": "margin",
            "technicalDefault": "null",
            "businessMeaning": "Defines the spacing buffer between nested shop drawings and the edge of the sheet.",
            "validRange": "0 - 50 mm",
            "unit": "mm",
            "affectsOutput": "Determines the packing density of drawings. Increasing the value increases the whitespace between drawings."
          },
          {
            "name": "smoothing",
            "technicalDefault": "null",
            "businessMeaning": "Sets the maximum length of small edges to be ignored or 'filled in' to simplify the bounding shape of the drawings.",
            "validRange": "0 - 1000 mm",
            "unit": "mm",
            "affectsOutput": "Modifies the calculated boundary profile of drawings. A larger value smooths out jagged edges, creating more rectangular bounding boxes."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "smoothing value increase",
            "effect": "Reduces the complexity of the calculated bounding shape, potentially making nesting less efficient but more geometrically regular.",
            "cascade": [
              "margin"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PlotViewport",
            "description": "Container entities created in Model Space that represent the layout sheets holding the nested drawings.",
            "appliedTo": "Model Space"
          },
          {
            "type": "TslInst",
            "description": "New script instances created to act as borders or containers for the nested subsets of MultiPages.",
            "appliedTo": "Groups of MultiPages"
          },
          {
            "type": "Polyline",
            "description": "Visual geometry representing the smoothed boundary of the drawing content.",
            "appliedTo": "Individual MultiPages"
          }
        ]
      },
      "tokens_used": 8206,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script invoked via command line or insertion.",
          "[Jig Phase] User selects insertion point or defines a rectangular boundary using dynamic visual feedback (JigInsert or JigRectangle).",
          "Script collects target entities (MultiPages, TslInsts, or Elements) in Model Space.",
          "Script iterates through collected entities to calculate their bounding profiles (PlaneProfiles).",
          "[Conditional] Smoothing: If 'smoothing' property > 0, the profile is modified to fill in notches/short edges.",
          "Script attempts to nest entities into the defined sheet boundary using a grid-based placement algorithm.",
          "Script checks for intersections between the candidate profile and already placed items.",
          "[Conditional] Placement:",
          "  - If placement is valid (no overlap/intersection): The entity is transformed to the new position.",
          "  - If placement fails (no space found): The entity is marked as a 'Left Over' and moved to a designated pile.",
          "Script aggregates successfully nested entities into groups and creates new TSL instances (borders) to wrap them.",
          "Script creates TSL instances for the 'Left Over' entities.",
          "Script assigns PlotViewport names and position numbers based on the defining entities.",
          "[Finalize] The 'Tool' instance is erased, leaving only the resulting layout and border instances."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode (Jig vs Calculation)",
            "path1": {
              "name": "Jig Mode",
              "steps": [
                "Check _bOnJig flag.",
                "If 'kJigInsert': Draw stored profile preview at cursor.",
                "If 'kJigRectangle': Draw dynamic rectangle between start point and cursor."
              ]
            },
            "path2": {
              "name": "Calculation Mode",
              "steps": [
                "Run nesting logic.",
                "Transform entities.",
                "Create result instances."
              ]
            }
          },
          {
            "condition": "Boundary Smoothing",
            "path1": {
              "name": "Smooth Enabled",
              "steps": [
                "Calculate profile segments.",
                "Identify segments shorter than 'smoothing' parameter.",
                "Fill notches using rectangular unions.",
                "Simplify profile."
              ]
            },
            "path2": {
              "name": "Smooth Disabled",
              "steps": [
                "Use exact raw profile of the entity.",
                "Proceed to nesting checks."
              ]
            }
          },
          {
            "condition": "Nesting Fit Check",
            "path1": {
              "name": "Fits",
              "steps": [
                "Transform entity to grid location.",
                "Add to placed list.",
                "Update available space profile."
              ]
            },
            "path2": {
              "name": "Does Not Fit",
              "steps": [
                "Increment grid position (X then Y).",
                "If grid exhausted, add to 'Left Overs' array."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Validity",
            "errorMessage": "Implicitly skips invalid entities during collection loop.",
            "recovery": "Script ignores the entity and processes the next one."
          },
          {
            "check": "Zero Area / Empty Page",
            "errorMessage": "Implicitly skips pages with zero area or zero length.",
            "recovery": "Entity is ignored, preventing division by zero or logic errors in nesting."
          },
          {
            "check": "Intersection Sliver Fix",
            "errorMessage": "Implicit handling of 'triangle shapes hit on one point' (Union failure).",
            "recovery": "Script detects minimal intersection areas and artificially adds a small rectangle to force a valid union, ensuring the nesting algorithm doesn't stall on floating-point errors."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Nesting Parameters",
            "how": "OPM (Object Properties Palette)",
            "effect": "Changing 'margin', 'color', or 'smoothing' on the created Border instances updates the visual representation or logic for subsequent recalculation."
          },
          {
            "action": "Adjust Geometry",
            "how": "Grip Edit",
            "effect": "Grips allow interactive adjustment of the boundary or margin (added in v2.4), triggering a recalculation of the nested layout."
          }
        ]
      },
      "tokens_used": 10766,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# BatchShopdrawing.mcr\n\n## Overview\nAutomates the batch layout and nesting of multiple shop drawings (MultiPages) onto master sheets or PlotViewports in Model Space. It optimizes paper usage by calculating efficient placement of drawings based on defined margins and boundary smoothing.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates entirely in Model Space to nest MultiPages and create PlotViewports. |\n| Paper Space | No | The output prepares drawings for plotting, but processing happens in Model Space. |\n| Shop Drawing | No | This is a utility script that acts *on* shop drawings (MultiPages), not within the SD environment itself. |\n\n## Prerequisites\n- **Required entities**: Existing `MultiPage` entities, `PlotViewports`, or valid `Element`/`GenBeam` collections in Model Space.\n- **Minimum beam count**: 0 (Script operates on drawing entities/containers).\n- **Required settings files**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `BatchShopdrawing.mcr`\n\n### Step 2: Define Sheet Boundary\n```\nCommand Line: Specify insertion point [or Rectangle]:\nAction: Click a point in Model Space to define the corner of your sheet (A0, A1, etc.), or drag to define a custom rectangular area.\n```\n\n### Step 3: Select Entities\n```\nCommand Line: Select entities:\nAction: Select the MultiPages, Elements, or GenBeams you wish to nest onto the defined sheet and press Enter.\n```\n\n### Step 4: Processing\n*   The script calculates the bounding profiles of the selected entities.\n*   It attempts to nest them efficiently within the boundary.\n*   Successfully nested items are grouped; items that do not fit are moved to a \"Left Over\" pile.\n\n### Step 5: Completion\nThe script instance erases itself, leaving behind the new layout borders (`TslInst`) and `PlotViewport` entities.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| color | PropInt | 7 (White/Black) | Sets the AutoCAD Color Index (ACI) for the border polyline drawn around the nested drawings. |\n| margin | PropDouble | 0 | Defines the clearance spacing (in mm) between nested drawings and the sheet edge. |\n| smoothing | PropDouble | 0 | Defines the maximum edge length (in mm) to be ignored when calculating the bounding shape. Higher values result in more rectangular (simplified) boundaries for better nesting. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *Update/Recalculate* | Triggers the nesting logic again to re-arrange drawings based on current property settings (e.g., if you changed the margin). |\n\n## Settings Files\n- **Filename**: None used.\n\n## Tips\n- **Smoothing**: If your drawings have complex, jagged edges (e.g., many small notches), increase the **smoothing** value. This simplifies the bounding box, allowing the script to pack items tighter without getting stuck on small geometric details.\n- **Left Overs**: If some drawings are moved to a \"Left Over\" pile, increase the size of your sheet boundary (via grips) or increase the margin spacing and recalculate.\n- **Grip Editing**: After creation, you can select the border instance and use the **blue grips** (added in v2.4) to visually adjust margins or the boundary size, which will automatically update the layout.\n- **Xref Support**: Use the specific properties (if configured) to enable selection of Xref entities if your drawings are referenced.\n\n## FAQ\n- **Q: Why are some of my drawings not nested?**\n  - A: They likely did not fit within the defined sheet boundary or margin constraints. Check for a cluster of \"Left Over\" drawings near your sheet. You can create a new sheet boundary for these leftovers.\n- **Q: How do I change the spacing between drawings?**\n  - A: Select the resulting border instance, open the Properties (Ctrl+1), and change the **margin** value. The script will automatically update the layout.\n- **Q: What does the smoothing property do?**\n  - A: It ignores small notches or edges smaller than the specified value. Use this to prevent the script from creating complex, interlocking shapes that are hard to nest, forcing them into simpler rectangular clusters."
      },
      "tokens_used": 6492,
      "error": null
    }
  }
}