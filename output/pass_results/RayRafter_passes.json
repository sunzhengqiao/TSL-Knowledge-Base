{
  "filename": "RayRafter.mcr",
  "status": "completed",
  "total_tokens": 33626,
  "processing_time": 270.57041215896606,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "27jan2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "HSB-6316 dialog image updated"
          },
          {
            "version": "1.0",
            "date": "08jan2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5296,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Entity collection using `Group().collectEntities(true, ERoofPlane(), _kModelSpace);`. The script uses `PrEntity` to prompt for `Beam` and `ERoofPlane` selection. It performs geometric transformations (`b.transformBy`, `b.addToolStatic`) on 3D bodies."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam",
            "ERoofPlane"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing Roofplanes and Rafters (Beams).",
          "requiredSettings": []
        }
      },
      "tokens_used": 4024,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select rafters|, |<Enter> to align first and last rafters by roofplane selection|",
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select roofplane(s)|",
              "condition": "_bOnInsert && (_Beam.length()<1)",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "On Insert",
            "title": null,
            "dataSource": "Internal Properties or Catalog Entry",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dAngle",
            "type": "PropDouble",
            "displayName": "|Angle|",
            "defaultValue": "22.5",
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the positive rotation angle.| |The sign of the angle will be calculated by the connecting hip or valley.|"
          },
          {
            "index": 0,
            "variable": "sName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Beam|",
            "description": "|Defines the Name|, |empty string means the name of the entity will not change|"
          },
          {
            "index": 1,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": "-1",
            "inputType": "number",
            "options": [],
            "category": "|Beam|",
            "description": "|Color '-1' will not change the color of the entity|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 4467,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Rotates rafters in plan view by a specified angle and automatically adjusts their vertical position and bottom cut to align with the roof surface.",
          "category": "Framing",
          "typicalUseCase": "Creating rotated jack rafters, fan rafters, or angled purlins where the member must maintain a specific plan angle relative to the roof structure while resting on the roof plane."
        },
        "parameters": [
          {
            "name": "dAngle",
            "technicalDefault": "22.5",
            "businessMeaning": "The magnitude of the rotation angle applied to the rafter in the horizontal plane (plan view). The script automatically determines the rotation direction (clockwise or counter-clockwise) based on the rafter's position relative to the roof hip or valley.",
            "validRange": "0.0 - 90.0",
            "unit": "degrees",
            "affectsOutput": "Changes the XY orientation of the rafter. Also influences the vertical translation and the location of the cut at the roof envelope."
          },
          {
            "name": "sName",
            "technicalDefault": "\"\"",
            "businessMeaning": "Defines a custom name for the processed rafters. Used for organization, filtering, and material listing.",
            "validRange": "Any text string (e.g., 'JackRafter', 'Rotated_22_5')",
            "unit": "text",
            "affectsOutput": "Sets the 'Name' attribute of the beam entity in the CAD database. An empty string leaves the name unchanged."
          },
          {
            "name": "nColor",
            "technicalDefault": "-1",
            "businessMeaning": "Controls the visual color of the rafter for differentiation in the model.",
            "validRange": "0-255 (AutoCAD Index Colors) or -1",
            "unit": "index",
            "affectsOutput": "Changes the display color of the beam. A value of -1 preserves the beam's original color."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Calculated Geometry (nSide)",
            "effect": "The sign of the dAngle parameter is multiplied by an internally calculated factor (nSide) based on the rafter's proximity to hip/valley geometry.",
            "cascade": [
              "dAngle"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam Transformation",
            "description": "The existing rafter beam is rotated around the vertical axis at the roof intersection point and shifted vertically to align with the roof plane height.",
            "appliedTo": "User-selected rafters or rafters detected from selected roof planes."
          },
          {
            "type": "Cut",
            "description": "A static cut is applied at the base of the rafter (at the roof envelope intersection) perpendicular to the roof plane normal.",
            "appliedTo": "The transformed rafter beams."
          }
        ]
      },
      "tokens_used": 7428,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script: Execution begins via command or catalog insertion.",
          "2. Cycle Check: Script verifies it is the first insertion cycle; otherwise, it erases itself.",
          "3. Catalog/Input Check: Checks if an execution key (_kExecuteKey) was passed.",
          "4. Load Properties: If a valid catalog key is found, properties are loaded; otherwise, the properties dialog is shown.",
          "5. Rafter Selection: User is prompted to select rafters (Beam entities).",
          "6. Roofplane Selection (Conditional): If no rafters were selected, user is prompted to select Roofplanes (ERoofPlane).",
          "7. Entity Collection (Roofplane Mode): If roofplanes are selected, the script identifies the first and last perpendicular beam from each plane and adds them to the processing list.",
          "8. Validation: Script checks if any beams are in the processing list.",
          "9. Error Termination: If the list is empty, an error message is displayed, and the instance is erased.",
          "10. Roofplane Linking: For each beam, the script searches the ModelSpace to find the associated Roofplane.",
          "11. Geometry Calculation: Calculates the rotation side (left/right) based on the roof envelope, the rotation base point, and the vertical offset.",
          "12. Transformation: Applies rotation (horizontal), translation (vertical), and applies a static cut at the base.",
          "13. Property Update: Applies the user-defined Color and Name to the beams.",
          "14. Visualization/Cleanup: If in Debug mode, shows preview; otherwise, erases the script instance, leaving only the modified beams."
        ],
        "conditionalBranches": [
          {
            "condition": "User Input Method (Beam vs Roofplane)",
            "path1": {
              "name": "Direct Beam Selection",
              "steps": [
                "User selects Beams at the 'Select rafters' prompt.",
                "Script processes these specific beams."
              ]
            },
            "path2": {
              "name": "Roofplane Inference",
              "steps": [
                "User presses Enter (or selects nothing) at the 'Select rafters' prompt.",
                "Script prompts 'Select roofplane(s)'.",
                "Script filters roofplane beams perpendicular to the X-axis.",
                "Script selects only the first and last beam from the sorted list."
              ]
            }
          },
          {
            "condition": "Catalog Execution Key",
            "path1": {
              "name": "Catalog Key Match",
              "steps": [
                "Script detects _kExecuteKey.",
                "Key matches a catalog entry name.",
                "Properties are loaded silently without showing the dialog."
              ]
            },
            "path2": {
              "name": "Manual Configuration",
              "steps": [
                "No key or invalid key provided.",
                "ShowDialog() is executed.",
                "User enters Angle, Name, and Color manually."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Beams Selected",
            "errorMessage": "RayRafter: no valid rafters selected.",
            "recovery": "User must re-run the script and select valid rafters or roofplanes containing rafters."
          },
          {
            "check": "Beam belongs to a Roofplane",
            "errorMessage": "[Implicit - No error shown]",
            "recovery": "The script silently skips any beam that is not found within a Roofplane's beam collection."
          },
          {
            "check": "Envelope Geometry Validity",
            "errorMessage": "[Implicit - No error shown]",
            "recovery": "If the calculated edge vector of the roof envelope is parallel to the roof axes (ambiguous rotation), the beam is skipped."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Parameter Modification",
            "how": "Re-run Script (Insertion)",
            "effect": "Since the script executes 'eraseInstance()' at the end, parameters cannot be changed via OPM (Object Properties Manager) after insertion. The user must undo or delete the modified beams and run the script again with new settings."
          },
          {
            "action": "Geometry Manipulation",
            "how": "Standard CAD Edit (Grips/Properties)",
            "effect": "The beams are standard GenBeam entities after processing. They can be moved, stretched, or cut using native hsbCAD/AutoCAD tools, but the relationship to the 'RayRafter' script is severed."
          }
        ]
      },
      "tokens_used": 7236,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# RayRafter.mcr\n\n## Overview\nRotates rafters in plan view by a specified angle and automatically adjusts their vertical position and bottom cut to align with the roof surface.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in the 3D model environment. |\n| Paper Space | No | Not supported for layout generation. |\n| Shop Drawing | No | Not a shop drawing generation script. |\n\n## Prerequisites\n- **Required Entities**: Beams (Rafters) and/or Roofplanes (`ERoofPlane`).\n- **Minimum Beam Count**: 1 (or Roofplanes containing rafters).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `RayRafter.mcr`\n\n### Step 2: Configure Properties\nA dialog will appear automatically upon insertion. Set the **Angle**, **Name**, and **Color** as desired. Click OK to proceed.\n\n### Step 3: Select Rafters or Roofplanes\n```\nCommand Line: Select rafters, <Enter> to align first and last rafters by roofplane selection\nAction: Select the specific rafter beams you wish to rotate.\n```\n\n**OR**\n\n```\nCommand Line: Select roofplane(s)\nAction: Press <Enter> without selecting beams. Then, select the Roofplane entities. The script will automatically process the first and last rafters perpendicular to the X-axis on the selected planes.\n```\n\n### Step 4: Processing\nThe script calculates the rotation direction based on the roof geometry (hip/valley), applies the rotation and vertical adjustment, adds the bottom cut, and then erases itself.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Angle | Number | 22.5 | Defines the positive rotation angle (magnitude). The script automatically calculates the direction (sign) based on the hip or valley connection. |\n| Name | Text | \"\" | Defines the Name for the processed rafters. An empty string means the name will not change. |\n| Color | Number | -1 | Sets the color of the beam. Enter -1 to keep the original beam color. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| N/A | This script erases itself after execution and does not retain context menu options. |\n\n## Settings Files\n- **Filename**: None detected.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Roofplane Shortcut**: If you need to rotate the outermost jack rafters on a roof, simply press Enter at the first prompt and select the Roofplane. The script automatically identifies the correct first and last rafters.\n- **Automatic Direction**: You do not need to worry about negative angles for the left side vs. the right side of the roof. The script detects the geometry and applies the rotation in the correct direction automatically.\n- **Visual Identification**: Use the **Color** property (e.g., set to Red) to visually distinguish the rotated rafters from standard structural members.\n\n## FAQ\n- **Q: Can I edit the angle after the script has run?**\n  - A: No. Once the script finishes, it erases itself from the drawing history. To change the angle, you must undo the command or delete the modified beams and run the script again.\n- **Q: Why did nothing happen when I ran the script?**\n  - A: Ensure the rafters you selected are associated with a valid Roofplane. The script silently skips any beams that do not belong to a Roofplane entity. Also, check the command line for the error \"RayRafter: no valid rafters selected.\"\n- **Q: Does this work on purlins?**\n  - A: The script is designed for rafters (Beams) within a Roofplane. It may work on other beams if they are part of a valid Roofplane collection, but it is intended for rafters."
      },
      "tokens_used": 5175,
      "error": null
    }
  }
}