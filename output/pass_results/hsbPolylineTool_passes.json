{
  "filename": "hsbPolylineTool.mcr",
  "status": "completed",
  "total_tokens": 51290,
  "processing_time": 190.0247449874878,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl creates beamcuts or freeprofiles on any genbeam. please note tool path limitations due to the used tool geometry",
        "versionHistory": [
          {
            "version": "1.3",
            "date": "24oct17",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "detection of closing points of free profile enhanced, this tool is no longer available for sheets"
          },
          {
            "version": "1.2",
            "date": "09jan17",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "tool type visualisation added"
          },
          {
            "version": "1.1",
            "date": "14dec16",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix fingermill"
          },
          {
            "version": "1.0",
            "date": "29july16",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9321,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit usage of _kModelSpace in dbCreate(). Logic focuses on generating 3D geometry (BeamCut, FreeProfile, SolidSubtract) on GenBeam/Sip objects. No usage of _Viewport, sd_ prefixes, or 2D drawing generation."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Sip"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7057,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select beam(s) or panel(s)|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select polyline(s) (<Enter> to pick points)|",
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "Pick start point",
              "condition": "_bOnInsert && No polyline selected in Step 2",
              "required": true
            },
            {
              "step": 4,
              "function": "PrPoint",
              "promptOriginal": "\n|Select next point|",
              "condition": "_bOnInsert && Point picking mode loop",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialog",
            "trigger": "Insertion (_bOnInsert)",
            "title": null,
            "dataSource": "Properties Palette",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|Reference Side|",
            "inputType": "dropdown",
            "options": [
              "|Reference Side|",
              "|Opposite Side|"
            ],
            "category": "|Alignment|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "|Side|",
            "defaultValue": "|Left|",
            "inputType": "dropdown",
            "options": [
              "|Left|",
              "|Center|",
              "|Right|"
            ],
            "category": "|Alignment|",
            "description": null
          },
          {
            "index": 0,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "|Depth|",
            "defaultValue": "20",
            "inputType": "number",
            "options": [],
            "category": "|Geometry|",
            "description": "|Defines the Depth|"
          },
          {
            "index": 1,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "|Width|",
            "defaultValue": "30",
            "inputType": "number",
            "options": [],
            "category": "|Geometry|",
            "description": "|Defines the Width|"
          },
          {
            "index": 2,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Beamcut|",
            "inputType": "dropdown",
            "options": [
              "|Beamcut|",
              "|Finger Mill|",
              "|Universal Mill|",
              "|Vertical|-|Finger Mill|"
            ],
            "category": "|Tooling|",
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Add entities|",
            "handler": "|Add entities|",
            "action": "Prompts user to select GenBeams to add to the list.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove entities|",
            "handler": "|Remove entities|",
            "action": "Prompts user to select GenBeams to remove from the list.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Flip Alignment|",
            "handler": "|Flip Alignment|",
            "action": "Toggles the Alignment property and flips the Side property.",
            "alsoTriggeredBy": "TslDoubleClick"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9394,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "This script applies complex tooling operations (Beamcuts, Finger Milling, Universal Milling) to timber beams or panels based on a selected polyline or user-defined path.",
          "category": "Machining/CNC",
          "typicalUseCase": "Creating custom routed slots, pockets, or finger joint profiles along a non-linear path on structural timber members."
        },
        "parameters": [
          {
            "name": "sAlignment",
            "technicalDefault": "|Reference Side|",
            "businessMeaning": "Determines which side of the selected polyline (Reference vs Opposite) serves as the anchor for the tool operation relative to the beam's coordinate system.",
            "validRange": "Reference Side, Opposite Side",
            "unit": "enum",
            "affectsOutput": "Flips the orientation of the tool path across the polyline's centerline, effectively mirroring the cut if used in conjunction with Side."
          },
          {
            "name": "sSide",
            "technicalDefault": "|Left|",
            "businessMeaning": "Specifies the lateral offset direction of the tool from the polyline path relative to the beam's width.",
            "validRange": "Left, Center, Right",
            "unit": "enum",
            "affectsOutput": "Shifts the tool geometry to the left, right, or centered directly on the drawn polyline."
          },
          {
            "name": "dDepth",
            "technicalDefault": 20,
            "businessMeaning": "The depth of the cut or the depth of the finger mill profile into the material.",
            "validRange": "1.0 to Material Height (mm)",
            "unit": "mm",
            "affectsOutput": "Controls how deep the tool penetrates the beam in the Z-direction of the tool's coordinate system."
          },
          {
            "name": "dWidth",
            "technicalDefault": 30,
            "businessMeaning": "The width of the tool cut or the diameter of the milling tool to be simulated.",
            "validRange": "Tool Diameter (typically 6mm to 50mm)",
            "unit": "mm",
            "affectsOutput": "Determines the lateral size of the material removed or the width of the finger joint profile."
          },
          {
            "name": "sTool",
            "technicalDefault": "|Beamcut|",
            "businessMeaning": "Selects the specific machining operation to apply to the beam.",
            "validRange": "|Beamcut|, |Finger Mill|, |Universal Mill|, |Vertical|-|Finger Mill|",
            "unit": "enum",
            "affectsOutput": "Switches the geometry generation between a standard rectangular subtraction (Beamcut) and complex freeform profiles (Finger/Universal Mill) suited for specific joinery."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sAlignment changes",
            "effect": "Automatically inverts the Side property to maintain the visual position relative to the beam.",
            "cascade": [
              "sSide"
            ]
          },
          {
            "trigger": "Context Menu 'Flip Alignment'",
            "effect": "Toggles sAlignment between Reference and Opposite and inverts sSide (Left becomes Right and vice versa).",
            "cascade": [
              "sAlignment",
              "sSide"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "BeamCut",
            "description": "A standard orthogonal subtraction operation, effectively a rectangular slot or notch.",
            "appliedTo": "Selected GenBeams and Sip elements."
          },
          {
            "type": "FreeProfile",
            "description": "A complex machining profile defined by the tool geometry (Finger Mill, Universal Mill) following the path of the polyline. Used for specialized joints like log cabin connections or timber framing joinery.",
            "appliedTo": "Selected GenBeams and Sip elements."
          },
          {
            "type": "SolidSubtract",
            "description": "A generic solid body subtraction used when complex boolean operations are required beyond standard BeamCut definitions.",
            "appliedTo": "Selected GenBeams and Sip elements."
          }
        ]
      },
      "tokens_used": 8636,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script: User executes hsbPolylineTool.mcr.",
          "2. Insert Cycle Check: Script checks if insertCycleCount() > 1; if so, it erases the temporary instance and returns.",
          "3. Execute Key/Catalog Check: Script checks _kExecuteKey. If valid, it loads properties from the matching catalog entry; otherwise, it loads from '|_LastInserted|' or shows the Properties dialog (showDialog).",
          "4. Entity Selection (Beam/Panel): User selects one or multiple GenBeams or Sip panels via PrEntity prompt. If no valid beams are selected, the script erases itself and exits.",
          "5. Coordinate System Setup: Script aligns its internal coordinate system (vecXT, vecYT) to the orientation of the first selected beam (GenBeam[0]).",
          "6. Path Definition Selection: User is prompted to select polyline(s).",
          "   6a. [Conditional - Polyline Mode] User selects one or more existing polylines (EntPLine).",
          "   6b. [Conditional - Point Mode] User presses Enter to proceed to point picking mode.",
          "7. Path Processing & Instance Creation:",
          "   6a. [Polyline Mode] The script loops through selected polylines. For each valid polyline, it extracts the vertices and creates a new, persistent TSL instance via dbCreate, passing the polyline entity.",
          "   6b. [Point Mode] User picks a start point. The script enters a while loop prompting for subsequent points. A temporary polyline is drawn dynamically for visualization. Upon loop exit (Enter/Cancel), a new persistent TSL instance is created via dbCreate containing the generated polyline entity.",
          "8. Cleanup: The original temporary instance of the script is erased (eraseInstance).",
          "9. Calculation: The new instance(s) execute the calculation block.",
          "10. Tool Logic Determination: The script checks the 'sTool' property to determine if a standard Beamcut or a FreeProfile (Finger/Universal/Vertical Mill) is required.",
          "11. Geometry Generation: The script calculates the cutting body based on the path, alignment (Left/Center/Right), width, and depth. Complex intersections and corner cleanups are performed.",
          "12. Tool Application: The generated tool (BeamCut, FreeProfile, or SolidSubtract) is added to the selected GenBeams/Sip elements."
        ],
        "conditionalBranches": [
          {
            "condition": "Path Definition Input",
            "path1": {
              "name": "Polyline Selection",
              "steps": [
                "User selects existing polylines.",
                "Iterate through selection.",
                "Verify entity is EntPLine and has >= 2 vertices.",
                "Create one TSL instance per selected polyline."
              ]
            },
            "path2": {
              "name": "Manual Point Picking",
              "steps": [
                "User presses Enter at polyline prompt.",
                "Pick Start Point.",
                "Loop: Pick Next Points (update dynamic polyline).",
                "End loop on invalid input.",
                "Create one TSL instance using the drawn geometry."
              ]
            }
          },
          {
            "condition": "Tool Type Selection (sTool)",
            "path1": {
              "name": "Standard Beamcut",
              "steps": [
                "nTool < 0 (Beamcut selected).",
                "Process path into linear segments.",
                "Calculate segment dimensions (dX, dY, dZ).",
                "Handle intersections/clean-up of segment corners.",
                "Generate BeamCut object.",
                "Apply to beams via addMeToGenBeamsIntersect."
              ]
            },
            "path2": {
              "name": "FreeProfile (Finger/Universal/Vertical Mill)",
              "steps": [
                "nTool >= 0 (Complex tool selected).",
                "Generate path profile (plFreeProfile).",
                "Detect closing points for open profiles.",
                "Generate FreeProfile object.",
                "Set specific parameters (Depth, DoSolid for Universal Mill).",
                "Apply to beams."
              ]
            }
          },
          {
            "condition": "Alignment/Side Interaction",
            "path1": {
              "name": "Flip Trigger (Context Menu/Double Click)",
              "steps": [
                "Trigger detected (Flip Alignment or TslDoubleClick).",
                "Toggle sAlignment (Reference <-> Opposite).",
                "Invert nSide (1 becomes -1, etc.).",
                "Update sSide property string.",
                "Trigger recalculation."
              ]
            },
            "path2": {
              "name": "Property Change (OPM)",
              "steps": [
                "User changes sAlignment in Properties Palette.",
                "Event caught (_kNameLastChangedProp == sAlignmentName).",
                "Invert nSide.",
                "Update sSide property string.",
                "Trigger recalculation."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Selection",
            "errorMessage": "(Silent failure)",
            "recovery": "Script erases instance if _GenBeam.length() < 1. User must restart and select beams."
          },
          {
            "check": "Polyline Vertices",
            "errorMessage": "(Silent skip)",
            "recovery": "Selected polylines with < 2 vertices are skipped during the loop in Polyline mode."
          },
          {
            "check": "Segment Dimensions",
            "errorMessage": "(No tool generated)",
            "recovery": "If calculated dimensions (dX, dY, dZ) are smaller than epsilon (0.1mm), the tool is not applied to that segment."
          },
          {
            "check": "Closing Points Detection",
            "errorMessage": "(Geometric self-intersection handling)",
            "recovery": "Script includes logic to check for self-intersecting profiles to determine correct closing points for FreeProfiles."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Tool Parameters",
            "how": "Properties Palette (OPM)",
            "effect": "Changing Depth, Width, Side, or Alignment updates the tool geometry immediately."
          },
          {
            "action": "Flip Alignment",
            "how": "Right-click Context Menu -> '|Flip Alignment|' or Double-click the TSL",
            "effect": "Toggles the alignment reference and flips the side direction, mirroring the cut across the path."
          },
          {
            "action": "Add Entities",
            "how": "Right-click Context Menu -> '|Add entities|'",
            "effect": "Prompts user to select additional beams; adds them to the internal list to receive the same tooling."
          },
          {
            "action": "Remove Entities",
            "how": "Right-click Context Menu -> '|Remove entities|'",
            "effect": "Prompts user to select beams to remove; removes them from the tooling operation."
          },
          {
            "action": "Edit Path Geometry",
            "how": "CAD Grips (Move vertex) on the source polyline",
            "effect": "Because setDependencyOnEntity is used, moving the polyline vertices triggers a recalculation and updates the tool path in real-time."
          }
        ]
      },
      "tokens_used": 10436,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbPolylineTool\n\n## Overview\nThis script applies complex tooling operations (such as rectangular beamcuts, finger milling, or universal milling) to structural beams or panels. It uses a selected polyline or manually picked points to define the path of the cut.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D geometry generation. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: At least one `GenBeam` (Beam) or `Sip` (Panel) must exist in the model.\n- **Minimum Beam Count**: 1.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbPolylineTool.mcr` from the catalog.\n\n### Step 2: Select Beams/Panels\n```\nCommand Line: Select beam(s) or panel(s)\nAction: Click on the beams or panels you want to machine. Press Enter to confirm selection.\n```\n\n### Step 3: Define Tool Path\n```\nCommand Line: Select polyline(s) (<Enter> to pick points)\nAction:\n- Option A: Click on an existing polyline in the drawing to use it as the tool path.\n- Option B: Press Enter to switch to point mode.\n```\n\n### Step 3b: Manual Point Entry (If Option B selected)\n```\nCommand Line: Pick start point\nAction: Click the location where the cut should begin.\n```\n```\nCommand Line: Select next point\nAction: Click subsequent points to draw the path. Press Enter to finish drawing.\n```\n\n### Step 4: Configure Properties\nAfter insertion, select the script instance and open the **Properties Palette** (Ctrl+1) to adjust the Depth, Width, Tool Type, and Alignment.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Alignment | Dropdown | Reference Side | Determines if the tool aligns to the Reference Side or Opposite Side of the beam's coordinate system. |\n| Side | Dropdown | Left | Offsets the tool to the Left, Right, or Center relative to the polyline path. |\n| Depth | Number | 20 | The depth of the cut or mill profile into the material (mm). |\n| Width | Number | 30 | The width of the tool or the diameter of the milling cut (mm). |\n| Tool | Dropdown | Beamcut | Selects the machining operation: Beamcut (standard slot), Finger Mill, Universal Mill, or Vertical Finger Mill. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Alignment | Toggles the alignment reference and flips the side direction (e.g., Left becomes Right), effectively mirroring the cut. |\n| Add entities | Prompts you to select additional beams or panels to apply the current tooling to. |\n| Remove entities | Prompts you to select beams or panels to remove from the tooling operation. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script uses the Properties Palette for configuration; no external settings file is required.\n\n## Tips\n- **Double-Click**: Double-clicking the script instance in the model triggers the \"Flip Alignment\" command, allowing you to quickly mirror the cut.\n- **Dynamic Editing**: If you selected an existing polyline in Step 3, you can use AutoCAD grips to move or reshape the polyline. The tool path will update automatically.\n- **Tool Visualization**: The tool type is visualized; ensure your Width setting matches the physical diameter of the tool you intend to use in production.\n\n## FAQ\n- **Q: Why did the script disappear after I ran it?**\n  A: The script requires at least one beam or panel to be selected in Step 2. If no valid element is selected, the instance will erase itself automatically.\n- **Q: Can I use this on sheets?**\n  A: No, this tool is specifically designed for beams (GenBeam) and panels (Sip) and is not available for sheets.\n- **Q: How do I create a curved path?**\n  A: In Step 3, select an existing polyline that contains arcs (a \"Polyline\" entity, not a \"Line\" entity). Manual point picking creates linear segments only."
      },
      "tokens_used": 6446,
      "error": null
    }
  }
}