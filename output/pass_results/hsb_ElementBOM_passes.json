{
  "filename": "hsb_ElementBOM.mcr",
  "status": "completed",
  "total_tokens": 57139,
  "processing_time": 967.2092430591583,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 47,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.47",
            "date": "29.09.2024",
            "author": "Marsel Nakuci",
            "changes": "HSB-20904: Add property to define the title name for the \"space studs\" table"
          },
          {
            "version": "1.46",
            "date": "22/08/2023",
            "author": "AJ",
            "changes": "Bugfix with sheeting been excluded incorrectly."
          },
          {
            "version": "1.45",
            "date": "25/07/2023",
            "author": "AJ",
            "changes": "Bugfix"
          },
          {
            "version": "1.44",
            "date": "21/07/2023",
            "author": "AJ",
            "changes": "Add support to the Assembly Definition TSL"
          },
          {
            "version": "1.43",
            "date": "28.11.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-16774: show subassemblies for \"GC-SpaceStudAssembly\""
          },
          {
            "version": "1.42",
            "date": "28.11.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-16774: Add property/column name; show beams part of subassembly \"S\" TSLs"
          },
          {
            "version": "1.0",
            "date": "15.03.2012",
            "author": "Alberto Jena",
            "changes": "base on hsb_WallBOM"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8579,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "Script provides user selection for '|paper space|' or '|shopdraw multipage|'. Logic branches: if Paper Space, prompts for Viewport ('getViewport') and appends to '_Viewport'; if Shopdraw, prompts for ShopDrawView ('getShopDrawView') and appends to '_Entity'. Transforms points using 'ms2ps' for drawing. Uses Display(dp) for 2D drawing operations."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam",
            "Sheeting",
            "Material"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Paper Space Viewport or Shopdrawing View Entity",
          "requiredSettings": []
        }
      },
      "tokens_used": 8411,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Pick a point to show the table\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getViewport\",\n        \"promptOriginal\": \"Select the viewport from which the element is taken\",\n        \"condition\": \"_bOnInsert && (sSpace == '|paper space|')\",\n        \"required\": true\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getShopDrawView\",\n        \"promptOriginal\": \"|Select the view entity from which the module is taken|\",\n        \"condition\": \"_bOnInsert && (sSpace == '|shopdraw multipage|')\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 2,\n      \"variable\": \"sSpace\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Drawing space|\",\n      \"defaultValue\": \"|paper space|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|paper space|\",\n        \"|shopdraw multipage|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dim Style\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": \"_DimStyles (Global)\",\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color\",\n      \"defaultValue\": 3,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 17,\n      \"variable\": \"strBmName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Beam names to exclude from the BOM\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \""
      },
      "tokens_used": 10649,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the creation of a Bill of Materials (BOM) table for timber construction elements (walls, floors, roofs) directly in layout views, listing beams, sheets, trusses, and materials with customizable filtering.\",\n    \"category\": \"ShopDrawing\",\n    \"typicalUseCase\": \"Used by detailers to generate accurate material schedules for production drawings. The script aggregates data from a selected viewport or shopdrawing view, filters out unwanted items, and places a formatted table on the sheet.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sSpace\",\n      \"technicalDefault\": \"\\\"|paper space|\\\"\",\n      \"businessMeaning\": \"Determines the drawing environment context, switching logic between extracting data from a standard Paper Space viewport or a multi-page Shopdrawing view.\",\n      \"validRange\": \"|paper space|, |shopdraw multipage|\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Changes the user prompt (selecting a Viewport vs a ShopdrawView entity) and the coordinate transformation required to project the table.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Specifies the AutoCAD Dimension Style that controls the text font, height, and unit formatting for the BOM table contents.\",\n      \"validRange\": \"Any valid DimStyle in the current drawing\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Visual appearance (size, font) of the text inside the table.\"\n    },\n    {\n      \"name\": \"nColor\",\n      \"technicalDefault\": \"3\",\n      \"businessMeaning\": \"Sets the AutoCAD color index for the table frame lines and text.\",\n      \"validRange\": \"0-255 (AutoCAD Color Index)\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Color of the graphical table entities.\"\n    },\n    {\n      \"name\": \"strBmName\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Excludes specific structural members (beams/studs) from the BOM based on their naming convention (e.g., 'WEB', 'STRINGER').\",\n      \"validRange\": \"Semicolon-separated list of names (e.g., 'WEB;SPLICE')\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Reduces the list of timber members in the table by filtering out matches.\"\n    },\n    {\n      \"name\": \"sFilterByZone\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Excludes components belonging to specific construction zones (phases or areas) from the BOM.\",\n      \"validRange\": \"Semicolon-separated list of zone numbers (e.g., '1;2')\",\n      \"unit\": \"Numbers\",\n      \"affectsOutput\": \"Filters out any entity assigned to the listed zones.\"\n    },\n    {\n      \"name\": \"strMaterial\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Excludes components based on their material specification (e.g., specific wood grades or sheet types).\",\n      \"validRange\": \"Semicolon-separated list of material names\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Removes items of specified materials from the calculated totals.\"\n    },\n    {\n      \"name\": \"strGrouping\",\n      \"technicalDefault\": \"\\\"|Posnum & dimension|\\\"\",\n      \"businessMeaning\": \"Controls how items are aggregated. Grouping by 'Posnum & dimension' treats same-named beams of different sizes as separate items, whereas 'Posnum' groups them together regardless of size.\",\n      \"validRange\": \"|Posnum & dimension|, |Posnum|\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Determines the number of rows and the sorting logic of the table.\"\n    },\n    {\n      \"name\": \"sCompAngle\",\n      \"technicalDefault\": \"\\\"No\\\"\",\n      \"businessMeaning\": \"If enabled, converts roof/wall angles to their complementary value (e.g., 90 - pitch) which is often required for specific manufacturing notations.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Alters the numeric value displayed in the Angle column.\"\n    },\n    {\n      \"name\": \"sDoSheets\",\n      \"technicalDefault\": \"\\\"Yes\\\"\",\n      \"businessMeaning\": \"Toggles the inclusion of sheeting materials (plywood, OSB, gypsum board) in the schedule.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Presence or absence of sheeting rows in the table.\"\n    },\n    {\n      \"name\": \"sDoBeams\",\n      \"technicalDefault\": \"\\\"Yes\\\"\",\n      \"businessMeaning\": \"Toggles the inclusion of structural timber members (studs, plates, joists) in the schedule.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Presence or absence of timber rows in the table.\"\n    },\n    {\n      \"name\": \"sDoSIPs\",\n      \"technicalDefault\": \"\\\"Yes\\\"\",\n      \"businessMeaning\": \"Toggles the inclusion of Structural Insulated Panels (SIPs) in the schedule.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Presence or absence of SIP rows in the table.\"\n    },\n    {\n      \"name\": \"sDoMetalparts\",\n      \"technicalDefault\": \"\\\"Yes\\\"\",\n      \"businessMeaning\": \"Toggles the inclusion of metal hardware/connectors (nail plates, hangers, bolts) in the schedule.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Presence or absence of hardware rows in the table.\"\n    },\n    {\n      \"name\": \"sDoTrusses\",\n      \"technicalDefault\": \"\\\"Yes\\\"\",\n      \"businessMeaning\": \"Toggles the inclusion of roof trusses in the schedule.\",\n      \"validRange\": \"Yes, No\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Presence or absence of truss rows in the table.\"\n    },\n    {\n      \"name\": \"sDimStylePosnum\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning\": \"Defines the text style specifically for the part labels (Position Numbers) drawn directly on the beams in the drawing view.\",\n      \"validRange\": \"Any valid DimStyle in the current drawing\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Visual appearance of the text labels overlaid on the 3"
      },
      "tokens_used": 10876,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch: Set sequence number and define global constants (units, tolerance).",
          "Property Initialization: Declare and map OPM properties (Strings, Ints) including filters, display toggles, and formatting options.",
          "Input Parsing: Convert user input strings (exclude names, materials, zones) into arrays for filtering logic.",
          "Execution Branch Check: Is this the initial insertion (_bOnInsert)?",
          "   [Path A: Insertion] Launch GUI Configuration Dialog (showDialog).",
          "   [Path A: Insertion] Prompt user for insertion point (getPoint).",
          "   [Path A: Insertion] Branch based on 'Drawing Space' property:",
          "       [Paper Space] Prompt user to select Viewport (getViewport) -> Save to _Viewport.",
          "       [Shopdraw Multipage] Prompt user to select ShopDrawView Entity (getShopDrawView) -> Save to _Entity.",
          "   [Path A: Insertion] Exit Script (return).",
          "   [Path B: Calculation/Update] Set graphical attributes (Marble diameter, Color, DimStyle).",
          "   [Path B: Calculation/Update] Iterate through entities from the saved Viewport/Entity reference.",
          "   [Path B: Calculation/Update] Apply Filters: Check exclusion lists (Names, Materials, Zones) and Type toggles (Sheets, Beams, SIPs, etc.).",
          "   [Path B: Calculation/Update] Sort and Group Data: Group items by PosNum and/or Dimension based on 'Group by' property.",
          "   [Path B: Calculation/Update] Draw Table: Calculate column widths based on text content and draw headers and rows.",
          "   [Path B: Calculation/Update] Draw Labels (Optional): If enabled, project beam coordinates to Paper Space, create collision masks, and draw Position Numbers on the beams."
        ],
        "conditionalBranches": [
          {
            "condition": "Is _bOnInsert true?",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Show Properties Dialog",
                "Get Insertion Point",
                "Select Source (Viewport or ShopdrawView)",
                "Terminate"
              ]
            },
            "path2": {
              "name": "Re-calculation/Update Mode",
              "steps": [
                "Read Source Entity",
                "Filter Entities",
                "Generate BOM Data",
                "Draw Table",
                "Draw Labels"
              ]
            }
          },
          {
            "condition": "Value of 'Drawing Space' (sSpace)",
            "path1": {
              "name": "Paper Space",
              "steps": [
                "Execute getViewport()",
                "Store result in _Viewport list",
                "Use ms2ps transformation for drawing"
              ]
            },
            "path2": {
              "name": "Shopdraw Multipage",
              "steps": [
                "Execute getShopDrawView()",
                "Store result in _Entity list",
                "Use ms2ps transformation for drawing"
              ]
            }
          },
          {
            "condition": "Filter Logic (Inside Loop)",
            "path1": {
              "name": "Entity Excluded",
              "steps": [
                "Check Name Match in Exclude List -> Skip if true",
                "Check Material Match in Exclude List -> Skip if true",
                "Check Zone Match in Exclude List -> Skip if true",
                "Check Entity Type (Beam/Sheet/etc) against Toggle -> Skip if disabled"
              ]
            },
            "path2": {
              "name": "Entity Included",
              "steps": [
                "Add to Calculation Arrays",
                "Apply Complementary Angle Logic if enabled",
                "Accumulate Quantities/Dimensions"
              ]
            }
          },
          {
            "condition": "Label Overlap Detection",
            "path1": {
              "name": "No Overlap",
              "steps": [
                "Draw Label at calculated position"
              ]
            },
            "path2": {
              "name": "Overlap Detected",
              "steps": [
                "Iterate search (max 30 steps)",
                "Move label in direction of vector vMoveDirection",
                "Check intersection again",
                "Draw label at cleared position"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Source Entity Selection",
            "errorMessage": "No viewport or entity selected (User cancels prompt).",
            "recovery": "User must restart the insert command and make a valid selection."
          },
          {
            "check": "Data Availability",
            "errorMessage": "Empty arrays generated after filtering (No beams/sheets found to list).",
            "recovery": "User modifies OPM filters (removes exclusions) or enables toggles (e.g., 'Show Beams')."
          },
          {
            "check": "Text Fitting",
            "errorMessage": "Text width exceeds calculated column width (Internal logic checks max width).",
            "recovery": "Script dynamically adjusts column width variable to fit the largest string."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Settings",
            "how": "Object Properties Palette (OPM)",
            "effect": "Changing any property (filters, toggles, grouping) triggers an immediate recalculation and redraw of the table and labels."
          },
          {
            "action": "Relocate Table",
            "how": "Grip Edit (Move)",
            "effect": "Changes the base point (_Pt0) of the table, moving the entire drawing to a new location in Paper Space."
          },
          {
            "action": "Update Source",
            "how": "Context Menu (Delete/Re-insert)",
            "effect": "Deleting the script instance removes the table; re-inserting allows selecting a different Viewport or Shopdrawing View to generate a new BOM."
          }
        ]
      },
      "tokens_used": 10831,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ElementBOM.mcr\n\n## Overview\nAutomates the creation of a Bill of Materials (BOM) table for timber construction elements (walls, floors, roofs) directly in layout views. It aggregates data from viewports or shop drawings, allowing detailed filtering of beams, sheets, hardware, and materials, and places a formatted table on the sheet.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is intended for layout documentation. |\n| Paper Space | Yes | Use this mode to generate a BOM from a standard viewport. |\n| Shop Drawing | Yes | Use \"Shopdraw multipage\" mode to generate a BOM from a specific shopdrawing view entity. |\n\n## Prerequisites\n- **Required Entities**: Element, GenBeam, Sheeting, or Material entities must exist in the selected view.\n- **Minimum Beam Count**: 0 (Works with empty or specific subsets of elements).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_ElementBOM.mcr`\n\n### Step 2: Configure BOM Settings\n```\nAction: An initial configuration dialog appears (or Properties Panel opens).\n```\nSet your preferred filtering options (e.g., exclude specific materials, toggle metal parts on/off) and click OK.\n\n### Step 3: Place Table\n```\nCommand Line: Pick a point to show the table\nAction: Click in the Paper Space layout where you want the top-left corner of the BOM table to appear.\n```\n\n### Step 4: Select Data Source\nThe prompt depends on the \"Drawing Space\" property selected in Step 2.\n\n**If \"Drawing Space\" is set to `|paper space|`:**\n```\nCommand Line: Select the viewport from which the element is taken\nAction: Click the border of the viewport containing the model view you wish to list.\n```\n\n**If \"Drawing Space\" is set to `|shopdraw multipage|`:**\n```\nCommand Line: Select the view entity from which the module is taken\nAction: Click the specific shopdrawing view entity (frame) in the model or layout.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Drawing space | dropdown | \\|paper space\\| | Selects the environment: Paper Space Viewport or Shopdraw Multipage view entity. |\n| Dim Style | dropdown | *Current* | AutoCAD Dimension Style used to determine text font and height for the table. |\n| Color | number | 3 | AutoCAD color index for the table frame and text lines. |\n| Beam names to exclude | text | \"\" | Semicolon-separated list of beam names to hide (e.g., \"WEB;STRINGER\"). |\n| Filter by Zone | text | \"\" | Semicolon-separated list of zone numbers to exclude from the BOM. |\n| Materials to exclude | text | \"\" | Semicolon-separated list of material names to exclude (e.g., \"C24;OSB\"). |\n| Grouping | dropdown | \\|Posnum & dimension\\| | Determines how items are grouped: \"Posnum\" ignores dimensions, while \"Posnum & dimension\" separates items by size. |\n| Complementary Angle | dropdown | No | If \"Yes\", converts roof/wall angles to their complementary value (90 - pitch). |\n| Do Sheets | dropdown | Yes | Toggle to include/exclude sheeting materials (plywood, gypsum, etc.). |\n| Do Beams | dropdown | Yes | Toggle to include/exclude structural timber members. |\n| Do SIPs | dropdown | Yes | Toggle to include/exclude Structural Insulated Panels. |\n| Do Metalparts | dropdown | Yes | Toggle to include/exclude metal hardware and connectors. |\n| Do Trusses | dropdown | Yes | Toggle to include/exclude roof trusses. |\n| Dim Style Posnum | text | \"\" | Specific Dimension Style for the position number labels drawn on the beams (if enabled). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Refreshes the BOM table if the model geometry or properties have changed. |\n| Delete | Removes the BOM script instance and the drawn table from the drawing. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on entity data and Properties Panel settings; no external XML settings file is required.\n\n## Tips\n- **Filtering**: Use the \"Beam names to exclude\" property to remove temporary members like webs or stiffeners from your production list.\n- **Text Size**: To change the text size of the table, modify the `Dim Style` property to point to an AutoCAD dimension style with your desired text height.\n- **Label Overlaps**: The script includes collision detection for part labels; if labels are too crowded, it will automatically attempt to shift them to a clear position.\n\n## FAQ\n- **Q: Why are my metal plates not showing up?**\n- **A:** Check the `Do Metalparts` property in the Properties Palette and ensure it is set to \"Yes\".\n- **Q: How do I separate items that have the same position number but different lengths?**\n- **A:** Change the `Grouping` property to `|Posnum & dimension|`. This treats items with different dimensions as separate line items.\n- **Q: Can I move the table after inserting it?**\n- **A:** Yes, select the BOM table (it is a block) and use standard AutoCAD Move commands or grip editing to reposition it."
      },
      "tokens_used": 7793,
      "error": null
    }
  }
}