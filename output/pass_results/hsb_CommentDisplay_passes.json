{
  "filename": "hsb_CommentDisplay.mcr",
  "status": "completed",
  "total_tokens": 52307,
  "processing_time": 225.5384063720703,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9041,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No usage of _Viewport, sd_*, Multipage*, or ShopDrawing (#Type E) entities detected. The script interacts with 'Element' entities and subMapX metadata, typical of model environment operations. The display logic uses standard Display() objects without paper space specific handling."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Element metadata with key 'Hsb_Comment' (ModelMap/Comment[])"
          ]
        }
      },
      "tokens_used": 5370,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"Select a set of elements\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": [\n      {\n        \"prompt\": \"Specify next point or [Undo/cOnfirm/eXit]:\",\n        \"options\": [\n          \"Undo\",\n          \"cOnfirm\",\n          \"eXit\"\n        ]\n      }\n    ]\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 2,\n      \"variable\": \"textOrientationProp\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Text orientation\",\n      \"defaultValue\": \"Unchanged\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Unchanged\",\n        \"Default\",\n        \"Horizontal\",\n        \"Vertical\",\n        \"Perpendicular\"\n      ],\n      \"category\": \"Position & Orientation\",\n      \"description\": \"Sets the text direction of the comment.Default text direction for a point and an area is the entity X, for a line its the line direction.\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"horizontalOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Horizontal offset\",\n      \"defaultValue\": \"0.0\",\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Position & Orientation\",\n      \"description\": \"Sets the horizontal offset.The offset is relative to the linked geometry, or in the entity X direction if there is no geometry linked.\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"verticalOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Vertical offset\",\n      \"defaultValue\": \"0.0\",\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Position & Orientation\",\n      \"description\": \"Sets the vertical offset.The offset is relative to the linked geometry, or in the entity Y direction if there is no geometry linked.\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"commentColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Colour\",\n      \"defaultValue\": 1,\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Comment style\",\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"commentTextHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Text height\",\n      \"defaultValue\": \"50.0\",\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Comment style\",\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"dLeaderSize\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Leader Size\",\n      \"defaultValue\": \"1.0\",\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Comment style\",\n      \"description\": \"Defines the Leader Size\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"gripTypeProp\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Active grippoints\",\n      \"defaultValue\": \"Edge\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Edge\",\n        \"Corner\"\n      ],\n      \"category\": \"Area profile\",\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"drawAreaCommentFilledProp\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Draw area filled\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": \"Area profile\",\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"opacityAreaComment\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Transparency\",\n      \"defaultValue\": 50,\n      \"inputType\": \"number\",\n      \"options\": null,\n      \"category\": \"Area profile\",\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sZone\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Zone\",\n      \"defaultValue\": \"0\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"5\",\n        \"4\",\n        \"3\",\n        \"2\",\n        \"1\",\n        \"0\",\n        \"-1\",\n        \"-2\",\n        \"-3\",\n        \"-4\",\n        \"-5\"\n      ],\n      \"category\": \"Assignment\",\n      \"description\": \"Defines the Zone\"\n    }\n  ],\n  \"contextMenu\": [\n    {\n      \"menuItem\": \"Copy comment to Element(s)\",\n      \"handler\": \"Copy comment to Element(s)\",\n      \"action\": \"Copies the specific comment to other elements\",\n      \"alsoTriggeredBy\": null\n    },\n    {\n      \"menuItem\": \"Copy all comments to Element(s)\",\n      \"handler\": \"Copy all comments to Element(s)\",\n      \"action\": \"Copies all comments from the source element to other elements\",\n      \"alsoTriggeredBy\": null\n    },\n    {\n      \"menuItem\": \"Edit comment\",\n      \"handler\": \"Edit comment\",\n      \"action\": \"Enters edit mode to modify comment geometry and points\",\n      \"alsoTriggeredBy\": null\n    },\n    {\n      \"menuItem\": \"Erase comment from Element\",\n      \"handler\": \"Erase comment from Element\",\n      \"action\": \"Removes a specific comment from"
      },
      "tokens_used": 9739,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Displays and manages visual annotations (comments) attached to timber elements within the 3D model, allowing for text positioning, styling, and zoning.",
          "category": "Annotation / Model Management",
          "typicalUseCase": "Used to visualize manufacturing notes, assembly instructions, or quality control tags directly on beams or walls in the 3D model environment."
        },
        "parameters": [
          {
            "name": "textOrientationProp",
            "technicalDefault": "Unchanged",
            "businessMeaning": "Determines the rotation angle of the comment text relative to the element's coordinate system or the screen.",
            "validRange": "Unchanged, Default, Horizontal, Vertical, Perpendicular",
            "unit": "enum",
            "affectsOutput": "Rotates the displayed text string. 'Default' aligns text to the element's X-axis; 'Horizontal' aligns to world coordinates."
          },
          {
            "name": "horizontalOffset",
            "technicalDefault": "0.0",
            "businessMeaning": "The distance the comment text is moved along the element's length (local X-axis).",
            "validRange": "-5000.0 to 5000.0",
            "unit": "mm",
            "affectsOutput": "Slings the text location left or right along the element."
          },
          {
            "name": "verticalOffset",
            "technicalDefault": "0.0",
            "businessMeaning": "The distance the comment text is moved along the element's width or height (local Y-axis).",
            "validRange": "-1000.0 to 1000.0",
            "unit": "mm",
            "affectsOutput": "Slings the text location up or down relative to the element's face."
          },
          {
            "name": "commentColor",
            "technicalDefault": "1",
            "businessMeaning": "The CAD color index used to render the comment text and leader lines.",
            "validRange": "1 to 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Changes the visual color of the annotation."
          },
          {
            "name": "commentTextHeight",
            "technicalDefault": "50.0",
            "businessMeaning": "The physical height of the text characters in the model space.",
            "validRange": "10.0 to 200.0",
            "unit": "mm",
            "affectsOutput": "Scales the text size up or down for readability."
          },
          {
            "name": "dLeaderSize",
            "technicalDefault": "1.0",
            "businessMeaning": "Scale multiplier for the leader line (the arrow/line pointing from text to the element).",
            "validRange": "0.5 to 5.0",
            "unit": "ratio",
            "affectsOutput": "Lengthens or shortens the leader line geometry."
          },
          {
            "name": "gripTypeProp",
            "technicalDefault": "Edge",
            "businessMeaning": "Specifies where editing handles (grips) appear on 'Area' type comments.",
            "validRange": "Edge, Corner",
            "unit": "enum",
            "affectsOutput": "Changes the interaction method for reshaping area comments (mid-point stretching vs. vertex moving)."
          },
          {
            "name": "drawAreaCommentFilledProp",
            "technicalDefault": "No",
            "businessMeaning": "Toggles the solid background fill for area-type comments.",
            "validRange": "Yes, No",
            "unit": "boolean",
            "affectsOutput": "Adds or removes a solid hatch/polygon behind the area comment."
          },
          {
            "name": "opacityAreaComment",
            "technicalDefault": "50",
            "businessMeaning": "The transparency level of the area comment fill.",
            "validRange": "0 (Transparent) to 100 (Opaque)",
            "unit": "percent",
            "affectsOutput": "Adjusts how 'see-through' the filled area is."
          },
          {
            "name": "sZone",
            "technicalDefault": "0",
            "businessMeaning": "Assigns the comment to a specific logical zone or layer for organization.",
            "validRange": "-5 to 5",
            "unit": "index",
            "affectsOutput": "Updates the metadata 'ZoneIndex' used for filtering or processing comments in reports or other scripts."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Modification of horizontalOffset or verticalOffset",
            "effect": "Recalculates the Text Origin point (_PtG[0]) and updates the element metadata.",
            "cascade": [
              "textOriginKey"
            ]
          },
          {
            "trigger": "Modification of sZone",
            "effect": "Updates the ZoneIndex field in the element's comment metadata map.",
            "cascade": [
              "zoneIndexKey"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Display Objects / Annotation",
            "description": "Visual representations of text, leader lines, and filled areas. These are graphics only and do not represent physical geometry.",
            "appliedTo": "Model Space (visual overlay on selected Elements)"
          }
        ]
      },
      "tokens_used": 9709,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution starts",
          "[Conditional] Check if insertCycleCount > 1: If true, erase instance and exit",
          "Prompt user to select a set of elements (PrEntity)",
          "Iterate through selected elements",
          "Remove existing script instances from element to prevent duplication",
          "Retrieve 'Hsb_Comment' metadata from element",
          "Iterate through found comments in metadata",
          "For each comment, insert a new script instance attached to the element",
          "Erase the temporary 'master' script instance",
          "[Instance Execution] Retrieve element and specific comment data from _Map",
          "[Conditional] Validate comment data (Location/GeometryType): If missing, erase instance",
          "[Conditional] Check execution trigger (Edit comment vs. Standard Update)",
          "Update text position based on Horizontal/Vertical offsets",
          "[Conditional] Render comment based on Visualisation Mode (Visible, Collapsed, None)",
          "[Conditional] Draw specific geometry based on Type (Point, Line, Area)",
          "Update Element metadata with modified properties (Position, Zone, Orientation)",
          "Synchronize OPM properties with current geometry state"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle Count > 1",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Execute Main Insertion Logic"
              ]
            }
          },
          {
            "condition": "Comment Metadata Existence",
            "path1": {
              "name": "Map Valid",
              "steps": [
                "Extract Comment Properties",
                "Render Annotation"
              ]
            },
            "path2": {
              "name": "Map Invalid/Missing",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            }
          },
          {
            "condition": "Visualisation Mode (Metadata key 'Visualisation')",
            "path1": {
              "name": "Visible (0)",
              "steps": [
                "Draw Text Lines",
                "Draw Leader Lines",
                "Draw Geometry"
              ]
            },
            "path2": {
              "name": "Collapsed (1)",
              "steps": [
                "Draw Circle with Dot and Info Bar Icon",
                "Hide Text"
              ]
            },
            "path3": {
              "name": "None (2)",
              "steps": [
                "Draw Nothing (Instance persists but is invisible)"
              ]
            }
          },
          {
            "condition": "Geometry Type",
            "path1": {
              "name": "Area",
              "steps": [
                "Draw Polygon/Profile",
                "Apply Transparency/Fill",
                "Generate Edge or Corner Grips"
              ]
            },
            "path2": {
              "name": "Line",
              "steps": [
                "Draw Line Segment",
                "Generate Start/End Grips"
              ]
            },
            "path3": {
              "name": "Point",
              "steps": [
                "Draw Point Marker",
                "Generate Single Location Grip"
              ]
            }
          },
          {
            "condition": "Edit Mode (Context Menu 'Edit comment')",
            "path1": {
              "name": "Edit Active",
              "steps": [
                "Enter Jig Loop",
                "Display Dynamic Leader Lines",
                "Prompt for Point (Add/Remove)",
                "Update Point Arrays"
              ]
            },
            "path2": {
              "name": "Standard Update",
              "steps": [
                "Skip Jig",
                "Render based on current properties"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Validity",
            "errorMessage": "None (Silent failure)",
            "recovery": "Script erases itself if the linked element is invalid or deleted."
          },
          {
            "check": "Metadata Integrity",
            "errorMessage": "None (Silent failure)",
            "recovery": "Script checks for 'Location' and 'GeometryType' keys. If missing, the instance is erased."
          },
          {
            "check": "Leader Line Movement",
            "errorMessage": "None",
            "recovery": "Script protects against invalid grip movements that would break the leader logic in the Jig phase."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Comment Text (Grip Edit)",
            "how": "Drag the primary grip (_PtG[0])",
            "effect": "Updates Horizontal/Vertical offset properties in OPM and updates TextOrigin in metadata."
          },
          {
            "action": "Resize Area/Line (Grip Edit)",
            "how": "Drag edge or corner grips (based on 'Active grippoints' property)",
            "effect": "Updates the Geometry coordinates in the metadata."
          },
          {
            "action": "Edit Leader Lines",
            "how": "Context Menu -> 'Edit comment' -> Click to add points / Hover + 'cOnfirm'/'eXit'",
            "effect": "Adds or removes points from the leader line path in the metadata."
          },
          {
            "action": "Change Style/Position (OPM)",
            "how": "Modify properties in AutoCAD Properties Palette (e.g., Text height, Colour, Zone, Offsets)",
            "effect": "Immediately redraws the comment and updates the metadata with new values."
          },
          {
            "action": "Assign Zone",
            "how": "Change 'Zone' property in OPM",
            "effect": "Updates the 'ZoneIndex' field in the comment metadata for filtering/export purposes."
          }
        ]
      },
      "tokens_used": 11103,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_CommentDisplay.mcr\n\n## Overview\nThis script visualizes and manages annotation comments attached to timber elements in the 3D model. It reads comment data from element metadata to display text, leader lines, and area markers, providing tools to edit geometry, adjust styles, and organize comments by zone.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This is the primary environment for viewing and editing 3D element comments. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required entities**: Element (e.g., Walls, Beams) that already contain comment metadata (key `Hsb_Comment`).\n- **Minimum beam count**: 0 (Requires selection of at least one Element).\n- **Required settings**: Elements must have existing comment data stored in their ModelMap/Comment properties.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_CommentDisplay.mcr`\n\n### Step 2: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on the timber elements (walls/beams) that contain the comments you wish to visualize or manage.\n```\n*Note: Upon selection, the script will scan the elements. If comments exist, a display instance is created for each comment, and the master script instance will automatically erase itself.*\n\n### Step 3: Edit Comment Geometry (Optional)\n```\nAction: Select a displayed comment in the model.\nRight-Click Menu: Select \"Edit comment\"\nCommand Line: Specify next point or [Undo/cOnfirm/eXit]:\nAction:\n - Click to add points to the leader line.\n - Type \"U\" to undo the last point.\n - Hover over the text and type \"C\" (cOnfirm) or \"X\" (eXit) to finish editing.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Comment style** | | | |\n| Colour | Number | 1 | Sets the color of the comment text and leader lines (AutoCAD Color Index 1-255). |\n| Text height | Number | 50.0 | Sets the physical height of the comment text in the model (mm). |\n| Leader Size | Number | 1.0 | Scale multiplier for the leader line arrow/segment length. |\n| **Position & Orientation** | | | |\n| Horizontal offset | Number | 0.0 | Moves the text along the element's length (local X-axis). |\n| Vertical offset | Number | 0.0 | Moves the text along the element's width/height (local Y-axis). |\n| Text orientation | Dropdown | Unchanged | Controls text rotation: Unchanged, Default (Element X), Horizontal, Vertical, or Perpendicular. |\n| **Area profile** | | | |\n| Active grippoints | Dropdown | Edge | Determines if resizing handles appear on Edge midpoints or Corners (for Area comments). |\n| Draw area filled | Dropdown | No | If \"Yes\", draws a solid background fill for area comments. |\n| Transparency | Number | 50 | Sets opacity of the area fill (0 = Transparent, 100 = Opaque). |\n| **Assignment** | | | |\n| Zone | Dropdown | 0 | Assigns the comment to a logical zone (-5 to 5) for organization or filtering. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Copy comment to Element(s) | Copies the specific selected comment to other selected elements. |\n| Copy all comments to Element(s) | Copies all comments from the source element to other selected elements. |\n| Edit comment | Enters an interactive mode to add, remove, or modify points in the comment leader line. |\n| Erase comment from Element | Removes the specific comment from the element and deletes the display instance. |\n\n## Settings Files\n- **Filename**: None (External XML)\n- **Location**: N/A\n- **Purpose**: This script relies entirely on **Element Metadata** (`Hsb_Comment` key) for configuration. No external settings file is required; properties are managed via the Properties Palette (OPM).\n\n## Tips\n- **Moving Text**: You can drag the text grip (the square handle on the text) in the model. The script will automatically calculate and update the \"Horizontal offset\" and \"Vertical offset\" properties in the palette.\n- **Zone Filtering**: Use the \"Zone\" property to group comments (e.g., \"Zone 1\" for framing, \"Zone 2\" for finishing). This is useful for generating filtered reports or lists later.\n- **Editing Leaders**: While in \"Edit comment\" mode, you can hover over the text anchor point and type `cOnfirm` to finish the shape without adding extra points.\n- **Visibility**: If an element has comment data but nothing displays, check if the \"Visualisation\" mode in the element's metadata is set to \"None\".\n\n## FAQ\n- **Q: Why did the script disappear immediately after I selected the elements?**\n- **A: This is normal behavior. The script acts as a generator; it reads the element data, spawns the visual comment instances, and then erases the \"master\" script instance to leave only the annotations behind.\n  \n- **Q: How do I create a new comment on an element?**\n- **A: This script *displays* existing comments. To create new comments, you typically need to use the data entry tools (like hsbCAD's Comment input commands or catalog tools) that write the `Hsb_Comment` metadata to the element first. Once the data exists, run this script to see it.\n\n- **Q: What is the difference between \"Default\" and \"Horizontal\" text orientation?**\n- **A: \"Default\" aligns the text relative to the element's local X-axis (e.g., along the length of a beam). \"Horizontal\" aligns the text to the World coordinate system, keeping it flat regardless of the beam's rotation."
      },
      "tokens_used": 7345,
      "error": null
    }
  }
}