{
  "filename": "HSB_G-SolidContainer.mcr",
  "status": "completed",
  "total_tokens": 50486,
  "processing_time": 406.7263412475586,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9069,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script operates on GenBeam entities, utilizing 3D vectors (vecX, vecY, vecZ), solid centroids (ptCenSolid), and volume calculations. It performs boolean operations on Body objects (subPart, decomposeIntoLumps) and draws 3D geometry. There are no references to Paper Space, Viewports, or Shop Drawing API calls (sd_*)."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Map entry with key 'RealSolid' containing a Body object (for volume comparison functionality)"
          ]
        }
      },
      "tokens_used": 6561,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "200",
            "inputType": "number",
            "category": "|Text|",
            "description": "|Defines the Text Height|"
          },
          {
            "index": 1,
            "variable": "sView",
            "type": "PropString",
            "displayName": "|View|",
            "defaultValue": "|Difference|",
            "inputType": "dropdown",
            "options": [
              "|Nothing|",
              "|Imported body|",
              "|Difference|"
            ],
            "category": "|Body|",
            "description": "|Defines the View|"
          },
          {
            "index": 2,
            "variable": "sColor",
            "type": "PropString",
            "displayName": "|Color|",
            "defaultValue": "|Yellow|",
            "inputType": "dropdown",
            "options": [
              "|Default|",
              "|Red|",
              "|Yellow|",
              "|Green|",
              "|Cyan|",
              "|Blue|",
              "|Magenta|",
              "|White|",
              "|Black|",
              "|Gray|",
              "|Dark brown|",
              "|Light brown|"
            ],
            "category": "|General|",
            "description": "|Defines the Color|"
          },
          {
            "index": 3,
            "variable": "dOffset",
            "type": "PropDouble",
            "displayName": "|Offset|",
            "defaultValue": "300",
            "inputType": "number",
            "category": "|Body|",
            "description": "|Defines the Offset value|"
          },
          {
            "index": 4,
            "variable": "sOffsetDirection",
            "type": "PropString",
            "displayName": "|Offset Direction| (|GenBeam|)",
            "defaultValue": "|Z|",
            "inputType": "dropdown",
            "options": [
              "|X|",
              "|-X|",
              "|Y|",
              "|-Y|",
              "|Z|",
              "|-Z|"
            ],
            "category": "|Body|",
            "description": "|Defines the Offset Direction|. |Notice|: |Direction is relative to GenBeam's vectors|"
          },
          {
            "index": 5,
            "variable": "sShowImportError",
            "type": "PropString",
            "displayName": "|Show Import Error|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Body|",
            "description": "|Shows face loops if not valid body was stored in map|"
          },
          {
            "index": 6,
            "variable": "dOffsetText",
            "type": "PropDouble",
            "displayName": "|Text Offset|",
            "defaultValue": "350",
            "inputType": "number",
            "category": "|Text|",
            "description": "|Defines the Text Offset|"
          },
          {
            "index": 7,
            "variable": "sFormattedVariable",
            "type": "PropString",
            "displayName": "|Custom Text|",
            "defaultValue": "",
            "inputType": "text",
            "category": "|Text|",
            "description": "|Defines the custom text to display including the usage of Formatted Variables|. |If no one is found then text will be displayed as it is|. "
          },
          {
            "index": 8,
            "variable": "sGroup",
            "type": "PropString",
            "displayName": "|Group|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "<Existing Groups>"
            ],
            "category": "|General|",
            "description": "|Assigns the element to a specific group|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7473,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Visually compares the geometry of a timber beam against a reference solid (imported from a Map) to detect volume differences, clashes, or modifications.\",\n    \"category\": \"Quality Control / Model Comparison\",\n    \"typicalUseCase\": \"Verifying if a modified architectural model matches the existing timber model, or checking if machining operations have altered the beam volume significantly by overlaying a 'ghost' solid.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dTextHeight\",\n      \"technicalDefault\": \"200\",\n      \"businessMeaning\": \"Controls the size of the text annotations displayed in the model view (e.g., position number, volume).\",\n      \"validRange\": \"50 - 500\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Scales the legibility of the text labels attached to the beam.\"\n    },\n    {\n      \"name\": \"sView\",\n      \"technicalDefault\": \"|Difference|\",\n      \"businessMeaning\": \"Determines the visualization mode of the comparison. 'Nothing' hides the comparison body. 'Imported body' shows the reference shape. 'Difference' highlights the geometric mismatches (gaps or clashes).\",\n      \"validRange\": \"|Nothing|, |Imported body|, |Difference|\",\n      \"unit\": \"Enumeration\",\n      \"affectsOutput\": \"Switches the script between hiding data, showing the target state, or showing the error state.\"\n    },\n    {\n      \"name\": \"sColor\",\n      \"technicalDefault\": \"|Yellow|\",\n      \"businessMeaning \"Defines the display color of the visualized solid (Imported body or Difference) to distinguish it from the actual timber beam.\",\n      \"validRange\": \"Standard CAD colors (Red, Yellow, Green, etc.)\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Changes the visual color of the overlay geometry.\"\n    },\n    {\n      \"name\": \"dOffset\",\n      \"technicalDefault\": \"300\",\n      \"businessMeaning\": \"Sets the distance the visualized body is shifted away from the beam to prevent visual overlap (Z-fighting) and make the comparison clear.\",\n      \"validRange\": \"0 - 2000\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Moves the ghost body relative to the real beam along the specified axis.\"\n    },\n    {\n      \"name\": \"sOffsetDirection\",\n      \"technicalDefault\": \"|Z|\",\n      \"businessMeaning\": \"Specifies the local axis direction (relative to the beam's coordinate system) in which to shift the visualized body.\",\n      \"validRange\": \"|X|, |-X|, |Y|, |-Y|, |Z|, |-Z|\",\n      \"unit\": \"Vector\",\n      \"affectsOutput\": \"Determines the spatial direction of the Offset applied to the visualized body.\"\n    },\n    {\n      \"name\": \"sShowImportError\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"If the imported solid data is invalid, toggles the display of wireframe 'face loops' as a fallback diagnostic instead of hiding the error entirely.\",\n      \"validRange\": \"|No|, |Yes|\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"Enables/disables wireframe debugging graphics when data integrity fails.\"\n    },\n    {\n      \"name\": \"dOffsetText\",\n      \"technicalDefault\": \"350\",\n      \"businessMeaning\": \"Defines the distance from the beam's center (or reference point) where the text label is positioned.\",\n      \"validRange\": \"0 - 1000\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Moves the text label closer to or further from the beam.\"\n    },\n    {\n      \"name\": \"sFormattedVariable\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Defines the content of the text label using dynamic tokens (e.g., '@(Posnum)', '@(Volume)') or static text to display relevant beam properties.\",\n      \"validRange\": \"String with optional tokens like @(Posnum), @(Length), @(Volume)\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Populates the text string drawn next to the beam with specific data.\"\n    },\n    {\n      \"name\": \"sGroup\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Assigns the script instance to a specific CAD group for organizational purposes, allowing users to filter or toggle visibility of these comparison elements.\",\n      \"validRange\": \"Existing Group Names\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Changes the layer/group property of the script element in the CAD model tree.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sView is set to |Nothing|\",\n      \"effect\": \"Visual body parameters (sColor, dOffset, sOffsetDirection) are ignored for body rendering, though text remains active.\",\n      \"cascade\": [\n        \"sColor\",\n        \"dOffset\",\n        \"sOffsetDirection\"\n      ]\n    },\n    {\n      \"trigger\": \"Imported body data is invalid/corrupt\",\n      \"effect\": \"The 'Difference' view may fail, and the sShowImportError parameter dictates if wireframe loops are drawn instead.\",\n      \"cascade\": [\n        \"sShowImportError\"\n      ]\n    },\n    {\n      \"trigger\": \"sFormattedVariable contains no valid tokens\",\n      \"effect\": \"The script defaults to displaying the Beam's Position Number (Posnum) if available.\",\n      \"cascade\": []\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"Visual Body (Ghost)\",\n      \"description\": \"A non-physical 3D representation of the imported reference solid or the calculated volume difference, used for visual clash detection.\",\n      \"appliedTo\": \"Selected GenBeam\"\n    },\n    {\n      \"type\": \"Annotation Text\",\n      \"description\": \"Text labels displaying dynamic beam properties (Posnum, Volume, etc.) based on the Custom Text configuration.\",\n      \"appliedTo\": \"Selected GenBeam\"\n    }\n  ]\n}\n```"
      },
      "tokens_used": 9533,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch script via command line or catalog.",
          "2. Prompt user: 'Select genBeam(s)'.",
          "3. Validate selection: Ensure entities are valid GenBeams.",
          "4. Iterate through selected GenBeams.",
          "5. Cleanup phase: Detect and erase any existing instances of this TSL attached to the selected GenBeam to prevent duplicates.",
          "6. Insertion: Attach new instance to GenBeam. Set insertion point (_Pt0) to the beam's solid centroid (ptCenSolid). Disable grip editing on _Pt0.",
          "7. Property Initialization: Apply default or user-defined properties from the OPM (Text Height, View, Color, Offset, etc.).",
          "8. Data Retrieval: Extract the beam's geometry and fetch the reference solid from the script's internal Map under key 'RealSolid'.",
          "9. Text Processing: Parse the 'Custom Text' property. If formatted variables (e.g., @(Volume)) are found, resolve them; otherwise, fall back to static text or Position Number.",
          "10. Visualization Logic: Determine visual output based on the 'View' property and the validity of the imported solid.",
          "11. Reporting: Display feedback messages (volume differences, equality status, or import errors) to the user."
        ],
        "conditionalBranches": [
          {
            "condition": "Validity of Imported Reference Solid (from Map)",
            "path1": {
              "name": "Valid Solid",
              "steps": [
                "Check 'View' property.",
                "If 'Imported body': Draw the imported solid shifted by the Offset value.",
                "If 'Difference': Calculate boolean volume difference (Real - Imported and Imported - Real).",
                "Compare difference volume against Tolerance (default 15cm³ or Map value).",
                "If difference > Tolerance: Draw the resulting 'lumps' of volume difference and report discrepancy.",
                "If difference <= Tolerance: Report 'Solids have same volume' (no geometry drawn for difference)."
              ]
            },
            "path2": {
              "name": "Invalid/Corrupt Solid",
              "steps": [
                "Check 'Show Import Error' property.",
                "If 'Yes': Retrieve and draw face loops (wireframe) from the Map as a fallback visualization.",
                "If 'No': Skip drawing geometry, report error indicating invalid body."
              ]
            }
          },
          {
            "condition": "User Selection - View Property",
            "path1": {
              "name": "Nothing (Index 0)",
              "steps": [
                "Suppress all body rendering (Imported or Difference).",
                "Text labels (Custom Text) are still generated and drawn."
              ]
            },
            "path2": {
              "name": "Imported body (Index 1)",
              "steps": [
                "Render the reference solid retrieved from Map.",
                "Apply Offset translation based on Offset Direction property.",
                "Apply Color property."
              ]
            },
            "path3": {
              "name": "Difference (Index 2)",
              "steps": [
                "Perform boolean subtraction between Beam and Imported Solid.",
                "Render the resulting volume discrepancies (clashes/gaps).",
                "Apply Offset and Color properties."
              ]
            }
          },
          {
            "condition": "Custom Text Parsing (Formatted Variables)",
            "path1": {
              "name": "Variables Detected",
              "steps": [
                "Scan string for tokens like @(Volume), @(Posnum).",
                "Extract values from the GenBeam entity.",
                "Draw multiple lines of text corresponding to the found variables."
              ]
            },
            "path2": {
              "name": "No Variables Detected",
              "steps": [
                "Display the string literally as defined in 'Custom Text'.",
                "If 'Custom Text' is empty, default to drawing the GenBeam's Position Number.",
                "If Position Number is empty, draw '-1'."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection",
            "errorMessage": "Implicitly handled by getGenBeam. If non-GenBeam selected, selection fails or is ignored.",
            "recovery": "Select a valid GenBeam timber element."
          },
          {
            "check": "Map Data Integrity",
            "errorMessage": "\"Not valid body resulted after importing from Map, showing face loops instead.\" (if enabled)",
            "recovery": "Ensure the Map entry 'RealSolid' contains a valid 3D Body object, not just surfaces or corrupt data. Use 'Show Import Error' = Yes to debug."
          },
          {
            "check": "Formatted Variable Syntax",
            "errorMessage": "Script ignores unrecognized tokens.",
            "recovery": "Ensure variables use the syntax @(Name) and match the internal list (e.g., @(Length), @(Volume))."
          },
          {
            "check": "Insertion Point Relocation",
            "errorMessage": "N/A (Prevented by code)",
            "recovery": "Script explicitly disables the grip point on _Pt0 to prevent users from accidentally moving the coordinate system and misaligning the comparison."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Visualization Mode",
            "how": "OPM Property 'View' (Dropdown)",
            "effect": "Switches between showing the full imported solid, the volume difference only, or hiding the solid comparison entirely."
          },
          {
            "action": "Adjust Visual Overlap",
            "how": "OPM Properties 'Offset' and 'Offset Direction'",
            "effect": "Moves the visualized ghost body away from the real beam along the specified local axis (X, Y, or Z) to improve visibility."
          },
          {
            "action": "Modify Labels",
            "how": "OPM Properties 'Custom Text', 'Text Height', 'Text Offset'",
            "effect": "Updates the dynamic text labels, changes their size, or moves their position relative to the beam."
          },
          {
            "action": "Update Beam Geometry",
            "how": "Modify the GenBeam (e.g., resize, add machining)",
            "effect": "Script automatically recalculates. If 'View' is Difference, the visualized volume difference updates immediately to reflect the new geometry."
          },
          {
            "action": "Change Reference Data",
            "how": "External process updating the Map entry 'RealSolid'",
            "effect": "The script refreshes its comparison based on the new reference solid in the map."
          }
        ]
      },
      "tokens_used": 10790,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-SolidContainer.mcr\n\n## Overview\nThis script performs a visual quality control check by comparing the current geometry of a timber beam (GenBeam) against a reference solid stored in the hsbCAD Map. It is used to visualize clashes, gaps, or volume differences between the actual timber model and an imported design state (e.g., from an architectural model).\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script only operates in the 3D Model environment. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Does not generate 2D drawing views. |\n\n## Prerequisites\n- **Required Entities**: At least one `GenBeam` (Timber Beam) must be present in the model.\n- **Minimum Beam Count**: 1.\n- **Required Settings**: The script requires a Map entry attached to the element (or globally) with the key `RealSolid` containing a valid 3D Body object. Without this reference data, the script cannot perform the comparison.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: In the file dialog, select `HSB_G-SolidContainer.mcr` and click Open.\n\n### Step 2: Select Beams\n```\nCommand Line: Select genBeam(s)\nAction: Click on the timber beam(s) you wish to compare against the reference solid. Press Enter to confirm selection.\n```\n*Note: Upon selection, the script attaches to the beam and performs an initial calculation based on default properties.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| View | dropdown | Difference | Determines what is visualized: <br>• **Nothing**: Hides the comparison body.<br>• **Imported body**: Shows the reference solid only.<br>• **Difference**: Shows the volume discrepancy (gaps or clashes) between the beam and the reference. |\n| Color | dropdown | Yellow | Sets the display color of the visualized solid (Imported body or Difference). |\n| Offset | number | 300 | Sets the distance (in mm) the visualized body is shifted away from the beam to prevent visual overlap. |\n| Offset Direction (GenBeam) | dropdown | Z | Specifies the axis direction (relative to the beam's local coordinate system) to apply the Offset. Options include X, -X, Y, -Y, Z, -Z. |\n| Text Height | number | 200 | Defines the height of the text annotation displayed in the model. |\n| Text Offset | number | 350 | Defines the distance from the beam's reference point where the text label is positioned. |\n| Custom Text | text | - | Defines the text content displayed next to the beam. Supports formatted variables like `@(Posnum)`, `@(Length)`, or `@(Volume)`. If left empty, it defaults to the Position Number. |\n| Show Import Error | dropdown | No | If the imported reference solid is invalid, set to **Yes** to display wireframe face loops for debugging purposes. |\n| Group | dropdown | - | Assigns the script instance to a specific CAD group for organizational control. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom items to the right-click context menu. All modifications are made via the Properties Palette. |\n\n## Settings Files\n- **Map Key**: `RealSolid`\n- **Location**: Internal hsbCAD Element Map\n- **Purpose**: Stores the reference 3D Body geometry (usually imported from an external CAD file) used for the comparison. This data must be populated by an import script or process before running this script.\n\n## Tips\n- **Visual Clarity**: If the visualized body overlaps perfectly with your beam (Z-fighting), increase the **Offset** value or change the **Offset Direction** (e.g., set to Z to shift it vertically above the beam).\n- **Finding Errors**: Set **View** to `Difference`. If you see colored geometry appear, it indicates areas where the timber beam does not match the reference solid (either too much material or too little).\n- **Data Labels**: Use the **Custom Text** property to display dynamic data. For example, entering `Vol: @(Volume)` will display the text \"Vol: \" followed by the actual calculated volume of the discrepancy.\n- **Data Integrity**: If the script reports errors, ensure the import process successfully created a valid solid in the Map and not just a collection of surfaces. Enable **Show Import Error** to diagnose bad data.\n\n## FAQ\n- **Q: I ran the script, but I don't see any new geometry.**\n  A: Check the **View** property in the Properties Palette. If it is set to \"Nothing\", change it to \"Imported body\" or \"Difference\". Also, verify that the `RealSolid` Map entry actually contains data.\n- **Q: Why does the text show \"-1\"?**\n  A: The script defaults to showing the Position Number. If the beam has not been assigned a position number yet, it may display -1 or an empty string. You can change the **Custom Text** property to show other data like `@(Length)`.\n- **Q: What does the \"Difference\" view actually show?**\n  A: It performs a Boolean operation. It shows the volume that exists in the Reference Solid but *not* in the Timber Beam (missing material) AND the volume that exists in the Timber Beam but *not* in the Reference Solid (extra material)."
      },
      "tokens_used": 7060,
      "error": null
    }
  }
}