{
  "filename": "f_Package.mcr",
  "status": "completed",
  "total_tokens": 53472,
  "processing_time": 281.2787685394287,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9444,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script processes Body arrays and 3D geometry (shadowProfile, intersectWith) within getBottomTopItems(). It uses standard ModelSpace insertion point (_Pt0) and grips (_PtG). It directly manipulates property sets on Entity objects (setAttachedPropSetFromMap). No ShopDrawing (#Type E) or sd_ prefixes found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Entity",
            "Body",
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "Property Set Definition 'Stacking'",
            "XML parameters for 'Wrapping' material",
            "XML parameter 'GripDistanceOnInsert'",
            "Project Special 'KLH' (optional functionality)"
          ]
        }
      },
      "tokens_used": 7623,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 10189,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Groups selected timber elements into a logical 'package' for transport or production, calculating total weight and generating a visual label.",
          "category": "Logistics/Labeling",
          "typicalUseCase": "Organizing wall panels or beams into truck loads or shipping bundles to ensure accurate weight calculation and identification on site."
        },
        "parameters": [
          {
            "name": "nNumber",
            "technicalDefault": "1",
            "businessMeaning": "The unique identification number assigned to this specific package (e.g., Palette 1, Bundle A).",
            "validRange": "1 - 9999",
            "unit": "count",
            "affectsOutput": "Updates the 'Package Number' property in the 'Stacking' property set of all contained items and updates the label text."
          },
          {
            "name": "sFormat",
            "technicalDefault": "@(Name)",
            "businessMeaning": "Defines the text layout and content displayed on the package label (e.g., showing Name, Weight, or Count).",
            "validRange": "Text string containing format tokens like @(Name), @(Number), @(Weight)",
            "unit": "string",
            "affectsOutput": "Changes the text lines drawn in the model space label."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "100 (mm)",
            "businessMeaning": "The height of the text characters on the package label for readability.",
            "validRange": "10 - 500 mm",
            "unit": "mm",
            "affectsOutput": "Scales the text size of the label."
          },
          {
            "name": "nStyle",
            "technicalDefault": "0",
            "businessMeaning": "The visual style of the label background (0 = no background, 1 = frame only, 2 = filled background).",
            "validRange": "0, 1, 2",
            "unit": "index",
            "affectsOutput": "Controls drawing of the polyline boundary around the label text (filled, wireframe, or none)."
          },
          {
            "name": "sGrouping",
            "technicalDefault": "Default",
            "businessMeaning": "Defines how items within the package are categorized or filtered (often used for sub-grouping reports).",
            "validRange": "Default, No group assignment",
            "unit": "enum",
            "affectsOutput": "Influences internal grouping logic and potential data export formats."
          },
          {
            "name": "sWrap",
            "technicalDefault": "None",
            "businessMeaning": "Specifies the packaging material used to protect the bundle (e.g., Foil, Cardboard).",
            "validRange": "String list defined in project settings",
            "unit": "string",
            "affectsOutput": "Updates 'Package Wrapping' property in 'Stacking' set and modifies visual representation if KLH special logic is active."
          },
          {
            "name": "dMaxBedding",
            "technicalDefault": "0",
            "businessMeaning": "Additional weight factor per volume unit for packing materials (straps, nails, foil) added to the item weights.",
            "validRange": "0 - 500 kg/m3",
            "unit": "kg/m³",
            "affectsOutput": "Increases the calculated 'Weight' value displayed on the label and stored in MapX."
          },
          {
            "name": "nColor",
            "technicalDefault": "12",
            "businessMeaning": "The CAD color used to visualize the package bounding box.",
            "validRange": "0 - 255 (AutoCAD color index)",
            "unit": "color index",
            "affectsOutput": "Changes the color of the 3D profile representing the package."
          },
          {
            "name": "nTransparencyTruck",
            "technicalDefault": "60",
            "businessMeaning": "Opacity of the package visual representation (lower percentage = more transparent).",
            "validRange": "0 - 90",
            "unit": "percent",
            "affectsOutput": "Adjusts visibility of elements contained within the package bounding box."
          },
          {
            "name": "GripDistanceOnInsert",
            "technicalDefault": "XML defined",
            "businessMeaning": "Initial offset distance of the text label from the package insertion point.",
            "validRange": "0 - 5000 mm",
            "unit": "mm",
            "affectsOutput": "Determines starting position of the label grip when the script is first inserted."
          },
          {
            "name": "ContourThickness",
            "technicalDefault": "XML defined",
            "businessMeaning": "Visual thickness of the wrapping material drawn around the package profile.",
            "validRange": "0 - 50 mm",
            "unit": "mm",
            "affectsOutput": "Offsets the drawing of the package boundary to simulate material thickness."
          },
          {
            "name": "PropertyReadOnly",
            "technicalDefault": "XML defined",
            "businessMeaning": "Locks the package properties to prevent manual editing (used in automated KLH workflows).",
            "validRange": "0 (No), 1 (Yes)",
            "unit": "bool",
            "affectsOutput": "Hides or disables parameters in the Properties palette."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing sWrap",
            "effect": "Updates the 'Stacking' property set on referenced entities to reflect the new wrapping type.",
            "cascade": [
              "Property Set 'Stacking' (Package Wrapping)"
            ]
          },
          {
            "trigger": "Changing nNumber",
            "effect": "Overwrites the 'Package Number' in the 'Stacking' property set of all constituent elements.",
            "cascade": [
              "Property Set 'Stacking' (Package Number)"
            ]
          },
          {
            "trigger": "Changing dMaxBedding",
            "effect": "Recalculates the total weight displayed in the label.",
            "cascade": [
              "Label Text (Weight)",
              "MapX (Weight)"
            ]
          },
          {
            "trigger": "Setting ProjectSpecial to KLH",
            "effect": "Activates specific logic for calculating weight and drawing wrapping contours.",
            "cascade": [
              "Weight Calculation Logic",
              "Visual Wrapping Representation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Profile (PlaneProfile)",
            "description": "A 3D bounding box representing the physical volume of the package.",
            "appliedTo": "Model Space (referencing grouped Entities/Beams)"
          },
          {
            "type": "Label/Tag (Text & PLine)",
            "description": "A dynamic text label displaying package info, attached via a leader line.",
            "appliedTo": "Model Space (at insertion point or grip location)"
          },
          {
            "type": "Property Set Data",
            "description": "Updates 'Stacking' properties (Number, Wrapping) on the individual timber elements within the package.",
            "appliedTo": "Selected Entity/Body array"
          },
          {
            "type": "MapX Data",
            "description": "Stores the calculated total weight of the package for data export.",
            "appliedTo": "Script Instance (f_Package)"
          }
        ]
      },
      "tokens_used": 9460,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Launch Script: User selects entities (Beams/Bodies) to be grouped into a package.\",\n    \"2. Insert Point: User specifies the insertion point (_Pt0) for the package script.\",\n    \"3. Initialization: Script reads XML defaults (TextHeight, GripDistance) and stores references to selected entities.\",\n    \"4. Property Read: Script retrieves OPM properties (Number, Format, Wrapping, Colors, Transparencies).\",\n    \"5. Entity Retrieval: Script fetches the array of referenced entities from the script instance.\",\n    \"6. Validation Check: Verify if entity array is populated.\",\n    \"7. Geometry Calculation: Generate 3D bounding box (PlaneProfile) and shadow profiles of all items.\",\n    \"8. Weight Calculation: Sum weights. Checks individual item MapX ('f_Item') first, otherwise calculates Volume * Density. Adds Bedding factor.\",\n    \"9. Conditional Check: Is 'KLH' Project Special active?\",\n    \"10. KLH Logic: If yes, identify Bottom"
      },
      "tokens_used": 11338,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# f_Package.mcr\n\n## Overview\nThis script groups selected timber elements (beams, walls, or bodies) into a logical transport or production package. It automatically calculates the total weight, generates a 3D visual bounding box, and applies labels and property data to the contained items.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script processes 3D geometry and attaches properties to entities in Model Space. |\n| Paper Space | No | This script does not function in Layouts/Sheet views. |\n| Shop Drawing | No | This script is for the 3D model, not 2D manufacturing drawings. |\n\n## Prerequisites\n- **Entities**: You must have existing timber elements (Beams, Bodies, or Elements) in the model to package.\n- **Property Sets**: A Property Set Definition named \"Stacking\" must exist in your project to store data on the individual elements.\n- **Settings File**: An XML configuration file (usually `f_Package.xml`) must be present in your hsbCAD configuration path to define wrapping materials and default visual settings.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or `TSL`) → Select `f_Package.mcr` from the file list.\n\n### Step 2: Select Elements\n```\nCommand Line: Select entities:\nAction: Click on the timber beams, walls, or bodies you want to include in the package. Press Enter to confirm selection.\n```\n\n### Step 3: Specify Insertion Point\n```\nCommand Line: Specify insertion point:\nAction: Click in the Model Space to place the package script (usually near the grouped items). This point acts as the anchor for the package label.\n```\n\n### Step 4: Configure Properties\nAction: Once inserted, select the new Package object and open the **Properties Palette** (Ctrl+1). Adjust the Package Number, Wrapping type, or Label Format as needed.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Number | Integer | 1 | The unique ID for this package (e.g., Palette 1). Updates the \"Package Number\" property on all contained items. |\n| Format | String | @(Name) | Determines the text displayed on the label. Use tokens like `@(Name)`, `@(Number)`, or `@(Weight)`. |\n| TextHeight | Double | 100 mm | Sets the height of the text characters on the label for visibility. |\n| Style | Integer | 0 | Visual style of the label background (0=None, 1=Frame, 2=Filled). |\n| Grouping | String | Default | Defines a category for the package, used for filtering or reporting. |\n| Wrap | String | None | Select the packaging material (e.g., Foil, Cardboard). Updates the \"Package Wrapping\" property on items. |\n| MaxBedding | Double | 0 kg/m³ | Adds extra weight to the total calculation for packing materials (nails, straps, foil). |\n| Color | Integer | 12 | The AutoCAD color index for the 3D bounding box visualizer. |\n| TransparencyTruck | Integer | 60 | Sets the opacity of the bounding box (0=Invisible/Transparent, 90=Solid). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the bounding box geometry and total weight if the contained elements have been modified or moved. |\n| Select Entities | Re-selects the beams and bodies currently assigned to this package for verification. |\n\n## Settings Files\n- **Filename**: `f_Package.xml` (or project-specific XML)\n- **Location**: `hsbCompany` or `hsbInstall` directory.\n- **Purpose**: Stores default values for the `GripDistanceOnInsert`, `ContourThickness` (visual thickness of wrapping), and the list of available Wrapping materials.\n\n## Tips\n- **Weight Accuracy**: The script first checks for an existing `f_Item` weight on individual elements. If not found, it calculates `Volume * Density`. Use `MaxBedding` to add a safety margin for packaging materials.\n- **Visualization**: If the bounding box is obscuring your view of the timber, lower the `TransparencyTruck` value (e.g., set to 40 or 50).\n- **Data Export**: Ensure your \"Stacking\" property set is mapped correctly if you intend to export the package data to production lists (e.g., CSV/Presto).\n\n## FAQ\n- **Q: Why is my label text empty?**\n  **A**: Check the `Format` property. Ensure you have included valid tokens like `@(Name)` or `@(Weight)` inside the string.\n- **Q: Why is the calculated weight zero?**\n  **A**: Verify that the timber elements inside the package have a Material assigned with a valid Density defined in the catalog.\n- **Q: Can I add more items to an existing package?**\n  **A**: Currently, you usually need to delete the script and re-run it, or manually edit the script's entity list (if permissions allow), but the standard workflow is to re-select all items."
      },
      "tokens_used": 5418,
      "error": null
    }
  }
}