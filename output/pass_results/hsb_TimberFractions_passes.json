{
  "filename": "hsb_TimberFractions.mcr",
  "status": "completed",
  "total_tokens": 36960,
  "processing_time": 225.60986256599426,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 3491,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to prompt user selection of Elements and getPoint for placement. Draws text via Display class at _Pt0. Lacks sd_ prefix, #Type E declaration, or _Viewport handling typical of Paper Space/ShopDrawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Requires user to select valid ElementWall entities from the model during insertion.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4383,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "Pick a Point to show result.",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Please select elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Property Dialog (Generic)",
            "trigger": "During Insert (showDialogOnce)",
            "title": null,
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sWalls",
            "type": "PropString",
            "displayName": "Wall codes for calculation",
            "defaultValue": "EA;EB;",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Please set the wall codes that should be used for the calculations. To add more than 1 use ';' after each code"
          },
          {
            "index": 0,
            "variable": "dSoleplateHeight",
            "type": "PropDouble",
            "displayName": "Soleplate thickness]",
            "defaultValue": 38,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Text Color|",
            "defaultValue": 7,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dHeadbinderHeight",
            "type": "PropDouble",
            "displayName": "Headbinder height",
            "defaultValue": 38,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sFilterByMaterial",
            "type": "PropString",
            "displayName": "Exclude sheets by material",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Set the material os the sheets that will be excluded from the volume calculation. To add more than 1 use ';' after each material"
          },
          {
            "index": 2,
            "variable": "dMinimumInsulationDepth",
            "type": "PropDouble",
            "displayName": "Minimum insulation depth",
            "defaultValue": 50,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sOutputKey",
            "type": "PropString",
            "displayName": "Output Key",
            "defaultValue": "TimberFraction",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6144,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates the percentage of timber volume relative to the total element volume for selected walls, excluding specific sheathing materials and accounting for openings.",
          "category": "Analysis/Reporting",
          "typicalUseCase": "Used during the design or estimation phase to generate a report or label indicating the timber density of a wall construction, often required for fire calculations or environmental material declarations."
        },
        "parameters": [
          {
            "name": "sWalls",
            "technicalDefault": "EA;EB;",
            "businessMeaning": "Defines which wall types (based on their Element Codes) are included in the calculation. This allows targeting specific external or internal wall types.",
            "validRange": "Valid Element Codes defined in the project (e.g., EA, EB, IN).",
            "unit": "String",
            "affectsOutput": "Filters which ElementWall entities are processed. Walls not matching these codes are ignored."
          },
          {
            "name": "dSoleplateHeight",
            "technicalDefault": 38,
            "businessMeaning": "The height (thickness) used to calculate the volume of the bottom plate. This overrides the actual modeled height to allow for standardized calculations or nominal dimension usage.",
            "validRange": "0 - 200 mm",
            "unit": "mm",
            "affectsOutput": "Increases the calculated Timber Volume and Total Element Volume, impacting the final percentage."
          },
          {
            "name": "dHeadbinderHeight",
            "technicalDefault": 38,
            "businessMeaning": "The height (thickness) used to calculate the volume of the top plate. This overrides the actual modeled height for standardized calculations.",
            "validRange": "0 - 200 mm",
            "unit": "mm",
            "affectsOutput": "Increases the calculated Timber Volume and Total Element Volume, impacting the final percentage."
          },
          {
            "name": "dMinimumInsulationDepth",
            "technicalDefault": 50,
            "businessMeaning": "The distance from the bottom of the wall element where the cross-sectional slice is taken to calculate the timber content (studs). This ensures the calculation ignores top/bottom plates or sheathing at the edges.",
            "validRange": "0 - Wall Height mm",
            "unit": "mm",
            "affectsOutput": "Shifts the cutting plane up from the bottom face. If set incorrectly, it may cut through voids or plates instead of studs, skewing the area calculation."
          },
          {
            "name": "sFilterByMaterial",
            "technicalDefault": "",
            "businessMeaning": "Excludes specific materials (e.g., OSB, Plywood, Gypsum) from the 'Total Element Volume' calculation, so the fraction represents Timber vs (Timber + Insulation) rather than Timber vs (Timber + Insulation + Sheathing).",
            "validRange": "Catalog Material names (e.g., OSB;Gypsum;)",
            "unit": "String",
            "affectsOutput": "Removing materials reduces the Total Element Volume (denominator), resulting in a higher Timber Fraction percentage."
          },
          {
            "name": "sOutputKey",
            "technicalDefault": "TimberFraction",
            "businessMeaning": "Identifier used to link script properties to a specific preset in the catalog database.",
            "validRange": "Catalog Key Strings",
            "unit": "String",
            "affectsOutput": "No direct geometric effect; used for property management and initialization."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Specifies the dimension style to use for the text output in the model view.",
            "validRange": "Available DimStyles in the drawing",
            "unit": "String",
            "affectsOutput": "Visual appearance (font, size) of the result label."
          },
          {
            "name": "nColor",
            "technicalDefault": 7,
            "businessMeaning": "Sets the AutoCAD color index for the result text label.",
            "validRange": "0 - 255 (ACI)",
            "unit": "Integer",
            "affectsOutput": "Color of the result label."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing sFilterByMaterial",
            "effect": "Modifies the total volume used as the denominator in the percentage calculation.",
            "cascade": [
              "dVolumeOfElements",
              "dTimberFraction"
            ]
          },
          {
            "trigger": "Changing dSoleplateHeight or dHeadbinderHeight",
            "effect": "Modifies the volume of plates added to both Timber Volume and Total Volume.",
            "cascade": [
              "dVolumeOfTimber",
              "dVolumeOfElements",
              "dTimberFraction"
            ]
          },
          {
            "trigger": "Changing dMinimumInsulationDepth",
            "effect": "Moves the cutting plane used to analyze the cross-section of the studs.",
            "cascade": [
              "dVolumeOfTimber",
              "dTimberFraction"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation Text",
            "description": "Draws a text label at the selected pick point displaying 'Timber fraction: XX.XX%'.",
            "appliedTo": "Model Space at user defined point (_Pt0)"
          },
          {
            "type": "Data Map (SubMap)",
            "description": "Writes the calculated percentage to the instance data under the key 'TimberFractions'.",
            "appliedTo": "Script Instance (_ThisInst)"
          }
        ]
      },
      "tokens_used": 7481,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Set unit to mm, initialize properties, and load catalog values if creating from database.",
          "2. Insertion Check: Verify if the script is being inserted for the first time.",
          "3. Duplicate Instance Handling: If insertCycleCount > 1, erase the current instance and exit.",
          "4. Input Collection: Prompt user for a result location point (_Pt0) via getPoint.",
          "5. Element Selection: Prompt user to select Elements via PrEntity.",
          "6. Entity Filtering: Iterate through selected entities, casting them to ElementWall and appending valid ones to the _Element array.",
          "7. Validation: Check if _Element array is empty. If true, erase instance and exit.",
          "8. Property Parsing: Parse 'sWalls' string into an array of uppercase wall codes (arSCodeWalls).",
          "9. Material Parsing: Parse 'sFilterByMaterial' string into an array of uppercase material names (arSheetMaterials).",
          "10. Display Setup: Initialize Display object with specified color and dimstyle.",
          "11. Iteration Loop: Iterate through all collected ElementWall entities.",
          "12. Code Check: For each wall, check if its code exists in 'arSCodeWalls'. If not, skip to next element.",
          "13. Geometry Calculation: Calculate coordinate system vectors and wall thickness (dZone0Thickness).",
          "14. Cutting Plane Definition: Define a plane at 'dMinimumInsulationDepth' above the wall bottom.",
          "15. Openings Analysis: Aggregate all wall openings into a single PlaneProfile (ppOpenings), applying specific geometric tolerances (side 50, top 175, bottom 50).",
          "16. Volume Calculation (Loop -5 to 5): Iterate through wall zones to calculate total volume.",
          "17. Material Exclusion: Check zone material against 'arSheetMaterials'. If found, exclude from volume calculation.",
          "18. Total Volume Summation: Add zone volume (Area * Height) to 'dVolumeOfElements'.",
          "19. Timber Volume Calculation (Beams): Iterate through all beams in the wall.",
          "20. Plate Volume Calculation: Calculate volume for bottom and top plates using user-defined heights (dSoleplateHeight, dHeadbinderHeight). Add to both timber and total volume.",
          "21. Stud Volume Calculation: Slice beam geometry with the cutting plane. Subtract openings from the slice profile.",
          "22. Stud Area Validation: If the resulting slice area is > 0.001, add area * dZone0Thickness to 'dVolumeOfTimber'.",
          "23. Final Calculation: Convert volumes to cubic meters. Calculate percentage: (dVolumeOfTimber / dVolumeOfElements) * 100.",
          "24. Volume Check: If volumes are too small (<0.01 m^3), erase instance and exit.",
          "25. Visualization: Draw text label 'Timber fraction: XX.XX%' at _Pt0.",
          "26. Data Export: Write the percentage to the instance SubMap 'TimberFractions' under key 'Percentage'.",
          "27. Completion: Script finishes execution."
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert is true (Script is being inserted)",
            "path1": {
              "name": "Insertion Path",
              "steps": [
                "Check insertCycleCount",
                "Show dialog if needed",
                "Prompt for Point (_Pt0)",
                "Prompt for Element Selection (PrEntity)",
                "Populate _Element array",
                "Validate _Element count"
              ]
            },
            "path2": {
              "name": "Recalculation Path (OPM Update)",
              "steps": [
                "Skip insertion prompts",
                "Use existing _Element array",
                "Proceed to Calculation Loop"
              ]
            }
          },
          {
            "condition": "insertCycleCount() > 1",
            "path1": {
              "name": "Duplicate detected",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "First Insertion",
              "steps": [
                "Proceed to User Input"
              ]
            }
          },
          {
            "condition": "Element Code check against arSCodeWalls",
            "path1": {
              "name": "Code Matches",
              "steps": [
                "Include Element in calculation",
                "Process zones and beams"
              ]
            },
            "path2": {
              "name": "Code Does Not Match",
              "steps": [
                "Skip Element (Continue to next iteration)"
              ]
            }
          },
          {
            "condition": "Zone Material found in arSheetMaterials",
            "path1": {
              "name": "Material Excluded",
              "steps": [
                "Skip Volume Calculation for this Zone",
                "Continue to next zone"
              ]
            },
            "path2": {
              "name": "Material Included",
              "steps": [
                "Calculate Zone Volume",
                "Add to Total Volume"
              ]
            }
          },
          {
            "condition": "Beam Type (kSFBottomPlate vs kSFTopPlate vs Other)",
            "path1": {
              "name": "Bottom Plate",
              "steps": [
                "Calc volume using dSoleplateHeight",
                "Add to Timber & Total Volume",
                "Skip slice calculation"
              ]
            },
            "path2": {
              "name": "Top Plate",
              "steps": [
                "Calc volume using dHeadbinderHeight",
                "Add to Timber & Total Volume",
                "Skip slice calculation"
              ]
            },
            "path3": {
              "name": "Stud/Other",
              "steps": [
                "Perform Slice at Cutting Plane",
                "Subtract Openings",
                "Calculate Area",
                "Add to Timber Volume"
              ]
            }
          },
          {
            "condition": "Final Volumes (< 0.01)",
            "path1": {
              "name": "Volumes too small/Invalid",
              "steps": [
                "Erase Instance",
                "Exit"
              ]
            },
            "path2": {
              "name": "Valid Volumes",
              "steps": [
                "Draw Text",
                "Save Data"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases duplicate instances."
          },
          {
            "check": "Element Array Count",
            "errorMessage": "None (Silent)",
            "recovery": "If no valid ElementWall entities are selected during PrEntity, the instance is erased. User must re-insert and select valid walls."
          },
          {
            "check": "Element Wall Code vs Property sWalls",
            "errorMessage": "None (Silent)",
            "recovery": "If a selected wall's code is not in the sWalls list, it is ignored. User updates sWalls property to include it."
          },
          {
            "check": "Calculated Volume Threshold (> 0.01 m^3)",
            "errorMessage": "None (Silent)",
            "recovery": "Instance is erased if calculation results in near-zero volume. User should check wall dimensions, material filters, or plate heights."
          },
          {
            "check": "Beam Slice Area (> 0.001)",
            "errorMessage": "None (Silent)",
            "recovery": "Beams with zero or tiny sliced areas (due to being outside the cutting plane or completely inside an opening) contribute 0 to timber volume."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Calculation Parameters",
            "how": "Object Properties Palette (OPM)",
            "effect": "Changing sWalls, dSoleplateHeight, dHeadbinderHeight, dMinimumInsulationDepth, or sFilterByMaterial triggers a recalculation of the percentage and updates the text label immediately."
          },
          {
            "action": "Change Visual Style",
            "how": "OPM (nColor, sDimStyle)",
            "effect": "Updates the color and dimension style of the text label without recalculating geometry."
          },
          {
            "action": "Move Result Label",
            "how": "Grip Edit (Standard AutoCAD point move)",
            "effect": "Relocates the text label to the new point position."
          },
          {
            "action": "Copy/Paste Script",
            "how": "Standard AutoCAD Copy",
            "effect": "The script detects insertCycleCount > 1 and erases the copy, preventing duplication of the analysis instance."
          }
        ]
      },
      "tokens_used": 8354,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_TimberFractions.mcr\n\n## Overview\nCalculates the percentage of timber volume relative to the total element volume for selected walls. It allows you to exclude specific sheathing materials (like OSB or Gypsum) to determine the structural timber fraction, often used for fire calculations or environmental reports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be inserted in the 3D model. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | Not supported for manufacturing drawings. |\n\n## Prerequisites\n- **Required Entities**: Element or ElementWall entities must exist in the model.\n- **Minimum Beam Count**: 0 (This script analyzes Wall elements, not individual beams directly).\n- **Required Settings**: None required to run, but properties should be configured for accurate results.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or `hsb_TimberFractions` if mapped)\nAction: Select the script file `hsb_TimberFractions.mcr` from the file dialog.\n\n### Step 2: Pick Result Location\n```\nCommand Line: Pick a Point to show result.\nAction: Click in the Model Space where you want the text label displaying the percentage to appear.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Please select elements\nAction: Select the Wall elements (ElementWalls) you wish to analyze and press Enter.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Wall codes for calculation | text | EA;EB; | The Element Codes of the walls to include. Separate multiple codes with a semicolon (;). Walls matching these codes are calculated. |\n| Soleplate thickness | number | 38 | The thickness (height) used to calculate the bottom plate volume. |\n| Headbinder height | number | 38 | The thickness (height) used to calculate the top plate volume. |\n| Minimum insulation depth | number | 50 | The distance from the bottom of the wall to measure the stud cross-section. Ensure this is set to hit the studs, avoiding plates or large voids. |\n| Exclude sheets by material | text | | Material names to exclude from the *total* volume calculation (e.g., OSB;Gypsum;). This isolates the timber fraction. Separate multiple materials with a semicolon. |\n| |Text Color| | number | 7 | The AutoCAD color index for the result text. |\n| Output Key | text | TimberFraction | Identifier for catalog presets. |\n| |Dimstyle| | text | _DimStyles | The dimension style used for the text label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add custom items to the right-click context menu. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script operates independently of external settings files.\n\n## Tips\n- **Filtering Walls**: If the script calculates 0% or erases itself immediately, check the **Wall codes for calculation** property. Ensure the codes match the Element Codes of the walls you selected (e.g., \"EA\", \"IN\").\n- **Accurate Volumes**: To calculate the \"Structural Timber Fraction\" (ignoring sheathing), add your sheathing material names to the **Exclude sheets by material** property. This reduces the total volume denominator, resulting in a higher timber percentage.\n- **Cutting Plane**: If your walls have unusual construction, adjust the **Minimum insulation depth**. The script takes a horizontal slice of the wall at this height to determine the stud area.\n- **Updating**: Change any property in the Properties Palette to trigger an automatic recalculation of the text label.\n- **Copying**: If you copy and paste this script, the duplicate instance will automatically erase itself to prevent calculation errors. Re-run the command to create a new analysis.\n\n## FAQ\n- **Q: Why did the text label disappear after I inserted it?**\n  A: This usually happens if the script detected no valid walls matching your codes, or if the calculated volume was too small (near zero). Check your **Wall codes for calculation** and ensure you selected valid ElementWall entities.\n\n- **Q: How do I include multiple wall types?**\n  A: In the **Wall codes for calculation** property, enter them separated by semicolons. For example: `EA;EB;INT;`.\n\n- **Q: The percentage seems too low. How do I fix it?**\n  A: You likely need to exclude sheathing materials. Add materials like `OSB` or `PLYWOOD` to the **Exclude sheets by material** property. This ensures the calculation is Timber vs. (Timber + Insulation) rather than Timber vs. Total Wall Volume.\n\n- **Q: Can I move the text label?**\n  A: Yes. Select the script instance in AutoCAD and use the standard grip point to drag the text to a new location."
      },
      "tokens_used": 7107,
      "error": null
    }
  }
}