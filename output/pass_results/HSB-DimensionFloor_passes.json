{
  "filename": "HSB-DimensionFloor.mcr",
  "status": "completed",
  "total_tokens": 52957,
  "processing_time": 361.47089886665344,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9186,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script prompts for a Viewport using getViewport() and appends it to the _Viewport array. It calculates the Model-to-PaperSpace coordinate system transformation (ms2ps) via vp.coordSys() and transforms dimension geometry using this transformation (e.g., dimBottom.transformBy(ms2ps)) before drawing."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "A Layout (Paper Space) containing a viewport with an associated hsbCAD element.",
          "requiredSettings": [
            "hsbCAD Dimension Styles (_DimStyles)"
          ]
        }
      },
      "tokens_used": 7581,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "Select a viewport.",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDialogOnce",
            "trigger": "On Insert",
            "title": null,
            "dataSource": "Default Property Dialog",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dDimOff",
            "type": "PropDouble",
            "displayName": "Distance dimension line to element",
            "defaultValue": "U(300)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dBetweenDim",
            "type": "PropDouble",
            "displayName": "Distance between dimlines",
            "defaultValue": "U(200)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dTextOffset",
            "type": "PropDouble",
            "displayName": "Distance text",
            "defaultValue": "U(100)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sDimLayout",
            "type": "PropString",
            "displayName": "Dimension layout",
            "defaultValue": "_DimStyles (First Item)",
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dDeltaVertical",
            "type": "PropDouble",
            "displayName": "Distance vertical dims look into the element",
            "defaultValue": "U(500)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dDeltaHorizontal",
            "type": "PropDouble",
            "displayName": "Distance horizontal dims look into the element",
            "defaultValue": "U(500)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sSideHorDim",
            "type": "PropString",
            "displayName": "Dimension side vertical beams",
            "defaultValue": "Center",
            "inputType": "dropdown",
            "options": [
              "Left",
              "Center",
              "Right"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sDimFirstJoist",
            "type": "PropString",
            "displayName": "Dimension first joist",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9652,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates detailed floor dimensions (joist spacing, openings, and overall lengths) in Paper Space layouts based on 3D model geometry.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used during the creation of production drawings to annotate floor layouts with precise measurements without manual drafting, ensuring dimensions update if the model changes."
        },
        "parameters": [
          {
            "name": "dDimOff",
            "technicalDefault": "300",
            "businessMeaning": "The clear distance between the outer edge of the floor element and the first dimension line.",
            "validRange": "100 - 1000",
            "unit": "mm",
            "affectsOutput": "Moves the entire stack of dimension lines closer to or further away from the floor outline in the drawing."
          },
          {
            "name": "dBetweenDim",
            "technicalDefault": "200",
            "businessMeaning": "The vertical spacing between stacked dimension lines (e.g., between the joist spacing dimension and the total length dimension).",
            "validRange": "100 - 500",
            "unit": "mm",
            "affectsOutput": "Adjusts the gap between parallel dimension lines to prevent text overlap or to compress the drawing view."
          },
          {
            "name": "dTextOffset",
            "technicalDefault": "100",
            "businessMeaning": "The offset distance for descriptive text labels (like 'Total length' or 'Beams') relative to their associated dimension line.",
            "validRange": "50 - 250",
            "unit": "mm",
            "affectsOutput": "Positions the text labels above/below or left/right of the dimension lines."
          },
          {
            "name": "sDimLayout",
            "technicalDefault": "_DimStyles (First Item)",
            "businessMeaning": "Selects the CAD dimension style (text height, arrowheads, precision) to be used for the dimensions.",
            "validRange": "Project Dimension Styles List",
            "unit": "String",
            "affectsOutput": "Changes the visual appearance and scale of the dimensions (font size, tick marks) to match drafting standards."
          },
          {
            "name": "dDeltaVertical",
            "technicalDefault": "500",
            "businessMeaning": "The search depth inward from the vertical edges of the floor to locate beams for dimensioning.",
            "validRange": "0 - Max Floor Depth",
            "unit": "mm",
            "affectsOutput": "Determines how far from the left/right edge the script looks for internal joists to mark. If set too low, internal joists near the center might be missed."
          },
          {
            "name": "dDeltaHorizontal",
            "technicalDefault": "500",
            "businessMeaning": "The search depth inward from the horizontal edges of the floor to locate beams for dimensioning.",
            "validRange": "0 - Max Floor Width",
            "unit": "mm",
            "affectsOutput": "Determines how far from the top/bottom edge the script looks for internal members to mark."
          },
          {
            "name": "sSideHorDim",
            "technicalDefault": "Center",
            "businessMeaning": "Specifies on which side of the vertical beams (trimmers/studs) the horizontal dimensions should be placed.",
            "validRange": "Left, Center, Right",
            "unit": "Option",
            "affectsOutput": "Relocates the dimension line relative to the vertical members (e.g., aligning dimensions to the left face, centerline, or right face of the beam)."
          },
          {
            "name": "sDimFirstJoist",
            "technicalDefault": "No",
            "businessMeaning": "Toggles whether the rim joist (outer band joist) is included in the joist spacing dimensions.",
            "validRange": "Yes, No",
            "unit": "Option",
            "affectsOutput": "If 'No', dimensions start from the second joist, often used to avoid cluttering the rim joist area. If 'Yes', the outer joist is dimensioned."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing Viewport Scale",
            "effect": "The text size and arrow scale defined in 'sDimLayout' are automatically adjusted to remain legible at the new scale.",
            "cascade": [
              "sDimLayout"
            ]
          },
          {
            "trigger": "Adjusting 'dDimOff'",
            "effect": "The position of the first dimension line shifts, which implicitly shifts all subsequent dimension lines stacked on top of it.",
            "cascade": [
              "dBetweenDim"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Dimensions",
            "description": "Linear dimensions indicating overall lengths, center-to-center spacing of joists, and positions of openings/voids.",
            "appliedTo": "Paper Space Viewport (referencing Model Space Element)"
          },
          {
            "type": "Text Labels",
            "description": "Annotations identifying dimension groups (e.g., 'Total length', 'Beams').",
            "appliedTo": "Paper Space Viewport"
          }
        ]
      },
      "tokens_used": 9593,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Start Script / Execute Command",
          "2. Check Insertion Flag (_bOnInsert)",
          "3. [Insertion Branch] Prompt user to 'Select a viewport.' using getViewport",
          "4. [Insertion Branch] Append selected Viewport to _Viewport array",
          "5. [Insertion Branch] Show Default Property Dialog (showDialogOnce)",
          "6. [Insertion Branch] Save and Exit (Return)",
          "7. [Recalculation Branch] Verify _Viewport array has elements",
          "8. [Recalculation Branch] Retrieve last Viewport and associated Element",
          "9. [Recalculation Branch] Validate Element validity (bIsValid)",
          "10. [Recalculation Branch] Calculate Coordinate Systems (Model-to-PaperSpace, Element CS)",
          "11. [Recalculation Branch] Set up Display properties (Dimension Style, Scale)",
          "12. [Recalculation Branch] Iterate through Element Beams to calculate Bounding Box (Min/Max X/Y)",
          "13. [Recalculation Branch] Determine Extreme Points (Top-Left, Top-Right, Bottom-Left, Bottom-Right)",
          "14. [Recalculation Branch] Internal Geometry Processing (Sort beams/joists, identify openings - TRUNCATED CODE)",
          "15. [Recalculation Branch] Generate Joist/Beam Dimensions (Bottom Side)",
          "16. [Recalculation Branch] Generate Overall Length Dimensions (Left, Right, Top, Bottom)",
          "17. [Recalculation Branch] Transform geometry to Paper Space (ms2ps)",
          "18. [Recalculation Branch] Draw Dimensions and Text Labels",
          "19. [Debug Branch] If Debug Mode active, draw wireframe geometry for Beams and Sheets",
          "20. Finish"
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert flag check",
            "path1": {
              "name": "New Insertion",
              "steps": [
                "Prompt for Viewport selection",
                "Open Property Dialog",
                "Initialize script instance",
                "Exit script immediately"
              ]
            },
            "path2": {
              "name": "Recalculation / Update",
              "steps": [
                "Read existing properties and Viewport data",
                "Re-run geometry extraction logic",
                "Redraw dimensions based on current state"
              ]
            }
          },
          {
            "condition": "Viewport Element Validity",
            "path1": {
              "name": "Valid Element",
              "steps": [
                "Proceed to Coordinate System calculation",
                "Generate dimensions"
              ]
            },
            "path2": {
              "name": "Invalid/Empty Element",
              "steps": [
                "Script halts immediately (Return)",
                "No drawing output generated"
              ]
            }
          },
          {
            "condition": "Dimension Point Distance (dEps check)",
            "path1": {
              "name": "Distance > dEps (0.05mm)",
              "steps": [
                "Point is included in dimension array",
                "Dimension segment is drawn"
              ]
            },
            "path2": {
              "name": "Distance <= dEps (Duplicate/Coincident)",
              "steps": [
                "Point is filtered out",
                "Prevents zero-length dimensions"
              ]
            }
          },
          {
            "condition": "Debug Mode (_bOnDebug)",
            "path1": {
              "name": "Debug Active",
              "steps": [
                "Draw Beams in Color 32",
                "Draw Sheet index 1 in Color 2",
                "Draw Sheet index -1 in Color 5 (commented out in code)"
              ]
            },
            "path2": {
              "name": "Production Mode",
              "steps": [
                "Skip debug wireframe drawing",
                "Only draw Dimensions and Text"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "Implicitly enforced by getViewport command. User cannot proceed without selection.",
            "recovery": "User must select a valid Paper Space viewport."
          },
          {
            "check": "Viewport Array Length",
            "errorMessage": "No error shown, script exits silently.",
            "recovery": "Ensure script instance is correctly initialized and linked to a viewport."
          },
          {
            "check": "Element Validity (vp.element().bIsValid())",
            "errorMessage": "No error shown, script exits silently.",
            "recovery": "Ensure the selected viewport displays a valid hsbCAD Element/Model with data."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Dimension Properties",
            "how": "Object Properties Palette (OPM)",
            "effect": "Changing properties like 'dDimOff', 'sDimLayout', or 'sSideHorDim' triggers an immediate recalculation, updating the position and style of the dimensions in Paper Space."
          },
          {
            "action": "Update Model Geometry",
            "how": "Modify 3D Model (Beams/Element)",
            "effect": "The script reads the current state of the beams on recalculation. If the floor layout changes (e.g., joists move), the dimensions update automatically to reflect new positions/lengths."
          },
          {
            "action": "Context Menu Recalc",
            "how": "Right-click script instance -> Recalculate",
            "effect": "Forces a full refresh of all dimension logic without changing properties."
          },
          {
            "action": "Delete Script",
            "how": "Select and Delete / Erase",
            "effect": "Removes all generated dimensions and text from the drawing."
          }
        ]
      },
      "tokens_used": 10605,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB-DimensionFloor.mcr\n\n## Overview\nThis script automates the creation of detailed floor dimensions in Paper Space layouts. It calculates and annotates joist spacing, opening locations, and overall floor lengths based on the 3D model geometry.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | Script operates on Layouts. |\n| Paper Space | Yes | Dimensions are drawn directly in the Layout. |\n| Shop Drawing | Yes | Designed for production floor plans. |\n\n## Prerequisites\n- **Required Entities**: A Layout (Paper Space) containing a Viewport that displays an hsbCAD Element (Floor).\n- **Minimum Beam Count**: 1 (Usually a floor consisting of multiple joists/beams).\n- **Required Settings**: Valid hsbCAD Dimension Styles must exist in the drawing to control text size and arrowheads.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse to and select `HSB-DimensionFloor.mcr`.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select a viewport.\nAction: Click on the viewport frame in your Layout that displays the floor plan you wish to dimension.\n```\n\n### Step 3: Configure Properties\n1. The Properties Palette (or default dialog) will appear automatically.\n2. Adjust the dimension offsets or layout style if needed.\n3. Close the dialog or press Enter to place the script.\n\n### Step 4: Automatic Update\nThe script will immediately calculate the floor geometry and draw the dimensions in Paper Space. If you change the 3D model (e.g., move a joist), right-click the dimension script and select **Recalculate** to update the annotations.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Distance dimension line to element | Number | 300 mm | Sets the gap between the floor edge and the first dimension line. |\n| Distance between dimlines | Number | 200 mm | Controls the vertical spacing between stacked dimension lines. |\n| Distance text | Number | 100 mm | Sets the offset distance for text labels (e.g., \"Total length\") from the dimension line. |\n| Dimension layout | Dropdown | (Project Default) | Selects the visual style (text height, arrows) from the project's hsbCAD Dimension Styles. |\n| Distance vertical dims look into the element | Number | 500 mm | Defines how far inward from the left/right edges the script searches for internal joists to dimension. |\n| Distance horizontal dims look into the element | Number | 500 mm | Defines how far inward from the top/bottom edges the script searches for internal members to dimension. |\n| Dimension side vertical beams | Dropdown | Center | Places horizontal dimensions relative to vertical beams: Left, Center, or Right face. |\n| Dimension first joist | Dropdown | No | If \"No\", the outer rim joist is excluded from spacing dimensions to reduce clutter. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Refreshes the dimensions based on current model geometry or property changes. |\n| Properties | Opens the parameters palette to adjust offsets and styles. |\n| Erase | Removes the script instance and all generated dimensions. |\n\n## Settings Files\n- **Dimension Styles**: This script relies on the standard `_DimStyles` collection defined in your hsbCAD project or drawing environment, rather than a separate XML configuration file.\n\n## Tips\n- **Clutter Control**: If joist spacing dimensions are too crowded near the rim, set **Dimension first joist** to \"No\".\n- **Adjusting Scale**: The visual size of arrows and text is controlled by the **Dimension layout** property. Select a style that matches your viewport scale (e.g., 1:50 or 1:100).\n- **Moving Dimensions**: To move the entire stack of dimensions further away from the floor, simply increase the **Distance dimension line to element** value.\n\n## FAQ\n- **Q: The script ran, but no dimensions appeared.**\n- **A:** Ensure the Viewport you selected contains a valid hsbCAD Element with visible beams. If the Element is empty or invalid, the script will exit silently.\n- **Q: How do I change the text height of the dimensions?**\n- **A:** You cannot change the text height directly in the script properties. Instead, change the **Dimension layout** property to select a different Dimension Style that has your desired text height settings.\n- **Q: Can I use this on a Roof Element?**\n- **A:** This script is specifically designed for floor layouts (horizontal planes). While it may technically run on roofs, the logic is optimized for floor joist direction and spacing."
      },
      "tokens_used": 6340,
      "error": null
    }
  }
}