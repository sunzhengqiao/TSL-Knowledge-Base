{
  "filename": "TextMarker.mcr",
  "status": "completed",
  "total_tokens": 53879,
  "processing_time": 381.9157247543335,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 1,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl creates textmarkers on genbeams",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "15.03.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-10890 strategy to filter outside beams more tolerant"
          },
          {
            "version": "1.0",
            "date": "15.03.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-10890 initial version of TextMarker"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8757,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly creates instances in Model Space using the flag 'bForceModelSpace = true' within the _bOnInsert block. It modifies 3D geometry by adding tools ('gb.addTool(ft)') to GenBeam entities rather than creating 2D drawing entities. It interacts directly with Element and GenBeam objects in the 3D model."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7392,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"Select elements or individual genbeams\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrPoint\",\n        \"promptOriginal\": \"Select point (optional)\",\n        \"condition\": \"_bOnInsert && _GenBeam.length()==1\",\n        \"required\": false\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"showDialog\",\n      \"trigger\": \"Insertion (_bOnInsert && _kExecuteKey is empty)\",\n      \"title\": null,\n      \"dataSource\": \"OPM Properties\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sFormat\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Format\",\n      \"defaultValue\": \"@(ElementNumber)_@(ProjectName)_@(ProjectComment)\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Content\",\n      \"description\": \"Defines the Format\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dTextHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Text Height\",\n      \"defaultValue\": \"60\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Content\",\n      \"description\": \"Defines the text height\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sTextOrientation\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Text Orientation\",\n      \"defaultValue\": \"Outside\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Outside\",\n        \"XZ-Plane\",\n        \"XY-Plane\",\n        \"YZ-Plane\",\n        \"Negative XZ-Plane\",\n        \"Negative XY-Plane\",\n        \"Negative YZ-Plane\"\n      ],\n      \"category\": \"Placement\",\n      \"description\": \"Defines the text orientation 'Outside' is only available for beams associated to zone 0 of an element and applies the marking to the subset of the outer beams\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sTextAlignment\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Alignment\",\n      \"defaultValue\": \"Top-Left\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Top-Left\",\n        \"Top-Center\",\n        \"Top-Right\",\n        \"Center-Left\",\n        \"Center-Center\",\n        \"Center-Right\",\n        \"Bottom-Left\",\n        \"Bottom-Center\",\n        \"Bottom-Right\"\n      ],\n      \"category\": \"Placement\",\n      \"description\": \"Defines the TextAlignment\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dAngle\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Angle\",\n      \"defaultValue\": \"0\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \""
      },
      "tokens_used": 10220,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the application of text labels (production codes, element numbers) onto specific faces of timber beams or wall elements.",
          "category": "Production / Shop Drawing",
          "typicalUseCase": "Marking specific studs or wall plates with assembly numbers or project data to facilitate on-site construction or logistics."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(ElementNumber)_@(ProjectName)_@(ProjectComment)",
            "businessMeaning": "Defines the actual text content to be stamped onto the wood, using dynamic database tokens (e.g., Element Number, Position Name).",
            "validRange": "Any string supported by hsbCAD format tokens (e.g., @(ElementNumber), @(Length)).",
            "unit": "text",
            "affectsOutput": "Changes the string value of the FreeText tool generated on the beam."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "60",
            "businessMeaning": "The physical height of the characters stamped/printed on the timber.",
            "validRange": "10 to 200 (Typically 30-100 for readability vs space)",
            "unit": "mm",
            "affectsOutput": "Scales the size of the FreeText geometry; larger text may not fit on narrow beams."
          },
          {
            "name": "sTextOrientation",
            "technicalDefault": "Outside",
            "businessMeaning": "Determines which face of the beam the text is applied to. 'Outside' attempts to find the exterior face of the wall, while planes (XZ, XY, etc.) force alignment to specific geometric axes relative to the beam.",
            "validRange": "List of preset options (Outside, XZ-Plane, XY-Plane, YZ-Plane, Negative variants)",
            "unit": "enum",
            "affectsOutput": "Calculates the insertion coordinate system (Origin and Normal vectors) for the text."
          },
          {
            "name": "sTextAlignment",
            "technicalDefault": "Top-Left",
            "businessMeaning": "The justification point of the text box relative to the insertion point on the beam surface.",
            "validRange": "9-point standard alignment (Top-Left to Bottom-Right)",
            "unit": "enum",
            "affectsOutput": "Shifts the text coordinates along the beam's local axes to ensure it doesn't overlap edges."
          },
          {
            "name": "dAngle",
            "technicalDefault": "0",
            "businessMeaning": "Rotates the text around its own center axis (perpendicular to the face).",
            "validRange": "0 to 360 (or negative for counter-clockwise)",
            "unit": "degrees",
            "affectsOutput": "Rotates the FreeText entity within its plane."
          },
          {
            "name": "sFilter",
            "technicalDefault": "Frame",
            "businessMeaning": "Filters which beams within a selected Element receive the text. This allows marking only the outer plates (Frame), the studs (X-Parallel), or other specific structural subsets.",
            "validRange": "Painter definitions (e.g., Disabled, Frame, X-Parallel, Y-Parallel, Non Orthogonal)",
            "unit": "enum",
            "affectsOutput": "Limits the iteration of GenBeams processed by the script; only beams matching the filter criteria get a tool added."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sTextOrientation set to 'Outside'",
            "effect": "Script relies on the Element's geometry to determine the 'Outside' normal vector. Only valid if the beam is part of an Element (Zone 0).",
            "cascade": [
              "sFilter"
            ]
          },
          {
            "trigger": "Selection of a single GenBeam on insertion",
            "effect": "Prompts user for a specific point (PtG0), overriding the automatic center placement logic.",
            "cascade": [
              "sTextAlignment"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "FreeText",
            "description": "Text geometry added as a 'Tool' to the beam, visible in model views and potentially exported to CNC machines as engravings or labels.",
            "appliedTo": "Selected GenBeams or GenBeams contained within selected Elements (filtered by sFilter)."
          }
        ]
      },
      "tokens_used": 9111,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script Initialization: Define constants and register default 'Painter' filters (Frame, X-Parallel, etc.).\",\n    \"2. Insertion Phase: Check if a specific execution key (catalog entry) was passed.\",\n    \"3. [Conditional] Property Input: If no key was passed, open the Properties Palette (OPM) for user input (Format, Height, Alignment, Filter, etc.).\",\n    \"4. Selection Prompt: User selects Elements or individual GenBeams via PrEntity.\",\n    \"5. [Conditional] Point Input: If exactly one GenBeam was selected, prompt the user to select a specific point (PrPoint) for text placement.\",\n    \"6. Instance Creation: The script erases the temporary instance and creates new TSL instances attached to the selected Elements or GenBeams.\",\n    \"7. Calculation Phase (New Instances): Retrieve references (Element or Beam) and resolve the coordinate system.\",\n    \"8. [Conditional] Context Resolution: If attached to a GenBeam, attempt to retrieve the parent Element. If found, update context and recalculate.\",\n    \"9. Filtering Loop: Iterate through relevant GenBeams. Apply the 'Filter' property (Painter logic) to skip non-matching beams.\",\n    \"10. Geometry Calculation: Determine the text plane (Normal/Direction vectors) based on 'Text Orientation' (Outside vs. Plane-specific).\",\n    \"11. Placement Logic: Calculate text origin based on 'Alignment' properties. Apply specific point if 'Grip Point' exists.\",\n    \"12. Tool Generation: Create FreeText geometry and add it as a tool to the GenBeam(s). Handle multiline text (\\\\P) by creating stacked tools.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"User Input Source during Insertion\",\n      \"path1\": {\n        \"name\": \"Silent/Catalog Insertion\",\n        \"steps\": [\n          \"Script executed with _kExecuteKey\",\n          \"Properties loaded from Catalog entry\",\n          \"Skip dialog prompt\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Interactive Insertion\",\n        \"steps\": [\n          \"Script executed normally\",\n          \"Properties Palette (OPM) displayed\",\n          \"User modifies values manually before confirmation\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Type of Entity Selected\",\n      \"path1\": {\n        \"name\": \"Element Selection\",\n        \"steps\": [\n          \"User selects Element (Wall/Frame)\",\n          \"TSL instance attached to Element\",\n          \"Process all GenBeams within Element\",\n          \"Use Element coordinate system for alignment\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"GenBeam Selection\",\n        \"steps\": [\n          \"User selects specific Beam(s)\",\n          \"TSL instance attached to GenBeam(s)\",\n          \"Process only selected GenBeam(s)\",\n          \"Use Beam coordinate system\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Number of GenBeams Selected\",\n      \"path1\": {\n        \"name\": \"Single Beam\",\n        \"steps\": [\n          \"Prompt user for insertion point (PrPoint)\",\n          \"Store point in _PtG0 (Grip Point)\",\n          \"Allow manual repositioning via grip after insertion\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Multiple Beams or Element\",\n        \"steps\": [\n          \"Skip point prompt\",\n          \"Calculate position automatically based on Alignment settings\",\n          \"Apply text to all filtered beams\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Text Orientation Setting\",\n      \"path1\": {\n        \"name\": \"Outside\",\n        \"steps\": [\n          \"Attempt to find outer face of the element (Zone 0)\",\n          \"Use Element BodyMarker to determine 'Outside' direction\",\n          \"Skip beams that do not have a valid 'Outside' face\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Geometric Plane (e.g., XZ, XY)\",\n        \"steps\": [\n          \"Ignore Element orientation\",\n          \"Force text plane to align with global or beam geometric axes\",\n          \"Apply even if beam is isolated from Element\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Element Reference\",\n      \"errorMessage\": \"Element reference not found.\",\n      \"recovery\": \"Script erases itself. User must ensure the beam is part of a valid element or use the GenBeam-only mode without 'Outside' orientation dependency.\"\n    },\n    {\n      \"check\": \"Insert Cycle\",\n      \"errorMessage\": \"(Silent)\",\n      \"recovery\": \"Script checks insertCycleCount(). If > 1, it erases itself to prevent duplicate processing during the same insertion event.\"\n    },\n    {\n      \"check\": \"Painter Filter Compatibility\",\n      \"errorMessage\": \"(Silent)\",\n      \"recovery\": \"If the selected 'Filter' (Painter) does not match the beam properties (e.g., Filtering for 'Frame' on a 'Stud'), the beam is silently skipped in the loop.\"\n    },\n    {\n      \"check\": \"Outside Orientation Validity\",\n      \"errorMessage\": \"(Silent)\",\n      \"recovery\": \"If 'Outside' is selected but the beam is not on the exterior or cannot be projected to the element boundary, the beam is skipped.\"\n    }\n  ],\n  \"postInsertionActions\": [\n    {\n      \"action\": \"Modify Text Properties\",\n      \"how\": \"OPM Properties Palette\",\n      \"effect\": \"Updates Format string, Text Height,"
      },
      "tokens_used": 11551,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# TextMarker.mcr\n\n## Overview\nThis script automates the application of text labels (production codes, element numbers) onto specific faces of timber beams or wall elements. It is used to mark assembly numbers or project data directly on the 3D model for fabrication or on-site identification.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in 3D model space to add tools to beams. |\n| Paper Space | No | Not designed for 2D drawing views. |\n| Shop Drawing | No | Modifies the 3D entity, not the 2D layout. |\n\n## Prerequisites\n- **Required Entities:** GenBeams (timber beams) or Elements (walls/roofs).\n- **Minimum Beam count:** 0 (Depends on selection; script applies to selected entities).\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `TextMarker.mcr`\n\n### Step 2: Configure Properties\nUpon launching, the Properties Palette (OPM) will display.\n- Adjust settings like **Text Height**, **Format**, and **Orientation** as needed before proceeding.\n\n### Step 3: Select Entities\n```\nCommand Line: Select elements or individual genbeams\nAction: Click on a Wall/Element or select specific GenBeams in the drawing.\n```\n\n### Step 4: [Optional] Pick Insertion Point\n*This step only appears if you selected exactly one GenBeam in Step 3.*\n```\nCommand Line: Select point (optional)\nAction: Click on the specific location on the beam where you want the text center to be placed. \nNote: If skipped, the text is placed automatically based on Alignment settings.\n```\n\n### Step 5: Processing\nThe script will create the text markers on the selected beams based on your Filter and Orientation settings.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | Text | `@(ElementNumber)_@(ProjectName)_@(ProjectComment)` | The text content to be stamped. Use tokens like `@(ElementNumber)` to pull data from the database. |\n| Text Height | Number | `60` | The physical height of the text characters in millimeters. |\n| Text Orientation | Dropdown | `Outside` | Determines which face the text is applied to. **Options:** Outside, XZ-Plane, XY-Plane, YZ-Plane, Negative variants. *Note: 'Outside' requires the beam to be part of a wall element.* |\n| Alignment | Dropdown | `Top-Left` | The justification point relative to the insertion point (e.g., Top-Left, Center-Center, Bottom-Right). |\n| Angle | Number | `0` | Rotation angle of the text in degrees. |\n| Filter | Dropdown | `Frame` | Filters which beams within a selected Element are marked. **Options:** Disabled, Frame, X-Parallel, Y-Parallel, Non Orthogonal. *Example: Select 'Frame' to mark only top/bottom plates, leaving studs unmarked.* |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Properties | Opens the Properties Palette to modify text content, size, or filter. |\n| Delete | Removes the script instance and the associated text markers. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on the Properties Palette for configuration; no external settings files are required.\n\n## Tips\n- **Marking Walls:** When selecting a whole Element (Wall), use the **Filter** property to avoid marking every single stud. Selecting \"Frame\" will typically mark only the perimeter plates.\n- **\"Outside\" Orientation:** If you select \"Outside\" for orientation but the text disappears, ensure the beam is part of a Wall Element (Zone 0). If marking loose beams, switch to a geometric plane (e.g., XZ-Plane).\n- **Dynamic Text:** You can combine tokens in the **Format** field, such as `Pos: @(ElementNumber) - L: @(Length)`, to create detailed labels.\n- **Grip Points:** If you insert the script on a single beam and pick a point, you can later select the script instance and drag the grip point to move the text to a different location.\n\n## FAQ\n- **Q: Why did my text not appear on some beams?**\n- **A:** Check your **Filter** setting. If set to \"Frame\" or \"X-Parallel,\" beams that do not match this description will be skipped. Also, ensure the **Text Orientation** is valid (e.g., \"Outside\" won't work on interior studs without a clear exterior face).\n\n- **Q: Can I use this for individual loose beams?**\n- **A:** Yes, but change the **Text Orientation** from \"Outside\" to a specific plane (like \"XZ-Plane\" or \"XY-Plane\"), as \"Outside\" relies on the wall element's geometry.\n\n- **Q: How do I display the Project Name on the beam?**\n- **A:** In the **Format** property, type `@(ProjectName)`. You can mix this with text, e.g., `Project: @(ProjectName)`."
      },
      "tokens_used": 6848,
      "error": null
    }
  }
}