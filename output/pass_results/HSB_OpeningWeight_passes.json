{
  "filename": "HSB_OpeningWeight.mcr",
  "status": "completed",
  "total_tokens": 32198,
  "processing_time": 512.4341816902161,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "12/11/2024",
            "author": "Robert Pol",
            "changes": "Pilot version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4687,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses the _kModelSpace constant in the dbCreate function during the _bOnInsert phase. It interacts directly with Opening and Element objects from the 3D model to set SubMapX data. There are no references to _kPaperSpace, Viewport, or drawing generation prefixes (sd_/Multipage)."
        },
        "prerequisites": {
          "requiredEntities": [
            "Opening",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script operates within the 3D model context.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3916,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "Select openings",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Standard",
            "trigger": "Insertion and Loop",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dWeight",
            "type": "PropDouble",
            "displayName": "|Weight|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|Defines the Weight of the opening in Kg.| |Entries 0 will disable the mapX and the hsbCenterOfGravity TSL will ignore the mapX.|"
          },
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "|Text Format|",
            "defaultValue": "@(OpeningStickDescription) - \n @(CenterOfGravity.Weight)",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sDimensionStyle",
            "type": "PropString",
            "displayName": "|Dimension Style|",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [
              "_DimStyles"
            ],
            "category": "|Style|",
            "description": "|Defines the dimstyle for the text of the percentage|"
          },
          {
            "index": 2,
            "variable": "sTextLayer",
            "type": "PropString",
            "displayName": "|Text Layer|",
            "defaultValue": "Tooling",
            "inputType": "dropdown",
            "options": [
              "Tooling",
              "Information",
              "Zone",
              "Element"
            ],
            "category": "|Style|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6521,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Assigns a specific weight value to openings (like windows/doors) for structural load calculations and displays this information as a text label in the model.",
          "category": "Data/Calculation",
          "typicalUseCase": "Used to define the mass of heavy glazing or machinery within openings so that the overall Center of Gravity of the timber element can be calculated accurately by the 'hsbCenterOfGravity' script."
        },
        "parameters": [
          {
            "name": "dWeight",
            "technicalDefault": "0",
            "businessMeaning": "The physical mass of the object inserted into the opening (e.g., window unit) in Kilograms.",
            "validRange": "0 to 500+ (depending on the size and material of the window/door)",
            "unit": "Kg",
            "affectsOutput": "Writes to the SubMapX data. If 0, the opening is ignored in gravity calculations. If > 0, it contributes to the element's total weight. Updates the numerical value in the text label."
          },
          {
            "name": "sFormat",
            "technicalDefault": "@(OpeningStickDescription) - \n @(CenterOfGravity.Weight)",
            "businessMeaning": "Controls the content and layout of the text label displayed at the opening center.",
            "validRange": "Any text string supporting hsbCAD dynamic tokens (e.g., @(Width), @(Height)).",
            "unit": "String",
            "affectsOutput": "Modifies the text drawn in the model. Can include the opening description, dimensions, and the assigned weight."
          },
          {
            "name": "sDimensionStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Determines the graphical appearance (font, text size, color) of the weight label.",
            "validRange": "Any existing Dimension Style in the drawing template.",
            "unit": "Style Name",
            "affectsOutput": "Changes the visual properties of the text entity without altering the data."
          },
          {
            "name": "sTextLayer",
            "technicalDefault": "Tooling",
            "businessMeaning": "Specifies the CAD layer on which the text label is created to manage drawing organization and visibility.",
            "validRange": "Tooling, Information, Zone, Element",
            "unit": "Layer Name",
            "affectsOutput": "Assigns the generated text to the specified layer."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dWeight changes",
            "effect": "Updates the 'CenterOfGravity.Weight' value in the SubMapX and updates the text label if the sFormat includes the weight token.",
            "cascade": [
              "SubMapX Data",
              "Text Label"
            ]
          },
          {
            "trigger": "sFormat changes",
            "effect": "Alters the string composition of the Text Entity output.",
            "cascade": [
              "Text Label"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text Entity",
            "description": "A label placed at the center of the opening displaying the description and weight.",
            "appliedTo": "Model Space (Opening)"
          },
          {
            "type": "SubMapX",
            "description": "Logical data attached to the Opening containing the 'Weight' (double) and 'Center' (Point3d) for use by other scripts.",
            "appliedTo": "Opening Entity"
          }
        ]
      },
      "tokens_used": 4525,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: User executes script (command or catalog insert).",
          "2. Insertion Cycle Check: Script checks insertCycleCount(). If >1, script erases itself to prevent duplicates.",
          "3. Property Initialization: Checks for an execution key (_kExecuteKey).",
          "   [If Key Exists]: Loads properties from the specific catalog entry or '_LastInserted' configuration.",
          "   [If No Key]: Opens the OPM Dialog (showDialog) for manual user input.",
          "4. Selection Loop: Starts an infinite loop to process multiple opening selections.",
          "5. User Input: Prompts user 'Select openings' using PrEntity.",
          "   [If Empty Selection]: Breaks the loop (End Insertion).",
          "   [If Selection Made]: Proceeds to process entities.",
          "6. Instance Creation: Loops through selected openings and creates a new TSL instance attached to each Opening entity.",
          "   Passes the current 'Weight' property to the new instance.",
          "7. Loop Repeat: Shows Dialog again to allow changing properties for the next batch, then repeats selection.",
          "8. Seed Cleanup: The original 'seed' TSL instance is erased.",
          "9. Instance Execution (for each attached TSL):",
          "   a. Validate Opening: Checks if exactly one valid Opening is linked. Erases if invalid.",
          "   b. Validate Element: Retrieves parent Element. Erases if invalid.",
          "   c. Dependency: Sets dependency on the Opening to trigger updates on geometry changes.",
          "   d. Cleanup Duplicates: Scans element for other instances of this script attached to the same opening and erases them.",
          "   e. Calculate Data: Formats text string and calculates the center point of the opening.",
          "   f. Write MapX: Writes 'Weight' and 'Center' data to SubMapX (key: 'CenterOfGravity').",
          "   g. Visual Output: Draws the formatted text at the center of the opening using the specified Layer and Dimension Style."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Script erases itself immediately.",
                "Execution stops."
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Proceeds to Property Initialization."
              ]
            }
          },
          {
            "condition": "Execution Key (_kExecuteKey) Presence",
            "path1": {
              "name": "Key Present (Catalog/Journal)",
              "steps": [
                "Load properties from catalog entry matching the key.",
                "Fallback to '_LastInserted' if key not found.",
                "Skip initial dialog."
              ]
            },
            "path2": {
              "name": "No Key (Standard Insert)",
              "steps": [
                "Execute showDialog().",
                "User must manually confirm or modify properties."
              ]
            }
          },
          {
            "condition": "Entity Selection in Loop",
            "path1": {
              "name": "User presses Enter/Escape (Empty)",
              "steps": [
                "Break selection loop.",
                "Erase seed instance.",
                "Finish script execution."
              ]
            },
            "path2": {
              "name": "User selects Openings",
              "steps": [
                "Create TSL instances for selections.",
                "Show dialog for next iteration.",
                "Restart loop."
              ]
            }
          },
          {
            "condition": "Opening and Element Validation",
            "path1": {
              "name": "Valid Entities",
              "steps": [
                "Proceed to Duplicate Cleanup.",
                "Calculate and Draw."
              ]
            },
            "path2": {
              "name": "Invalid/Missing Entities",
              "steps": [
                "Report error message.",
                "Erase TSL instance."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Opening Assignment",
            "errorMessage": "ScriptName One valid opening needed",
            "recovery": "User must ensure the script is attached to a valid Opening entity in the model."
          },
          {
            "check": "Valid Parent Element",
            "errorMessage": "None (Silent erase)",
            "recovery": "The opening must be properly hosted within an Element. The script self-destructs if the element is invalid."
          },
          {
            "check": "Weight Value (Business Logic)",
            "errorMessage": "None (Controlled by Description)",
            "recovery": "Description states: 'Entries 0 will disable the mapX and the hsbCenterOfGravity TSL will ignore the mapX.' User should input >0 for structural calculations."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Weight (dWeight)",
            "how": "OPM (Properties Palette)",
            "effect": "Updates the 'Weight' value in the SubMapX data structure and updates the text label if the format includes the weight."
          },
          {
            "action": "Modify Text Format (sFormat)",
            "how": "OPM",
            "effect": "Immediately redraws the text label with the new string formatting (e.g., adding dimensions, description)."
          },
          {
            "action": "Modify Visual Style (sDimensionStyle, sTextLayer)",
            "how": "OPM",
            "effect": "Updates the graphical appearance (font, height, layer) of the text label in the drawing."
          },
          {
            "action": "Modify Opening Geometry",
            "how": "Grip Edit / Properties of the Opening",
            "effect": "Script detects dependency change, recalculates the center point, and redraws the text label at the new location."
          },
          {
            "action": "Delete Opening",
            "how": "AutoCAD Erase",
            "effect": "The attached TSL instance is automatically removed/erased."
          }
        ]
      },
      "tokens_used": 6898,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_OpeningWeight.mcr\n\n## Overview\nThis script assigns a specific weight (in Kg) to openings (such as windows or doors) and generates a text label in the model. This data is used by the `hsbCenterOfGravity` script to accurately calculate the structural load and center of gravity for timber elements.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script interacts directly with 3D Opening and Element entities. |\n| Paper Space | No | Not applicable for drawing views. |\n| Shop Drawing | No | Not applicable for manufacturing layouts. |\n\n## Prerequisites\n- **Required Entities**: An existing **Opening** entity hosted within a valid **Element** (Wall/Roof).\n- **Minimum beam count**: None.\n- **Required settings files**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Browse and select `HSB_OpeningWeight.mcr`.\n\n### Step 2: Configure Properties\nUpon launching, the Properties Palette (OPM) will open, or a dialog will appear asking you to configure the settings for the batch of openings you are about to select.\n- **Action**: Enter the **Weight** (Kg) for the window/door unit.\n- **Action**: Adjust the **Text Format** or **Layer** if necessary.\n- **Action**: Close the dialog/Properties Palette to confirm settings.\n\n### Step 3: Select Openings\n```\nCommand Line: Select openings\nAction: Click on the desired openings (windows/doors) in the 3D model. You can select multiple openings at once.\n```\n\n### Step 4: Apply and Continue\n```\nCommand Line: ...\nAction: Press Enter or Right-Click to confirm the selection.\n```\n- The script will attach to the selected openings and draw the text label at their center points.\n- The Properties dialog will re-open, allowing you to enter a different weight for the next batch of openings.\n\n### Step 5: Finish\n```\nAction: Press ESC or make an empty selection (press Enter without selecting) to exit the command.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| |Weight| | Number | 0 | Defines the physical mass of the opening object (e.g., glazing unit) in Kilograms. **Note:** Entering 0 will disable the data mapping, causing the structural gravity calculation to ignore this opening. |\n| |Text Format| | Text | @(OpeningStickDescription) - \\n @(CenterOfGravity.Weight) | Determines the content of the label. You can use dynamic tokens (e.g., @(Width), @(Height)) to display specific opening data. |\n| |Dimension Style| | Dropdown | _DimStyles | Sets the visual style (font, size) for the text label. Select from available styles in your drawing. |\n| |Text Layer| | Dropdown | Tooling | Specifies the CAD layer on which the text label is created. Options include Tooling, Information, Zone, or Element. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | There are no custom context menu options for this script. All modifications are made via the Properties Palette. |\n\n## Settings Files\nNo external settings files are required for this script.\n\n## Tips\n- **Batch Processing**: Use the loop functionality to assign different weights to different types of openings (e.g., 50kg for standard windows, 200kg for sliding doors) in a single command execution without restarting the script.\n- **Structural Calculation**: Ensure you input a value greater than 0 for openings that contain heavy inserts (glass, machinery), otherwise they will be treated as empty holes by the `hsbCenterOfGravity` script.\n- **Visibility**: If the labels clutter your view, you can use the `sTextLayer` property to place them on a layer that is currently frozen or turned off.\n\n## FAQ\n\n**Q: What happens if I set the Weight to 0?**\nA: The script will still draw the label (unless you format the text to hide the weight), but it will **not** write the weight data to the element. Consequently, the structural center of gravity calculation will treat the opening as empty space.\n\n**Q: How do I change the weight after the script is already applied?**\nA: Select the Opening (or the text label generated by the script), open the **Properties Palette (Ctrl+1)**, locate the `HSB_OpeningWeight` section, and modify the `Weight` value. The text label and calculation data will update automatically.\n\n**Q: Can I edit the text label manually?**\nA: No, the text is dynamically generated by the script. To change what it says, modify the `Text Format` property in the palette. You can erase the text entity if you no longer wish to see it, but the weight data will remain attached to the opening until the TSL instance is removed."
      },
      "tokens_used": 5651,
      "error": null
    }
  }
}