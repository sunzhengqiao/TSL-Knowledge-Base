{
  "filename": "GE_HDWR_STRAP_TWIST_HTS.mcr",
  "status": "completed",
  "total_tokens": 50936,
  "processing_time": 382.1127462387085,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9120,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script creates 3D geometry using Body objects (bdLower, bdUp1, etc.), uses U() for unit conversions, and creates Groups for deliverables (setBIsDeliverableContainer). It interacts with Beam and TrussEntity envelopes to position geometry. There is no usage of _Viewport, Sheet, or sd_ prefixes characteristic of Paper Space or Shop Drawing scripts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam",
            "TrussEntity"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 6739,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select a Beam or a Truss Entity",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "\nSelect insertion Point",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getString",
              "promptOriginal": "\nStrap Type\n [HTS16/HTS20/HTS24/HTS28/HTS30/H2.5/H2.5A/H2.5T/H8] <HTS20>",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 4,
              "function": "PrEntity",
              "promptOriginal": "Select an Entitie or Element to attach Display to (Optional)",
              "condition": "_bOnInsert",
              "required": false
            }
          ],
          "keywordOptions": [
            {
              "prompt": "\nStrap Type\n [HTS16/HTS20/HTS24/HTS28/HTS30/H2.5/H2.5A/H2.5T/H8] <HTS20>",
              "options": [
                "HTS16",
                "HTS20",
                "HTS24",
                "HTS28",
                "HTS30",
                "H2.5",
                "H2.5A",
                "H2.5T",
                "H8"
              ]
            }
          ]
        },
        "dialogs": [
          {
            "type": "PrEntity",
            "trigger": "Insertion",
            "title": "Select a Beam or a Truss Entity",
            "dataSource": "Model Space",
            "features": {
              "searchable": false,
              "multiSelect": true
            }
          },
          {
            "type": "PrEntity",
            "trigger": "Insertion",
            "title": "Select an Entitie or Element to attach Display to (Optional)",
            "dataSource": "Model Space",
            "features": {
              "searchable": false,
              "multiSelect": true
            }
          },
          {
            "type": "PrEntity",
            "trigger": "Context Menu",
            "title": "Select an Entities or Elements to attach Display to (Optional)",
            "dataSource": "Model Space",
            "features": {
              "searchable": false,
              "multiSelect": true
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "strStrap",
            "type": "PropString",
            "displayName": "Strap type",
            "defaultValue": "HTS20",
            "inputType": "dropdown",
            "options": [
              "HTS16",
              "HTS20",
              "HTS24",
              "HTS28",
              "HTS30",
              "H2.5",
              "H2.5A",
              "H2.5T",
              "H8"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nDir",
            "type": "PropInt",
            "displayName": "Direction",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "1",
              "-1"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nSide",
            "type": "PropInt",
            "displayName": "Side",
            "defaultValue": 1,
            "inputType": "dropdown",
            "options": [
              "1",
              "-1"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dHeal",
            "type": "PropDouble",
            "displayName": "Heel Height",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Add wall(s) to the display",
            "handler": "_kExecuteKey",
            "action": "Opens PrEntity selection to add Elements/Walls to the display group.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove all walls from the display",
            "handler": "_kExecuteKey",
            "action": "Clears the internal list of attached Elements/Walls.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 7897,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates 3D models and scheduling data for Twist Straps (Simpson Strong-Tie HTS and H-series) used to connect trusses or rafters to top plates for uplift resistance.",
          "category": "Hardware / Connectors",
          "typicalUseCase": "Wind uplift mitigation. The user inserts the script on a truss/rafter entity to place a metal strap that wraps over the top and down the side of the wood member."
        },
        "parameters": [
          {
            "name": "strStrap",
            "technicalDefault": "HTS20",
            "businessMeaning": "Selects the specific manufacturer part number/model of the twist strap. This determines the total length and the distribution of metal above and below the bend.",
            "validRange": "List selection: HTS16, HTS20, HTS24, HTS28, HTS30, H2.5, H2.5A, H2.5T, H8",
            "unit": "String",
            "affectsOutput": "Changes the 3D geometry dimensions (total length, upper leg length, lower leg length) and the description/nomenclature in reports and BOMs."
          },
          {
            "name": "nDir",
            "technicalDefault": 1,
            "businessMeaning": "Controls the orientation of the strap along the axis of the beam (flip direction). It determines which side of the insertion point the strap extends towards along the beam length.",
            "validRange": "1 or -1",
            "unit": "Index",
            "affectsOutput": "Mirrors the strap geometry along the beam's longitudinal axis relative to the insertion point."
          },
          {
            "name": "nSide",
            "technicalDefault": 1,
            "businessMeaning": "Controls the side of the beam where the strap hangs (Left vs Right relative to the beam's vertical axis).",
            "validRange": "1 or -1",
            "unit": "Index",
            "affectsOutput": "Mirrors the strap geometry to the opposite side of the beam."
          },
          {
            "name": "dHeal",
            "technicalDefault": 0,
            "businessMeaning": "Vertical offset for the bottom of the strap (Heel Height adjustment). Allows the strap to extend lower than the insertion point to reach through double top plates or connect to wall studs below.",
            "validRange": "0 to Strap Length (practically 0\" - 12\")",
            "unit": "Inches (internal), Project Units (UI)",
            "affectsOutput": "Extends the lower vertical leg of the strap geometry downward. If set higher than the beam/plate height, it pushes the bottom of the strap further down into the structure."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User changes 'strStrap'",
            "effect": "The script recalculates internal length variables (dLength, dStrapLUp, dStrapLDn) based on the hardware lookup tables.",
            "cascade": [
              "dHeal"
            ]
          },
          {
            "trigger": "User changes 'dHeal'",
            "effect": "Modifies the vertical position of the lower plane (pnLower). If the heel height is greater than the distance between plates, the strap is extended downward.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Body (3D Solid)",
            "description": "The physical representation of the metal strap, including the vertical legs and the horizontal top section/bends.",
            "appliedTo": "Model Space (referenced against the selected Beam or TrussEntity)"
          },
          {
            "type": "Group",
            "description": "Creates a grouping entity named 'X-Twist Straps' under 'X - Hardware' for scheduling and BOM extraction.",
            "appliedTo": "Script Instance / Attached Elements"
          },
          {
            "type": "Data Export (DXA)",
            "description": "Exports attribute data for reports, including the strap type (TH-Item) and quantity.",
            "appliedTo": "Production Reports"
          }
        ]
      },
      "tokens_used": 9549,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins; variables and hardware lookup tables are initialized.",
          "Check Insertion Flag (_bOnInsert):",
          "IF Inserting:",
          "  Prompt user to 'Select a Beam or a Truss Entity' (PrEntity).",
          "  Loop through selection and add valid Beams or TrussEntities to internal list.",
          "  Prompt user to 'Select insertion Point' (getPoint).",
          "  Prompt user for 'Strap Type' via Command Line (getString). Validates input against list (HTS16, HTS20, etc.).",
          "  Prompt user to 'Select an Entity or Element to attach Display to (Optional)' (PrEntity).",
          "  Prepare and Clone script instances:",
          "    Iterate through selected Structural Entities (Beams/Trusses).",
          "    Iterate through selected Wall Elements.",
          "    Filter Walls based on spatial intersection with Structural Entity.",
          "    Create a new instance of the script for each Structural Entity using dbCreate, passing points and properties.",
          "  Erase the original script instance (eraseInstance) and return.",
          "ELSE (Executing on Cloned Instance):",
          "  Identify Host Geometry:",
          "    IF Beams found in script context, use the first Beam's envelope and coordinate system.",
          "    ELSE IF Entities found:",
          "      IF TrussEntity: Iterate through TrussDefinition beams to find the highest beam intersecting the insertion point.",
          "      ELSE IF Beam: Use the Beam's envelope and coordinate system.",
          "    IF No Geometry Found: Report 'No Beams found', erase instance, and exit.",
          "  Validate Geometry Orientation:",
          "    Check if Beam X-axis is parallel to World Z (Vertical).",
          "    IF Parallel: Report 'Wrong Selection***Twist Strap cannot be inserted', erase instance, and exit.",
          "  Check Context Menu Triggers (_kExecuteKey):",
          "    IF 'Add wall(s) to the display': Open PrEntity to select Elements/Walls, append to internal list.",
          "    IF 'Remove all walls from the display': Clear internal list of Elements.",
          "  Calculate Vectors and Coordinate Systems based on Beam orientation, Direction (nDir), and Side (nSide).",
          "  Calculate Geometry Dimensions:",
          "    Retrieve Strap Lengths (Upper/Lower) based on selected Type.",
          "    Check for Map Data (Point Load Cloning):",
          "      IF 'PT_BOTTOM_ON_LOWEST_TOP_PLATE' exists AND Type is H2.5T: Adjust lower leg length dynamically.",
          "      IF 'PT_TOP_ON_HIGHEST_TOP_PLATE' exists AND Type is HTS20: Adjust reference point height.",
          "    Adjust Heel Height (dHeal): Modify lower plane if Heel Height > Beam Height.",
          "  Generate 3D Bodies:",
          "    Create Lower Leg (bdLower) using PLine and extrusion.",
          "    Create Upper Leg (bdUp1/bdUp2) and calculate intersections with Top of Beam.",
          "    Create Horizontal/Top Section (bdUp3) using rotation vectors if Upper Leg length permits.",
          "    Combine all bodies into bdLower.",
          "  Create and Assign Groups:",
          "    Create Group 'X-Twist Straps' under 'X - Hardware'.",
          "    Mark as Deliverable Container.",
          "    Attach script instance and associated Wall Elements to the Group.",
          "  Export Data: Set Model name, Material, and DXA attributes for scheduling.",
          "  Finish execution."
        ],
        "conditionalBranches": [
          {
            "condition": "Selection of Host Entity (TrussEntity vs Beam)",
            "path1": {
              "name": "Beam Selected",
              "steps": [
                "Use _Beam[0] directly.",
                "Extract Envelope and CoordSys.",
                "Proceed to vector calculations."
              ]
            },
            "path2": {
              "name": "TrussEntity Selected",
              "steps": [
                "Get TrussDefinition.",
                "Iterate through sub-beams of truss.",
                "Check intersection with insertion point and compare Z-heights.",
                "Select the highest valid beam as the host.",
                "Transform its local coordinate system to Truss CS."
              ]
            }
          },
          {
            "condition": "Strap Upper Length vs Distance to Top of Beam",
            "path1": {
              "name": "Strap longer than gap to top",
              "steps": [
                "Calculate distance to Top Plane (pnUpper).",
                "Check if Distance < Upper Leg Length (dLU).",
                "Create vertical section hitting Top Plane.",
                "Calculate remaining length.",
                "Create horizontal top section (Bends) extending over the beam.",
                "Create final vertical drop section if material remains."
              ]
            },
            "path2": {
              "name": "Strap fits entirely in gap",
              "steps": [
                "Distance to Top Plane >= Upper Leg Length.",
                "Create vertical section ending at full dLU.",
                "Do not create horizontal or top sections."
              ]
            }
          },
          {
            "condition": "Interaction with Point Load Script (Map Data)",
            "path1": {
              "name": "Cloned by Point Load (H2.5T)",
              "steps": [
                "Check Map for 'PT_BOTTOM_ON_LOWEST_TOP_PLATE'.",
                "Recalculate lower leg length based on map point.",
                "Adjust position to bottom of lower top plate."
              ]
            },
            "path2": {
              "name": "Cloned by Point Load (HTS20)",
              "steps": [
                "Check Map for 'PT_TOP_ON_HIGHEST_TOP_PLATE'.",
                "Move insertion point vertically to match map point.",
                "Place strap from top of highest plate."
              ]
            },
            "path3": {
              "name": "Standard Insertion",
              "steps": [
                "Use user-selected insertion point (_Pt0).",
                "Use standard Heel Height property."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of valid Host Geometry (Beam or TrussEntity) after insertion.",
            "errorMessage": "\nNo Beams found",
            "recovery": "The script self-destructs (eraseInstance). User must insert again and select a valid object."
          },
          {
            "check": "Beam orientation relative to World Z.",
            "errorMessage": "\nWrong Selection***Twist Strap cannot be inserted",
            "recovery": "The script self-destructs. User must select a non-vertical member (e.g., rafter or joist)."
          },
          {
            "check": "User Input for Strap Type",
            "errorMessage": "None explicit, but getString returns default if invalid input is ignored. However, code checks: if(arStrapChoices.find(str)>-1).",
            "recovery": "If user types an invalid string not in the list, it is not added to properties, but since 'str' is used immediately, invalid input might default or fail depending on TSL engine string handling (usually defaults to empty or first if logic allows, though strict logic here implies filtering)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Strap Type",
            "how": "OPM Properties (Strap type)",
            "effect": "Recalculates all dimensions (Upper/Lower lengths) and regenerates 3D geometry immediately."
          },
          {
            "action": "Flip Orientation (Direction/Side)",
            "how": "OPM Properties (Direction: 1/-1, Side: 1/-1)",
            "effect": "Mirrors geometry along the beam axis (Direction) or to the opposite side of the beam (Side) without re-inserting."
          },
          {
            "action": "Adjust Heel Height",
            "how": "OPM Properties (Heel Height)",
            "effect": "Extends or contracts the lower leg of the strap vertically."
          },
          {
            "action": "Manage Wall Associations (Display Groups)",
            "how": "Right-click Context Menu -> 'Add wall(s) to the display' or 'Remove all walls from the display'",
            "effect": "Adds or removes Wall Elements from the internal '_Element' list. These elements are then used to assign the script instance to their 'Z' zone (Entity Set), affecting how the hardware is scheduled or reported per wall."
          },
          {
            "action": "Move Insertion Point",
            "how": "Grip Edit (Dragging the script instance origin/grip)",
            "effect": "_Pt0 updates, recalculating the position relative to the host beam and walls."
          }
        ]
      },
      "tokens_used": 10987,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# GE_HDWR_STRAP_TWIST_HTS.mcr\n\n## Overview\nGenerates 3D models and scheduling data for Simpson Strong-Tie Twist Straps (HTS and H-series). It connects trusses or rafters to top plates to provide wind uplift resistance.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for inserting and visualizing 3D hardware. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | Not applicable. |\n\n## Prerequisites\n- **Required Entities:** At least one Beam or Truss Entity.\n- **Minimum Beam Count:** 1.\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `GE_HDWR_STRAP_TWIST_HTS.mcr`\n\n### Step 2: Select Structural Member\n```\nCommand Line: Select a Beam or a Truss Entity\nAction: Click on the rafter, truss, or joist where the strap will be applied. You can select multiple members if needed.\n```\n\n### Step 3: Locate Insertion Point\n```\nCommand Line: Select insertion Point\nAction: Click in the model to define where the strap will penetrate the member (typically at the heel or bearing point).\n```\n\n### Step 4: Define Strap Type\n```\nCommand Line: Strap Type [HTS16/HTS20/HTS24/HTS28/HTS30/H2.5/H2.5A/H2.5T/H8] <HTS20>\nAction: Type the specific strap code (e.g., HTS20) and press Enter. Pressing Enter without typing defaults to HTS20.\n```\n\n### Step 5: Attach to Wall Display (Optional)\n```\nCommand Line: Select an Entitie or Element to attach Display to (Optional)\nAction: Select a wall or element if you wish to associate this hardware with a specific schedule or wall display group. Press Enter to skip.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Strap type | Dropdown | HTS20 | Selects the hardware model (HTS16, HTS20, HTS24, HTS28, HTS30, H2.5, H2.5A, H2.5T, H8). |\n| Direction | Dropdown | 1 | Flips the strap orientation along the beam axis (1 or -1). |\n| Side | Dropdown | 1 | Flips the strap to the opposite side of the beam (1 or -1). |\n| Heel Height | Number | 0 | Adjusts the vertical extension of the lower leg. Use this for double top plates or to reach wall studs. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add wall(s) to the display | Opens a selection box to choose wall elements. This links the hardware instance to those walls for reporting purposes. |\n| Remove all walls from the display | Removes any previously linked wall elements from this hardware instance. |\n\n## Settings Files\nNone required. All dimensions are internal to the script based on the selected Strap type.\n\n## Tips\n- **Quick Adjustments:** After insertion, select the hardware and use the Properties panel (Ctrl+1) to flip the `Direction` or `Side` without re-inserting.\n- **Double Plates:** If using double top plates, increase the `Heel Height` value to ensure the strap extends through to the bottom plate or wall stud.\n- **Vertical Members:** This script cannot be applied to vertical columns; ensure you select a horizontal or sloped beam/rafter.\n\n## FAQ\n- **Q: Why did I get the error \"Wrong Selection\"?**\n  **A:** You likely selected a vertical beam or an object that is not a valid Beam or Truss Entity. Select a rafter or truss bottom chord and try again.\n- **Q: Can I change the strap size after inserting?**\n  **A:** Yes. Select the strap in the model, open the Properties palette, and change the \"Strap type\" dropdown. The 3D model will update automatically.\n- **Q: How do I make the strap appear on my wall schedule?**\n  **A:** Right-click the strap instance and choose \"Add wall(s) to the display\", then select the relevant wall element."
      },
      "tokens_used": 6644,
      "error": null
    }
  }
}