{
  "filename": "hsbCreateSheetZone.mcr",
  "status": "completed",
  "total_tokens": 49356,
  "processing_time": 253.54168796539307,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl modifies and/or creates a new sheeting zone based on a selected zone. The contour of an existing zone and its sheets is taken and used as base for newly created sheets. If at least one polyline is selected the newly created sheets are build from the intersection of the drawn contour and the existing sheets. Existing sheets will be cut by the contour. In case no polyline has been selected the new sheets will be based on the sheets of the selected zone. New sheets or the source sheets will be transformed to a new zone. All overlaying sheets will be transformed or respectivly cut if based on plines. At least one empty zone must be available on tooling side. The tsl will remain resident, but not visible if the construction is build. It will restore previous zone settings on element deleted.",
        "versionHistory": [
          {
            "version": "1.5",
            "date": "29/08/2024",
            "author": "Marsel Nakuci",
            "changes": "HSB-22549: Fix when reseting color; Fix \"on top of reference zone\" for case with pline"
          },
          {
            "version": "1.4",
            "date": "28/08/2024",
            "author": "Marsel Nakuci",
            "changes": "HSB-22549: Rename properties; consider new sheets created after pline subtract opeation"
          },
          {
            "version": "1.3",
            "date": "14oct2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "HSB-5755 properties reordered and categorized"
          },
          {
            "version": "1.0",
            "date": "10dec15",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8018,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script interacts with Element, Sheet, and ElemZone objects. Performs geometric operations like dbCreate and transformBy on 3D entities. Uses ModelMap and modifies element zones (el.setZone). No usage of Viewport, _kPaperSpace, or sd_ prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing an Element with at least one active zone (thickness > 0)",
          "requiredSettings": []
        }
      },
      "tokens_used": 6903,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getElement",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select polyline(s) which describe the contour to be changed| |(optional)|",
              "condition": "_bOnInsert",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "During _bOnInsert",
            "title": "TSL Properties",
            "dataSource": "TSL Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nRefZone",
            "type": "PropInt",
            "displayName": "|Reference zone|",
            "defaultValue": "Dependent on element zones",
            "inputType": "dropdown",
            "options": [],
            "category": "|Calculation rule|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sShiftRule",
            "type": "PropString",
            "displayName": "|Position of new sheet|",
            "defaultValue": "Integrated in reference zone",
            "inputType": "dropdown",
            "options": [
              "Integrated in reference zone",
              "|On Top of Reference Zone|"
            ],
            "category": "|Calculation rule|",
            "description": "|Specifies wether the source or target object shifts zone assignment.|"
          },
          {
            "index": 0,
            "variable": "dThickness",
            "type": "PropDouble",
            "displayName": "|Thickness|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Sheet|",
            "description": "|Specifies the new thickness|"
          },
          {
            "index": 1,
            "variable": "sName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Sheet|",
            "description": null
          },
          {
            "index": 2,
            "variable": "sMaterial",
            "type": "PropString",
            "displayName": "|Material|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Sheet|",
            "description": null
          },
          {
            "index": 3,
            "variable": "sGrade",
            "type": "PropString",
            "displayName": "|Grade|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Sheet|",
            "description": null
          },
          {
            "index": 4,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "|Color|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Sheet|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7558,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "This script creates or modifies a sheeting layer (zone) on a timber element, derived from an existing reference zone and optionally constrained by a user-drawn polyline contour.",
          "category": "Framing/Construction",
          "typicalUseCase": "Used to add local reinforcement (e.g., thicker OSB under a load point), change material in a specific area (e.g., wet room), or create a specific patch of sheeting with different properties than the rest of the wall."
        },
        "parameters": [
          {
            "name": "nRefZone",
            "technicalDefault": "First available zone index on the element",
            "businessMeaning": "The source material layer (index) from which the geometry is derived. In hsbCAD, zones are numbered (e.g., -1 exterior sheathing, 1 interior sheathing).",
            "validRange": "-5 to 5 (Integer)",
            "unit": "Index/Count",
            "affectsOutput": "Determines which existing sheets are used as the base shape and the starting reference point for the calculation."
          },
          {
            "name": "sShiftRule",
            "technicalDefault": "\"Integrated in reference zone\"",
            "businessMeaning": "Defines how the new sheets relate to the reference zone. 'Integrated' modifies the existing zone (cuts or changes attributes). 'On Top' creates a new zone adjacent to the reference zone.",
            "validRange": "Dropdown List",
            "unit": "Enumeration",
            "affectsOutput": "If 'Integrated', the target zone index is the same as the reference. If 'On Top', the target zone index is incremented (e.g., Zone 1 becomes Zone 2) and existing sheets are offset by the new thickness."
          },
          {
            "name": "dThickness",
            "technicalDefault": "0",
            "businessMeaning": "The thickness of the sheet material to be created or the offset distance for shifting existing sheets.",
            "validRange": "6 mm to 300 mm",
            "unit": "mm",
            "affectsOutput": "Sets the 3D body height of new sheets. In 'On Top' mode without polylines, it acts as the Z-axis offset for existing sheets to make room for the new layer."
          },
          {
            "name": "sName",
            "technicalDefault": "Empty string",
            "businessMeaning": "The logical name or identifier for the sheet material (e.g., 'Structural Sheathing', 'Lining').",
            "validRange": "Alphanumeric string",
            "unit": "Text",
            "affectsOutput": "Updates the 'Name' property of the resulting Sheet entities and potentially the Zone name in the element properties."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "Empty string",
            "businessMeaning": "The material code defining the physical properties (e.g., 'OSB/3', 'Gypsum Board').",
            "validRange": "Catalog-defined codes",
            "unit": "Text",
            "affectsOutput": "Assigns the material class to the sheet, affecting hatching patterns in drawings and data exports."
          },
          {
            "name": "sGrade",
            "technicalDefault": "Empty string",
            "businessMeaning": "The quality grade or standard of the material (e.g., 'C24', 'EN 13986').",
            "validRange": "Catalog-defined codes",
            "unit": "Text",
            "affectsOutput": "Updates the grade attribute for BOM and listing purposes."
          },
          {
            "name": "nColor",
            "technicalDefault": "0 (ByLayer/Standard)",
            "businessMeaning": "The visual color index used to display the sheet in the CAD model and shop drawings.",
            "validRange": "0 to 255 (CAD Index)",
            "unit": "Index",
            "affectsOutput": "Changes the display color of the generated 3D sheet bodies and their projections."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sShiftRule set to \"On Top of Reference Zone\"",
            "effect": "The script changes the target zone index and offsets the Z-coordinates of overlaying sheets.",
            "cascade": [
              "nRefZone",
              "dThickness"
            ]
          },
          {
            "trigger": "dThickness change in 'On Top' mode",
            "effect": "Determines the distance by which existing sheets above the reference zone are translated along the element's Z-axis.",
            "cascade": [
              "sShiftRule"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Sheet",
            "description": "New sheet entities created at the intersection of the reference zone and the polyline (or the full zone).",
            "appliedTo": "The selected Element"
          },
          {
            "type": "Element",
            "description": "Updates the element's zone configuration (ElemZone) to reflect new thicknesses, materials, or new zone indexes.",
            "appliedTo": "The selected Element"
          }
        ]
      },
      "tokens_used": 9833,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Insertion",
          "Check if inserting duplicate cycle (insertCycleCount > 1)",
          "Check for execute key (_kExecuteKey) to load catalog properties",
          "Prompt user to select an Element",
          "Collect available zones from selected Element",
          "Prompt user to select Polyline(s) (Optional)",
          "Compose and Interpret ModelMap to capture Element initial state",
          "Open ShowDynamicDialog for user parameters",
          "Assign instance to Element Group (Resident TSL)",
          "Validation: Check for duplicate scripts on the same side",
          "Validation: Check if construction is built (_bOnElementConstructed) or database created (_bOnDbCreated)",
          "Execution: Determine 'Side' (Left/Right) based on Reference Zone sign",
          "Check for presence of Polylines (bHasPLines)",
          "Construct new Sheets or modify existing ones based on Polylines and Shift Rules",
          "Update Element Zone properties (Thickness, Material, Grade, Color)",
          "Transform or Cut overlaying sheets based on new geometry",
          "Assign modified/created sheets to appropriate Zones"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Check",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Continue to Catalog Key Check"
              ]
            }
          },
          {
            "condition": "Execute Key Presence",
            "path1": {
              "name": "Key Found",
              "steps": [
                "Load properties from specific Catalog entry"
              ]
            },
            "path2": {
              "name": "Key Not Found",
              "steps": [
                "Load properties from '_LastInserted' catalog entry"
              ]
            }
          },
          {
            "condition": "Zone Collection Result",
            "path1": {
              "name": "No Zones Found",
              "steps": [
                "Report Error: 'Could not collect element zones'",
                "Erase Instance",
                "Exit"
              ]
            },
            "path2": {
              "name": "Zones Found",
              "steps": [
                "Continue to Polyline Selection"
              ]
            }
          },
          {
            "condition": "Duplicate Script Check",
            "path1": {
              "name": "Duplicate Found",
              "steps": [
                "Report Warning: 'Only one instance allowed per side'",
                "Erase Instance",
                "Exit"
              ]
            },
            "path2": {
              "name": "Unique Instance",
              "steps": [
                "Proceed to Execution Logic"
              ]
            }
          },
          {
            "condition": "Polyline Selection (Geometry Source)",
            "path1": {
              "name": "Polylines Selected",
              "steps": [
                "Define intersecting contour (ppDefine)",
                "Intersect new sheets with contour",
                "Subtract contour from overlaying sheets"
              ]
            },
            "path2": {
              "name": "No Polylines",
              "steps": [
                "Use full Reference Zone sheets",
                "Transform overlaying sheets (shift Z)"
              ]
            }
          },
          {
            "condition": "Shift Rule (sShiftRule)",
            "path1": {
              "name": "Integrated in reference zone",
              "steps": [
                "Modify properties of Reference Zone",
                "Assign new sheets to Reference Zone",
                "Shift overlaying sheets by thickness"
              ]
            },
            "path2": {
              "name": "On Top of Reference Zone",
              "steps": [
                "Create new adjacent zone (RefZone + Side)",
                "Assign new sheets to adjacent zone",
                "Shift Reference Zone properties to adjacent zone",
                "Shift overlaying sheets by thickness"
              ]
            }
          },
          {
            "condition": "Event Trigger",
            "path1": {
              "name": "Element Deleted (_bOnElementDeleted)",
              "steps": [
                "Restore original zone settings from saved map",
                "Reset zone attributes"
              ]
            },
            "path2": {
              "name": "Element Constructed/DbCreated",
              "steps": [
                "Execute sheet generation/modification logic",
                "Update Element Zones"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": null,
            "recovery": "Silent erase of instance"
          },
          {
            "check": "Element Zones Availability",
            "errorMessage": "ScriptName: Could not collect element zones.",
            "recovery": "User must select an Element with valid zones (thickness > 0)"
          },
          {
            "check": "Duplicate Script on Side",
            "errorMessage": "Element [Number]: Only one instance allowed per side.",
            "recovery": "Remove existing TSL instance or change the Reference Zone side (Left/Right)"
          },
          {
            "check": "Element Construction Status",
            "errorMessage": null,
            "recovery": "Script remains resident; logic triggers when construction is built or regenerated"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Parameters (Thickness, Material, etc.)",
            "how": "OPM (Object Properties Palette)",
            "effect": "Recalculates sheet geometry and zone properties upon regeneration"
          },
          {
            "action": "Change Reference Zone",
            "how": "OPM Dropdown",
            "effect": "Updates the base layer from which sheets are derived; switches side if sign changes"
          },
          {
            "action": "Change Position Rule (Shift Rule)",
            "how": "OPM Dropdown",
            "effect": "Toggles between integrating into the existing zone or creating a new overlaying zone"
          },
          {
            "action": "Delete/Undo Construction",
            "how": "AutoCAD Erase/Undo",
            "effect": "Restores original element zone settings (if 'Integrated' mode was used to modify the source)"
          },
          {
            "action": "Change Polyline Geometry",
            "how": "Grip edit the selected PLine",
            "effect": "Updates the intersection contour used for cutting/creating sheets on next rebuild"
          }
        ]
      },
      "tokens_used": 10047,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCreateSheetZone\n\n## Overview\nThis script creates a new sheeting layer or modifies an existing one based on a selected reference zone and an optional polyline contour. It is ideal for creating local reinforcement patches (e.g., thicker wet area boards) or adding a new material layer to specific parts of a wall or floor.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in the 3D Model Space where Elements exist. |\n| Paper Space | No | Not applicable for layouts or drawings. |\n| Shop Drawing | No | This is a construction/creation script, not a detailing script. |\n\n## Prerequisites\n- **Required Entities**: An existing **Element** (Wall, Floor, or Roof) that has at least one active zone (thickness > 0).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Browse and select `hsbCreateSheetZone.mcr`, then click **Open**.\n\n### Step 2: Select Element\n```\nCommand Line: Select element\nAction: Click on the timber Element (Wall/Floor) you wish to modify.\n```\n\n### Step 3: Select Contour (Optional)\n```\nCommand Line: Select polyline(s) which describe the contour to be changed (optional)\nAction: \n- To modify the ENTIRE zone: Press **Enter** or **Space**.\n- To modify a SPECIFIC AREA: Select one or more Polylines that define the boundary, then press **Enter**.\n```\n\n### Step 4: Configure Properties\nAction: The **TSL Properties** dialog appears automatically.\n1.  **Reference Zone**: Select which existing layer acts as the base (e.g., -1 for Exterior Sheathing).\n2.  **Position of new sheet**: Choose whether to integrate the change into the existing zone or add it \"On Top\" (creating a new layer).\n3.  Adjust **Thickness**, **Material**, **Grade**, and **Color** as needed.\n4.  Click **OK**.\n\n### Step 5: Build Construction\nAction: Run `Construct` (or `Generate Construction`) on the element. The script will generate or cut the sheets based on your inputs.\n\n---\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Reference zone | Dropdown | First available | Selects the existing material layer index (e.g., Zone -1, 1) to use as the geometric base. |\n| Position of new sheet | Dropdown | Integrated in reference zone | Determines how the new sheets interact with the wall.<br>• **Integrated**: Modifies the existing zone directly.<br>• **On Top of Reference Zone**: Creates a new zone adjacent to the reference zone and shifts other sheets to make room. |\n| Thickness | Number | 0 | The thickness of the new sheet material (in millimeters). |\n| Name | Text | [Empty] | The logical name for the sheet (e.g., \"OSB Patch\"). |\n| Material | Text | [Empty] | The material code for the sheet (e.g., \"OSB/3\"). Must exist in your catalog. |\n| Grade | Text | [Empty] | The quality grade of the material (e.g., \"C24\"). |\n| Color | Number | 0 | The AutoCAD color index (0-255) used to display the sheet in the model. |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom context menu items. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on the Element's existing zones and user input; no external XML settings files are required.\n\n## Tips\n- **Partial Modifications**: Draw your polyline on the exact plane of the reference zone to ensure the intersection is calculated correctly.\n- **Layering**: Use the **\"On Top of Reference Zone\"** option when you need to add a specific layer (like a secondary sheathing board) without deleting or cutting the original primary sheeting.\n- **Restoring Defaults**: If you delete the Element, the script attempts to restore the original zone settings that existed before the script was applied.\n- **Visibility**: Once the construction is built, the script instance itself is resident but hidden; you only see the resulting Sheets.\n\n## FAQ\n- **Q: What happens if I do not select a polyline?**\n  **A:** The script will apply the new settings to the *entire* area of the selected Reference Zone.\n  \n- **Q: How do I add a wet area board that is thicker than the rest of the wall?**\n  **A:** Select the interior sheathing zone as the Reference, draw a polyline around the wet area, set the new Thickness, and select **\"On Top of Reference Zone\"**. This pushes the standard boards out and places the thicker board in the specific area.\n\n- **Q: Why did the script disappear after I inserted it?**\n  **A:** This is a \"Resident\" script. It attaches itself to the Element group and remains active even if not visibly selectable. You can modify its settings via the Element's properties."
      },
      "tokens_used": 6997,
      "error": null
    }
  }
}