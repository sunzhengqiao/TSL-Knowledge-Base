{
  "filename": "hsbMarkerLines.mcr",
  "status": "completed",
  "total_tokens": 55039,
  "processing_time": 474.9548554420471,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9057,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly prompts for 'GenBeam' selection and 'marking entity(s)' (Solids, roof planes, etc.) using command-line inputs within `_bOnInsert`. It performs 3D geometric operations, utilizing `GenBeam.realBody()`, `PlaneProfile`, and spatial intersection logic. It modifies the `GenBeam` objects directly by adding 3D tools (`Drill`, `MarkerLine`). There is no usage of `_Viewport`, `sd_` prefixes, or Paper Space entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Solid",
            "RoofPlane",
            "RoofElement",
            "Polyline"
          ],
          "minimumBeams": 1,
          "requiredSpace": "ModelSpace",
          "requiredSettings": []
        }
      },
      "tokens_used": 7445,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getPoint/getEnt (implied)\",\n        \"promptOriginal\": \"Select marking entity(s) (Solids, roof planes, roof elements or polylines)\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getGenBeam (implied)\",\n        \"promptOriginal\": \"Select genbeams to be marked\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dMarkerLength\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Marker Length|\",\n      \"defaultValue\": \"U(30)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Defines length of the marker line, overlapping segments will be combined.|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dMarkerOffset\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Marker Offset|\",\n      \"defaultValue\": \"U(0)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sMarkBounds\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Mark Boundings|\",\n      \"defaultValue\": \"|Yes|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": \"|Defines if the marking follows the boundings or the real contour of the marking entity.|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sExportAsMark\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Export as Mark|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|No|\",\n        \"|Yes|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sSide\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Side|\",\n      \"defaultValue\": \"|Front|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Front|\",\n        \"|Back|\",\n        \"|Both|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"|Color|\",\n      \"defaultValue\": \"1\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Defines the color of the symbol display.| |The color of the marker can be modified in hsbSettings|\"\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Type|\",\n      \"defaultValue\": \"|Corner|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Corner|\",\n       "
      },
      "tokens_used": 9803,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automatically applies visual or machined markings (lines, drills, or midlines) to timber beams at the locations where they intersect with other structural elements like walls, roof planes, or solids.\",\n    \"category\": \"ShopDrawing / Layout\",\n    \"typicalUseCase\": \"Marking floor beams where a load-bearing wall sits, indicating cut lines, or placing alignment drills for assembly on site.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"dMarkerLength\",\n      \"technicalDefault\": \"U(30)\",\n      \"businessMeaning\": \"The physical length of the marking line drawn on the beam surface.\",\n      \"validRange\": \"10mm - 200mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Extends or shortens the visible line or CNC mark on the beam. Overlapping segments are merged into longer continuous lines.\"\n    },\n    {\n      \"name\": \"dMarkerOffset\",\n      \"technicalDefault\": \"U(0)\",\n      \"businessMeaning\": \"The distance the marking is shifted from the exact intersection edge towards the center of the beam.\",\n      \"validRange\": \"0mm - 100mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Moves the starting point of the mark inward from the intersection edge to ensure visibility near cuts or edges.\"\n    },\n    {\n      \"name\": \"sMarkBounds\",\n      \"technicalDefault\": \"|Yes|\",\n      \"businessMeaning\": \"Determines the geometry used to calculate the marking position: the bounding box (simpler) or the actual complex contour of the intersecting object.\",\n      \"validRange\": \"Yes (Bounding Box) / No (Real Contour)\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"If 'No', marks follow the exact shape of the intersecting object (e.g., a skewed roof plane). If 'Yes', marks follow the rectangular outline of that object.\"\n    },\n    {\n      \"name\": \"sExportAsMark\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"Controls whether the generated line is treated as a graphical element only or exported as a production mark to CNC machines.\",\n      \"validRange\": \"Yes / No\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"If 'Yes', the information is sent to production files (e.g., for inkjet printing or stamping). If 'No', it remains only in the 3D model/CAD drawings.\"\n    },\n    {\n      \"name\": \"sSide\",\n      \"technicalDefault\": \"|Front|\",\n      \"businessMeaning\": \"Selects which vertical face of the beam receives the marking relative to its local coordinate system.\",\n      \"validRange\": \"Front / Back / Both\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Restricts the drawing of the mark to the specified face(s) of the timber element.\"\n    },\n    {\n      \"name\": \"nColor\",\n      \"technicalDefault\": \"1\",\n      \"businessMeaning\": \"The visual display color (AutoCAD Index) of the marker in the model.\",\n      \"validRange\": \"1 - 255\",\n      \"unit\": \"ACI Color Index\",\n      \"affectsOutput\": \"Changes the color of the marker in the 3D view and 2D drawings for visual differentiation.\"\n    },\n    {\n      \"name\": \"sType\",\n      \"technicalDefault\": \"|Corner|\",\n      \"businessMeaning\": \"Specifies the nature of the marking tool to be generated: a standard corner line, a drilled hole, or a centerline.\",\n      \"validRange\": \"Corner / Drill / Midline\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Determines the geometric entity added to the beam: a visual line, a physical drill hole, or a centerline reference.\"\n    },\n    {\n      \"name\": \"dDiameterDrill\",\n      \"technicalDefault\": \"U(2)\",\n      \"businessMeaning\": \"The diameter of the drill hole when Type is set to 'Drill'.\",\n      \"validRange\": \"2mm - 30mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Changes the size of the hole machined into the timber.\"\n    },\n    {\n      \"name\": \"dDepthDrill\",\n      \"technicalDefault\": \"U(5)\",\n      \"businessMeaning\": \"The depth of the drill hole when Type is set to 'Drill'.\",\n      \"validRange\": \"5mm - Beam Width\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Controls how deep the marking drill penetrates into the beam.\"\n    },\n    {\n      \"name\": \"sMarkingFace\",\n      \"technicalDefault\": \"|Contact|\",\n      \"businessMeaning\": \"Defines whether the marking is applied to the face physically touching the other object or on the side faces of the beam.\",\n      \"validRange\": \"Contact / Side\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Switches the calculation logic to project marks either onto the intersection face or onto the vertical sides (useful for vertical alignment marks).\"\n    },\n    {\n      \"name\": \"sSideMarking\",\n      \"technicalDefault\": \"|Left|\",\n      \"businessMeaning\": \"Refines the position of the mark relative to the intersection vector (Left, Right, Both, or Middle).\",\n      \"validRange\": \"Left / Right / Both / Middle\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Fine-tunes the lateral placement of the marking on the specific face.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sType set to |Drill|\",\n      \"effect\": \"Activates machining logic and ignores standard marker line length logic in favor of drilling parameters.\",\n      \"cascade\": [\"dDiameterDrill\", \"dDepthDrill\"]\n    },\n    {\n      \"trigger\": \"sExportAsMark set to |Yes|\",\n      \"effect\": \"Enables CNC export flag on the generated MarkerLine or Drill entity.\",\n      \"cascade\": []\n    },\n    {\n      \"trigger\": \"sMarkingFace set to |Side|\",\n      \"effect\": \"Calculates geometry based on the beam's side envelope rather"
      },
      "tokens_used": 10273,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Insert/Recalculation Triggered",
          "2. Check Insert Cycle: If _bOnInsert, prompt for entity selection; otherwise retrieve stored entities.",
          "3. Prompt: Select marking entity(s) (Solids, roof planes, roof elements or polylines).",
          "4. Prompt: Select genbeams to be marked.",
          "5. Read Properties: Length, Offset, Type (Corner/Drill/Midline), Side, Face, Export settings.",
          "6. Initialize loop through selected GenBeams (Female entities).",
          "7. For each GenBeam, analyze intersections with selected Marking entities (Male entities).",
          "8. Determine geometry profiles (Bounding vs Real Contour based on 'sMarkBounds').",
          "9. Calculate projection planes for specific sides (Front/Back) based on 'sSide'.",
          "10. [Branch] Generate Tooling based on 'sType' (Corner, Drill, or Midline).",
          "11. Validate placement (e.g., ensure drills are not too close to edges).",
          "12. Assign tool to GenBeam and assign to Group 'T'.",
          "13. Final check: If no markers placed, report error and erase instance.",
          "14. Set Recalculation Triggers (Realbody/Envelope toggle)."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode (_bOnInsert vs Recalc)",
            "path1": {
              "name": "Initial Insert",
              "steps": [
                "Prompt user for Marking Entities",
                "Prompt user for GenBeams",
                "Store Entity Handles in Map"
              ]
            },
            "path2": {
              "name": "Recalculation",
              "steps": [
                "Retrieve Entity Handles from Map",
                "Skip prompts, proceed to geometry calculation"
              ]
            }
          },
          {
            "condition": "Marking Type (sType)",
            "path1": {
              "name": "Corner (Default)",
              "steps": [
                "Calculate intersection vector and length",
                "Apply 'dMarkerOffset'",
                "Add MarkerLine tool to GenBeam"
              ]
            },
            "path2": {
              "name": "Drill",
              "steps": [
                "Calculate potential drill point",
                "Validate point is within shrunken profile (20mm margin)",
                "Add Drill tool with 'dDiameterDrill' and 'dDepthDrill'"
              ]
            },
            "path3": {
              "name": "Midline",
              "steps": [
                "Check if entities intersect in a way that allows a midline",
                "If valid, create MarkerLine at center of contact",
                "If invalid, fallback to Corner type and alert user"
              ]
            }
          },
          {
            "condition": "Marking Geometry Source (sMarkBounds)",
            "path1": {
              "name": "Mark Bounds = Yes",
              "steps": [
                "Use plEnvelope (bounding box) of Male entity",
                "Faster calculation, approximate fit"
              ]
            },
            "path2": {
              "name": "Mark Bounds = No",
              "steps": [
                "Use realBody/contour of Male entity",
                "Slower calculation, precise fit"
              ]
            }
          },
          {
            "condition": "Drill Edge Safety",
            "path1": {
              "name": "Safe (>20mm from edge)",
              "steps": [
                "Drill is created successfully"
              ]
            },
            "path2": {
              "name": "Unsafe (<20mm from edge)",
              "steps": [
                "Drill point is ignored/rejected",
                "No tool added for this specific intersection"
              ]
            }
          },
          {
            "condition": "Final Validation (Success or Failure)",
            "path1": {
              "name": "Markers Placed (bOk=true)",
              "steps": [
                "Script completes",
                "Instance remains in model"
              ]
            },
            "path2": {
              "name": "No Markers Placed (bOk=false)",
              "steps": [
                "Report Error: 'Could not place any marking...'",
                "Erase Instance automatically"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Intersection",
            "errorMessage": "Could not place any marking to the selected entities. Tool will be deleted.",
            "recovery": "User must ensure selected GenBeams physically intersect or touch the selected marking entities."
          },
          {
            "check": "Drill Placement Boundary",
            "errorMessage": "No specific error, but drill is not generated if too close to edge.",
            "recovery": "Increase 'Marker Offset' or adjust geometry to ensure drill center is >20mm from beam edge."
          },
          {
            "check": "Midline Geometry Support",
            "errorMessage": "Type Midline not possible. Marking type has been changed back to Corner.",
            "recovery": "Script automatically reverts type. User can accept 'Corner' or change geometry to support 'Midline'."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Dimensions (Length, Offset, Drill Depth)",
            "how": "OPM (Properties Palette)",
            "effect": "Recalculates and redraws the marking geometry immediately."
          },
          {
            "action": "Switch Marking Type",
            "how": "OPM (Properties Palette)",
            "effect": "Changes the tool from visual line to physical drill (or vice versa)."
          },
          {
            "action": "Toggle Calculation Speed/Accuracy",
            "how": "Right-click Context Menu -> 'Use envelope shape...' or 'Use realbody...'",
            "effect": "Toggles between fast bounding box calculation and slow but accurate real body calculation."
          },
          {
            "action": "Change Visual Appearance (Color)",
            "how": "OPM (Properties Palette)",
            "effect": "Updates the display color of the marker in the CAD view."
          },
          {
            "action": "Toggle Export (sExportAsMark)",
            "how": "OPM (Properties Palette)",
            "effect": "Enables or disables the export of the marking to production/CNC files."
          }
        ]
      },
      "tokens_used": 10301,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbMarkerLines.mcr\n\n## Overview\nThis script automatically applies visual markings or machining operations (drills) to timber beams based on their intersection with other structural elements, such as walls, roof planes, or solids. It is used to indicate cut lines, alignment positions, or assembly points directly on the beam surface.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates on 3D GenBeams and intersections. |\n| Paper Space | No | Not intended for 2D layout views. |\n| Shop Drawing | No | Marks are generated in the model and may appear in derived views, but the script is run in Model Space. |\n\n## Prerequisites\n- **Required Entities**:\n  - At least one **GenBeam** (the timber element to be marked).\n  - At least one **Marking Entity** (Solid, Roof Plane, Roof Element, or Polyline used to define the intersection location).\n- **Minimum Beams**: 1 GenBeam.\n- **Required Settings**: None (Standard hsbCAD environment).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbMarkerLines.mcr` from the list.\n\n### Step 2: Select Marking Entity\n```\nCommand Line: Select marking entity(s) (Solids, roof planes, roof elements or polylines)\nAction: Click on the object(s) in the model that define where the mark should go (e.g., a wall sitting on top of beams). Press Enter to confirm selection.\n```\n\n### Step 3: Select GenBeams\n```\nCommand Line: Select genbeams to be marked\nAction: Click on the timber beams that you want to mark. Press Enter to confirm selection.\n```\n\n### Step 4: Configuration\nAfter selection, the script calculates the intersections. You can adjust the marker appearance and behavior using the **Properties Palette** (Ctrl+1) while the script instance is selected.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Marker Length** | Number | 30 mm | Defines the physical length of the marker line. Overlapping segments are combined into longer continuous lines. |\n| **Marker Offset** | Number | 0 mm | Shifts the marking inward from the exact intersection edge. Useful to ensure the mark is visible near cuts. |\n| **Mark Boundings** | Dropdown | Yes | **Yes**: Uses the bounding box of the marking entity (Faster, Rectangular). **No**: Uses the real contour of the marking entity (Slower, Precise). |\n| **Export as Mark** | Dropdown | No | If **Yes**, the mark is exported to production/CNC files (e.g., for inkjet printing). If **No**, it is visual only. |\n| **Side** | Dropdown | Front | Determines which vertical face of the beam receives the mark: **Front**, **Back**, or **Both**. |\n| **Color** | Number | 1 | Sets the AutoCAD color index for the marker display in the model. |\n| **Type** | Dropdown | Corner | Select the tool type: **Corner** (Visual Line), **Drill** (Machined Hole), or **Midline**. |\n| **Diameter Drill** | Number | 2 mm | Sets the diameter of the drill hole (Only active when Type is \"Drill\"). |\n| **Depth Drill** | Number | 5 mm | Sets the depth of the drill hole (Only active when Type is \"Drill\"). |\n| **Marking Face** | Dropdown | Contact | **Contact**: Marks the face physically touching the object. **Side**: Projects marks onto the vertical sides. |\n| **Side Marking** | Dropdown | Left | Refines the lateral position of the mark: **Left**, **Right**, **Both**, or **Middle**. |\n\n## Right-Click Menu Options\nSelect the script instance in the model and right-click to access the following options:\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Use envelope shape of marking entities** | Switches calculation mode to use the Bounding Box. Faster, but less accurate for complex shapes. |\n| **Use realbody of marking entities** | Switches calculation mode to use the exact geometry. Slower, but accurate for slanted or complex objects. |\n\n## Settings Files\n- **Filename**: `hsbSettings`\n- **Location**: Company or Install path (standard hsbCAD configuration)\n- **Purpose**: This script references `hsbSettings` to determine default display colors for markers, though local properties can override them.\n\n## Tips\n- **Performance**: If working with many complex roof planes, set **Mark Boundings** to \"Yes\" (Bounding Box) initially to speed up calculations. Switch to \"No\" (Real Body) only for final precision.\n- **Drill Safety**: Drills will not be placed if they are within 20mm of the beam edge (to prevent splitting). If a drill is missing, try increasing the **Marker Offset**.\n- **Midline Fallback**: If you select \"Midline\" as the Type but the geometry does not support it, the script will automatically revert to \"Corner\" type.\n\n## FAQ\n- **Q: Why did the script instance disappear immediately after running?**\n  - A: The script could not find any valid intersections between the selected Marking Entities and GenBeams. Ensure the objects physically touch or overlap in 3D space.\n- **Q: My marks are rectangular, but the wall is slanted. How do I fix this?**\n  - A: Change the **Mark Boundings** property to \"No\". This forces the script to follow the real contour of the slanted wall instead of its bounding box.\n- **Q: Can I use this to print marks on the timber for assembly?**\n  - A: Yes. Set **Export as Mark** to \"Yes\". This ensures the mark data is sent to production files (e.g., for inkjet markers or CNC labels)."
      },
      "tokens_used": 8160,
      "error": null
    }
  }
}