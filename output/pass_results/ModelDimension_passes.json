{
  "filename": "ModelDimension.mcr",
  "status": "completed",
  "total_tokens": 55731,
  "processing_time": 267.3164441585541,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "This tsl creates a dimension line on a genbeam or its multipage (shopdrawing)",
        "versionHistory": [
          {
            "version": "1.5",
            "date": "18.06.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11864 Cleanup added, view dependency modified"
          },
          {
            "version": "1.4",
            "date": "14.06.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11864 map definition of type and subtypes added"
          },
          {
            "version": "1.3",
            "date": "11.05.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11864 settings and multiple rules per stereotype supported, renamed"
          },
          {
            "version": "1.2",
            "date": "11.05.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11856 dimensions of ruleset tsls are contributing for dim location"
          },
          {
            "version": "1.1",
            "date": "07.05.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11742 updated using new multipageview class"
          },
          {
            "version": "1.0",
            "date": "05.05.2021",
            "author": "Thorsten Huck",
            "changes": "HSB-11725 first draft of model based dimensioning (shopdrawings and model)"
          }
        ],
        "settingsFiles": [
          "ModelDimension.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 8592,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": true,
          "detectionEvidence": "Script description explicitly states 'creates a dimension line on a genbeam or its multipage (shopdrawing)'. Logic declares 'MultiPage mp;' and 'MultiPageView mpvs[]', uses 'mp.modelToPaperMatrix(nView)' for coordinate transformation, and checks 'if (mp.bIsValid()|| child.bIsValid())' to apply Paper Space logic. Also iterates through 'ViewData vdatas[]'."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "MultiPage"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space or Paper Space (via MultiPage selection)",
          "requiredSettings": [
            "ModelDimension.xml"
          ]
        }
      },
      "tokens_used": 8634,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getEnt",
              "promptOriginal": "Select multipage or GenBeam",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrPoint.goJig",
              "promptOriginal": "|Select point|",
              "condition": "_bOnRecalc && _kExecuteKey == \"|Add Points|\"",
              "required": false
            },
            {
              "step": 3,
              "function": "PrPoint.goJig",
              "promptOriginal": "|Select tool|",
              "condition": "_bOnRecalc && _kExecuteKey == \"|Append Tool|\"",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Right-click menu: '|Append Tool|' or '|Renove Tool|'",
            "title": null,
            "dataSource": "Script self-instantiation (TslInst)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "ShowNotice",
            "trigger": "_bOnDbCreated && Version Mismatch",
            "title": null,
            "dataSource": "System generated",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": "nStringIndex",
            "variable": "sToolType",
            "type": "PropString",
            "displayName": "|Tool Type|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "Dynamic (Rule Types or sRuleTypes)"
            ],
            "category": "|Tool|",
            "description": "|Defines the ToolType|"
          },
          {
            "index": "nStringIndex",
            "variable": "sSubType",
            "type": "PropString",
            "displayName": "|Subtype|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "|All Types|",
              "analysedBeamCut_subTypes",
              "analysedDrill_subTypes"
            ],
            "category": "|Tool|",
            "description": "|Defines the subtype of the tool|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Set View|",
            "handler": "|Set View|",
            "action": "Allows configuration of view settings for dimensioning",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Append Tool|",
            "handler": "|Append Tool|",
            "action": "Opens dialog to add a tool rule (Beamcut or Drill) to the dimension logic",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add Points|",
            "handler": "|Add Points|",
            "action": "Initiates a Jig to select points for dimensioning",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Renove Tool|",
            "handler": "|Renove Tool|",
            "action": "Opens dialog to remove an existing tool rule",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "ModelDimension.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings",
              "_kPathHsbInstall\\Content\\General\\TSL\\Settings"
            ],
            "purpose": "Stores tool rules, stereotypes, and version information for model dimensioning",
            "required": false
          }
        ]
      },
      "tokens_used": 10204,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates dimension lines for specific timber machining (cuts, drills, etc.) on beams within the 3D model or 2D shop drawings.",
          "category": "ShopDrawing / Annotation",
          "typicalUseCase": "A detailer needs to annotate specific joinery details (e.g., birdsmouth cuts, drill holes) on a shop drawing to ensure manufacturing clarity, using the intelligent 3D model data rather than manual measurement."
        },
        "parameters": [
          {
            "name": "sToolType",
            "technicalDefault": "",
            "businessMeaning": "Specifies the general category of the timber feature to be dimensioned (e.g., Beam cuts, Drills, Housings). This filters the model elements to find relevant geometry.",
            "validRange": "AnalysedBeamCut, AnalysedDrill, AnalysedMortise, AnalysedHouse, AnalysedCut, AnalysedFreeProfile",
            "unit": "String",
            "affectsOutput": "Filters which types of tools are analyzed for dimensioning. Changing this updates the available options for the Subtype parameter."
          },
          {
            "name": "sSubType",
            "technicalDefault": "",
            "businessMeaning": "Specifies the exact type of machining within the selected Tool Type category (e.g., 'Birdsmouth' within Beam Cuts, or 'Perpendicular' within Drills).",
            "validRange": "Dynamic list based on ToolType (e.g., SeatCut, Birdsmouth, Perpendicular, Rotated, etc.) or '|All Types|'",
            "unit": "String",
            "affectsOutput": "Determines the specific subset of features that receive dimension lines. Only features matching both Type and Subtype are dimensioned."
          },
          {
            "name": "|Append Tool|",
            "technicalDefault": "N/A",
            "businessMeaning": "UI command to add a new dimensioning rule. Allows users to stack multiple dimension rules (e.g., 'Dimension all Seat Cuts' AND 'Dimension all Perpendicular Drills') on the same beam or drawing view.",
            "validRange": "N/A",
            "unit": "Action",
            "affectsOutput": "Adds a new rule to the internal configuration, resulting in additional dimension lines being generated for the selected tool types."
          },
          {
            "name": "|Add Points|",
            "technicalDefault": "N/A",
            "businessMeaning": "UI command to manually select points on the beam or drawing to create custom dimension lines where automatic tool detection is insufficient.",
            "validRange": "N/A",
            "unit": "Action",
            "affectsOutput": "Creates dimension lines connecting the user-selected points, or adds points to the automatic dimension calculation logic."
          },
          {
            "name": "|Renove Tool|",
            "technicalDefault": "N/A",
            "businessMeaning": "UI command to remove an existing dimensioning rule from the current configuration.",
            "validRange": "N/A",
            "unit": "Action",
            "affectsOutput": "Removes dimension lines associated with the selected rule from the display."
          },
          {
            "name": "|Set View|",
            "technicalDefault": "N/A",
            "businessMeaning": "Configures the specific view (e.g., Plan, Elevation, Section) or projection plane in which the dimensions should be generated and displayed.",
            "validRange": "Available Views defined in the MultiPage or Model Space",
            "unit": "Action",
            "affectsOutput": "Restricts dimension generation to the selected view, hiding dimensions in other views or orientations to prevent clutter."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing sToolType",
            "effect": "Updates the list of available options in sSubType to match the selected category.",
            "cascade": [
              "sSubType"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Dimension Line (Annotation)",
            "description": "Standard CAD dimensions indicating lengths, positions, or depths of the selected timber features.",
            "appliedTo": "GenBeam (in Model Space) or MultiPage/View (in Paper Space)"
          },
          {
            "type": "Protection Area (ViewProtect)",
            "description": "A virtual boundary registered in the hsbCAD environment to prevent other scripts or labels from overlapping with these dimensions.",
            "appliedTo": "Current Script Instance"
          }
        ]
      },
      "tokens_used": 10502,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Start: Load Constants and Colors.",
          "2. Settings Initialization: Load 'ModelDimension.xml' from Company or Install path. Create/Update MapObject in dictionary 'hsbTSL'.",
          "3. Version Check: If '_bOnDbCreated', compare installed XML version with existing MapObject version. Report notice if mismatched.",
          "4. Entity Selection Phase (Insert Only): Prompt user 'Select multipage or GenBeam'.",
          "5. Validation: Verify selected entity is valid (GenBeam or MultiPage).",
          "6. Data Persistence: Store selected entity handle/index. Set '_bOnInsert' to false and restart loop (setExecutionLoops(2)).",
          "7. Recalculation Phase: Retrieve stored entity and coordinate systems (Model/Paper space transforms).",
          "8. Contextual Logic: Determine ViewIndex and ViewData.",
          "9. Rule Loading: Deserialize internal 'sMapRule' string to retrieve existing dimensioning rules (Tool[]).",
          "10. Dimension Generation: Iterate through rules. For each rule, filter beam tools (Cuts, Drills, etc.) matching the rule's Type/SubType.",
          "11. Geometry Processing: Project relevant tool geometry to the current view plane. Add manually defined points ('Points[]').",
          "12. Visual Output: Generate dimension lines and protection areas ('ViewProtect').",
          "13. Interactive Event Loop: Listen for context menu triggers to modify rules or points."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution State (Dialog Mode vs Main Logic)",
            "path1": {
              "name": "Dialog Mode (UI Helper)",
              "steps": [
                "Check if _Map.getInt('DialogMode') > 0",
                "Setup OPM Properties (sToolType, sSubType) based on Mode (Beamcut, Drill, RemoveTool)",
                "Return immediately (acts as a dialog for the main instance)"
              ]
            },
            "path2": {
              "name": "Main Script Execution",
              "steps": [
                "Check if '_bOnInsert' is true",
                "Prompt for Entity selection",
                "Execute Recalc logic to draw dimensions"
              ]
            }
          },
          {
            "condition": "Context Menu Trigger (Append Tool)",
            "path1": {
              "name": "Graphical Selection",
              "steps": [
                "Collect all tools (Cuts, Drills) from the beam",
                "Visualize tools using Jig ('ToolJig')",
                "User selects a tool visually",
                "Launch Dialog (TslInst) to confirm Type/SubType",
                "Update internal 'mapRule' with new tool rule",
                "Restart script"
              ]
            },
            "path2": {
              "name": "No Action",
              "steps": [
                "Continue standard dimension generation"
              ]
            }
          },
          {
            "condition": "Entity Type (Model Space vs Paper Space)",
            "path1": {
              "name": "Paper Space (MultiPage)",
              "steps": [
                "Detect 'mp' (MultiPage) is valid",
                "Use 'ms2ps' matrix to transform coordinates",
                "Generate dimensions in Paper Space context"
              ]
            },
            "path2": {
              "name": "Model Space (GenBeam)",
              "steps": [
                "Detect 'entDefine' (GenBeam) is valid",
                "Use direct world coordinates",
                "Generate dimensions in Model Space"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection",
            "errorMessage": "Implicitly fails if no entity is selected during getEnt",
            "recovery": "Script prompts again or terminates if selection is invalid/cancelled."
          },
          {
            "check": "Settings Version Mismatch",
            "errorMessage": "Notice: 'A different Version of the settings has been found for [ScriptName]'",
            "recovery": "User must update the XML file or ensure correct version is loaded. Script continues with existing MapObject."
          },
          {
            "check": "Entity Existence on Recalc",
            "errorMessage": "If stored beam handle is invalid/deleted.",
            "recovery": "Script logic implies checking validity (bIsValid). If invalid, the script typically erases itself or stops execution to prevent errors."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Set View",
            "how": "Right-click context menu -> '|Set View|'",
            "effect": "Updates the internal 'nView' index to change which 2D view the dimensions are associated with (e.g., Plan vs Elevation)."
          },
          {
            "action": "Append Tool (Add Dimension Rule)",
            "how": "Right-click context menu -> '|Append Tool|' -> Graphical pick of feature",
            "effect": "Adds a new rule to the dimension list. Dimensions will appear for all tools matching the selected type/subtype on the beam."
          },
          {
            "action": "Add Points (Manual Dimensioning)",
            "how": "Right-click context menu -> '|Add Points|' -> Select points on screen",
            "effect": "Adds custom user-selected points to the dimension line calculation."
          },
          {
            "action": "Remove Tool",
            "how": "Right-click context menu -> '|Renove Tool|' -> Select from list",
            "effect": "Removes a specific tool rule (Type/SubType combination) from the dimension logic, removing those specific dimensions."
          }
        ]
      },
      "tokens_used": 11277,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ModelDimension.mcr\n\n## Overview\nAutomatically generates dimension lines for specific timber machining (such as cuts, drills, or housings) on beams within the 3D model or on 2D shop drawings (MultiPages). It allows users to define rules based on tool types to create intelligent, model-driven annotations.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Select a GenBeam to dimension tools in 3D. |\n| Paper Space | Yes | Select a MultiPage (Shop Drawing) frame to dimension tools in 2D views. |\n| Shop Drawing | Yes | Fully integrated with MultiPage views and coordinate systems. |\n\n## Prerequisites\n- **Required Entities**: A `GenBeam` (in Model Space) or a `MultiPage` (in Paper Space).\n- **Minimum Beams**: 1.\n- **Required Settings**: `ModelDimension.xml` (Located in `Company\\TSL\\Settings` or `Install\\Content\\General\\TSL\\Settings`).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `ModelDimension.mcr` from the list.\n\n### Step 2: Select Target Entity\n```\nCommand Line: Select multipage or GenBeam\nAction: Click on a timber beam in the model view OR click the border of a shop drawing page in a layout.\n```\n*After selection, the script instance is created attached to that entity.*\n\n### Step 3: Configure Dimensions\n*Note: The script does not automatically draw dimensions immediately upon insertion. You must define rules via the Right-Click menu.*\n1.  Select the newly inserted script instance.\n2.  Right-click and choose **|Append Tool|** to define what to dimension.\n3.  Follow the prompts to pick a specific tool (e.g., a cut or drill) graphically.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Tool Type | Dropdown | Dynamic | The general category of the machining to dimension (e.g., *AnalysedBeamCut*, *AnalysedDrill*). |\n| Subtype | Dropdown | Dynamic | The specific type of machining (e.g., *Birdsmouth*, *SeatCut*, *Perpendicular*). Selecting \"All Types\" applies dimensions to every tool in the category. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **|Set View|** | Opens a dialog to configure specific views (e.g., Plan, Elevation) where the dimensions should appear. |\n| **|Append Tool|** | Starts a graphical selection process. Click on a specific cut or drill in the model/drawing to add a rule for dimensioning that specific tool type. |\n| **|Add Points|** | Allows manual selection of points on the screen to create custom dimension lines not tied to a specific tool. |\n| **|Renove Tool|** | Opens a list of currently active tool rules. Select one to remove it and stop generating dimensions for that specific tool type. |\n\n## Settings Files\n- **Filename**: `ModelDimension.xml`\n- **Location**: `_kPathHsbCompany\\TSL\\Settings` or `_kPathHsbInstall\\Content\\General\\TSL\\Settings`\n- **Purpose**: Defines the available stereotypes, tool mappings, and version information for model dimensioning.\n\n## Tips\n- **Stacking Rules**: You can use the **|Append Tool|** command multiple times on the same script. This allows you to dimension different features (e.g., all Birdsmouth cuts AND all Perpendicular drills) using a single script instance.\n- **Manual Override**: If the automatic tool detection misses a detail, use **|Add Points|** to manually dimension that specific location.\n- **Clean Up**: If dimensions disappear or look wrong, check if the beam or tool definitions have changed. Use **|Renove Tool|** to clear conflicting rules and re-add them.\n- **View Specificity**: Use **|Set View|** to ensure dimensions only appear in the correct elevation or plan view, keeping other views clean.\n\n## FAQ\n- **Q: Why don't I see dimensions immediately after inserting the script?**\n  - **A**: The script requires configuration. You must right-click the script instance and select **|Append Tool|** or **|Add Points|** to define what needs to be dimensioned.\n- **Q: Can I use this in both the 3D model and the 2D drawings?**\n  - **A**: Yes. When inserting, simply select a beam for 3D model dimensions, or select a MultiPage frame for 2D shop drawing dimensions.\n- **Q: How do I dimension a specific type of cut?**\n  - **A**: Right-click the script, choose **|Append Tool|**, and then click directly on the cut in the drawing/model. The script will automatically detect its type and create a rule for it."
      },
      "tokens_used": 6522,
      "error": null
    }
  }
}