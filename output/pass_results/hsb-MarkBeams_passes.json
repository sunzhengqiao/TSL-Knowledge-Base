{
  "filename": "hsb-MarkBeams.mcr",
  "status": "completed",
  "total_tokens": 34008,
  "processing_time": 267.22168254852295,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "28.09.2017",
            "author": "Mihai Bercuci",
            "changes": ""
          },
          {
            "version": "1.2",
            "date": "23.10.2017",
            "author": "Mihai Bercuci",
            "changes": ""
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5247,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to select elements in the model and dbCreate to attach TSL instances to those elements. It performs 3D geometric calculations (Plane, Line, Vector3d) and adds Mark tools directly to Beam entities (bmT.addTool). No sd_* prefixes, Viewport logic, or 2D drawing generation code found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space",
          "requiredSettings": [
            "HSB_G-FilterGenBeams TSL (must be loaded in the drawing to filter beams)"
          ]
        }
      },
      "tokens_used": 4497,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && _kExecuteKey==\"\"",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Select one or More Elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Properties Dialog",
            "trigger": "Shown on insert when no ExecuteKey is provided",
            "title": null,
            "dataSource": "Internal OPM properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Marking side",
            "defaultValue": "Intersection Face",
            "inputType": "dropdown",
            "options": [
              "Intersection Face",
              "Front Face",
              "Back Face"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "genBeamFilterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition for beams to mark|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              ""
            ],
            "category": null,
            "description": "|Filter definition for beams to mark.|Use| HSB_G-FilterGenBeams |to define the filters|."
          },
          {
            "index": 2,
            "variable": "sMarkingSide",
            "type": "PropString",
            "displayName": "Marking options",
            "defaultValue": "Left & Right",
            "inputType": "dropdown",
            "options": [
              "Left & Right",
              "Center"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 4558,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically applies assembly marks (text/labels) to timber beams to indicate intersections with connecting members.",
          "category": "Production / Labeling",
          "typicalUseCase": "Marking wall plates with the position of studs, or marking beams where purlins or joists connect, to assist with assembly on site or in the factory."
        },
        "parameters": [
          {
            "name": "sMode",
            "technicalDefault": "Intersection Face",
            "businessMeaning": "Specifies the physical face of the beam where the mark label will be applied. 'Intersection Face' places the mark on the side where the other beam connects. 'Front/Back' uses the element's coordinate system to force the mark to specific vertical faces.",
            "validRange": "Intersection Face, Front Face, Back Face",
            "unit": "Selection (Enum)",
            "affectsOutput": "Changes the orientation and plane of the Mark tool, determining which side of the beam is legible after assembly."
          },
          {
            "name": "genBeamFilterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Defines a filter rule to select specific beams within the element to receive marks (e.g., only 'Studs' or 'Top Plates'). It prevents marking every single beam if only certain connections are relevant.",
            "validRange": "Any string matching a catalog entry in the 'HSB_G-FilterGenBeams' TSL",
            "unit": "String (Catalog Reference)",
            "affectsOutput": "Controls the quantity and selection of beams that get marked; only beams matching the filter criteria will receive the Mark tools."
          },
          {
            "name": "sMarkingSide",
            "technicalDefault": "Left & Right",
            "businessMeaning": "Determines the horizontal placement of the mark relative to the beam's width. 'Left & Right' places marks on both edges of the beam face. 'Center' places a single mark aligned with the beam's centerline.",
            "validRange": "Left & Right, Center",
            "unit": "Selection (Enum)",
            "affectsOutput": "Changes the number of marks generated (1 or 2) and their lateral position on the beam."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Availability of HSB_G-FilterGenBeams TSL",
            "effect": "If the external TSL is not loaded, the genBeamFilterDefinition cannot populate options, and the script may fail to filter beams.",
            "cascade": [
              "genBeamFilterDefinition"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mark",
            "description": "A text or symbol machining entity used to label the timber surface for assembly purposes.",
            "appliedTo": "Beams (GenBeams) contained within the selected Elements that pass the filter definition."
          }
        ]
      },
      "tokens_used": 5722,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: User starts the script (Insert)",
          "2. Cycle Check: Verify insertCycleCount() == 1 to prevent recursive execution",
          "3. Parameter Entry: If executed manually (_kExecuteKey==\"\"), show Properties Dialog",
          "4. Entity Selection: Prompt user to select one or more Elements (PrEntity)",
          "5. Instance Spawning: For each selected Element, create a new TSL instance attached to that element via dbCreate",
          "6. Cleanup Launcher: Erase the temporary 'launcher' instance",
          "7. [Attached Instance] Check: Verify instance is attached to a valid Element",
          "8. Conflict Resolution: Scan Element for other instances of this script and delete them (ensuring single instance)",
          "9. Beam Collection: Retrieve all Beams from the Element",
          "10. Filtering: Apply 'genBeamFilterDefinition' using 'HSB_G-FilterGenBeams' TSL to select markable beams",
          "11. Processing Loop: Iterate through filtered Beams (bm) to find T-connections with other filtered Beams (bmT)",
          "12. Geometry Check: Validate beam orientation (perpendicularity and vertical alignment)",
          "13. Mark Calculation: Determine intersection points based on 'Marking options' (Left/Right vs Center)",
          "14. Application: Create 'Mark' tools on the intersecting beams (bmT)",
          "15. Visualization: Draw display lines for debugging/preview"
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Mode (Insert vs. Update)",
            "path1": {
              "name": "Insertion Mode (_bOnInsert)",
              "steps": [
                "Check cycle count",
                "Show dialog if needed",
                "Select Elements",
                "Spawn attached instances",
                "Erase self"
              ]
            },
            "path2": {
              "name": "Calculation Mode (_bOnDbCreated/Recalc)",
              "steps": [
                "Verify Element attachment",
                "Clean duplicate instances",
                "Filter beams",
                "Calculate and apply Marks"
              ]
            }
          },
          {
            "condition": "Marking Options (sMarkingSide)",
            "path1": {
              "name": "Left & Right (Default)",
              "steps": [
                "Calculate points on both edges of the beam",
                "Check if points fall within the profile of the intersecting beam",
                "Create Mark if valid"
              ]
            },
            "path2": {
              "name": "Center",
              "steps": [
                "Calculate single point on beam centerline",
                "Create Mark at intersection"
              ]
            }
          },
          {
            "condition": "Marking Side (sMode)",
            "path1": {
              "name": "Intersection Face",
              "steps": [
                "Use the normal vector of the intersecting beam to place the mark"
              ]
            },
            "path2": {
              "name": "Front Face",
              "steps": [
                "Force mark to the positive Element Z direction (vz)"
              ]
            },
            "path3": {
              "name": "Back Face",
              "steps": [
                "Force mark to the negative Element Z direction (-vz)"
              ]
            }
          },
          {
            "condition": "Filter TSL Availability",
            "path1": {
              "name": "Success",
              "steps": [
                "Filter beam list",
                "Continue processing"
              ]
            },
            "path2": {
              "name": "Failure (TSL not loaded)",
              "steps": [
                "Report Warning to user",
                "Erase instance",
                "Stop script"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Recursive Execution",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases itself if insertCycleCount > 1"
          },
          {
            "check": "Element Selection",
            "errorMessage": "None (Silent)",
            "recovery": "If no elements are selected, _Element.length() remains 0, causing the instance to erase itself."
          },
          {
            "check": "Filter Definition Execution",
            "errorMessage": "\"Beams could not be filtered! Make sure that the tsl HSB_G-FilterGenBeams is loaded in the drawing.\"",
            "recovery": "User must load the 'HSB_G-FilterGenBeams' TSL into the drawing and rerun the script."
          },
          {
            "check": "Geometric Validity",
            "errorMessage": "None (Silent)",
            "recovery": "Beams that do not meet the perpendicular/vector alignment criteria are skipped (bIsValidMark = FALSE)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Marking Settings",
            "how": "Select the Element(s), open Properties Palette (OPM), change 'Marking side' or 'Marking options'",
            "effect": "Script recalculates and moves/removes marks based on new side or alignment (Left/Right/Center)."
          },
          {
            "action": "Change Beam Filter",
            "how": "Select the Element(s), open Properties Palette, change 'Filter definition for beams to mark'",
            "effect": "Script re-evaluates which beams in the element receive marks, adding or removing them as necessary."
          },
          {
            "action": "Geometry Update",
            "how": "Grip edit the Beams or Element",
            "effect": "Script detects geometry change, recalculates intersection points, and updates Mark positions."
          },
          {
            "action": "Delete Script",
            "how": "Select Element, right-click context menu -> Erase (or select TSL instance in model and delete)",
            "effect": "All generated Marks associated with this script instance are removed from the beams."
          }
        ]
      },
      "tokens_used": 7687,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb-MarkBeams.mcr\n\n## Overview\nAutomatically applies assembly marks to timber beams to indicate intersection points with connecting members, facilitating on-site assembly and factory production.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in 3D model space to place marks on beam faces. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Marks are applied directly to the 3D model entities. |\n\n## Prerequisites\n- **Required Entities**: At least one `Element` containing `Beams` (GenBeams).\n- **Minimum Beam Count**: 1 (within selected elements).\n- **Required Settings/Dependencies**: The TSL script `HSB_G-FilterGenBeams` must be loaded in the drawing to use the filtering functionality.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: Type `TSLINSERT` in the command line and select `hsb-MarkBeams.mcr` from the list.\n\n### Step 2: Configure Marking Settings\n```\nCommand Line: N/A (Properties Dialog or Palette)\nAction: A dialog or the Properties Palette appears. Choose the \"Marking side\" (e.g., Intersection Face) and \"Marking options\" (e.g., Left & Right).\n```\n*Note: You can also change these settings after insertion by selecting the element and checking the Properties Palette.*\n\n### Step 3: Select Elements\n```\nCommand Line: Select one or More Elements\nAction: Click on the Element(s) (e.g., a wall frame or roof assembly) that contain the beams you want to mark. Press Enter to confirm.\n```\n*The script will automatically process the beams within the selected elements and apply the marks.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Marking side | Dropdown | Intersection Face | Determines which face of the beam receives the mark. \"Intersection Face\" places it where beams meet; \"Front/Back\" uses the element's coordinate system. |\n| Filter definition for beams to mark | Dropdown | (Empty) | Limits which beams receive marks based on properties defined in the `HSB_G-FilterGenBeams` script (e.g., only mark \"Studs\"). |\n| Marking options | Dropdown | Left & Right | Sets the horizontal placement of the mark. \"Left & Right\" places marks on both edges; \"Center\" places one mark on the centerline. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Erase | Removes the script instance from the element, which also deletes all generated marks. |\n| (Standard hsbCAD context items) | Standard properties and modification commands available for the Element or TSL instance. |\n\n## Settings Files\nThis script does not use specific external settings files, but relies on the **HSB_G-FilterGenBeams** TSL to provide filter definitions.\n\n## Tips\n- **Filtering Beams**: To avoid marking every beam (like blocking), use the \"Filter definition\" property. Ensure `HSB_G-FilterGenBeams` is loaded to populate the dropdown options.\n- **Visualizing Marks**: Marks are applied as \"Mark\" tools. If they are not visible, check your layer visibility or display style in the 3D model.\n- **Updating**: If you modify the geometry of the beams or move the element, the script will automatically recalculate and move the marks to the correct positions.\n\n## FAQ\n- **Q: I see a warning message about \"Beams could not be filtered\". What does this mean?**\n- A: The required helper script `HSB_G-FilterGenBeams` is not loaded in your current drawing. Load it via the `TSLINSERT` command or your project template, and then run the script again.\n- **Q: How do I remove the marks without deleting the beams?**\n- A: Select the Element(s) that were marked, find the `hsb-MarkBeams` instance in the model or properties, and erase it. Alternatively, use the \"Erase\" command on the script instance.\n- **Q: The marks appear on the wrong side of the beam.**\n- A: Select the Element and change the \"Marking side\" property in the Properties Palette from \"Intersection Face\" to \"Front Face\" or \"Back Face\"."
      },
      "tokens_used": 6297,
      "error": null
    }
  }
}