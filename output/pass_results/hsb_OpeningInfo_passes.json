{
  "filename": "hsb_OpeningInfo.mcr",
  "status": "completed",
  "total_tokens": 44795,
  "processing_time": 314.3691930770874,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.3",
            "date": "5-2-2025",
            "author": "Ronald van Wijngaarden",
            "changes": "Add property to choose the sublayer to assign the tsl to."
          },
          {
            "version": "1.2",
            "date": "29-3-2023",
            "author": "Ronald van Wijngaarden",
            "changes": "Add check for multiple instances of this tsl. If present, delete them."
          },
          {
            "version": "1.1",
            "date": "13-12-2022",
            "author": "Ronald van Wijngaarden",
            "changes": "Add showInDxa to the display, to show the tsl in hsbmake"
          },
          {
            "version": "1.0",
            "date": "29-11-2022",
            "author": "Ronald van Wijngaarden",
            "changes": "Initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7009,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Comment 'This tsl shows opening info in modelspace'; uses PrEntity to select Elements directly; operates on Element().opening() and Element().beam(); creates geometry using Display/Body in 3D context; no #Type E declaration or _Viewport usage."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space with at least one selected Element",
          "requiredSettings": []
        }
      },
      "tokens_used": 5388,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\":"
      },
      "tokens_used": 8754,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Annotates wall elements with opening descriptions, dimensions, and optional visual indicators (cross-hatching or frames) directly in the 3D model space.\",\n    \"category\": \"Information/Annotation\",\n    \"typicalUseCase\": \"Labeling door and window openings on walls to clearly show size, type, or material info directly in the 3D model or for production drawings.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sInformationToShow\",\n      \"technicalDefault\": \"|Description|\",\n      \"businessMeaning\": \"Selects the primary content displayed at the opening: just the description, description plus header material, description plus size (Width x Height), or nothing.\",\n      \"validRange\": \"0 to 3 (Indices of arSInfo array)\",\n      \"unit\": \"Index (Enum)\",\n      \"affectsOutput\": \"Controls the text string drawn at the opening center and the vertical stacking of text lines.\"\n    },\n    {\n      \"name\": \"sCustomText\",\n      \"technicalDefault\": \"\\\"\\\"\",\n      \"businessMeaning \"Allows entry of up to 5 lines of user-defined text for specific remarks or notes regarding the opening.\",\n      \"validRange\": \"String (up to 5 lines)\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Adds extra text lines below the primary opening information.\"\n    },\n    {\n      \"name\": \"sLayer\",\n      \"technicalDefault\": \"T\",\n      \"businessMeaning \"Assigns the annotation to a specific drawing sublayer (T=Tool, I=Information, G=Geometry), which controls visibility in different drawing views (e.g., shop floor vs. architectural).\",\n      \"validRange\": \"\\\"T\\\", \\\"I\\\", \\\"G\\\"\",\n      \"unit\": \"String (Enum)\",\n      \"affectsOutput\": \"Sets the CAD layer for all generated graphics via assignToElementGroup.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"_DimStyles[0]\",\n      \"businessMeaning\": \"Selects the dimension style (font, text size, arrowheads) to be used for the text annotation.\",\n      \"validRange\": \"Available Dimension Styles in the project\",\n      \"unit\": \"String (Style Name)\",\n      \"affectsOutput\": \"Updates the Display object properties for text rendering.\"\n    },\n    {\n      \"name\": \"dTextHeight\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Manually overrides the text height defined in the dimension style. A value of 0 falls back to the style's default setting.\",\n      \"validRange\": \"0 to ~500 mm (0 = Use Default)\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Scales the text size if > 0; otherwise uses the DimStyle's default height.\"\n    },\n    {\n      \"name\": \"sDimensionBeamsBesideOpening\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"If 'Yes', dimensions are calculated based on the distance between the surrounding trimmer/king studs (accounting for connection gaps) rather than the theoretical opening outline.\",\n      \"validRange\": \"|Yes|, |No|\",\n      \"unit\": \"Boolean (Enum)\",\n      \"affectsOutput\": \"Modifies the displayed dimensions and the polyline geometry used for the frame/cross by projecting points to the adjacent beams.\"\n    },\n    {\n      \"name\": \"sWithCross\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"Toggles the visibility of diagonal cross-lines inside the opening to visually indicate a void or cut-out.\",\n      \"validRange\": \"|Yes|, |No|\",\n      \"unit\": \"Boolean (Enum)\",\n      \"affectsOutput\": \"Draws PLine segments connecting the extents of the opening profile if enabled.\"\n    },\n    {\n      \"name\": \"sWithFrame\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"Toggles the visibility of a rectangular outline (frame) around the perimeter of the opening.\",\n      \"validRange\": \"|Yes|, |No|\",\n      \"unit\": \"Boolean (Enum)\",\n      \"affectsOutput\": \"Draws the perimeter PLine of the opening shadow profile if enabled.\"\n    },\n    {\n      \"name\": \"colorCross\",\n      \"technicalDefault\": \"-1\",\n      \"businessMeaning\": \"Sets the color for the diagonal cross-lines. -1 uses the layer/entity default color.\",\n      \"validRange\": \"-1 to 255 (AutoCAD Color Index)\",\n      \"unit\": \"ACI\",\n      \"affectsOutput\": \"Changes the color attribute of the dpCross Display object.\"\n    },\n    {\n      \"name\": \"colorDescription\",\n      \"technicalDefault\": \"-1\",\n      \"businessMeaning\": \"Sets the color for the primary text description. -1 uses the layer/entity default color.\",\n      \"validRange\": \"-1 to 255 (AutoCAD Color Index)\",\n      \"unit\": \"ACI\",\n      \"affectsOutput\": \"Changes the color attribute of the dp Display object used for text.\"\n    },\n    {\n      \"name\": \"colorFrame\",\n      \"technicalDefault\": \"-1\",\n      \"businessMeaning\": \"Sets the color for the rectangular frame outline. -1 uses the layer/entity default color.\",\n      \"validRange\": \"-1 to 255 (AutoCAD Color Index)\",\n      \"unit\": \"ACI\",\n      \"affectsOutput\": \"Changes the color attribute of the dpFrame Display object.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sInformationToShow is set to Description & Size (Index 2)\",\n      \"effect\": \"The vertical offset of the Custom Text is increased to prevent overlapping with the dimensions.\",\n      \"cascade\": [\n        \"sCustomText\"\n      ]\n    },\n    {\n      \"trigger\": \"sDimensionBeamsBesideOpening is set to Yes\",\n      \"effect\": \"The dimensions and visual frame geometry are calculated based on the surrounding beams rather than the opening's CAD outline.\",\n      \"cascade\": [\n        \"sInformationToShow\",\n        \"sWithFrame\",\n        \"sWithCross\"\n      ]\n    },\n    {\n      \"trigger\": \"dTextHeight is 0\",\n      \"effect\": \"Text height is inherited from the sDimStyle setting.\",\n      \"cascade\": [\n        \"sDimStyle\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"Text/Annotation\",\n      \"description\": \"Opening descriptions, material info, dimensions (WxH), and custom notes drawn in Model Space.\",\n      \"appliedTo\": \"Element (Wall)\"\n    },\n    {\n      \"type\": \"Line/PLine\",\n      \"description\": \"Visual indicators including diagonal cross-marks and a perimeter frame representing the opening shape.\",\n      \"appliedTo\": \"Element (Wall)\"\n    }\n  ]\n}\n```"
      },
      "tokens_used": 7171,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launched via Insert or Execute.",
          "2. Check insertCycleCount; if > 1, erase instance and exit (prevents recursion).",
          "3. Determine property source: Check for Execute Key.",
          "4. [Branch] If Execute Key exists and valid catalog found: Load properties from Catalog.",
          "5. [Branch] If Execute Key exists but invalid catalog: Load properties from '_LastInserted' catalog.",
          "6. [Branch] If no Execute Key: Show GUI Dialog, then save properties to '_LastInserted' catalog.",
          "7. Prompt user to select Element(s) (PrEntity).",
          "8. Iterate through selected elements and attach a new instance of the TSL to each.",
          "9. Erase the original 'launcher' instance.",
          "10. Attached instances start execution.",
          "11. Validate Element (if invalid, erase and exit).",
          "12. Identify and erase any other instances of 'hsb_OpeningInfo' on the same element (ensures uniqueness).",
          "13. Determine Element geometry (CoordSys, Outline) and filter Header Beams.",
          "14. Iterate through all Openings in the Element.",
          "15. [Branch] Check 'Dimension opening beams' property.",
          "16. If Yes: Raycast from opening edges to find adjacent beams and adjust profile geometry.",
          "17. Generate 3D Body of the opening and project shadow to element plane.",
          "18. [Branch] Check 'With cross' property; if Yes, draw diagonal lines.",
          "19. [Branch] Check 'With frame' property; if Yes, draw perimeter outline.",
          "20. [Branch] Check 'Information to show' property (Description, Desc+Header, Desc+Size, None).",
          "21. Draw selected text info at opening center.",
          "22. Draw Custom Text (vertical offset adjusted based on Info Type).",
          "23. End loop."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Method (Execute Key vs Manual)",
            "path1": {
              "name": "Execute Key Insert",
              "steps": [
                "Read _kExecuteKey",
                "Search for matching Catalog name",
                "Apply Properties from Catalog",
                "Skip GUI Dialog"
              ]
            },
            "path2": {
              "name": "Manual Insert",
              "steps": [
                "Launch GUI Dialog (showDialog)",
                "User modifies properties",
                "Save properties to '_LastInserted' catalog"
              ]
            }
          },
          {
            "condition": "Dimension Source ('Dimension opening beams')",
            "path1": {
              "name": "Dimension Beams",
              "steps": [
                "For each opening edge vertex",
                "Calculate normal vector towards center",
                "Find closest beam using raycast",
                "Move profile edge midpoint to beam edge",
                "Calculate dimensions based on new profile"
              ]
            },
            "path2": {
              "name": "Dimension Outline",
              "steps": [
                "Use theoretical opening PLine (plOp)",
                "Calculate dimensions based on original geometry"
              ]
            }
          },
          {
            "condition": "Information Display Type ('Information to show')",
            "path1": {
              "name": "Description Only (0)",
              "steps": [
                "Draw opening description at center",
                "Draw Custom Text at offset -3"
              ]
            },
            "path2": {
              "name": "Description & Header Material (1)",
              "steps": [
                "Draw opening description",
                "Iterate Header beams",
                "Draw Material text if beam X-projection overlaps opening center",
                "Draw Custom Text at offset -3"
              ]
            },
            "path3": {
              "name": "Description & Size (2)",
              "steps": [
                "Draw opening description",
                "Calculate Width and Height from profile",
                "Format string 'W x H'",
                "Draw Size text at offset -3",
                "Draw Custom Text at offset -6"
              ]
            },
            "path4": {
              "name": "None (3)",
              "steps": [
                "Draw Custom Text at offset 0 (Center)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "(None - Silent failure)",
            "recovery": "Script logic prevents re-entrancy by erasing duplicate instances immediately."
          },
          {
            "check": "Selected Entity Validity",
            "errorMessage": "(None - Script terminates)",
            "recovery": "User must ensure a valid hsbCAD Element is selected before running the script."
          },
          {
            "check": "Beam Height/Width Availability",
            "errorMessage": "(None - Opening skipped)",
            "recovery": "If Element width is 0, script attempts to use first beam width. If that fails, the specific opening is skipped in the loop."
          },
          {
            "check": "Catalog Existence",
            "errorMessage": "(None - Fallback)",
            "recovery": "If an Execute Key is specified but the catalog doesn't exist, it automatically falls back to '_LastInserted'."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Annotation Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Updates the displayed text, toggles frames/crosses, changes colors, or alters layer assignments dynamically."
          },
          {
            "action": "Change Display Content",
            "how": "OPM - 'Information to show' dropdown",
            "effect": "Switches between Description, Header Material, Size, or blank."
          },
          {
            "action": "Adjust Dimension Logic",
            "how": "OPM - 'Dimension opening beams' toggle",
            "effect": "Recalculates the opening graphics and text to either measure the void or the surrounding trimmer beams."
          },
          {
            "action": "Layer Management",
            "how": "OPM - 'Assign to layer' (T/I/G)",
            "effect": "Moves the graphics to the specified sublayer (Tool, Information, or Geometry) for visibility control."
          }
        ]
      },
      "tokens_used": 9616,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_OpeningInfo\n\n## Overview\nThis script annotates wall elements with opening descriptions, dimensions, and optional visual indicators (such as cross-hatching or frames) directly in the 3D model space. It is useful for labeling door and window openings on walls to clearly show size, type, or material information for production or visualization.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script creates visual geometry and text in the 3D model. |\n| Paper Space | No | Not designed for layout views. |\n| Shop Drawing | No | This is a model space annotation tool. |\n\n## Prerequisites\n- **Required Entities**: An Element (Wall) must be selected.\n- **Minimum Beam Count**: None required (operates on the Element level).\n- **Required Settings**: None required, though Dimension Styles should be configured in the project for optimal text display.\n\n## Usage Steps\n\n### Step 1: Launch Script\nRun the script using the `TSLINSERT` command or double-click `hsb_OpeningInfo.mcr` in the TSL Palette.\n\n### Step 2: Configure Settings (Dialog)\nA dialog box will appear upon insertion (unless an Execute Key is used).\n- Select the **Information to Show** (Description, Header Material, Size, etc.).\n- Configure visual options like **With Cross** or **With Frame**.\n- Choose the **Layer** assignment (Tool, Information, or Geometry).\n- Click **OK** to confirm.\n\n### Step 3: Select Element\n```\nCommand Line: Select element(s):\nAction: Click on the Wall(s) or Element(s) where you want to display opening information.\n```\nThe script will attach itself to the selected elements and generate the annotations automatically.\n\n## Properties Panel Parameters\nOnce the script is inserted, you can modify these settings via the AutoCAD Properties Palette (Ctrl+1).\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Information to show | Dropdown | Description | Selects what content is displayed: Description only, Description + Header Material, Description + Size (W x H), or None. |\n| Custom Text | String | (Empty) | Enter up to 5 lines of custom notes to appear below the opening information. |\n| Assign to layer | Dropdown | T (Tool) | Sets the drawing sublayer (T=Tool, I=Information, G=Geometry) to control visibility in different views. |\n| DimStyle | Dropdown | Project Default | Selects the dimension style (font, text size) used for the text annotation. |\n| Text Height | Number | 0 | Overrides the text height from the DimStyle. Value is in mm. Enter 0 to use the style default. |\n| Dimension opening beams | Yes/No | No | If **Yes**, dimensions are taken from the surrounding trimmer/king studs (including gaps). If **No**, dimensions are taken from the theoretical opening outline. |\n| With Cross | Yes/No | No | Toggles diagonal cross-lines inside the opening to visually indicate a void. |\n| With Frame | Yes/No | No | Toggles a rectangular outline (frame) around the perimeter of the opening. |\n| Color Cross | Number | -1 | Sets the color for the diagonal cross-lines (-1 uses layer color). |\n| Color Description | Number | -1 | Sets the color for the primary text description (-1 uses layer color). |\n| Color Frame | Number | -1 | Sets the color for the rectangular frame (-1 uses layer color). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Update | Recalculates the opening geometry and text based on current Element properties or script parameter changes. |\n| Erase | Removes the opening information from the selected element. |\n| Properties | Opens the AutoCAD Properties Palette to edit script parameters. |\n\n## Settings Files\n- **Catalog**: `_LastInserted` (or specific Execute Key catalogs)\n- **Purpose**: Stores the last used settings for the script so they are remembered for the next insertion.\n\n## Tips\n- **Clear vs. Rough Opening**: Use the **Dimension opening beams** property. Set it to **No** to get the CAD \"Clear Opening\" size, or **Yes** to measure between the surrounding timber (rough opening size).\n- **Visibility Control**: Use the **Assign to layer** property to move annotations to the \"Information\" (I) layer if you want them hidden in shop floor views but visible in architectural layouts.\n- **Text Scaling**: If the text appears too small or large, set **Text Height** to 0 first to check your DimStyle settings. Adjusting the DimStyle is often cleaner than hardcoding a height in the script.\n\n## FAQ\n- **Q: The dimensions shown don't match my beam sizes. Why?**\n  **A**: Check the **Dimension opening beams** property. If it is set to **No**, the script measures the theoretical void. Setting it to **Yes** will calculate dimensions based on the actual beams surrounding the opening.\n  \n- **Q: Can I add specific notes for a specific door?**\n  **A**: Yes, use the **Custom Text** property in the Properties Palette. You can type multiple lines of notes specific to that element.\n\n- **Q: Why did the text disappear?**\n  **A**: Check if the **Information to show** dropdown is set to \"None\". Also, verify your current layer visibility; the script might be on a frozen or turned-off layer (e.g., T-Slayer or I-Slayer)."
      },
      "tokens_used": 6857,
      "error": null
    }
  }
}