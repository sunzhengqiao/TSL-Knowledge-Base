{
  "filename": "ElementToolTag.mcr",
  "status": "completed",
  "total_tokens": 52291,
  "processing_time": 258.5205714702606,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9094,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "int bInLayoutTab = Viewport().inLayoutTab(); _Viewport.append(getViewport(...)); Matrix3D ms2ps = sdv.transformMatrix(); bPaperspace = _kMySpace == _kPaperSpace; PrEntity ssE(..., Section2d()); Comment: 'mainly designed to work with hsbcad viewports in paperspace you may attach it in model'"
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam",
            "Section2d",
            "ShopDrawView"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Accepts input from Model Space (Elements/GenBeams) or Paper Space (Viewports). Creates instances in Model Space attached to Element zones.",
          "requiredSettings": [
            "DimStyle (referenced in properties)"
          ]
        }
      },
      "tokens_used": 7330,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": "null",
              "condition": "_bOnInsert && _kExecuteKey.length()==0",
              "required": true
            },
            {
              "step": 2,
              "function": "getShopDrawView",
              "promptOriginal": "T(\"|\")",
              "condition": "!bInLayoutTab && viewEnts.length()>0",
              "required": false
            },
            {
              "step": 3,
              "function": "getViewport",
              "promptOriginal": "T(\"|Select a viewport|\")",
              "condition": "bInLayoutTab && _Entity.length()<1",
              "required": true
            },
            {
              "step": 4,
              "function": "PrEntity",
              "promptOriginal": "T(\"|Select elements|\")",
              "condition": "bInLayoutTab && _Viewport.length()>0 && !_Viewport[0].element().bIsValid()",
              "required": false
            },
            {
              "step": 5,
              "function": "PrEntity",
              "promptOriginal": "T(\"|Select elements or sections|\")",
              "condition": "!bInLayoutTab && _Entity.length()<1",
              "required": true
            },
            {
              "step": 6,
              "function": "getPoint",
              "promptOriginal": "T(\"|Pick insertion point|\")",
              "condition": "bInLayoutTab || (viewEnts.length()<1 && ents.length()<1)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "T(\"|Zone|\")",
            "defaultValue": "0",
            "inputType": "dropdown",
            "options": [
              "Dynamic (0..5)"
            ],
            "category": "T(\"|General|\")",
            "description": "T(\"|Defines the Zone|\")+ T(\", |0 = all zones|\")"
          },
          {
            "index": 1,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "T(\"|Tool|\")",
            "defaultValue": "T(\"|Saw Line|\")",
            "inputType": "dropdown",
            "options": [
              "T(\"|Saw Line|\")",
              "T(\"|Milling Line|\")",
              "T(\"|Element Drill|\")",
              "T(\"|Nailing Line|\")"
            ],
            "category": "T(\"|General|\")",
            "description": "T(\"|Defines the Tool|\")"
          },
          {
            "index": 2,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "T(\"|Format|\")",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "T(\"|General|\")",
            "description": "T(\"|Defines the Format|\")+ T(\"|Empty = default format|\")"
          },
          {
            "index": 3,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "T(\"|DimStyle|\")",
            "defaultValue": "_DimStyles.sorted()",
            "inputType": "dropdown",
            "options": [
              "_DimStyles.sorted()"
            ],
            "category": "T(\"|Display|\")",
            "description": "T(\"|Defines the DimStyle|\")"
          },
          {
            "index": 0,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "T(\"|Text Height|\")",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "T(\"|Display|\")",
            "description": "T(\"|Defines the text height|, \") + T(\"|0 = byDimstyle|\")"
          },
          {
            "index": 1,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "T(\"|Color|\")",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "T(\"|Display|\")",
            "description": "T(\"|Defines the Color|\")+ T(\", |0 = byZone|\") + T(\", |-1 = byToolindex|\")"
          },
          {
            "index": 2,
            "variable": "sLayer",
            "type": "PropString",
            "displayName": "T(\"|Layer|\")",
            "defaultValue": "I",
            "inputType": "dropdown",
            "options": [
              "I",
              "T",
              "E",
              "C",
              "J"
            ],
            "category": "T(\"|Display|\")",
            "description": "T(\"|Defines the sublayer|\")"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "T(\"|Add/Remove Format|\")",
            "handler": "_kExecuteKey==sTriggerAddRemoveFormat",
            "action": "Displays a list of available format variables in the command line and allows adding/removing them to the Format string via index input.",
            "alsoTriggeredBy": "null"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9344,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates and labels machining tags (saw lines, milling, drills, nails) for timber elements in both model space and paper space viewports.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used during the creation of production drawings to dimension and annotate specific machining operations on elements within a viewport or directly in the model."
        },
        "parameters": [
          {
            "name": "nZone",
            "technicalDefault": "0",
            "businessMeaning": "Specifies which construction zone of the element to analyze and tag. Elements are divided into zones (e.g., left, right, top, bottom) based on their geometry.",
            "validRange": "-5 to 5 (0 = All Zones)",
            "unit": "Index",
            "affectsOutput": "Filters which machining tools are found and tagged. If set to 0, the script tags tools in all valid zones. If set to a specific zone, only tools in that zone are processed."
          },
          {
            "name": "sTool",
            "technicalDefault": "T(\"|Saw Line|\")",
            "businessMeaning": "Selects the category of machining tool to visualize and label.",
            "validRange": "Saw Line, Milling Line, Element Drill, Nailing Line",
            "unit": "Enumeration",
            "affectsOutput": "Determines which collection of tools (e.g., ElemSaw, ElemMill, ElemDrill, ElemNail) is queried from the element geometry to generate tags."
          },
          {
            "name": "sFormat",
            "technicalDefault": "",
            "businessMeaning": "Defines the text string template for the tag label, allowing dynamic insertion of tool properties like angle, diameter, or spacing.",
            "validRange": "String (supports @() variable placeholders)",
            "unit": "String",
            "affectsOutput": "Changes the content of the text label displayed next to the tool. Empty string defaults to a standard format based on the tool type (e.g., 'Saw @Angle @Overshoot')."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles.sorted()",
            "businessMeaning": "Sets the graphical style (font, arrow style, precision) for the dimension text.",
            "validRange": "Any existing DimStyle in the drawing",
            "unit": "String (Reference)",
            "affectsOutput": "Alters the visual appearance (size, font) of the generated text annotation."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "U(0)",
            "businessMeaning": "Explicitly sets the height of the annotation text.",
            "validRange": "Typically 2.0mm to 10.0mm depending on drawing scale",
            "unit": "mm",
            "affectsOutput": "Resizes the text label. A value of 0 defers to the height defined in the selected DimStyle."
          },
          {
            "name": "nColor",
            "technicalDefault": "0",
            "businessMeaning": "Controls the color of the tag text.",
            "validRange": "Integer (Autodesk Color Index), 0, or -1",
            "unit": "ACI Index",
            "affectsOutput": "Changes the color of the drawn text. 0 uses the color assigned to the element's zone. -1 uses the color associated with the tool's index."
          },
          {
            "name": "sLayer",
            "technicalDefault": "I",
            "businessMeaning": "Assigns the tag to a specific sublayer relative to the element's layer, organizing drawing data.",
            "validRange": "I, T, E, C, J",
            "unit": "Layer Code",
            "affectsOutput": "Changes the CAD layer property of the generated text entity, affecting visibility and plot styles."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sTool changes",
            "effect": "Default Format changes",
            "cascade": [
              "sFormat"
            ]
          },
          {
            "trigger": "sTool changes",
            "effect": "Available variables for Format change",
            "cascade": [
              "sFormat"
            ]
          },
          {
            "trigger": "nZone is set to 0",
            "effect": "Script creates multiple instances (one for each zone) if executed during insertion.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Text/Dimension",
            "description": "Annotation labels displaying tool properties (Angle, Spacing, Diameter, etc.) positioned at the midpoint of the tool's operation path.",
            "appliedTo": "Selected Elements or GenBeams in Model Space; Viewport representations in Paper Space."
          }
        ]
      },
      "tokens_used": 8658,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Start Insertion (Check insertCycleCount > 1 -> Exit if true)\",\n    \"2. Determine Property Source: Check for Catalog Key (_kExecuteKey) else show Dialog\",\n    \"3. Detect Workspace: Check if in Layout Tab (PaperSpace) or Model Space\",\n    \"4. [Conditional Branch] Selection Phase:\",\n    \"   - PaperSpace: Prompt for Viewport. If Viewport Element invalid, switch to ModelSpace to prompt for Elements, then switch back. Prompt for Insertion Point.\",\n    \"   - ModelSpace: Prompt for Entities (Element, GenBeam, or Section2d).\",\n    \"5. Instance Creation Logic:\",\n    \"   - Loop through selected Entities.\",\n    \"   - Determine Zones: If nZone=0, scan for all valid zones (-5 to 5); else use specific nZone.\",\n    \"   - Call dbCreate for each Element/Zone combination.\",\n    \"   - Erase 'Launcher' instance and return.\",\n    \"6. Instance Execution Phase:\",\n    \"   - Fetch Element tools based on 'Tool' property (Saw, Mill, Drill, Nail).\",\n    \"   - Filter tools by assigned Zone.\",\n    \"   - Generate Text: Use 'Format' property and tool data (Diameter, Angle, etc.).\",\n    \"   - Draw Text annotation at tool midpoint.\",\n    \"7. [Conditional Branch] Context Menu Interaction:\",\n    \"   - If 'Add/Remove Format' triggered: List available variables to command line. Prompt for index to toggle in Format string. Recalculate.\",\n    \"   - Normal Recalc: Redraw annotations.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"bInLayoutTab (PaperSpace vs ModelSpace)\",\n      \"path1\": {\n        \"name\": \"PaperSpace Workflow\",\n        \"steps\": [\n          \"Prompt for Viewport\",\n          \"Check Viewport.element().bIsValid()\",\n          \"If false: Switch to ModelSpace -> PrEntity (Elements) -> Switch to PaperSpace\",\n          \"Prompt for Insertion Point\",\n          \"Create Instances for Element/Zones\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"ModelSpace Workflow\",\n        \"steps\": [\n          \"PrEntity (Elements, GenBeam, Section2d)\",\n          \"If Section2d: Create instance immediately\",\n          \"If Element/GenBeam: Store in array\",\n          \"Loop stored elements -> Create Instances for Zones\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"nZone Property (Zone Selection)\",\n      \"path1\": {\n        \"name\": \"All Zones (nZone == 0)\",\n        \"steps\": [\n          \"Iterate z from -5 to 5\",\n          \"Check if el.zone(z).dH() > dEps\",\n          \"Create instance for every valid zone found\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Specific Zone (nZone != 0)\",\n        \"steps\": [\n          \"Create instance for the single specified zone index\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"_kExecuteKey (Context Menu Trigger)\",\n      \"path1\": {\n        \"name\": \"Format Editor Mode\",\n        \"steps\": [\n          \"Extract variables from tool data map\",\n          \"Print translated variable list to command line\",\n          \"Prompt user for index\",\n          \"Add/Remove variable from sFormat"
      },
      "tokens_used": 11673,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ElementToolTag.mcr\n\n## Overview\nThis script automatically generates and labels machining tags (such as saw lines, milling lines, drills, and nailing lines) for timber elements. It is designed to create production annotations in both Model Space and Paper Space viewports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Select elements directly to generate tags. |\n| Paper Space | Yes | Select a viewport to tag elements visible in that view. |\n| Shop Drawing | Yes | Specifically designed for detailing views. |\n\n## Prerequisites\n- **Required Entities**: `Element`, `GenBeam`, `Section2d`, or `ShopDrawView`.\n- **Minimum Beam Count**: 0 (Can be used on single elements).\n- **Required Settings**: A valid `DimStyle` must exist in the drawing.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `ElementToolTag.mcr` from the list.\n\n### Step 2: Configure Tool Type\nA dialog or property prompt appears upon insertion.\n1.  Select the desired **Tool** (e.g., Saw Line, Milling Line).\n2.  Select the **Zone** (0 for all zones, or a specific index).\n3.  Click OK or Enter to confirm.\n\n### Step 3: Select Input (Context Dependent)\nThe script behaves differently depending on your current workspace:\n\n**If in Paper Space (Layout Tab):**\n1.  **Command Line**: `Select a viewport`\n2.  **Action**: Click on the border of the viewport where the element is drawn.\n3.  **Conditional**: If the viewport does not contain specific element data, the script may prompt you to switch to Model Space to select the element.\n\n**If in Model Space:**\n1.  **Command Line**: `Select elements or sections`\n2.  **Action**: Click on the timber elements (`Element` or `GenBeam`) or a 2D section you wish to annotate. Press Enter when finished.\n\n### Step 4: Position Tags\n1.  **Command Line**: `Pick insertion point`\n2.  **Action**: Click in the drawing to define the base location for the annotations.\n3.  **Result**: The script generates text labels at the midpoints of the detected machining operations.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone | dropdown | 0 | Defines which construction zone to analyze. Set to `0` to tag all valid zones (usually -5 to 5). |\n| Tool | dropdown | Saw Line | Selects the machining category to visualize (Saw Line, Milling Line, Element Drill, Nailing Line). |\n| Format | text | *(Empty)* | Defines the label text template. Leave empty for the default format. Supports dynamic variables (e.g., `@Angle`, `@Diameter`). |\n| DimStyle | dropdown | *(First in list)* | Sets the graphical style (font, arrows) for the dimension text. |\n| Text Height | number | 0 | Defines the text height. `0` uses the height defined in the selected DimStyle. |\n| Color | number | 0 | Defines the text color. `0` = by Zone, `-1` = by Tool Index. Otherwise, uses the specific Autodesk Color Index entered. |\n| Layer | dropdown | I | Defines the sublayer for the tag (I, T, E, C, or J). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add/Remove Format | Displays a list of available format variables in the command line. Type the index number to add or remove that variable (e.g., Angle, Diameter) from the label format. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies on standard drawing DimStyles rather than external XML files.\n\n## Tips\n- **Zone 0**: Use `Zone = 0` during insertion to automatically create tags for all sides of an element in one operation.\n- **Custom Labels**: Use the \"Add/Remove Format\" right-click option to quickly customize what data appears on the tag without typing complex strings manually.\n- **Text Height**: For cleaner shop drawings, set `Text Height` to `0` so the tags automatically scale according to your active DimStyle.\n\n## FAQ\n- **Q: Why did the script create multiple tags for one element?**\n  **A**: If the `Zone` property is set to `0`, the script detects and tags machining operations on all valid zones of the element. To target a specific side, change the Zone property to a non-zero value.\n- **Q: How do I display the cut angle on the tag?**\n  **A**: Right-click the script instance and select \"Add/Remove Format\". The command line will list available variables (usually including `Angle`). Enter the corresponding index to add it to your format string."
      },
      "tokens_used": 6192,
      "error": null
    }
  }
}