{
  "filename": "hsbNailCluster.mcr",
  "status": "completed",
  "total_tokens": 53637,
  "processing_time": 285.4726285934448,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9172,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit creation of instances using _kModelSpace (tslNew.dbCreate(..., _kModelSpace, mapTsl)). Logic operates on GenBeam, Element, Body, and PlaneProfile 3D geometry. Adds ElemNailCluster tooling to elements. No usage of _Viewport, _kPaperSpace, or shopdrawing specific prefixes (sd_, Multipage)."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Beam",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing valid Roof Elements with beams and sheets.",
          "requiredSettings": [
            "Materials must be assigned to sheets/beams for correct filtering via properties sMatNail and sMatContact"
          ]
        }
      },
      "tokens_used": 7108,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity.go",
              "promptOriginal": "|Select Element(s)|, |<Enter> to select individual entities of one nailing cluster|",
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "getBeam",
              "promptOriginal": "|Select rafter or beam|",
              "condition": "_bOnInsert && _Element.length()==0",
              "required": true
            },
            {
              "step": 3,
              "function": "getSheet",
              "promptOriginal": "|Select lath|",
              "condition": "_bOnInsert && _Element.length()==0",
              "required": true
            },
            {
              "step": 4,
              "function": "PrEntity.go",
              "promptOriginal": "|Select entities of contact zone|",
              "condition": "_bOnInsert && _Element.length()==0",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Properties Dialog",
            "trigger": "Manual Insert (_bOnInsert)",
            "title": "hsbNailCluster Properties",
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 22,
            "variable": "sNailingDummy",
            "type": "PropString",
            "displayName": "|Nailing Zone|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "sMatNail",
            "type": "PropString",
            "displayName": "|Material|",
            "defaultValue": "   ",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dNailEdge",
            "type": "PropDouble",
            "displayName": "|Edge Offset|",
            "defaultValue": "U(5)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dSupportEdge",
            "type": "PropDouble",
            "displayName": "|Edge Offset Support| |(0 to ignore)|",
            "defaultValue": "U(15)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dDistBetweenNail",
            "type": "PropDouble",
            "displayName": "|Nail Distance|",
            "defaultValue": "U(20)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "|Defines the max Nail Distance| |0 = 1 Nail|"
          },
          {
            "index": 2,
            "variable": "sSnap2Axis",
            "type": "PropString",
            "displayName": "|Snap Nails to Axis|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": "|Projects nailing points on an axis parallel to the rafter axis|"
          },
          {
            "index": 23,
            "variable": "sContactDummy",
            "type": "PropString",
            "displayName": "|Contact Zone|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sMatContact",
            "type": "PropString",
            "displayName": "|Material| ",
            "defaultValue": "   ",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "dContactEdge",
            "type": "PropDouble",
            "displayName": "|Edge Offset| |(0 to ignore)|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 24,
            "variable": "sRafterDummy",
            "type": "PropString",
            "displayName": "|Zone 0|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dRafterEdge",
            "type": "PropDouble",
            "displayName": "|Edge Offset Zone 0|",
            "defaultValue": "U(5)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nToolingIndex",
            "type": "PropInt",
            "displayName": "|Tooling index|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Create individual cluster nailings|",
            "handler": "|Create individual cluster nailings|",
            "action": "Converts element-level cluster instances into individual instances for each beam/lath combination.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8418,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the generation of nail patterns at intersection points between roofing components (rafters, counter-battens, and laths) based on material assignments and geometric constraints.",
          "category": "Tooling/Fastening",
          "typicalUseCase": "Used in timber roof engineering to calculate and apply fastening points for laths to rafters, ensuring compliance with spacing and edge offset rules for manufacturing (CNC) and drawings."
        },
        "parameters": [
          {
            "name": "sNailingDummy",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual separator header in the properties palette grouping settings related to the nailing/lath zone.",
            "validRange": "N/A (Display Only)",
            "unit": "text",
            "affectsOutput": "None"
          },
          {
            "name": "sMatNail",
            "technicalDefault": "\"   \"",
            "businessMeaning": "The material name assigned to the lath/sheet to be nailed. Used to identify which components in the roof element receive nails.",
            "validRange": "Any valid material name defined in the project (e.g., 'Lath_50x50').",
            "unit": "string",
            "affectsOutput": "Determines which components are the 'targets' for the nailing pattern. If empty or no match found, no nails are generated."
          },
          {
            "name": "dNailEdge",
            "technicalDefault": "U(5)",
            "businessMeaning": "The minimum distance from the edge of the target component (lath) where nailing may start.",
            "validRange": "0 to Width of Lath/2",
            "unit": "mm",
            "affectsOutput": "Offsets the start/end of the nailing grid from the edges of the lath."
          },
          {
            "name": "dSupportEdge",
            "technicalDefault": "U(15)",
            "businessMeaning": "The distance from the support edge (e.g., rafter face) used to align the nail cluster. If set > 0, the script attempts to align the first nail to this offset from the support.",
            "validRange": "0 to Component Length",
            "unit": "mm",
            "affectsOutput": "Shifts the calculated nail points to align with a specific reference edge of the support (rafter)."
          },
          {
            "name": "dDistBetweenNail",
            "technicalDefault": "U(20)",
            "businessMeaning": "The maximum allowable spacing between nails in a cluster. A value of 0 results in exactly one nail point (single nailing).",
            "validRange": "0 (single nail) to 300+",
            "unit": "mm",
            "affectsOutput": "Controls the density of nails. If > 0, generates multiple nails based on the contact length. If 0, generates a single nail per intersection."
          },
          {
            "name": "sSnap2Axis",
            "technicalDefault": "|No|",
            "businessMeaning": "Forces the nail points to project onto a line parallel to the rafter axis, ensuring straight nailing rows regardless of minor geometric deviations.",
            "validRange": "|No|, |Yes|",
            "unit": "bool",
            "affectsOutput": "Aligns nail points geometrically along the rafter axis rather than following the exact intersection contour."
          },
          {
            "name": "sContactDummy",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual separator header for settings related to the intermediate contact layer (e.g., counter-lath).",
            "validRange": "N/A (Display Only)",
            "unit": "text",
            "affectsOutput": "None"
          },
          {
            "name": "sMatContact",
            "technicalDefault": "\"   \"",
            "businessMeaning": "The material name of the intermediate layer (like a counter-batten) sitting between the rafter and the lath.",
            "validRange": "Any valid material name",
            "unit": "string",
            "affectsOutput": "Identifies the contact zone geometry which influences the valid nailing area. If blank, assumes direct contact between lath and rafter."
          },
          {
            "name": "dContactEdge",
            "technicalDefault": "0",
            "businessMeaning": "The edge offset for the contact material. 0 means the full contact surface is considered valid for nailing.",
            "validRange": "0 to Contact Width",
            "unit": "mm",
            "affectsOutput": "Reduces the effective contact area (shrinks the profile) for calculating nailing positions."
          },
          {
            "name": "sRafterDummy",
            "technicalDefault": "\"\"",
            "businessMeaning": "Visual separator header for settings related to the structural support beam (rafter).",
            "validRange": "N/A (Display Only)",
            "unit": "text",
            "affectsOutput": "None"
          },
          {
            "name": "dRafterEdge",
            "technicalDefault": "U(5)",
            "businessMeaning": "The inset from the edge of the rafter support face where nailing is prohibited or adjusted.",
            "validRange": "0 to Rafter Width",
            "unit": "mm",
            "affectsOutput": "Narrows the intersection area on the rafter, effectively limiting the nailing zone length."
          },
          {
            "name": "nToolingIndex",
            "technicalDefault": "1",
            "businessMeaning": "Selects the specific machine tool or nail group to use for production (e.g., Nail Gun 1 vs Nail Gun 2).",
            "validRange": "1 to N (defined in machine setup/CAM)",
            "unit": "index",
            "affectsOutput": "Assigns the generated nails to a specific tool number in the CAM/NC output."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMatNail",
            "effect": "Filtering logic; requires components with this specific material to exist in the element. If not found, the script reports no clusters found.",
            "cascade": []
          },
          {
            "trigger": "dDistBetweenNail = 0",
            "effect": "Overrides any calculated spacing logic to force a single nail point per intersection.",
            "cascade": []
          },
          {
            "trigger": "sMatContact",
            "effect": "Enables the contact zone logic. If populated, the script seeks components of this material between the rafter and the lath to calculate contact geometry.",
            "cascade": [
              "dContactEdge"
            ]
          },
          {
            "trigger": "dSupportEdge > 0",
            "effect": "Forces a transformation of the cluster points so the first nail aligns with this offset from the support edge, potentially overriding the calculated start position.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "ElemNailCluster",
            "description": "A collection of 3D points representing nail locations, added as tooling to the Element.",
            "appliedTo": "Roof Elements (ElementRoof)"
          }
        ]
      },
      "tokens_used": 9680,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User executes script 'hsbNailCluster'.",
          "2. Properties Dialog appears (or settings load from Catalog/ExecuteKey).",
          "3. Command Line Prompt: 'Select Element(s), <Enter> to select individual entities of one nailing cluster'.",
          "4. [Branch Point] User selects Roof Elements OR presses <Enter>.",
          "5. [Path - Element Mode] Script checks if an instance with identical settings already exists on the element.",
          "6. [Path - Element Mode] Instance attached to Element (Mode 0). Script scans element for beams/sheets matching 'Material' properties.",
          "7. [Path - Element Mode] Loops through all combinations of rafters and laths to calculate intersections.",
          "8. [Path - Individual Mode] Prompt: 'Select rafter or beam'.",
          "9. [Path - Individual Mode] Prompt: 'Select lath'.",
          "10. [Path - Individual Mode] Prompt: 'Select entities of contact zone' (Optional).",
          "11. [Path - Individual Mode] Properties (sMatNail, sMatContact) update based on selection; Dialog re-opens for confirmation.",
          "12. [Path - Individual Mode] Instance created for specific beam/sheet set (Mode 1).",
          "13. [Common] Nail points calculated based on offsets and spacing rules.",
          "14. [Common] ElemNailCluster tooling added to Element and geometry drawn in 3D.",
          "15. [Validation] If no valid clusters found, instance erases itself and reports to command line."
        ],
        "conditionalBranches": [
          {
            "condition": "User input at initial selection prompt",
            "path1": {
              "name": "Element Mode (Batch)",
              "steps": [
                "Select Element(s)",
                "Check for duplicate TSL instances on elements",
                "Attach script to element with Mode=0",
                "Iterate all GenBeams in element",
                "Filter beams/sheets by properties (sMatNail, sMatContact)",
                "Call MapIO for every intersection pair",
                "Add tooling to Element"
              ]
            },
            "path2": {
              "name": "Individual Mode (Single)",
              "steps": [
                "Press <Enter>",
                "Select specific Rafter/Beam",
                "Select specific Lath",
                "Select optional Contact Zone",
                "Attach script to selection with Mode=1",
                "Calculate single intersection",
                "Add tooling to Element"
              ]
            }
          },
          {
            "condition": "Context Menu command execution (on Element Mode instance)",
            "path1": {
              "name": "Explode Clusters",
              "steps": [
                "Right-click instance -> 'Create individual cluster nailings'",
                "Script iterates calculated clusters",
                "Creates new independent TSL instances (Mode 1) for each beam/sheet pair",
                "Original instance remains or is typically removed (depending on implementation, here it usually creates new ones alongside)"
              ]
            },
            "path2": {
              "name": "Standard Recalculation",
              "steps": [
                "Properties modified or geometry changed",
                "Script recalculates all clusters in Element Mode",
                "Updates existing tooling"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Duplicate Instance Check",
            "errorMessage": "'hsbNailCluster already attached to element [ElementNumber]'",
            "recovery": "User selects different elements or modifies properties of the existing instance manually."
          },
          {
            "check": "Valid Entities (Individual Mode)",
            "errorMessage": "Implicit failure (script does not proceed if entities are invalid/missing).",
            "recovery": "Ensure valid Beam and Sheet are selected during the manual prompts."
          },
          {
            "check": "Material Match (Element Mode)",
            "errorMessage": "'no beams or sheets found' or 'could not collect any clusters...'",
            "recovery": "Verify that the 'Material' properties in the script (sMatNail, sMatContact) match the actual material names assigned to the Sheets/Beams in the drawing."
          },
          {
            "check": "Cluster Generation Result",
            "errorMessage": "'could not collect any clusters of element [ElementNumber] with material [MaterialName]'",
            "recovery": "Check geometric intersections; ensure laths actually cross rafters; check edge offsets (dNailEdge, dRafterEdge) which might be shrinking the valid area to zero."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Nailing Parameters",
            "how": "Properties Palette (OPM)",
            "effect": "Changing 'Edge Offset', 'Nail Distance', or 'Material' triggers an immediate recalculation of nail points."
          },
          {
            "action": "Explode to Individual Instances",
            "how": "Right-click Context Menu -> 'Create individual cluster nailings'",
            "effect": "Converts the smart Element-based logic into specific instances for each joint, allowing for granular manual edits of specific nails later."
          },
          {
            "action": "Geometry Modification",
            "how": "Grip edits or Move commands on Beams/Sheets",
            "effect": "Since the script relies on GenBeam geometry, moving a lath or rafter triggers the TSL to recalculate the nail positions to follow the new intersection."
          }
        ]
      },
      "tokens_used": 11945,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbNailCluster\n\n## Overview\nAutomates the calculation and generation of nail patterns (ElemNailCluster) at intersections between roofing components like rafters, counter-battens, and laths based on material assignments and geometric constraints.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates on 3D Elements, Beams, and Sheets. |\n| Paper Space | No | Not designed for 2D layouts. |\n| Shop Drawing | No | Production data is written to the model, not drawing views. |\n\n## Prerequisites\n- **Required Entities**: Roof Elements containing structural beams (rafters) and sheets (laths/boards).\n- **Minimum Beam Count**: 0 (Script can be inserted manually on specific entities).\n- **Required Settings**: Materials must be correctly assigned to your beams and sheets in the drawing for the script to filter them correctly.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or select from hsbCAD toolbar) â†’ Select `hsbNailCluster.mcr`\n\n### Step 2: Select Elements or Entities\nThe script provides two different workflows depending on your initial input:\n\n**Option A: Batch Mode (Recommended for full roofs)**\n```\nCommand Line: Select Element(s), <Enter> to select individual entities of one nailing cluster\nAction: Select one or multiple Roof Elements in the model.\n```\nThe script will automatically attach to the elements and scan for all beams and sheets matching the specified materials.\n\n**Option B: Individual Mode (For specific joints)**\n```\nCommand Line: Select Element(s), <Enter> to select individual entities of one nailing cluster\nAction: Press <Enter> on the command line.\n```\n```\nCommand Line: Select rafter or beam\nAction: Click on the structural beam (e.g., rafter) supporting the nailing.\n```\n```\nCommand Line: Select lath\nAction: Click on the sheet or lath to be nailed onto the beam.\n```\n```\nCommand Line: Select entities of contact zone\nAction: (Optional) Select intermediate components (e.g., counter-battens) if applicable, or press Enter to skip.\n```\n\n### Step 3: Configure Properties\nAfter selection, the Properties Palette will open. Configure the material names and offsets to define the nailing pattern. See the *Properties Panel Parameters* section below for details.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Nailing Zone** | | | *Group Header* |\n| Material | text | (blank) | The material name assigned to the lath/sheet to be nailed. Must match the material in the drawing. |\n| Edge Offset | number | U(5) | Minimum distance from the edge of the lath where nailing may start. |\n| Edge Offset Support (0 to ignore) | number | U(15) | Distance from the support edge (rafter) to align the first nail. Set to 0 to ignore. |\n| Nail Distance | number | U(20) | Maximum spacing between nails. Set to **0** for a single nail per intersection. |\n| Snap Nails to Axis | dropdown | No | Projects nail points onto an axis parallel to the rafter. Ensures straight rows. |\n| **Contact Zone** | | | *Group Header* |\n| Material | text | (blank) | Material name of the intermediate layer (e.g., counter-batten). |\n| Edge Offset (0 to ignore) | number | 0 | Reduces the effective contact area of the intermediate material. |\n| **Zone 0** | | | *Group Header* |\n| Edge Offset Zone 0 | number | U(5) | Inset from the edge of the rafter face where nailing is prohibited. |\n| **General** | | | *Group Header* |\n| Tooling index | number | 1 | The machine tool number (e.g., nail gun index) assigned for production. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Create individual cluster nailings | Converts the smart Element-level instance into multiple independent instances, one for each specific beam/lath intersection. Allows for granular editing of specific joints. |\n\n## Settings Files\n- **None**: This script relies entirely on Properties Palette settings and geometry within the current drawing.\n\n## Tips\n- **Material Matching**: Ensure the text entered in the `Material` fields exactly matches the material names defined in your catalog or assigned to the entities.\n- **Single Nail**: For joist hangers or specific single-point connections, set `Nail Distance` to `0`.\n- **Alignment**: Use the `Edge Offset Support` parameter to align the first nail in a row to a specific reference point on the rafter (e.g., align with the roof edge).\n- **Visual Debugging**: If no nails appear, check your command line. The script reports if no clusters were found due to material mismatches or geometries that do not intersect.\n\n## FAQ\n- **Q: I get the message \"hsbNailCluster already attached to element\".**\n  - **A**: An instance of this script already exists on that Element. Select the existing instance in the model and modify its properties in the palette, or delete it to insert a new one.\n- **Q: No nails are generated even though I selected the elements.**\n  - **A**: Verify that the `Material` property in the script matches the material of the laths in the drawing. Also, check if the `Edge Offset` values are larger than the width of the material, effectively reducing the valid nailing area to zero.\n- **Q: How do I change the nail gun used for production?**\n  - **A**: Modify the `Tooling index` property. This number corresponds to the tool definitions in your CAM/Machine setup."
      },
      "tokens_used": 7314,
      "error": null
    }
  }
}