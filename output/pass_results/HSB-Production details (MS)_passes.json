{
  "filename": "HSB-Production details (MS).mcr",
  "status": "completed",
  "total_tokens": 55765,
  "processing_time": 277.91665625572205,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9457,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicitly creates instances using _kModelSpace in dbCreate(). Operates on Element objects (_Element[0]). Assigns visual displays to element zones in 3D. No usage of _Viewport or paper space coordinate transformations."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": [
            "Dimension styles"
          ]
        }
      },
      "tokens_used": 7166,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select element(s)|\",\n        \"condition\": \"_bOnInsert && bAutoMode\",\n        \"required\": true\n      },\n      {\n        \"step\": 1,\n        \"function\": \"getElement\",\n        \"promptOriginal\": \"Select an element\",\n        \"condition\": \"_bOnInsert && !bAutoMode\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"Select an insertion point\",\n        \"condition\": \"_bOnInsert && !bAutoMode\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"ShowDynamicDialog\",\n      \"trigger\": \"On Insert (if _kExecuteKey does not match catalog)\",\n      \"title\": null,\n      \"dataSource\": \"Local Properties\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dSizeDetail\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Size|\",\n      \"defaultValue\": \"500\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dSectionDepth\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Depth|\",\n      \"defaultValue\": \"500\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"textOffsetProp\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"|Text offset|\",\n      \"defaultValue\": \"0\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sDetailName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Detail name|\",\n      \"defaultValue\": \"A\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 31,\n      \"variable\": \"detailPrefix\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Detail filename prefix|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Sets the prefix for the filename. E.g. If the prefix is set to 'Det' and the detail name is '05', the file linked to it should be named 'Det05'.|\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sDetailDescription\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Detail description|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimension style\",\n      \"defaultValue\": \"_DimStyles\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\"_DimStyles\"],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColorLine\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Line color\",\n      \"defaultValue\": \"1\",\n      \"inputType\": \"number"
      },
      "tokens_used": 10134,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts a 3D production detail marker (tag) onto a timber element to identify section locations and links them to specific filenames or drawing views.",
          "category": "ShopDrawing / Annotation",
          "typicalUseCase": "Used by a detailer to mark specific walls, floors, or openings in the 3D model that require specific 2D detail drawings or sections, ensuring the naming and file linking conventions are correct for downstream production drawings."
        },
        "parameters": [
          {
            "name": "dSizeDetail",
            "technicalDefault": "500",
            "businessMeaning": "The graphical size (height/width) of the detail marker (the box or section cut symbol) drawn on the element.",
            "validRange": "100 - 2000",
            "unit": "mm",
            "affectsOutput": "Scales the 3D polyline box representing the detail marker."
          },
          {
            "name": "dSectionDepth",
            "technicalDefault": "500",
            "businessMeaning": "Metadata defining the depth of the section cut to be generated for this detail.",
            "validRange": "0 - 5000",
            "unit": "mm",
            "affectsOutput": "Passed to the script instance; likely used by downstream drawing generation tools to determine how far back the section cut extends in the 2D view."
          },
          {
            "name": "textOffsetProp",
            "technicalDefault": "0",
            "businessMeaning": "The distance between the detail marker and the text label (Name/Description). If 0, it defaults to 40% of the marker size.",
            "validRange": "0 - 1000",
            "unit": "mm",
            "affectsOutput": "Moves the text label closer to or further from the marker geometry."
          },
          {
            "name": "sDetailName",
            "technicalDefault": "A",
            "businessMeaning": "The unique identifier for the detail (e.g., 'A', '1', 'DTL-01') displayed on the model and used for linking.",
            "validRange": "String (Alphanumeric)",
            "unit": "text",
            "affectsOutput": "Updates the primary text label and the filename key stored in the element's MapX data."
          },
          {
            "name": "detailPrefix",
            "technicalDefault": "",
            "businessMeaning": "A prefix added to the detail name to form the full drawing filename (e.g., 'Detail_' + 'A' = 'Detail_A').",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Modifies the string stored in the element MapX, ensuring the CAD system looks for the correct external drawing reference."
          },
          {
            "name": "sDetailDescription",
            "technicalDefault": "",
            "businessMeaning": "Secondary text providing more specific information about the detail (e.g., 'Top Plate Connection').",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Draws a secondary line of text below the detail name."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The specific CAD dimension/text style to be used for the detail labels.",
            "validRange": "Existing Dimension Styles",
            "unit": "style",
            "affectsOutput": "Changes the font, height, and appearance of the text labels."
          },
          {
            "name": "nColorLine",
            "technicalDefault": "1",
            "businessMeaning": "The CAD color index for the detail marker graphic (the box/line).",
            "validRange": "0 - 255 (CAD Index)",
            "unit": "color index",
            "affectsOutput": "Changes the color of the drawn PLine geometry."
          },
          {
            "name": "nColorText",
            "technicalDefault": "7",
            "businessMeaning": "The CAD color index for the detail text labels.",
            "validRange": "0 - 255 (CAD Index)",
            "unit": "color index",
            "affectsOutput": "Changes the color of the drawn text."
          },
          {
            "name": "sDrawSectionLine",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the visibility of the physical section marker graphic (box).",
            "validRange": "Yes/No",
            "unit": "boolean",
            "affectsOutput": "If 'No', hides the graphical box but keeps the text labels."
          },
          {
            "name": "sApplyDetailsTo",
            "technicalDefault": "Zone 0",
            "businessMeaning": "Selects the specific Element Zone (3D layer within the element) where the graphics are drawn.",
            "validRange": "Zone 0 - 10 (or specific negative zones)",
            "unit": "zone index",
            "affectsOutput": "Assigns the graphics to a specific sub-layer of the element, controlling visibility in different model views."
          },
          {
            "name": "sZoneCharacter",
            "technicalDefault": "I",
            "businessMeaning": "Assigns the layer type character for the detail graphics (e.g., 'I' for Information, 'D' for Dimensions).",
            "validRange": "E, Z, T, I, C, D, J",
            "unit": "layer type",
            "affectsOutput": "Determines the final layer name generation (e.g., 'I0' for Info Zone 0) for the graphics."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "textOffsetProp is set to 0",
            "effect": "The script calculates the offset automatically as 40% of the dSizeDetail value.",
            "cascade": [
              "textOffsetProp",
              "dSizeDetail"
            ]
          },
          {
            "trigger": "detailPrefix is set",
            "effect": "The MapX key for the detail is created by concatenating [detailPrefix] + [sDetailName].",
            "cascade": [
              "detailPrefix",
              "sDetailName",
              "Element MapX Data"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PLine (3D)",
            "description": "A rectangular box or section cut graphic indicating the location and direction of the detail view.",
            "appliedTo": "Selected Element (on the specified Element Zone)"
          },
          {
            "type": "Text",
            "description": "The Detail Name and Description labels placed adjacent to the marker.",
            "appliedTo": "Selected Element (on the specified Element Zone)"
          },
          {
            "type": "MapX Data",
            "description": "A data entry attached to the Element listing the detail names and prefixes, used for downstream drawing generation and file linking.",
            "appliedTo": "Selected Element (Properties/SubMapX)"
          }
        ]
      },
      "tokens_used": 10694,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch",
          "2. [Conditional] Check for Execute Key (Catalog usage)",
          "3. [Conditional] Show Dynamic Dialog (if no Execute Key found) to set properties (Name, Size, Depth, Prefix, etc.) and Auto-Insert flags",
          "4. [Branch] Determine Insertion Mode based on 'Auto insert' property",
          "5. [Path A: Auto Insert Mode] Select Element(s) via PrEntity",
          "6. [Path A] Iterate elements: Calculate geometry (Top, Bottom, Left, Right, Corners, Openings)",
          "7. [Path A] Insert Child TSL instances at calculated locations",
          "8. [Path A] Erase Master TSL Instance (Script finishes)",
          "9. [Path B: Manual Insert Mode] Select Single Element via getElement",
          "10. [Path B] Select Insertion Point via getPoint",
          "11. [Path B] Calculate Section Vector based on closest element edge",
          "12. Write geometric data (Vectors, Reference Point) to Instance Map",
          "13. Append Element to script",
          "14. [Execution Pass] Retrieve stored Vectors and Element Data",
          "15. Calculate Text Offset (Default 40% size or specific value)",
          "16. [Conditional] Draw Section Line (Box) if 'Draw section line' is Yes",
          "17. Draw Detail Name and Description Text",
          "18. Update Element SubMapX 'Details' with concatenated prefix+name",
          "19. Script Finish"
        ],
        "conditionalBranches": [
          {
            "condition": "Execute Key detected on insertion",
            "path1": {
              "name": "Catalog Preset",
              "steps": [
                "Load properties from catalog entry",
                "Skip Dynamic Dialog",
                "Proceed to Insertion Mode Check"
              ]
            },
            "path2": {
              "name": "Standard Insert",
              "steps": [
                "Show Dynamic Dialog for user input",
                "Proceed to Insertion Mode Check"
              ]
            }
          },
          {
            "condition": "Property 'Auto insert' is set to Yes",
            "path1": {
              "name": "Auto Mode (Batch)",
              "steps": [
                "Prompt user to select Element(s)",
                "Clear existing instances of this script on selected elements",
                "Calculate Brutto/Netto profiles to identify edges and openings",
                "Loop through potential locations (TL, L, BL, B, BR, R, TR, T, Openings)",
                "Check if location is valid (vertex exists, distance check passes)",
                "Check if specific location is enabled in properties (e.g., 'Top-Left' = Yes)",
                "Insert new TSL instance at location",
                "Erase the master script instance"
              ]
            },
            "path2": {
              "name": "Manual Mode (Single)",
              "steps": [
                "Prompt user to select single Element",
                "Prompt user to pick insertion point on element profile",
                "Find closest point on element profile to insertion point",
                "Calculate directional vectors (Section and Perpendicular)",
                "Determine if point is on an opening or main outline",
                "Store vectors in Map",
                "Keep master script instance attached to element"
              ]
            }
          },
          {
            "condition": "Context Menu Trigger 'Toggle opening detail' executed",
            "path1": {
              "name": "Toggle",
              "steps": [
                "Read current 'IsOpening' status from Map",
                "Flip status (True becomes False, False becomes True)",
                "Recalculate script graphics (may affect text side or visibility)"
              ]
            }
          },
          {
            "condition": "Property 'Text offset' is 0",
            "path1": {
              "name": "Default Offset",
              "steps": [
                "Calculate offset as 40% of 'Size' property"
              ]
            },
            "path2": {
              "name": "Custom Offset",
              "steps": [
                "Use explicit value from 'Text offset' property"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element selection",
            "errorMessage": "User cancels selection or no element found.",
            "recovery": "Script aborts insertion or erases instance."
          },
          {
            "check": "Geometric Vectors (Map Data)",
            "errorMessage": "No vector set! TSL is removed!",
            "recovery": "Script calls eraseInstance() immediately. Requires re-insertion or fixing Map data if manually edited."
          },
          {
            "check": "Detail Name Collision",
            "errorMessage": "None (Silent handling)",
            "recovery": "Script iterates existing TSLs on element and skips appending duplicate names to the Element MapX list, ensuring unique entries in the aggregate data."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Properties",
            "how": "OPM (Object Properties Manager)",
            "effect": "Users can change Detail Name, Description, Size, Depth, Colors, Visibility, and Text Offset. Updates are reflected immediately."
          },
          {
            "action": "Move Location",
            "how": "Grip Edit (Point)",
            "effect": "Moving the grip updates the graphical position of the section marker and text."
          },
          {
            "action": "Toggle Opening Status",
            "how": "Right-click Context Menu -> 'Toggle opening detail'",
            "effect": "Swaps the 'IsOpening' flag. This likely toggles the side of the element the text appears on (or other logic handling openings vs outer walls)."
          },
          {
            "action": "Delete",
            "how": "Standard AutoCAD Erase/Select",
            "effect": "Removes the specific instance. The Element MapX 'Details' list will be updated to remove this detail name the next time any instance of this script recalculates on that element."
          }
        ]
      },
      "tokens_used": 10840,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB-Production details (MS)\n\n## Overview\nInserts 3D production detail markers (tags) onto timber elements to identify specific section locations. This script links 3D model elements to external detail drawings using customizable naming conventions and supports both batch automatic placement and precise manual placement.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script creates geometry in 3D model space on Element Zones. |\n| Paper Space | No | Not intended for layout or paper space usage. |\n| Shop Drawing | No | Used in the model to prepare data for drawings, not directly on drawing sheets. |\n\n## Prerequisites\n- **Required Entities**: Element (Wall, Floor, Roof).\n- **Minimum Beams**: None (Operates on Elements).\n- **Required Settings**: Dimension Styles (Default: `_DimStyles` must exist in drawing).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse and select `HSB-Production details (MS).mcr`.\n\n### Step 2: Configure Properties (Dialog)\nUpon insertion, a dynamic dialog appears (unless run from a specific catalog preset):\n- **Detail Name**: Enter the unique ID (e.g., \"A\", \"1\").\n- **Detail Prefix**: Enter the file prefix (e.g., \"Det\"). The final linked filename will be \"Prefix + Name\" (e.g., \"DetA\").\n- **Auto Insert**: \n  - **Yes**: Automatically places markers on all detected corners/edges of selected elements.\n  - **No**: Allows manual placement of a single marker.\n- Set other properties like Size, Depth, and Colors as needed.\n- Click **OK** or **Insert**.\n\n### Step 3: Select Geometry\nThe command line prompt depends on the \"Auto Insert\" setting chosen in Step 2.\n\n**Scenario A: Auto Insert Mode (Batch)**\n```\nCommand Line: Select element(s)\nAction: Click one or multiple Elements in the model.\nResult: The script automatically scans the selected elements and inserts detail markers at calculated locations (corners, openings). The master instance is then erased.\n```\n\n**Scenario B: Manual Insert Mode (Single)**\n```\nCommand Line: Select an element\nAction: Click on the specific Element you want to tag.\n\nCommand Line: Select an insertion point\nAction: Click on the face/profile of the selected element where you want the detail marker to appear.\nResult: A single detail marker is placed at the picked location, aligned with the nearest element edge.\n```\n\n## Properties Panel Parameters\n\nThese properties can be edited via the AutoCAD Properties Palette (Ctrl+1) after insertion.\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Detail name | String | A | The unique identifier displayed on the marker (e.g., 'A', '01'). |\n| Detail filename prefix | String | (Empty) | Prefix added to the name to create the target drawing filename (e.g., Prefix 'Detail_' + Name 'A' links to file 'Detail_A'). |\n| Detail description | String | (Empty) | Secondary text label displayed below the main name. |\n| Size | Double | 500 mm | The graphical size (height/width) of the detail marker box. |\n| Depth | Double | 500 mm | Metadata defining the depth of the section cut for downstream detailing. |\n| Text offset | Double | 0 mm | Distance between the marker and the text. If set to 0, it defaults to 40% of the Size. |\n| Dimension style | String | _DimStyles | The text style used for the labels. |\n| Line color | Integer | 1 (Red) | CAD color index for the marker box/lines. |\n| Text color | Integer | 7 (White) | CAD color index for the text labels. |\n| Draw section line | String | Yes | Toggles visibility of the graphical section box (No = hides box, keeps text). |\n| Apply details to | String | Zone 0 | The Element Zone (sub-layer) where the graphics are drawn. |\n| Zone character | String | I | The layer type character (e.g., 'I' for Information) used to generate the layer name. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Toggle opening detail | Switches the logic flag indicating if the marker is associated with an opening or the main element outline. This may affect text positioning or visibility logic. |\n\n## Settings Files\n- **Dimension Styles**: Standard AutoCAD/hsbCAD dimension styles (defined by `sDimStyle`).\n- **Purpose**: Controls font, height, and appearance of the detail text labels.\n\n## Tips\n- **Batch Processing**: Use \"Auto Insert\" mode to quickly tag all corners and openings of a complex wall frame.\n- **Automatic Scaling**: Leave \"Text offset\" set to `0` to let the script automatically scale the text distance based on the \"Size\" parameter.\n- **File Linking**: Ensure your \"Prefix\" and \"Detail name\" combine exactly to match your external drawing filenames (e.g., DWG or PDF files).\n- **Grip Editing**: Select the marker and use the grip to move it to a different location on the element face.\n\n## FAQ\n- **Q: My detail markers disappeared, but the text is still there.**\n- **A:** Check the \"Draw section line\" property in the Properties Palette. It might be set to \"No\".\n- **Q: How do I link this to a specific drawing file?**\n- **A:** Use the \"Detail filename prefix\" and \"Detail name\" properties. If your drawing is `Section_05.dwg`, set Prefix to `Section_` and Name to `05`.\n- **Q: Can I tag multiple elements at once?**\n- **A:** Yes. Enable \"Auto insert\" in the initial dialog or properties, then run the script and select multiple elements when prompted.\n- **Q: The text is too small to read.**\n- **A:** Increase the \"Size\" parameter, or change the \"Dimension style\" to a style with larger text height settings."
      },
      "tokens_used": 7474,
      "error": null
    }
  }
}