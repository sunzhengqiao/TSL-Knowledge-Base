{
  "filename": "hsbX-Marking.mcr",
  "status": "completed",
  "total_tokens": 57557,
  "processing_time": 367.94587683677673,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9900,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `bm1.addTool(mrk)` to attach `Mark` and `MarkerLine` objects to beams, which is a Model Space operation. The `_bOnInsert` block contains a distributor pattern that calls `tsl.dbCreate` with the `_kModelSpace` argument. The script interacts with 3D entities using `PrEntity` (RoofPlane, Beam, TrussEntity) and checks for body intersections. There are no references to `_Viewport`, `_kPaperSpace`, or shopdrawing drawing contexts."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam",
            "RoofPlane",
            "TrussEntity"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7778,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && _kExecuteKey == \"\"",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "Select marking entities (roofplane and/or beams and/or trusses)",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity.go",
              "promptOriginal": "Select beams to be marked",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Property Dialog",
            "trigger": "On Insert (if not using catalog)",
            "title": null,
            "dataSource": "Global and local Property declarations",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "Face of marking",
            "defaultValue": "Front",
            "inputType": "dropdown",
            "options": [
              "Front",
              "Top",
              "Back",
              "Bottom"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "Side of marking",
            "defaultValue": "Both",
            "inputType": "dropdown",
            "options": [
              "Both",
              "Left",
              "Center",
              "Right",
              "None"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sPrefix",
            "type": "PropString",
            "displayName": "Prefix",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sAutoTxt",
            "type": "PropString",
            "displayName": "Autotext",
            "defaultValue": "PosNum",
            "inputType": "dropdown",
            "options": [
              "PosNum",
              "PosNum + Text",
              "None"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sTextPosition",
            "type": "PropString",
            "displayName": "Text Position",
            "defaultValue": "Bottom",
            "inputType": "dropdown",
            "options": [
              "Bottom",
              "Center",
              "Top"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sTextAlignment",
            "type": "PropString",
            "displayName": "Text Alignment",
            "defaultValue": "Right",
            "inputType": "dropdown",
            "options": [
              "Right",
              "Center",
              "Left"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "sDirection",
            "type": "PropString",
            "displayName": "Text Direction",
            "defaultValue": "normal",
            "inputType": "dropdown",
            "options": [
              "normal",
              "upside down",
              "back to front",
              "right vertical text",
              "front t o back",
              "left vertical text"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sDir",
            "type": "PropString",
            "displayName": "Direction of marking",
            "defaultValue": "Along marking beam",
            "inputType": "dropdown",
            "options": [
              "Along marking beam",
              "Recangular on marked beam"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nDimColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 92,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Mark top edge",
            "handler": "Mark top edge",
            "action": "Sets orientation to mark the top edge",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Mark bottom edge",
            "handler": "Mark bottom edge",
            "action": "Sets orientation to mark the bottom edge",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 10434,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates automated assembly or position markings (text and lines) on specific beams based on their intersection with reference elements like roof planes, walls, or other beams.",
          "category": "Framing/Construction",
          "typicalUseCase": "Labeling rafters where they intersect with purlins, or marking wall studs where they meet top/bottom plates, to ensure correct placement during assembly."
        },
        "parameters": [
          {
            "name": "sFace",
            "technicalDefault": "Front",
            "businessMeaning": "Specifies the exact face of the target beam (Front, Top, Back, Bottom) where the marking should be applied, relative to the beam's local coordinate system.",
            "validRange": "Front, Top, Back, Bottom",
            "unit": "Enum",
            "affectsOutput": "Moves the marking tool (text and line) to the selected surface of the timber."
          },
          {
            "name": "sSide",
            "technicalDefault": "Both",
            "businessMeaning": "Determines the horizontal placement of the mark along the intersection line, allowing for marks at the start (Left), end (Right), middle (Center), both ends, or no lines (None).",
            "validRange": "Both, Left, Center, Right, None",
            "unit": "Enum",
            "affectsOutput": "Controls the position and number of marker lines generated (e.g., one line at center, two lines at edges)."
          },
          {
            "name": "sPrefix",
            "technicalDefault": "",
            "businessMeaning": "Allows the user to prepend custom text to the automatic mark (e.g., 'W-' for Wall, 'R-' for Roof) for better identification on site or in the shop.",
            "validRange": "Any alphanumeric string",
            "unit": "Text",
            "affectsOutput": "Modifies the text string displayed by the Mark tool."
          },
          {
            "name": "sAutoTxt",
            "technicalDefault": "PosNum",
            "businessMeaning": "Selects the source of the marking content, choosing between the Position Number, Position Number plus Text comment, or no automatic text.",
            "validRange": "PosNum, PosNum + Text, None",
            "unit": "Enum",
            "affectsOutput": "Determines the content of the text label (the 'what' to write)."
          },
          {
            "name": "sTextPosition",
            "technicalDefault": "Bottom",
            "businessMeaning": "Sets the vertical alignment of the text relative to the marking line to avoid overlapping with other geometry or marks.",
            "validRange": "Bottom, Center, Top",
            "unit": "Enum",
            "affectsOutput": "Vertically shifts the text relative to the marker line."
          },
          {
            "name": "sTextAlignment",
            "technicalDefault": "Right",
            "businessMeaning": "Sets the horizontal justification of the text relative to the insertion point.",
            "validRange": "Right, Center, Left",
            "unit": "Enum",
            "affectsOutput": "Horizontally shifts the text anchor point."
          },
          {
            "name": "sDirection",
            "technicalDefault": "normal",
            "businessMeaning": "Controls the rotation and reading direction of the text to ensure it is readable by the machine operator or carpenter (e.g., reading from left to right, or reading from inside the building).",
            "validRange": "normal, upside down, back to front, right vertical text, front t o back, left vertical text",
            "unit": "Enum",
            "affectsOutput": "Rotates the text string."
          },
          {
            "name": "sDir",
            "technicalDefault": "Along marking beam",
            "businessMeaning": "Defines the geometric logic of the marking. 'Along marking beam' follows the angle of the intersecting element (useful for skewed cuts). 'Recangular' projects the mark vertically/horizontally relative to the beam being marked.",
            "validRange": "Along marking beam, Recangular on marked beam",
            "unit": "Enum",
            "affectsOutput": "Changes the angle and coordinates of the generated MarkerLines."
          },
          {
            "name": "nDimColor",
            "technicalDefault": "92",
            "businessMeaning": "Sets the CAD color index for the marking lines to distinguish them from other geometry or dimensions in the drawing.",
            "validRange": "0-255 (Standard ACI)",
            "unit": "Color Index",
            "affectsOutput": "Changes the visual color of the display lines and markers in the 3D model and drawings."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sDir is set to 'Recangular on marked beam'",
            "effect": "Enables a Right-Click context menu option ('Mark top edge' / 'Mark bottom edge') to toggle the orientation of the marking.",
            "cascade": [
              "Context Menu Items"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mark",
            "description": "A production annotation object containing text information (Position Number/Prefix) to be printed on the timber or visible in shop drawings.",
            "appliedTo": "The beams selected to be marked (_Beam[1])."
          },
          {
            "type": "MarkerLine",
            "description": "A geometric line tool drawn on the surface of the timber to visually indicate the location of the intersecting element, often corresponding to a notch or cut.",
            "appliedTo": "The beams selected to be marked (_Beam[1])."
          }
        ]
      },
      "tokens_used": 10363,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User launches script (Command or Catalog)",
          "2. Script checks insertCycleCount (Erases if > 1 to prevent duplicates)",
          "3. Determine execution source",
          "4. User selects 'Marking Entities' (RoofPlanes, Beams, or Trusses)",
          "5. System filters selection (Removes plates, extracts beams from RoofPlanes)",
          "6. User selects 'Target Beams' (Beams to be marked)",
          "7. System loops through Target Beams and Marking Entities",
          "8. Check for geometric intersection and tolerance",
          "9. Check if entities are parallel (Skips if parallel)",
          "10. Create specific TSL instance for each valid pair",
          "11. Erase the 'Distributor' instance",
          "12. Instance executes: Extracts coordinate systems and geometry",
          "13. Calculate intersection planes and points (16 initial points)",
          "14. Filter and refine intersection lines to 8 valid lines",
          "15. Generate Mark (Text) and MarkerLine (Graphics) tools based on properties",
          "16. Attach tools to the Target Beam"
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Source (_kExecuteKey)",
            "path1": {
              "name": "Manual Insert",
              "steps": [
                "Show Property Dialog (showDialog)",
                "User confirms properties",
                "Proceed to Selection"
              ]
            },
            "path2": {
              "name": "Catalog Insert",
              "steps": [
                "Load properties from Catalog (setPropValuesFromCatalog)",
                "Skip Dialog",
                "Proceed to Selection"
              ]
            }
          },
          {
            "condition": "Direction of Marking (sDir)",
            "path1": {
              "name": "Along marking beam (0)",
              "steps": [
                "Use intersection lines aligned with the marking entity",
                "Create MarkerLines (Left, Center, and/or Right)",
                "Create Mark (Text) attached to lines"
              ]
            },
            "path2": {
              "name": "Rectangular on marked beam (1)",
              "steps": [
                "Enable Orientation Context Menu (Top/Bottom edge toggle)",
                "Project marking perpendicular to target beam",
                "Create Mark (Text) only (No MarkerLine tools based on code snippet)",
                "Draw visual display lines only"
              ]
            }
          },
          {
            "condition": "Side of Marking (sSide)",
            "path1": {
              "name": "Both (0)",
              "steps": [
                "Generate Left MarkerLine",
                "Generate Right MarkerLine",
                "Generate Text spanning both"
              ]
            },
            "path2": {
              "name": "Left (1) or Right (3)",
              "steps": [
                "Generate single MarkerLine on selected side",
                "Generate Text at that side"
              ]
            },
            "path3": {
              "name": "Center (2)",
              "steps": [
                "Generate Center MarkerLine",
                "Generate Text at center point"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Intersection Geometry Calculation",
            "errorMessage": "Unexpected error. Instance deleted",
            "recovery": "Script automatically erases the invalid instance. User must check geometry complexity or orientation and re-insert."
          },
          {
            "check": "Parallel Beam Check",
            "errorMessage": "(None - Silent failure)",
            "recovery": "If the Marking Entity is parallel to the Target Beam, no instance is created. User must ensure selected beams actually cross."
          },
          {
            "check": "Tolerance Range",
            "errorMessage": "(None - Silent failure)",
            "recovery": "If beams do not physically touch within the 'Detection Range' (default 5mm), no instance is created. User can adjust properties or geometry."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Properties",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Prefix, Text Position, Color, Face, Side, and Direction. Triggers recalculation of tools."
          },
          {
            "action": "Toggle Orientation (Top/Bottom Edge)",
            "how": "Right-click Context Menu (Available only when 'Direction of marking' = 'Rectangular on marked beam')",
            "effect": "Toggles the internal 'Orientation' integer state. Switches the marking between the top and bottom intersection edge of the rectangular face."
          }
        ]
      },
      "tokens_used": 11997,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbX-Marking.mcr\n\n## Overview\nThis script automatically generates position marks (text) and visual indicator lines on timber beams. It detects intersections between selected elements (such as roof planes or purlins) and target beams, applying annotations to indicate assembly locations.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates exclusively in the 3D model. |\n| Paper Space | No | Not applicable for 2D drawings. |\n| Shop Drawing | No | Marks are applied to the 3D model for production or detailing. |\n\n## Prerequisites\n- **Required Entities**: You must have at least two sets of elements in the model:\n    - **Marking Entities**: Roof planes, beams, or trusses that define *where* the mark should be placed.\n    - **Target Beams**: The beams you want to mark (e.g., rafters or studs).\n- **Minimum Beam Count**: At least one marking entity and one target beam that physically intersect.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbX-Marking.mcr`\n*Alternatively, drag and drop the script from your catalog browser into the model.*\n\n### Step 2: Configure Properties (Optional)\nUpon insertion, a properties dialog may appear (depending on your configuration).\n- Adjust settings such as **Prefix**, **Text Position**, or **Color** if needed.\n- Click OK to confirm.\n\n### Step 3: Select Marking Entities\n```\nCommand Line: Select marking entities (roofplane and/or beams and/or trusses)\nAction: Click on the elements that define the intersection line (e.g., a purlin crossing several rafters). Press Enter to confirm selection.\n```\n\n### Step 4: Select Target Beams\n```\nCommand Line: Select beams to be marked\nAction: Click on the beams that require the marking (e.g., the rafters intersected by the purlin selected in Step 3). Press Enter to confirm.\n```\n\n### Step 5: Generation\nThe script calculates intersections and automatically places the marks and lines on the selected beams.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Face of marking | dropdown | Front | Selects which side of the beam receives the mark (Front, Top, Back, Bottom). |\n| Side of marking | dropdown | Both | Determines the placement along the intersection: Both edges, Left edge, Center, Right edge, or None. |\n| Prefix | text | | Adds custom text before the automatic position number (e.g., \"W-\" for Wall). |\n| Autotext | dropdown | PosNum | Sets the text content: Position Number, Position Number + Text comment, or None. |\n| Text Position | dropdown | Bottom | Vertical alignment of the text relative to the marking line (Bottom, Center, Top). |\n| Text Alignment | dropdown | Right | Horizontal justification of the text (Right, Center, Left). |\n| Text Direction | dropdown | normal | Controls the reading orientation (e.g., normal, upside down, vertical). |\n| Direction of marking | dropdown | Along marking beam | **Key Setting**: <br>• *Along marking beam*: Follows the angle of the intersecting element.<br>• *Recangular on marked beam*: Projects the mark vertically/horizontally relative to the beam. |\n| Color | number | 92 | Sets the CAD color index for the marking lines and text. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Mark top edge | Switches the marking location to the top intersection edge. (Only available when \"Direction of marking\" is set to \"Recangular on marked beam\"). |\n| Mark bottom edge | Switches the marking location to the bottom intersection edge. (Only available when \"Direction of marking\" is set to \"Recangular on marked beam\"). |\n\n## Settings Files\n- None required. This script relies on the geometric properties of the selected entities and standard OPM (Object Property Model) inputs.\n\n## Tips\n- **Distributor Behavior**: This script acts as a \"distributor.\" Once it runs, it creates individual marks on the beams and the main script instance is removed. To edit marks later, select the specific mark on the beam and adjust its properties in the Properties Palette.\n- **Rectangular Mode**: If you need to toggle the mark between the top and bottom edge of a connection (e.g., on a plate), set **Direction of marking** to \"Recangular on marked beam\" and use the Right-Click menu on the specific mark.\n- **Intersections Required**: Ensure elements physically touch or overlap within the default tolerance (approx. 5mm). If beams are parallel or too far apart, no mark will be generated.\n\n## FAQ\n- **Q: Why did no marks appear on my beam?**\n  **A:** The script skips beams that are parallel to the marking element or do not physically intersect within the tolerance range. Check your geometry to ensure the elements actually cross each other.\n\n- **Q: How can I change the text after inserting?**\n  **A:** Select the specific marking (line or text) on the beam. Open the Properties Palette (Ctrl+1) and modify the **Prefix**, **Text Position**, or **Autotext** fields.\n\n- **Q: Can I mark multiple beams at once?**\n  **A:** Yes. In Step 4, you can window select multiple beams. The script will loop through all selected beams and place marks where they intersect with the entities selected in Step 3."
      },
      "tokens_used": 7085,
      "error": null
    }
  }
}