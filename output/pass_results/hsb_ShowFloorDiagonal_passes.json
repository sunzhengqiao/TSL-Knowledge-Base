{
  "filename": "hsb_ShowFloorDiagonal.mcr",
  "status": "completed",
  "total_tokens": 31276,
  "processing_time": 177.27103185653687,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "11.04.2011",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "Release Version"
          },
          {
            "version": "1.1",
            "date": "06.07.2011",
            "author": "",
            "changes": "Fix direction of Text"
          },
          {
            "version": "1.2",
            "date": "24.11.2014",
            "author": "",
            "changes": "Add filter by code"
          },
          {
            "version": "1.3",
            "date": "24.11.2021",
            "author": "",
            "changes": "Change extractContactFaceInPlane for shadowProfile"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4644,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Viewport vp = getViewport(\"Select the viewport from which the element is taken\"); _Viewport.append(vp); Viewport vp = _Viewport[_Viewport.length()-1]; CoordSys ms2ps = vp.coordSys(); dp.dimStyle(strDimStyle, ps2ms.scale()); dimDiag.transformBy(ms2ps);"
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Must be executed within a Layout Viewport containing an hsbCAD Element.",
          "requiredSettings": []
        }
      },
      "tokens_used": 2825,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "Select the viewport from which the element is taken",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "strDimStyle",
            "type": "PropString",
            "displayName": "Dim style",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dbTH",
            "type": "PropDouble",
            "displayName": "Text Heigth",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nZones",
            "type": "PropInt",
            "displayName": "Zone to calculate diagonal",
            "defaultValue": "0",
            "inputType": "dropdown",
            "options": [
              "0",
              "1",
              "2",
              "3",
              "4",
              "5",
              "6",
              "7",
              "8",
              "9",
              "10"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sFilterExcludeBMC",
            "type": "PropString",
            "displayName": "Exclude Beam With BeamCode",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Set the code of the extra beams that you want to show int the beam dimension at the bottom of the panel. To add more than 1 use ';' after each code"
          },
          {
            "index": 1,
            "variable": "iColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": "3",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6016,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically calculates and dimensions the maximum diagonal length of a timber floor or roof panel within a Layout Viewport, displaying the measurement in Paper Space.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used by detailers to annotate production drawings with the diagonal dimension of a panel, often required for bracing calculations, structural verification, or transport logistics."
        },
        "parameters": [
          {
            "name": "strDimStyle",
            "technicalDefault": "\"\"",
            "businessMeaning": "Selects the specific dimension style (e.g., arrow style, text font) to be used for the diagonal annotation, ensuring it matches the project's drafting standards.",
            "validRange": "Any available dimension style in the current AutoCAD template.",
            "unit": "String (Name)",
            "affectsOutput": "Alters the graphical appearance (lines, arrows, ticks, text font) of the dimension entity in the drawing."
          },
          {
            "name": "dbTH",
            "technicalDefault": "1",
            "businessMeaning": "Sets the absolute height of the dimension text in Paper Space (on the printed page), ensuring the annotation is legible regardless of the viewport scale.",
            "validRange": "1.5 - 3.0 mm (Standard architectural text heights for drawings)",
            "unit": "mm (Paper Space)",
            "affectsOutput": "Resizes the text label of the diagonal length. Larger values increase text size on the plot."
          },
          {
            "name": "nZones",
            "technicalDefault": "0",
            "businessMeaning": "Filters which part of the element is measured. '0' measures the overall assembled panel geometry; '1' to '5' (or negative equivalents) measures specific construction layers (Floors/Roofs) defined in the element.",
            "validRange": "0 to 5 (Integer)",
            "unit": "Index (Integer)",
            "affectsOutput": "Changes the boundary polygon used for calculation. If 0, calculates based on the composite profile of all beams. If >0, calculates based on the envelope of the specific floor/roof sheet selected."
          },
          {
            "name": "sFilterExcludeBMC",
            "technicalDefault": "\"\"",
            "businessMeaning": "Excludes specific structural components (like blocking, trimmers, or gable studs) from the diagonal calculation based on their Beam Code, preventing them from skewing the main panel dimension.",
            "validRange": "String list of Beam Codes separated by ';'",
            "unit": "String",
            "affectsOutput": "Modifies the calculated 2D profile by removing the 'shadow' of beams matching the excluded codes, potentially reducing the calculated diagonal distance."
          },
          {
            "name": "iColor",
            "technicalDefault": "3",
            "businessMeaning": "Sets the CAD color index for the dimension line and text, allowing the dimension to be highlighted or color-coded (e.g., Green for measurements, Red for warnings).",
            "validRange": "1 to 255 (AutoCAD Color Index)",
            "unit": "Color Index",
            "affectsOutput": "Changes the on-screen and plotted color of the dimension entity."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFilterExcludeBMC is populated",
            "effect": "Filters the array of beams collected from the element, removing any that match the provided codes before generating the shadow profile.",
            "cascade": [
              "arBm",
              "ppContour"
            ]
          },
          {
            "trigger": "nZones is changed from 0",
            "effect": "Switches the logic for obtaining the vertex points from calculating a beam profile (shadow) to retrieving the pre-calculated envelope of a specific sheet.",
            "cascade": [
              "ptExtEle",
              "plElement"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Dimension",
            "description": "A linear dimension entity representing the maximum diagonal distance of the panel's 2D projection, transformed into Paper Space coordinates.",
            "appliedTo": "Layout Viewport (Paper Space)"
          }
        ]
      },
      "tokens_used": 4944,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch script: User executes hsb_ShowFloorDiagonal from palette or command line.",
          "2. Property Configuration: Initial properties are set (default values) or prompted via dialog if executed normally.",
          "3. Viewport Selection: User is prompted to select a Layout Viewport containing the target Element.",
          "4. Data Validation: Script verifies the selected Viewport contains valid hsbCAD element data.",
          "5. Filter Parsing: Script parses the 'Exclude Beam With BeamCode' string to identify beams to ignore.",
          "6. Coordinate System Setup: Calculates transformation matrices between Model Space and Paper Space.",
          "7. Geometry Extraction Branch: Determines geometry source based on 'Zone to calculate diagonal' property.",
          "8. Profile Generation: Creates a 2D contour from the collected geometry (Union of beam shadows or Sheet envelope).",
          "9. Diagonal Calculation: Iterates through contour vertices to find the pair with the maximum distance.",
          "10. Text Orientation Logic: Calculates the text direction vector to ensure readability (left-to-right) in Paper Space.",
          "11. Dimension Creation: Draws the calculated dimension line and text on the layout."
        ],
        "conditionalBranches": [
          {
            "condition": "Value of 'Zone to calculate diagonal' (nZoneIndex) is not 0",
            "path1": {
              "name": "Sheet Based Calculation",
              "steps": [
                "Retrieves specific Sheet entities based on the zone index.",
                "Extracts the pre-calculated envelope (PLine) from the Sheet(s).",
                "Uses these envelope vertices for diagonal measurement."
              ]
            },
            "path2": {
              "name": "Beam Based Calculation (Default)",
              "steps": [
                "Retrieves all Beams associated with the Element.",
                "Filters out beams matching the exclusion list.",
                "Calculates the 'shadow profile' (projection) of the remaining beams onto the element plane.",
                "Unions these profiles to find the outer boundary.",
                "Uses the outer boundary vertices for diagonal measurement."
              ]
            }
          },
          {
            "condition": "Beam Code matches a code in the 'Exclude Beam With BeamCode' list",
            "path1": {
              "name": "Exclude Beam",
              "steps": [
                "Beam is skipped during the geometry collection loop.",
                "Beam does not contribute to the shadow profile or final contour."
              ]
            },
            "path2": {
              "name": "Include Beam",
              "steps": [
                "Beam body is retrieved.",
                "Shadow profile is calculated and added to the main contour."
              ]
            }
          },
          {
            "condition": "Text direction vector in Paper Space points Left (Dot product with X-axis < 0)",
            "path1": {
              "name": "Flip Direction",
              "steps": [
                "Inverts the diagonal vector.",
                "Inverts the text direction vector.",
                "Ensures text reads left-to-right on the drawing."
              ]
            },
            "path2": {
              "name": "Keep Direction",
              "steps": [
                "Vector remains as calculated.",
                "Text is drawn using the initial vector orientation."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport contains valid hsbCAD Element",
            "errorMessage": "None (Silent failure)",
            "recovery": "Select a viewport that actually contains a processed hsbCAD element and run the script again."
          },
          {
            "check": "Beams found in Element (Zone 0) or Sheets found in Zone (!=0)",
            "errorMessage": "None (Silent failure)",
            "recovery": "Ensure the Element has construction data (beams or sheets) generated in the specified zone."
          },
          {
            "check": "Resulting Geometry has > 2 vertices",
            "errorMessage": "None (Silent failure - No dimension drawn)",
            "recovery": "Ensure the calculated contour is a valid polygon (not a line or point) by checking beam filters and geometry integrity."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Dimension Style",
            "how": "OPM Properties Palette",
            "effect": "Updates the arrow style, font, and formatting of the diagonal dimension."
          },
          {
            "action": "Adjust Text Height",
            "how": "OPM Properties Palette",
            "effect": "Resizes the dimension text height in Paper Space (mm)."
          },
          {
            "action": "Change Calculation Zone",
            "how": "OPM Properties Palette",
            "effect": "Switches measurement between the main panel assembly (0) and specific floor/roof layers."
          },
          {
            "action": "Filter Beams",
            "how": "OPM Properties Palette",
            "effect": "Modifies the exclusion list string, recalculating the diagonal based on the remaining beams."
          },
          {
            "action": "Change Color",
            "how": "OPM Properties Palette",
            "effect": "Changes the color index of the dimension entity."
          }
        ]
      },
      "tokens_used": 7180,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ShowFloorDiagonal\n\n## Overview\nCalculates and dimensions the maximum diagonal length of a timber floor or roof panel within a Layout Viewport. It is used to annotate production drawings with structural measurements required for bracing calculations or transport logistics.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script interacts specifically with Layout Viewports. |\n| Paper Space | Yes | This is the primary environment. Dimensions are created in Paper Space. |\n| Shop Drawing | Yes | Used to annotate production layouts. |\n\n## Prerequisites\n- **Layout Viewport**: A viewport on a layout tab that contains a valid hsbCAD Element.\n- **Element Data**: The selected element must have generated geometry (Beams or Sheets).\n- **Dimension Styles**: At least one dimension style must be loaded in the current AutoCAD drawing.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_ShowFloorDiagonal.mcr`\n\n### Step 2: Select Viewport\n```\nCommand Line: Select the viewport from which the element is taken\nAction: Click on the border of the viewport containing the element you wish to measure.\n```\n*The script will automatically calculate the diagonal and place the dimension in Paper Space.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dim style | Dropdown | (Current) | Selects the dimension style (arrow style, text font) for the annotation. |\n| Text Height | Number | 1 | Sets the text height in **mm** (Paper Space units). This ensures the text size remains constant regardless of viewport scale. |\n| Zone to calculate diagonal | Dropdown | 0 | Determines which part of the element is measured. `0` measures the entire assembly. `1`-`10` measures specific construction layers (floors/roofs). |\n| Exclude Beam With BeamCode | Text | (Empty) | Enter Beam Codes to exclude specific beams (e.g., blocking) from the calculation. Separate multiple codes with a semicolon `;`. |\n| Color | Number | 3 | Sets the AutoCAD Color Index for the dimension line and text (e.g., 3 = Green). |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add specific items to the right-click context menu. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: *None*\n- **Location**: *N/A*\n- **Purpose**: *N/A*\n\n## Tips\n- **Ignoring Blocking**: If you have blocking or trimmers sticking out of the main panel area, copy their Beam Codes into the \"Exclude Beam With BeamCode\" property. The script will then calculate the diagonal based on the main structural shape only.\n- **Layer Specifics**: If you only need the diagonal of a specific floor sheet (e.g., the top layer), change the \"Zone to calculate diagonal\" to the corresponding index number.\n- **Text Readability**: The script automatically calculates text orientation to ensure the dimension text reads from left to right. If you manually adjust the dimension grip afterwards, it may override this logic.\n\n## FAQ\n- **Q: Why didn't the dimension appear?**\n  - **A**: Ensure the selected Viewport actually contains an hsbCAD Element. Also, check if your \"Exclude Beam With BeamCode\" filter accidentally removed all geometry, or if the \"Zone\" selected contains no data.\n- **Q: Can I change the units of the dimension?**\n  - **A**: The dimension units are controlled by your AutoCAD dimension style settings (set in the *Dim style* property), not directly by the script.\n- **Q: The text is too small to read on the printed plot.**\n  - **A**: Increase the *Text Height* property in the palette. Since this value is in Paper Space mm, increasing it to 2.5 or 3.0 will make it larger on the plot without affecting the model geometry."
      },
      "tokens_used": 5667,
      "error": null
    }
  }
}