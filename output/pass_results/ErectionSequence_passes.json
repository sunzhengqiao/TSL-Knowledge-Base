{
  "filename": "ErectionSequence.mcr",
  "status": "completed",
  "total_tokens": 51796,
  "processing_time": 230.81967544555664,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": null,\n  \"versionHistory\": [\n    {\n      \"version\": \"1.8\",\n      \"date\": \"26.01.2022\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"HSB-14337 new property 'SequenceNumberText' appended to enable text based sorting of numbers, i.e. 0001, 0002, .... 0011, 0012. Use this property for any sorting purpose instead of 'SequenceNumber'\"\n    },\n    {\n      \"version\": \"1.07\",\n      \"date\": \"28aug2020\",\n      \"author\": \"nils.gregor@hsbcad.com\",\n      \"changes\": \"HSB-8663 Corrected sequence numbers\"\n    },\n    {\n      \"version\": \"1.06\",\n      \"date\": \"24jul2020\",\n      \"author\": \"nils.gregor@hsbcad.com\",\n      \"changes\": \"HSB-8095 remove sequence numbers\"\n    },\n    {\n      \"version\": \"1.05\",\n      \"date\": \"01jul2020\",\n      \"author\": \"nils.gregor@hsbcad.com\",\n      \"changes\": \"HSB-8094 respect start number\"\n    },\n    {\n      \"version\": \"1.04\",\n      \"date\": \"14feb2020\",\n      \"author\": \"david.rueda@hsbcad.com\",\n      \"changes\": \"Insertion method enhanced to use/skip ENTER input\"\n    },\n    {\n      \"version\": \"1.03\",\n      \"date\": \"20jan2020\\\"\",\n      \"author\": \"david.rueda@hsbcad.com\",\n      \"changes\": \"Thumbnail updated for 4K\"\n    },\n    {\n      \"version\": \"1.02\",\n      \"date\": \"12jan2019\\\"\",\n      \"author\": \"david.rueda@hsbcad.com\",\n      \"changes\": \"Selection changed to get one by one upon ENTER. Phase name not forced to upper case anymore. Bugfix when a phase name could be part of another"
      },
      "tokens_used": 9041,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Uses `_kModelSpace` explicitly in `Group().collectEntities(true, Entity(), _kModelSpace)` and `tslNew.dbCreate(..., _kModelSpace, ...)`. No `sd_` prefix, `_Viewport`, or `_kShopDrawing` tokens found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Entity",
            "Panel",
            "Beam",
            "Sheet",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7014,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getString",
              "promptOriginal": "|Type phase name|. (|It will be available on next insertion at dropdown|)",
              "condition": "sBuildingPhase == sNew",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Select panel|Select beam|Select sheet|Select elem",
              "condition": "Mode is 'Add to sequence'",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity",
              "promptOriginal": "Select objects to remove",
              "condition": "Mode is 'Remove sequence' (variants)",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (_bOnInsert)",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nStartNumber",
            "type": "PropInt",
            "displayName": "Start Number",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the Start Number. If -1 then the next available secuence number will be used"
          },
          {
            "index": 0,
            "variable": "sKeepNumbers",
            "type": "PropString",
            "displayName": "Keep existing",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "General",
            "description": "Defines the behavior if new numbers will match existing numbers."
          },
          {
            "index": 1,
            "variable": "sBuildingPhase",
            "type": "PropString",
            "displayName": "Building Phase",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "<Dynamic list of existing phases in drawing + New>",
            "category": "General",
            "description": "Defines the Building Phase"
          },
          {
            "index": 2,
            "variable": "sEntityType",
            "type": "PropString",
            "displayName": "EntityType",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "|Panel|",
              "|Beam|",
              "|Sheet|",
              "|Element| (|Wall|, |Floor|, |Roof|)"
            ],
            "category": "General",
            "description": "Defines the EntityType"
          },
          {
            "index": 3,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Mode",
            "defaultValue": "|Add to sequence|",
            "inputType": "dropdown",
            "options": [
              "|Add to sequence|",
              "|Remove sequence|",
              "|Remove sequence by| |EntityType|",
              "|Remove sequence by| |Building Phase|"
            ],
            "category": "General",
            "description": "Defines the Mode. Sequences can be added or removed"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7740,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically assigns and manages erection sequence numbers to timber elements (panels, beams, sheets) based on building phases to facilitate on-site assembly logistics.",
          "category": "Project Management / Logistics",
          "typicalUseCase": "Used when a project manager needs to generate a specific numbered list of elements indicating the exact order in which they should be erected on site, potentially split by different construction phases (e.g., Ground Floor, Roof)."
        },
        "parameters": [
          {
            "name": "nStartNumber",
            "technicalDefault": -1,
            "businessMeaning": "Sets the starting integer for the erection sequence. If set to -1, the system automatically finds the next available number based on existing elements. If set to a specific value, numbering begins strictly from that number.",
            "validRange": "-1 (Auto) or 1 to 99999",
            "unit": "count",
            "affectsOutput": "Determines the integer value written to the element's metadata (SequenceNumber) and the formatted text string (SequenceNumberText, e.g., '0001'). Affects how elements are sorted and identified on lists and labels."
          },
          {
            "name": "sKeepNumbers",
            "technicalDefault": "|No|",
            "businessMeaning": "Controls whether the tool overwrites existing sequence numbers for elements already in the phase. 'No' forces a re-numbering of the whole phase to ensure a perfect incremental sequence (1, 2, 3...), potentially changing numbers on existing elements. 'Yes' preserves existing numbers, fitting new elements into gaps or appending them at the end.",
            "validRange": "|No|, |Yes|",
            "unit": "enum",
            "affectsOutput": "If 'No', the tool acts as a global re-numbering device for the selected phase, ensuring strict continuity but altering existing data. If 'Yes', it inserts new elements into the sequence without disturbing numbers already assigned to other elements."
          },
          {
            "name": "sBuildingPhase",
            "technicalDefault": "",
            "businessMeaning": "The specific construction phase (e.g., 'Phase 1', 'Ground Floor', 'Roof') to which the selected elements belong. Elements are grouped and numbered independently within each phase.",
            "validRange": "Text string (User defined or selected from existing phases in drawing)",
            "unit": "text",
            "affectsOutput": "Elements are tagged with this phase name in their hidden metadata. Numbering calculations are isolated to elements sharing this exact phase name."
          },
          {
            "name": "sEntityType",
            "technicalDefault": "|Any|",
            "businessMeaning": "Filters the types of construction elements that can be selected or affected by the numbering operation. This allows for separating sequences for structural walls (Panels) versus floors versus individual beams.",
            "validRange": "|Any|, |Panel|, |Beam|, |Sheet|, |Element| (Wall, Floor, Roof)",
            "unit": "enum",
            "affectsOutput": "Restricts the selection of entities in the CAD environment during the command prompt. Only entities matching the selected type will accept the sequence numbers."
          },
          {
            "name": "sMode",
            "technicalDefault": "|Add to sequence|",
            "businessMeaning": "Determines the operation performed on the selected elements. 'Add to sequence' assigns new numbers. 'Remove sequence' deletes the numbering from specific selected elements. The other 'Remove' options automate the deletion of numbering based on Type or Phase criteria for bulk clearing.",
            "validRange": "|Add to sequence|, |Remove sequence|, |Remove sequence by EntityType|, |Remove sequence by Building Phase|",
            "unit": "enum",
            "affectsOutput": "In 'Add' mode, it writes metadata (MapX) to entities including the phase and sequence number. In 'Remove' modes, it deletes the metadata key ('Hsb_SequenceChild') from the target entities, effectively erasing their erection numbering information."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sBuildingPhase == '|New|'",
            "effect": "Triggers a command-line prompt asking the user to type a new phase name string.",
            "cascade": [
              "sBuildingPhase"
            ]
          },
          {
            "trigger": "sMode != '|Add to sequence|'",
            "effect": "Switches the script logic to removal mode. Parameters like 'Start Number' and 'Keep existing' are ignored as they are irrelevant for deletion.",
            "cascade": [
              "nStartNumber",
              "sKeepNumbers"
            ]
          },
          {
            "trigger": "sKeepNumbers == '|No|'",
            "effect": "The script sorts and re-indexes all existing elements in the target phase to ensure a continuous sequence, potentially changing numbers on elements not currently selected but present in that phase.",
            "cascade": [
              "nStartNumber"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "MapX Data (Metadata)",
            "description": "Writes key-value pairs to the entity's extended data (MapX). Specifically writes 'BuildingPhase' (String) and 'SequenceNumber' (Int). It also writes 'SequenceNumberText' (String) which is a zero-padded version of the number for correct alphanumeric sorting (e.g., '0001', '0002').",
            "appliedTo": "Panels, Beams, Sheets, or Elements (depending on sEntityType filter) selected by the user."
          },
          {
            "type": "TSL Instance (Anchor)",
            "description": "Attaches a script instance to the entity to maintain the link for re-calculation and to potentially visualize the number as text in 3D (if debug mode is active).",
            "appliedTo": "The selected entities."
          }
        ]
      },
      "tokens_used": 9027,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Scan ModelSpace for all entities containing existing sequence MapX data to generate a list of active Building Phases.",
          "2. Properties Palette (OPM) Launch: User configures the operation via properties (Mode, Building Phase, Start Number, Keep existing, Entity Type).",
          "3. [Conditional] Mode Check: Script branches based on whether the user selected 'Add to sequence' or a 'Remove sequence' variant.",
          "4. (If Remove Mode) User selects objects in the drawing.",
          "5. (If Remove Mode) Script filters selected objects based on the specific removal criteria (Manual selection, By EntityType, or By Building Phase) and deletes the sequence MapX data.",
          "6. (If Add Mode) Phase Check: If Building Phase is set to '|New|', a command-line prompt asks the user to input a new unique phase name.",
          "7. (If Add Mode) Entity Selection: User selects target entities (Panels, Beams, Sheets, Elements, or Any).",
          "8. (If Add Mode) Data Aggregation: Script gathers all existing entities belonging to the target phase and sorts them by their current sequence numbers.",
          "9. (If Add Mode) Number Calculation: Script integrates the newly selected entities into the sorted list. It calculates the new numbers based on 'Start Number' and 'Keep existing' logic (Re-numbering vs. Gap filling).",
          "10. (If Add Mode) Instance Creation: Script creates a temporary TSL instance on every affected entity (old and new) to trigger data writing.",
          "11. Data Writing: Each TSL instance writes 'BuildingPhase', 'SequenceNumber', and 'SequenceNumberText' (e.g., 0001) to the entity's MapX.",
          "12. [Conditional] Debug Check: If Debug mode is OFF, TSL instances erase themselves, leaving only the data. If ON, instances persist and display text labels in 3D."
        ],
        "conditionalBranches": [
          {
            "condition": "sMode (Operation Mode)",
            "path1": {
              "name": "Add to sequence",
              "steps": [
                "Check if Phase is New (Prompt user if yes)",
                "Prompt user to select entities (Filtered by EntityType)",
                "Calculate and assign new sequence numbers",
                "Write MapX data to entities"
              ]
            },
            "path2": {
              "name": "Remove sequence",
              "steps": [
                "Prompt user to select objects",
                "Apply Filters (By EntityType OR By Building Phase OR None)",
                "Delete 'Hsb_SequenceChild' MapX entry from entities",
                "Erase script instance"
              ]
            }
          },
          {
            "condition": "sKeepNumbers (Numbering Logic)",
            "path1": {
              "name": "No (Re-sequence)",
              "steps": [
                "Existing sequence numbers in the phase are ignored for positioning",
                "Script re-indexes the entire phase starting from 'nStartNumber'",
                "Ensures a continuous, gap-free sequence (1, 2, 3...)"
              ]
            },
            "path2": {
              "name": "Yes (Keep existing)",
              "steps": [
                "Script preserves existing sequence numbers on unselected entities",
                "New numbers are inserted into the first available gap",
                "If no gaps, numbers are appended to the end of the existing sequence"
              ]
            }
          },
          {
            "condition": "bDebug (Debug Mode)",
            "path1": {
              "name": "True (Debug)",
              "steps": [
                "TSL instance remains attached to the entity",
                "Dependency on entity is set",
                "Text label (Phase-Number) is drawn at the entity's centroid in 3D"
              ]
            },
            "path2": {
              "name": "False (Production)",
              "steps": [
                "TSL instance is erased immediately after writing MapX",
                "No visual elements are left in the model",
                "Only the hidden metadata remains on the entity"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Building Phase Name Uniqueness",
            "errorMessage": "None (Implicit correction)",
            "recovery": "If the user types a 'New' phase name that already exists (case-insensitive match), the script automatically assigns the entity to the existing phase instead of creating a duplicate."
          },
          {
            "check": "Entity Selection",
            "errorMessage": "None (Silent Exit)",
            "recovery": "If the user presses ENTER without selecting any objects during the selection prompts, the script erases its instance and terminates without modifying data."
          },
          {
            "check": "Insertion Cycle",
            "errorMessage": "None",
            "recovery": "If 'insertCycleCount() > 1', the script immediately erases itself. This prevents recursion errors when the script programmatically inserts itself onto entities."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update specific element properties",
            "how": "OPM (Properties Palette) selection",
            "effect": "Changing properties on a specific element (if the TSL instance exists) triggers a recalculation for that specific element, updating its individual MapX data."
          },
          {
            "action": "Visual Verification",
            "how": "hsbDebugController (Set 'bDebug' to true)",
            "effect": "The script will draw text at the element center showing the Phase and Number (e.g., 'Phase1-0012'), allowing visual verification of the numbering in 3D."
          }
        ]
      },
      "tokens_used": 11562,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ErectionSequence.mcr\n\n## Overview\nAutomatically assigns and manages erection sequence numbers to timber elements (panels, beams, sheets) based on building phases. This tool facilitates on-site assembly logistics by creating a numbered list or text labels (e.g., 0001, 0002) to indicate the order of installation.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for selecting and numbering entities. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: At least one structural element (Panel, Beam, Sheet, or Element/Wall-Floor-Roof) must exist in the model.\n- **Minimum Beam Count**: 1\n- **Required Settings Files**: None\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse and select `ErectionSequence.mcr`.\n3.  Press **Enter** to insert the script instance into the drawing.\n\n### Step 2: Configure Operation Properties\n1.  Select the inserted script instance in the model.\n2.  Open the **Properties Palette** (Ctrl+1).\n3.  Configure the parameters as follows:\n    *   **Mode**: Choose `|Add to sequence|` to assign numbers or `|Remove sequence...|` to delete them.\n    *   **Building Phase**: Select an existing phase (e.g., \"Ground Floor\") or choose `|New|` to create one.\n    *   **EntityType**: Set to `|Any|` or specific types (Panel, Beam, etc.) to filter your selection.\n    *   **Start Number**: Set to `-1` for automatic numbering or enter a specific integer (e.g., 100) to start from that number.\n    *   **Keep existing**: Set to `|No|` to renumber the whole phase continuously, or `|Yes|` to preserve existing numbers and fill gaps only.\n\n### Step 3: Execute the Command\n1.  **If you selected `|New|` for Building Phase:**\n    *   Look at the command line.\n    *   Type the name for the new phase (e.g., \"Phase 1\") and press **Enter**.\n2.  **Selection Phase:**\n    *   If Mode is **Add**: The prompt will ask to \"Select panel/beam/sheet/elem\". Click the objects you want to number and press **Enter**.\n    *   If Mode is **Remove**: The prompt will ask to \"Select objects to remove\". Click the objects and press **Enter**.\n3.  The script will process the selection, assign or remove the metadata, and then erase the script instance from the drawing (leaving only the data attached to the elements).\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Mode** | dropdown | \\|Add to sequence\\| | Determines the operation. Choose to add numbers or remove them by selection, type, or phase. |\n| **Building Phase** | dropdown | <Empty> | Defines the construction phase. Choosing `|New|` triggers a prompt to create a new phase name. |\n| **EntityType** | dropdown | \\|Any\\| | Filters which types of elements can be selected (Panels, Beams, Sheets, or Elements). |\n| **Start Number** | number | -1 | Sets the starting number. `-1` finds the next available number automatically. Any positive integer starts numbering from that value. |\n| **Keep existing** | dropdown | \\|No\\| | If `|No|`, the script re-sequences all elements in the phase for a continuous list (1, 2, 3...). If `|Yes|`, it keeps current numbers and only assigns numbers to new items. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script does not add custom context menu items. Interaction is handled via the Properties Palette during insertion. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Sorting Lists**: The script creates a property called `SequenceNumberText` (e.g., \"0001\", \"0011\"). Use this property instead of the standard number when exporting to lists or Excel to ensure correct alphanumeric sorting.\n- **Visual Verification**: To see the erection numbers drawn in the 3D model as text labels, you must enable Debug mode (usually via `hsbDebugController` or setting `bDebug` to true) before running the script. Otherwise, the numbers are stored as hidden data only.\n- **Renumbering Phases**: If you add elements to an existing phase and want them to be the last numbers, set **Keep existing** to `|Yes|`. If you want to shuffle the order so new elements are mixed in or simply want a clean 1-100 sequence, set **Keep existing** to `|No|`.\n\n## FAQ\n- **Q: I ran the script but nothing happened.**\n- **A:** Check the command line. Did you select objects? If you pressed Enter without selecting objects, the script exits silently. Also, ensure **EntityType** allows the type of object you are trying to click.\n- **Q: How do I change the number of an existing element?**\n- **A:** You cannot manually edit the number directly on the element. You must run the script again, select the phase, set **Keep existing** to `|No|`, and select the elements again. The script will re-calculate the sequence based on the order of selection or existing data.\n- **Q: What does \"Start Number = -1\" do?**\n- **A:** It tells the script to look at all existing elements in that phase, find the highest number currently used, and start numbering the newly selected elements from the next number (e.g., if highest is 10, new ones start at 11)."
      },
      "tokens_used": 7412,
      "error": null
    }
  }
}