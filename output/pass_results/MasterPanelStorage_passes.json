{
  "filename": "MasterPanelStorage.mcr",
  "status": "completed",
  "total_tokens": 49760,
  "processing_time": 174.14196920394897,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "09.11.2022",
            "author": "Thorsten Huck",
            "changes": "HSB-17005 initial version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8026,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No sd_* or Multipage* prefix in filename. No usage of _Viewport.length(). No #Type E with _Entity[] property definition. The script uses getPoint() for insertion in 3D space, manipulates TslInst entities and Body objects, and creates 3D visualizations using Display dpFreight.draw(bd). It calculates geometry relative to World Axes (_XW, _YW, _ZW) and stores data in SubMaps typical of model-side organization scripts."
        },
        "prerequisites": {
          "requiredEntities": [],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 5756,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "OnInsert",
            "title": "Properties",
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sStorageID",
            "type": "PropString",
            "displayName": "Storage ID",
            "defaultValue": "001",
            "inputType": "text",
            "options": [],
            "category": "General",
            "description": "Defines the StorageID"
          },
          {
            "index": 1,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "@(Number)",
            "inputType": "text",
            "options": [],
            "category": "General",
            "description": "Defines the format to display properties"
          },
          {
            "index": 2,
            "variable": "nSolidColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 7,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the Color of the solid"
          },
          {
            "index": 3,
            "variable": "dBattenHeight",
            "type": "PropDouble",
            "displayName": "Batten Height",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Stacking",
            "description": "Defines a uniform batten height between each stack"
          },
          {
            "index": 4,
            "variable": "sStackMode",
            "type": "PropString",
            "displayName": "Stack Mode",
            "defaultValue": "<|Disabled|>",
            "inputType": "dropdown",
            "options": [
              "<|Disabled|>",
              "|Only Once|",
              "|Always|"
            ],
            "category": "Stacking",
            "description": "Defines the StackMode"
          },
          {
            "index": 5,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Text Color",
            "defaultValue": 7,
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "Defines the Color"
          },
          {
            "index": 6,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "Text Height",
            "defaultValue": 300,
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "Defines the text height of the dimension, |0 = byDimstyle|"
          },
          {
            "index": 7,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "DimStyle",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "_DimStyles.sorted()",
            "category": "Display",
            "description": "Defines the DimStyle"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Add Item|",
            "handler": "Add Item",
            "action": "Prompts user to select entities ('Select entities'), appends them to the stack and transforms them relative to the origin.",
            "alsoTriggeredBy": "Double-click"
          },
          {
            "menuItem": "|Remove Item|",
            "handler": "Remove Item",
            "action": "Prompts user to select entities ('Select entities') and a location point ('Select new location'), removes entities from the stack and transforms them to the new location.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Stack Items|",
            "handler": "Stack Items",
            "action": "Sets the Stack Mode to 'Only Once' to trigger vertical stacking logic. Only visible when Stack Mode is 'Disabled'.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9900,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "This script creates a logical storage or freight container for grouping and visualizing stacked master panel clones in 3D model space. It automates the vertical arrangement of panels for transport planning and calculates package dimensions and weights.",
          "category": "Logistics/Packaging",
          "typicalUseCase": "Used during production planning to stack timber panels into a single transport unit, visualize the stack, and export package data (dimensions, weight, item count) to shop drawings or BOMs."
        },
        "parameters": [
          {
            "name": "sStorageID",
            "technicalDefault": "\"001\"",
            "businessMeaning": "A unique identifier label for the specific storage stack or package, used for tracking and labeling.",
            "validRange": "Any alphanumeric string",
            "unit": "string",
            "affectsOutput": "Updates the text label displayed in the model and the ID metadata exported to shop drawings."
          },
          {
            "name": "sFormat",
            "technicalDefault": "\"@(Number)\"",
            "businessMeaning": "A formatting string that defines how the package properties (like ID, dimensions, or count) are displayed as text in the model.",
            "validRange": "Standard TSL format strings (e.g., \"@(Number)\", \"Storage: @(StorageID)\")",
            "unit": "string",
            "affectsOutput": "Alters the text content displayed near the stack origin."
          },
          {
            "name": "nSolidColor",
            "technicalDefault": "7",
            "businessMeaning": "The display color of the 3D representation of the stacked items (freight display).",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Changes the visual color of the panel bodies in the 3D view."
          },
          {
            "name": "dBattenHeight",
            "technicalDefault": "0",
            "businessMeaning": "The thickness of spacer battens placed between horizontal layers of stacked panels.",
            "validRange": "0 - 100 mm",
            "unit": "mm",
            "affectsOutput": "Increases the total vertical height (Z-dimension) of the stack by adding gaps between overlapping panels during the 'Stack Items' operation."
          },
          {
            "name": "sStackMode",
            "technicalDefault": "\"<|Disabled|>\"",
            "businessMeaning": "Controls the automatic vertical stacking behavior. 'Disabled' allows manual placement; 'Only Once' stacks items immediately then resets; 'Always' maintains stacking on every update.",
            "validRange": "Disabled, Only Once, Always",
            "unit": "enum",
            "affectsOutput": "Determines if and when the script automatically moves panels vertically to sit on top of one another without overlap."
          },
          {
            "name": "nColor",
            "technicalDefault": "7",
            "businessMeaning": "The color of the annotation text (Storage ID and dimensions).",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Changes the color of the text label in the drawing."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "300",
            "businessMeaning": "The height of the text annotation for the package label.",
            "validRange": "100 - 1000 mm",
            "unit": "mm",
            "affectsOutput": "Scales the text size; set to 0 to use the CAD DimStyle default height."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "The specific CAD dimension style used to determine text font and height properties (if dTextHeight is 0).",
            "validRange": "Available DimStyles in the drawing",
            "unit": "string",
            "affectsOutput": "Modifies the font and size of the text label if dTextHeight is 0."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTextHeight is set to 0",
            "effect": "Text height is dictated by the sDimStyle setting instead of the explicit dTextHeight value.",
            "cascade": [
              "sDimStyle"
            ]
          },
          {
            "trigger": "User executes '|Stack Items|'",
            "effect": "Temporarily sets sStackMode to '|Only Once|' to trigger the vertical arrangement logic.",
            "cascade": [
              "sStackMode",
              "dBattenHeight"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInstance",
            "description": "The logical storage container instance that holds the list of stacked panels.",
            "appliedTo": "Model Space (at insertion point)"
          },
          {
            "type": "Visualization Body",
            "description": "3D visual representation of the stacked panels, displayed in the 'Freight' display representation.",
            "appliedTo": "Selected MasterPanel Clones"
          },
          {
            "type": "Map/PackageData",
            "description": "Extensible data including Weight, Volume, QuantityItems, and Size (X/Y/Z), attached to the instance for use by shop drawing scripts.",
            "appliedTo": "TslInstance (SubMap 'Hsb_PackageParent')"
          },
          {
            "type": "Text/Annotation",
            "description": "Formatted text label displaying the Storage ID and package info.",
            "appliedTo": "Model Space (near stack origin)"
          }
        ]
      },
      "tokens_used": 9000,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Insertion Triggered",
          "Check Insertion Cycle (ignore if >1)",
          "Property Initialization (StorageID, BattenHeight, etc.)",
          "[Conditional] Load Catalog Settings or Show Properties Dialog",
          "Prompt User for Insertion Point (_Pt0) via getPoint()",
          "Set Entity Dependencies and Collect Storage Items",
          "[Conditional] Check if Origin (_Pt0) Dragged (Move Items)",
          "[Conditional] Check Stack Mode and Execute Vertical Stacking Logic",
          "Calculate Volume and Package Dimensions",
          "Draw Visualization (Text, Bodies, Outline)",
          "Update SubMap Data (Hsb_PackageParent)"
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert is TRUE",
            "path1": {
              "name": "Insertion Flow",
              "steps": [
                "Check insertCycleCount",
                "Load Catalog/Show Dialog",
                "Prompt getPoint",
                "Exit Script (return)"
              ]
            },
            "path2": {
              "name": "Recalculation/Update Flow",
              "steps": [
                "Collect Entities from _Entity list",
                "Filter valid items (volume > eps, correct parent)",
                "Handle origin drag event",
                "Handle Stack Mode logic",
                "Draw and update data"
              ]
            }
          },
          {
            "condition": "_kExecuteKey matches Context Menu Triggers",
            "path1": {
              "name": "Add Item",
              "steps": [
                "Prompt Select Entities",
                "Calculate Z-max of current stack",
                "Move new entities to top of stack aligned to origin",
                "Append to _Entity list",
                "Force 2 execution loops"
              ]
            },
            "path2": {
              "name": "Remove Item",
              "steps": [
                "Prompt Select Entities",
                "Prompt Select New Location",
                "Remove SubMap 'MasterStorage'",
                "Move entities to new location",
                "Remove from _Entity list",
                "Force 2 execution loops"
              ]
            },
            "path3": {
              "name": "Stack Items",
              "steps": [
                "Set sStackMode to 'Only Once'",
                "Force 2 execution loops",
                "Trigger Recalculation to run stacking logic"
              ]
            }
          },
          {
            "condition": "sStackMode Evaluation",
            "path1": {
              "name": "Stacking Disabled",
              "steps": [
                "Entities remain in manually placed positions",
                "Display update only"
              ]
            },
            "path2": {
              "name": "Stacking Enabled (Only Once or Always)",
              "steps": [
                "Sort entities by Z-height relative to origin",
                "Loop through entities to check overlaps (intersect)",
                "Move entities up by (Overlap Height + Batten Height)",
                "If Mode was 'Only Once', reset to 'Disabled' after run"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "EraseInstance() returns immediately if cycle > 1"
          },
          {
            "check": "Entity Validity during Collection",
            "errorMessage": "None (Silent Skip)",
            "recovery": "Skips entities with Volume < pow(dEps,3) or invalid geometry"
          },
          {
            "check": "Parent Map Assignment",
            "errorMessage": "None",
            "recovery": "If entity parent != _ThisInst, it is removed from the _Entity array"
          },
          {
            "check": "Add Item Duplicate Check",
            "errorMessage": "None",
            "recovery": "If selected entity is already in _Entity list, it is skipped"
          },
          {
            "check": "Batten Height Value",
            "errorMessage": "None",
            "recovery": "Clamped to 0 if negative value entered"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Storage Stack",
            "how": "Grip Edit (Point _Pt0)",
            "effect": "Transforms all collected items by the delta vector of the move"
          },
          {
            "action": "Add Panels to Stack",
            "how": "Context Menu '|Add Item|' or Double-Click",
            "effect": "Prompts selection, aligns entities horizontally to X-axis of origin, stacks vertically at current top height"
          },
          {
            "action": "Remove Panels from Stack",
            "how": "Context Menu '|Remove Item|'",
            "effect": "Prompts selection and location, removes internal tracking, moves entities to new location"
          },
          {
            "action": "Automatic Vertical Stacking",
            "how": "Context Menu '|Stack Items|' or Property 'Stack Mode' = 'Always'",
            "effect": "Sorts items by Z, detects intersections, moves items up to clear overlaps plus Batten Height"
          },
          {
            "action": "Update Configuration",
            "how": "Properties Palette (OPM)",
            "effect": "Updates Storage ID label, Text Height/Color, Solid Color, Batten Height, and formatting string"
          }
        ]
      },
      "tokens_used": 10009,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# MasterPanelStorage\n\n## Overview\nThis script creates a logical storage or freight container in the 3D model to group, stack, and visualize master panels for transport planning. It automates the vertical arrangement of panels, calculates package dimensions/weights, and displays labeling information.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script inserts at a 3D point and manipulates entities in the model. |\n| Paper Space | No | Not designed for 2D layout or detailing. |\n| Shop Drawing | No | This script organizes data in the model; other scripts use this data for drawings. |\n\n## Prerequisites\n- **Required entities**: None to insert the script, but you typically need existing Master Panel entities to add to the storage.\n- **Minimum beam count**: 0\n- **Required settings files**: None\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `MasterPanelStorage.mcr` from the list.\n\n### Step 2: Configure Initial Properties (Optional)\nA \"Properties\" dialog may appear automatically upon insertion. You can accept the defaults or set the **Storage ID** and **Batten Height** now. You can also change these later via the Properties Palette.\n\n### Step 3: Place Storage Unit\n```\nCommand Line: Specify insertion point:\nAction: Click in the Model Space to define the bottom-center origin (0,0,0) of your storage stack.\n```\n\n### Step 4: Add Panels\n```\nAction: Double-click the Storage Unit or Right-click and select \"Add Item\".\nCommand Line: Select entities:\nAction: Select the master panels you want to include in this stack.\nResult: The selected panels will move to align with the storage unit's origin and stack vertically.\n```\n\n### Step 5: Stack Panels (Optional)\n```\nAction: Right-click the Storage Unit and select \"Stack Items\".\nResult: The script will automatically sort panels by height and move them up to resolve overlaps, adding the specified Batten Height between layers.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| sStorageID | text | 001 | A unique identifier label for the storage stack (e.g., \"PAL-001\"). |\n| sFormat | text | @(Number) | Defines how properties are displayed in the text label (e.g., \"Storage: @(StorageID)\"). |\n| nSolidColor | number | 7 | The color of the 3D visualization bodies (AutoCAD Color Index 0-255). |\n| dBattenHeight | number | 0 | The thickness of spacer battens placed between layers of stacked panels (in mm). |\n| sStackMode | dropdown | Disabled | Controls stacking behavior: **Disabled** (manual placement), **Only Once** (stacks immediately then stops), **Always** (maintains stacking on every update). |\n| nColor | number | 7 | The color of the annotation text (AutoCAD Color Index 0-255). |\n| dTextHeight | number | 300 | The height of the text label (in mm). Set to 0 to use the DimStyle default. |\n| sDimStyle | dropdown | <current> | The dimension style used to determine font and text height properties. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add Item | Prompts you to select entities. It moves them to the storage origin and stacks them on top of the current content. (Can also be triggered by Double-Click). |\n| Remove Item | Prompts you to select entities and a new location point. It removes the entities from the storage stack and moves them to the chosen location. |\n| Stack Items | Forces the script to perform a vertical stacking calculation immediately (setting mode to \"Only Once\" for this operation). |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not rely on external settings files; all configuration is handled via the Properties Palette.\n\n## Tips\n- **Quick Access**: Simply double-click the storage origin point to open the \"Add Item\" selection prompt.\n- **Dynamic Stacking**: If you are editing the package frequently, set **Stack Mode** to \"Always\". This ensures panels automatically rearrange vertically if you move them horizontally.\n- **Visualization**: Use the **nSolidColor** property to make the freight stack stand out from other model elements (e.g., set to a specific color for shipping visualization).\n\n## FAQ\n- **Q: Why did my panels disappear?**\n  - A: Check if they were moved to a high Z-coordinate. If the **Stack Mode** is active, the script may have stacked them very high based on overlapping geometry. Try \"Remove Item\" to extract them, or reset the Stack Mode to \"Disabled\".\n  \n- **Q: How do I account for packaging wood between panels?**\n  - A: Set the **Batten Height** property to the thickness of your packing strips (e.g., 50mm) before running the \"Stack Items\" command.\n\n- **Q: Can I change the ID label later?**\n  - A: Yes. Select the storage script, open the Properties Palette (Ctrl+1), and edit the **Storage ID** field. The text label in the model will update automatically."
      },
      "tokens_used": 7069,
      "error": null
    }
  }
}