{
  "filename": "hsbRoofDataEdge.mcr",
  "status": "completed",
  "total_tokens": 52912,
  "processing_time": 678.3641138076782,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.9",
            "date": "28.10.2025",
            "author": "Marsel Nakuci",
            "changes": "HSB-24831: Show angles for Baufritz (Markus Sailer)"
          },
          {
            "version": "1.8",
            "date": "12.04.2021",
            "author": "Marsel Nakuci",
            "changes": "HSB-11511: write level of the group in hardware group"
          },
          {
            "version": "1.7",
            "date": "15dec2020",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-10119: roof valley should include the cutting of the two areas of roof planes"
          },
          {
            "version": "1.6",
            "date": "22nov18",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "count type set to length"
          },
          {
            "version": "1.5",
            "date": "25may18",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "bugfix group assignment"
          },
          {
            "version": "1.4",
            "date": "05apr17",
            "author": "florian.wuermseer@hsbcad.com",
            "changes": "individual edge lines are assigned to the same group as the complete TSL, now (in place edit)"
          },
          {
            "version": "1.3",
            "date": "25jan17",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "supports and displays base angle and hip/valey angle"
          },
          {
            "version": "1.2",
            "date": "15dec16",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "child/parent relation to roofData-Schedule added"
          },
          {
            "version": "1.1",
            "date": "05dec16",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "unit bugfix"
          },
          {
            "version": "1.0",
            "date": "22july16",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9435,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script collects entities using `Group().collectEntities(true, ERoofPlane(), _kModelSpace);`. It prompts for `ERoofPlane` selection via `PrEntity` and performs 3D geometric analysis (Body creation, PlaneProfile intersections). No usage of `_Viewport`, `_kPaperSpace`, `Sheet`, or `sd_` prefixes."
        },
        "prerequisites": {
          "requiredEntities": [
            "ERoofPlane"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing valid Roofplanes",
          "requiredSettings": []
        }
      },
      "tokens_used": 7957,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select roofplane(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertiesDialog",
            "trigger": "Insertion (if no ExecuteKey provided)",
            "title": "Properties",
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|Dimstyle|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "Dynamic list from _DimStyles"
            ],
            "category": "|Display|",
            "description": null
          },
          {
            "index": 1,
            "variable": "dTxtH",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "U(30)",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Sets the text height|"
          },
          {
            "index": 2,
            "variable": "sUnit",
            "type": "PropString",
            "displayName": "|Unit|",
            "defaultValue": 2,
            "inputType": "dropdown",
            "options": [
              "mm",
              "cm",
              "m",
              "inch"
            ],
            "category": "|Display|",
            "description": "|Defines the unit|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 10745,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates, labels, and lists roof edge dimensions and types (eave, ridge, hip, valley, etc.) for selected roof planes. It outputs data to hardware lists for scheduling and provides graphical dimensions in the model.",
          "category": "ShopDrawing/Reporting",
          "typicalUseCase": "Generating a schedule of roof board lengths and identifying specific edge conditions for manufacturing or estimation directly from the 3D model."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "\"|_Default|\"",
            "businessMeaning": "Selects the visual style (font, arrows, color) for the dimension lines and text displayed in the model.",
            "validRange": "Any available AutoCAD dimension style in the drawing",
            "unit": "String (Selection)",
            "affectsOutput": "Visual appearance of the dimension text and markers drawn on the roof edges. Does not affect geometric lengths."
          },
          {
            "name": "dTxtH",
            "technicalDefault": "U(30)",
            "businessMeaning": "Sets the physical height of the text labels displaying the roof edge lengths and types.",
            "validRange": "10mm to 100mm depending on drawing scale and visibility requirements",
            "unit": "mm (Length)",
            "affectsOutput": "Size of the text labels. Larger text may cause overlap issues which the script tries to resolve automatically by moving labels."
          },
          {
            "name": "sUnit",
            "technicalDefault": "2",
            "businessMeaning": "Defines the measurement unit used for displaying the length values in the text labels.",
            "validRange": "0=mm, 1=cm, 2=m, 3=inch",
            "unit": "Enum",
            "affectsOutput": "The numerical value and unit suffix displayed in the label (e.g., '1200mm' vs '1.2m')."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTxtH is modified",
            "effect": "The script recalculates the text box size and interference checks to ensure labels do not overlap.",
            "cascade": []
          },
          {
            "trigger": "sUnit is modified",
            "effect": "The internal unit factor changes, converting the raw geometric length to the selected format for display.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Text/Dimensions",
            "description": "Visual labels in Model Space showing the edge type (e.g., 'Eave') and length with pitch angles (e.g., 'Eave(5000mm 30Â°)').",
            "appliedTo": "Roof Plane edges (graphical overlay)."
          },
          {
            "type": "Hardware (Logical)",
            "description": "Logical entries written to the hardware list categorized under 'RoofEdge', containing length, type, and material information.",
            "appliedTo": "The TSL instance for export to reports/CSV/CAM."
          }
        ]
      },
      "tokens_used": 8231,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Start",
          "Check Insertion Cycle (if >1, erase and exit)",
          "Determine Input Source (Catalog via ExecuteKey vs Dialog)",
          "[Conditional] Load Properties from Catalog if ExecuteKey provided, else Show Dialog",
          "Prompt User to Select Roofplane(s)",
          "[Conditional] If selection successful, store entities and return",
          "[Recalculation/Execution] Start execution",
          "Retrieve Execution Mode (0=All Edges, 1=Individual Edge) from internal Map",
          "Validate selected entities (cast to ERoofPlane)",
          "[Conditional] If no valid roofplanes, erase instance and exit",
          "Sort roofplanes by envelope area (descending)",
          "[Conditional] Check Mode (0 vs 1)",
          "[Mode 0: All Edges] Collect all roofplanes in ModelSpace",
          "[Mode 0] Detect openings: compare selected planes against all planes for coplanarity and intersection",
          "[Mode 0] Append detected opening planes to selection list",
          "[Mode 0] Loop through each roofplane in selection",
          "Extract Geometry (Pline, Coordinate System, Segments)",
          "[Mode 0] Determine Edge Types: Eave, Verge, Hip, Valley, Ridge, etc.",
          "Calculate Lengths, Pitch Angles, and Bend Angles",
          "[Mode 0] Generate Text Label string based on unit settings",
          "Create Text Label Placement Box at midpoint of edge",
          "[Conditional] Check for Text Interference with existing labels",
          "Resolve Interference: Move label along polar offsets (up to 100 iterations) to find clear space",
          "Update Protected Area to include new label position",
          "Draw Text Label and Dimensions in Model Space",
          "[Mode 0 & Baufritz Only] Calculate and Draw Angular Dimensions for Valley/First edges",
          "Create Hardware Entries (Logical) for each edge segment",
          "[Mode 0] Handle Parent/Child relationship (if exists)",
          "[Conditional] If Edit Mode is ON and Mode is 0, Erase Instance and Update Parent Map",
          "Apply Hardware List to Instance",
          "Script End"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count > 1",
            "path1": {
              "name": "Duplicate Insert Detected",
              "steps": [
                "Erase current instance",
                "Return immediately"
              ]
            },
            "path2": {
              "name": "First Insert",
              "steps": [
                "Proceed to Input Source check"
              ]
            }
          },
          {
            "condition": "ExecuteKey provided (via Catalog/Toolbar)",
            "path1": {
              "name": "Catalog Load",
              "steps": [
                "Check if ExecuteKey exists in Script Catalog",
                "If yes, set properties from that Catalog Entry",
                "If no, set properties from '_LastInserted' Entry"
              ]
            },
            "path2": {
              "name": "Manual Insert",
              "steps": [
                "Show Properties Dialog to user",
                "Wait for user confirmation"
              ]
            }
          },
          {
            "condition": "Execution Mode (stored in _Map 'mode')",
            "path1": {
              "name": "Mode 0: All Edges",
              "steps": [
                "Process geometric relationships between planes",
                "Auto-detect openings",
                "Label and List all edges",
                "Support in-place edit (erase self and pass data to parent)"
              ]
            },
            "path2": {
              "name": "Mode 1: Individual Edge",
              "steps": [
                "Target specific segment editing",
                "Preserve instance geometry for individual manipulation"
              ]
            }
          },
          {
            "condition": "Project Special Variable = 'BAUFRITZ'",
            "path1": {
              "name": "Baufritz Project",
              "steps": [
                "Identify 'Kehle' (Valley) and 'First' edges",
                "Store geometric points for angular calculation",
                "Draw specific Angular Dimensions for manufacturing"
              ]
            },
            "path2": {
              "name": "Standard Project",
              "steps": [
                "Skip Angular Dimension logic for Baufritz"
              ]
            }
          },
          {
            "condition": "Text Interference Detection (Overlap)",
            "path1": {
              "name": "Interference Detected",
              "steps": [
                "Calculate polar offsets",
                "Iteratively move label position",
                "Increase offset distance if initial tries fail",
                "Find non-intersecting position",
                "Update protected area profile"
              ]
            },
            "path2": {
              "name": "No Interference",
              "steps": [
                "Place label at midpoint",
                "Join label box to protected area profile"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid Roofplane Entities selected",
            "errorMessage": "(Implicit) If invalid, instance is erased silently.",
            "recovery": "User must re-run script and select valid ERoofPlane entities."
          },
          {
            "check": "Catalog Entry Match",
            "errorMessage": "If ExecuteKey is not found in catalog list.",
            "recovery": "Script defaults to '_LastInserted' catalog entry settings."
          },
          {
            "check": "Label Overlap Resolution",
            "errorMessage": "None logged, but loop limited to 100 iterations.",
            "recovery": "If loop fails, label likely stays at last calculated offset (potentially overlapping)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Display Settings",
            "how": "OPM (Object Properties Palette)",
            "effect": "Updates 'Dimstyle', 'Text Height', and 'Unit'. Script recalculates text size and redraws labels."
          },
          {
            "action": "Edit in Place (Double Click)",
            "how": "Double Click TSL Instance",
            "effect": "Sets Mode 1 (Individual Edge). Allows modification of specific segments (Note: Logic for Mode 1 editing is partially truncated in provided code, but implies individual segment handling)."
          },
          {
            "action": "Update Geometry",
            "how": "Modify Source Roofplanes",
            "effect": "TSL reacts to changes in roof geometry (recalculates lengths, angles, and types based on new ERoofPlane shape)."
          },
          {
            "action": "Schedule/Data Export",
            "how": "Run Hardware Report/Export",
            "effect": "Outputs the list of calculated edges (Length, Type, Group) categorized under 'RoofEdge'."
          }
        ]
      },
      "tokens_used": 10403,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbRoofDataEdge.mcr\n\n## Overview\nThis script automatically calculates, labels, and lists roof edge dimensions and types (such as eave, ridge, hip, and valley) for selected roof planes. It generates visual text labels in the model and creates a hardware list for scheduling or manufacturing reports.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script requires 3D roof planes to analyze. |\n| Paper Space | No | |\n| Shop Drawing | No | Generates data in Model Space used for reports. |\n\n## Prerequisites\n- **Required entities**: `ERoofPlane` (hsbCAD Roof Planes).\n- **Minimum beam count**: 0.\n- **Required settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** Type `TSLINSERT` in the command line (or select from the hsbCAD toolbar) and choose `hsbRoofDataEdge.mcr`.\n\n### Step 2: Select Roofplanes\n```\nCommand Line: Select roofplane(s)\nAction: Click on one or multiple roof planes in the model, then press Enter.\n```\n*Note: Selecting multiple adjacent planes allows the script to identify internal connections (valleys/ridges) between them.*\n\n### Step 3: Configure Properties (Optional)\nAfter insertion, select the TSL instance and open the **Properties Palette** (Ctrl+1) to adjust text height, units, or dimension styles.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimstyle | Dropdown | _Default | Sets the visual style (font, arrows, color) for the dimension lines and text. |\n| Text Height | Number | U(30) | Sets the physical height of the text labels displaying the roof edge lengths. |\n| Unit | Dropdown | 2 (m) | Defines the measurement unit for the displayed length values (mm, cm, m, inch). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add specific custom items to the right-click menu. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Label Overlap**: The script automatically detects if labels overlap. It attempts to move them to a clear space. If labels are still crowded, try reducing the **Text Height** in the properties.\n- **Data Export**: The script writes logical data to a \"Hardware\" list. You can generate a report (e.g., CSV or Excel) to see a table of all calculated edge lengths and types.\n- **Project Specifics**: If the project variable is set to 'BAUFRITZ', the script will additionally calculate and draw angular dimensions for valleys.\n\n## FAQ\n- **Q: Where do I find the calculated lengths for my cut list?**\n  - A: The script adds entries to the Hardware list categorized under 'RoofEdge'. Run a hardware report to export this data to Excel.\n- **Q: Can I label just one edge of a roof?**\n  - A: The script is designed to process all edges of the selected roof planes. While it supports \"In-Place\" editing (double-click), the primary function is to label the entire perimeter and internal intersections.\n- **Q: Why did the script disappear after I inserted it?**\n  - A: This happens if the script detects a duplicate insertion or if no valid roof planes were found. Ensure you select valid `ERoofPlane` entities when prompted."
      },
      "tokens_used": 6141,
      "error": null
    }
  }
}