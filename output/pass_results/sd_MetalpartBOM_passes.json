{
  "filename": "sd_MetalpartBOM.mcr",
  "status": "completed",
  "total_tokens": 49103,
  "processing_time": 306.69671082496643,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.0",
            "date": "08.09.2010",
            "author": "th@hsbCAD.de",
            "changes": null
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7891,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ShopDrawing",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "Filename prefix 'sd_', usage of getShopDrawView() on insert, iteration of _Entity[] for ShopDrawView(), usage of _kOnGenerateShopDrawing, and transformation using ms2ps (Model to Paper Space)."
        },
        "prerequisites": {
          "requiredEntities": [
            "ShopDrawView",
            "MetalPartCollectionEnt",
            "Beam"
          ],
          "minimumBeams": null,
          "requiredSpace": "Must be inserted/linked to a ShopDrawing view.",
          "requiredSettings": []
        }
      },
      "tokens_used": 7531,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getShopDrawView",
              "promptOriginal": "Select one or multiple sips to attach this tsl. alternativly select a shopdraw viewport to define it's display with shopdrawings",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (if not using a catalog)",
            "title": null,
            "dataSource": "Default properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 1,
            "variable": "sShowBOM",
            "type": "PropString",
            "displayName": "Show List",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": "Show List"
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": "_DimStyles",
            "category": null,
            "description": "The dimstyle controls the textstyle and size of all texts being displayed"
          },
          {
            "index": 0,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "The color of the instance."
          },
          {
            "index": 1,
            "variable": "nColorPosNum",
            "type": "PropInt",
            "displayName": "Color PosNum",
            "defaultValue": 20,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "Color PosNum"
          },
          {
            "index": 2,
            "variable": "nColorBackground",
            "type": "PropInt",
            "displayName": "Color Background",
            "defaultValue": 51,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "Color Background-2 = do not hide"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7629,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a Bill of Materials (BOM) schedule and position number labels for metal connection parts (plates/brackets) associated with a timber beam within a shop drawing view.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used in the layout of production drawings to automatically list and tag steel plates, gussets, or brackets attached to specific wall or floor beams, ensuring all metal hardware is documented."
        },
        "parameters": [
          {
            "name": "sShowBOM",
            "technicalDefault": "|No|",
            "businessMeaning": "Toggle switch to display or hide the detailed data table. When set to 'No', the script acts as a pure labeling tool (tags only). When 'Yes', it draws the full schedule list including dimensions and weight.",
            "validRange": "|No|, |Yes|",
            "unit": "Enum",
            "affectsOutput": "Controls the visibility of the spreadsheet-style table. Position number bubbles (tags) on the drawing are always drawn regardless of this setting."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "null",
            "businessMeaning": "Defines the text font and style settings used for the labels and table content. Note: The actual text height is automatically calculated based on the table width grip, but this property controls the font family and basic style characteristics.",
            "validRange": "Any valid Dimension Style in the current drawing",
            "unit": "String (Style Name)",
            "affectsOutput": "Changes the font face of the position numbers and table text."
          },
          {
            "name": "nColor",
            "technicalDefault": "1",
            "businessMeaning": "The CAD color index used for the BOM table lines and text content.",
            "validRange": "1-255 (AutoCAD Index Colors)",
            "unit": "Index",
            "affectsOutput": "Changes the plotted/screen color of the schedule table."
          },
          {
            "name": "nColorPosNum",
            "technicalDefault": "20",
            "businessMeaning": "The CAD color index used for the position number bubbles (tags) and their leader lines pointing to the metal parts.",
            "validRange": "1-255 (AutoCAD Index Colors)",
            "unit": "Index",
            "affectsOutput": "Changes the plotted/screen color of the metal part tags."
          },
          {
            "name": "nColorBackground",
            "technicalDefault": "51",
            "businessMeaning": "The background fill color for the position number bubbles. A specific value of -2 renders the bubble transparent (outline only), which prevents the tag from obscuring underlying geometry.",
            "validRange": "-2 or 1-255",
            "unit": "Index",
            "affectsOutput": "If > -2, tags are solid filled, potentially hiding lines behind them. If -2, tags are wireframe/transparent."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Moving the Width Grip (_PtG)",
            "effect": "Adjusts the total width of the BOM table and automatically scales the text height and row height proportionally to maintain readability.",
            "cascade": [
              "Table Width",
              "Text Height",
              "Row Height"
            ]
          },
          {
            "trigger": "sShowBOM = No",
            "effect": "The table geometry is skipped, but the positioning logic for the bubble tags (collision detection) remains active.",
            "cascade": [
              "Table Geometry",
              "Table Text"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PLine (2D)",
            "description": "Grid lines for the BOM table and the border for the position number bubbles.",
            "appliedTo": "Paper Space (Shop Drawing View)"
          },
          {
            "type": "Text (2D)",
            "description": "Position numbers (inside bubbles) and attribute data (inside table cells: Pos, Name, Qty, Profile, Material, Length, Width, Height, Weight).",
            "appliedTo": "Paper Space (Shop Drawing View)"
          },
          {
            "type": "PlaneProfile (Filled)",
            "description": "Solid background fill for the position number bubbles (if Color Background != -2).",
            "appliedTo": "Paper Space (Shop Drawing View)"
          }
        ]
      },
      "tokens_used": 9752,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script starts and checks if it is in Insertion Mode (_bOnInsert).",
          "If inserting, verify it's the first cycle (prevent duplicate instances).",
          "Prompt user to select a ShopDrawView entity to link to.",
          "Prompt user for an insertion point (_Pt0) for the table/label origin.",
          "Check if a Catalog Entry is being used. If not, display the default Properties Dialog.",
          "Script finishes insertion and recalculates.",
          "Execution enters the display/generation phase.",
          "Identify the linked ShopDrawView and retrieve its transformation matrix (Model Space to Paper Space).",
          "Search for a valid parent entity (Beam) within the view's define set.",
          "Scan the parent Beam for connected MetalPartCollection entities (tools) and populate the metal parts array.",
          "Check 'Show List' (sShowBOM) property to determine output mode (Table vs. Tags Only).",
          "If 'Show List' is Yes: Calculate table width based on Grip position, generate column headers, iterate through parts to write data rows (Pos, Name, Qty, etc.), and calculate totals.",
          "If 'Show List' is No: Skip table generation entirely.",
          "Draw Position Number Bubbles (Tags) for all valid metal parts found.",
          "For each tag: Transform part center to Paper Space, check for collision with existing tags, reposition if overlapping (shift right), draw leader line, and draw text.",
          "If no metal parts are found, draw a debug line from View Origin to Insertion Point and display Script Name."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Trigger Check (_bOnInsert)",
            "path1": {
              "name": "Insertion Flow",
              "steps": [
                "Check insertCycleCount",
                "Check for Catalog Key (_kExecuteKey)",
                "Call getShopDrawView()",
                "Call getPoint() for _Pt0",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "Calculation/Draw Flow",
              "steps": [
                "Retrieve View Data",
                "Collect Metal Parts",
                "Execute Drawing Logic based on sShowBOM"
              ]
            }
          },
          {
            "condition": "Catalog Usage",
            "path1": {
              "name": "Manual Insert",
              "steps": [
                "Execute showDialog() to show OPM defaults"
              ]
            },
            "path2": {
              "name": "Catalog Insert",
              "steps": [
                "Execute setPropValuesFromCatalog()"
              ]
            }
          },
          {
            "condition": "sShowBOM Property Value",
            "path1": {
              "name": "Full Schedule (Yes)",
              "steps": [
                "Initialize Table variables",
                "Process Table Width Grip",
                "Draw Header Row (Pos, Name, Qty...)",
                "Iterate Metal Parts & Draw Data Rows",
                "Draw Tags/Bubbles"
              ]
            },
            "path2": {
              "name": "Tags Only (No)",
              "steps": [
                "Skip Table logic",
                "Iterate Metal Parts",
                "Draw Tags/Bubbles with collision detection"
              ]
            }
          },
          {
            "condition": "Tag Collision Detection",
            "path1": {
              "name": "Clear Space",
              "steps": [
                "Draw tag at calculated position",
                "Draw text",
                "No leader line needed"
              ]
            },
            "path2": {
              "name": "Overlap Detected",
              "steps": [
                "Shift tag position to the right (up to 40 iterations)",
                "Draw leader line from original part center to new tag position",
                "Draw text"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid ShopDrawView attached",
            "errorMessage": "Implicit error handling: bError flag set to 1 if sdv is not valid. Script halts drawing logic.",
            "recovery": "Ensure the script is linked to a valid ShopDrawView entity."
          },
          {
            "check": "Valid ViewData found in Map",
            "errorMessage": "Implicit error handling: bError flag set to 2 if nIndFound < 0.",
            "recovery": "Regenerate shop drawing view data to ensure _Map contains current ViewData."
          },
          {
            "check": "Metal Parts Exist",
            "errorMessage": "Visual feedback: Draws a line from View Origin to _Pt0 and writes the Script Name. No table is drawn.",
            "recovery": "Ensure the selected element in the view has MetalPartCollection tools attached."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Toggle Table Visibility",
            "how": "OPM Property: 'Show List' (sShowBOM)",
            "effect": "Switches between showing just the bubbles or the full BOM table."
          },
          {
            "action": "Adjust Table Width",
            "how": "Grip Edit (_PtG[0])",
            "effect": "Dragging the grip changes the total width of the table; row height and text height scale automatically."
          },
          {
            "action": "Move Table/Tags",
            "how": "Grip Edit (_Pt0)",
            "effect": "Moves the entire set of tags and the table origin point."
          },
          {
            "action": "Change Visual Style",
            "how": "OPM Properties: 'Color', 'Color PosNum', 'Dimstyle'",
            "effect": "Updates colors of table/lines and font styles used for text."
          },
          {
            "action": "Toggle Tag Background",
            "how": "OPM Property: 'Color Background'",
            "effect": "If set to -2, tags are transparent outlines. If set to a color index, tags are solid filled."
          }
        ]
      },
      "tokens_used": 10043,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# sd_MetalpartBOM.mcr\n\n## Overview\nThis script automatically generates a Bill of Materials (BOM) table and position number labels for metal connection parts (plates, brackets, gussets) within a shop drawing view. It identifies metal parts attached to timber beams and creates a detailed schedule including dimensions, material, and weight, while tagging the parts in the drawing view.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script runs in the context of a layout. |\n| Paper Space | Yes | Output is generated directly in the layout view. |\n| Shop Drawing | Yes | Must be linked to a `ShopDrawView` entity. |\n\n## Prerequisites\n- **Required Entities**: A valid `ShopDrawView` entity and a `Beam` contained within that view.\n- **Required Content**: The beam must have metal parts assigned to it via `MetalPartCollection` tools.\n- **Minimum Beams**: 1 (The script scans the selected Shop Drawing View for a primary beam).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `sd_MetalpartBOM.mcr`\n\n### Step 2: Select Shop Drawing View\n```\nCommand Line: Select one or multiple sips to attach this tsl. alternatively select a shopdraw viewport to define it's display with shopdrawings\nAction: Click on the Shop Drawing View (or SIP) where the metal parts are located.\n```\n\n### Step 3: Set Insertion Point\n```\nCommand Line: [Point Prompt]\nAction: Click in the drawing to place the origin of the BOM table and label system.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Show List** (sShowBOM) | dropdown | \\|No\\| | Toggles the visibility of the BOM table. Set to `|Yes|` to show the full schedule; set to `|No|` to show only the position number tags. |\n| **Dimstyle** (sDimStyle) | dropdown | *Current* | Selects the Dimension Style that controls the text font and size for the table and tags. |\n| **Color** (nColor) | number | 1 | Sets the AutoCAD color index for the BOM table lines and text. |\n| **Color PosNum** (nColorPosNum) | number | 20 | Sets the AutoCAD color index for the position number bubbles and leader lines. |\n| **Color Background** (nColorBackground) | number | 51 | Sets the background fill color for the position bubbles. Enter `-2` to make the bubbles transparent (outline only). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | No specific custom menu items are added by this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: No external settings files are required for this script.\n\n## Tips\n- **Table Sizing**: Use the triangular **Width Grip** (drag point) appearing on the table to resize the table width. Text height and row height will scale automatically to fit the new width.\n- **Avoiding Overlaps**: The script automatically detects if position bubbles overlap. If they do, it shifts the bubble to the right and adds a leader line pointing to the metal part.\n- **Transparent Tags**: If your position bubbles are covering important geometry, set the **Color Background** property to `-2`. This makes the bubbles transparent so you can see lines through them.\n- **Display Only Tags**: If you only need to tag the parts in the view but do not need the data table (e.g., for a cleaner drawing view), set **Show List** to `|No|`.\n\n## FAQ\n- **Q: I inserted the script, but no table appears.**\n  - A: By default, the **Show List** property is set to `|No|`. Select the script instance in the drawing, open the Properties palette, and change **Show List** to `|Yes|`.\n  \n- **Q: Why is the script listing \"0\" items?**\n  - A: Ensure that the `ShopDrawView` you selected contains a beam that actually has metal parts assigned to it. The script specifically looks for `MetalPartCollection` entities attached to the beam.\n\n- **Q: The text in my table is too small.**\n  - A: Select the **Dimstyle** property in the palette and choose a dimension style with larger text settings, or adjust the width grip to force the text to scale up."
      },
      "tokens_used": 6257,
      "error": null
    }
  }
}