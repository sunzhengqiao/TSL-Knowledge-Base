{
  "filename": "HSB_E-ReferenceMarking.mcr",
  "status": "completed",
  "total_tokens": 41974,
  "processing_time": 296.12400555610657,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7390,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses PrEntity to select Elements and explicitly calls dbCreate with the _kModelSpace parameter during the _bOnInsert phase. It iterates through Element.beam() to add Mark objects to beams, which is a Model Space production data action."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Beam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "HSB_G-FilterGenBeams TSL must be loaded in the drawing",
            "A valid Filter definition catalog entry selected"
          ]
        }
      },
      "tokens_used": 5034,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Script Insertion (if no execute key)",
            "title": null,
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 1,
            "variable": "tslIdentifier",
            "type": "PropString",
            "displayName": "Pos 1",
            "defaultValue": " ",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "Only one instance, per identifier, can be attached to an element."
          },
          {
            "index": 0,
            "variable": "referenceCorner",
            "type": "PropString",
            "displayName": "Reference corner",
            "defaultValue": "|Bottom left|",
            "inputType": "dropdown",
            "options": [
              "|Bottom left|",
              "|Bottom right|",
              "|Top right|",
              "|Top left|"
            ],
            "category": "|Reference|",
            "description": "Sets the reference corner. All marking is offsetted from this corner."
          },
          {
            "index": 1,
            "variable": "offsetMarking",
            "type": "PropDouble",
            "displayName": "Offset marking",
            "defaultValue": 200,
            "inputType": "number",
            "options": [],
            "category": "|Reference|",
            "description": "Sets the offset for the marking from the start of the beam."
          },
          {
            "index": 2,
            "variable": "distanceBewteenReferenceMarkerLines",
            "type": "PropDouble",
            "displayName": "Distance between marker lines",
            "defaultValue": 15,
            "inputType": "number",
            "options": [],
            "category": "|Reference|",
            "description": "Sets the distance between the 2 marker lines."
          },
          {
            "index": 11,
            "variable": "filterDefinition",
            "type": "PropString",
            "displayName": "Filter definition beams",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": "Dynamic (from HSB_G-FilterGenBeams catalog)",
            "category": "|Filtering|",
            "description": "Filter definition for  beams. Use HSB_G-FilterGenBeams to define the filters."
          },
          {
            "index": 12,
            "variable": "extraFilter",
            "type": "PropString",
            "displayName": "Extra Filter",
            "defaultValue": "|--|",
            "inputType": "dropdown",
            "options": [
              "|--|",
              "|Horizontal|",
              "|Vertical|",
              "|Both|"
            ],
            "category": "|Filtering|",
            "description": "specify if you also want to filter horizontal or/and vertical beams."
          },
          {
            "index": 0,
            "variable": "symbolColor",
            "type": "PropInt",
            "displayName": "Color",
            "defaultValue": 4,
            "inputType": "number",
            "options": [],
            "category": "|Visualisation|",
            "description": "Specifies the color of the visualisation symbol."
          },
          {
            "index": 0,
            "variable": "symbolSize",
            "type": "PropDouble",
            "displayName": "Symbol size",
            "defaultValue": 40,
            "inputType": "number",
            "options": [],
            "category": "|Visualisation|",
            "description": "Specifies the size of the visualisation symbol."
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Execute Key",
            "handler": "Catalog Entry",
            "action": "Runs the script and applies properties defined in the catalog entry.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Catalog Entries",
            "searchPaths": [
              "_kExecuteKey"
            ],
            "purpose": "Stores property presets for specific insertions.",
            "required": false
          }
        ]
      },
      "tokens_used": 5958,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically adds reference marks to beams within an element to ensure correct positioning during assembly and production.",
          "category": "ProductionMarking",
          "typicalUseCase": "Used during the pre-assembly of timber elements (walls/floors) where workers need visual cues on specific beams to verify alignment relative to a reference corner."
        },
        "parameters": [
          {
            "name": "tslIdentifier",
            "technicalDefault": " ",
            "businessMeaning": "A unique tag to identify this specific set of markings, preventing the same element from having duplicate marking rules applied.",
            "validRange": "Any unique string",
            "unit": "text",
            "affectsOutput": "If a duplicate identifier is found on the same element, the older script instance is removed. Does not alter geometry directly."
          },
          {
            "name": "referenceCorner",
            "technicalDefault": "|Bottom left|",
            "businessMeaning": "Determines which corner of the element acts as the origin (0,0) for calculating the direction and start point of the beam markings.",
            "validRange": "|Bottom left|, |Bottom right|, |Top right|, |Top left|",
            "unit": "enum",
            "affectsOutput": "Inverts the coordinate system logic. Changing this flips the side of the beam considered the 'start' (where the offset is measured from)."
          },
          {
            "name": "offsetMarking",
            "technicalDefault": 200,
            "businessMeaning": "The distance from the beam's start point (relative to the reference corner) to the center of the reference mark.",
            "validRange": "50 to 1000",
            "unit": "mm",
            "affectsOutput": "Moves the Mark entity along the beam's length axis. Critical for ensuring marks are not placed under connectors or too close to the ends."
          },
          {
            "name": "distanceBewteenReferenceMarkerLines",
            "technicalDefault": 15,
            "businessMeaning": "The length of the line segment drawn on the beam as the reference mark.",
            "validRange": "10 to 100",
            "unit": "mm",
            "affectsOutput": "Directly changes the geometry of the Mark entity (line length) produced for the machine/CNC."
          },
          {
            "name": "filterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Selects a pre-configured rule set (from HSB_G-FilterGenBeams) to determine which specific beams within the element receive the mark.",
            "validRange": "Catalog entries from HSB_G-FilterGenBeams",
            "unit": "selection",
            "affectsOutput": "Filters the list of beams processed. Beams not matching the selected definition do not receive any marks."
          },
          {
            "name": "extraFilter",
            "technicalDefault": "|--|",
            "businessMeaning": "Filters beams based on their orientation relative to the element's local axes (horizontal = parallel to ElX, vertical = parallel to ElY).",
            "validRange": "|--|, |Horizontal|, |Vertical|, |Both|",
            "unit": "enum",
            "affectsOutput": "Excludes beams based on vector alignment. If set to 'Horizontal', beams running vertically (relative to element) are skipped."
          },
          {
            "name": "symbolColor",
            "technicalDefault": 4,
            "businessMeaning": "The display color of the 3D preview symbol in the CAD model.",
            "validRange": "1 to 255 (AutoCAD Color Index)",
            "unit": "index",
            "affectsOutput": "Only affects the visual 'Display' entity in the model; does not change the physical mark on the beam."
          },
          {
            "name": "symbolSize",
            "technicalDefault": 40,
            "businessMeaning": "The graphical size of the 3D preview symbol drawn in the model.",
            "validRange": "10 to 100",
            "unit": "mm",
            "affectsOutput": "Scales the PLine visualization geometry. Has no impact on the actual CNC mark size."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "referenceCorner",
            "effect": "Modifies the origin and direction vectors used to calculate the beam's 'start' face.",
            "cascade": [
              "offsetMarking"
            ]
          },
          {
            "trigger": "extraFilter",
            "effect": "Restricts the set of beams processed by the filterDefinition.",
            "cascade": [
              "filterDefinition"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mark",
            "description": "A physical line marking applied to the beam surface for production reference.",
            "appliedTo": "Beams belonging to the selected Element that pass the filter criteria."
          },
          {
            "type": "Display (PLine/Text)",
            "description": "A visual 'Y' shaped indicator and text label in the 3D model to show script presence.",
            "appliedTo": "Element origin (ModelSpace visual only)."
          }
        ]
      },
      "tokens_used": 6847,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch: User runs the script from the catalog or command line.",
          "2. Initialization: Define properties, vectors, and localized strings.",
          "3. Execution Key Check: Determine if the script was started via a predefined catalog entry.",
          "4. [Conditional] Property Input: Load properties from catalog key OR show dynamic dialog if no key is used.",
          "5. Insertion Phase: Check for multiple insertion cycles (error if > 1).",
          "6. User Selection: Prompt user to select Elements via PrEntity.",
          "7. Selection Loop: Iterate through all selected elements.",
          "8. Conflict Resolution: Check if the element already contains this script with the same 'tslIdentifier'. If found, erase the old instance.",
          "9. Instance Creation: Create a new script instance attached to the Element in ModelSpace.",
          "10. Cleanup: Erase the temporary insertion instance and exit.",
          "11. Execution Phase (New Instance): Validate Element linkage (_Element).",
          "12. Coordinate Setup: Retrieve Element Coordinate System (Origin, X, Y, Z).",
          "13. Duplicate Runtime Check: Scan element TSLs again to ensure no other instance with the same ID exists.",
          "14. Reference Calculation: Define Reference X and Y vectors based on the 'referenceCorner' property.",
          "15. Beam Collection: Retrieve all beams from the element.",
          "16. Filtering - Step 1: Call 'HSB_G-FilterGenBeams' to filter beam list based on catalog definition.",
          "17. Filtering - Step 2: Apply 'extraFilter' logic (Horizontal/Vertical/Both) to the remaining beams.",
          "18. Processing Loop: Iterate through valid beams.",
          "19. Orientation Alignment: Adjust Beam X-axis direction to align with the Reference Corner vectors.",
          "20. Face Determination: Compare beam dimensions (width vs height) to select the short side for marking.",
          "21. Positioning: Calculate the mark position based on 'offsetMarking' from the beam start.",
          "22. Mark Creation: Generate the 'Mark' entity and add it to the beam.",
          "23. Visualization: Draw the 'Y' symbol and script name at the element origin in 3D and Plan views."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Trigger Method",
            "path1": {
              "name": "Catalog Execution",
              "steps": [
                "Detect _kExecuteKey in catalog list",
                "Load properties directly from catalog entry",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Insertion",
              "steps": [
                "Detect empty or invalid _kExecuteKey",
                "Execute ShowDynamicDialog()",
                "User inputs properties manually",
                "Save properties to '_LastInserted' catalog"
              ]
            }
          },
          {
            "condition": "Duplicate Identifier Detection",
            "path1": {
              "name": "Conflict Found",
              "steps": [
                "Find existing TSL on Element with matching scriptName and tslIdentifier",
                "Execute dbErase() on the old instance",
                "Proceed with new instance creation"
              ]
            },
            "path2": {
              "name": "No Conflict",
              "steps": [
                "Proceed with new instance creation"
              ]
            }
          },
          {
            "condition": "Marking Face Selection",
            "path1": {
              "name": "Vertical Face (Narrow)",
              "steps": [
                "Check if beam height (dD Z) is greater than beam width (dD Y)",
                "Select Y-axis vector as marking face"
              ]
            },
            "path2": {
              "name": "Horizontal Face (Wide/Narrow depending on rotation)",
              "steps": [
                "Check if beam width (dD Y) is greater than or equal to beam height (dD Z)",
                "Select Z-axis vector as marking face"
              ]
            }
          },
          {
            "condition": "Orientation Filter (extraFilter)",
            "path1": {
              "name": "Horizontal",
              "steps": [
                "Check dot product of Beam X and Element X",
                "Skip beam if alignment is not near 1.0"
              ]
            },
            "path2": {
              "name": "Vertical",
              "steps": [
                "Check dot product of Beam X and Element Y",
                "Skip beam if alignment is not near 1.0"
              ]
            },
            "path3": {
              "name": "Both",
              "steps": [
                "Check alignment against Element X AND Element Y",
                "Skip beam if neither alignment is near 1.0"
              ]
            },
            "path4": {
              "name": "None (|--|)",
              "steps": [
                "Skip orientation check",
                "Process beam based on other filters"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases itself if insertCycleCount() > 1 to prevent recursion."
          },
          {
            "check": "Element Selection",
            "errorMessage": "Invalid or no element selected.",
            "recovery": "Script erases itself; User must run script again and select a valid element."
          },
          {
            "check": "External Filter Script Availability",
            "errorMessage": "Beams could not be filtered! Make sure that the tsl HSB_G-FilterGenBeams is loaded in the drawing.",
            "recovery": "User must load 'HSB_G-FilterGenBeams' TSL or select a valid filter definition, then re-run/update the script."
          },
          {
            "check": "Element Linkage on Instance",
            "errorMessage": "Invalid selection!",
            "recovery": "Script erases instance; indicates data corruption or deleted element."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties (OPM)",
            "how": "Select Element in Model Space -> Properties Palette -> Expand TSL entry",
            "effect": "Changing 'referenceCorner', 'offsetMarking', 'distanceBewteenReferenceMarkerLines', or filter properties triggers an immediate recalculation and update of the marks on the beams. Changing 'tslIdentifier' triggers the uniqueness check, potentially removing other instances."
          },
          {
            "action": "Change Catalog Entry",
            "how": "Right-click Element -> TSL Menu -> Select different catalog entry for this script.",
            "effect": "All properties associated with the new catalog entry are applied, and marks update accordingly."
          },
          {
            "action": "Delete/Remove Script",
            "how": "Right-click Element -> TSL Menu -> Remove [Script Name]",
            "effect": "All reference marks generated by this instance are removed from the beams in the element."
          }
        ]
      },
      "tokens_used": 9676,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-ReferenceMarking\n\n## Overview\nThis script automatically adds production reference marks to specific beams within a timber element. It is used to ensure correct positioning during assembly by marking beams based on a selected reference corner and offset.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on Elements and their beams within the 3D model. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities**: An Element (e.g., Wall, Floor) containing Beams.\n- **Required Settings**: The TSL script **HSB_G-FilterGenBeams** must be loaded in the drawing to use the filter functionality effectively.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-ReferenceMarking.mcr` from the catalog.\n\n### Step 2: Configure Properties (If applicable)\nIf you run the script without selecting a predefined Catalog Entry (Execute Key), a dynamic dialog will appear.\n```\nDialog: ShowDynamicDialog\nAction: Select the desired filter definition, reference corner, and offsets. Click OK to confirm.\n```\n\n### Step 3: Select Element\n```\nCommand Line: Select elements\nAction: Click on the Element(s) in the model to which you want to apply the reference marks. Press Enter to confirm selection.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Pos 1 | Text | \" \" | Unique identifier for this script instance. If another instance with the same ID exists on the element, it will be replaced. |\n| Reference corner | Dropdown | \\|Bottom left\\| | Sets the origin corner of the element used to calculate beam start points and marking direction. |\n| Offset marking | Number | 200 | The distance (in mm) from the beam's start point to the center of the reference mark. |\n| Distance between marker lines | Number | 15 | The length (in mm) of the mark drawn on the beam. |\n| Filter definition beams | Dropdown | *Dynamic* | Select a filter rule (defined in HSB_G-FilterGenBeams) to determine which beams receive the mark. |\n| Extra Filter | Dropdown | \\|--\\| | Additional filter to include only Horizontal (\\|X\\|), Vertical (\\|Y\\|), or Both orientations relative to the element. |\n| Color | Number | 4 | The color index (1-255) for the visualization symbol in the model. |\n| Symbol size | Number | 40 | The graphical size (in mm) of the visualization symbol displayed in the model. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Execute Key | Applies the properties from a specific catalog entry preset to the script instance. |\n\n## Settings Files\n- **Catalog Entries**: Stored within the drawing or standard catalog.\n- **Purpose**: Stores predefined property sets (Execute Keys) for different marking scenarios (e.g., \"Left Wall Standard\", \"Floor Right\").\n\n## Tips\n- **Visual vs. Production**: The \"Symbol size\" and \"Color\" properties only affect the 3D preview in AutoCAD. The actual physical mark on the beam is determined by the \"Offset marking\" and \"Distance between marker lines\".\n- **Filtering**: If no marks appear, check if `HSB_G-FilterGenBeams` is loaded and if the selected \"Filter definition beams\" actually matches the beams in your element.\n- **Conflict Management**: Use the \"Pos 1\" identifier to manage different marking schemes on the same element. Changing this ID allows you to run multiple instances of the script on a single element without conflicts.\n\n## FAQ\n- **Q: Why do I see an error \"Beams could not be filtered!\"?**\n- **A:** Ensure that the TSL script `HSB_G-FilterGenBeams` is loaded in your drawing. This script is required to process the beam selection.\n\n- **Q: Can I mark beams that are not rectangular?**\n- **A:** Yes, the script calculates the start point based on the element coordinate system. However, filtering depends on the logic provided by the HSB_G-FilterGenBeams catalog.\n\n- **Q: How do I remove the marks?**\n- **A:** Right-click the Element, go to the TSL Menu, and select \"Remove [Script Name]\" or delete the script instance from the element properties."
      },
      "tokens_used": 7069,
      "error": null
    }
  }
}