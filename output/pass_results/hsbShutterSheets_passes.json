{
  "filename": "hsbShutterSheets.mcr",
  "status": "completed",
  "total_tokens": 48538,
  "processing_time": 361.23223185539246,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8901,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses 'tslNew.dbCreate(..., _kModelSpace, ...)' to insert instances. It operates on 'OpeningSF' selections, interacts with 'Element' and 'Sheet' entities (e.g., 'Sheet sheets[] = el.sheet(nZone)'), and performs 3D geometric operations using 'Body', 'PlaneProfile', and 'CoordSys'. No shop drawing ('sd_') prefixes or paper space entities ('_Viewport') are detected."
        },
        "prerequisites": {
          "requiredEntities": [
            "Opening",
            "Element",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "3D Model Space with a constructed element containing an opening",
          "requiredSettings": []
        }
      },
      "tokens_used": 6574,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select opening(s)",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Shown when no catalog entry is found during insertion, or during map IO",
            "title": null,
            "dataSource": "Internal Property List",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "Zone",
            "defaultValue": 5,
            "inputType": "dropdown",
            "options": [
              "-5",
              "-4",
              "-3",
              "-2",
              "-1",
              "1",
              "2",
              "3",
              "4",
              "5"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dXOffset",
            "type": "PropDouble",
            "displayName": "X-Offset",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the offset in X-direction"
          },
          {
            "index": 2,
            "variable": "dYOffset",
            "type": "PropDouble",
            "displayName": "Y-Offset",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the offset in X-direction"
          },
          {
            "index": 3,
            "variable": "dMaxHeight",
            "type": "PropDouble",
            "displayName": "max. Height",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the maximal height of the sheet above/below the opening 0 = no limit"
          },
          {
            "index": 4,
            "variable": "dXGap",
            "type": "PropDouble",
            "displayName": "Lateral offset",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines a horizontal gap"
          },
          {
            "index": 5,
            "variable": "dYGap1",
            "type": "PropDouble",
            "displayName": "Gap towards opening",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines a horizontal gap at the side of the opening"
          },
          {
            "index": 6,
            "variable": "dYGap2",
            "type": "PropDouble",
            "displayName": "Gap opposite opening",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines a horizontall gap at the opposide side of the opening"
          },
          {
            "index": 0,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "Alignment",
            "defaultValue": "Top",
            "inputType": "dropdown",
            "options": [
              "Bottom",
              "Top"
            ],
            "category": "Alignment",
            "description": "Defines the alignment"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7231,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Generates and modifies wall sheeting (cladding or structural sheathing) specifically to create shutter boards or infill panels above or below an opening.\",\n    \"category\": \"Sheeting/Cladding\",\n    \"typicalUseCase\": \"Creating a structural header board above a window in a timber frame wall, or adding a specific infill sheet below a door, ensuring it fits within the wall's sheeting zone.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"nZone\",\n      \"technicalDefault\": 5,\n      \"businessMeaning\": \"Identifies the specific wall layer (e.g., exterior sheathing, interior finish) to apply the shutter sheet to.\",\n      \"validRange\": \"-5 to 5 (Integers)\",\n      \"unit\": \"Index\",\n      \"affectsOutput\": \"Determines which existing sheets are cut and to which zone the new shutter sheet is assigned. The script erases itself if the selected zone has zero thickness.\"\n    },\n    {\n      \"name\": \"dXOffset\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Expands the width of the shutter sheet equally on both sides relative to the opening width.\",\n      \"validRange\": \"-500 to 500\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Increases or decreases the horizontal span of the generated sheet.\"\n    },\n    {\n      \"name\": \"dYOffset\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Shifts the shutter sheet vertically towards (positive) or away from (negative) the opening center.\",\n      \"validRange\": \"-500 to 500\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Moves the sheet along the wall's vertical axis, effectively extending it over the opening or pulling it back.\"\n    },\n    {\n      \"name\": \"dMaxHeight\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Limits the vertical extension of the shutter sheet. A value of 0 allows it to extend until it hits another obstruction or the zone boundary.\",\n      \"validRange\": \"0 to 3000\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Stops the sheet from growing infinitely tall; restricts it to a specific height.\"\n    },\n    {\n      \"name\": \"dXGap\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Reduces the width of the shutter sheet on both left and right sides (side clearance).\",\n      \"validRange\": \"0 to 50\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Creates a horizontal gap between the shutter sheet edges and the surrounding wall/obstructions.\"\n    },\n    {\n      \"name\": \"dYGap1\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"The vertical clearance between the shutter sheet and the opening frame (the side closest to the window/door).\",\n      \"validRange\": \"0 to 50\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Offsets the edge of the sheet nearest the opening.\"\n    },\n    {\n      \"name\": \"dYGap2\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"The vertical clearance between the shutter sheet and the wall boundary/top plate (the side furthest"
      },
      "tokens_used": 10045,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initiated (via command or catalog)",
          "Check Insert Cycle: If >1, erase instance and return (prevents loops)",
          "Catalog Check: Search for catalog entry matching execution key",
          "[Conditional] Load Properties (Silent) or Show Dialog",
          "User Input: Select opening(s) via command line prompt",
          "Instance Generation: Loop through selection and create attached TSL instances in ModelSpace",
          "Erase Starter Instance: Remove the temporary script instance used for insertion",
          "[Instance Execution]",
          "Map IO: If triggered by map, show dialog, update _Map, and exit",
          "DbCreated: Read properties from _Map and apply to local variables",
          "Validation: Check if _Opening[0] and Element el are valid; erase if not",
          "Zone Check: Query sheets in specified zone (nZone)",
          "[Conditional] Zone Status Check",
          "Geometry Calculation: Build zone profile, detect opening shape contour",
          "Shutter Profile Calculation: Define rectangle based on offsets, gaps, alignment, and max height",
          "Intersection Handling: Find existing sheets in the test volume",
          "Modify Existing Sheets: Subtract shutter profile from found sheets (erase if area is negligible)",
          "Gap Application: Subtract lateral gaps (dXGap) from shutter profile",
          "Distribution Check: Compare width with zone sheeting dimensions (width/height)",
          "Sheet Generation: Create new Sheet entities (single or distributed), assign zone/material",
          "Finalize: Erase script instance (unless in Debug mode)"
        ],
        "conditionalBranches": [
          {
            "condition": "Catalog Entry Found",
            "path1": {
              "name": "Silent Load",
              "steps": [
                "Set properties from catalog values",
                "Proceed to selection"
              ]
            },
            "path2": {
              "name": "Interactive Dialog",
              "steps": [
                "Show Dynamic Dialog",
                "User inputs settings",
                "Proceed to selection"
              ]
            }
          },
          {
            "condition": "Sheets found in target Zone (nZone)",
            "path1": {
              "name": "Zone Constructed",
              "steps": [
                "Continue with geometry calculation"
              ]
            },
            "path2": {
              "name": "Zone Missing/Empty",
              "steps": [
                "Check zone thickness (el.zone(nZone).dH())",
                "If thickness < 0.1mm, erase instance",
                "If thickness > 0.1mm, display 'waiting for construction'",
                "Set execution loops and pause"
              ]
            }
          },
          {
            "condition": "Opening Contour Detected",
            "path1": {
              "name": "Contour Found",
              "steps": [
                "Use detected profile for shutter logic"
              ]
            },
            "path2": {
              "name": "Contour Failed (e.g. Door)",
              "steps": [
                "Calculate convex hull of zone",
                "Subtract zone profile to find opening boundary",
                "Use resulting boundary for shutter logic"
              ]
            }
          },
          {
            "condition": "Alignment Property (Top vs Bottom)",
            "path1": {
              "name": "Bottom",
              "steps": [
                "Direction vector = -vecY",
                "Swap vertical gap usage (dYUseGap1/dYUseGap2)"
              ]
            },
            "path2": {
              "name": "Top",
              "steps": [
                "Direction vector = +vecY",
                "Standard vertical gap usage"
              ]
            }
          },
          {
            "condition": "Shutter Width vs Zone Sheet Dimensions",
            "path1": {
              "name": "Fits in Single Sheet",
              "steps": [
                "Create one Sheet entity"
              ]
            },
            "path2": {
              "name": "Requires Distribution",
              "steps": [
                "Calculate quantity based on max width",
                "Loop to create multiple Sheets with gaps (dSheetGap)"
              ]
            }
          },
          {
            "condition": "Zone Sign (Positive vs Negative)",
            "path1": {
              "name": "Positive Zone",
              "steps": [
                "Create Sheet at CoordinateSystem location"
              ]
            },
            "path2": {
              "name": "Negative Zone",
              "steps": [
                "Invert Y and Z vectors for Sheet CS",
                "Transform profile by -Zone thickness"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle Count",
            "errorMessage": "None",
            "recovery": "N/A (Automatic cleanup)"
          },
          {
            "check": "Valid Opening Entity",
            "errorMessage": "None",
            "recovery": "N/A (Instance erased if invalid)"
          },
          {
            "check": "Valid Element Entity",
            "errorMessage": "None",
            "recovery": "N/A (Instance erased if invalid)"
          },
          {
            "check": "Zone Thickness (construction)",
            "errorMessage": "None (or 'waiting for construction')",
            "recovery": "Ensure wall construction exists in the specified zone"
          },
          {
            "check": "Opening Dimensions (Width/Height > 0.1mm)",
            "errorMessage": "Tool is not applicable.",
            "recovery": "Verify opening dimensions or wall structure"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Parameters",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Changing offsets, gaps, alignment, or max height triggers recalculation and updates/rebuilds the shutter sheets."
          },
          {
            "action": "Change Zone",
            "how": "OPM (Zone Property)",
            "effect": "Moves the shutter logic to a different wall layer. If the new zone has no thickness, the script instance erases itself."
          },
          {
            "action": "Map IO",
            "how": "Context Menu / Map Import",
            "effect": "Allows bulk updates of properties or resetting configuration via dialog."
          }
        ]
      },
      "tokens_used": 9384,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbShutterSheets.mcr\n\n## Overview\nThis script automatically generates shutter boards (infill panels or structural sheathing) above or below wall openings such as windows and doors. It calculates the geometry based on the wall construction, cuts existing sheeting where necessary, and inserts the new sheets aligned with the specified zone.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script inserts and modifies sheet entities in the 3D model. |\n| Paper Space | No | This script does not generate 2D shop drawings. |\n| Shop Drawing | No | This script operates on the physical model only. |\n\n## Prerequisites\n- **Required Entities**: An `Element` (Wall) with a defined construction and an `Opening` (Window/Door).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: The target wall must have a constructed \"Sheet\" layer (Zone) with a thickness greater than 0.1mm.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbShutterSheets.mcr` from the catalog or file browser.\n\n### Step 2: Configuration\nIf no catalog entry is found, a dialog may appear to set initial parameters. Otherwise, proceed to selection.\n\n### Step 3: Select Opening\n```\nCommand Line: Select opening(s)\nAction: Click on the window or door opening(s) in the drawing where you want to add shutter sheets.\n```\n\n### Step 4: Edit Properties (Optional)\nAfter insertion, select the newly created script instance (or the opening with the attached script) and open the **Properties Palette (OPM)** to fine-tune dimensions, offsets, and alignment.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone | dropdown | 5 | Selects the wall layer (e.g., exterior sheathing) to apply the sheet to. Range is -5 to 5. |\n| X-Offset | number | 0 | Extends the width of the shutter sheet equally on both sides relative to the opening width. |\n| Y-Offset | number | 0 | Shifts the shutter sheet vertically. Positive moves it away from the opening center; negative pulls it back. |\n| max. Height | number | 0 | Limits the vertical height of the sheet. A value of 0 allows it to extend until it hits another obstruction or zone boundary. |\n| Lateral offset | number | 0 | Creates a horizontal gap between the sheet edges and the surrounding wall/obstructions. |\n| Gap towards opening | number | 0 | Defines the vertical gap between the sheet edge and the opening frame (window/door). |\n| Gap opposite opening | number | 0 | Defines the vertical gap at the side furthest from the opening (towards top or bottom plate). |\n| Alignment | dropdown | Top | Determines if the sheet is placed relative to the Top (Header) or Bottom (Sill) of the opening. |\n\n## Right-Click Menu Options\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add specific custom items to the right-click context menu. Edit parameters via the Properties Palette. |\n\n## Settings Files\n- **Filename**: None (Standard script execution).\n- **Location**: N/A\n- **Purpose**: N/A (Uses internal properties and Map IO).\n\n## Tips\n- **Zone Selection**: Ensure the selected Zone has a constructed thickness. If the script erases itself immediately, the Zone thickness is likely 0.\n- **Header vs. Sill**: Use the **Alignment** property to toggle between creating a header board (Top) and a sill board (Bottom).\n- **Avoiding Collisions**: Use **max. Height** to prevent the shutter sheet from extending too far up or down into intersecting walls or roofs.\n- **Distribution**: If the calculated width of the shutter sheet exceeds the maximum width defined in your sheeting material catalogs, the script will automatically distribute the sheet into multiple pieces.\n\n## FAQ\n- **Q: The script disappeared after I selected the opening. Why?**\n- **A: This usually happens if the selected **Zone** has a thickness of 0mm in the wall construction. Check your wall construction settings or select a different Zone (e.g., 1 or 2) that contains actual sheeting material.\n\n- **Q: The prompt says \"waiting for construction\". What does this mean?**\n- **A: The script has detected the Zone exists but the wall geometry has not been generated/calculated for that specific layer yet. Run the \"Generate Single Element\" or similar wall construction command to update the wall, and the script will proceed automatically.\n\n- **Q: How do I create a sheet that extends past the window trim?**\n- **A: Set a positive value for **X-Offset**. This will widen the shutter sheet beyond the width of the opening."
      },
      "tokens_used": 6403,
      "error": null
    }
  }
}