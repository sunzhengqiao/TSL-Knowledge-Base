{
  "filename": "Hilti-Verankerungsplan.mcr",
  "status": "completed",
  "total_tokens": 50774,
  "processing_time": 422.2322759628296,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9594,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly creates new TSL instances using `_kModelSpace` in the `dbCreate` function. It lacks `#Type E`, `sd_` prefixes, or `_Viewport` handling, indicating it operates entirely in the Model environment to generate dimensions and geometry relative to a selected Polyline."
        },
        "prerequisites": {
          "requiredEntities": [
            "EntPLine",
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script requires a selection of a Polyline and one or more TSL instances (specifically 'Hilti-Verankerung', 'Hilti-Stockschraube', or 'hsbCLT-Hilti') to function.",
          "requiredSettings": []
        }
      },
      "tokens_used": 5991,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": \"T(\\\"|_LastInserted|\\\")\",\n        \"condition\": \"_kExecuteKey.length()>0\",\n        \"required\": false\n      },\n      {\n        \"step\": 2,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_kExecuteKey.length()==0\",\n        \"required\": false\n      },\n      {\n        \"step\": 3,\n        \"function\": \"getEntPLine\",\n        \"promptOriginal\": null,\n        \"condition\": null,\n        \"required\": true\n      },\n      {\n        \"step\": 4,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"T(\\\"|Select TSL(s)|\\\")\",\n        \"condition\": null,\n        \"required\": true\n      },\n      {\n        \"step\": 5,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": null,\n        \"condition\": null,\n        \"required\": true\n      }\n    ]\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"dTxtH\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Text height\",\n      \"defaultValue\": \"U(70)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nColor\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color\",\n      \"defaultValue\": \"6\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimstyle\",\n      \"defaultValue\": \"_DimStyles\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"_DimStyles\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sGroup\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Auto group (seperate Level by '\\\\')\",\n      \"defaultValue\": \"Hilti Verankerungsplan\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"Determines the group (seperate level by '\\\\'), e.g. H"
      },
      "tokens_used": 10332,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a 2D anchoring plan that dimensions and labels the position of Hilti connectors relative to a boundary polyline (e.g., a concrete slab edge).",
          "category": "ShopDrawing",
          "typicalUseCase": "Used to create a layout drawing for the construction crew showing where to drill or place anchors on the foundation slab based on the timber structure above."
        },
        "parameters": [
          {
            "name": "dTxtH",
            "technicalDefault": "U(70)",
            "businessMeaning": "Height of the text labels used to identify the connector types (e.g., 'Hilti-Verankerung') in the plan.",
            "validRange": "25 - 150",
            "unit": "mm",
            "affectsOutput": "Scales the size of text labels and adjusts the offset distance of dimension lines to ensure text does not overlap geometry."
          },
          {
            "name": "nColor",
            "technicalDefault": "6",
            "businessMeaning": "The CAD color index assigned to all generated elements (dimensions, text, and markers) in the plan.",
            "validRange": "1 - 255",
            "unit": "Index",
            "affectsOutput": "Changes the visual color of the plan elements in the model to distinguish them from other geometry (e.g., red for anchor plans)."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "The specific drafting standard (dimension style) applied to the generated dimensions, controlling arrowheads, ticks, and text font.",
            "validRange": "Any existing DimStyle name in the drawing",
            "unit": "String",
            "affectsOutput": "Determines the graphical representation of dimension lines and arrowheads to match company or project standards."
          },
          {
            "name": "sGroup",
            "technicalDefault": "Hilti Verankerungsplan",
            "businessMeaning": "The group path to which the plan instance is assigned, allowing users to toggle the visibility of the entire plan on/off.",
            "validRange": "String (supports hierarchy via '\\')",
            "unit": "String",
            "affectsOutput": "Controls the visibility state of the generated plan within the hsbCAD project structure. If empty, no group is assigned."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dTxtH modification",
            "effect": "Alters the offset calculation of dimension lines (ptClosest-vx_*dTxtH) to maintain legibility.",
            "cascade": [
              "Dimension Line Geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation",
            "description": "Dimension lines and text labels indicating the offset of connectors from the selected boundary polyline.",
            "appliedTo": "ModelSpace (relative to selected Polyline and Connectors)"
          },
          {
            "type": "AuxiliaryGeometry",
            "description": "Visual markers and text identifying the specific Hilti connector type.",
            "appliedTo": "ModelSpace"
          }
        ]
      },
      "tokens_used": 8466,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch 'Hilti-Verankerungsplan' command",
          "Check for Execute Key (Catalog) vs Manual Launch",
          "[If Manual] Show Properties Dialog",
          "Select Boundary Polyline (EntPLine)",
          "Select Hilti Connector TSL(s) (Filtered selection)",
          "Select Reference Point for Offset (_Pt0)",
          "[Mode 0 Generation] Calculate Polyline Segments",
          "[Mode 0 Generation] Project Connectors onto Segments",
          "[Mode 0 Generation] Spawn Child TSL Instances (Mode 1) for each Segment",
          "[Mode 0 Generation] Erase Parent Script Instance",
          "[Mode 1 Execution] Display Dimensions and Text",
          "[Mode 1 Execution] Listen for Context Menu or Grip Changes"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Launch Trigger",
            "path1": {
              "name": "Catalog/Execute Key",
              "steps": [
                "Check if _kExecuteKey exists in catalog",
                "Apply properties from catalog entry",
                "Skip Properties Dialog"
              ]
            },
            "path2": {
              "name": "Standard Manual Launch",
              "steps": [
                "Open Properties Dialog (showDialog)",
                "User confirms settings"
              ]
            }
          },
          {
            "condition": "Connector Type Processing",
            "path1": {
              "name": "hsbCLT-Hilti",
              "steps": [
                "Check if attached to exactly 1 Panel (Sip)",
                "Check if Vector Z points Up (World Z)",
                "Calculate reference from Sip Element",
                "Add to valid TSL list"
              ]
            },
            "path2": {
              "name": "Standard Connectors (Hilti-Verankerung, Hilti-Stockschraube)",
              "steps": [
                "Get Element Wall",
                "Check 'exposed' property of Wall",
                "If Exposed: Project reference directly to Polyline",
                "If Not Exposed: Calculate intersection with Polyline planes",
                "Add to valid TSL list"
              ]
            }
          },
          {
            "condition": "Group Assignment",
            "path1": {
              "name": "Group Defined",
              "steps": [
                "Check if sGroup property is not empty",
                "Create Group if it does not exist",
                "Assign current TSL instance to the Group"
              ]
            },
            "path2": {
              "name": "No Group",
              "steps": [
                "Check if sGroup property is empty",
                "Skip Group creation/assignment",
                "Instance remains ungrouped"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Boundary Polyline Validity",
            "errorMessage": "None (Script fails silently)",
            "recovery": "Script calls eraseInstance() if no valid polyline is selected. User must re-run command and select a valid polyline."
          },
          {
            "check": "Minimum Connector Count",
            "errorMessage": "None (Script fails silently)",
            "recovery": "Script calls eraseInstance() if zero valid TSL connectors are found in selection. User must ensure selected entities match allowed list (Hilti-Verankerung, Hilti-Stockschraube, hsbCLT-Hilti)."
          },
          {
            "check": "CLT Connector Orientation",
            "errorMessage": "None (Filtered out)",
            "recovery": "hsbCLT-Hilti instances pointing downwards or on multiple panels are automatically removed from the list without warning, preventing calculation errors."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add Connector to Dimension",
            "how": "Right-click Context Menu > 'Verankerung hinzufügen'",
            "effect": "Opens selection prompt. Selected valid TSLs are appended to the dimension instance, triggering a recalculation to include them in the dimension line."
          },
          {
            "action": "Remove Connector from Dimension",
            "how": "Right-click Context Menu > 'Verankerung entfernen'",
            "effect": "Opens selection prompt. Selected TSLs are removed from the instance's entity list, and dimensions are updated."
          },
          {
            "action": "Add Manual Dimension Points",
            "how": "Right-click Context Menu > 'Add Points'",
            "effect": "Enters a loop allowing user to pick multiple points. These points are added to the dimension line definition."
          },
          {
            "action": "Delete Manual Dimension Points",
            "how": "Right-click Context Menu > 'Delete Points'",
            "effect": "Allows user to select and remove previously added manual points from the dimension line."
          },
          {
            "action": "Move Dimension Line",
            "how": "Grip Edit (Drag _Pt0)",
            "effect": "Moves the entire dimension line and maintains the relative offset of all manual points attached to it."
          },
          {
            "action": "Modify Visual Style",
            "how": "OPM Properties Palette",
            "effect": "Changes Text Height (dTxtH), Color (nColor), or Dimstyle (sDimStyle) instantly updating the graphics."
          }
        ]
      },
      "tokens_used": 10254,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Hilti-Verankerungsplan.mcr\n\n## Overview\nThis script automatically generates a 2D anchoring plan by dimensioning Hilti connectors relative to a selected boundary polyline, such as a concrete slab edge. It creates visual markers and dimension lines indicating where to place anchors on the foundation.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script operates entirely in ModelSpace. |\n| Paper Space | No | |\n| Shop Drawing | No | |\n\n## Prerequisites\n- **Required Entities:**\n  - A **Polyline** representing the boundary (e.g., slab edge).\n  - One or more **TSL instances** of type: `Hilti-Verankerung`, `Hilti-Stockschraube`, or `hsbCLT-Hilti`.\n- **Minimum beam count:** 0 (This script works with TSL instances and Polylines, not directly with beams).\n- **Required settings:** None (Standard TSL environment).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Browse and select `Hilti-Verankerungsplan.mcr`.\n\n### Step 2: Configure Properties\n**Action:** A properties dialog will appear (unless launched from a catalog preset).\n- Adjust settings like **Text Height**, **Color**, or **Dimstyle** if necessary.\n- Click **OK** to proceed.\n\n### Step 3: Select Boundary Polyline\n```\nCommand Line: Select Polyline\nAction: Click on the Polyline that represents the edge or boundary you want to dimension against.\n```\n\n### Step 4: Select Connectors\n```\nCommand Line: Select TSL(s)\nAction: Select the Hilti connector instances (Hilti-Verankerung, Hilti-Stockschraube, etc.) you wish to include in the plan. Press Enter to confirm selection.\n```\n\n### Step 5: Place Reference Point\n```\nCommand Line: Select Point\nAction: Click a point in the drawing to determine the position and offset of the dimension lines.\n```\n*The script will now generate the dimension lines and text labels.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Text height (`dTxtH`) | Number | U(70) | Sets the height of the text labels. This also affects the spacing of dimension lines to prevent overlap. |\n| Color (`nColor`) | Number | 6 | The CAD color index (1-255) used for all generated text and dimensions. |\n| Dimstyle (`sDimStyle`) | Dropdown | _DimStyles | Select the dimension style to apply (controls arrows, ticks, and fonts). |\n| Auto group (`sGroup`) | Text | Hilti Verankerungsplan | Assigns the generated plan to a specific group in the project browser. Use `\\` to create sub-groups (e.g., `Level1\\Anchors`). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Verankerung hinzufügen** (Add Connector) | Allows you to select additional TSL connectors to be added to the existing dimension plan. |\n| **Verankerung entfernen** (Remove Connector) | Allows you to select connectors to be removed from the dimension plan. |\n| **Add Points** | Allows you to manually pick points in the drawing to be added as dimension references on the line. |\n| **Delete Points** | Allows you to select and remove manually added dimension points. |\n\n## Settings Files\n- **Catalog Entry:** `_kExecuteKey`\n- **Location:** hsbCAD Catalog\n- **Purpose:** If a catalog entry exists, it can pre-fill the Properties Panel (Text height, Color, etc.) and skip the initial configuration dialog.\n\n## Tips\n- **Moving Dimensions:** Select the generated plan and drag the **Grip Point** (the point selected in Step 5) to move the entire dimension line while maintaining relative positions.\n- **Visibility Control:** Use the `sGroup` property to organize your plans. You can easily toggle the visibility of all anchors for a specific floor or section via the Project Browser.\n- **Valid Connectors:** The script automatically filters out invalid connectors. For example, `hsbCLT-Hilti` connectors pointing downwards or attached to multiple panels will be ignored without an error message.\n- **Dimension Style:** Ensure your chosen `sDimStyle` exists in the drawing before running the script, or it may default to the standard style.\n\n## FAQ\n- **Q: The script disappeared after I selected the point. Did it fail?**\n  - **A:** Not necessarily. The script works in \"Generation Mode.\" It creates child instances for the dimensions and often erases the parent script instance to keep the drawing clean. Check if your dimension lines appeared.\n  \n- **Q: Why are some of my connectors not showing up in the dimensions?**\n  - **A:** Ensure the connectors are of the correct type (`Hilti-Verankerung`, `Hilti-Stockschraube`, `hsbCLT-Hilti`). Also, verify that Wall elements associated with the connectors are set to \"exposed\" if required by your configuration.\n\n- **Q: How do I change the text size after the plan is created?**\n  - **A:** Select the dimension plan instance, open the **Properties Palette (OPM)**, and modify the `Text height (`dTxtH`) value. The graphics will update automatically."
      },
      "tokens_used": 6137,
      "error": null
    }
  }
}