{
  "filename": "hsbLogVerticalDrill.mcr",
  "status": "completed",
  "total_tokens": 48846,
  "processing_time": 246.9886975288391,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.3",
            "date": "03.06.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-14882: Dont allow empty format"
          },
          {
            "version": "1.2",
            "date": "08.04.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-14881: Add setDefinesFormat for the property"
          },
          {
            "version": "1.1",
            "date": "01.04.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-14863: Satosh: Fix bug for 0 depth (all through)"
          },
          {
            "version": "1.0",
            "date": "16nov20",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-9290: initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9031,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses tslNew.dbCreate(..., _kModelSpace, ...) to insert instances. It retrieves an ElementLog via getElement and casts the _Element[0] to ElementLog. It creates Drill operations (eLog.addOperation(dr)) and modifies 3D geometry. No sd_ functions, viewport handling, or sheet entities are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementLog"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7340,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getElement",
              "promptOriginal": "|Select ElementLog|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "|Select point for drill|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (if _kExecuteKey is empty)",
            "title": null,
            "dataSource": "TSL Properties (internal)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dDiameter",
            "type": "PropDouble",
            "displayName": "Diameter",
            "defaultValue": 50,
            "inputType": "number",
            "options": [],
            "category": "Geometry",
            "description": "Defines the Diameter"
          },
          {
            "index": 1,
            "variable": "dOffsetAxis",
            "type": "PropDouble",
            "displayName": "Axis Offset",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the Axis Offset of the drill"
          },
          {
            "index": 2,
            "variable": "dHeightStart",
            "type": "PropDouble",
            "displayName": "Start Height",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the HeightStart"
          },
          {
            "index": 3,
            "variable": "dHeightEnd",
            "type": "PropDouble",
            "displayName": "End Height",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "Alignment",
            "description": "Defines the HeightEnd"
          },
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "coordDim\\P@(coordDim)",
            "inputType": "text",
            "options": [],
            "category": "Display",
            "description": "Defines the text and/or attributes. Multiple lines are separated by a backslash '\\P'. Attributes can also be added or removed by context commands."
          },
          {
            "index": 1,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "DimStyle",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [],
            "category": "Display",
            "description": "Defines the DimStyle"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 7511,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts vertical drilling operations into Log walls (ElementLog) and generates associated dimension labels/annotations.",
          "category": "Machining/Annotation",
          "typicalUseCase": "Creating vertical holes for utilities (pipes/wires) or mechanical fasteners in log walls, while automatically labeling the hole dimensions or position."
        },
        "parameters": [
          {
            "name": "dDiameter",
            "technicalDefault": 50,
            "businessMeaning": "The diameter of the drill hole to be cut into the timber.",
            "validRange": "10mm to 300mm (dependent on wall width and structural integrity)",
            "unit": "mm",
            "affectsOutput": "Directly changes the radius of the cylindrical void removed from the wall. Updates the 'Diameter' attribute used in text labels."
          },
          {
            "name": "dOffsetAxis",
            "technicalDefault": 0,
            "businessMeaning": "The vertical elevation offset of the drilling axis from the element's origin or center.",
            "validRange": "-1000mm to +2000mm (relative to wall height)",
            "unit": "mm",
            "affectsOutput": "Shifts the entire drill path (start and end points) and the annotation vertically along the wall."
          },
          {
            "name": "dHeightStart",
            "technicalDefault": 0,
            "businessMeaning": "The start depth of the hole relative to the bottom surface of the specific log beam being drilled.",
            "validRange": "0 (bottom) to Beam Height",
            "unit": "mm",
            "affectsOutput": "Sets the lower Z-coordinate of the drill cylinder. If 0, it drills to the absolute bottom of that specific log layer."
          },
          {
            "name": "dHeightEnd",
            "technicalDefault": 0,
            "businessMeaning": "The end depth of the hole relative to the bottom surface of the specific log beam being drilled.",
            "validRange": "0 (top) to Beam Height",
            "unit": "mm",
            "affectsOutput": "Sets the upper Z-coordinate of the drill cylinder. If 0, it drills to the absolute top of that specific log layer (through drill)."
          },
          {
            "name": "sFormat",
            "technicalDefault": "coordDim\\P@(coordDim)",
            "businessMeaning": "The text template used to generate the label annotation. Supports attributes like Diameter and custom calculations (coordDim).",
            "validRange": "String containing keys like @(Diameter), @(coordDim), separated by '\\P' for new lines.",
            "unit": "String",
            "affectsOutput": "Alters the content and layout of the text displayed in the model space near the drill location."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "_DimStyles.sorted()",
            "businessMeaning": "The CAD dimension style that governs the visual appearance (font, size, arrows) of the annotation.",
            "validRange": "Any valid DimStyle name present in the current drawing.",
            "unit": "String",
            "affectsOutput": "Changes the font, text height, and color of the generated label."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Moving Start/End Grips (_PtG[0], _PtG[1])",
            "effect": "The script recalculates the dHeightStart and dHeightEnd properties to match the new grip positions relative to the log profile.",
            "cascade": [
              "dHeightStart",
              "dHeightEnd"
            ]
          },
          {
            "trigger": "Changing dHeightStart or dHeightEnd properties",
            "effect": "The visual grips (_PtG[0], _PtG[1]) update their position to reflect the new start/end heights.",
            "cascade": [
              "_PtG[0]",
              "_PtG[1]"
            ]
          },
          {
            "trigger": "Moving Insertion Point (_Pt0)",
            "effect": "Updates the lateral position (X-axis relative to wall) of the drill and the label text.",
            "cascade": [
              "Drill Position",
              "Label Position"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Drill",
            "description": "A cylindrical subtraction operation applied to the Log element geometry.",
            "appliedTo": "ElementLog"
          },
          {
            "type": "Text Label",
            "description": "Dynamic text generated based on the sFormat property, displaying dimensions or attributes.",
            "appliedTo": "Model Space"
          }
        ]
      },
      "tokens_used": 8415,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Launch Script",
          "Check Insert Cycle: If cycle count > 1, erase instance and exit.",
          "Determine Execution Mode: Check if _kExecuteKey (Catalog entry) is provided.",
          "[Branch A] Catalog Mode: Load properties from catalog entry specified by _kExecuteKey.",
          "[Branch B] Manual Mode: Show internal property Dialog for user input (Diameter, Offsets, Format).",
          "Prepare TSL Instance: Collect current property values and coordinate vectors.",
          "Loop: Prompt user to Select ElementLog.",
          "[Validation] Validate ElementLog: If selection is invalid, report error and restart loop.",
          "Loop: Prompt user to Select Point for drill (getPoint).",
          "[Validation] Validate Point: If user cancels, break the point loop.",
          "Clone TSL: Create new script instance in ModelSpace with current settings.",
          "Erase Original Template: Exit script immediately.",
          "Post-Insert Execution (Cloned Instance): Retrieve attached ElementLog and coordinate system.",
          "Calculate Geometry: Determine Start/End points based on dHeightStart/dHeightEnd properties.",
          "[Conditional] Handle Zero Depth: If height is 0, snap points to absolute top/bottom of wall profile.",
          "Update Visual Grips: Sync _PtG[0] and _PtG[1] to calculated start/end positions.",
          "Locate GenBeams: Iterate through wall beams to find those intersecting drill path.",
          "Refine Geometry: Snap Start/End points to the specific local bottom/top of intersecting GenBeams.",
          "Create Drill Operation: Define cylindrical drill between Start and End with dDiameter.",
          "Apply Machining: Add Drill operation to ElementLog.",
          "Generate Annotation: Resolve sFormat string to generate dimension label.",
          "[Conditional] Validate Text: If resulting text is empty, reset format to default and recalc.",
          "Draw Annotation: Insert Text entity into ModelSpace at calculated location."
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase Instance",
                "Return"
              ]
            },
            "path2": {
              "name": "Cycle = 1",
              "steps": [
                "Proceed to Execution Mode check"
              ]
            }
          },
          {
            "condition": "Execution Source (Insertion)",
            "path1": {
              "name": "Catalog Entry Key Present",
              "steps": [
                "Load properties from catalog",
                "Skip dialog"
              ]
            },
            "path2": {
              "name": "Manual Insertion",
              "steps": [
                "Execute showDialog",
                "Wait for user OK"
              ]
            }
          },
          {
            "condition": "Height Input Value (dHeightStart/dHeightEnd)",
            "path1": {
              "name": "Value > 0",
              "steps": [
                "Use explicit offset from bottom profile"
              ]
            },
            "path2": {
              "name": "Value == 0",
              "steps": [
                "Snap point to top or bottom extreme of ElementLog profile (plus epsilon)"
              ]
            }
          },
          {
            "condition": "Last Changed Property (Recalculation)",
            "path1": {
              "name": "_Pt0 Moved",
              "steps": [
                "Update Start/End grips based on new X-position"
              ]
            },
            "path2": {
              "name": "Heights Changed",
              "steps": [
                "Update _PtG[0] and _PtG[1] to new Z-positions"
              ]
            },
            "path3": {
              "name": "Grips Moved (_PtG0/_PtG1)",
              "steps": [
                "Update dHeightStart and dHeightEnd properties to match grip positions"
              ]
            }
          },
          {
            "condition": "Format String Resolution",
            "path1": {
              "name": "Valid Text Generated",
              "steps": [
                "Draw text entity"
              ]
            },
            "path2": {
              "name": "Empty Result",
              "steps": [
                "Reset sFormat to 'D @(Diameter)'",
                "Trigger Recalc (setExecutionLoops(2))"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "ElementLog Selection (Insertion)",
            "errorMessage": "no valid ElementLog entity",
            "recovery": "Returns to start of wall selection loop."
          },
          {
            "check": "ElementLink Existence (Post-Insert)",
            "errorMessage": "unexpected at least one wall needed",
            "recovery": "Erases instance and stops execution."
          },
          {
            "check": "ElementLog Validity (Post-Insert)",
            "errorMessage": "ElementLog is needed",
            "recovery": "Erases instance and stops execution."
          },
          {
            "check": "Format String Content",
            "errorMessage": "None (Silent internal check)",
            "recovery": "Automatically resets 'Format' property to 'D @(Diameter)' and recalculates the script."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Resize Drill",
            "how": "Edit 'Diameter' property in OPM",
            "effect": "Updates the radius of the drill operation and the text label."
          },
          {
            "action": "Reposition Drill (Height)",
            "how": "Drag _PtG[0] or _PtG[1] grips OR edit 'Start Height'/'End Height' in OPM",
            "effect": "Modifies the vertical start/end points of the drill. Updates properties bi-directionally."
          },
          {
            "action": "Move Drill Location",
            "how": "Drag _Pt0 grip",
            "effect": "Moves the drill hole laterally along the wall X-axis. Moves the label text accordingly."
          },
          {
            "action": "Change Label Content",
            "how": "Edit 'Format' property string in OPM",
            "effect": "Updates the text displayed in the model (e.g., showing Diameter vs. coordDim)."
          },
          {
            "action": "Change Label Style",
            "how": "Edit 'DimStyle' property in OPM",
            "effect": "Changes the font, size, and color of the annotation text."
          }
        ]
      },
      "tokens_used": 9939,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbLogVerticalDrill.mcr\n\n## Overview\nThis script inserts a vertical drilling operation into Log walls (ElementLog) and automatically generates a dimension label. It is designed for creating utility holes or mechanical fasteners in timber log construction with precise annotations.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be inserted and executed in Model Space. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | This is a 3D model modification script, not a 2D detailing tool. |\n\n## Prerequisites\n- **Required Entities**: An existing `ElementLog` (Log Wall) in the drawing.\n- **Minimum Beams**: None (Script interacts directly with the Log Element).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT` (or select from hsbCAD Catalog)\n**Action**: Browse and select `hsbLogVerticalDrill.mcr`.\n\n### Step 2: Select ElementLog\n**Command Line**: `Select ElementLog`\n**Action**: Click on the Log wall element where you want to place the drill.\n\n### Step 3: Select Point for Drill\n**Command Line**: `Select point for drill`\n**Action**: Click on the face of the log wall to define the lateral (X/Y) position of the hole.\n\n### Step 4: Configure Properties (If applicable)\n**Action**: If you are not using a pre-configured catalog entry, a properties dialog will appear.\n- Adjust the **Diameter**.\n- Set **Start Height** and **End Height** (0 = through the entire log layer).\n- Configure the **Format** string for the label.\n- Click **OK** to generate the drill and label.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Diameter | Number | 50 | The diameter of the vertical drill hole (in mm). |\n| Axis Offset | Number | 0 | The vertical elevation offset of the drilling axis relative to the element origin. |\n| Start Height | Number | 0 | The start depth of the hole relative to the bottom of the specific log layer (0 = bottom). |\n| End Height | Number | 0 | The end depth of the hole relative to the bottom of the specific log layer (0 = top). |\n| Format | Text | coordDim\\\\P@(coordDim) | The text template for the label. Attributes like @(Diameter) can be used. Separate lines with `\\P`. |\n| DimStyle | Dropdown | Current | The dimension style controlling font, size, and color of the label. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *(None)* | No custom context menu items are provided. Use the Properties Palette or Grips to edit. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: No external settings files are required for this script.\n\n## Tips\n- **Grip Editing**: After insertion, use the triangle grips (`_PtG[0]`, `_PtG[1]`) to visually drag the start and end points of the drill. This automatically updates the Start Height and End Height properties.\n- **Through Drilling**: To drill completely through a specific log layer, leave both **Start Height** and **End Height** as `0`.\n- **Label Formatting**: If the label text appears empty or incorrect, check the **Format** property. Ensure you are using valid attribute keys (e.g., `@(Diameter)`).\n- **Moving the Hole**: Drag the main insertion point (`_Pt0`) to move the entire drill and label laterally along the wall.\n\n## FAQ\n- **Q: Can I use this on standard beams?**\n  **A:** No, this script is specifically designed for `ElementLog` (Log Wall) entities.\n- **Q: How do I make the hole go deeper than one log?**\n  **A:** This script operates on the specific log layer selected. If you need a hole through multiple logs, you must insert the script on each relevant log layer or adjust the Axis Offset significantly if the geometry allows.\n- **Q: Why did my text label disappear?**\n  **A:** The **Format** property might contain invalid syntax or resolve to an empty string. Reset it to the default: `coordDim\\P@(coordDim)`.\n- **Q: How do I change the label size?**\n  **A:** Change the **DimStyle** property to a different dimension style defined in your AutoCAD drawing, or modify the text height in the selected DimStyle."
      },
      "tokens_used": 6610,
      "error": null
    }
  }
}