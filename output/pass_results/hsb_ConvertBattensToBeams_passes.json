{
  "filename": "hsb_ConvertBattensToBeams.mcr",
  "status": "completed",
  "total_tokens": 41227,
  "processing_time": 214.78680205345154,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": null,\n  \"versionHistory\": [\n    {\n      \"version\": \"1.0\",\n      \"date\": \"12.06.2009\",\n      \"author\": \"Alberto Jena (aj@hsb-cad.com)\",\n      \"changes\": \"Release Version\"\n    },\n    {\n      \"version\": \"1.1\",\n      \"date\": \"12.08.2009\",\n      \"author\": \"\",\n      \"changes\": \"Offset the horizontal battens 5mm on openings Fix the interference of vertical batens above and bellow the openings with the horizontal ones.\"\n    },\n    {\n      \"version\": \"1.1\",\n      \"date\": \"12.01.2011\",\n      \"author\": \"\",\n      \"changes\": \"Offset the horizontal battens 5mm on openings\"\n    },\n    {\n      \"version\": \"1.3\",\n      \"date\": \"22.03.2011\",\n      \"author\": \"\",\n      \"changes\": \"Bugfix\"\n    },\n    {\n      \"version\": \"1.5\",\n      \"date\": \"23.03.2011\",\n      \"author\": \"\",\n      \"changes\": \"Change beam type to _kLath\"\n    },\n    {\n      \"version\": \"1.6\",\n      \"date\": \"24.07.2012\",\n      \"author\": \"\",\n      \"changes\": \"Analize beam"
      },
      "tokens_used": 7016,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses PrEntity to prompt selection of Element objects. Utilizes _Element array to process 3D construction data. Accesses Element zones and sheets (el.sheet(nZone)) and creates Beam entities (bm.dbCreate) directly in the model database. No ShopDrawing (sd_) prefixes, #Type E, or _Viewport usage found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing hsbCAD Elements with Sheets defined in the target zone",
          "requiredSettings": []
        }
      },
      "tokens_used": 5212,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "\nSelect a set of elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZones",
            "type": "PropInt",
            "displayName": "Zone to Convert the Battens",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dDist",
            "type": "PropDouble",
            "displayName": "Size to cut the Top of the Battens",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sAlignHeightToZ",
            "type": "PropString",
            "displayName": "Align height to Z of the element",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sOverwrite",
            "type": "PropString",
            "displayName": "Overwrite zone material",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": "Beam Properties",
            "description": null
          },
          {
            "index": 0,
            "variable": "sName",
            "type": "PropString",
            "displayName": "Beam Name",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam Properties",
            "description": "Set the name of the battens"
          },
          {
            "index": 1,
            "variable": "sMaterial",
            "type": "PropString",
            "displayName": "Beam Material",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam Properties",
            "description": "Set the material of the battens"
          },
          {
            "index": 2,
            "variable": "sGrade",
            "type": "PropString",
            "displayName": "Beam Grade",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam Properties",
            "description": "Set the grade of the battens"
          },
          {
            "index": 3,
            "variable": "sBeamCode",
            "type": "PropString",
            "displayName": "Beam Code",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Beam Properties",
            "description": "Set the Beam Code"
          },
          {
            "index": 1,
            "variable": "nColor",
            "type": "PropInt",
            "displayName": "Beam Color",
            "defaultValue": -1,
            "inputType": "number",
            "options": [],
            "category": "Beam Properties",
            "description": "Set the color of the battens, (-1) will keep the existing color"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5719,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Converts parametric sheet-based battens into solid structural Beam entities for production, applying specific material properties, orientation adjustments, and top cuts.",
          "category": "Framing/Element Processing",
          "typicalUseCase": "Converting wall skin or roof sheathing battens (modeled as sheets for layout flexibility) into physical timber beams for CNC manufacturing and BOM export."
        },
        "parameters": [
          {
            "name": "nZones",
            "technicalDefault": 0,
            "businessMeaning": "Selects the specific construction zone (layer) within the element that contains the sheets to be converted.",
            "validRange": "1-10",
            "unit": "Index",
            "affectsOutput": "Determines which subset of sheets are processed; sheets in other zones remain unchanged."
          },
          {
            "name": "dDist",
            "technicalDefault": 0,
            "businessMeaning": "Sets a trimming distance from the top-most edge of the battens downwards to create a horizontal cut.",
            "validRange": "0 to 200 mm",
            "unit": "mm",
            "affectsOutput": "Adds a static cut operation to the top of the generated beams. If the cut distance exceeds the beam length, the beam is deleted."
          },
          {
            "name": "sAlignHeightToZ",
            "technicalDefault": "No",
            "businessMeaning": "Forces the beam's 'Height' dimension to be perpendicular to the element's Z-axis (horizontal for vertical walls), effectively rotating standing studs into flat laths.",
            "validRange": "No/Yes",
            "unit": "Enum",
            "affectsOutput": "Rotates the beam coordinate system 90 degrees around its length axis if the beam height is currently vertical."
          },
          {
            "name": "sOverwrite",
            "technicalDefault": "Yes",
            "businessMeaning": "Controls whether to apply the script's defined material properties to the new beams or inherit properties from the original sheets.",
            "validRange": "No/Yes",
            "unit": "Enum",
            "affectsOutput": "If 'No', material/grade/name come from the source sheet. If 'Yes', the explicit script properties are applied."
          },
          {
            "name": "sName",
            "technicalDefault": "",
            "businessMeaning": "Assigns a specific name to the resulting beams (used in lists and labels).",
            "validRange": "Text String",
            "unit": "String",
            "affectsOutput": "Sets the beam entity name property."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "",
            "businessMeaning": "Specifies the timber material species/type (e.g., C24, Spruce) for the battens.",
            "validRange": "Catalog Material Names",
            "unit": "String",
            "affectsOutput": "Sets the beam material property for BOM and machining."
          },
          {
            "name": "sGrade",
            "technicalDefault": "",
            "businessMeaning": "Specifies the structural strength grade of the timber.",
            "validRange": "Catalog Grade Names",
            "unit": "String",
            "affectsOutput": "Sets the beam grade property."
          },
          {
            "name": "sBeamCode",
            "technicalDefault": "",
            "businessMeaning": "Defines the production code or classification used for CNC exports and sorting.",
            "validRange": "String (no semicolons)",
            "unit": "String",
            "affectsOutput": "Appends to or replaces the beam code property."
          },
          {
            "name": "nColor",
            "technicalDefault": -1,
            "businessMeaning": "Sets the display color of the beams in the CAD model.",
            "validRange": "Autodesk Color Index (0-255) or -1",
            "unit": "Index",
            "affectsOutput": "Visual representation in ModelSpace. -1 preserves the original sheet's color."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sOverwrite set to 'No'",
            "effect": "Explicit script properties are ignored, values are inherited from source Sheet.",
            "cascade": [
              "sMaterial",
              "sGrade"
            ]
          },
          {
            "trigger": "dDist",
            "effect": "Can delete beams if the cut distance is greater than the remaining length.",
            "cascade": [
              "Entity Existence"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Structural timber battens created from the geometry of the original sheets. Assigned type _kBatten.",
            "appliedTo": "Selected Elements in the specified Zone."
          },
          {
            "type": "Cut",
            "description": "A horizontal saw cut applied at a specific distance from the top of the batten.",
            "appliedTo": "Generated Beams (if dDist > 0)."
          }
        ]
      },
      "tokens_used": 7949,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch",
          "Set internal variables from OPM properties (Zone, Distance, Alignment, Material properties)",
          "Check execution flag: Is this the initial insert (_bOnInsert)?",
          "[Insert Flow] Validate if insertCycleCount > 1 (prevent recursive execution)",
          "[Insert Flow] Show configuration dialog if not already executed from catalog",
          "[Insert Flow] Prompt user to select Elements (PrEntity)",
          "[Insert Flow] Store selected Elements in _Element array",
          "[Insert Flow] Exit script (wait for recalculation trigger)",
          "[Processing Flow] Check if _Element array is populated",
          "[Processing Flow] Iterate through each selected Element",
          "Retrieve Element coordinate system and target Zone data",
          "Collect all Sheets from the specified Zone",
          "Initialize arrays for new Beams and cut operations",
          "For each Sheet in Zone:",
          "Generate Beam geometry from Sheet realBody",
          "Set Beam Type to _kBatten",
          "Apply Property Mapping (Name, Color, Beam Code, Material/Grade depending on Overwrite flag)",
          "Assign Beam to Element Group in same Zone",
          "Check if Beam Length <= dDist (Cut distance)",
          "[Short Beam] Erase beam if too short to cut",
          "[Valid Beam] Add to checking list for cutting",
          "Erase original Sheet entities",
          "Iterate through all generated Beams for orientation analysis",
          "Check Beam dimensions (Width vs Height)",
          "[Width > Height] Rotate Beam CS 90 deg around X-axis and swap dimensions",
          "Check 'Align Height to Z' property",
          "[Align Enabled & Height is vertical to Element Z] Rotate Beam CS 90 deg to make height horizontal",
          "Calculate Top Point of all beams to determine Cut Plane position",
          "Offset Cut Plane by dDist distance (negative Y direction of Element)",
          "Create Cut Body and filter beams intersecting the cut plane",
          "Apply Static Cut tool to filtered beams",
          "Erase Script Instance"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution Phase (Insert vs. Recalc)",
            "path1": {
              "name": "Initial Insert",
              "steps": [
                "Check insertCycleCount",
                "Show Dialog (if needed)",
                "Prompt Element Selection",
                "Store Elements",
                "Return"
              ]
            },
            "path2": {
              "name": "Processing (Recalculation)",
              "steps": [
                "Validate Element array",
                "Loop through elements and zones",
                "Process Sheets to Beams",
                "Apply orientation logic",
                "Apply cuts",
                "Erase instance"
              ]
            }
          },
          {
            "condition": "Material Overwrite Setting (sOverwrite)",
            "path1": {
              "name": "Yes (Overwrite)",
              "steps": [
                "Apply script-defined Material",
                "Apply script-defined Grade"
              ]
            },
            "path2": {
              "name": "No (Inherit)",
              "steps": [
                "Retain original Sheet Material",
                "Retain original Sheet Grade"
              ]
            }
          },
          {
            "condition": "Beam Length vs Cut Distance (dDist)",
            "path1": {
              "name": "Length <= dDist",
              "steps": [
                "Beam is marked as too short",
                "Beam is immediately erased (dbErase)"
              ]
            },
            "path2": {
              "name": "Length > dDist",
              "steps": [
                "Beam added to 'ToCheck' array",
                "Beam undergoes orientation correction",
                "Beam checked for top cut intersection"
              ]
            }
          },
          {
            "condition": "Beam Orientation (Width vs Height)",
            "path1": {
              "name": "Width > Height",
              "steps": [
                "Rotate CS 90 deg around X",
                "Swap Width and Height values"
              ]
            },
            "path2": {
              "name": "Height >= Width",
              "steps": [
                "Keep current orientation",
                "Proceed to next check"
              ]
            }
          },
          {
            "condition": "Align Height to Z (sAlignHeightToZ)",
            "path1": {
              "name": "Enabled & Height Parallel to Element Z",
              "steps": [
                "Rotate CS 90 deg to flatten beam",
                "Swap dimensions to maintain geometry"
              ]
            },
            "path2": {
              "name": "Disabled or Already Aligned",
              "steps": [
                "Skip alignment rotation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "(Implicit) No action taken if selection is empty or cancelled.",
            "recovery": "User must select valid Elements and restart script."
          },
          {
            "check": "Beam Code Syntax",
            "errorMessage": "Beam Code set by Convert Battens to beam TSL is not valid",
            "recovery": "Remove semicolons from the sBeamCode property in the Properties Palette."
          },
          {
            "check": "Beam Length against Cut Distance",
            "errorMessage": "(Silent failure) Beam disappears.",
            "recovery": "Increase Beam length or reduce dDist (Size to cut Top)."
          },
          {
            "check": "Element Validity",
            "errorMessage": "(Implicit) Script skips invalid element references.",
            "recovery": "Ensure selected Elements exist in the drawing database."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Zone (nZones)",
            "how": "OPM (Properties Palette)",
            "effect": "Re-running script targets a different construction layer of the selected elements."
          },
          {
            "action": "Adjust Top Cut (dDist)",
            "how": "OPM",
            "effect": "Changes the distance of the horizontal cut from the top of the battens."
          },
          {
            "action": "Toggle Alignment (sAlignHeightToZ)",
            "how": "OPM",
            "effect": "Switches battens between 'standing' (height vertical to element) and 'flat' (height horizontal to element) orientation relative to the Element's Z-axis."
          },
          {
            "action": "Update Properties (Name, Material, Code)",
            "how": "OPM",
            "effect": "Updates metadata on generated beams (requires Overwrite flag check)."
          }
        ]
      },
      "tokens_used": 8295,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_ConvertBattensToBeams.mcr\n\n## Overview\nThis script converts sheet-based battens (often used for layout or modeling) into solid structural Beam entities for manufacturing. It applies specific material properties, color coding, and horizontal top cuts to the new beams based on user settings.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D hsbCAD Elements. |\n| Paper Space | No | |\n| Shop Drawing | No | This script does not generate 2D views directly. |\n\n## Prerequisites\n- **Required Entities**: hsbCAD Elements containing Sheets in the specific zones you wish to process.\n- **Minimum Beam Count**: 0 (This script creates beams from sheets, not vice versa).\n- **Required Settings**: None specific, but material catalogs must be available if assigning specific grades/materials.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsb_ConvertBattensToBeams.mcr` from the file dialog.\n\n### Step 2: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on the hsbCAD Element(s) in the model that contain the sheets you want to convert. Press Enter to confirm selection.\n```\n\n### Step 3: Configure Properties\nAfter selection, the script instance is created. Select the script instance in the drawing and open the **Properties Palette** (Ctrl+1). Adjust parameters such as the target Zone, Top Cut distance, and Material properties.\n\n### Step 4: Execute Conversion\nTrigger the script calculation by changing any parameter value in the Properties Palette or using the standard hsbCAD Recalculate command. The sheets will be converted to beams, and the original sheets will be erased.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Zone to Convert the Battens | dropdown | 0 | Select the construction zone (1-10) containing the sheets to convert. |\n| Size to cut the Top of the Battens | number | 0 | Distance (mm) from the top of the batten to apply a horizontal saw cut. |\n| Align height to Z of the element | dropdown | No | If \"Yes\", rotates the batten so its height is horizontal relative to the element's Z-axis (laying flat vs. standing). |\n| Overwrite zone material | dropdown | Yes | If \"Yes\", applies the script's material settings; if \"No\", keeps the original sheet properties. |\n| Beam Name | text | [Empty] | Assigns a specific name to the generated battens. |\n| Beam Material | text | [Empty] | Sets the timber material species (e.g., C24). |\n| Beam Grade | text | [Empty] | Sets the structural strength grade. |\n| Beam Code | text | [Empty] | Sets the production code used for CNC/export. **Note:** Semicolons are not allowed. |\n| Beam Color | number | -1 | Sets the Autodesk color index (0-255). Use -1 to keep the original sheet color. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No specific custom context menu items are defined for this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on Properties Palette inputs and does not use external XML settings files.\n\n## Tips\n- **Disappearing Beams**: If your beams disappear after running the script, check the **Size to cut the Top of the Battens** parameter. If this value is greater than the length of the batten, the script deletes the beam because it is too short.\n- **Material Updates**: If your material or grade settings are not applying to the new beams, ensure **Overwrite zone material** is set to \"Yes\".\n- **Orientation**: Use the **Align height to Z** property to toggle between vertical studs (standing) and horizontal laths (flat) orientation automatically.\n\n## FAQ\n- **Q: Why did I get an error \"Beam Code set by Convert Battens to beam TSL is not valid\"?**\n  **A:** You likely used a semicolon (;) in the **Beam Code** property. Remove the semicolon and try again.\n- **Q: Can I undo this operation?**\n  **A:** Yes, use the standard AutoCAD `UNDO` command to revert the conversion and restore the original sheets.\n- **Q: What happens to the original sheets?**\n  **A:** The script deletes the original sheets after successfully creating the beams. Ensure you have a backup if you need to retain the sheet geometry."
      },
      "tokens_used": 7036,
      "error": null
    }
  }
}