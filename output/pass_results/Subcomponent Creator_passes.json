{
  "filename": "Subcomponent Creator.mcr",
  "status": "completed",
  "total_tokens": 26966,
  "processing_time": 249.09206771850586,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 5968,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No ShopDrawing prefixes (sd_*) or Paper Space entities (_Viewport) found. The script interacts directly with Beam entities in the 3D model using geometric properties like envelopeBody(), ptCenSolid(), and vectors. Visualization is handled via Display dp drawing to the workplane or world coordinates, indicating a Model Space context."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 2305,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select beam(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Insertion (_bOnInsert)",
            "title": null,
            "dataSource": "Property Collection",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "subcomponentName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "|Unknown|",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "|Sets the name of the subcomponent|."
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 3125,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a logical 'Subcomponent' grouping by assigning a shared Name and ID to a set of touching, aligned beams. It validates that the beams form a contiguous physical assembly.",
          "category": "Data Management",
          "typicalUseCase": "Grouping a set of studs or columns that form a single transportable assembly (e.g., a curved wall segment or a girder assembly) to assign a unified production name."
        },
        "parameters": [
          {
            "name": "subcomponentName",
            "technicalDefault": "Unknown",
            "businessMeaning": "The production name or label for the assembly (e.g., 'Wall-Segment-A', 'Truss-Left').",
            "validRange": "Any string describing the assembly.",
            "unit": "string",
            "affectsOutput": "Sets the 'Name' field in the Hsb_SubcomponentData map attached to the beams and updates the text label in the model."
          },
          {
            "name": "vectorTolerance",
            "technicalDefault": "0.01 mm",
            "businessMeaning": "The allowable deviation for beam alignment. If beams deviate more than this from being parallel, they are rejected.",
            "validRange": "0.01 mm to 5.0 mm",
            "unit": "mm",
            "affectsOutput": "Controls the strictness of the 'beams are aligned' validation check. Prevents creation of the subcomponent if exceeded."
          },
          {
            "name": "textColour",
            "technicalDefault": "3",
            "businessMeaning": "The display color of the subcomponent label and outline in the model.",
            "validRange": "0-255 (AutoCAD Color Index)",
            "unit": "ACI",
            "affectsOutput": "Visual representation in Model Space."
          },
          {
            "name": "textSize",
            "technicalDefault": "50",
            "businessMeaning": "The height of the text label drawn to identify the subcomponent.",
            "validRange": "20 mm to 200 mm (depending on model scale)",
            "unit": "mm",
            "affectsOutput": "Changes the size of the name text and recalculates the position of the bounding box outline."
          },
          {
            "name": "shrinkSize",
            "technicalDefault": "5",
            "businessMeaning": "The amount to trim the visual 'shadow' of the beams so the overlay sits neatly inside/around them.",
            "validRange": "0 mm to 20 mm",
            "unit": "mm",
            "affectsOutput": "Alters the visual footprint polygon drawn by the script."
          },
          {
            "name": "transparencyPercent",
            "technicalDefault": "50",
            "businessMeaning": "The opacity of the filled area indicating the subcomponent extent.",
            "validRange": "0 (opaque) to 90 (transparent)",
            "unit": "percent",
            "affectsOutput": "Visual overlay appearance."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selected Beams",
            "effect": "Must be touching and aligned (within vectorTolerance) to proceed.",
            "cascade": [
              "subcomponentName",
              "subcomponentId",
              "visual geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Attribute Data (SubMapX)",
            "description": "Writes 'Hsb_SubcomponentData' (containing Name and a GUID) to the entity properties of the selected beams.",
            "appliedTo": "Selected GenBeams"
          },
          {
            "type": "Visual Representation",
            "description": "Draws a filled polygon (shadow) and a text label at the assembly centroid to visualize the group.",
            "appliedTo": "Model Space (non-physical)"
          }
        ]
      },
      "tokens_used": 4156,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User inserts script 'Subcomponent Creator'.",
          "2. Script opens Properties Dialog (OPM) for user to input 'Name'.",
          "3. Command line prompts user to 'Select beam(s)'.",
          "4. User selects one or more beams and confirms (Enter/Space).",
          "5. Script iterates through selection to check if all beams are parallel (aligned).",
          "6. [Conditional Branch] Alignment Check: If not parallel, script warns and erases itself.",
          "7. If aligned, script checks connectivity (beams physically touching).",
          "8. [Conditional Branch] Connectivity Check: If not touching or forming multiple groups, script warns and erases itself.",
          "9. If connected, script generates a unique GUID for the subcomponent.",
          "10. Script calculates the combined bounding volume and 2D shadow profile.",
          "11. Script draws the visual representation (Polygon outline and Name label).",
          "12. Script writes 'Hsb_SubcomponentData' (Name + GUID) to the SubMap of each beam."
        ],
        "conditionalBranches": [
          {
            "condition": "Are selected beams aligned (parallel)?",
            "path1": {
              "name": "Not Aligned",
              "steps": [
                "Calculate vector dot products against first beam.",
                "Detect deviation > vectorTolerance (0.01mm).",
                "Display Warning: 'The selected beams are not aligned.'",
                "Erase Instance (Script terminates)."
              ]
            },
            "path2": {
              "name": "Aligned",
              "steps": [
                "Proceed to Connectivity check."
              ]
            }
          },
          {
            "condition": "Do selected beams form a single contiguous group (touching)?",
            "path1": {
              "name": "Disconnected / Multiple Groups",
              "steps": [
                "Detect intersections using 'blown up' envelope bodies.",
                "Find zero or >1 connected components.",
                "Display Warning: 'The selected beams are not touching each other.'",
                "Erase Instance (Script terminates)."
              ]
            },
            "path2": {
              "name": "Contiguous",
              "steps": [
                "Merge bodies into single subcomponent volume.",
                "Generate Visuals and Attribute Data."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Beam Alignment (Parallelism)",
            "errorMessage": "|The subcomponent definition could not be created| |The selected beams are not aligned.|",
            "recovery": "Ensure all selected beams have their X-axes (length) running in the same direction. Re-insert the script."
          },
          {
            "check": "Physical Connectivity (Touching)",
            "errorMessage": "|The subcomponent definition could not be created| |The selected beams are not touching each other.|",
            "recovery": "Ensure beams form a single physical assembly (end-to-end or side-by-side contact). Re-insert the script."
          },
          {
            "check": "Entity Type",
            "errorMessage": "Implicit via PrEntity filter",
            "recovery": "User must select valid Beam entities."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Subcomponent Name",
            "how": "OPM (Object Properties Manager)",
            "effect": "Updates the Text Label in the model and the 'Name' field inside the 'Hsb_SubcomponentData' map on all linked beams."
          },
          {
            "action": "Update Visual Style",
            "how": "OPM (Change textColour, textSize, transparencyPercent, shrinkSize)",
            "effect": "Immediately redraws the polygon and text overlay in the model. Does not affect beam data."
          },
          {
            "action": "Move/Modify Beams",
            "how": "Grip Edit / Standard CAD Modify commands",
            "effect": "Triggers script recalculation. If beams are no longer touching, the script will delete itself (eraseInstance) and throw an error, effectively breaking the subcomponent link."
          }
        ]
      },
      "tokens_used": 6487,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Subcomponent Creator\n\n## Overview\nCreates a logical production grouping by assigning a shared Name and unique ID to a set of touching, aligned beams. It validates that selected beams form a single, contiguous physical assembly and visualizes the group with a bounding box and label.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in the 3D model to validate beam geometry and write attributes. |\n| Paper Space | No | Not supported for 2D layouts. |\n| Shop Drawing | No | Does not generate detailing views. |\n\n## Prerequisites\n- **Required Entities:** GenBeams (standard timber beams).\n- **Minimum Beam Count:** 1 or more (practically used for groups).\n- **Required Settings:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `Subcomponent Creator.mcr`\n\n### Step 2: Configure Properties\n```\nAction: The Properties Palette (OPM) opens automatically.\nTask: Enter a descriptive Name for the subcomponent (e.g., \"Wall-Segment-A\").\nOptional: Adjust visual settings like text size or color.\n```\n\n### Step 3: Select Beams\n```\nCommand Line: |Select beam(s)|\nAction: Click on the beams that form the assembly.\nConfirmation: Press Enter or Space to finish selection.\n```\n**Note:** The script will automatically verify if the beams are parallel and physically touching.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Name | Text | Unknown | The production name or label assigned to the assembly (e.g., 'Truss-Left'). This is written to the beam data. |\n| textColour | Number | 3 | The display color of the label and outline (0-255 AutoCAD Color Index). |\n| textSize | Number | 50 mm | The height of the text label in the model. |\n| shrinkSize | Number | 5 mm | The amount to trim the visual outline so it sits neatly inside the beam profile. |\n| transparencyPercent | Number | 50 % | The opacity of the filled polygon (0 = Opaque, 90 = Transparent). |\n| vectorTolerance | Number | 0.01 mm | The allowable deviation for beam alignment. If beams deviate more than this from being perfectly parallel, the script will fail. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add specific options to the right-click context menu. Edit properties via the Properties Palette. |\n\n## Settings Files\n- **Filename:** None\n- **Location:** N/A\n- **Purpose:** N/A\n\n## Tips\n- **Alignment Check:** Ensure all selected beams are running in the same direction (parallel). If beams are perpendicular or skewed, the script will abort and delete itself.\n- **Connectivity:** Beams must be physically touching (end-to-end or side-by-side). Small gaps will cause the script to fail.\n- **Dynamic Updates:** You can change the \"Name\" property at any time via the Properties Palette to update the label and data on the beams.\n- **Modifying Geometry:** If you move or stretch the beams such that they no longer touch or align, the script instance will automatically delete itself to prevent invalid data.\n\n## FAQ\n- **Q: Why did the script disappear immediately after I selected the beams?**\n  **A:** The validation checks failed. This usually happens because the selected beams were not perfectly parallel (within `vectorTolerance`) or were not physically touching each other.\n- **Q: Can I group beams that are just close to each other but not touching?**\n  **A:** No, this script requires physical contact. Use gaps or overlap scripts for non-touching assemblies.\n- **Q: Where is the data stored?**\n  **A:** The script writes the Name and a unique ID into the `Hsb_SubcomponentData` map attached to each selected beam. This data can be used in lists or labels.\n- **Q: How do I change the text size later?**\n  **A:** Select the subcomponent (the text or outline in the model), open the Properties Palette, and modify the `textSize` value. The visual will update immediately."
      },
      "tokens_used": 4925,
      "error": null
    }
  }
}