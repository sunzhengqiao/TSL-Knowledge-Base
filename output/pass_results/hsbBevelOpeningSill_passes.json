{
  "filename": "hsbBevelOpeningSill.mcr",
  "status": "completed",
  "total_tokens": 42214,
  "processing_time": 164.78903031349182,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.4",
            "date": "09dec21",
            "author": "nils.gregor@hsbcad.com",
            "changes": "HSB-13520 Bugfix search target beam in horizontal and vertical beams "
          },
          {
            "version": "1.3",
            "date": "17nov21",
            "author": "nils.gregor@hsbcad.com",
            "changes": " HSB-13520  Fixed rotation of the coordinate system. "
          },
          {
            "version": "1.2",
            "date": "15nov21",
            "author": "nils.gregor@hsbcad.com",
            "changes": " HSB-13520  Adjustments in description. "
          },
          {
            "version": "1.1",
            "date": "08nov21",
            "author": "nils.gregor@hsbcad.com",
            "changes": "HSB-13520  Adjustment of position an behavior"
          },
          {
            "version": "1.0",
            "date": "04nov21",
            "author": "nils.gregor@hsbcad.com",
            "changes": "HSB-13520 initial "
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7754,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit usage of `_kModelSpace` in `tslNew.dbCreate` calls. The script manipulates 3D construction entities like `Beam` and `Sheet` using `BeamCut` and `Cut` tools. There is no usage of `_Viewport`, `sd_` prefixes, or shopdrawing specific logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "Opening",
            "Element",
            "Beam",
            "Sheet"
          ],
          "minimumBeams": 1,
          "requiredSpace": "3D Model Space within an hsbCAD element containing an opening.",
          "requiredSettings": []
        }
      },
      "tokens_used": 6315,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert && _kExecuteKey.length()==0",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "Select openings",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Catalog/Properties Dialog",
            "trigger": "On insert (if no execute key) or via Properties Palette",
            "title": null,
            "dataSource": "Internal properties or Catalog",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "dAngle",
            "type": "PropDouble",
            "displayName": "Angle",
            "defaultValue": 5.0,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the angle of the sill or sole plate milling."
          },
          {
            "index": 1,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "Depth",
            "defaultValue": 102.0,
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the starting point of the milling in element Z-direction. If the value is 0, the depth is taken from the packers."
          },
          {
            "index": 0,
            "variable": "sPackersAreSheets",
            "type": "PropString",
            "displayName": "Packers are sheets",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": "General",
            "description": "Select if packers are of type beam or sheet."
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6350,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a beveled (angled) mill on the sill plate of a wall opening and stretches/cuts associated packers to match this angle.",
          "category": "Framing/Machining",
          "typicalUseCase": "When a window or door opening in a timber frame wall requires a sloped sill to shed water, rather than a flat horizontal surface."
        },
        "parameters": [
          {
            "name": "dAngle",
            "technicalDefault": 5.0,
            "businessMeaning": "The slope angle of the sill bevel relative to the horizontal plane.",
            "validRange": "1.0 - 45.0",
            "unit": "degrees",
            "affectsOutput": "Rotates the cutting plane for the sill plate and the cutting plane for the packers. A positive value creates a downward slope towards the interior (or exterior depending on wall orientation)."
          },
          {
            "name": "dDepth",
            "technicalDefault": 102.0,
            "businessMeaning": "The vertical distance from the bottom of the opening down to where the bevel cut begins.",
            "validRange": "0.0 - 300.0",
            "unit": "mm",
            "affectsOutput": "Determines the starting Z-position of the bevel. If set to 0, the script attempts to detect packers (fillers) and starts the bevel at their top face. If non-zero, it forces the start depth explicitly."
          },
          {
            "name": "sPackersAreSheets",
            "technicalDefault": "No",
            "businessMeaning": "Specifies whether the filling materials (packers) between the opening studs and the main wall are constructed as Sheet elements (e.g., plywood/OSB) or standard Beams.",
            "validRange": "No, Yes",
            "unit": "enum",
            "affectsOutput": "Switches the logic for detecting and cutting the side materials. If 'Yes', it searches for Sheet entities; if 'No', it searches for Beam entities. It also enables geometry stretching logic specific to Sheets."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dDepth is set to 0",
            "effect": "The script ignores the explicit depth value and attempts to calculate the start height based on the detected height of 'packers' (side fillers). If no packers are found and Depth is 0, the script fails and deletes itself.",
            "cascade": []
          },
          {
            "trigger": "sPackersAreSheets is set to 'Yes'",
            "effect": "Enables a search for Sheet entities instead of Beams to determine the bevel start depth (if dDepth is 0) and selects them to be cut/stretched.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "BeamCut",
            "description": "A volumetric cut applied to the sill plate beam to create the angled slope.",
            "appliedTo": "The vertical beam located immediately below the opening (Sill plate)."
          },
          {
            "type": "Cut",
            "description": "A planar cut applied to side packers to match the new angle of the sill plate.",
            "appliedTo": "Beams or Sheets (packers) located horizontally to the left and right of the opening."
          },
          {
            "type": "Sheet Stretch",
            "description": "Modifies the geometry of sheet packers to extend their shape so they can be cut at the new angle.",
            "appliedTo": "Sheet entities identified as packers (if sPackersAreSheets is 'Yes')."
          }
        ]
      },
      "tokens_used": 7048,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch",
          "Check Insert Cycle: If >1, erase instance and exit",
          "Check Execute Key: If specific key provided, load catalog properties; else show Dialog",
          "Prompt User: Select opening(s) via PrEntity",
          "Instance Creation: For each selected opening, create a new TSL instance with current properties (dAngle, dDepth, sPackersAreSheets)",
          "Erase 'Launcher' Instance",
          "New Instance Initialization",
          "Map IO Check: If property map exists, load values from map, show dialog, save map, and exit",
          "Entity Attachment Check: Verify if instance is attached to an Opening or Element",
          "Element Branch: If attached to an Element with >1 opening, spawn individual instances for each opening and erase parent",
          "Validation: Check if valid Opening reference exists. If not, report error and erase",
          "Geometry Calculation: Determine Opening center and Coordinate Systems",
          "Find Sill Plate: Identify vertical beams below the opening to select the sill beam",
          "Determine Milling Bounds: Scan horizontally from center to find studs or packers to determine start/end X-points",
          "Packer Detection: If 'Packers are sheets' is Yes, search for sheets within opening width to find height reference",
          "Calculate Depth: Determine cut start height based on 'Depth' property or detected packer height",
          "Validation: Ensure depth is valid (>0) or packers were found if Depth=0",
          "Apply Tools: Create BeamCut for sill plate and Cut for side packers",
          "Sheet Stretching: If packers are sheets, modify profile geometry to ensure clean cut",
          "Completion: If not in Debug mode, erase instance"
        ],
        "conditionalBranches": [
          {
            "condition": "Execute Key provided on insert?",
            "path1": {
              "name": "Catalog Load",
              "steps": [
                "Search for catalog entry matching key",
                "Load properties from catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Input",
              "steps": [
                "Show Properties Dialog",
                "User inputs Angle, Depth, Packers type",
                "Continue with selection"
              ]
            }
          },
          {
            "condition": "Entity Attachment Type",
            "path1": {
              "name": "Attached to Opening",
              "steps": [
                "Cast entity to Opening object",
                "Proceed to calculation for this specific opening"
              ]
            },
            "path2": {
              "name": "Attached to Element",
              "steps": [
                "Cast entity to Element object",
                "If 0 openings: Erase",
                "If 1 opening: Proceed for that opening",
                "If >1 openings: Spawn new instances for each, erase current"
              ]
            }
          },
          {
            "condition": "Packer / Depth Calculation Logic",
            "path1": {
              "name": "Explicit Depth",
              "steps": [
                "Property 'Depth' is non-zero",
                "Use property value directly for vertical start position of cut"
              ]
            },
            "path2": {
              "name": "Auto Depth (Depth = 0)",
              "steps": [
                "Property 'Depth' is zero",
                "Search for horizontal packers (Beams or Sheets depending on property)",
                "Calculate Max Height of found packers",
                "If no packers found: Error and Erase",
                "Use Max Height as start position"
              ]
            }
          },
          {
            "condition": "Side Material Type (Sheets vs Beams)",
            "path1": {
              "name": "Sheets",
              "steps": [
                "Search Sheet entities within opening width",
                "Identify packers based on size and location",
                "Apply Cut",
                "Stretch Sheet profile geometry to match slope"
              ]
            },
            "path2": {
              "name": "Beams",
              "steps": [
                "Identify Beam packers (Beams shorter than wall width)",
                "Apply Cut",
                "No geometry stretching required"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid reference Opening or Element attached",
            "errorMessage": "could not find reference to element. Instance will be deleted.",
            "recovery": "Re-run script and select a valid opening or element"
          },
          {
            "check": "Sill plate beam found below opening",
            "errorMessage": "No beams to mill found. Instance will be deleted.",
            "recovery": "Ensure there is a vertical beam (plate) below the opening in the wall construction"
          },
          {
            "check": "Side boundaries (studs/packers) found to determine cut width",
            "errorMessage": "Could not detect opening posts. Instance will be deleted.",
            "recovery": "Ensure the opening has studs or material on both sides to define the cut area"
          },
          {
            "check": "Valid Depth (Depth > 0 OR Packers found when Depth = 0)",
            "errorMessage": "No packers were found and depth is set to 0. Plate can not be beveled",
            "recovery": "Increase the 'Depth' property value manually, or ensure packers exist in the model if Depth must be 0"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Parameters",
            "how": "Properties Palette (OPM)",
            "effect": "Changes 'Angle', 'Depth', or 'Packers are sheets'. Script recalculates geometry immediately."
          },
          {
            "action": "Move/Resize Opening",
            "how": "Grip edit / hsbCAD commands",
            "effect": "Script detects change (via _bOnElementConstructed or similar triggers), re-evaluates beam positions, and updates cuts."
          },
          {
            "action": "Change Wall Construction",
            "how": "Modify beams/sheets in Element",
            "effect": "If the sill beam or packers are modified/removed, the script updates the cut or errors out and deletes itself if critical geometry is missing."
          }
        ]
      },
      "tokens_used": 8853,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbBevelOpeningSill.mcr\n\n## Overview\nThis script automates the creation of a sloped (beveled) sill cut for window or door openings in timber frame walls. It simultaneously cuts or stretches the adjacent packers and sheathing to match the specified angle.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be run in the 3D model context. |\n| Paper Space | No | Not applicable for 2D drawings. |\n| Shop Drawing | No | Not intended for shop drawing generation. |\n\n## Prerequisites\n- **Required Entities**: An existing wall `Element` containing at least one `Opening` (Window or Door).\n- **Construction**:\n    - A vertical beam (Sill plate) located immediately below the opening.\n    - Side materials (studs or packers) defining the width of the opening.\n    - If using \"Depth = 0\", horizontal packers or sheets must exist below the opening to define the cut height.\n- **Minimum Beam Count**: 1 (the sill plate beam).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the AutoCAD command line.\n2.  Browse to and select `hsbBevelOpeningSill.mcr`.\n\n### Step 2: Configure Properties\nA dialog will appear (or you can set these later in the Properties Palette):\n1.  **Angle**: Set the desired slope for the sill (default is 5.0Â°).\n2.  **Depth**: Enter the vertical distance from the bottom of the opening to start the bevel (default is 102.0 mm).\n3.  **Packers are sheets**: Select \"Yes\" if your infill material is structural sheeting (e.g., plywood/OSB) or \"No\" if it is dimensional lumber/beams.\n\n### Step 3: Select Opening\n```\nCommand Line: Select openings\nAction: Click on the window or door opening in the model.\n```\n*Note: You can select multiple openings at once.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Angle | Number | 5.0 | Defines the slope of the sill bevel in degrees. |\n| Depth | Number | 102.0 | The vertical distance (mm) from the bottom of the opening where the bevel starts. If set to 0, the script calculates this based on the height of detected packers. |\n| Packers are sheets | Dropdown | No | Determines if the side materials are \"Sheets\" (e.g., OSB) or \"Beams\" (e.g., studs). This affects how the script detects and cuts the material. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No specific context menu options are added by this script. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Dynamic Updates**: After insertion, you can change the `Angle` or `Depth` directly in the AutoCAD Properties Palette (select the script instance). The cuts will update automatically.\n- **Depth Calculation**: If you are unsure of the exact depth measurement, set `Depth` to `0`. The script will look for the top of the packers below the window to determine where to start the cut.\n- **Multiple Openings**: If you select a main wall `Element` that contains multiple openings, the script will automatically create a separate instance for each opening.\n\n## FAQ\n- **Q: Why did the script delete itself immediately after running?**\n  **A**: The script performs validation checks. It will delete itself if it cannot find a valid sill beam below the opening, if it cannot detect side boundaries (studs/packers), or if `Depth` is 0 but no packers were found to calculate the height.\n- **Q: The side cut isn't matching my sill cut.**\n  **A**: Check the `Packers are sheets` property. If your wall uses sheet material (like plywood) on the sides but this is set to \"No\", the script might be looking for beams instead. Switch it to \"Yes\".\n- **Q: Can I use this on doors?**\n  **A**: Yes, as long as there is a beam below the opening (sill/threshold) to receive the bevel cut."
      },
      "tokens_used": 5894,
      "error": null
    }
  }
}