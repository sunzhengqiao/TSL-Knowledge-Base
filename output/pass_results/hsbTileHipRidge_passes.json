{
  "filename": "hsbTileHipRidge.mcr",
  "status": "completed",
  "total_tokens": 53249,
  "processing_time": 327.9902560710907,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 0,\n    \"minorVersion\": 0,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"This tsl creates instances per hip- and/or ridge line and computes the quantity of the required tiles. Pent and ridge connection tiles are created if required. Select at least two roofplane"
      },
      "tokens_used": 8989,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script directly manipulates ERoofPlane entities using 3D geometry (Z-offsets, PlaneProfile intersections) and creates HardWrComp objects for BOM calculation. It contains no 'sd_' prefixes, no '_Viewport' handling, and no ShopDrawing entity (#Type E) selection logic, indicating it is a 3D modeling and calculation script."
        },
        "prerequisites": {
          "requiredEntities": [
            "ERoofPlane"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Roofplanes must have valid 'Hsb_RoofTile' and 'RoofFamilyDefinition' submaps assigned.",
            "Access to RoofTilingManager.dll."
          ]
        }
      },
      "tokens_used": 6911,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select roofplane(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sRidgeTile",
            "type": "PropString",
            "displayName": "|Ridge/Hip Tile|",
            "defaultValue": "|No Tile|",
            "inputType": "dropdown",
            "options": [
              "|No Tile|",
              "|ByRoofplane|"
            ],
            "category": "|General|",
            "description": "|Specifies the ridge/hip tile|"
          },
          {
            "index": 1,
            "variable": "sStartTile",
            "type": "PropString",
            "displayName": "|Start Tile|",
            "defaultValue": "|No Tile|",
            "inputType": "dropdown",
            "options": [
              "|No Tile|"
            ],
            "category": "|Start Tile|",
            "description": "|Specifies the start tile|"
          },
          {
            "index": 0,
            "variable": "dStartOffset",
            "type": "PropDouble",
            "displayName": "|Offset|",
            "defaultValue": 0,
            "inputType": "number",
            "category": "|Start Tile|",
            "description": "|Defines the start offset of the ridge/ hip tiles|"
          },
          {
            "index": 2,
            "variable": "sEndTile",
            "type": "PropString",
            "displayName": "|End Tile|",
            "defaultValue": "|No Tile|",
            "inputType": "dropdown",
            "options": [
              "|No Tile|"
            ],
            "category": "|End Tile|",
            "description": "|Specifies the end tile|"
          },
          {
            "index": 1,
            "variable": "dEndOffset",
            "type": "PropDouble",
            "displayName": "|Offset| ",
            "defaultValue": 0,
            "inputType": "number",
            "category": "|End Tile|",
            "description": "|Defines the end offset of the ridge/ hip tiles|"
          },
          {
            "index": 3,
            "variable": "sOverwrite",
            "type": "PropString",
            "displayName": "|Replace Start/ End Tile|",
            "defaultValue": "|Don´t replace|",
            "inputType": "dropdown",
            "options": [
              "|Don´t replace|",
              "|Start Tile|",
              "|End Tile|"
            ],
            "category": "|Replace tile|",
            "description": "|Replace the start/ end tile with selected tile(s)|"
          },
          {
            "index": 4,
            "variable": "sAllTile",
            "type": "PropString",
            "displayName": "|1st Start/ End Tile|",
            "defaultValue": "|No Tile|",
            "inputType": "dropdown",
            "options": [
              "|No Tile|"
            ],
            "category": "|Replace tile|",
            "description": "|Used to replace the first start/ end tile|"
          },
          {
            "index": 5,
            "variable": "sAllTile2",
            "type": "PropString",
            "displayName": "|2nd Start/ End Tile|",
            "defaultValue": "|No Tile|",
            "inputType": "dropdown",
            "options": [
              "|No Tile|"
            ],
            "category": "|Replace tile|",
            "description": "|Used to add a second start/ end tile|"
          },
          {
            "index": 6,
            "variable": "sOffsetDir",
            "type": "PropString",
            "displayName": "|Offset direction|",
            "defaultValue": "|Parallel to edge|",
            "inputType": "dropdown",
            "options": [
              "|Parallel to edge|",
              "|Parallel to roofplane|"
            ],
            "category": "|Geometrie|",
            "description": "|Defines the direction of the offset|"
          },
          {
            "index": 2,
            "variable": "dRidgeOffset",
            "type": "PropDouble",
            "displayName": "|Z-Offset ridge|",
            "defaultValue": 80,
            "inputType": "number",
            "category": "|Geometrie|",
            "description": "|Defines the ridge offset|"
          },
          {
            "index": 3,
            "variable": "dHipOffset",
            "type": "PropDouble",
            "displayName": "|Z-Offset hip|",
            "defaultValue": 130,
            "inputType": "number",
            "category": "|Geometrie|",
            "description": "|Defines the hip offset|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "TslDoubleClick",
            "handler": "TslDoubleClick",
            "action": "String variable defined for double-click handling",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "RoofTilingManager.dll",
            "searchPaths": [
              "_kPathHsbInstall\\Utilities\\RoofTiles\\"
            ],
            "purpose": "External assembly used to retrieve tile definitions and data from the database.",
            "required": true
          }
        ]
      },
      "tokens_used": 8127,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the calculation and Bill of Materials (BOM) generation for ridge and hip roof tiles, including specialized start/end caps and intersection pieces, based on selected roof planes.",
          "category": "Hardware",
          "typicalUseCase": "Used during the detailed design or material takeoff phase to determine exactly how many ridge and hip tiles are needed for a roof, ensuring that roof transitions (hips, valleys, ridges) are properly covered according to manufacturer specifications."
        },
        "parameters": [
          {
            "name": "sRidgeTile",
            "technicalDefault": "\"|No Tile|\"",
            "businessMeaning": "Selects the primary catalog tile to be used along the ridge or hip line. It defines the standard tile type that covers the main length of the roof peak.",
            "validRange": "Specific Manufacturer Catalog Entries (Type 6), 'ByRoofplane', 'No Tile'",
            "unit": "String (Catalog Selection)",
            "affectsOutput": "Determines the ArticleNumber, dimensions, and material for the HardWrComp BOM entries. Controls the visual representation of the standard tiling run."
          },
          {
            "name": "sStartTile",
            "technicalDefault": "\"|No Tile|\"",
            "businessMeaning": "Specifies a specialized tile (e.g., a ridge starter or capped end) to be placed at the very beginning of the ridge/hip line.",
            "validRange": "Manufacturer Catalog Entries (Type 8 - Ridge Start), 'No Tile'",
            "unit": "String (Catalog Selection)",
            "affectsOutput": "Generates a specific hardware item at the start point and reduces the remaining length for standard tiles."
          },
          {
            "name": "dStartOffset",
            "technicalDefault": "0",
            "businessMeaning": "Defines a gap or offset distance from the exact start point of the roof geometry to where the tiling actually begins. Used to handle fascia spacing or overhangs.",
            "validRange": "0 mm to 1000 mm",
            "unit": "mm",
            "affectsOutput": "Shifts the start of the tiling pattern along the ridge vector, effectively shortening the tiled run."
          },
          {
            "name": "sEndTile",
            "technicalDefault": "\"|No Tile|\"",
            "businessMeaning": "Specifies a specialized tile (e.g., a ridge end or ventilator cap) to be placed at the very end of the ridge/hip line.",
            "validRange": "Manufacturer Catalog Entries (Type 9 - Ridge End), 'No Tile'",
            "unit": "String (Catalog Selection)",
            "affectsOutput": "Generates a specific hardware item at the end point and reduces the remaining length for standard tiles."
          },
          {
            "name": "dEndOffset",
            "technicalDefault": "0",
            "businessMeaning": "Defines a gap or offset distance from the exact end point of the roof geometry to where the tiling actually ends.",
            "validRange": "0 mm to 1000 mm",
            "unit": "mm",
            "affectsOutput": "Shifts the end of the tiling pattern backwards along the ridge vector, shortening the tiled run."
          },
          {
            "name": "sOverwrite",
            "technicalDefault": "\"|Don´t replace|\"",
            "businessMeaning": "Allows complex end configurations by forcing the script to ignore standard start/end tiles and use specific user-selected replacements instead.",
            "validRange": "Don´t replace, Start Tile, End Tile",
            "unit": "Enumeration",
            "affectsOutput": "Switches logic to use 'sAllTile' and 'sAllTile2' properties instead of the standard 'sStartTile' or 'sEndTile' at the specified end."
          },
          {
            "name": "sAllTile",
            "technicalDefault": "\"|No Tile|\"",
            "businessMeaning": "The primary replacement tile to use when 'sOverwrite' is active.",
            "validRange": "Manufacturer Catalog Entries (Ridge/Hip types)",
            "unit": "String (Catalog Selection)",
            "affectsOutput": "Replaces the tile at the start or end (depending on sOverwrite) with this specific item."
          },
          {
            "name": "sAllTile2",
            "technicalDefault": "\"|No Tile|\"",
            "businessMeaning": "An optional secondary replacement tile to be placed adjacent to the 'sAllTile' at the start or end.",
            "validRange": "Manufacturer Catalog Entries (Ridge/Hip types)",
            "unit": "String (Catalog Selection)",
            "affectsOutput": "Adds an extra tile instance at the modified start or end position."
          },
          {
            "name": "sOffsetDir",
            "technicalDefault": "\"|Parallel to edge|\"",
            "businessMeaning": "Determines how the Start/End offsets are measured geometrically relative to the roof slope.",
            "validRange": "Parallel to edge, Parallel to roofplane",
            "unit": "Enumeration",
            "affectsOutput": "Alters the calculation vector for dStartOffset and dEndOffset. 'Parallel to roofplane' calculates the offset projected onto the roof surface, whereas 'Parallel to edge' measures directly along the ridge line."
          },
          {
            "name": "dRidgeOffset",
            "technicalDefault": "80",
            "businessMeaning": "The vertical (Z-axis) height of the ridge tiles above the roof plane surface, typically accounting for batten thickness and air gaps.",
            "validRange": "0 mm to 300 mm",
            "unit": "mm",
            "affectsOutput": "Visually raises or lowers the generated ridge geometry in the 3D model to sit correctly on the roof structure."
          },
          {
            "name": "dHipOffset",
            "technicalDefault": "130",
            "businessMeaning": "The vertical (Z-axis) height of the hip tiles above the roof plane surface, often distinct from ridge offset due to the intersection geometry of hips.",
            "validRange": "0 mm to 300 mm",
            "unit": "mm",
            "affectsOutput": "Visually raises or lowers the generated hip geometry in the 3D model."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sRidgeTile is set to '|ByRoofplane|'",
            "effect": "The script ignores the specific catalog selection in this property and attempts to read the tile assignment directly from the attached RoofPlane entity properties.",
            "cascade": [
              "sRidgeTile"
            ]
          },
          {
            "trigger": "sStartTile or sEndTile is selected",
            "effect": "The script calculates the length of these special tiles and subtracts that length from the total available ridge length before placing standard tiles.",
            "cascade": [
              "sStartTile",
              "sEndTile",
              "dStartOffset",
              "dEndOffset"
            ]
          },
          {
            "trigger": "sOverwrite is set to '|Start Tile|' or '|End Tile|'",
            "effect": "The logic for placing standard start/end tiles is bypassed. The configuration relies on sAllTile and sAllTile2 to define the end conditions.",
            "cascade": [
              "sOverwrite",
              "sAllTile",
              "sAllTile2"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "HardWrComp (Hardware Component)",
            "description": "Generates Bill of Material (BOM) entries for every tile type (Standard, Start, End, Half, and special connectors). Includes Article Number, Quantity, Manufacturer, and Dimensions.",
            "appliedTo": "The TSL instance itself, linking back to the selected RoofPlane for reporting."
          },
          {
            "type": "PlaneProfile (Visual Geometry)",
            "description": "Draws the graphical representation of the tiles in the model plan/3D views to verify placement and coverage.",
            "appliedTo": "The coordinate system of the selected RoofPlane."
          },
          {
            "type": "Map Data (Submap)",
            "description": "Exports 'Hsb_TileExportData' and 'TilesToSubtract' maps to the RoofPlane. This allows other scripts (like Tile Grid generators) to know where ridge tiles have already been placed to avoid overlap.",
            "appliedTo": "The selected ERoofPlane entity."
          }
        ]
      },
      "tokens_used": 10262,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User executes the script (hsbTileHipRidge.mcr).",
          "2. If in Insert mode (_bOnInsert), prompt user to select ERoofPlane entities via command line.",
          "3. Script iterates through selected entities to locate a 'RoofFamilyDefinition' submap.",
          "4. Validate that valid tile family and manufacturer data exist on the roof planes.",
          "5. Call RoofTilingManager.dll to retrieve catalog entries for Ridge, Hip, Start, End, and Connection tiles based on the Family ID.",
          "6. Populate OPM dropdown properties (sRidgeTile, sStartTile, etc.) with the retrieved catalog options.",
          "7. Execute Main Calculation Loop:",
          "   - Identify intersection lines (Ridges/Hips) between selected roof planes.",
          "   - For each line, determine the Z-offset based on whether it is a Hip or Ridge.",
          "   - Calculate effective tiling length by applying Start and End offsets (dStartOffset, dEndOffset) in the specified direction (sOffsetDir).",
          "   - Determine Start and End tile placements based on sOverwrite settings (standard vs. custom replacement).",
          "   - Fill the remaining length with standard Ridge/Hip tiles.",
          "   - Detect and calculate specialized tiles for 'Pent' (valley) intersections and Half-tiles.",
          "8. Generate Visual Geometry: Draw PlaneProfiles for the calculated tiles in the 3D model.",
          "9. Generate BOM: Create HardWrComp entries for all calculated tiles with ArticleNumbers and Quantities.",
          "10. Export Data: Write 'Hsb_TileExportData' and 'TilesToSubtract' submaps to the roof plane entities.",
          "11. Final Check: If no hardware was generated, report an error and delete the instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Existence of Roof Tile Data on Selection",
            "path1": {
              "name": "Data Found",
              "steps": [
                "Read 'RoofFamilyDefinition'.",
                "Load tile catalogs from database.",
                "Proceed to calculation."
              ]
            },
            "path2": {
              "name": "Data Missing",
              "steps": [
                "Display error message 'could not find valid roof tile data'.",
                "Delete TSL instance immediately."
              ]
            }
          },
          {
            "condition": "Start/End Tile Configuration",
            "path1": {
              "name": "Don't Replace",
              "steps": [
                "Use 'sStartTile' at the beginning.",
                "Use 'sEndTile' at the end."
              ]
            },
            "path2": {
              "name": "Replace Start or End Tile",
              "steps": [
                "Ignore 'sStartTile'/'sEndTile'.",
                "Use 'sAllTile' as the primary replacement.",
                "Use 'sAllTile2' as a secondary adjacent tile if defined."
              ]
            }
          },
          {
            "condition": "Offset Direction Setting (sOffsetDir)",
            "path1": {
              "name": "Parallel to edge",
              "steps": [
                "Offset distance is measured linearly along the ridge/hip vector."
              ]
            },
            "path2": {
              "name": "Parallel to roofplane",
              "steps": [
                "Offset distance is measured projected onto the roof plane surface."
              ]
            }
          },
          {
            "condition": "Tile Placement Geometry",
            "path1": {
              "name": "Standard Ridge/Hip Run",
              "steps": [
                "Place Type 6 (Ridge) or Type 12/13 (Hip) tiles.",
                "Fill available length sequentially."
              ]
            },
            "path2": {
              "name": "Intersection/Pent Area",
              "steps": [
                "Identify complex geometry at roof intersections.",
                "Calculate 'Half' tiles or 'RidgeConnection' tiles (Types 4, 5, 7) to fit the irregular gap."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Valid 'RoofFamilyDefinition' map attached to ERoofPlane.",
            "errorMessage": "could not find valid roof tile data. Please make sure the rp has a roof tile style assigned.",
            "recovery": "Assign a valid roof tile style to the roof plane properties."
          },
          {
            "check": "Hardware Components generated successfully.",
            "errorMessage": "could not evaluate any tiles.",
            "recovery": "Ensure selected roof planes actually intersect (form ridges/hips), check if offsets are too large, or verify database catalogs are accessible."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Tile Selection",
            "how": "OPM Properties (sRidgeTile, sStartTile, etc.)",
            "effect": "Swaps the catalog definition used for the BOM and visual representation."
          },
          {
            "action": "Adjust Offsets",
            "how": "OPM Properties (dStartOffset, dEndOffset, dRidgeOffset)",
            "effect": "Moves the start/end points of the tiling run or changes the vertical height of the tiles."
          },
          {
            "action": "Change Offset Logic",
            "how": "OPM Property (sOffsetDir)",
            "effect": "Recalculates start/end positions switching between linear and surface-projected measurements."
          },
          {
            "action": "Modify End Conditions",
            "how": "OPM Properties (sOverwrite, sAllTile, sAllTile2)",
            "effect": "Switches between standard end caps and custom multi-tile end configurations."
          },
          {
            "action": "Refresh Calculation",
            "how": "Double Click entity or Modify Roof Plane Geometry",
            "effect": "Script recalculates all quantities and positions based on current properties and roof geometry."
          }
        ]
      },
      "tokens_used": 11059,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbTileHipRidge.mcr\n\n## Overview\nThis script automates the calculation and Bill of Materials (BOM) generation for ridge and hip roof tiles. It places visual representations of the tiles in the model, handles specialized start/end caps, and accounts for roof intersections and offsets.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Primary working environment. Select roof planes here. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: At least two `ERoofPlane` entities that intersect to form a ridge or hip line.\n- **Minimum Beam Count**: 0 (This script operates on Roof Planes, not beams).\n- **Required Settings**:\n  - Roof Planes must have a valid **Roof Tile Style** assigned (containing `Hsb_RoofTile` and `RoofFamilyDefinition` submaps).\n  - `RoofTilingManager.dll` must be available in the hsbCAD install path.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbTileHipRidge.mcr` from the list.\n\n### Step 2: Select Roof Planes\n```\nCommand Line: Select roofplane(s)\nAction: Click on the roof planes that form the ridge or hip you wish to tile. You must select at least two intersecting planes. Press Enter to confirm selection.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **General** | | | |\n| Ridge/Hip Tile | dropdown | No Tile | Select the catalog tile for the main run. Select \"ByRoofplane\" to use the tile defined in the roof plane properties. |\n| **Geometrie** | | | |\n| Z-Offset ridge | number | 80 | The vertical height (Z-axis) to raise ridge tiles above the roof plane surface. |\n| Z-Offset hip | number | 130 | The vertical height (Z-axis) to raise hip tiles above the roof plane surface. |\n| Offset direction | dropdown | Parallel to edge | Defines how start/end offsets are measured. \"Parallel to edge\" measures along the ridge line; \"Parallel to roofplane\" projects onto the roof surface. |\n| **Start Tile** | | | |\n| Start Tile | dropdown | No Tile | Specifies the specialized tile (e.g., starter cap) to place at the beginning of the run. |\n| Offset | number | 0 | The distance from the start of the roof geometry to where tiling actually begins. |\n| **End Tile** | | | |\n| End Tile | dropdown | No Tile | Specifies the specialized tile (e.g., end cap) to place at the end of the run. |\n| Offset | number | 0 | The distance from the end of the roof geometry to where tiling actually ends. |\n| **Replace tile** | | | |\n| Replace Start/ End Tile | dropdown | Don´t replace | Enables custom end configurations. Select \"Start Tile\" or \"End Tile\" to override standard settings with the specific tiles below. |\n| 1st Start/ End Tile | dropdown | No Tile | The primary replacement tile to use when the \"Replace\" option is active. |\n| 2nd Start/ End Tile | dropdown | No Tile | An optional secondary replacement tile placed adjacent to the first replacement tile. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Double Click | Recalculates the tile layout and BOM. Use this after changing roof geometry or modifying properties. |\n\n## Settings Files\n- **Filename**: `RoofTilingManager.dll`\n- **Location**: `_kPathHsbInstall\\Utilities\\RoofTiles\\`\n- **Purpose**: Retrieves tile definitions (dimensions, article numbers, material) from the tile database catalog.\n\n## Tips\n- **Missing Data Error**: If the script disappears immediately after insertion, check that your Roof Planes have a valid \"Roof Tile Style\" assigned in their properties.\n- **Visual Adjustments**: If the tiles look like they are floating or sinking into the roof, adjust the \"Z-Offset ridge\" or \"Z-Offset hip\" values.\n- **Complex Ends**: If you need a specific arrangement of tiles at the ridge ends (e.g., for ventilation), use the \"Replace Start/ End Tile\" option combined with the \"1st\" and \"2nd\" tile fields to stack multiple custom pieces.\n- **ByRoofplane**: Use the \"ByRoofplane\" setting for the main tile to ensure the script automatically updates if you change the global roof material assignment.\n\n## FAQ\n- **Q: Why does the script say \"could not evaluate any tiles\"?**\n  **A**: This usually means the selected roof planes do not intersect to form a ridge or hip, or the calculated offsets are larger than the available length.\n- **Q: What is the difference between \"Parallel to edge\" and \"Parallel to roofplane\" offset?**\n  **A**: \"Parallel to edge\" measures the offset in a straight line along the ridge. \"Parallel to roofplane\" projects the measurement onto the sloped roof surface, which results in a longer horizontal distance for steep roofs.\n- **Q: Can I use this for valley tiles?**\n  **A**: No, this script is specifically designed for Ridges (the top peak) and Hips (the sloped intersection between roof sections)."
      },
      "tokens_used": 7901,
      "error": null
    }
  }
}