{
  "filename": "hsbCAD_Electrical Fixture.mcr",
  "status": "completed",
  "total_tokens": 46333,
  "processing_time": 276.5097312927246,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8133,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No 'sd_' or 'Multipage' prefix detected. Script utilizes assignToElementGroup() and el.addTool() which are strictly 3D Model Space functions. It calculates geometry using 3D vectors (Vector3d) and coordinates relative to an Element's CoordSys."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (via Circuit)",
            "TslInst (Electrical Circuit)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "electricallibrary.xml"
          ]
        }
      },
      "tokens_used": 5620,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getDouble",
              "promptOriginal": "Height",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getDouble",
              "promptOriginal": "Lateral Position",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getTslInst",
              "promptOriginal": "Select electrical circuit",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertyDialog",
            "trigger": "_bOnInsert (showDialog)",
            "title": null,
            "dataSource": "TSL Properties (sFixture, dDepthMill, strTurn, strOShoot)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sCircuit",
            "type": "PropString",
            "displayName": "Circuit",
            "defaultValue": "None",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sFixture",
            "type": "PropString",
            "displayName": "Fixture",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": "Populated from electricallibrary.xml",
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dDepthMill",
            "type": "PropDouble",
            "displayName": "Milling Depth '0=Automatic'",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "strTurn",
            "type": "PropString",
            "displayName": "Turning direction",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "Against course",
              "With course"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "strOShoot",
            "type": "PropString",
            "displayName": "Overshoot",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "electricallibrary.xml",
            "searchPaths": [
              "_kPathHsbInstall\\Content\\UK\\TSL\\Standard\\Electrical\\"
            ],
            "purpose": "Provides fixture definitions, codes, and types for the 'Fixture' property dropdown.",
            "required": true
          }
        ]
      },
      "tokens_used": 7078,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Inserts electrical fixtures (sockets, switches, aerials) into timber wall elements and links them to specific electrical circuits for manufacturing data and visualization.",
          "category": "Hardware/MEP",
          "typicalUseCase": "Placing a double socket or light switch on a stud wall during the design phase to ensure the correct back box milling is generated in production drawings and CNC data."
        },
        "parameters": [
          {
            "name": "Height",
            "technicalDefault": "User Input",
            "businessMeaning": "The vertical elevation of the electrical fixture relative to the element's coordinate system origin.",
            "validRange": "0 to Total Wall Height",
            "unit": "mm",
            "affectsOutput": "Determines the Y-coordinate of the 2D symbol representation, the connection line, and the location of the back box milling."
          },
          {
            "name": "Lateral Position",
            "technicalDefault": "User Input",
            "businessMeaning": "The horizontal placement of the fixture relative to the element's coordinate system origin.",
            "validRange": "0 to Wall Width",
            "unit": "mm",
            "affectsOutput": "Determines the X-coordinate of the 2D symbol representation and the location of the back box milling."
          },
          {
            "name": "Select electrical circuit",
            "technicalDefault": "Selected TslInst",
            "businessMeaning": "Associates the fixture with a specific 'Circuit' script instance to group fixtures logically and draw visual connections.",
            "validRange": "Existing 'Electrical Circuit' Tsl Instances in Model",
            "unit": "N/A",
            "affectsOutput": "Populates the read-only 'Circuit' property, draws a visual connecting line to the circuit, and updates the DXA export data."
          },
          {
            "name": "sFixture",
            "technicalDefault": "First entry in electricallibrary.xml",
            "businessMeaning": "Defines the specific type of electrical device (e.g., Double Socket, TV Aerial) which dictates its geometry and symbol.",
            "validRange": "List defined in electricallibrary.xml",
            "unit": "N/A",
            "affectsOutput": "Controls which 2D symbol is drawn (PLine shapes) and determines if a back box milling operation is required."
          },
          {
            "name": "sCircuit",
            "technicalDefault": "None",
            "businessMeaning": "Read-only display of the name of the circuit this fixture is attached to.",
            "validRange": "String",
            "unit": "N/A",
            "affectsOutput": "Metadata for DXA export and internal logic reference."
          },
          {
            "name": "dDepthMill",
            "technicalDefault": "0",
            "businessMeaning": "Controls the depth of the back box milling. A value of 0 automatically calculates the depth based on the sheathing/cladding zone thicknesses.",
            "validRange": "0 (Auto) or 15mm to 300mm (Manual)",
            "unit": "mm",
            "affectsOutput": "Sets the Z-depth of the CNC Milling operation."
          },
          {
            "name": "strTurn",
            "technicalDefault": "Against course",
            "businessMeaning": "Determines the direction the CNC tool travels around the cut (Climb vs. Conventional milling).",
            "validRange": "Against course, With course",
            "unit": "N/A",
            "affectsOutput": "Alters the G-code toolpath direction for the back box milling."
          },
          {
            "name": "strOShoot",
            "technicalDefault": "No",
            "businessMeaning": "Specifies whether the CNC tool should overrun the cut profile to ensure a clean edge and avoid dwell marks.",
            "validRange": "No, Yes",
            "unit": "N/A",
            "affectsOutput": "Adds or removes lead-in/out paths in the CNC toolpath."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFixture selection",
            "effect": "Changes the internal 'nRoutingType' variable. Only specific types (Double Socket, Single Socket) trigger the creation of back box milling.",
            "cascade": [
              "Geometry",
              "Milling Operations"
            ]
          },
          {
            "trigger": "dDepthMill = 0",
            "effect": "The script calculates the milling depth by summing the thickness of element zones (cladding layers). If > 0, it uses the explicit value.",
            "cascade": [
              "ElemMill Depth"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PLine (Visuals)",
            "description": "2D representation of the specific fixture (e.g., socket symbol) and a connecting line to the electrical circuit.",
            "appliedTo": "Element (Model Space Display)"
          },
          {
            "type": "ElemMill (CNC)",
            "description": "Rectangular pocket milling operation for back boxes (plasterboard depth) if the fixture type requires it (Type 1 or 2).",
            "appliedTo": "Element (Outer sheathing layer)"
          },
          {
            "type": "ElemItem (Data)",
            "description": "Non-visual data object storing fixture coordinates, code, and circuit name for export to production management systems (DXA).",
            "appliedTo": "Element (Zone 7)"
          }
        ]
      },
      "tokens_used": 8178,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script Start: Load 'electricallibrary.xml' and populate fixture lists.\",\n    \"2. Insertion Mode Triggered (_bOnInsert).\",\n    \"3. Command Line Prompt: Request 'Height' (Y coordinate) from user.\",\n    \"4. Command Line Prompt: Request 'Lateral Position' (X coordinate) from user.\",\n    \"5. Selection Prompt: Request user to select an 'Electrical Circuit' (TslInst).\",\n    \"6. Linking: Establish bidirectional link between this instance and the selected circuit instance.\",\n    \"7. Validation: Check if fixture library loaded successfully (list not empty).\",\n    \"8. UI Interaction: Open Properties Dialog (showDialog) for fixture selection.\",\n    \"9. Persistence: Store library map in the instance _Map variable and return.\",\n    \"10. Recalculation Trigger: Script re-runs (e.g., property change, model update).\",\n    \"11. Dependency Check: Verify linked Circuit instance still exists.\",\n    \"12. Context Resolution: Retrieve host Element and Coordinate System from Circuit.\",\n    \"13. Mapping: Identify selected fixture's 'Type' and 'Code' from the library.\",\n    \"14. Geometry Generation: Execute specific drawing logic based on fixture Type (Sockets, Aerials, Radiators).\",\n    \"15. Visuals: Draw connecting line between fixture and circuit origin.\",\n    \"16. CNC Logic: Calculate milling depth (Auto sum of zones vs Manual value).\",\n    \"17. Data Export: Create ElemItem with fixture details (Description, Circuit, Coords) for DXA export.\",\n    \"18. Completion: Finalize drawing and tool additions.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Library Load Validation\",\n      \"path1\": {\n        \"name\": \"Library Empty\",\n        \"steps\": [\n          \"Display error message: 'No Electrical Library items found.'\",\n          \"Execute eraseInstance().\",\n          \"Stop script execution.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Library Loaded\",\n        \"steps\": [\n          \"Continue to User Input prompts.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Fixture Type Selection (sType)\",\n      \"path1\": {\n        \"name\": \"Double Socket\",\n        \"steps\": [\n          \"Set nFixtureType = 1.\",\n          \"Draw specific pin holes (PLines).\",\n          \"Set nRoutingType = 1 (Double Back Box).\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Telephone/Data/TV/Radiator/Switch\",\n        \"steps\": [\n          \"Set nFixtureType = 2.\",\n          \"Draw specific geometry (Rectangles/Circles).\",\n          \"Set nRoutingType = 0 or 2 (Single Back Box depending on specific type logic).\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Connection Distance (abs(dFixtureDistance) > 17.5)\",\n      \"path1\": {\n        \"name\": \"Far from Circuit\",\n        \"steps\": [\n          \"Draw connection line in Color 3.\",\n          \"Draw end circle at circuit connection point.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Near to Circuit\",\n        \"steps\": [\n          \"Draw standard connection line.\",\n          \"Skip specific end circle marker.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Milling Depth Calculation (abs(dDepthMill) < 0.01)\",\n      \"path1\": {\n        \"name\": \"Automatic (0)\",\n        \"steps\": [\n          \"Loop through element zones (1 to nOutSideZone).\",\n          \"Sum zone thicknesses (dH) to determine Mill Depth.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Manual (>0)\",\n        \"steps\": [\n          \"Use the explicit value from dDepthMill property.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Routing Requirement (nRoutingType != 0)\",\n      \"path1\": {\n        \"name\": \"Milling Required\",\n        \"steps\": [\n          \"Calculate PLine dimensions based on Type (Double vs Single).\",\n          \"Generate ElemMill operation for the outer sheathing zone.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"No Milling\",\n        \"steps\": [\n          \"Skip CNC tool generation.\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Electrical Library Availability\",\n      \"errorMessage\": \"No Electrical Library items found.\",\n      \"recovery\": \"Ensure 'electricallibrary.xml' exists in the configured hsbCAD Content path.\"\n    },\n    {\n      \"check\": \"Circuit Instance Integrity\",\n      \"errorMessage\": \"(Implicit) Script instance erased.\",\n      \"recovery\": \"Re-select the Electrical Circuit or ensure the original circuit was not deleted.\"\n    },\n    {\n      \"check\": \"Element Zones\",\n      \"errorMessage\": \"None (Script uses existing zone data)\",\n      \"recovery\": \"Ensure host Element has valid material zones defined if using Automatic Milling Depth.\"\n    }\n  ],\n  \"postInsertionActions\": [\n    {\n      \"action\": \"Change Fixture Type\",\n      \"how\": \"Properties Palette (OPM) -> 'Fixture' dropdown\",\n      \"effect\": \"Updates 2D symbol, changes nRoutingType"
      },
      "tokens_used": 10272,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCAD Electrical Fixture\n\n## Overview\nInserts electrical fixtures (e.g., sockets, switches, aerials) into timber wall elements and links them to specific electrical circuits to generate manufacturing data and visualizations.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model environment to calculate geometry and assign tools to elements. |\n| Paper Space | No | This script does not function in layout views. |\n| Shop Drawing | No | This script is for detailing and manufacturing, not for generating 2D shop drawings directly. |\n\n## Prerequisites\n- **Required Entities**:\n  - An existing **Element** (Wall) in the model.\n  - An existing **Electrical Circuit** TSL instance in the model.\n- **Minimum Beam Count**: 0 (This script targets Elements, not individual beams).\n- **Required Settings Files**:\n  - `electricallibrary.xml` must be present in the hsbCAD Content folder (`...\\Content\\UK\\TSL\\Standard\\Electrical\\`).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCAD_Electrical Fixture.mcr` from the available scripts list.\n\n### Step 2: Specify Height\n```\nCommand Line: Height\nAction: Type the vertical elevation (in mm) where the fixture should be placed relative to the element's coordinate origin. Press Enter.\n```\n\n### Step 3: Specify Lateral Position\n```\nCommand Line: Lateral Position\nAction: Type the horizontal distance (in mm) from the element's coordinate origin. Press Enter.\n```\n\n### Step 4: Select Electrical Circuit\n```\nCommand Line: Select electrical circuit\nAction: Click on the existing 'Electrical Circuit' instance (TSL) in the drawing that you wish to associate this fixture with.\n```\n\n### Step 5: Configure Fixture\n```\nAction: The Properties Palette will open automatically.\n1. Select the desired 'Fixture' type (e.g., Double Socket) from the dropdown list.\n2. Adjust 'Milling Depth' if necessary (default is 0 for automatic calculation).\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Circuit | String | None | (Read-only) Displays the name of the electrical circuit this fixture is linked to. |\n| Fixture | Dropdown | *First in library* | Select the specific electrical device type (e.g., Double Socket, TV Aerial) from the library. |\n| Milling Depth '0=Automatic' | Number | 0 | Sets the depth of the back box milling. **0** calculates depth based on sheathing zones automatically. Enter a value (mm) to override. |\n| Turning direction | Dropdown | Against course | Determines the CNC tool travel direction: \"Against course\" or \"With course\". |\n| Overshoot | Dropdown | No | Specifies if the CNC tool should overrun the cut profile (\"Yes\" or \"No\") to ensure clean edges. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *(None)* | This script does not add custom items to the right-click context menu. Use standard AutoCAD/hsbCAD commands to modify or erase the instance. |\n\n## Settings Files\n- **Filename**: `electricallibrary.xml`\n- **Location**: `[hsbCAD Install Path]\\Content\\UK\\TSL\\Standard\\Electrical\\`\n- **Purpose**: Provides the list of available fixtures, their internal codes, and geometry definitions used to populate the 'Fixture' dropdown and determine the correct symbol and milling type.\n\n## Tips\n- **Automatic Milling Depth**: Leave the 'Milling Depth' set to 0. The script will automatically sum the thickness of the wall's outer sheathing zones to determine the correct pocket depth.\n- **Positioning**: The \"Height\" and \"Lateral Position\" are defined relative to the Element's local coordinate system. If you place a fixture incorrectly, you must erase the instance and re-insert it; these coordinates are not editable properties after insertion.\n- **Circuit Linking**: Ensure you select the correct Circuit instance. The script draws a visual connection line to the circuit and exports the relationship to production data (DXA).\n- **Milling Types**: Only specific fixture types (such as sockets requiring back boxes) will generate CNC milling operations. Items like switches or aerials may only generate visual symbols and data points.\n\n## FAQ\n- **Q: I get an error \"No Electrical Library items found.\" What should I do?**\n- **A:** Ensure that `electricallibrary.xml` exists in the correct directory (`...\\Content\\UK\\TSL\\Standard\\Electrical\\`). If the file is missing or corrupted, the script cannot load fixture definitions and will abort.\n\n- **Q: Can I move the fixture after I have inserted it?**\n- **A:** No. The insertion coordinates (Height and Lateral Position) are only requested during the initial insertion command (`_bOnInsert`). To move the fixture, you must erase the current instance and run the script again at the new location.\n\n- **Q: Why is no CNC milling tool generated for my socket?**\n- **A:** Check the 'Fixture' property you selected. Ensure it is a type defined in the library that requires routing (e.g., \"Double Socket\"). Also, verify that the element has valid material zones defined if you are using the Automatic Milling Depth setting."
      },
      "tokens_used": 7052,
      "error": null
    }
  }
}