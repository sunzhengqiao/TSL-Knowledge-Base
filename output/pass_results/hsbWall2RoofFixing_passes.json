{
  "filename": "hsbWall2RoofFixing.mcr",
  "status": "completed",
  "total_tokens": 52889,
  "processing_time": 264.7022063732147,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "17jan2022",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-13746: use continuous distribution, TSL assignment, TSL run as an element TSL"
          },
          {
            "version": "1.0",
            "date": "03feb2021",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-10120: initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 8015,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script filename 'hsbWall2RoofFixing.mcr' lacks 'sd_' prefix. Summary explicitly states 'TSL can be attached as a wall TSL and run on wall construction'. Logic collects entities using 'Group().collectEntities(true, ElementRoof(), _kModelSpace)'. Uses '_bOnElementConstructed' for calculation logic. Adds CncExport tools to Beams which is a model space operation."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWallSF",
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D)",
          "requiredSettings": []
        }
      },
      "tokens_used": 7100,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select stick frame wall(s) and roof(s) elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (_bOnInsert) or MapIO (_bOnMapIO)",
            "title": null,
            "dataSource": "Script Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nNailIndex",
            "type": "PropInt",
            "displayName": "Nail Index",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "General",
            "description": "Defines the NailIndex"
          },
          {
            "index": 0,
            "variable": "sDirection",
            "type": "PropString",
            "displayName": "Direction",
            "defaultValue": "Wall-Floor/Ceiling",
            "inputType": "dropdown",
            "options": [
              "Wall-Floor/Ceiling",
              "Floor/Ceiling-Wall"
            ],
            "category": "Alignment",
            "description": "Defines the direction of nail"
          },
          {
            "index": 1,
            "variable": "sDistributionArea",
            "type": "PropString",
            "displayName": "Distribution Areas",
            "defaultValue": "Continuous",
            "inputType": "dropdown",
            "options": [
              "Continuous",
              "Separately"
            ],
            "category": "Alignment",
            "description": "Defines how the nailing distribution should be done. Continuously from start to end or separately for each distribution area."
          },
          {
            "index": 2,
            "variable": "sModeDistribution",
            "type": "PropString",
            "displayName": "Mode",
            "defaultValue": "Even",
            "inputType": "dropdown",
            "options": [
              "Even",
              "Fixed"
            ],
            "category": "Distribution",
            "description": "Defines the Distribution Mode between even or fixed. User can enter Even or Fixed"
          },
          {
            "index": 0,
            "variable": "dDistanceBottom",
            "type": "PropDouble",
            "displayName": "Distance Bottom/Start",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Defines the distance at the bottom or start of distribution"
          },
          {
            "index": 1,
            "variable": "dDistanceTop",
            "type": "PropDouble",
            "displayName": "Distance Top/End",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Defines the distance at the top or end of distribution"
          },
          {
            "index": 2,
            "variable": "dDistanceBetween",
            "type": "PropDouble",
            "displayName": "Max. Distance between ",
            "defaultValue": "10",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Defines the MAx. distance between the parts."
          },
          {
            "index": 3,
            "variable": "dDistanceBetweenResult",
            "type": "PropDouble",
            "displayName": "Distance between calculated",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Exact distance between nails for an equal distribution"
          },
          {
            "index": 1,
            "variable": "nNrResult",
            "type": "PropInt",
            "displayName": "Nr.",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Number of nails"
          },
          {
            "index": 3,
            "variable": "dDistaceStud",
            "type": "PropDouble",
            "displayName": "Distace Stud",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Defines the Distace from Stud"
          },
          {
            "index": 4,
            "variable": "dDistanceTooling",
            "type": "PropDouble",
            "displayName": "Distance Tooling",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "Distribution",
            "description": "Defines the Distance from Tooling"
          },
          {
            "index": 3,
            "variable": "sType",
            "type": "PropString",
            "displayName": "Type",
            "defaultValue": "Floor",
            "inputType": "dropdown",
            "options": [
              "Floor",
              "Ceiling"
            ],
            "category": "Distribution",
            "description": "Defines the Type"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Swap Direction",
            "handler": "Swap Direction",
            "action": "Toggles the Direction property between index 0 (Wall-Floor/Ceiling) and index 1 (Floor/Ceiling-Wall).",
            "alsoTriggeredBy": "Double-click (TslDoubleClick)"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8359,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automatically calculates positions and generates CNC data for nailing a wall to a floor or ceiling element.\",\n    \"category\": \"Hardware/Connection\",\n    \"typicalUseCase\": \"Automating the nailing pattern of bottom plates to floor joists or top plates to ceilings during the design of timber frame structures.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"nNailIndex\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"Selects the specific nail gun tooling index (nail type/size) from the CNC machine's configuration database.\",\n      \"validRange\": \"1 - 50 (Positive Integers)\",\n      \"unit\": \"Integer\",\n      \"affectsOutput\": \"Determines the 'ToolIndex' in the CNC export data, specifying which physical nail gun and nail size to use on the machine.\"\n    },\n    {\n      \"name\": \"sDirection\",\n      \"technicalDefault\": \"Wall-Floor/Ceiling\",\n      \"businessMeaning\": \"Defines the shooting direction of the nail. Determines which structural element (Wall or Floor) holds the nail and which is penetrated.\",\n      \"validRange\": \"Wall-Floor/Ceiling, Floor/Ceiling-Wall\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"Reverses the nailing vector and assigns the machining operation either to the Wall beams or the Floor beams.\"\n    },\n    {\n      \"name\": \"sDistributionArea\",\n      \"technicalDefault\": \"Continuous\",\n      \"businessMeaning\": \"Controls how wall openings (windows/doors) affect the nailing pattern. 'Continuous' calculates spacing based on the total wall length. 'Separately' calculates spacing individually for each solid section between openings.\",\n      \"validRange\": \"Continuous, Separately\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"Changes the spacing logic (nNrResult and dDistanceBetweenResult) to ensure nails are not placed in openings and spacing remains consistent across segments.\"\n    },\n    {\n      \"name\": \"sModeDistribution\",\n      \"technicalDefault\": \"Even\",\n      \"businessMeaning\": \"Defines the calculation rule for nail spacing. 'Even' adjusts the distance to be uniform across the length. 'Fixed' uses a strict user-defined distance.\",\n      \"validRange\": \"Even, Fixed\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"In 'Even' mode, it modifies 'Distance between calculated' to ensure uniform distribution. In 'Fixed' mode, it strictly follows 'Max. Distance between'.\"\n    },\n    {\n      \"name\": \"dDistanceBottom\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"The edge distance (margin) from the start of the wall or segment to the center of the first nail.\",\n      \"validRange\": \"0 - 300 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Shifts the entire distribution pattern along the wall axis. Prevents nailing too close to the end grain.\"\n    },\n    {\n      \"name\": \"dDistanceTop\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"The edge distance (margin) from the end of the wall or segment to the center of the last nail.\",\n      \"validRange\": \"0 - 300 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Determines the placement of the final nail in the distribution pattern.\"\n    },\n    {\n      \"name\": \"dDistanceBetween\",\n      \"technicalDefault\": \"10\",\n      \"businessMeaning\": \"The target spacing between nails. In 'Even' mode, this is the maximum allowed distance. In 'Fixed' mode, this is the exact distance.\",\n      \"validRange\": \"50 - 2000 mm\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"Primary driver for the number of nails (nNrResult) and the calculated spacing.\"\n    },\n    {\n      \"name\": \"dDistanceBetweenResult\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"The actual distance between nails calculated by the script (Read-only).\",\n      \"validRange\": \"Calculated\",\n      \"unit\": \"mm\",\n      \"affectsOutput\": \"None (Output Parameter).\"\n    },\n    {\n      \"name\": \"nNrResult\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"The total number of nails generated by the script (Read-only).\",\n      \"validRange\": \"Calculated\",\n      \"unit\": \"Count\",\n      \"affectsOutput\": \"None (Output Parameter).\"\n    },\n    {\n      \"name\": \"dDistaceStud\",\n      \"technicalDefault\": \"0\",\n      \"businessMeaning\": \"An offset distance applied relative to the position of wall studs.\",\n      \"validRange\": \"0 - 200 mm\",\n      \"unit\": \"mm\",\n      \"affects"
      },
      "tokens_used": 10801,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Start: Initialize constants and properties.",
          "2. Check Execution Mode (_bOnInsert):",
          "   - If Insert Cycle > 1: Erase instance and exit.",
          "   - If executed with command key: Load properties from catalog/last inserted.",
          "   - Else: Show Property Dialog (showDialog).",
          "3. Entity Selection:",
          "   - Prompt user to select Stick Frame Wall(s) and Roof(s).",
          "   - Append valid entities to _Element array.",
          "4. Selection Validation:",
          "   - Check if count < 2. If yes, Report Error, Erase instance, Exit.",
          "   - Set Map flag 'Inserted' = true and return.",
          "5. MapIO / Element Constructed Phase:",
          "   - Handle input from property dialog if present.",
          "   - Check for valid Wall element attachment.",
          "6. Geometry Preparation:",
          "   - Validate Wall Element (Must be ElementWallSF).",
          "   - Collect all Roof elements in ModelSpace.",
          "   - Filter Roof list: Remove non-Floor elements (Keep Floors only).",
          "   - Calculate intersection profile between Wall and Floors.",
          "7. Distribution Calculation (Loop):",
          "   - Determine distribution points based on 'Distribution Areas' (Continuous vs Separately).",
          "   - Apply logic for 'Mode' (Even vs Fixed).",
          "   - Calculate positions respecting 'Distance Bottom/Start' and 'Distance Top/End'.",
          "8. Assignment & CNC Generation:",
          "   - Assign Script Instance to Wall or Floor based on 'Direction'.",
          "   - Loop through calculated points.",
          "   - Determine host beam (Wall or Floor) based on 'Direction'.",
          "   - Add CncExport ('FrameNailTool') to host beam.",
          "   - Draw visual markers (Circles and lines).",
          "9. Context Menu Handling:",
          "   - Listen for 'Swap Direction' trigger.",
          "   - If triggered: Toggle 'Direction' property and force recalculation."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion Method",
            "path1": {
              "name": "Manual Insert",
              "steps": [
                "User executes command.",
                "Prompts for Entity Selection.",
                "Requires explicit selection of Wall and Floor."
              ]
            },
            "path2": {
              "name": "Element Attachment (MapIO)",
              "steps": [
                "Script attached to Wall element in catalog.",
                "Auto-detects Floor elements from ModelSpace.",
                "Requires no user selection prompt."
              ]
            }
          },
          {
            "condition": "Distribution Areas Property",
            "path1": {
              "name": "Continuous",
              "steps": [
                "Calculates extents of the total valid intersection length.",
                "Distributes nails continuously across the entire span.",
                "Ignores gaps between individual wall sections for the count/spacing calc."
              ]
            },
            "path2": {
              "name": "Separately",
              "steps": [
                "Iterates through individual wall segments (solid parts).",
                "Calculates nail distribution independently for each segment.",
                "Respects openings/gaps between segments."
              ]
            }
          },
          {
            "condition": "Direction Property (Nailing Vector)",
            "path1": {
              "name": "Wall-Floor/Ceiling (Index 0)",
              "steps": [
                "Nail shoots from Wall into Floor.",
                "CNC Tool added to Wall Beam.",
                "Script assigned to Wall Element Group."
              ]
            },
            "path2": {
              "name": "Floor/Ceiling-Wall (Index 1)",
              "steps": [
                "Nail shoots from Floor into Wall.",
                "CNC Tool added to Floor Beam.",
                "Script assigned to Floor Element Group."
              ]
            }
          },
          {
            "condition": "Mode Property (Spacing)",
            "path1": {
              "name": "Even",
              "steps": [
                "Calculates exact spacing to fit 'Nr. of nails' or 'Max Distance' evenly.",
                "Updates 'Distance between calculated' property."
              ]
            },
            "path2": {
              "name": "Fixed",
              "steps": [
                "Uses 'Max. Distance between' strictly.",
                "Places nails at fixed intervals starting from offset.",
                "Last segment may have different spacing to fit margin."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selected Entity Count",
            "errorMessage": "At least a wall and a roof are needed",
            "recovery": "Select both a Wall and a Roof element during insertion."
          },
          {
            "check": "Wall Element Existence (Attachment Mode)",
            "errorMessage": "wall not found",
            "recovery": "Ensure the TSL is attached to a valid wall element."
          },
          {
            "check": "Element Type",
            "errorMessage": "TSL should only be attached to SF Walls",
            "recovery": "Detach from current element and attach to a Stick Frame Wall (ElementWallSF)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Swap Direction",
            "how": "Right-click context menu 'Swap Direction' or Double-click on instance",
            "effect": "Toggles 'Direction' property between Wall->Floor and Floor->Wall, recalculates nail hosts, and reassigns TSL group."
          },
          {
            "action": "Modify Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Changing distances, mode, or distribution area triggers immediate recalculation of nail positions and visual update."
          }
        ]
      },
      "tokens_used": 11175,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbWall2RoofFixing.mcr\n\n## Overview\nThis script automates the calculation of nailing positions and generates CNC data for connecting stick frame walls to floor or ceiling elements. It supports various distribution modes (continuous or separate) and allows flexible configuration of nail directions and spacing.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script runs in 3D model environment to detect walls and floors. |\n| Paper Space | No | Not supported for layout views. |\n| Shop Drawing | No | This is a model/CNC generation script. |\n\n## Prerequisites\n- **Required Entities**: At least one Stick Frame Wall (`ElementWallSF`) and one Roof element (specifically a Floor or Ceiling).\n- **Minimum Beam Count**: 0 (Operates on Elements).\n- **Required Settings**: None specific (uses standard catalogs for nail indices).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbWall2RoofFixing.mcr` from the list.\n\n### Step 2: Select Elements\n```\nCommand Line: Select stick frame wall(s) and roof(s) elements\nAction: Click on the Wall element and the Floor/Ceiling element, then press Enter.\n```\n\n### Step 3: Configure Properties\n```\nAction: The Properties Palette (OPM) opens automatically. Adjust parameters such as Nail Index, Distribution Mode, and Distances. \nNote: The script will automatically calculate nail positions and generate visual markers/CNC data once properties are applied.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Nail Index | number | 0 | Selects the specific nail gun tooling index (nail type/size) from the CNC machine's configuration. |\n| Direction | dropdown | Wall-Floor/Ceiling | Defines the shooting direction. Choose if the nail shoots from the Wall into the Floor, or vice versa. |\n| Distribution Areas | dropdown | Continuous | Determines how openings (windows/doors) affect the pattern. \"Continuous\" spans the whole length; \"Separately\" treats solid wall sections individually. |\n| Mode | dropdown | Even | Sets the calculation rule. \"Even\" adjusts spacing for uniformity; \"Fixed\" uses a strict user-defined distance. |\n| Distance Bottom/Start | number | 0 | The edge distance (margin) from the start of the wall/segment to the center of the first nail. |\n| Distance Top/End | number | 0 | The edge distance (margin) from the end of the wall/segment to the center of the last nail. |\n| Max. Distance between | number | 10 | Target spacing between nails. In \"Even\" mode this is a maximum; in \"Fixed\" mode it is exact. |\n| Distance between calculated | number | 0 | (Read-only) The exact distance calculated by the script in \"Even\" mode. |\n| Nr. | number | 0 | (Read-only) The total number of nails generated. |\n| Distace Stud | number | 0 | Defines an offset distance applied relative to the position of wall studs. |\n| Distance Tooling | number | 0 | Defines an offset distance for the tooling machinery setup. |\n| Type | dropdown | Floor | Defines the connection type, either \"Floor\" or \"Ceiling\". |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Swap Direction | Toggles the nailing direction between Wall-Floor/Ceiling and Floor/Ceiling-Wall. Also updates which element hosts the CNC data. |\n\n## Settings Files\n- **Filename**: None specified\n- **Location**: N/A\n- **Purpose**: This script relies on standard hsbCAD catalogs for Nail Index definitions rather than a specific XML settings file.\n\n## Tips\n- **Element Attachment**: Instead of manual insertion, this TSL can be attached directly to a Wall Element in the catalog. When attached, it automatically detects adjacent floors without needing manual selection.\n- **Visual Feedback**: The script draws circles and lines to indicate where nails will be placed.\n- **Quick Swap**: You can double-click the script instance in the model to quickly trigger the \"Swap Direction\" function.\n\n## FAQ\n- **Q: What happens if I have a window in the wall?**\n  - **A**: If the **Distribution Areas** property is set to \"Separately\", the script will calculate nail patterns for the wall sections on either side of the window individually. If set to \"Continuous\", it calculates based on the total length.\n- **Q: How do I ensure my nails hit the studs?**\n  - **A**: Use the **Distace Stud** property to apply an offset relative to the stud positions detected by the script.\n- **Q: Can I use this for ceilings?**\n  - **A**: Yes, ensure the **Type** property is set to \"Ceiling\" and that you select a Ceiling element (Roof element type) during insertion."
      },
      "tokens_used": 7439,
      "error": null
    }
  }
}