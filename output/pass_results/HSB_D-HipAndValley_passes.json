{
  "filename": "HSB_D-HipAndValley.mcr",
  "status": "completed",
  "total_tokens": 55055,
  "processing_time": 273.0588324069977,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9342,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly prompts for viewport selection ('_Viewport.append(getViewport(...))') and checks '_Viewport.length()'. It extensively uses 'ms2ps' transformations to map model geometry (Beam, Point3d) to paper space dimensions ('dimTotal.transformBy(ms2ps)'). Properties include 'sDimStyle' and 'sDimStyleName' for detailing output."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Requires a valid Viewport selection in Paper Space. The script calculates dimensions based on the view direction defined by the viewport.",
          "requiredSettings": [
            "HSB_G-FilterGenBeams.mcr (optional, used for beam filtering if configured)"
          ]
        }
      },
      "tokens_used": 5763,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getViewport\",\n        \"promptOriginal\": \"|Select a viewport|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"getPoint\",\n        \"promptOriginal\": \"|Select a position|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sSeperator01\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Selection|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sSectionName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Name element section|\",\n      \"defaultValue\": \" \",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \" \"\n      ],\n      \"category\": \"Selection\",\n      \"description\": null\n    },\n    {\n      \"index\": 22,\n      \"variable\": \"genBeamFilterDefinition\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Filter definition for GenBeams|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [],\n      \"category\": \"Selection\",\n      \"description\": \"|Filter definition for GenBeams.| (|Will be combined with custom filters|)|Use| HSB_G-FilterGenBeams.mcr |to define the filters|.\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sFilterBC\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Filter beams with beamcode|\",\n      \"defaultValue\": \"KEG-01;HRL-01\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Selection\",\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sFilterLabel\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Filter beams and sheets with label or material|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Selection\",\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sFilterZone\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Filter zones|\",\n      \"defaultValue\": \"1;7\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Selection\",\n      \"description\": null\n    },\n    {\n      \"index\": 20,\n      \"variable\": \"sCombineTouchingBeams\",\n      \"type\": \"PropString\",\n      \"displayName\": \"  |Combine touching beams|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": \"Selection\",\n      \"description\": null\n   "
      },
      "tokens_used": 10087,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the dimensioning of hip and valley rafter intersections in 2D shop drawings, calculating the precise offsets and positions of perpendicular (jack) rafters relative to the main angled beam.\",\n    \"category\": \"ShopDrawing\",\n    \"typicalUseCase\": \"Used when creating layout drawings for roof fabrication to ensure all jack rafters are measured and placed correctly along a hip or valley rafter.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sSeperator01\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Visual grouping header in the properties palette (Read-only).\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"N/A\",\n      \"affectsOutput\": \"None (UI only).\"\n    },\n    {\n      \"name\": \"sSectionName\",\n      \"technicalDefault\": \" \",\n      \"businessMeaning\": \"Identifies the specific drawing section (Element) to dimension. It filters elements based on the names of other TSL instances found in the drawing.\",\n      \"validRange\": \"List of available Section/Element names\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Determines which set of beams (rafters/hips) the script scans for dimensioning.\"\n    },\n    {\n      \"name\": \"genBeamFilterDefinition\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning \" \"Links to a custom filter definition from 'HSB_G-FilterGenBeams.mcr' to pre-filter the beams based on complex criteria.\",\n      \"validRange\": \"List of available Filter Definitions\",\n      \"unit\": \"Selection\",\n      \"affectsOutput\": \"Refines the selection of beams included in the dimension calculation.\"\n    },\n    {\n      \"name\": \"sFilterBC\",\n      \"technicalDefault\": \"KEG-01;HRL-01\",\n      \"businessMeaning\": \"Filters beams by their Beam Code (e.g., 'KEG' for rafters, 'HRL' for Hip/Valley). Ensures only relevant structural members are dimensioned.\",\n      \"validRange\": \"String of semicolon-separated codes (e.g., \\\"KEG-01;KK-01\\\")\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Excludes beams that do not match the specified codes from the dimension logic.\"\n    },\n    {\n      \"name\": \"sFilterLabel\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Filters beams and sheets based on their label or material designation.\",\n      \"validRange\": \"String\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Further refines the set of elements to be dimensioned.\"\n    },\n    {\n      \"name\": \"sFilterZone\",\n      \"technicalDefault\": \"1;7\",\n      \"businessMeaning\": \"Restricts dimensioning to specific construction zones (model phases or areas).\",\n      \"validRange\": \"Semicolon-separated integers (e.g., \\\"1;2\\\")\",\n      \"unit\": \"Zone Index\",\n      \"affectsOutput\": \"Prevents beams outside these zones from being included in the output.\"\n    },\n    {\n      \"name\": \"sCombineTouchingBeams\",\n      \"technicalDefault\": \"|No|\",\n      \"businessMeaning\": \"Determines if two rafters that touch end-to-end should be dimensioned as one continuous piece or separately.\",\n      \"validRange\": \"[\\\"|Yes|\\\", \\\"|No|\\\"]\",\n      \"unit\": \"Boolean\",\n      \"affectsOutput\": \"If 'Yes', it removes the dimension point between touching beams, displaying a combined length dimension.\"\n    },\n    {\n      \"name\": \"sSeperator02\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Visual grouping header for dimension settings (Read-only).\",\n      \"validRange\": \"N/A\",\n      \"unit\": \"N/A\",\n      \"affectsOutput\": \"None (UI only).\"\n    },\n    {\n      \"name\": \"sBmCodeAngledBeams\",\n      \"technicalDefault\": \"KK-01\",\n      \"businessMeaning\": \"The Beam Code for the main Hip or Valley rafter (the reference line) against which perpendicular rafters are measured.\",\n      \"validRange\": \"String representing a valid Beam Code\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Identifies the primary reference beam. If incorrect, dimensions will not calculate.\"\n    },\n    {\n      \"name\": \"sBmCodeBlocking\",\n      \"technicalDefault\": \"KS-HKS\",\n      \"businessMeaning\": \"Specifies the Beam Code for blocking or stiffeners that should be excluded from the rafter dimensioning.\",\n      \"validRange\": \"String representing a valid Beam Code\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Filters out blocking beams so they are not dimensioned as rafters.\"\n    },\n    {\n      \"name\": \"sIncludeBC\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Allows additional beams defined by custom codes to be included in the dimensioning, beyond the standard rafter codes.\",\n      \"validRange\": \"String of semicolon-separated codes\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Adds beams with these specific codes to the list of rafters to dimension.\"\n    },\n    {\n      \"name\": \"sRafterSide\",\n      \"technicalDefault\": \"|Shortest side|\",\n      \"businessMeaning\": \"Determines whether the dimension point on a rafter is taken from the shortest or longest side of its cross-section (relevant for non-square profiles).\",\n      \"validRange\": \"[\\\"|Shortest side|\\\", \\\"|Longest side|\\\"]\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"Adjusts the lateral position of the dimension tick mark on the rafter.\"\n    },\n    {\n      \"name\": \"sSideAngledBeam\",\n      \"technicalDefault\": \"|Inside|\",\n      \"businessMeaning\": \"Specifies which side of the Hip/Valley beam is used as the reference (Inside, Outside, or Extremes).\",\n      \"validRange\": \"[\\\"|Inside|\\\", \\\"|Outside|\\\", \\\"|Extremes|\\\"]\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"Shifts the zero-point of the dimensions to the inside face, outside face, or extreme edges of the angled beam.\"\n    },\n    {\n      \"name\": \"sSideElement\",\n      \"technicalDefault\": \"|Outside|\",\n      \"businessMeaning\": \"Selects whether the dimension reference plane is the interior or exterior of the roof element.\",\n      \"validRange\": \"[\\\"|Outside|\\\", \\\"|Inside|\\\"]\",\n      \"unit\": \"Option\",\n      \"affectsOutput\": \"Flips the side of the element used for projecting the dimension lines.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"Standard\",\n      \"businessMeaning\": \"Sets the AutoCAD dimension style (arrowheads, text"
      },
      "tokens_used": 10508,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization and Variable Setup",
          "Populate Section Names Dropdown based on existing TSL instances in the drawing",
          "Insert Phase: Check if _bOnInsert is true",
          "Insert Phase: Prompt user to select a Viewport",
          "Insert Phase: Prompt user to select a Position point for the instance",
          "Insert Phase: Show configuration dialog if no execute key is present",
          "Insert Phase: Erase instance after first cycle to finalize placement",
          "Update Phase: Check for valid Viewport selection stored in _Viewport",
          "Update Phase: Erase instance and exit if no viewport found",
          "Update Phase: Retrieve Viewport object and coordinate transformation (ms2ps)",
          "Update Phase: Check 'sDisableTsl' property",
          "Update Phase: If disabled, skip all drawing logic",
          "Update Phase: Collect all TSL instances in the group to find Section Names",
          "Update Phase: Iterate through TSL instances to match 'sSectionName'",
          "Update Phase: If matching TSL found, retrieve its Element handle",
          "Update Phase: Validate Element existence and retrieve associated GenBeams",
          "Update Phase: Apply Zone, Label, and BeamCode filters to GenBeams",
          "Update Phase: Apply Custom Filter definition (HSB_G-FilterGenBeams) if configured",
          "Update Phase: Check context menu triggers (Filtering vs Dimensioning)",
          "Update Phase: Branch 1 (Filter): Change colors of beams based on Element association",
          "Update Phase: Branch 2 (Dimension): Proceed to dimension calculation",
          "Dimensioning: Iterate through filtered GenBeams to find Hip/Valley (Angled) beams",
          "Dimensioning: Identify perpendicular rafters and parallel rafters relative to the element",
          "Dimensioning: Filter out blocking beams based on sBmCodeBlocking",
          "Dimensioning: Collect custom beams defined by sIncludeBC",
          "Dimensioning: Define the Dimension Plane based on element side and offsets",
          "Dimensioning: Sort rafters using vector filtering and intersection logic",
          "Dimensioning: Loop through rafters to calculate intersection points with the angled beam",
          "Dimensioning: Check if rafters are in proper contact (projection check)",
          "Dimensioning: Apply 'Combine touching beams' logic if enabled to merge points",
          "Dimensioning: Add valid points to the dimension point array",
          "Dimensioning: Calculate dimension line position and orientation in PaperSpace",
          "Dimensioning: Remove points falling outside the start/end extremes of the angled beam",
          "Dimensioning: Correct reading direction (Left-to-Right) for text alignment",
          "Dimensioning: Create DimLine and Dim entities, transform to PaperSpace, and draw",
          "Output: Draw Viewport Outline (if enabled), Name, and Description text"
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert flag state",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Erase previous instance (if cycleCount > 1)",
                "Prompt user for Viewport",
                "Prompt user for Position",
                "Show Properties Dialog",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "Update/Recalc Mode",
              "steps": [
                "Validate Viewport",
                "Check Disable Flag",
                "Execute Filtering or Dimensioning Logic"
              ]
            }
          },
          {
            "condition": "sDisableTSL property value",
            "path1": {
              "name": "Disabled",
              "steps": [
                "Script execution halts immediately after viewport check",
                "No dimensions or text are drawn"
              ]
            },
            "path2": {
              "name": "Enabled",
              "steps": [
                "Proceed with Element search",
                "Execute Beam Filtering",
                "Generate Dimensions"
              ]
            }
          },
          {
            "condition": "Context Menu Trigger (Filtering vs. Dimensioning)",
            "path1": {
              "name": "Filter Mode",
              "steps": [
                "Identify beams belonging to the current Element",
                "Change color of other elements (Gray/Invisible)",
                "Highlight current element beams"
              ]
            },
            "path2": {
              "name": "Dimension Mode (Default)",
              "steps": [
                "Identify Hip/Valley beam (Angled)",
                "Identify Perpendicular Rafters",
                "Calculate intersection points",
                "Draw dimension lines in PaperSpace"
              ]
            }
          },
          {
            "condition": "sCombineTouchingBeams Property",
            "path1": {
              "name": "Yes (Combine)",
              "steps": [
                "Compare current rafter position with last dimensioned rafter",
                "If centers align within half-width tolerance, remove previous dimension point",
                "Append new point effectively merging the two"
              ]
            },
            "path2": {
              "name": "No (Individual)",
              "steps": [
                "Append a dimension point for every valid beam intersection found"
              ]
            }
          },
          {
            "condition": "sSideAngledBeam Property",
            "path1": {
              "name": "Inside/Outside",
              "steps": [
                "Calculate dimension start/end points based on the inside or outside face of the angled beam"
              ]
            },
            "path2": {
              "name": "Extremes",
              "steps": [
                "Calculate dimension start/end points based on the extreme geometric ends of the angled beam body"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "N/A (Script automatically erases instance)",
            "recovery": "User must re-insert the script and select a valid viewport."
          },
          {
            "check": "Element/Section Name Match",
            "errorMessage": "Silent failure (No dimensions drawn)",
            "recovery": "User must ensure 'Name element section' matches a valid TSL script name present in the drawing layout."
          },
          {
            "check": "Beam Codes and Filters",
            "errorMessage": "No dimensions drawn (0 beams found)",
            "recovery": "User must verify 'Filter beams with beamcode', 'Beamcode angled beams', and Zone settings match the actual model data."
          },
          {
            "check": "Spatial Intersection (Contact)",
            "errorMessage": "Specific rafters omitted from dimensions",
            "recovery": "User must ensure rafters physically touch the hip/valley beam or adjust 'Side element' / 'Side of rafters' settings."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Target Element",
            "how": "OPM Property: 'Name element section'",
            "effect": "Script switches context to dimension beams belonging to a different Element/Section."
          },
          {
            "action": "Filter Beam Selection",
            "how": "OPM Properties: 'Filter beams...', 'Beamcode angled beams', 'Filter definition for GenBeams'",
            "effect": "Updates the list of beams included in the dimension calculation dynamically."
          },
          {
            "action": "Adjust Dimension Geometry",
            "how": "OPM Properties: 'Offset dimline...', 'Side of angled beam', 'Dimension layout'",
            "effect": "Moves dimension lines, flips reference sides, or changes between Delta/Cumulative styles."
          },
          {
            "action": "Toggle Visibility Filters",
            "how": "Right-click Context Menu: '|Filter this element|' or '|Remove filter...|'",
            "effect": "Isolates the current element's beams visually, hiding others to reduce clutter."
          },
          {
            "action": "Toggle Combination of Touching Beams",
            "how": "OPM Property: 'Combine touching beams'",
            "effect": "Switches between dimensioning rafters individually or as continuous runs."
          }
        ]
      },
      "tokens_used": 11396,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_D-HipAndValley.mcr\n\n## Overview\nAutomates the dimensioning of hip and valley rafter intersections in 2D shop drawings. It calculates the precise offsets and positions of perpendicular (jack) rafters relative to the main angled beam based on your current viewport view.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed for detailing. |\n| Paper Space | Yes | Script requires a selected Viewport to calculate dimensions. |\n| Shop Drawing | Yes | Specifically designed for creating production layout drawings. |\n\n## Prerequisites\n- **Required Entities**: `GenBeam` (Rafters/Hips), `Element` (Building sections).\n- **Minimum Beam Count**: At least 1 main Hip/Valley beam and 1 intersecting rafter.\n- **Required Settings**: A valid Viewport must be present in the Paper Space layout.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_D-HipAndValley.mcr`\n\n### Step 2: Select Viewport\n```\nCommand Line: |Select a viewport|\nAction: Click inside the viewport border where you want the dimensions to appear.\n```\n\n### Step 3: Select Position\n```\nCommand Line: |Select a position|\nAction: Click a location in the drawing to place the script instance (usually near the hip/valley to be dimensioned).\n```\n\n### Step 4: Configure Properties\nAfter placement, select the script instance and open the **Properties Palette** (Ctrl+1). Select the **Name element section** corresponding to the roof area you wish to dimension.\n\n## Properties Panel Parameters\n\n### Selection Settings\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Name element section | dropdown | (empty) | Select the specific Element/Section name to dimension. |\n| Filter definition for GenBeams | dropdown | (empty) | Apply a custom filter preset from `HSB_G-FilterGenBeams.mcr`. |\n| Filter beams with beamcode | text | KEG-01;HRL-01 | Semicolon-separated list of Beam Codes to include (e.g., Rafters, Hips). |\n| Filter beams and sheets with label or material | text | (empty) | Further filter elements by material name or label. |\n| Filter zones | text | 1;7 | Restrict dimensioning to specific model zones (e.g., \"1;2\"). |\n| Combine touching beams | dropdown | No | If **Yes**, rafters touching end-to-end are dimensioned as one continuous length. |\n\n### Dimensioning Settings\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Beamcode angled beams | text | KK-01 | The Beam Code identifying the main Hip or Valley rafter (reference line). |\n| Beamcode blocking | text | KS-HKS | The Beam Code for blocking/stiffeners to exclude from dimensioning. |\n| Include BC | text | (empty) | Additional Beam Codes to force-include in the dimensioning. |\n| Side of rafters | dropdown | Shortest side | Determines if dimension ticks are on the shortest or longest side of the rafter profile. |\n| Side of angled beam | dropdown | Inside | Reference point for dimensions: Inside face, Outside face, or Extremes. |\n| Side element | dropdown | Outside | Reference side of the roof element for projecting dimensions. |\n| DimStyle | dropdown | Standard | The AutoCAD dimension style to use for the generated lines. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Filter this element | Isolates the beams belonging to the current element section by graying out others. |\n| Remove filter | Restores visibility of all beams in the view. |\n| Recalculate | Refreshes the dimensions based on current property settings or model changes. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams.mcr`\n- **Location**: hsbCAD TSL folder (Company or Install path)\n- **Purpose**: Provides the list of available filter definitions used in the \"Filter definition for GenBeams\" property.\n\n## Tips\n- **View Orientation**: Ensure the viewport selected in Step 2 shows the roof from the correct direction (e.g., Plan view or perpendicular elevation) to get accurate intersection points.\n- **Beam Codes**: If dimensions are missing, verify that the `Beamcode angled beams` matches your actual Hip/Valley beam codes in the model.\n- **Combined Dimensions**: Use **Combine touching beams** set to **Yes** to avoid cluttering the drawing with small dimension segments for continuous rafters.\n- **Filtering**: Use the right-click \"Filter this element\" option to quickly check if the script is identifying the correct set of beams before generating dimensions.\n\n## FAQ\n- **Q: I ran the script, but no dimensions appeared.**\n  - **A**: Check the following:\n    1. Did you select a valid Viewport during insertion?\n    2. Does the \"Name element section\" property match an existing TSL instance name in the drawing?\n    3. Do the \"Filter beams with beamcode\" settings actually match the codes in your model?\n- **Q: The dimensions are on the wrong side of the beam.**\n  - **A**: Change the \"Side of angled beam\" property (e.g., switch from **Inside** to **Outside**).\n- **Q: The dimension line is too close/far from the beams.**\n  - **A**: Adjust the \"Offset dimline...\" properties (not listed in table but available in the full property list) to move the dimension line away from the geometry.\n- **Q: Some rafters are missing from the dimension.**\n  - **A**: Check if \"Beamcode blocking\" is excluding a rafter by mistake, or if the \"Filter zones\" is restricting the area."
      },
      "tokens_used": 7959,
      "error": null
    }
  }
}