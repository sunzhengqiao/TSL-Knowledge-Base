{
  "filename": "hsb_Battens.mcr",
  "status": "completed",
  "total_tokens": 49077,
  "processing_time": 220.73542618751526,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9248,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script manipulates 3D ElementWall entities, creates 3D Sheets using sh.dbCreate, and processes Openings within a 3D coordinate system. No usage of Viewport, sd_* prefixes, or 2D drawing generation logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall",
            "Opening"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 6890,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion (if no execute key) or MapIO",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sYesNoExtraBattensAboveOpening",
            "type": "PropString",
            "displayName": "|Create extra battens above opening|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "sYesNoExtraBattensBelowOpening",
            "type": "PropString",
            "displayName": "|Create extra battens below opening|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dSideGap",
            "type": "PropDouble",
            "displayName": "|Side Gap|",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dZoneToExclude",
            "type": "PropInt",
            "displayName": "|Zone index to exclude|",
            "defaultValue": "0",
            "inputType": "integer",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "dGapTop",
            "type": "PropDouble",
            "displayName": "|Top|",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "|Vertical batten Gap|",
            "description": "|Defines the Top Gap of the Batten|"
          },
          {
            "index": 2,
            "variable": "dGapBottom",
            "type": "PropDouble",
            "displayName": "|Bottom|",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "|Vertical batten Gap|",
            "description": "|Defines the Bottom Gap of the Batten|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8932,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates structural timber battens (noggings/jack studs) around openings in wall elements to support sheathing or cladding where standard sheet layout leaves unsupported edges.",
          "category": "Framing",
          "typicalUseCase": "Used during wall panel design to ensure vertical sheet joints and opening perimeters have adequate backing for fixing plasterboard or plywood."
        },
        "parameters": [
          {
            "name": "sYesNoExtraBattensAboveOpening",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Controls whether vertical 'jack' battens are created in the top corners of the opening (above the header).",
            "validRange": "Yes/No",
            "unit": "Selection",
            "affectsOutput": "If Yes, generates vertical battens in the top-left and top-right corners. If No, these corners remain without extra vertical backing."
          },
          {
            "name": "sYesNoExtraBattensBelowOpening",
            "technicalDefault": "|Yes|",
            "businessMeaning": "Controls whether vertical 'jack' battens are created in the bottom corners of the opening (below the sill).",
            "validRange": "Yes/No",
            "unit": "Selection",
            "affectsOutput": "If Yes, generates vertical battens in the bottom-left and bottom-right corners. If No, these corners remain without extra vertical backing."
          },
          {
            "name": "dSideGap",
            "technicalDefault": "0.0",
            "businessMeaning": "Sets the horizontal clearance distance between the opening jambs and the side battens.",
            "validRange": "0 - 100 mm",
            "unit": "mm",
            "affectsOutput": "Offsets the horizontal battens running alongside the opening. Provides space for window reveal liners or expansion."
          },
          {
            "name": "dZoneToExclude",
            "technicalDefault": "0",
            "businessMeaning": "Identifies a specific wall layer (Zone) index to skip batten generation.",
            "validRange": "Integer (e.g., 1, 2, -1; 0 = none excluded)",
            "unit": "Index",
            "affectsOutput": "Stops the script from creating any battens on the specified wall layer."
          },
          {
            "name": "dGapTop",
            "technicalDefault": "0.0",
            "businessMeaning": "Defines a vertical cutout or gap at the top edge of the vertical battens.",
            "validRange": "0 - 500 mm",
            "unit": "mm",
            "affectsOutput": "Subtracts a rectangular area from the top of the generated vertical battens. Used to avoid structural beams or provide service clearance."
          },
          {
            "name": "dGapBottom",
            "technicalDefault": "0.0",
            "businessMeaning": "Defines a vertical cutout or gap at the bottom edge of the vertical battens.",
            "validRange": "0 - 500 mm",
            "unit": "mm",
            "affectsOutput": "Subtracts a rectangular area from the bottom of the generated vertical battens. Used to avoid floor plates or sills."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sYesNoExtraBattensAboveOpening = No",
            "effect": "Suppresses creation of top corner vertical battens regardless of gap settings.",
            "cascade": [
              "dGapTop"
            ]
          },
          {
            "trigger": "sYesNoExtraBattensBelowOpening = No",
            "effect": "Suppresses creation of bottom corner vertical battens regardless of gap settings.",
            "cascade": [
              "dGapBottom"
            ]
          },
          {
            "trigger": "dZoneToExclude set to active Zone index",
            "effect": "Prevents all geometry generation for that specific wall layer.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Sheet",
            "description": "3D timber battens (rectangular solids) assigned to specific wall zones.",
            "appliedTo": "ElementWall"
          }
        ]
      },
      "tokens_used": 7952,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Start",
          "Check if `_bOnInsert` (Insertion Mode)",
          "If Insertion: Check `insertCycleCount` (must be 1, else erase)",
          "Check for ExecuteKey (_kExecuteKey)",
          "If ExecuteKey exists: Load Properties from Catalog",
          "If no ExecuteKey: Show Properties Dialog (showDialog)",
          "Prompt user to select Element(s) (PrEntity)",
          "Loop through selected elements",
          "Clone TSL instance to each selected Element (dbCreate)",
          "Erase original instance",
          "Script End (Insertion Phase)",
          "Validation Phase: Check if Element exists (length >= 1)",
          "Validate Element is of type ElementWall",
          "Check if ExecuteKey is 'ManualInsert' or Construct/Debug event",
          "Get Element Openings and GenBeams",
          "Validate GenBeams exist (length >= 1)",
          "Loop through defined Zones (1, 2, 3, 4, 5, -1, -2, -3, -4, -5)",
          "Check Zone Distribution Code (must be 'HSB-PL09')",
          "Check Zone Exclusion Property (skip if matches dZoneToExclude)",
          "Calculate Geometry for specific Zone (Width, Thickness, Coordinate System)",
          "Loop through all Openings in the Wall",
          "Calculate Opening Corners and apply Side Gap (dSideGap)",
          "Generate Horizontal Battens (Header/Sill) if gaps exist (Top/Bottom)",
          "Check Property 'Create extra battens above opening'",
          "If Yes: Generate Top Left/Right Vertical Battens (Jack Studs)",
          "Check Property 'Create extra battens below opening'",
          "If Yes: Generate Bottom Left/Right Vertical Battens (Jack Studs)",
          "Apply Top/Bottom Gaps (dGapTop/dGapBottom) to Vertical Battens and modify existing sheets if intersecting",
          "Filter created Battens by Minimum Area (approx 9 sqmm/U(3)*U(3))",
          "Merge new Battens with existing Zone Sheets",
          "Erase original overlapping sheets and replace with merged geometry",
          "If ExecuteKey matches or Constructed: Erase Instance",
          "Script Finish"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Invocation Mode",
            "path1": {
              "name": "Insertion Mode (_bOnInsert)",
              "steps": [
                "Validate insert cycle",
                "Load props from Catalog or Dialog",
                "Select Elements",
                "Clone instance to Elements",
                "Exit"
              ]
            },
            "path2": {
              "name": "Execution Mode (Calculation)",
              "steps": [
                "Validate attached Element",
                "Calculate Battens",
                "Create/Modify Geometry",
                "Clean up instance if required"
              ]
            }
          },
          {
            "condition": "ExecuteKey Presence on Insertion",
            "path1": {
              "name": "Key Found",
              "steps": [
                "Load properties from Catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "No Key",
              "steps": [
                "Show Properties Dialog",
                "Load properties from User Input"
              ]
            }
          },
          {
            "condition": "Zone Exclusion Setting",
            "path1": {
              "name": "Zone Excluded",
              "steps": [
                "Skip calculations for this Zone index",
                "Continue to next Zone"
              ]
            },
            "path2": {
              "name": "Zone Active",
              "steps": [
                "Proceed with Batten Generation"
              ]
            }
          },
          {
            "condition": "Extra Battens Properties (Above/Below)",
            "path1": {
              "name": "Yes (Create)",
              "steps": [
                "Calculate Corner Geometry",
                "Apply Top/Bottom Gaps",
                "Create Vertical Sheet Battens"
              ]
            },
            "path2": {
              "name": "No (Skip)",
              "steps": [
                "Do not generate Corner Vertical Battens"
              ]
            }
          },
          {
            "condition": "Batten Area Calculation",
            "path1": {
              "name": "Area > Threshold",
              "steps": [
                "Create Batten Geometry"
              ]
            },
            "path2": {
              "name": "Area <= Threshold",
              "steps": [
                "Skip Creation (too small)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Internal)",
            "recovery": "Automatically erases instance if count > 1"
          },
          {
            "check": "Element Selection",
            "errorMessage": "|Element reference not found.|",
            "recovery": "Script erases instance; user must re-run and select valid wall."
          },
          {
            "check": "Element Type Validity",
            "errorMessage": "|Element not valid|.",
            "recovery": "Script erases instance; user must select ElementWall."
          },
          {
            "check": "GenBeams Existence",
            "errorMessage": "|No genbeams found|.",
            "recovery": "Script erases instance; user must ensure wall has generated framing."
          },
          {
            "check": "Side Gap Value",
            "errorMessage": "None (Internal)",
            "recovery": "Automatically sets negative values to 0."
          },
          {
            "check": "Zone Distribution Code",
            "errorMessage": "None (Internal)",
            "recovery": "Skips zone if not 'HSB-PL09' (Vertical Sheets)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Batten Configuration",
            "how": "OPM Properties Palette",
            "effect": "Changing properties (e.g., sYesNoExtraBattensAboveOpening, dSideGap) and updating the script recalculates the batten geometry."
          },
          {
            "action": "Update Geometry",
            "how": "Context Menu 'Update' or Automatic Recalculation",
            "effect": "Re-runs the logic, recreating battens based on current wall state and properties."
          },
          {
            "action": "Change Wall Geometry",
            "how": "Modify Wall/Opening dimensions",
            "effect": "Script regenerates battens to fit new opening shapes and positions (if AutoUpdate is enabled or triggered)."
          },
          {
            "action": "Delete Script",
            "how": "Erase Command",
            "effect": "Removes the generated battens (logic indicates clean-up, though specific deletion dependency might vary based on hsbCAD version/association)."
          }
        ]
      },
      "tokens_used": 9869,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_Battens.mcr\n\n## Overview\nGenerates structural timber battens (noggings/jack studs) around openings in wall elements. This script provides additional backing for sheathing or cladding where standard sheet layouts leave unsupported edges, specifically targeting vertical zones.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script manipulates 3D ElementWall entities. |\n| Paper Space | No | Not intended for 2D drawing generation. |\n| Shop Drawing | No | Operates in the 3D model environment. |\n\n## Prerequisites\n- **Required Entities**: An existing `ElementWall` containing openings.\n- **Minimum Beam Count**: The wall must contain generated GenBeams (framing) before running this script.\n- **Required Settings**: None (Script relies on internal wall zone distribution codes).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse to and select `hsb_Battens.mcr`.\n\n### Step 2: Configure Properties (Optional)\n*   If the script is run without a predefined configuration key, a properties dialog (or the AutoCAD Properties Palette) will appear.\n*   Set options such as side gaps or whether to create extra battens above/below openings.\n\n### Step 3: Select Wall Elements\n```\nCommand Line: Select element(s)\nAction: Click on the wall(s) you wish to process and press Enter.\n```\n\n### Step 4: Processing\n*   The script automatically attaches to the selected walls.\n*   It scans for wall zones marked as 'HSB-PL09' (Vertical Sheets).\n*   It calculates geometry around openings and creates or merges the batten sheets.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Create extra battens above opening** | Dropdown | Yes | If Yes, generates vertical battens in the top-left and top-right corners of the opening. |\n| **Create extra battens below opening** | Dropdown | Yes | If Yes, generates vertical battens in the bottom-left and bottom-right corners of the opening. |\n| **Side Gap** | Number | 0.0 mm | Sets the horizontal clearance distance between the opening jambs and the side battens. |\n| **Zone index to exclude** | Integer | 0 | Identifies a specific wall layer index to skip (0 = process all layers). |\n| **Top** (Vertical batten Gap) | Number | 0.0 mm | Defines a vertical cutout/gap at the top edge of the vertical battens. |\n| **Bottom** (Vertical batten Gap) | Number | 0.0 mm | Defines a vertical cutout/gap at the bottom edge of the vertical battens. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Update** | Recalculates the batten geometry based on current wall properties or opening changes. |\n| **Properties** | Opens the Properties Palette to edit parameters like gaps and exclusions. |\n| **Erase** | Removes the script instance and the generated battens. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not require external settings files; it uses properties stored in the drawing.\n\n## Tips\n- **Framing First**: Ensure your wall has generated GenBeams (studs/plates) before running this script. If the script reports \"No genbeams found,\" generate the wall framing first.\n- **Reveal Liners**: Use the **Side Gap** property to create space for window or door reveal liners so the battens do not interfere with finish carpentry.\n- **Floor Plate Clearances**: Use the **Top** and **Bottom** gap properties under the \"Vertical batten Gap\" category to cut the battens so they do not overlap with top or bottom plates.\n- **Layer Control**: If you only want battens on the structural layer and not the insulation layer, check your Zone Index in the wall composition and set **Zone index to exclude** to match the insulation layer index.\n\n## FAQ\n\n**Q: Why did the script disappear immediately after I selected the wall?**\nA: This usually happens if the wall has no generated framing (\"No genbeams found\") or if the selected element is not a valid `ElementWall`. Generate the wall framing and try again.\n\n**Q: The script created battens, but they are too short/tall.**\nA: Check the **Top** and **Bottom** properties in the \"Vertical batten Gap\" category. These values subtract length from the batten ends.\n\n**Q: Can I run this on multiple walls at once?**\nA: Yes. When prompted to \"Select element(s)\", you can select multiple walls, and the script will instance itself onto all of them."
      },
      "tokens_used": 6186,
      "error": null
    }
  }
}