{
  "filename": "hsb_FrameNail.mcr",
  "status": "completed",
  "total_tokens": 29221,
  "processing_time": 958.4980390071869,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 6343,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses getBeam() and Element interaction in 3D. Creates ElemItem attached to Element (el.addTool). Display index is -1 (Model Space). No sd_ prefix or viewport logic found."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Catalog entry for property initialization (setPropValuesFromCatalog)"
          ]
        }
      },
      "tokens_used": 3919,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialogOnce",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": "Pick a Point",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getBeam",
              "promptOriginal": "Select Female Beam",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 4,
              "function": "getBeam",
              "promptOriginal": "Select Male Beam",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Catalog/Defaults",
            "trigger": "On Insert",
            "title": null,
            "dataSource": "Catalog (setPropValuesFromCatalog)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "prIndexes",
            "type": "PropInt",
            "displayName": "Nail Indexes",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "Catalog",
            "searchPaths": [
              "_kExecuteKey"
            ],
            "purpose": "Initializes property values based on the selected catalog entry on insert.",
            "required": true
          }
        ]
      },
      "tokens_used": 3757,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates and defines the connection point for a framing nail (nailing bridge) between a wall plate and a stud, specifically designed to handle the geometric offsets required for L-shaped studs in timber framing.",
          "category": "Hardware/Framing",
          "typicalUseCase": "Used when detailing wall panels to ensure automatic nailing or bridging hardware is correctly positioned relative to the stud face, accounting for the 'flange' of L-studs."
        },
        "parameters": [
          {
            "name": "prIndexes",
            "technicalDefault": 0,
            "businessMeaning": "An identifier code for the nail connection used in manufacturing exports (e.g., BTL) to link the 3D location to specific tooling or machine instructions.",
            "validRange": "Integer (0 - 1000)",
            "unit": "Index",
            "affectsOutput": "Updates the 'INDEX' field in the output map; does not change the physical position of the connection point, only its data identity."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selection of Male Beam (L-Stud geometry)",
            "effect": "Determines if the beam is an 'L Stud Opp' type. If true, the reference point is offset from the right face of the stud; if false, it is offset from the left face.",
            "cascade": [
              "ptCDTNailPosition",
              "ElemItem map"
            ]
          },
          {
            "trigger": "Insertion via Catalog",
            "effect": "Initializes the `prIndexes` property based on the selected catalog configuration.",
            "cascade": [
              "prIndexes"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElemItem",
            "description": "Creates a hidden data entity 'HSB_FRAMENAIL' attached to the wall element containing the calculated nail coordinate, orientation, and associated beam handle.",
            "appliedTo": "Element (Parent of the selected Female Beam)"
          },
          {
            "type": "ModelSpace Visualization",
            "description": "Draws a crosshair and vertical vector in 3D space to indicate the calculated nail location and direction.",
            "appliedTo": "ModelSpace"
          }
        ]
      },
      "tokens_used": 3918,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "User executes script (e.g., insert command).",
          "[Insert Cycle Check] If insertCycleCount > 1, erase instance and exit. Else, continue.",
          "Properties initialized from Catalog entry specified by _kExecuteKey.",
          "Dialog 'showDialogOnce' appears.",
          "Command prompt: Pick a Point (Defines nail location).",
          "Command prompt: Select Female Beam (The wall plate/header).",
          "Command prompt: Select Male Beam (The stud).",
          "Script validates inputs (Beam count and validity).",
          "[Recalculation/Update Mode] If script is running on update (not insert): Retrieve Element and Female Beam properties.",
          "Check if map 'Reference' exists in _Map.",
          "[Branch A - Map exists] Retrieve ptCDTNailPosition and vy vector directly from _Map.",
          "[Branch B - Map missing] Calculate geometry based on Male Beam and Element configuration.",
          "Determine L-Stud Orientation: Analyze Male Beam module to detect 'L Stud Opp' configuration.",
          "Calculate Reference Point: Offset nail position based on L-Stud detection (Left face or Right face offset).",
          "Construct CoordSys for the nail orientation.",
          "Draw visual indicators (Crosshair and Vector) in ModelSpace.",
          "Construct Map with INDEX, VERSION, POINTS, and Beam Handles.",
          "Create ElemItem 'HSB_FRAMENAIL' and attach to Element.",
          "Assign script instance to Element Group.",
          "Lock 'prIndexes' property to read-only."
        ],
        "conditionalBranches": [
          {
            "condition": "Check for existing Reference Map",
            "path1": {
              "name": "Reference Found",
              "steps": [
                "Retrieve 'vy' vector from _Map.",
                "Retrieve 'Reference' point from _Map.",
                "Use retrieved data directly for CDT position (Skip calculation logic)."
              ]
            },
            "path2": {
              "name": "Reference Missing (Calculate)",
              "steps": [
                "Validate exactly 2 beams are selected (Female + Male).",
                "Get Male Beam module.",
                "Compare Male Beam dimensions (dD(vx) vs dD(vz)).",
                "Detect 'L Stud Opp' by checking for neighbor beams in -vx direction within the module.",
                "Calculate offset based on type (nLStudOpp ? Right Face Offset : Left Face Offset).",
                "Determine ptCDTNailPosition."
              ]
            }
          },
          {
            "condition": "Script Execution Mode",
            "path1": {
              "name": "Insert Mode (_bOnInsert)",
              "steps": [
                "Cycle check (erase if duplicate).",
                "Show Dialog.",
                "Prompt for Point.",
                "Prompt for Female Beam.",
                "Prompt for Male Beam.",
                "Return."
              ]
            },
            "path2": {
              "name": "Calculation/Update Mode",
              "steps": [
                "Validate existing beams array (must have at least 1).",
                "Check validity of Female Beam.",
                "Execute geometry calculation or Map retrieval.",
                "Update Element and ModelSpace."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Silent exit)",
            "recovery": "N/A (System prevents duplicate insertions)"
          },
          {
            "check": "Beam Array Length (on Update)",
            "errorMessage": "None (Silent eraseInstance)",
            "recovery": "Ensure the Element associated with the script still contains the beams."
          },
          {
            "check": "Female Beam Validity",
            "errorMessage": "None (Silent eraseInstance)",
            "recovery": "Ensure the Female Beam has not been deleted or corrupted."
          },
          {
            "check": "Element Validity",
            "errorMessage": "Notice: 'Invalid element found!'",
            "recovery": "Check if the Element associated with the Female Beam is valid."
          },
          {
            "check": "Beam Count (on Calculation without Map)",
            "errorMessage": "None (Silent eraseInstance)",
            "recovery": "Requires both Female and Male beams (Total 2) to calculate geometry if Map is missing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit 'Nail Indexes' Property",
            "how": "OPM (Object Properties Manager)",
            "effect": "Updates the 'INDEX' value in the 'HSB_FRAMENAIL' ElemItem map for manufacturing/export data."
          },
          {
            "action": "Modify Element Geometry (e.g., move wall/beam)",
            "how": "Grip Edit / Move Command",
            "effect": "Triggers script recalculation. The visual indicator and 'HSB_FRAMENAIL' data point update position relative to the new beam geometry. The script attempts to re-calculate the reference point unless a fixed Map was provided by another process."
          },
          {
            "action": "Delete Beams",
            "how": "Erase Command",
            "effect": "Script detects invalid/missing beams, executes eraseInstance(), and removes itself."
          }
        ]
      },
      "tokens_used": 5619,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_FrameNail.mcr\n\n## Overview\nThis script defines the connection point for a framing nail (nailing bridge) between a wall plate and a stud. It automatically calculates the geometric offsets required for L-shaped studs to ensure correct positioning for manufacturing data.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates in 3D model space to attach data to elements. |\n| Paper Space | No | Not designed for layout or detailing views. |\n| Shop Drawing | No | Script is for 3D model detailing only. |\n\n## Prerequisites\n- **Required Entities:** \n  - One Wall Plate or Header (Female Beam)\n  - One Stud (Male Beam)\n  - A parent Wall Element containing these beams\n- **Minimum Beam Count:** 2 (One Female, One Male)\n- **Required Settings:** \n  - A Catalog entry must exist to initialize default properties (referenced by `_kExecuteKey`).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Browse and select `hsb_FrameNail.mcr` from the script list.\n\n### Step 2: Configuration\n**Interface:** Catalog / Defaults Dialog\n**Action:** Confirm the default configuration settings loaded from the catalog (sets the initial Index values).\n\n### Step 3: Define Location\n```\nCommand Line: Pick a Point\nAction: Click in the drawing to specify the desired location for the nail connection.\n```\n\n### Step 4: Select Wall Plate\n```\nCommand Line: Select Female Beam\nAction: Click on the wall plate or header beam that will receive the nail.\n```\n\n### Step 5: Select Stud\n```\nCommand Line: Select Male Beam\nAction: Click on the stud that the connection references. The script will automatically detect if this is an L-stud to calculate the correct offset.\n```\n\n### Step 6: Completion\nThe script will draw a crosshair and vertical vector at the calculated location in Model Space and attach the necessary data to the wall element.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Nail Indexes | Number | 0 | An identifier code for the nail connection used in manufacturing exports (e.g., BTL) to link the 3D location to specific tooling or machine instructions. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | No custom context menu items are defined. The script updates automatically when geometry changes. |\n\n## Settings Files\n- **Filename:** Catalog Entry (referenced by `_kExecuteKey`)\n- **Location:** Defined in your hsbCAD Catalog paths\n- **Purpose:** Initializes property values (such as the default Nail Index) when the script is first inserted.\n\n## Tips\n- **Visual Indicators:** Look for the crosshair and vertical line drawn in the 3D model; this indicates exactly where the nail point is calculated.\n- **L-Studs:** You do not need to manually calculate offsets for L-shaped studs. The script analyzes the stud geometry and adjusts the reference point to the correct face (Left or Right) automatically.\n- **Updates:** If you move the wall or adjust the beam sizes using grips, the nail position and data will update automatically to match the new geometry.\n- **Export Data:** Remember to set the \"Nail Indexes\" property correctly if your downstream machinery requires specific codes for different nail types.\n\n## FAQ\n- **Q: What happens if I delete the wall plate or stud?**\n  - A: The script detects that the required beams are missing and automatically deletes itself to prevent errors.\n- **Q: Can I move the nail point after insertion?**\n  - A: The script calculates the position based on the beam geometry. To move the nail, you should modify the beam positions or sizes. The script will then recalculate the location.\n- **Q: I don't see the nail point in my drawings.**\n  - A: The script draws indicators in Model Space. Ensure you are looking at the correct location in 3D and that layers are turned on. The primary output is data attached to the element for manufacturing, rather than a 2D linework symbol."
      },
      "tokens_used": 5665,
      "error": null
    }
  }
}