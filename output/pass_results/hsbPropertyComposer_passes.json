{
  "filename": "hsbPropertyComposer.mcr",
  "status": "completed",
  "total_tokens": 33160,
  "processing_time": 2220.4609220027924,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [
          {
            "version": "1.4",
            "date": "05.06.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22203 debug bugfix"
          },
          {
            "version": "1.3",
            "date": "04.06.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22203 replacement strings added"
          },
          {
            "version": "1.2",
            "date": "08.05.2024",
            "author": "Thorsten Huck",
            "changes": "HSB-22051 accepting definitions without replacements"
          },
          {
            "version": "1.1",
            "date": "26.04.2022",
            "author": "Thorsten Huck",
            "changes": "HSB-15331 bugfix replacing values"
          },
          {
            "version": "1.0",
            "date": "01Oct2018",
            "author": "thorsten.huck@hsbc.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6128,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script processes GenBeam entities via _GenBeam and uses PrEntity prompts. No sd_* prefixes, #Type E definitions, or Viewport handling found. The eraseInstance() call at the end indicates a utility script modifying existing model data rather than generating layout views."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing General Beams to modify properties.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3324,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select entity(s) |<Enter> to insert setup instance|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getPoint",
              "promptOriginal": null,
              "condition": "_GenBeam.length()<1 && _bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getGenBeam",
              "promptOriginal": null,
              "condition": "_GenBeam.length()<1 && _bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert && _kExecuteKey.length()==0",
            "title": null,
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFormat",
            "type": "PropString",
            "displayName": "Format",
            "defaultValue": "@(Name)",
            "inputType": "text",
            "options": [],
            "category": "Source",
            "description": "Defines the format of the composed value.|Samples|   @(Label)@(SubLabel)|   @(Label:L2) |the first two characters of Label||   @(Label:T1; |the second part of Label if value is separated by blanks, i.e. 'EG AW 2' will return AW'|)||   @(Width:RL1) |the rounded value of width with one decimal.||R |Right: Takes the specified number of characters from the right of the string.||L |Left: Takes the specified number of characters from the left of the string.||S |SubString: Given one number will take all characters starting at the position (zero based).| |Given two numbers will start at the first number and take the second number of characters.||T |​Tokeniser: Returns the member of a delimited list using the specified index (zero based). A delimiter can be specified as an optional parameter with the default delimiter being the semcolon character..||# |Rounds a number. Specify the number of decimals to round to. Trailing zero's are removed.||RL |​Round Local: Rounds a number using the local regional settings..|"
          },
          {
            "index": 1,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Property(s)",
            "defaultValue": "Erase",
            "inputType": "dropdown",
            "options": [
              "Erase",
              "Keep"
            ],
            "category": "Source",
            "description": "Defines whether the source properties are kept or cleared."
          },
          {
            "index": 2,
            "variable": "sProperty",
            "type": "PropString",
            "displayName": "Property",
            "defaultValue": "Name",
            "inputType": "dropdown",
            "options": [
              "Name",
              "Material",
              "Information",
              "Label",
              "Grade",
              "Sublabel",
              "Sublabel2"
            ],
            "category": "Target",
            "description": "Defines the property to be modified."
          },
          {
            "index": 3,
            "variable": "sReplace",
            "type": "PropString",
            "displayName": "Replace",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "Target",
            "description": "Defines the replacement of characters.| |Empty = no replacement| |Separate source and target by a semicolon.|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5340,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Composes a new property value for selected beams by extracting, formatting, and combining existing attributes (like dimensions or labels). It acts as a data management utility to rename or re-label elements based on their current properties.",
          "category": "Data Management / Utility",
          "typicalUseCase": "Automating the creation of naming conventions, such as combining a Room Code and a Wall Label into the beam's 'Name' field, or formatting specific dimensions into the 'Information' field for production lists."
        },
        "parameters": [
          {
            "name": "sFormat",
            "technicalDefault": "@(Name)",
            "businessMeaning": "The template string used to construct the new value. It pulls data from existing beam properties (e.g., @(Width), @(Label)) and applies formatting rules (e.g., truncation, rounding, substring extraction).",
            "validRange": "Text string containing @(PropertyName) with optional format specifiers (e.g., @(Label:L2), @(Width:RL1)).",
            "unit": "String",
            "affectsOutput": "Determines the resulting text string. If 'sMode' is 'Erase', the properties referenced here are also removed from the beam."
          },
          {
            "name": "sMode",
            "technicalDefault": "Erase",
            "businessMeaning": "Determines the fate of the source properties used in the Format string. 'Erase' removes the source fields after composing the target, effectively migrating data. 'Keep' copies the data, leaving the sources intact.",
            "validRange": "Erase, Keep",
            "unit": "Enumeration",
            "affectsOutput": "If 'Erase', source properties found in 'sFormat' are cleared. This changes the data schema of the beam."
          },
          {
            "name": "sProperty",
            "technicalDefault": "Name",
            "businessMeaning": "The destination field on the beam where the newly composed string will be written.",
            "validRange": "Name, Material, Information, Label, Grade, Sublabel, Sublabel2",
            "unit": "Enumeration",
            "affectsOutput": "Updates the specific attribute of the GenBeam. This changes how the beam is identified or listed in reports and drawings."
          },
          {
            "name": "sReplace",
            "technicalDefault": "",
            "businessMeaning": "A find-and-replace list to sanitize or adjust the final composed string. It allows swapping specific characters or text (e.g., replacing spaces with underscores).",
            "validRange": "Text string in the format 'source;target'. Multiple pairs are separated by semicolons, parsed sequentially.",
            "unit": "String",
            "affectsOutput": "Performs text substitution on the final string before it is written to the target property."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMode set to 'Erase'",
            "effect": "The script analyzes 'sFormat' to identify which source properties (e.g., Name, Material) were used. Those specific properties are then cleared on the beam.",
            "cascade": [
              "sFormat"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Property Update",
            "description": "Updates the text attributes of existing GenBeams. No physical geometry or machining is generated.",
            "appliedTo": "Selected General Beams (_GenBeam)"
          }
        ]
      },
      "tokens_used": 5577,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Execution Started",
          "Check _bOnInsert flag (True on first run)",
          "Check for Execute Key (_kExecuteKey) to load Catalog settings",
          "[Branch] If Execute Key exists: Load properties from Catalog (matching key or LastInserted)",
          "[Branch] If no Execute Key: Open Properties Dialog (showDialog) for user input",
          "Prompt user to Select Entities (PrEntity)",
          "[Branch] If Entities Selected: Store in _GenBeam array",
          "[Branch] If No Entities Selected: Prompt for Point (getPoint) and Single GenBeam (getGenBeam), set Map 'setup' to 1",
          "End Insertion Phase (return)",
          "Execution Phase: Read Map 'setup' status",
          "Determine Target Property Index (sProperty)",
          "Determine Mode Index (sMode: Erase vs Keep)",
          "Loop through all GenBeams in _GenBeam array",
          "Generate Formatted String (sValue) from sFormat",
          "Process Replacement Strings (sReplace) via tokenization and find/replace",
          "Determine if modification occurred (bModify)",
          "[Branch] Check 'setup' status (True if single beam selected via point, False otherwise)",
          "[Branch] If 'setup' is True (Visual Preview): Display transformation (Source -> Target) and current settings in Model Space",
          "[Branch] If 'setup' is False (Apply Changes):",
          "  Check Mode (Erase): If true, clear source properties found in sFormat string",
          "  Check Modification (bModify): If true, write composed string to Target Property",
          "End Loop",
          "Check Debug/Setup flags",
          "[Branch] If not Debugging and not in Setup mode: Erase Script Instance (cleanup)",
          "Script Finished"
        ],
        "conditionalBranches": [
          {
            "condition": "Selection method used during Insertion",
            "path1": {
              "name": "Batch Processing",
              "steps": [
                "User selects GenBeams via PrEntity selection set",
                "'setup' flag remains 0 (False)",
                "Script applies changes immediately and erases itself"
              ]
            },
            "path2": {
              "name": "Setup/Preview Mode",
              "steps": [
                "User hits Enter at PrEntity prompt",
                "User picks a point and selects a single GenBeam",
                "'setup' flag set to 1 (True)",
                "Script draws a visual preview of the transformation",
                "Instance remains in drawing for potential re-editing via OPM"
              ]
            }
          },
          {
            "condition": "sMode (Property source handling)",
            "path1": {
              "name": "Erase Mode",
              "steps": [
                "Parse sFormat string to find source properties (Name, Material, etc.)",
                "Clear those specific properties on the beam",
                "Write new value to target property"
              ]
            },
            "path2": {
              "name": "Keep Mode",
              "steps": [
                "Write new value to target property",
                "Leave all source properties unchanged"
              ]
            }
          },
          {
            "condition": "Configuration Source",
            "path1": {
              "name": "Catalog/Key Driven",
              "steps": [
                "_kExecuteKey is detected",
                "Load properties from specific catalog entry or '_LastInserted'",
                "Skip interactive dialog"
              ]
            },
            "path2": {
              "name": "Interactive Dialog",
              "steps": [
                "Execute showDialog()",
                "User manually selects Format, Mode, Target, and Replace strings"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Target property modification detection",
            "errorMessage": "None explicitly thrown, but logic uses 'bModify' flag.",
            "recovery": "If 'sReplace' has no effect or format fails to produce valid string, the write step is skipped (bModify remains false)."
          },
          {
            "check": "String Replacement Logic",
            "errorMessage": "None thrown.",
            "recovery": "If 'sReplace' format is invalid (e.g., missing target), it is ignored. Script requires semicolon separator 'source;target'."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Settings (Format/Mode/Target)",
            "how": "OPM Properties Palette",
            "effect": "In 'Setup' mode, the preview text updates immediately. In 'Batch' mode, the instance is already erased, so this only applies if the instance was preserved via debug or setup logic."
          },
          {
            "action": "Change Selection",
            "how": "Erase instance and re-run command",
            "effect": "User can select a different set of beams or choose a single beam to enter Preview mode."
          }
        ]
      },
      "tokens_used": 6873,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbPropertyComposer.mcr\n\n## Overview\nThis script composes a new property value for selected beams by extracting, formatting, and combining existing attributes (like dimensions or labels). It acts as a data management utility to automate renaming or re-labeling elements based on their current properties.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Used to modify properties of General Beams. |\n| Paper Space | No | Not supported in layouts. |\n| Shop Drawing | No | Not intended for manufacturing views. |\n\n## Prerequisites\n- **Required entities:** General Beams (GenBeams) must exist in the drawing.\n- **Minimum beam count:** 1.\n- **Required settings files:** None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbPropertyComposer.mcr` from the list.\n\n### Step 2: Select Execution Mode\nThe script will prompt: `Select entity(s) |<Enter> to insert setup instance|`\n\nYou have two options:\n1.  **Batch Processing:** Select one or multiple beams using a window or crossing selection and press **Enter**. The script will apply the current settings to all selected beams immediately and finish.\n2.  **Setup/Preview Mode:** Press **Enter** without selecting anything.\n    - The script will prompt: `Pick a point` (Click anywhere in the model).\n    - The script will prompt: `Select GenBeam` (Click on a single beam).\n    - The script instance will remain in the drawing, showing a preview of the result.\n\n### Step 3: Configure Parameters (Setup Mode Only)\nIf you entered Setup Mode, select the script instance and open the **Properties Palette** (Ctrl+1). Adjust the parameters (Format, Mode, Property, Replace) to see the preview update dynamically. Once satisfied, erase the script instance to commit the changes to the single beam, or use the settings to run a Batch Process.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Format | Text | @(Name) | The template used to construct the new value. <br>Examples: <br>• `@(Label)` <br>• `@(Width) x @(Height)` <br>• `@(Label:L2)` (First 2 chars) <br>• `@(Width:RL1)` (Rounded length) |\n| Property(s) | Dropdown | Erase | Determines what happens to the source data used in the Format string. <br>• **Erase:** Removes the source properties after copying. <br>• **Keep:** Leaves the source properties intact. |\n| Property | Dropdown | Name | The destination field where the composed string will be written (e.g., Name, Material, Information, Label). |\n| Replace | Text | | Defines character replacements. Format: `Source;Target`. <br>Example: ` ;_` replaces all spaces with underscores. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu items are added by this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Preview before Batch:** Always use \"Setup/Preview Mode\" (Step 2, option 2) on a single beam to verify your Format string is correct before running it on a large selection.\n- **Data Cleaning:** Use the \"Erase\" mode to clean up your data structure by moving values from temporary fields (like Label) into the final Name field and removing the temporary data.\n- **Advanced Formatting:** You can use mathematical rounding or token extraction in the Format field (e.g., extracting \"AW\" from \"EG AW 2\" using token logic).\n\n## FAQ\n- **Q: What happens if I select multiple beams?**\n- **A:** The script enters \"Batch Processing\" mode. It applies the current property settings to all selected beams and then removes itself from the drawing immediately.\n- **Q: How do I fix a mistake if I used \"Erase\" mode?**\n- **A:** You cannot easily undo the erasure of source properties unless you use the standard AutoCAD Undo command immediately after execution.\n- **Q: Can I change the order of text?**\n- **A:** Yes, simply rearrange the tags in the Format string (e.g., change `@(Label) @(Width)` to `@(Width) @(Label)`)."
      },
      "tokens_used": 5918,
      "error": null
    }
  }
}