{
  "filename": "NA_DIM_GENBEAMS_REFERENCED_TO_GENBEAM_STACK.mcr",
  "status": "completed",
  "total_tokens": 42299,
  "processing_time": 858.535073518753,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5938,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly prompts for a Viewport using getViewport() and stores it in the _Viewport array. It retrieves the Element from the Viewport (Element thisElement = thisViewPort.element()) and performs coordinate transformations between model and paper space (CoordSys modelToPaperTransformation = thisViewPort.coordSys()). It includes logic to transform points (pointDimensionLinePosition.transformBy(modelToPaperTransformation)) which is characteristic of a script running in a drawing/layout environment to annotate model data."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "The script requires a valid Viewport on a Paper Space layout linked to an Element containing GenBeams.",
          "requiredSettings": []
        }
      },
      "tokens_used": 4612,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getViewport",
              "promptOriginal": "\nSelect element viewport",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "Edit dimension properties",
            "handler": "callPropertiesTrigger",
            "action": "Opens configuration for dimension properties.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Add properties override for current element",
            "handler": "overridePropertiesTrigger",
            "action": "Creates a specific property set override for the active element.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove properties override for current element",
            "handler": "removePropertiesOverrideTrigger",
            "action": "Removes the specific property set override for the active element.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Reset grip points for current element",
            "handler": "resetGripPointsTrigger",
            "action": "Resets the grip points associated with the dimensions.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8597,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation of layout dimensions in Paper Space, specifically designed to measure the length or position of GenBeams relative to a 'stack' or reference group of beams.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used when generating 2D production drawings to annotate beam lengths or placements in wall panels or floor cassettes where measurements are relative to a specific reference beam or grouping (the stack)."
        },
        "parameters": [
          {
            "name": "Dimensioned entities",
            "technicalDefault": "All dimensioned genbeams",
            "businessMeaning": "Defines the scope of beams that receive dimension lines. It filters whether the dimension applies to beams inside the stack, beams touching the stack, or all beams in the viewport.",
            "validRange": "Enumeration (All dimensioned genbeams, Dimensioned genbeams in stack, Dimensioned genbeams touching stack)",
            "unit": "String",
            "affectsOutput": "Determines which specific GenBeam entities are annotated by the dimension lines."
          },
          {
            "name": "Stack selection",
            "technicalDefault": "All stacked genbeams",
            "businessMeaning": "Defines the logic used to group a set of beams to act as the reference 'stack' or baseline for the dimensions.",
            "validRange": "Enumeration (All stacked genbeams, etc.)",
            "unit": "String",
            "affectsOutput": "Calculates the reference geometry (reference point or line) from which dimensions are measured."
          },
          {
            "name": "Tolerance",
            "technicalDefault": "1.0",
            "businessMeaning": "The maximum distance allowed between two beams for them to be considered 'touching' or 'stacked'.",
            "validRange": "0.0mm - 10.0mm",
            "unit": "mm",
            "affectsOutput": "Influences beam grouping and intersection logic. A higher tolerance groups beams that are slightly apart, while a lower tolerance requires tighter contact."
          },
          {
            "name": "Text offset",
            "technicalDefault": "2.0",
            "businessMeaning": "The visual distance between the dimension text and the dimension line.",
            "validRange": "0.0mm - 10.0mm",
            "unit": "mm",
            "affectsOutput": "Controls the legibility and layout of the dimension annotation in the drawing."
          },
          {
            "name": "Arrow size",
            "technicalDefault": "2.5",
            "businessMeaning": "The size of the arrowheads or tick marks at the ends of the dimension lines.",
            "validRange": "1.0mm - 5.0mm",
            "unit": "mm",
            "affectsOutput": "Affects the visual scale and CAD standard compliance of the drawing entities."
          },
          {
            "name": "Extension line offset",
            "technicalDefault": "1.5",
            "businessMeaning": "The gap between the physical beam geometry and the start of the dimension extension line.",
            "validRange": "0.0mm - 5.0mm",
            "unit": "mm",
            "affectsOutput": "Visual clarity of the drawing, preventing lines from overlapping the beam outline."
          },
          {
            "name": "CurrentLanguage",
            "technicalDefault": "en-US",
            "businessMeaning": "Sets the localization for script messages and property names.",
            "validRange": "en-US, fr-CA",
            "unit": "String",
            "affectsOutput": "Changes the language of the right-click context menu items and report messages."
          },
          {
            "name": "Element Override (bIsOverride)",
            "technicalDefault": "false",
            "businessMeaning": "A state flag indicating if the current Element uses specific dimension settings different from the global defaults.",
            "validRange": "true / false",
            "unit": "Boolean",
            "affectsOutput": "If true, the script reads settings from a map key specific to the current Element Handle; otherwise, it uses global settings."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing 'Dimensioned entities'",
            "effect": "Updates the list of beams passed to the dimension creation function (`genbeamsToDimensionFiltered`).",
            "cascade": [
              "genbeamsToDimensionFiltered",
              "Dimension Output"
            ]
          },
          {
            "trigger": "Changing 'Stack selection'",
            "effect": "Recalculates the group of beams considered the 'stack' (`genbeamsInStack`), which determines the reference point for dimension vectors.",
            "cascade": [
              "genbeamsInStack",
              "Reference Point",
              "Dimension Output"
            ]
          },
          {
            "trigger": "Selecting 'Remove properties override' (Context Menu)",
            "effect": "Deletes the element-specific property map, causing the script to revert to global defaults.",
            "cascade": [
              "bIsOverride",
              "mapUserSelectedValues"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Dim (Dimension)",
            "description": "Standard AutoCAD dimension objects drawn in Paper Space representing lengths or positions relative to the beam stack.",
            "appliedTo": "Paper Space layout via the selected Viewport."
          },
          {
            "type": "Grip",
            "description": "Interactive handles allowing the user to drag the dimension line position dynamically.",
            "appliedTo": "The TSL instance in Paper Space."
          }
        ]
      },
      "tokens_used": 8741,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script starts and initializes variables (language, properties maps, grip reset).",
          "Verify if script is on Insert: Check for duplicate insert cycles (>1) and erase if necessary.",
          "Prompt user: Select element viewport (_Viewport).",
          "Validate input: Ensure Viewport exists; if not, report error and erase instance.",
          "Retrieve Element from Viewport and validate its existence.",
          "Set up Coordinate Systems: Calculate transformations between Model and Paper Space based on Viewport scale and orientation.",
          "Register Context Menu Triggers: Add options for editing properties, managing overrides, and resetting grips.",
          "Load User Preferences: Check for global defaults or Element-specific overrides from the Map. Handle Remove Override trigger if active.",
          "Generate Grip Candidates and Stacking Logic: Calculate outlines of GenBeams, determine which beams constitute a 'stack' based on overlap/tolerance, and identify valid grip locations.",
          "Loop through Beam Stacks: For each identified stack, determine the set of beams to dimension (filtering by 'in stack', 'touching stack', or 'all').",
          "Determine Dimension Line Position: Retrieve existing grip point location or calculate default position from geometry.",
          "Generate Dimension: Create the dimension entity (Dim) using calculated vectors, offsets, and text properties.",
          "Draw and Finalize: Render dimensions to the display, save updated grip locations to the Map, and assign them to the TSL instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Duplicate Insert Cycle (insertCycleCount > 1)",
            "path1": {
              "name": "Cleanup",
              "steps": [
                "Erase current instance",
                "Exit script"
              ]
            },
            "path2": {
              "name": "Normal Insert",
              "steps": [
                "Prompt for Viewport",
                "Continue execution"
              ]
            }
          },
          {
            "condition": "Element Override Existence",
            "path1": {
              "name": "Use Override Settings",
              "steps": [
                "Load Map key specific to current Element Handle",
                "Set flag bIsOverride = true",
                "Report warning message"
              ]
            },
            "path2": {
              "name": "Use Global Settings",
              "steps": [
                "Load Map key 'UserSelectedValues'",
                "Set flag bIsOverride = false"
              ]
            }
          },
          {
            "condition": "Trigger Key Context (Right-click action)",
            "path1": {
              "name": "Remove Override",
              "steps": [
                "Delete Element-specific Map entry",
                "Reload global defaults",
                "Recalculate"
              ]
            },
            "path2": {
              "name": "Edit Properties",
              "steps": [
                "Open OPM or Dialog",
                "Update values in Map"
              ]
            }
          },
          {
            "condition": "Grip Point Interaction (Drag vs Static)",
            "path1": {
              "name": "Dynamic Grip Drag",
              "steps": [
                "Identify moved grip index",
                "Transform grip point to Model Space",
                "Update dimension geometry dynamically",
                "Exit early (skip other stack calculations)"
              ]
            },
            "path2": {
              "name": "Static Calculation / Reset",
              "steps": [
                "Calculate all stacks",
                "Retrieve or calculate grip points",
                "Draw all dimensions",
                "Save final state"
              ]
            }
          },
          {
            "condition": "Dimensioned Entities Selection",
            "path1": {
              "name": "In Stack",
              "steps": [
                "Filter beams to only those included in the current stack group"
              ]
            },
            "path2": {
              "name": "Touching Stack",
              "steps": [
                "Filter beams to those physically contacting the current stack group"
              ]
            },
            "path3": {
              "name": "All Beams",
              "steps": [
                "Include all beams referenced by the Viewport Element"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport availability",
            "errorMessage": "No valid viewport. Erasing this instance.",
            "recovery": "User must re-insert the script and select a valid viewport."
          },
          {
            "check": "Element validity within Viewport",
            "errorMessage": "No valid element in viewport",
            "recovery": "Ensure the selected Viewport is linked to a valid 3D Element/Model."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Move Dimension Lines",
            "how": "Grip Edit (Drag)",
            "effect": "Updates the dimension line position vector and redraws the specific dimension associated with that grip."
          },
          {
            "action": "Modify Dimension Settings (Arrows, Text, Tolerance)",
            "how": "Right-click Context Menu -> 'Edit dimension properties'",
            "effect": "Opens OPM/Dialog to change visual parameters; updates the Map and redraws dimensions."
          },
          {
            "action": "Apply Element-Specific Settings",
            "how": "Right-click Context Menu -> 'Add properties override for current element'",
            "effect": "Saves a copy of current settings specific to the Element Handle; changes made here only affect this Element."
          },
          {
            "action": "Reset Dimension Positions",
            "how": "Right-click Context Menu -> 'Reset grip points for current element'",
            "effect": "Clears manual grip positions and recalculates them based on the default geometric outline of the beam stacks."
          },
          {
            "action": "Remove Custom Settings",
            "how": "Right-click Context Menu -> 'Remove properties override for current element'",
            "effect": "Deletes the Element-specific Map entry, reverting the script to the global default settings."
          }
        ]
      },
      "tokens_used": 8254,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# NA_DIM_GENBEAMS_REFERENCED_TO_GENBEAM_STACK.mcr\n\n## Overview\nAutomates the creation of layout dimensions in Paper Space, specifically designed to measure the length or position of GenBeams relative to a \"stack\" or reference group of beams.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script runs in the layout environment. |\n| Paper Space | Yes | Requires a Viewport to be selected. |\n| Shop Drawing | Yes | Used for annotating production drawings. |\n\n## Prerequisites\n- **Required Entities**: A Paper Space Layout containing a Viewport linked to an Element with GenBeams.\n- **Minimum Beam Count**: 1 GenBeam within the referenced Element.\n- **Required Settings**: None (Settings are managed via the Properties Panel).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `NA_DIM_GENBEAMS_REFERENCED_TO_GENBEAM_STACK.mcr`\n\n### Step 2: Select Viewport\n```\nCommand Line: Select element viewport\nAction: Click inside the viewport on the layout that contains the element/assembly you wish to dimension.\n```\n\n### Step 3: Configuration (Optional)\n- Select the script instance in Paper Space.\n- Adjust settings in the Properties Palette (Ctrl+1) if the default appearance does not meet your standards.\n\n### Step 4: Adjust Dimensions\n- **Move Dimension Lines**: Click and drag the blue grips associated with the dimension lines to reposition them manually.\n- **Modify Settings**: Right-click the script instance to access context menu options for overrides or resets.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimensioned entities | dropdown | All dimensioned genbeams | Defines the scope: dimensions all beams, only those in the stack, or those touching the stack. |\n| Stack selection | dropdown | All stacked genbeams | Determines the logic used to group beams to act as the reference baseline. |\n| Tolerance | Number | 1.0 mm | Maximum distance for beams to be considered \"touching\" or \"stacked.\" |\n| Text offset | Number | 2.0 mm | Visual distance between the dimension text and the dimension line. |\n| Arrow size | Number | 2.5 mm | Size of the arrowheads or tick marks at the ends of dimension lines. |\n| Extension line offset | Number | 1.5 mm | Gap between the beam geometry and the start of the dimension extension line. |\n| CurrentLanguage | String | en-US | Sets the language for script messages (e.g., en-US, fr-CA). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Edit dimension properties | Opens the configuration (Properties Panel) to modify visual parameters like offsets, text size, and tolerance. |\n| Add properties override for current element | Saves the current settings specifically for this Element. Future changes to global defaults will not affect this element. |\n| Remove properties override for current element | Deletes element-specific settings and reverts the script to the global default settings. |\n| Reset grip points for current element | Clears manual adjustments to dimension line positions and recalculates them based on the default geometry. |\n\n## Settings Files\n- **Storage**: Internal Drawing Map\n- **Location**: Stored within the current AutoCAD drawing (.dwg).\n- **Purpose**: Retains user preferences for global use and element-specific overrides without requiring external XML files.\n\n## Tips\n- **Use Overrides for Unique Elements**: If one wall panel requires different dimensioning offsets than the rest of the project, use \"Add properties override\" to handle that specific panel without affecting others.\n- **Fix Grouping Issues**: If beams that should be grouped together are not being dimensioned as a single stack, try increasing the **Tolerance** parameter slightly.\n- **Reset After Updates**: If the model changes significantly and dimensions look disjointed, use \"Reset grip points\" to snap them back to the calculated optimal positions.\n\n## FAQ\n- **Q: The script disappeared immediately after I selected a viewport.**\n  **A**: This usually happens if the selected viewport is not linked to a valid Element or contains no GenBeams. Ensure you select a viewport showing a valid 3D model.\n- **Q: Can I dimension beams that are not touching each other?**\n  **A**: Yes. Set the **Dimensioned entities** property to \"All dimensioned genbeams\" to ignore the stacking logic and dimension everything in the view.\n- **Q: How do I change the arrow style?**\n  **A**: Currently, this script controls arrow size via the properties panel. The arrow style itself is typically determined by your current CAD dimension style standard, but this script generates specific entities that may use the style active at insertion."
      },
      "tokens_used": 6157,
      "error": null
    }
  }
}