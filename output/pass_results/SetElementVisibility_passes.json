{
  "filename": "SetElementVisibility.mcr",
  "status": "completed",
  "total_tokens": 29833,
  "processing_time": 641.8635876178741,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 5983,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly queries entities using `Group().collectEntities(true, Element(), _kModelSpace)`. It operates on 3D `Element` objects (`ElementWallSF`, `ElementRoof`) and toggles their group visibility. No `sd_*` functions, `#Type E` declarations, or Paper Space tokens (`_kPaperSpace`) are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing hsbCAD Elements organized in Groups.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3611,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFloor",
            "type": "PropString",
            "displayName": "Storey",
            "defaultValue": "Select All",
            "inputType": "dropdown",
            "options": [
              "Select All",
              "<Dynamic list of floors found in model>"
            ],
            "category": "General",
            "description": "Defines the Floor"
          },
          {
            "index": 1,
            "variable": "sFilter",
            "type": "PropString",
            "displayName": "Element Filter",
            "defaultValue": "Select All",
            "inputType": "dropdown",
            "options": [
              "Select All",
              "Floor/Ceiling",
              "Roof",
              "Walls (any)",
              "Walls (exterior)",
              "Walls (interior)"
            ],
            "category": "General",
            "description": "Defines the Filter"
          },
          {
            "index": 2,
            "variable": "sVisibility",
            "type": "PropString",
            "displayName": "Set Visibility",
            "defaultValue": "toggle state",
            "inputType": "dropdown",
            "options": [
              "toggle state",
              "On",
              "Off"
            ],
            "category": "General",
            "description": "Defines the Visibility"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5153,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "A utility script to bulk manage the visibility of element groups in the model based on storey (floor) and structural element type.",
          "category": "ModelManagement",
          "typicalUseCase": "Hiding roof elements to inspect floor plans, or isolating specific storeys (e.g., Ground Floor vs First Floor) for presentation or editing purposes without manually hiding individual groups."
        },
        "parameters": [
          {
            "name": "sFloor",
            "technicalDefault": "Select All",
            "businessMeaning": "Selects the specific Storey (Level) to process. This corresponds to the second part of the hsbCAD Group naming convention (Group.namePart(1)).",
            "validRange": "Dynamic list derived from existing Group names in the model (e.g., 'GF', '1F', 'ROOF'). Default includes 'Select All' to target every storey.",
            "unit": "Text",
            "affectsOutput": "Filters the set of processed Elements to only those belonging to the specified storey's Group."
          },
          {
            "name": "sFilter",
            "technicalDefault": "Select All",
            "businessMeaning": "Categorizes elements to target specific construction functions. Distinguishes between Interior/Exterior walls based on the 'Exposed' property, and Roof vs Floor/Ceiling based on element orientation.",
            "validRange": "Dropdown options: 'Select All', 'Floor/Ceiling', 'Roof', 'Walls (any)', 'Walls (exterior)', 'Walls (interior)'.",
            "unit": "N/A",
            "affectsOutput": "Determines which subset of elements within the chosen storey is affected. 'Floor/Ceiling' selects flat roof elements (Z parallel to World Z), while 'Roof' selects sloped elements."
          },
          {
            "name": "sVisibility",
            "technicalDefault": "toggle state",
            "businessMeaning": "Controls the final display state of the selected groups. 'Toggle' calculates the majority state of the selection and inverts it.",
            "validRange": "Dropdown options: 'toggle state', 'On', 'Off'.",
            "unit": "N/A",
            "affectsOutput": "Directly sets the Group visibility status (Visible/Hidden) in the AutoCAD Model Space."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFloor selection",
            "effect": "Defines the pool of available elements that the sFilter logic will be applied to.",
            "cascade": [
              "sFilter"
            ]
          },
          {
            "trigger": "sVisibility set to 'toggle state'",
            "effect": "Requires checking the current visibility status of the groups defined by sFloor and sFilter to decide whether to turn them On or Off.",
            "cascade": [
              "sFloor",
              "sFilter"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Group Visibility State",
            "description": "Modifies the display status of existing hsbCAD Groups.",
            "appliedTo": "Element Groups (containing ElementWallSF or ElementRoof) matching the specified Storey and Type criteria."
          }
        ]
      },
      "tokens_used": 5289,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution triggered.",
          "Script scans Model Space for all Element entities to populate a dynamic list of 'Storey' names (based on Group naming).",
          "Properties Palette (OPM) or Dialog displays available options: Storey, Element Filter, and Set Visibility.",
          "User configures the three properties (Filter logic is applied immediately upon confirmation).",
          "Script iterates through all collected Elements to filter targets based on Storey and Element Type.",
          "If 'toggle state' is selected, script analyzes current visibility of matching Groups to determine the dominant state.",
          "Script applies the visibility change (On/Off) to the identified Groups.",
          "System reports the total number of groups modified.",
          "Script instance is erased from the drawing, and the view is regenerated (_REGEN)."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Cycle",
            "path1": {
              "name": "Recalculation / Regen",
              "steps": [
                "Script detects insertCycleCount() > 1",
                "Script erases itself immediately",
                "Process halts"
              ]
            },
            "path2": {
              "name": "Initial Insertion",
              "steps": [
                "Script proceeds to property collection and logic execution"
              ]
            }
          },
          {
            "condition": "Execution Source",
            "path1": {
              "name": "Catalog/Command Key",
              "steps": [
                "Script checks _kExecuteKey against catalog names",
                "Sets properties from specific catalog entry",
                "Bypasses dialog display"
              ]
            },
            "path2": {
              "name": "Standard Insert",
              "steps": [
                "Script executes showDialog()",
                "User manually selects properties"
              ]
            }
          },
          {
            "condition": "Element Filter Type",
            "path1": {
              "name": "Wall Types",
              "steps": [
                "Element cast to ElementWallSF",
                "Checks 'exposed' property",
                "Matches against 'Interior', 'Exterior', or 'any Wall' filter"
              ]
            },
            "path2": {
              "name": "Roof/Floor Types",
              "steps": [
                "Element cast to ElementRoof",
                "Checks Vector Z orientation (isParallelTo _ZW)",
                "Matches against 'Floor/Ceiling' (flat) or 'Roof' (sloped) filter"
              ]
            },
            "path3": {
              "name": "Select All",
              "steps": [
                "Element passes filter regardless of type (assuming Storey match)",
                "Added to processing list"
              ]
            }
          },
          {
            "condition": "Visibility Action",
            "path1": {
              "name": "Explicit Set (On/Off)",
              "steps": [
                "Target state set directly by user choice ('On' or 'Off')",
                "Groups forced to specified state"
              ]
            },
            "path2": {
              "name": "Toggle State",
              "steps": [
                "Script counts currently visible vs hidden groups in selection",
                "Determines majority state (e.g., if mostly visible, turn them Off)",
                "Inverts the majority state for the selection"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Model Space Content",
            "errorMessage": "No explicit error message. If model is empty, the 'Storey' dropdown will only contain 'Select All', and the script will finish with 0 groups modified.",
            "recovery": "User must ensure hsbCAD Elements exist in the Model Space."
          },
          {
            "check": "Group Naming Convention",
            "errorMessage": "No explicit error. If Groups do not follow standard naming, 'Storey' filtering may fail to capture elements correctly.",
            "recovery": "Ensure Elements are grouped using standard hsbCAD conventions (House, Floor, Part)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Re-execution",
            "how": "Command line or Tool Palette.",
            "effect": "Since the script erases itself upon completion, the user must insert the script again to perform a new visibility operation."
          }
        ]
      },
      "tokens_used": 4956,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# SetElementVisibility\n\n## Overview\nA utility script to bulk manage the visibility of hsbCAD element groups in the model. It filters elements by storey (floor level) and structural type (e.g., roof, walls) to hide or show them instantly.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be run in Model Space where hsbCAD Elements exist. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required entities**: hsbCAD Elements (Walls, Roofs) existing in the Model Space.\n- **Minimum beam count**: 0.\n- **Required settings**: None.\n- **Note**: Elements should be organized in Groups using standard hsbCAD naming conventions (House, Storey/Floor, Part) for the Storey filter to function correctly.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or insert via Catalog/Tool Palette) â†’ Select `SetElementVisibility.mcr`\n\n### Step 2: Configure Options\n```\nDialog / Properties Palette: SetElementVisibility options appear.\nAction: The script automatically scans the drawing to identify existing Storeys.\n```\n\n### Step 3: Select Parameters\n1.  **Storey**: Select the specific floor level (e.g., \"GF\", \"1F\") from the dropdown, or leave as \"Select All\" to target the entire model.\n2.  **Element Filter**: Choose the specific type of construction to modify (e.g., \"Walls (exterior)\", \"Roof\", \"Floor/Ceiling\").\n3.  **Set Visibility**:\n    *   Choose **On** to make elements visible.\n    *   Choose **Off** to hide elements.\n    *   Choose **toggle state** to invert the current visibility of the matched elements.\n\n### Step 4: Apply Changes\nAction: Click OK in the dialog or close the Properties Palette. The view regenerates, and the script instance automatically deletes itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Storey** | dropdown | Select All | Selects the specific floor level to process. The list is generated dynamically from the Group names in the current model. |\n| **Element Filter** | dropdown | Select All | Filters elements by structural type. Options include Floor/Ceiling, Roof, or specific Wall types (Interior/Exterior). |\n| **Set Visibility** | dropdown | toggle state | Determines the action to perform. Options are \"toggle state\" (inverts current state), \"On\", or \"Off\". |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu items are defined for this script. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Isolating Floors**: Use the \"Storey\" dropdown combined with \"Set Visibility: On\" to quickly display only the ground floor while hiding upper levels.\n- **Presentation**: Use the \"toggle state\" option to quickly flip the visibility of a specific category (like Roofs) without checking if they are currently on or off.\n- **Script Behavior**: The script automatically erases itself after running. If you need to make changes again, simply re-insert the script.\n\n## FAQ\n- **Q: Why is \"Select All\" the only option in the Storey list?**\n  **A**: This usually means the script could not find standard Group names in the model. Ensure your elements are grouped using the standard hsbCAD convention (House, Storey, Part).\n\n- **Q: Where did the script go after I clicked OK?**\n  **A**: The script is designed to erase itself immediately after applying the visibility changes to keep your drawing clean. Re-insert it to perform another operation."
      },
      "tokens_used": 4841,
      "error": null
    }
  }
}