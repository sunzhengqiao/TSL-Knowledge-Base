{
  "filename": "hsb_BattensAroundOpenings.mcr",
  "status": "completed",
  "total_tokens": 35381,
  "processing_time": 235.68608975410461,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "12.06.2009",
            "author": "Alberto Jena (aj@hsb-cad.com)",
            "changes": "Release Version"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4573,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses ElementWall, Opening, and Beam creation (bm.dbCreate) which are 3D model entities. No sd_* prefixes, #Type E, or _Viewport usage found. The script iterates through _Element[] which typically refers to model elements, and manipulates geometry using CoordSys and Vector3d in a 3D context."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementWall"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing Wall Elements with Openings (Windows/Doors)",
          "requiredSettings": []
        }
      },
      "tokens_used": 2411,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"\\\\nSelect a set of elements\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sDoor\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Apply Battens Around Doors\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sCorners\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Corners Cleanup\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Extend Vertical\",\n        \"Extend Horizontal\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dBattenWidth\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Batten Width\",\n      \"defaultValue\": \"U(38)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dBattenHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Batten Height\",\n      \"defaultValue\": \"U(20)\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nZones\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Zone to assign the Battens\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"1\",\n        \"2\",\n        \"3\",\n        \"4\",\n        \"5\",\n        \"6\",\n        \"7\",\n        \"8\",\n        \"9\",\n        \"10\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sName\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Name\",\n      \"defaultValue\": \"Battens\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sMaterial\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Material\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sGrade\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Grade\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sInformation\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Information\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n"
      },
      "tokens_used": 6783,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically generates timber framing battens (noggings/furring strips) around the perimeter of wall openings (windows and doors) to provide fixing points for linings, claddings, or reveal finishes.",
          "category": "Framing / Wall Accessories",
          "typicalUseCase": "Used during the detailing phase to add support battens around rough openings where drywall or exterior cladding requires fixing, ensuring continuity of the substrate around fenestration."
        },
        "parameters": [
          {
            "name": "sDoor",
            "technicalDefault": "No",
            "businessMeaning": "Determines whether the script should generate battens around Door openings. Often omitted to avoid interference with door frames or specific door jambs.",
            "validRange": "Yes, No",
            "unit": "Boolean/Enum",
            "affectsOutput": "Controls if beams are generated for openings classified as Doors."
          },
          {
            "name": "sCorners",
            "technicalDefault": "Extend Vertical",
            "businessMeaning": "Defines the corner lap strategy. Specifies whether vertical or horizontal battens extend past the opening corner to overlap the adjoining batten member.",
            "validRange": "Extend Vertical, Extend Horizontal",
            "unit": "Enum",
            "affectsOutput": "Modifies the length calculation of the generated beams. If 'Extend Vertical' is chosen, vertical battens increase in length by 2*Width to overlap horizontals, and vice versa."
          },
          {
            "name": "dBattenWidth",
            "technicalDefault": "U(38)",
            "businessMeaning": "The cross-sectional width of the batten (the dimension visible on the wall elevation).",
            "validRange": "19 - 100 mm (typical timber sizes: 38, 45, 50, 70, 90 mm)",
            "unit": "mm",
            "affectsOutput": "Sets the width (Y-axis in beam local coordinates) of the generated timber beam. Also influences the overlap length if Corners Cleanup is active."
          },
          {
            "name": "dBattenHeight",
            "technicalDefault": "U(20)",
            "businessMeaning": "The thickness/depth of the batten (the dimension perpendicular to the wall face).",
            "validRange": "12 - 50 mm (typical timber sizes: 19, 22, 25, 38, 45 mm)",
            "unit": "mm",
            "affectsOutput": "Sets the height (Z-axis in beam local coordinates) of the generated timber beam."
          },
          {
            "name": "nZones",
            "technicalDefault": "1",
            "businessMeaning": "Specifies the construction layer (Zone) within the wall assembly where the battens are positioned. Positive values typically map to structural/specific layers, while mapped negative values (6-10) may indicate the opposite side of the wall origin.",
            "validRange": "1 - 10",
            "unit": "Index",
            "affectsOutput": "Determines the 3D insertion point (offset from the wall origin) and the orientation (side of the wall) of the battens."
          },
          {
            "name": "sName",
            "technicalDefault": "Battens",
            "businessMeaning": "The entity name assigned to the generated beams for identification in schedules and model filtering.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the 'Name' property of the beam entity."
          },
          {
            "name": "sMaterial",
            "technicalDefault": "",
            "businessMeaning": "Defines the timber material code (e.g., C24, GL24h) for structural analysis and material takeoffs.",
            "validRange": "Valid material codes from the hsbCAD catalog",
            "unit": "Text",
            "affectsOutput": "Sets the 'Material' property of the beam entity."
          },
          {
            "name": "sGrade",
            "technicalDefault": "",
            "businessMeaning": "Specifies the timber strength grade.",
            "validRange": "Valid grade codes (e.g., C24, SS)",
            "unit": "Text",
            "affectsOutput": "Sets the 'Grade' property of the beam entity."
          },
          {
            "name": "sLabel",
            "technicalDefault": "Batten",
            "businessMeaning": "Short label/emarking often used for drawings or CAM identifiers.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the 'Label' property of the beam entity."
          },
          {
            "name": "sSublabel",
            "technicalDefault": "",
            "businessMeaning": "Secondary label for additional grouping or identification.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the 'SubLabel' property of the beam entity."
          },
          {
            "name": "sSublabel2",
            "technicalDefault": "",
            "businessMeaning": "Tertiary label.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the 'SubLabel2' property of the beam entity."
          },
          {
            "name": "sInformation",
            "technicalDefault": "",
            "businessMeaning": "Free text field for notes or additional details attached to the entities.",
            "validRange": "Text string",
            "unit": "Text",
            "affectsOutput": "Sets the 'Information' property of the beam entity."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Corners Cleanup (sCorners) selection",
            "effect": "Modifies the length of the generated beams based on their orientation.",
            "cascade": [
              "dBattenWidth"
            ],
            "details": "The length of the beam is increased by 2 * dBattenWidth for the orientation specified in 'Corners Cleanup' to create a lap joint."
          }
        ],
        "outputEntities": [
          {
            "type": "Beam",
            "description": "Rectangular timber members generated along the edges of the opening polyline. The beams are placed on the specific Zone layer and grouped with the parent wall element.",
            "appliedTo": "Selected Wall Elements (ElementWall)"
          }
        ]
      },
      "tokens_used": 6680,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch",
          "2. Check Execution Context (_bOnInsert)",
          "3. Check Insert Cycle Count (if > 1, exit immediately to prevent duplicate execution)",
          "4. Display Properties Dialog (if not executed via Catalog)",
          "5. Prompt User to Select Wall Elements (ElementWall)",
          "6. Validate Element Selection (if empty, erase instance and exit)",
          "7. Iterate through each Selected Wall Element",
          "8. Validate Wall Geometry (bIsValid)",
          "9. Retrieve Openings from the Wall",
          "10. Iterate through each Opening",
          "11. Check Opening Type (Door vs Window/Other) against 'Apply Battens Around Doors' property",
          "12. Retrieve Opening Geometry (Polyline vertices) and Project to Wall Zone Plane",
          "13. Iterate through Opening Segments (Edges)",
          "14. Calculate Batten Orientation (Local X, Y, Z vectors) relative to Wall and Segment",
          "15. Check for 'Internal' Edges on Doors (Skip if on the wall's internal reference side)",
          "16. Calculate Batten Length based on Segment Length",
          "17. Apply 'Corners Cleanup' Logic (Extend Horizontal vs Extend Vertical)",
          "18. Create Beam Entity at calculated Position",
          "19. Apply Properties (Material, Grade, Name, Labels) and Assign to Element Group",
          "20. Loop Completion",
          "21. Erase Script Instance (cleanup)",
          "22. Script Execution Ends"
        ],
        "conditionalBranches": [
          {
            "condition": "Check Insert Cycle Count",
            "path1": {
              "name": "Count > 1",
              "steps": [
                "Erase Instance",
                "Exit Script"
              ]
            },
            "path2": {
              "name": "Count = 1",
              "steps": [
                "Proceed to Dialog/Selection"
              ]
            }
          },
          {
            "condition": "Door Batten Filter (sDoor property vs Opening Type)",
            "path1": {
              "name": "Doors Disabled OR Opening is a Door",
              "steps": [
                "Skip Current Opening",
                "Proceed to Next Opening"
              ]
            },
            "path2": {
              "name": "Doors Enabled OR Opening is Window",
              "steps": [
                "Process Opening for Battens"
              ]
            }
          },
          {
            "condition": "Side Check for Doors (Internal Edge Detection)",
            "path1": {
              "name": "Is Door AND Edge is internal (points to -vy)",
              "steps": [
                "Skip Current Segment (Edge)",
                "Proceed to Next Segment"
              ]
            },
            "path2": {
              "name": "Is Window OR Edge is external",
              "steps": [
                "Create Batten for this Segment"
              ]
            }
          },
          {
            "condition": "Corner Cleanup Logic (Segment Orientation vs Preference)",
            "path1": {
              "name": "Horizontal Segment + 'Extend Horizontal' Preference",
              "steps": [
                "Increase Length by 2 * Batten Width",
                "Create Beam"
              ]
            },
            "path2": {
              "name": "Vertical Segment + 'Extend Vertical' Preference",
              "steps": [
                "Increase Length by 2 * Batten Width",
                "Create Beam"
              ]
            },
            "path3": {
              "name": "Orientation Mismatch (e.g. Vertical Segment + Horizontal Preference)",
              "steps": [
                "Use Standard Segment Length",
                "Create Beam"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selection Set Validity",
            "errorMessage": "None (Silent failure)",
            "recovery": "Script checks if _Element.length() == 0. If true, it erases itself and exits. User must re-run command and select elements."
          },
          {
            "check": "Insert Cycle Count",
            "errorMessage": "None (Automated)",
            "recovery": "Script detects duplicate execution attempts (insertCycleCount > 1), erases itself, and returns immediately to stop processing."
          },
          {
            "check": "Wall Entity Validity",
            "errorMessage": "None (Silent skip)",
            "recovery": "Script checks el.bIsValid() inside the loop. If false, it continues to the next element in the selection set."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Regenerate/Update Battens",
            "how": "Not Available",
            "effect": "The script calls eraseInstance() at the end. The TSL instance is removed from the drawing, leaving only the generated beams. Properties cannot be edited to trigger an update; the user must delete the beams and run the script again to change dimensions or layout."
          },
          {
            "action": "Modify Generated Beams",
            "how": "AutoCAD Grip Edit / Properties Palette",
            "effect": "Standard AutoCAD modification of the resulting Beam entities (move, stretch, change properties). Changes are not associative to the original wall or script."
          }
        ]
      },
      "tokens_used": 7815,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_BattensAroundOpenings.mcr\n\n## Overview\nThis script automatically generates timber framing battens (noggings/furring strips) around the perimeter of wall openings (windows and doors). It is used to create fixing points for linings, claddings, or reveal finishes based on user-defined dimensions and wall zones.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D Wall Elements. |\n| Paper Space | No | Not designed for 2D drawing generation. |\n| Shop Drawing | No | Not applicable for shop drawing views. |\n\n## Prerequisites\n- **Required Entities**: Wall Elements (`ElementWall`) containing Openings (Windows or Doors).\n- **Minimum Beam Count**: 0.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Browse and select `hsb_BattensAroundOpenings.mcr`.\n3.  Press **Enter**.\n\n### Step 2: Configure Properties (Optional)\n*Before selecting elements, you can adjust the settings in the AutoCAD Properties Palette (Ctrl+1) if the script is selected, or rely on the defaults.*\n\n### Step 3: Select Wall Elements\n1.  **Command Line Prompt**: `Select a set of elements`\n2.  **Action**: Click on the Wall elements in the Model Space that contain the openings you wish to frame.\n3.  Press **Enter** to confirm selection.\n\n### Step 4: Generation\nThe script will automatically calculate the opening geometries, generate the battens, place them in the specified zone, and then remove itself from the drawing.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Apply Battens Around Doors | dropdown | No | Determines whether to generate battens around Door openings. |\n| Corners Cleanup | dropdown | Extend Vertical | Defines corner overlap strategy. If \"Extend Vertical\", vertical battens are longer to overlap horizontal ones. |\n| Batten Width | number | 38 mm | The cross-sectional width of the batten (visible on elevation). |\n| Batten Height | number | 20 mm | The thickness/depth of the batten (perpendicular to the wall face). |\n| Zone to assign the Battens | dropdown | 1 | The construction layer (Zone) in the wall where battens are placed. |\n| Name | text | Battens | The entity name assigned to the generated beams. |\n| Material | text | [Empty] | The timber material code (e.g., C24). |\n| Grade | text | [Empty] | The timber strength grade. |\n| Label | text | Batten | Short label for drawings or CAM identifiers. |\n| Sublabel | text | [Empty] | Secondary label for grouping. |\n| Sublabel2 | text | [Empty] | Tertiary label. |\n| Information | text | [Empty] | Free text field for notes. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| *None* | This script runs once and erases itself. There are no recalculation triggers available via right-click menu after insertion. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Zone Assignment**: Ensure the \"Zone to assign the Battens\" corresponds to the correct layer in your wall setup (e.g., internal lining vs. external structure). If battens appear on the wrong side of the wall, change the Zone index.\n- **Corner Cleanup**: Use the \"Corners Cleanup\" option to avoid butt joints at corners. Overlapping the battens (lapping) provides a better fixing surface for plasterboard or cladding.\n- **Door Handling**: By default, doors are excluded. If you need battens on the reveal of a door frame, ensure \"Apply Battens Around Doors\" is set to **Yes**.\n- **Post-Creation Editing**: Since the script instance is deleted after running, the generated beams are standard AutoCAD/hsbCAD entities. You can manually move or stretch them using grips if minor adjustments are needed.\n\n## FAQ\n- **Q: Why didn't the script create battens around my door?**\n  **A:** Check the \"Apply Battens Around Doors\" property. It defaults to \"No\" to avoid interference with door frames. Change this to \"Yes\" and run the script again.\n  \n- **Q: Can I modify the batten size after running the script?**\n  **A:** You cannot change the settings via the script because it deletes itself upon completion. However, you can select the generated beams and use the AutoCAD Properties palette to manually change their Width or Height, or delete them and re-run the script with new settings.\n\n- **Q: The battens are being generated in the middle of the wall, not on the face.**\n  **A:** The \"Zone to assign the Battens\" determines the position. Change this index (e.g., from 1 to 2, or check your wall definition mappings) to shift the battens to the correct surface layer."
      },
      "tokens_used": 7119,
      "error": null
    }
  }
}