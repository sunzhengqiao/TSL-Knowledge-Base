{
  "filename": "hsb_AssignBeamToElementZone.mcr",
  "status": "completed",
  "total_tokens": 32763,
  "processing_time": 247.56074833869934,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 5854,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "No sd_* or Multipage* prefixes found. No _Viewport usage. Script interacts with GenBeam and Element objects directly, which are model-space entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 2101,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"Select elements\",\n        \"condition\": \"sFilterBeams property is not empty\",\n        \"required\": true\n      },\n      {\n        \"step\": 1,\n        \"function\": \"getElement\",\n        \"promptOriginal\": \"Select an element\",\n        \"condition\": \"sFilterBeams property is empty\",\n        \"required\": true\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"Select Beams or Sheets\",\n        \"condition\": \"sFilterBeams property is empty (follows element selection)\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sFilterBeams\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Find Beams with Code|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"|Separate multiple entries by| ;\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"nZones\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Zone to Assign the Beams or Sheets\",\n      \"defaultValue\": \"1\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"1\",\n        \"2\",\n        \"3\",\n        \"4\",\n        \"5\",\n        \"6\",\n        \"7\",\n        \"8\",\n        \"9\",\n        \"10\",\n        \"0\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sZoneColour\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Use Sheeting Zone Colour?\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": \"|Sets the colour of the beams from the selected zone|\"\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sSetBeamType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Set beam type?\",\n      \"defaultValue\": \"No\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"No\",\n        \"Yes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"pTypes\",\n      \"type\": \"PropString\",\n      \"displayName\": \"New beam type\",\n      \"defaultValue\": null,\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"_BeamTypes\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sModule\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Reset Module Information\",\n      \"defaultValue\": \"No"
      },
      "tokens_used": 6511,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Assigns specific structural beams or sheets to defined construction zones within an element, allowing for batch updates of properties like color, beam type, and module grouping based on zone settings.",
          "category": "Model Management / Data Organization",
          "typicalUseCase": "Used during the detailing or planning phase to categorize timber components (e.g., separating gable end studs from standard wall studs) for production filtering, visual differentiation in drawings, or specific machining requirements."
        },
        "parameters": [
          {
            "name": "sFilterBeams",
            "technicalDefault": "",
            "businessMeaning": "A text filter to identify specific beams within the selected elements based on their assigned Beam Code. This allows targeting specific subsets of members (e.g., only 'STUD' or 'RAFTER') rather than processing the entire element contents.",
            "validRange": "Any string matching existing Beam Codes. Multiple entries separated by semicolons (;).",
            "unit": "String (Text)",
            "affectsOutput": "Filters which beams in the element are updated. If empty, all beams (or manually selected beams) are processed. Controls whether the script prompts for an Element only (auto-filtering) or Element + Beams (manual selection)."
          },
          {
            "name": "nZones",
            "technicalDefault": "1",
            "businessMeaning": "The target construction zone number to which the beams will be assigned. Zones are logical groupings within an element used for sorting, reporting, or applying specific construction rules.",
            "validRange": "Integers 1 through 10, or 0. (Note: Internally, 6-9 map to negative zones -1 to -4).",
            "unit": "Count",
            "affectsOutput": "Sets the 'ElementGroup' (Zone) attribute of the beams. This influences how the beams are organized in lists, labels, and potentially how they react to other scripts that process specific zones."
          },
          {
            "name": "sZoneColour",
            "technicalDefault": "No",
            "businessMeaning": "Option to override the current display color of the beams to match the specific color defined for the selected zone in the project's element settings.",
            "validRange": "Yes, No",
            "unit": "Boolean (Option)",
            "affectsOutput": "If 'Yes', changes the visual color of the affected beams in the CAD model to match the Zone color. Does not change geometry, only visualization."
          },
          {
            "name": "sSetBeamType",
            "technicalDefault": "No",
            "businessMeaning": "Flag to enable or disable the changing of the Beam Type property (e.g., Material Grade or Structural Class) for the selected beams.",
            "validRange": "Yes, No",
            "unit": "Boolean (Option)",
            "affectsOutput": "If 'Yes', triggers the update of the beam's type property. Used in conjunction with the 'New beam type' parameter."
          },
          {
            "name": "pTypes",
            "technicalDefault": null,
            "businessMeaning": "The specific Beam Type selected from the catalog to apply to the beams if the 'Set beam type' option is active.",
            "validRange": "Any Beam Type available in the current hsbCAD Catalog (e.g., C24, GL24h).",
            "unit": "Enumeration (Catalog Entry)",
            "affectsOutput": "Updates the 'Beam Type' data attribute of the beams. This can affect material calculations, machining allowances, or engineering data exports."
          },
          {
            "name": "sModule",
            "technicalDefault": "No",
            "businessMeaning": "Option to clear or reset the Module assignment of the beams. Modules are often used to group elements for pre-assembly or transport.",
            "validRange": "Yes, No",
            "unit": "Boolean (Option)",
            "affectsOutput": "If 'Yes', clears the module information (sets to empty/null), effectively removing the beams from any specific module group."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sFilterBeams is populated (not empty)",
            "effect": "Changes the user input flow. The script will only prompt for Elements and automatically process internal beams matching the code. It skips the manual beam selection prompt.",
            "cascade": [
              "Insertion Logic (Step 1/2 prompts)"
            ]
          },
          {
            "trigger": "sSetBeamType is set to 'Yes'",
            "effect": "Makes the 'pTypes' (New beam type) parameter active and relevant. If 'No', 'pTypes' is ignored.",
            "cascade": [
              "pTypes"
            ]
          },
          {
            "trigger": "sZoneColour is set to 'Yes'",
            "effect": "Requires the 'nZones' parameter to determine which Zone's color setting to retrieve and apply.",
            "cascade": [
              "nZones"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Attribute Modification",
            "description": "The script modifies properties (Zone, Color, Type, Module) of existing GenBeam entities. It does not create new geometry.",
            "appliedTo": "GenBeams found within the selected Elements (filtered by code) or manually selected GenBeams."
          }
        ]
      },
      "tokens_used": 5087,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Start: Check execution context (_bOnInsert).",
          "2. Load Properties: Retrieve 'Find Beams with Code' (sFilterBeams) and other properties from catalog or previous instance.",
          "3. Parse Filters: Process sFilterBeams string into a token array (uppercase, trimmed) to determine if a beam code filter is active.",
          "4. Branch Selection: Check if beam code filter is active (bBmFilter).",
          "5. Path A (Filter Active): Prompt user to select Elements (PrEntity).",
          "6. Path B (Filter Inactive): Prompt user to select a single Element (getElement), then prompt to select Beams or Sheets (PrEntity).",
          "7. Insertion Complete: Store selected entities in script instance, exit insertion loop, and persist instance.",
          "8. Execution Phase: Iterate through selected Elements.",
          "9. Zone Configuration: Retrieve color settings for the target Zone (nZones) from the Element.",
          "10. Beam Collection: Gather all GenBeams from the Element (if filter active) or use manually selected Beams (if filter inactive).",
          "11. Beam Processing Loop: Iterate through gathered beams.",
          "12. Conditional Check: Verify if beam matches the filter code OR if no filter is set.",
          "13. Property Updates: Assign Beam to Element Group (Zone), update Color (if enabled), update Type (if enabled), clear Module (if enabled).",
          "14. Cleanup: Erase script instance (_bOnElementConstructed or nErase flag)."
        ],
        "conditionalBranches": [
          {
            "condition": "Is the 'Find Beams with Code' (sFilterBeams) property populated?",
            "path1": {
              "name": "Automatic Filter Mode",
              "steps": [
                "Parse sFilterBeams into array of codes.",
                "Display prompt: 'Select elements'.",
                "User selects one or more Elements.",
                "Execution processes ALL beams within those elements matching the filter codes."
              ]
            },
            "path2": {
              "name": "Manual Selection Mode",
              "steps": [
                "Display prompt: 'Select an element'.",
                "User selects exactly one Element.",
                "Display prompt: 'Select Beams or Sheets'.",
                "User selects specific GenBeams/Sheets.",
                "Execution processes ONLY the manually selected beams."
              ]
            }
          },
          {
            "condition": "Is 'Use Sheeting Zone Colour?' set to Yes?",
            "path1": {
              "name": "Update Color",
              "steps": [
                "Retrieve color index from Element's Zone definition (nZones).",
                "Apply color index to the beam using bm.setColor()."
              ]
            },
            "path2": {
              "name": "Preserve Color",
              "steps": [
                "Skip color assignment step."
              ]
            }
          },
          {
            "condition": "Is 'Set beam type?' set to Yes?",
            "path1": {
              "name": "Update Beam Type",
              "steps": [
                "Retrieve beam type index from pTypes property.",
                "Apply type to beam using bm.setType()."
              ]
            },
            "path2": {
              "name": "Preserve Beam Type",
              "steps": [
                "Skip type assignment step."
              ]
            }
          },
          {
            "condition": "Is 'Reset Module Information' set to Yes?",
            "path1": {
              "name": "Clear Module",
              "steps": [
                "Set beam module to empty string using bm.setModule(\"\")."
              ]
            },
            "path2": {
              "name": "Preserve Module",
              "steps": [
                "Skip module assignment step."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "Implicit. If no element is selected, _Element.length() is 0.",
            "recovery": "Script executes eraseInstance() immediately if _Element array is empty after insertion prompts."
          },
          {
            "check": "Beam Filter Match",
            "errorMessage": "None displayed silently.",
            "recovery": "If sFilterBeams is set, but a beam's code does not match, the loop skips that beam without action."
          },
          {
            "check": "Insertion Cycle",
            "errorMessage": "None.",
            "recovery": "Script checks if ( insertCycleCount() > 1 ) to prevent re-running insertion logic if the instance is regenerated."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties via OPM",
            "how": "Select the script instance and change properties in the Properties Palette (sFilterBeams, nZones, etc.).",
            "effect": "Changes in OPM trigger a recalculation, re-running the execution logic with new settings."
          },
          {
            "action": "Context Menu Recalculation",
            "how": "Right-click the script instance and select 'Recalculate'.",
            "effect": "Re-executes the assignment logic based on currently stored properties and element geometry."
          }
        ]
      },
      "tokens_used": 6175,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_AssignBeamToElementZone.mcr\n\n## Overview\nAssigns structural beams or sheets to specific construction zones (Element Groups) within an element. It allows batch updating of properties like color, beam type, and module grouping based on zone settings to help organize production data.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates directly on Elements and GenBeams. |\n| Paper Space | No | Not applicable for layout views. |\n| Shop Drawing | No | Not intended for detailing views. |\n\n## Prerequisites\n- **Required Entities:** Existing Elements and GenBeams in the model.\n- **Minimum Beam Count:** 0 (Script can run even if no beams are found, though no updates will occur).\n- **Required Settings:** None required; uses standard hsbCAD Catalogs for beam types.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or select from hsbCAD Scripts menu)\nAction: Select `hsb_AssignBeamToElementZone.mcr` from the file dialog.\n\n### Step 2: Select Input Mode (Based on Properties)\nThe script behavior depends on the \"Find Beams with Code\" property. By default, this is empty, triggering **Manual Selection Mode**.\n\n**Manual Selection Mode (Default):**\n```\nCommand Line: Select an element\nAction: Click on the main Element (wall/floor) containing the beams you want to modify.\n```\n```\nCommand Line: Select Beams or Sheets\nAction: Select the specific GenBeams or Sheets within that element. You can use a window selection.\n```\n\n**Automatic Filter Mode (If \"Find Beams with Code\" is populated):**\n*Note: To use this mode, select the script instance after insertion and edit the properties first, then Recalculate.*\n```\nCommand Line: Select elements\nAction: Select one or more Elements. The script will automatically find all beams inside these elements that match the specified Beam Codes.\n```\n\n## Properties Panel Parameters\nAfter inserting the script, select it to view these properties in the AutoCAD Properties Palette (OPM).\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Find Beams with Code | Text | (Empty) | Enter Beam Codes to filter (e.g., `STUD;RAFTER`). If left empty, you must manually select beams. Separate multiple codes with a semicolon (`;`). |\n| Zone to Assign | Number | 1 | Select the target Zone number (1-10). Zones are used to group elements for lists or production. Note: Options 6-9 map to internal negative zones (-1 to -4). |\n| Use Sheeting Zone Colour? | Dropdown | No | If set to **Yes**, the script changes the display color of the selected beams to match the color defined for the target Zone in your project settings. |\n| Set beam type? | Dropdown | No | If set to **Yes**, the script changes the material/structural type of the beams. |\n| New beam type | Dropdown | (Current) | The Beam Type to apply (e.g., C24, GL24h). Only active if \"Set beam type?\" is Yes. Populated from the hsbCAD Catalog. |\n| Reset Module Information | Dropdown | No | If set to **Yes**, clears the Module assignment for the selected beams, effectively removing them from any transport or assembly group. |\n\n## Right-Click Menu Options\nAfter inserting the script, select the script instance in the model and right-click to access:\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Re-runs the assignment logic. Use this after changing properties in the palette (e.g., changing the Zone number or Filter codes) to apply the new settings. |\n\n## Settings Files\n- **Filename:** None (Uses internal hsbCAD Catalog)\n- **Location:** N/A\n- **Purpose:** The script reads Beam Types directly from your active hsbCAD Catalog. Zone colors are read from the Element's project properties.\n\n## Tips\n- **Batch Processing:** Use the \"Find Beams with Code\" property to update all studs or rafters across multiple elements at once without manually picking every beam.\n- **Visual Organization:** Enable \"Use Sheeting Zone Colour\" to visually differentiate specific zones (e.g., making all Zone 2 beams appear Red) directly in the 3D model.\n- **Workflow:** Since the script persists in the drawing, you can select it later and change the Zone assignment to move the same set of beams to a different zone, then click Recalculate.\n\n## FAQ\n- **Q: I want to change the zone of every beam in a wall, not just specific ones. How do I do that?**\n  - A: Leave the \"Find Beams with Code\" property empty. Run the script, select the Element, and then window-select all beams when prompted.\n- **Q: What is the difference between Zone 6 and Zone -1?**\n  - A: In the dropdown, selecting Zone 6, 7, 8, or 9 assigns the beams to internal negative zones -1, -2, -3, or -4 respectively. This is often used for sheeting or specific sub-assembly groupings.\n- **Q: The script didn't change the color of my beams.**\n  - A: Ensure \"Use Sheeting Zone Colour?\" is set to **Yes** in the properties palette and that you have run **Recalculate**. Also, verify that a specific color is actually defined for that Zone in your Element defaults."
      },
      "tokens_used": 7035,
      "error": null
    }
  }
}