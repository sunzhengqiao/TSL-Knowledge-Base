{
  "filename": "Nail-SheetOnBeam.mcr",
  "status": "completed",
  "total_tokens": 49834,
  "processing_time": 677.1948053836823,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8736,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses PainterDefinition() and generates geometry for Beams and Sheets in the 3D model. Dialog creation explicitly references _kModelSpace: tslDialog.dbCreate(..., _kModelSpace, mapTsl);. No sd_* prefixes, #Type E structures, or _Viewport references are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Sheet"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing construction elements.",
          "requiredSettings": [
            "PainterDefinitions (requires hsbcad v23+)",
            "Nail-Configuration.xml (reads from _kPathHsbCompany or _kPathHsbInstall)"
          ]
        }
      },
      "tokens_used": 5183,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getString",
              "promptOriginal": "|Overwrite existing rule?| [|No|/|Yes|]",
              "condition": "Attempting to save a rule that already exists in the configuration.",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "TslDialog (Dynamic Form)",
            "trigger": "Context Menu: '|Add new Configuration|'",
            "title": "scriptName()",
            "dataSource": "Internal Properties (Nailing Set)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "TslDialog (Dynamic Form)",
            "trigger": "Context Menu: '|Remove Configuration|'",
            "title": "scriptName()",
            "dataSource": "Internal Properties (Remove Set)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "TslDialog (Dynamic Form)",
            "trigger": "Context Menu: '|Save as rule|'",
            "title": "scriptName()",
            "dataSource": "Internal Properties (Configuration, Rule Name)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          },
          {
            "type": "TslDialog (Dynamic Form)",
            "trigger": "Context Menu: '|Delete rule|'",
            "title": "scriptName()",
            "dataSource": "Internal Properties (Configuration, Rule Name)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": "nStringIndex++",
            "variable": "sConfiguration",
            "type": "PropString",
            "displayName": "|Nailing Set|",
            "defaultValue": "|Configuration|",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": "|Defines the name of a configuration|"
          },
          {
            "index": "nStringIndex++",
            "variable": "sConfiguration",
            "type": "PropString",
            "displayName": "|Remove Set|",
            "defaultValue": "sConfigurations",
            "inputType": "dropdown",
            "options": "sConfigurations (Dynamic list from settings)",
            "category": null,
            "description": "|Defines the name of a configuration which will be removed.|"
          },
          {
            "index": "nStringIndex++",
            "variable": "sConfiguration",
            "type": "PropString",
            "displayName": "|Configuration|",
            "defaultValue": "sConfigurations",
            "inputType": "dropdown",
            "options": "sConfigurations (Dynamic list from settings)",
            "category": null,
            "description": "|Defines the name of a configuration|"
          },
          {
            "index": "nStringIndex++",
            "variable": "sRuleName",
            "type": "PropString",
            "displayName": "|Rule Name|",
            "defaultValue": "|Rule Name|",
            "inputType": "text",
            "options": [],
            "category": "|General|",
            "description": "|Defines the name of he rule|"
          },
          {
            "index": "nStringIndex++",
            "variable": "sConfiguration",
            "type": "PropString",
            "displayName": "|Configuration|",
            "defaultValue": "sConfigurations",
            "inputType": "dropdown",
            "options": "sConfigurations (Dynamic list from settings)",
            "category": null,
            "description": "|Defines the name of a configuration|"
          },
          {
            "index": "nStringIndex++",
            "variable": "sRuleName",
            "type": "PropString",
            "displayName": "|Rule Name|",
            "defaultValue": "sRules",
            "inputType": "dropdown",
            "options": "sRules (Dynamic list from selected configuration)",
            "category": "|General|",
            "description": "|Defines the name of he rule which will be deleted on OK|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Edit in Place|",
            "handler": "|Edit in Place|",
            "action": "Recalculates the script instance for in-place editing.",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "|Add new Configuration|",
            "handler": "|Add new Configuration|",
            "action": "Opens dialog to create a new nailing configuration.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove Configuration|",
            "handler": "|Remove Configuration|",
            "action": "Opens dialog to remove an existing nailing configuration.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Save as rule|",
            "handler": "|Save as rule|",
            "action": "Opens dialog to save current properties as a rule within a configuration.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Delete rule| (ConfigurationName)",
            "handler": "|Delete rule|",
            "action": "Opens dialog to delete a specific rule from a specific configuration.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Show Rule Definitions|",
            "handler": "|Show Rule Definitions|",
            "action": "Prints all configurations and rules to the report console.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Nail-Configuration.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings",
              "_kPathHsbInstall\\Content\\General\\TSL\\Settings"
            ],
            "purpose": "Stores the nailing configurations and rules (PainterDefinitions).",
            "required": true
          }
        ]
      },
      "tokens_used": 7992,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Automates the generation of nail patterns (naillines) on structural timber and sheet materials based on predefined configurations and painter definitions.\",\n    \"category\": \"Machining/Hardware\",\n    \"typicalUseCase\": \"Applying sheathing schedules (e.g., nailing patterns for OSB or Plywood) to timber wall panels or roof elements, and managing the library of these nailing rules.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sConfiguration (Nailing Set)\",\n      \"technicalDefault\": \"\\\"|Configuration|\\\"\",\n      \"businessMeaning\": \"The name assigned to a new group of nailing rules (e.g., 'Standard Sheathing', 'Floor Decking'). This acts as a category or folder for organizing different nailing patterns.\",\n      \"validRange\": \"String (text). Must be unique to avoid conflicts.\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Creates a new container in the configuration XML where rules can be stored. Does not directly create geometry, but enables organization of machining instructions.\"\n    },\n    {\n      \"name\": \"sConfiguration (Remove Set)\",\n      \"technicalDefault\": \"sConfigurations (Dynamic List)\",\n      \"businessMeaning\": \"Selects an existing group of nailing rules to be permanently deleted from the project configuration.\",\n      \"validRange\": \"List of existing Configuration names.\",\n      \"unit\": \"Text (Selection)\",\n      \"affectsOutput\": \"Removes the selected group and all rules contained within it from the available settings, preventing their future use until re-created or imported.\"\n    },\n    {\n      \"name\": \"sConfiguration (Parent Configuration)\",\n      \"technicalDefault\": \"sConfigurations (Dynamic List)\",\n      \"businessMeaning\": \"The specific group (category) selected to either save a new nailing rule into or delete an existing rule from.\",\n      \"validRange\": \"List of existing Configuration names.\",\n      \"unit\": \"Text (Selection)\",\n      \"affectsOutput\": \"Determines the storage location for new rule definitions or filters the list of available rules for deletion operations.\"\n    },\n    {\n      \"name\": \"sRuleName (New Rule)\",\n      \"technicalDefault\": \"\\\"|Rule Name|\\\"\",\n      \"businessMeaning\": \"The unique identifier for a specific nailing pattern (e.g., 'Nail 150/300', 'Edge Nail 100'). This represents a specific set of geometric parameters (spacing, offsets, nail type) being saved.\",\n      \"validRange\": \"String (text). Must be unique within the selected Configuration.\",\n      \"unit\": \"Text\",\n      \"affectsOutput\": \"Stores the current script properties (nailing geometry) into the database under this name, making it a reusable preset for generating actual nail lines.\"\n    },\n    {\n      \"name\": \"sRuleName (Delete Rule)\",\n      \"technicalDefault\": \"sRules (Dynamic List)\",\n      \"businessMeaning\": \"Selects a specific nailing pattern preset to be removed from the selected configuration.\",\n      \"validRange\": \"List of existing Rule names within the selected Configuration.\",\n      \"unit\": \"Text (Selection)\",\n      \"affectsOutput\": \"Deletes the specific preset definition. Future use of this rule name will not be possible unless recreated.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"User selects 'sConfiguration' in Delete Rule mode\",\n      \"effect\": \"Updates the list of available rules in 'sRuleName' dropdown.\",\n      \"cascade\": [\n        \"sRuleName\"\n      ]\n    },\n    {\n      \"trigger\": \"User enters a 'sConfiguration' name that already exists in Add mode\",\n      \"effect\": \"Triggers a command line prompt asking if the user wants to overwrite the existing configuration.\",\n      \"cascade\": [\n        \"mapSetting\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"NailLines\",\n      \"description\": \"Linear or grid representations of fasteners applied to the surface of elements.\",\n      \"appliedTo\": \"GenBeams (structural timber) and Sheets (sheathing materials)\"\n    },\n    {\n      \"type\": \"PainterDefinitions\",\n      \"description\": \"Internal logic definitions used to detect valid nailing areas on complex geometries.\",\n      \"appliedTo\": \"Internal Database"
      },
      "tokens_used": 10348,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launch: Load 'Nail-Configuration.xml' settings from Company or Install path.",
          "2. Check execution state: Is the script running via a specific Context Menu trigger (e.g., Add Configuration, Save Rule)?",
          "3. [Branch - Management Mode] If triggered: Execute management workflow (Set DialogMode -> Show Dynamic Dialog -> Update XML Settings -> Return).",
          "4. [Branch - Generation Mode] If not triggered (Insert or Edit): Initialize standard geometric properties (Offsets, Spacings, Strategies).",
          "5. Check Property 'sSelectionRule': If a rule is selected, auto-populate properties from the loaded settings.",
          "6. User Input (_bOnInsert): Prompt user to select Beams or Sheets. Store selection in ElementArray.",
          "7. Geometry Processing Loop: Iterate through selected elements.",
          "8. Detect valid nailing areas using PainterDefinitions (e.g., 'Nailing\\bySheet').",
          "9. Calculate Nail pattern based on offsets, distances (X/Y), and distribution strategies (Fixed, Count, etc.).",
          "10. Generate NailLine entities into the model.",
          "11. Post-Process Validation: Check if any NailLines were generated.",
          "12. [Branch - Purge] If NailLines count is 0: Erase the script instance automatically.",
          "13. If NailLines count > 0: Keep instance attached to elements."
        ],
        "conditionalBranches": [
          {
            "condition": "Saving a Configuration or Rule with an existing name.",
            "path1": {
              "name": "Overwrite",
              "steps": [
                "Script detects existing name in mapSetting.",
                "Prompt command line: 'Overwrite existing...? [No/Yes]'.",
                "User enters 'Yes'.",
                "Script overwrites existing entry in XML.",
                "Report success message."
              ]
            },
            "path2": {
              "name": "Cancel",
              "steps": [
                "Script detects existing name in mapSetting.",
                "Prompt command line: 'Overwrite existing...? [No/Yes]'.",
                "User enters 'No' or default.",
                "Script reports operation canceled.",
                "Settings remain unchanged."
              ]
            }
          },
          {
            "condition": "Initial Parameter Input",
            "path1": {
              "name": "Rule Based",
              "steps": [
                "User selects an entry from 'sSelectionRule' dropdown.",
                "Script retrieves 'PropertyMap' from XML.",
                "Script applies all stored parameters (offsets, spacings, etc.) automatically.",
                "User selects geometry to nail."
              ]
            },
            "path2": {
              "name": "Manual",
              "steps": [
                "User leaves 'sSelectionRule' as default or empty.",
                "User manually inputs Offsets, Distances, and Strategies via OPM or Dialog.",
                "User selects geometry to nail."
              ]
            }
          },
          {
            "condition": "Deleting a Rule",
            "path1": {
              "name": "Dynamic Context Menu",
              "steps": [
                "Script iterates through all configurations found in settings.",
                "Generates unique context menu items for each: 'Delete rule (ConfigurationName)'.",
                "User clicks specific item.",
                "Dialog opens pre-filtered for that specific Configuration."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of 'Nail-Configuration.xml'.",
            "errorMessage": "ReportNotice if no settings file found in Company or Install path.",
            "recovery": "Script creates a default MapObject, but user needs to import XML or manually create configurations via context menu."
          },
          {
            "check": "PainterDefinitions availability.",
            "errorMessage": "Log info if a painter could not find requested entities (HSB-12218).",
            "recovery": "Ensure hsbcad version is >= 23 and that valid geometry exists to define the nailing surface."
          },
          {
            "check": "Geometry Generation Result.",
            "errorMessage": "None (Silent failure).",
            "recovery": "Script automatically erases itself (eraseInstance) if segNails.length() < 1, preventing empty instances in the drawing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Geometry Parameters",
            "how": "Double Click (Edit in Place) or Properties Palette (OPM)",
            "effect": "Modifies offsets, grid spacing, or nailing strategies for the existing instance."
          },
          {
            "action": "Manage Configurations",
            "how": "Right-click Context Menu -> 'Add new Configuration' or 'Remove Configuration'",
            "effect": "Adds or removes a container (category) for rules in the global settings XML."
          },
          {
            "action": "Manage Rules",
            "how": "Right-click Context Menu -> 'Save as rule' or 'Delete rule'",
            "effect": "Saves current instance settings as a reusable preset or deletes a preset from the XML."
          },
          {
            "action": "Inspect Rules",
            "how": "Right-click Context Menu -> 'Show Rule Definitions'",
            "effect": "Outputs a full text report of all configurations and their parameters to the report console."
          }
        ]
      },
      "tokens_used": 10729,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# Nail-SheetOnBeam.mcr\n\n## Overview\nThis script automates the generation of nail patterns (naillines) on structural timber and sheet materials. It allows users to apply predefined sheathing schedules (e.g., for OSB or Plywood) to wall panels or roof elements and manage a library of these nailing rules via configuration files.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Generates 3D geometry and machining. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | Not applicable. |\n\n## Prerequisites\n- **Required Entities**: `GenBeam` or `Sheet` elements.\n- **Minimum Beam Count**: 0 (You can select a single sheet or multiple beams).\n- **Required Settings**:\n  - `Nail-Configuration.xml` (Must exist in `_kPathHsbCompany\\TSL\\Settings` or `_kPathHsbInstall\\Content\\General\\TSL\\Settings`).\n  - hsbcad version 23 or higher (for PainterDefinitions support).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `Nail-SheetOnBeam.mcr`\n\n### Step 2: Select Elements\n```\nCommand Line: Select Beams or Sheets\nAction: Click on the timber beams or sheet material you want to apply nailing to, then press Enter.\n```\n\n### Step 3: Configuration\nThe script will attempt to apply the default nailing rule.\n- **If using a preset**: Ensure the desired Configuration and Rule Name are selected in the Properties Palette before inserting.\n- **If manual**: Adjust geometric properties (offsets, spacing) in the Properties Palette after insertion.\n\n### Step 4: (Optional) Save Settings\nIf you have manually adjusted the nailing pattern and wish to reuse it:\n1. Right-click the script instance.\n2. Select **Save as rule**.\n3. Enter the Configuration name and Rule Name in the dialog that appears.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Nailing Set** | Text | \"Configuration\" | Enter the name for a new group of nailing rules (e.g., \"Standard Sheathing\"). |\n| **Remove Set** | Dropdown | *Dynamic* | Select an existing group of nailing rules to permanently delete it. |\n| **Configuration** | Dropdown | *Dynamic* | Select a specific group (category) to save a new rule into or delete an existing rule from. |\n| **Rule Name** | Text | \"Rule Name\" | Enter a unique name for a specific nailing pattern (e.g., \"Nail 150/300\") when saving a new rule. |\n| **Rule Name (Delete)** | Dropdown | *Dynamic* | Select a specific nailing pattern preset to delete from the currently selected Configuration. |\n\n*Note: Standard geometric parameters (Offsets, Spacings) are also available in the Properties Palette but are intended to be managed via the \"Save as rule\" workflow.*\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Edit in Place** | Activates the script for modification. Can also be triggered by double-clicking the instance. |\n| **Add new Configuration** | Opens a dialog to create a new group/container for organizing nailing rules. |\n| **Remove Configuration** | Opens a dialog to delete an existing group and all its rules from the settings file. |\n| **Save as rule** | Opens a dialog to save the current instance's settings (spacing, offsets) as a reusable preset. |\n| **Delete rule (ConfigurationName)** | Opens a dialog filtered to a specific configuration to allow deletion of a specific nailing preset. |\n| **Show Rule Definitions** | Prints a text report of all configurations and their parameters to the report console. |\n\n## Settings Files\n- **Filename**: `Nail-Configuration.xml`\n- **Location**: Searches in `Company\\TSL\\Settings` or `Install\\Content\\General\\TSL\\Settings`.\n- **Purpose**: Stores all defined nailing configurations (PainterDefinitions) and rule parameters.\n\n## Tips\n- **Purge Empty Instances**: The script automatically deletes itself if no valid nail lines are generated during the calculation.\n- **Overwriting**: If you try to save a rule with a name that already exists, look at the command line. You will be prompted: `Overwrite existing rule? [No/Yes]`. Type `Y` and Enter to confirm.\n- **Rule Management**: Use the dynamic menu item **Delete rule (ConfigurationName)** to quickly access the specific configuration you are working with without scrolling through the master list.\n\n## FAQ\n- **Q: Why did the script disappear after I inserted it?**\n  A: The script automatically erases itself if it does not generate any nail lines. Check that your selected elements have valid surfaces and that the PainterDefinitions are active.\n- **Q: Where are my nail rules stored?**\n  A: They are stored in the `Nail-Configuration.xml` file. If you move the project to a new PC, you may need to copy this XML file to retain your custom rules.\n- **Q: How do I change the nailing pattern on a single sheet without changing the rule?**\n  A: Double-click the instance (Edit in Place), change the parameters in the Properties Palette, and ensure you do not use the \"Save as rule\" option, or save it under a new name."
      },
      "tokens_used": 6846,
      "error": null
    }
  }
}