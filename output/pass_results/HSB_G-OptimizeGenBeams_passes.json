{
  "filename": "HSB_G-OptimizeGenBeams.mcr",
  "status": "completed",
  "total_tokens": 47096,
  "processing_time": 490.61648058891296,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": [],\n    \"majorVersion\": 1,\n    \"minorVersion\": 2,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.00\",\n      \"date\": \"13.04.2017\",\n      \"author\": \"YB\",\n      \"changes\": \"Pilot version\"\n    },\n    {\n      \"version\": \"1.01\",\n      \"date\": \"14.04.2017\",\n      \"author\": \"YB\",\n      \"changes\": \"Started with setting up the filter\"\n    },\n    {\n      \"version\": \"1.02\",\n      \"date\": \"14.04.2017\",\n      \"author\": \"YB\",\n      \"changes\": \"Improved the filter, fixed sheet optimizing\"\n    },\n    {\n      \"version\": \"2.00\",\n      \"date\": \"11.11.2020\",\n      \"author\": \"RP\",\n      \"changes\": \"Tsl can be used on element generation, take side from element distribution\"\n    },\n    {\n      \"version\": \"2.4\",\n      \"date\": \"20/07/2023\",\n      \"author\": \"Robert Pol\",\n      \"changes\": \"Fix genbeamX not aligned to element\"\n    },\n    {\n      \"version\": \"2.3\",\n      \"date\": \"01/06/2023\",\n      \"author\": \"Robert Pol\",\n      \"changes\": \"Add option to use start and or end as split position\"\n    },\n    {\n      \"version\": \"2.2\",\n      \"date\": \"12/08/2022\",\n      \"author\": \"Robert Pol\",\n      \"changes\": \"Add distribute evenly prop\"\n    },\n    {\n      \"version\": \"2.1\",\n      \"date\": \"22/07/2021"
      },
      "tokens_used": 7919,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script performs geometric operations (dbSplit) on 3D entities like GenBeam, Element, Sheet, and Beam. It uses PrEntity to select elements directly. No PaperSpace indicators (_Viewport, _kPaperSpace, addToMultiPage) or ShopDrawing specific markers (sd_ prefix) are present. It modifies the model structure rather than generating 2D views."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element",
            "Sheet",
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "HSB_G-FilterGenBeams",
            "HSB_G-Distribution"
          ]
        }
      },
      "tokens_used": 5860,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)| <ENTER> |to select genbeams|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select genbeam(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "_bOnInsert (if no execute key)",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": null,
              "multiSelect": null
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "pDistribution",
            "type": "PropString",
            "displayName": "|Distribution|",
            "defaultValue": "|Left|",
            "inputType": "dropdown",
            "options": [
              "|Left|",
              "|Right|",
              "|Center|",
              "|Center, no beam in center|"
            ],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 0,
            "variable": "pSplitLength",
            "type": "PropDouble",
            "displayName": "|Split length|",
            "defaultValue": "5400",
            "inputType": "number",
            "options": [],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 1,
            "variable": "pSplitGap",
            "type": "PropDouble",
            "displayName": "|Gap|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 2,
            "variable": "pStartOffset",
            "type": "PropDouble",
            "displayName": "|Start offset|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 3,
            "variable": "pEndOffset",
            "type": "PropDouble",
            "displayName": "|End offset|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 2,
            "variable": "pDistributeEvenly",
            "type": "PropString",
            "displayName": "|Distribute evenly|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 3,
            "variable": "pUseStartAsPosition",
            "type": "PropString",
            "displayName": "|Split at start|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 4,
            "variable": "pUseEndAsPosition",
            "type": "PropString",
            "displayName": "|Split at end|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": "|Distribution|",
            "description": null
          },
          {
            "index": 1,
            "variable": "filterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition beams|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [
              "HSB_G-FilterGenBeams"
            ],
            "category": "|Filter|",
            "description": "|Filter definition for beams.| |Use| HSB_G-FilterGenBeams |to define the filters|."
          }
        ],
        "contextMenu": [
          {
            "menuItem": "ManualInsert",
            "handler": "ManualInsert",
            "action": "Runs the optimization process based on current properties and selection.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "HSB_G-FilterGenBeams",
            "searchPaths": [
              "Catalog"
            ],
            "purpose": "Provides filter definitions for selecting specific beams.",
            "required": true
          },
          {
            "filename": "HSB_G-Distribution",
            "searchPaths": [
              "Catalog"
            ],
            "purpose": "Calculates the split positions based on distribution parameters.",
            "required": true
          }
        ]
      },
      "tokens_used": 7268,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically splits long generic beams, sheets, or structural panels into smaller, manageable segments based on specific lengths, gaps, and alignment rules to optimize for transport or manufacturing constraints.",
          "category": "Framing/Optimization",
          "typicalUseCase": "Splitting long roof purlins, floor joists, or wall panels into standard transport lengths (e.g., 6000mm) while managing overlaps or gaps."
        },
        "parameters": [
          {
            "name": "pDistribution",
            "technicalDefault": "|Left|",
            "businessMeaning": "Controls the alignment logic for splitting the beam relative to its start point. It determines if the first segment starts at the beginning ('Left'), the last segment ends at the end ('Right'), or if segments are centered.",
            "validRange": "Left, Right, Center, Center, no beam in center",
            "unit": "enum",
            "affectsOutput": "Alters the placement of cut points along the beam. 'Left' fills from the start, 'Right' fills from the end, and 'Center' balances the leftover length on both ends."
          },
          {
            "name": "pSplitLength",
            "technicalDefault": "5400",
            "businessMeaning": "The target length for each resulting segment after splitting.",
            "validRange": "1000 - 18000",
            "unit": "mm",
            "affectsOutput": "Determines the primary size of the cut pieces. Larger values reduce the number of cuts; smaller values increase fragmentation."
          },
          {
            "name": "pSplitGap",
            "technicalDefault": "0",
            "businessMeaning": "The distance maintained between adjacent split segments (e.g., for expansion gaps or visual separation).",
            "validRange": "0 - 50",
            "unit": "mm",
            "affectsOutput": "Physically separates the resulting beams. If > 0, the total length of the assembly increases, or the segments shorten to fit within the original bounds if 'Distribute Evenly' is active."
          },
          {
            "name": "pStartOffset",
            "technicalDefault": "0",
            "businessMeaning": "A reserved buffer zone at the start of the beam where no splits are allowed.",
            "validRange": "0 - (Total Length)",
            "unit": "mm",
            "affectsOutput": "Shifts the first split position inward, ensuring the first segment is longer than the standard split length."
          },
          {
            "name": "pEndOffset",
            "technicalDefault": "0",
            "businessMeaning": "A reserved buffer zone at the end of the beam where no splits are allowed.",
            "validRange": "0 - (Total Length)",
            "unit": "mm",
            "affectsOutput": "Shifts the last split position inward, ensuring the last segment is longer than the standard split length."
          },
          {
            "name": "pDistributeEvenly",
            "technicalDefault": "|No|",
            "businessMeaning": "When enabled, forces all intermediate segments to be identical in length, adjusting the start/end segments to absorb the remainder.",
            "validRange": "No, Yes",
            "unit": "bool",
            "affectsOutput": "Ensures uniform spacing of cuts. The actual segment length may deviate slightly from 'Split length' to fit the total available space exactly."
          },
          {
            "name": "pUseStartAsPosition",
            "technicalDefault": "|No|",
            "businessMeaning": "Forces a split to occur exactly at the start of the beam (plus offset).",
            "validRange": "No, Yes",
            "unit": "bool",
            "affectsOutput": "Ensures the very first cut is made at the start offset, regardless of whether it fits the standard pattern."
          },
          {
            "name": "pUseEndAsPosition",
            "technicalDefault": "|No|",
            "businessMeaning": "Forces a split to occur exactly at the end of the beam (minus offset).",
            "validRange": "No, Yes",
            "unit": "bool",
            "affectsOutput": "Ensures the very last cut is made at the end offset, regardless of whether it fits the standard pattern."
          },
          {
            "name": "filterDefinition",
            "technicalDefault": "",
            "businessMeaning": "Selects a specific filter set (from HSB_G-FilterGenBeams) to choose which beams to split from a larger selection.",
            "validRange": "Catalog Entries (HSB_G-FilterGenBeams)",
            "unit": "string",
            "affectsOutput": "Filters the input selection. Only beams matching the criteria in the chosen filter will be split; others remain unchanged."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "ElementRoof.beamDistribution() is 'R'",
            "effect": "The script automatically inverts the distribution direction (swapping Left/Right) to match the roof beam distribution logic.",
            "cascade": [
              "pDistribution"
            ]
          },
          {
            "trigger": "pDistributeEvenly = |Yes|",
            "effect": "The script prioritizes equal spacing over strict adherence to 'Split length', calculating an exact fit.",
            "cascade": [
              "pSplitLength",
              "pSplitGap"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam",
            "description": "The original beam is replaced by multiple new GenBeam entities corresponding to the calculated segments.",
            "appliedTo": "Selected GenBeams"
          },
          {
            "type": "Sheet",
            "description": "If the input is a sheet (e.g., CLT panel), it is split using a planar cut, generating new Sheet entities.",
            "appliedTo": "Selected Sheets"
          },
          {
            "type": "Sip",
            "description": "Structural Insulated Panels are split using a planar cut, generating new Sip entities.",
            "appliedTo": "Selected Sips"
          },
          {
            "type": "Beam",
            "description": "Standard timber beams are split at the calculated points, generating new Beam entities.",
            "appliedTo": "Selected Beams"
          }
        ]
      },
      "tokens_used": 8506,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script initialization: Load properties, constants, and default catalog values.",
          "Check execution context: Is this a manual insert or an automated execution (via Element generation)?",
          "[Manual Insert Only] Show Properties Dialog for user configuration.",
          "[Manual Insert Only] Prompt user to select Element(s).",
          "[Branch] If Element(s) selected: Attach script instances to selected elements and terminate original instance.",
          "[Branch] If no Element(s) selected: Prompt user to select GenBeam(s) directly.",
          "[Execution Phase] Aggregate all GenBeams (from attached Elements or direct selection) into a processing list.",
          "Apply Filter: Execute 'HSB_G-FilterGenBeams' to exclude specific beams based on catalog settings.",
          "Loop through each filtered GenBeam.",
          "Determine Geometry: Calculate beam vector, length, and orientation (handle ElementRoof distribution direction).",
          "Calculate Split Positions: Call 'HSB_G-Distribution' to determine where cuts should occur based on Length, Gap, and Offsets.",
          "Perform Splits: Iterate through calculated positions and execute split operations.",
          "[Branch] Split Logic: Use planar cut for Sheets/Sips, linear split for Beams.",
          "Collect resulting segments into a final list.",
          "Update Map/Database: Store new entities in the map or replace old entities.",
          "Cleanup: Erase the script instance from the drawing."
        ],
        "conditionalBranches": [
          {
            "condition": "User input during Element selection prompt (Manual Insert)",
            "path1": {
              "name": "Elements Selected",
              "steps": [
                "User selects one or more Elements.",
                "Script iterates through selected Elements.",
                "Script creates a new instance of itself attached to each Element via 'dbCreate'.",
                "Original script instance is erased.",
                "New instances enter Execution Phase automatically."
              ]
            },
            "path2": {
              "name": "No Elements Selected (Enter pressed)",
              "steps": [
                "Prompt for GenBeam selection is triggered.",
                "User selects specific GenBeam entities.",
                "Script processes these beams directly."
              ]
            }
          },
          {
            "condition": "Entity type identified during processing loop",
            "path1": {
              "name": "Sheet or Sip",
              "steps": [
                "Cast entity to Sheet or Sip type.",
                "Calculate splitting plane at the split point.",
                "Execute 'dbSplit' with Plane and Gap parameters.",
                "Add resulting Sheet/Sip entities to the split list."
              ]
            },
            "path2": {
              "name": "Beam",
              "steps": [
                "Cast entity to Beam type.",
                "Execute 'dbSplit' using Point and Vector (plus Gap).",
                "Add resulting Beam entity to the split list."
              ]
            }
          },
          {
            "condition": "Element Roof Distribution Setting",
            "path1": {
              "name": "Distribution is 'R' (Right)",
              "steps": [
                "Script detects 'R' in ElementRoof.beamDistribution().",
                "Inverts the split direction calculation (multiplies distributionDirection by -1).",
                "Updates pDistribution property visually to match the inverted logic."
              ]
            },
            "path2": {
              "name": "Distribution is 'L' or Standard",
              "steps": [
                "Split calculation proceeds using standard pDistribution property values."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Selection Availability",
            "errorMessage": "|No genbeams or element found|",
            "recovery": "User must select valid Elements or GenBeams to run the script."
          },
          {
            "check": "Filter Script Availability",
            "errorMessage": "|Beams could not be filtered!| |Make sure that the tsl| HSB_G-FilterGenBeams |is loaded in the drawing|.",
            "recovery": "Ensure 'HSB_G-FilterGenBeams.mcr' is present in the TSL catalog or loaded in the drawing."
          },
          {
            "check": "Distribution Script Availability",
            "errorMessage": "|Beams could not be distributed!| |Make sure that the tsl| HSB_G-Distribution |is loaded in the drawing|.",
            "recovery": "Ensure 'HSB_G-Distribution.mcr' is present in the TSL catalog or loaded in the drawing."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Re-run Optimization",
            "how": "Re-insert script or execute catalog entry",
            "effect": "The script instance erases itself immediately after execution. To modify the result, the user must run the script again on the new entities or undo the operation."
          }
        ]
      },
      "tokens_used": 10128,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-OptimizeGenBeams.mcr\n\n## Overview\nThis script automatically splits long generic beams, sheets, or structural panels into smaller, manageable segments. It optimizes lengths for transport or manufacturing by calculating cut positions based on user-defined lengths, gaps, and alignment rules.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates on 3D model entities. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | Not intended for generating views. |\n\n## Prerequisites\n- **Required Entities**: GenBeam, Element, Sheet, or Beam entities must exist in the drawing.\n- **Minimum Beam Count**: 1\n- **Required Settings Files**:\n    - `HSB_G-FilterGenBeams.mcr`: For filtering specific beams.\n    - `HSB_G-Distribution.mcr`: For calculating split positions.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Browse the catalog and select `HSB_G-OptimizeGenBeams.mcr`.\n\n### Step 2: Select Input Entities\nThe script will prompt you to select how it targets beams:\n```\nCommand Line: Select element(s) <ENTER> to select genbeams\n```\n- **Option A (Elements)**: Click one or more Elements in the drawing. The script will attach itself to these elements and process relevant beams automatically upon generation.\n- **Option B (Specific Beams)**: Press `ENTER`. The prompt will change to `Select genbeam(s)`. Click the specific beams, sheets, or panels you wish to split.\n\n### Step 3: Configure Parameters\n1. Once selected, the Properties Palette will display the script parameters.\n2. Adjust the **Distribution**, **Split length**, **Gap**, and **Offsets** as needed.\n3. Right-click and select **ManualInsert** (or click the \"Run\" button in your catalog browser if applicable) to execute the split.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Distribution | Dropdown | Left | Determines alignment: <br>**Left**: First segment starts at beam origin.<br>**Right**: Last segment ends at beam end.<br>**Center**: Segments are centered on the beam.<br>**Center, no beam in center**: Centers segments but leaves the middle empty. |\n| Split length | Number | 5400 mm | The target length for the resulting segments. |\n| Gap | Number | 0 mm | The distance left between split segments (e.g., for expansion joints). |\n| Start offset | Number | 0 mm | A buffer zone at the start of the beam where no splits occur. |\n| End offset | Number | 0 mm | A buffer zone at the end of the beam where no splits occur. |\n| Distribute evenly | Dropdown | No | If **Yes**, forces all intermediate segments to be identical in length, adjusting slightly from the target \"Split length\" to fit perfectly. |\n| Split at start | Dropdown | No | If **Yes**, forces a split exactly at the start offset position. |\n| Split at end | Dropdown | No | If **Yes**, forces a split exactly at the end offset position. |\n| Filter definition beams | Dropdown | *Empty* | Select a filter from `HSB_G-FilterGenBeams` to only process beams that match specific criteria. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| ManualInsert | Executes the optimization process immediately using the current property settings and selected entities. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams.mcr`\n  - **Location**: TSL Catalog\n  - **Purpose**: Allows you to define rules (e.g., name, material, height) to filter which beams within an Element should be split.\n- **Filename**: `HSB_G-Distribution.mcr`\n  - **Location**: TSL Catalog\n  - **Purpose**: Handles the complex mathematical calculations required to determine exact split positions based on your offsets and distribution settings.\n\n## Tips\n- **Using Elements**: Selecting an Element rather than individual beams allows this script to run automatically during future element generations or updates.\n- **Avoiding Small Offcuts**: If you have a long beam that doesn't divide evenly by your split length, enable **Distribute Evenly**. This will adjust all segments slightly to ensure they are equal, preventing one tiny piece at the end.\n- **Roof Logic**: If used on a Roof Element with \"Right\" beam distribution set, the script automatically inverts the split direction to match the roof layout.\n- **Gaps**: Remember that adding a **Gap** increases the total span of the assembly. If you need the overall assembly to stay the same length, use **Distribute Evenly** to compensate.\n\n## FAQ\n- **Q: I get the error \"Beams could not be filtered!\"**\n  - A: Ensure the script `HSB_G-FilterGenBeams.mcr` is loaded in your drawing or available in your active catalog.\n- **Q: I get the error \"Beams could not be distributed!\"**\n  - A: Ensure the script `HSB_G-Distribution.mcr` is loaded in your drawing or available in your active catalog.\n- **Q: Can I undo the split?**\n  - A: Yes, use the standard AutoCAD `UNDO` command immediately after running the script.\n- **Q: What happens to the original beam?**\n  - A: The original beam is erased and replaced by the new split segments. The script instance also erases itself after completion."
      },
      "tokens_used": 7415,
      "error": null
    }
  }
}