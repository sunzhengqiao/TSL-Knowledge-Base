{
  "filename": "hsbCLT-SubNesting.mcr",
  "status": "completed",
  "total_tokens": 57250,
  "processing_time": 311.3428370952606,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8893,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script filename starts with 'hsb' (Model script convention). Logic operates on 'Element' and 'Sip' (Single Instance Panel) objects which are Model entities. Implements 'DimRequest[]' map structure to output geometry and text specifically for consumption by ShopDrawing scripts (e.g., sd_EntitySymbolDisplay). Comments explicitly state 'supports shopdrawing display'."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (Master Panel)"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "Map entries for 'Tool[]' (referenced for tool cloning logic)",
            "Map entry for 'Format' (optional, used for naming)"
          ]
        }
      },
      "tokens_used": 7451,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "SelectFromList",
            "trigger": "Double-click on instance (TslDoubleClick)",
            "title": "Select Property",
            "dataSource": "Internal list (Name, Label, Sublabel, Sublabel2, Grade, Material, Information)",
            "features": {
              "searchable": true,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDiameter",
            "type": "PropString",
            "displayName": "|Diameter|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Category|",
            "description": "|Defines the diameter, a range of diameters (i.e. 0-20 to consume all diameters up to 20mm) or a list of diameters (i.e. 20;40 to consume only diameter 20mm and 40mm).||Empty = all diameters|"
          },
          {
            "index": 1,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|Perpendicular|",
              "|Beveled|"
            ],
            "category": "|Category|",
            "description": "|Defines the alignment which must apply to a drill|"
          },
          {
            "index": 2,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "|Face|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|bottom|",
              "|top|",
              "|complete through|",
              "|Edge|"
            ],
            "category": "|Category|",
            "description": "|Defines the face alignment which must apply to a drill|"
          },
          {
            "index": 3,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|Perpendicular|",
              "|Beveled|"
            ],
            "category": "|Category|",
            "description": "|Defines the alignment which must apply to a beamcut|"
          },
          {
            "index": 4,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "|Face|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|bottom|",
              "|top|",
              "|complete through|",
              "|Edge|"
            ],
            "category": "|Category|",
            "description": "|Defines the face alignment which must apply to a beamcut|"
          },
          {
            "index": 5,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "<Dynamic from Map 'Tool[]'>"
            ],
            "category": "|Category|",
            "description": "|Specifies the parent Tool which must refer to a free profile|"
          },
          {
            "index": 6,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "|Face|",
            "defaultValue": "|All|",
            "inputType": "dropdown",
            "options": [
              "|All|",
              "|bottom|",
              "|top|",
              "|Edge|"
            ],
            "category": "|Category|",
            "description": "|Defines the face alignment which must apply to a free profile|"
          },
          {
            "index": 7,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "<Dynamic from Map 'Tool[]'>"
            ],
            "category": "|Category|",
            "description": "|Specifies the parent Tool which must refer to a cut|"
          },
          {
            "index": 8,
            "variable": "sAlignment",
            "type": "PropString",
            "displayName": "|Alignment|",
            "defaultValue": "|Beveled|",
            "inputType": "dropdown",
            "options": [
              "|Beveled|"
            ],
            "category": "|Category|",
            "description": "|Defines the alignment which must apply to a cut|"
          },
          {
            "index": 9,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "<Dynamic from Map 'Tool[]'>"
            ],
            "category": "|Category|",
            "description": "|Specifies the parent tool which must refer to a cut|"
          },
          {
            "index": 10,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "<Dynamic from Map 'Tool[]'>"
            ],
            "category": "|Category|",
            "description": "|Specifies the parent tool which must refer to a cut|"
          },
          {
            "index": 11,
            "variable": "sTool",
            "type": "PropString",
            "displayName": "|Tool|",
            "defaultValue": "|Any|",
            "inputType": "dropdown",
            "options": [
              "|Any|",
              "<Dynamic from Map 'Tool[]'>"
            ],
            "category": "|Category|",
            "description": "|Specifies the parent tool which must refer to a cut|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "../|Add/Remove Format|",
            "handler": "../|Add/Remove Format|",
            "action": "Opens list to add or remove format properties by index.",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "|Select subnesting|",
            "handler": "|Select subnesting|",
            "action": "Selects the subnesting instance.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Show Settings|",
            "handler": "|Show Settings|",
            "action": "Displays the script settings map.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone Drills|",
            "handler": "|Clone Drills|",
            "action": "Clones selected drills as static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove Drills|",
            "handler": "|Remove Drills|",
            "action": "Removes selected drills from static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone BeamCuts|",
            "handler": "|Clone BeamCuts|",
            "action": "Clones selected beamcuts as static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone FreeProfiles|",
            "handler": "|Clone FreeProfiles|",
            "action": "Clones selected free profiles as static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone Cuts|",
            "handler": "|Clone Cuts|",
            "action": "Clones selected cuts as static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone Slots|",
            "handler": "|Clone Slots|",
            "action": "Clones selected slots as static tools.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Clone X-Fix|",
            "handler": "|Clone X-Fix|",
            "action": "Clones X-Fix defined by free profile.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Map entries",
            "searchPaths": [
              "_kPathHsbCompany",
              "_kPathHsbInstall"
            ],
            "purpose": "Stores 'Format', 'Tool[]', and various tool configuration maps.",
            "required": true
          }
        ]
      },
      "tokens_used": 9311,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Manages and visualizes sub-elements (subnestings) within a Master CLT panel, allowing for property display and the cloning of specific machining tools (drills, cuts, slots) to the subnesting.",
          "category": "CLT / Panel Processing",
          "typicalUseCase": "Used when a Master CLT panel contains nested sub-panels that need to be treated as separate entities for production data or labeling. It allows the user to isolate and 'freeze' specific machining operations (drilling, cuts) belonging to the subnesting."
        },
        "parameters": [
          {
            "name": "sDiameter",
            "technicalDefault": "",
            "businessMeaning": "Filters drill holes based on their diameter size for cloning or removal operations.",
            "validRange": "Positive numbers, ranges (e.g., '0-20'), or lists (e.g., '20;40').",
            "unit": "mm",
            "affectsOutput": "Determines which drills are selected when executing 'Clone Drills' or 'Remove Drills' context commands."
          },
          {
            "name": "sAlignment (Drills)",
            "technicalDefault": "|All|",
            "businessMeaning": "Filters drills based on their angle relative to the panel surface.",
            "validRange": "Perpendicular, Beveled, All",
            "unit": "enum",
            "affectsOutput": "Restricts drill cloning to either standard vertical drilling or angled drilling."
          },
          {
            "name": "sFace (Drills)",
            "technicalDefault": "|All|",
            "businessMeaning": "Filters drills based on the face of the panel they penetrate or start from.",
            "validRange": "Top, Bottom, Edge, complete through, All",
            "unit": "enum",
            "affectsOutput": "Selects drills located on specific faces of the panel for cloning."
          },
          {
            "name": "sAlignment (BeamCuts)",
            "technicalDefault": "|All|",
            "businessMeaning": "Filters saw cuts (beam cuts) based on their angle.",
            "validRange": "Perpendicular, Beveled, All",
            "unit": "enum",
            "affectsOutput": "Determines which beam cuts are selected when executing 'Clone BeamCuts'."
          },
          {
            "name": "sFace (BeamCuts)",
            "technicalDefault": "|All|",
            "businessMeaning": "Filters beam cuts based on the face they are applied to.",
            "validRange": "Top, Bottom, Edge, complete through, All",
            "unit": "enum",
            "affectsOutput": "Limits beam cut selection to specific panel faces."
          },
          {
            "name": "sTool (FreeProfiles)",
            "technicalDefault": "|Any|",
            "businessMeaning": "Identifies the specific CNC tool or machining operation used to create a contour profile.",
            "validRange": "String list derived from Project Settings (Map 'Tool[]')",
            "unit": "string",
            "affectsOutput": "Selects specific free profiles (milling contours) defined by the named tool for cloning."
          },
          {
            "name": "sFace (FreeProfiles)",
            "technicalDefault": "|All|",
            "businessMeaning": "Filters free profiles by the face they are machined on.",
            "validRange": "Top, Bottom, Edge, All",
            "unit": "enum",
            "affectsOutput": "Restricts free profile cloning to specific faces."
          },
          {
            "name": "sTool (Cuts)",
            "technicalDefault": "|Any|",
            "businessMeaning": "Identifies the tool name associated with a specific cut operation.",
            "validRange": "String list derived from Project Settings (Map 'Tool[]')",
            "unit": "string",
            "affectsOutput": "Selects cuts associated with the specified tool for cloning."
          },
          {
            "name": "sAlignment (Cuts)",
            "technicalDefault": "|Beveled|",
            "businessMeaning": "Restricts cut filtering to angled (beveled) cuts only.",
            "validRange": "Beveled",
            "unit": "enum",
            "affectsOutput": "Ensures only angled cuts are cloned, often used for X-Fix or connection details."
          },
          {
            "name": "sTool (Slots)",
            "technicalDefault": "|Any|",
            "businessMeaning": "Identifies the tool used to create a slot (dado/housing).",
            "validRange": "String list derived from Project Settings (Map 'Tool[]')",
            "unit": "string",
            "affectsOutput": "Selects slots defined by the tool for cloning as static tools."
          },
          {
            "name": "sTool (X-Fix)",
            "technicalDefault": "|Any|",
            "businessMeaning": "Identifies the tool associated with X-Fixing hardware/profiles.",
            "validRange": "String list derived from Project Settings (Map 'Tool[]')",
            "unit": "string",
            "affectsOutput": "Selects X-Fix profiles for cloning."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User executes Context Menu Command (e.g., 'Clone Drills')",
            "effect": "Sets the internal DialogMode, which exposes specific property groups in the OPM (Properties Palette).",
            "cascade": [
              "sDiameter",
              "sAlignment (Drills)",
              "sFace (Drills)"
            ]
          },
          {
            "trigger": "User executes Context Menu Command (e.g., 'Clone BeamCuts')",
            "effect": "Sets DialogMode to expose BeamCut specific properties.",
            "cascade": [
              "sAlignment (BeamCuts)",
              "sFace (BeamCuts)"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Tag / Label",
            "description": "Text and geometry displaying properties (Name, Grade, Material) and grain direction of the subnesting. Consumed by ShopDrawing scripts.",
            "appliedTo": "The Subnesting instance in Model Space."
          },
          {
            "type": "Cloned Machining Tools",
            "description": "Static copies of Drills, BeamCuts, FreeProfiles, Cuts, or Slots that match the filter criteria.",
            "appliedTo": "The Subnesting Element (stored as static tools on the subnesting)."
          }
        ]
      },
      "tokens_used": 10711,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. User executes script (Insert or Recalc)",
          "2. Script retrieves 'DialogMode' from internal Map (determines active context command)",
          "3. [Conditional Branch] Check DialogMode",
          "   - If Mode == 0 (Default): Prepare for general display visualization",
          "   - If Mode >= 1 (Filtering/Cloning): Define specific OPM properties (e.g., sDiameter, sTool, sFace) relevant to the selected tool type (Drill, BeamCut, FreeProfile, Cut, Slot, X-Fix)",
          "4. Script retrieves the 'Format' string property",
          "5. Script iterates through the Format string to parse tokens (e.g., @(Name), @(GrainDirection))",
          "   - Identify tokens enclosed in @()",
          "   - Replace tokens with actual data from Element or Sip (e.g., PosNum, Style, SurfaceQuality)",
          "   - Handle Grain Direction token specifically to flag for symbol drawing",
          "6. Script constructs the final display text lines",
          "7. [Visualization] Script draws the Text Label at the insertion point using DP (Draw Primitives)",
          "8. [Conditional Branch] Check if Grain Direction token was found",
          "   - If Yes: Calculate geometry based on wood grain vector and draw symbol using PLine",
          "9. Script iterates through Child Panels (PlaneProfiles)",
          "   - Transform profiles to local coordinate system",
          "   - Draw Contour rings (Outer)",
          "   - Draw Opening rings (Inner)",
          "10. Script populates 'DimRequest[]' Map with Text, PLines, and Color info for ShopDrawing consumption",
          "11. Script updates Map requests to Model"
        ],
        "conditionalBranches": [
          {
            "condition": "Value of 'DialogMode' (Set by Context Menu/Double Click)",
            "path1": {
              "name": "Display Mode (0)",
              "steps": [
                "Standard properties visible (Format, Grade, etc.)",
                "Logic focuses on text generation and drawing child outlines"
              ]
            },
            "path2": {
              "name": "Filter/Clone Mode (1-6)",
              "steps": [
                "setOPMKey() called to group properties (e.g., 'Drill', 'Cut')",
                "Specific filter properties exposed in OPM (e.g., sDiameter, sAlignment, sTool)",
                "User adjusts filters to select specific machining entities"
              ]
            }
          },
          {
            "condition": "Format String Token Parsing",
            "path1": {
              "name": "Recognized Token (e.g., @(Name))",
              "steps": [
                "Script matches token to internal if/else list",
                "Retrieved value appended to text display string"
              ]
            },
            "path2": {
              "name": "Unrecognized Token or Text",
              "steps": [
                "Raw text appended to display string",
                "If token is unknown but inside @(), it may be skipped or treated as text depending on parser logic"
              ]
            }
          },
          {
            "condition": "Grain Direction Presence",
            "path1": {
              "name": "Token @(Graindirection) Found",
              "steps": [
                "Calculate vector for Wood Grain",
                "Generate specific PLine geometry for symbol",
                "Add PLine to MapRequests"
              ]
            },
            "path2": {
              "name": "Token Not Found",
              "steps": [
                "Skip symbol geometry generation"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Variable Syntax in Format String",
            "errorMessage": "None explicitly thrown in snippet, but unknown variables result in empty text output for that segment.",
            "recovery": "User edits Format property via OPM or Double-Click dialog to use valid keywords (e.g., @(Name), @(PosNum))."
          },
          {
            "check": "Tool Map Availability (for Dropdowns)",
            "errorMessage": "Dropdown lists for 'sTool' would be empty or incomplete.",
            "recovery": "Ensure 'Tool[]' map exists in Project/Company Settings (TslSettings)."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Display Format",
            "how": "Double-Click instance OR edit 'Format' property in OPM",
            "effect": "Script reparses the string, replacing tokens with updated entity data, and redraws the label."
          },
          {
            "action": "Filter Tools for Cloning",
            "how": "Right-click Context Menu (e.g., 'Clone Drills', 'Clone Cuts')",
            "effect": "Sets 'DialogMode' to 1-6, exposes specific filter properties (Diameter, Tool Name, Face) in OPM. Changing these filters updates the internal selection set for cloning."
          },
          {
            "action": "Move / Resize",
            "how": "Grip Edit or Properties",
            "effect": "Updates coordinate system (Cs) and insertion point, regenerating text and child outlines relative to new position."
          }
        ]
      },
      "tokens_used": 12331,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-SubNesting\n\n## Overview\nThis script manages and visualizes sub-elements (subnestings) within a Master CLT panel. It allows users to display specific properties on the subnesting (like grade or material) and to clone specific machining tools (drills, cuts, slots) from the main panel to the subnesting for production data processing.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This is the primary environment for this script. |\n| Paper Space | Yes | Supported for display purposes. |\n| Shop Drawing | No | This is a Model script, but it outputs geometry that shop drawing scripts can read. |\n\n## Prerequisites\n- **Required Entities**: A single Master CLT Panel (Element).\n- **Minimum Beam Count**: 1.\n- **Required Settings**:\n    - Map entry for `Tool[]` (used for populating tool name dropdowns).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCLT-SubNesting.mcr`\n\n### Step 2: Select Element\nAction: Click on the Master CLT Panel (Element) in the drawing to attach the script.\n\n### Step 3: Configure Display (Optional)\nAction: Double-click the script instance or use the Right-Click menu \"Add/Remove Format\" to select which properties (e.g., Name, Grade, Material) to display on the label.\n\n### Step 4: Clone Machining (Optional)\nAction: Right-click the script instance and select a cloning option (e.g., \"Clone Drills\"). Adjust the specific filters (Diameter, Face, etc.) in the Properties palette to define which tools to clone.\n\n## Properties Panel Parameters\n\n*Note: Many properties only appear or become relevant after triggering a specific Context Menu command (e.g., Clone Drills).*\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Diameter** | Text | `\"\"` | Filters drill holes. Supports single values, ranges (e.g., `0-20`), or lists (e.g., `20;40`). Empty = all diameters. |\n| **Alignment** | Dropdown | `All` | Filters drills or beam cuts based on angle. Options: `All`, `Perpendicular`, `Beveled`. |\n| **Face** | Dropdown | `All` | Filters operations by the panel face. Options: `All`, `bottom`, `top`, `complete through`, `Edge`. |\n| **Tool** | Dropdown | `Any` | Filters Free Profiles, Cuts, Slots, or X-Fix by the specific tool name defined in the Tool Map. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Add/Remove Format** | Opens a list to select which properties (Name, Label, Grade, etc.) are displayed in the text label. |\n| **Select subnesting** | Selects the subnesting instance in the model. |\n| **Show Settings** | Displays the script's internal settings map. |\n| **Clone Drills** | Enables drill cloning mode. Exposes Diameter, Alignment, and Face filters in the Properties palette to select which drills to copy. |\n| **Remove Drills** | Removes previously cloned drills based on the current filter settings. |\n| **Clone BeamCuts** | Enables beam cut cloning mode. Exposes Alignment and Face filters. |\n| **Clone FreeProfiles** | Enables free profile (contour) cloning mode. Exposes Tool and Face filters. |\n| **Clone Cuts** | Enables cut cloning mode. Exposes Tool and Alignment filters. |\n| **Clone Slots** | Enables slot cloning mode. Exposes Tool filter. |\n| **Clone X-Fix** | Clones X-Fix hardware profiles defined by free profiles. |\n\n## Settings Files\n- **Map Entries**: `Tool[]`\n- **Location**: `_kPathHsbCompany` or `_kPathHsbInstall`\n- **Purpose**: Provides the list of available Tool names used in the dropdown filters for machining operations.\n\n## Tips\n- **Diameter Syntax**: When filtering drills, you can use `0-20` to catch all holes up to 20mm, or `12;16` to catch only exactly 12mm and 16mm holes.\n- **Dynamic Labels**: Use the \"Add/Remove Format\" menu to quickly toggle the display of Grain Direction or Material info without editing complex strings manually.\n- **Cloning Workflow**: When using \"Clone\" commands, set your filters in the Properties palette first, then re-calculate the script (or move it) to apply the cloning logic.\n\n## FAQ\n- **Q: I don't see any filter options (Diameter, Tool) in the Properties palette.**\n  - **A**: You must first trigger the specific clone command from the Right-Click menu (e.g., \"Clone Drills\"). This activates the specific properties needed for that operation.\n- **Q: The text label is not showing the correct information.**\n  - **A**: Double-click the script instance or select \"Add/Remove Format\" from the menu. Check if the desired fields (like Name or Grade) are selected in the list.\n- **Q: My cloned drills are not appearing.**\n  - **A**: Check the \"Diameter\" property. If it contains a value that excludes your drill size (e.g., set to `100` but your drill is `10`), nothing will be cloned. Clear the Diameter field to accept all sizes."
      },
      "tokens_used": 8553,
      "error": null
    }
  }
}