{
  "filename": "hsbItemNester.mcr",
  "status": "completed",
  "total_tokens": 53094,
  "processing_time": 381.2137107849121,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": 1,
          "minorVersion": 2,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl creates pline based nestings from tsl based items",
        "versionHistory": [
          {
            "version": "1.2",
            "date": "20sep2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "HSB-5633 isotropic nesting enabled"
          },
          {
            "version": "1.1",
            "date": "09apr2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "sip nesting functions and properties added, supports settings"
          },
          {
            "version": "1.0",
            "date": "12sep2018",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [
          "hsbItemClone.xml"
        ],
        "dependencies": []
      },
      "tokens_used": 8814,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly calls _kModelSpace in tslNew.dbCreate() and lacks #Type E, sd_* prefix, or _Viewport references. Logic handles 3D entities (GenBeam, TslInst, Body) and geometric positioning (_Pt0, _XW, _YW, _ZW) typical of model space operations."
        },
        "prerequisites": {
          "requiredEntities": [
            "TslInst"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "hsbItemClone.xml"
          ]
        }
      },
      "tokens_used": 5656,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrEntity.go",
              "promptOriginal": "|Select item clone(s)|",
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Insertion (_bOnInsert)",
            "title": null,
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 2,
            "variable": "sGrainDirection",
            "type": "PropString",
            "displayName": "|Grain Direction|",
            "defaultValue": "|Lengthwise|",
            "inputType": "dropdown",
            "options": [
              "|Lengthwise|",
              "|Crosswise|",
              "|Isotropic|"
            ],
            "category": "|Master|",
            "description": "|Defines the GrainDirection|"
          },
          {
            "index": 0,
            "variable": "dLength",
            "type": "PropDouble",
            "displayName": "|Length|",
            "defaultValue": "U(5000)",
            "inputType": "number",
            "options": [],
            "category": "|Master|",
            "description": "|Defines the Length|"
          },
          {
            "index": 1,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "|Width|",
            "defaultValue": "U(2000)",
            "inputType": "number",
            "options": [],
            "category": "|Master|",
            "description": "|Defines the Width|"
          },
          {
            "index": 2,
            "variable": "dOversize",
            "type": "PropDouble",
            "displayName": "|Oversize Format Cut|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Master|",
            "description": "|Defines the outer offset of the raw master.|"
          },
          {
            "index": 3,
            "variable": "sFaceAlignment",
            "type": "PropString",
            "displayName": "|Top Face Alignment|",
            "defaultValue": "|Unchanged|",
            "inputType": "dropdown",
            "options": [
              "|Unchanged|",
              "|Higher Quality|",
              "|Lower Quality|"
            ],
            "category": "|Master|",
            "description": "|Defines the alignment of the child panel|"
          },
          {
            "index": 3,
            "variable": "dGap",
            "type": "PropDouble",
            "displayName": "|Gap|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Item|",
            "description": "|Defines the gap between individual items|"
          },
          {
            "index": 1,
            "variable": "sAttribute",
            "type": "PropString",
            "displayName": "|Format|",
            "defaultValue": "|Project| @(ProjectName)\\P@(ProjectName)",
            "inputType": "text",
            "options": [],
            "category": "|Display|",
            "description": "|Defines the text and/or attributes.| |Multiple lines are separated by| '\\P' |Attributes can also be added or removed by context commands.|"
          },
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "|DimStyle|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "_DimStyles.sorted()"
            ],
            "category": "|Display|",
            "description": "|Defines the DimStyle|"
          },
          {
            "index": 4,
            "variable": "dTextHeight",
            "type": "PropDouble",
            "displayName": "|Text Height|",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "|Display|",
            "description": "|Overrides the Text Height| |0 = by dimstyle|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": [
          {
            "filename": "hsbItemClone.xml",
            "searchPaths": [
              "_kPathHsbCompany\\TSL\\Settings"
            ],
            "purpose": "Read default display, nesting, and dimension settings",
            "required": false
          }
        ]
      },
      "tokens_used": 9721,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically arranges (nests) selected timber items onto a defined raw material sheet to optimize material usage and generate a cutting layout.",
          "category": "Manufacturing / Production",
          "typicalUseCase": "Used when preparing a cutting list for a CNC saw or beam saw, determining how many smaller parts can be cut from large raw timber panels or sheets with minimal waste."
        },
        "parameters": [
          {
            "name": "dLength",
            "technicalDefault": "U(5000)",
            "businessMeaning": "The length of the raw material (master board/sheet) available for nesting.",
            "validRange": "1000mm to 12000mm (Typical stock lengths)",
            "unit": "mm",
            "affectsOutput": "Defines the long boundary of the nesting rectangle. Increasing this allows more items to be placed in a row."
          },
          {
            "name": "dWidth",
            "technicalDefault": "U(2000)",
            "businessMeaning": "The width of the raw material (master board/sheet) available for nesting.",
            "validRange": "600mm to 3000mm (Typical stock widths)",
            "unit": "mm",
            "affectsOutput": "Defines the short boundary of the nesting rectangle. Increasing this allows more rows of items."
          },
          {
            "name": "dOversize",
            "technicalDefault": "U(0)",
            "businessMeaning": "A safety margin or saw kerf allowance subtracted from the outer edge of the raw master sheet.",
            "validRange": "0mm to 50mm (Standard saw blade width + trim allowance)",
            "unit": "mm",
            "affectsOutput": "Reduces the effective nesting area. Items will not be placed closer than this distance to the edge of the defined Length/Width."
          },
          {
            "name": "sGrainDirection",
            "technicalDefault": "|Lengthwise|",
            "businessMeaning": "Constraint defining the structural orientation of the wood grain relative to the sheet length.",
            "validRange": "Lengthwise, Crosswise, Isotropic",
            "unit": "enum",
            "affectsOutput": "Restricts how items can be rotated. 'Lengthwise' forces the item's grain to align with the sheet length; 'Isotropic' (for OSB/Particle board) allows 90-degree rotation for better packing density."
          },
          {
            "name": "dGap",
            "technicalDefault": "U(0)",
            "businessMeaning": "The spacing between individual nested items, typically accounting for the saw blade thickness (kerf).",
            "validRange": "0mm to 20mm",
            "unit": "mm",
            "affectsOutput": "Adds physical space between items in the layout. Prevents items from touching or overlapping in the visual representation and CNC output."
          },
          {
            "name": "sFaceAlignment",
            "technicalDefault": "|Unchanged|",
            "businessMeaning": "Controls the orientation of the 'Top' face of the item relative to the master sheet (e.g., keeping the sanded side up).",
            "validRange": "Unchanged, Higher Quality, Lower Quality",
            "unit": "enum",
            "affectsOutput": "Determines if the item is flipped (mirrored) during placement to ensure the correct surface quality faces upwards or downwards."
          },
          {
            "name": "sAttribute",
            "technicalDefault": "|Project| @(ProjectName)\\P@(ProjectName)",
            "businessMeaning": "Label information to be displayed on the nesting drawing for identification.",
            "validRange": "Text string including attributes like @(ElementNumber), @(ProjectName)",
            "unit": "text",
            "affectsOutput": "Updates the text labels placed near the nested items or master sheet in the CAD model."
          },
          {
            "name": "sDimStyle",
            "technicalDefault": "(from hsbItemClone.xml)",
            "businessMeaning": "The visual style standard (arrowheads, text size, font) used for dimensions in the nesting plan.",
            "validRange": "Available AutoCAD/hsbCAD DimStyles",
            "unit": "style",
            "affectsOutput": "Changes the appearance of dimensions drawn on the master sheet and items."
          },
          {
            "name": "dTextHeight",
            "technicalDefault": "U(0)",
            "businessMeaning": "Explicit height for text labels in the nesting plan (0 means use DimStyle default).",
            "validRange": "2.5mm to 10mm",
            "unit": "mm",
            "affectsOutput": "Scales the size of the text labels. A value of 0 defers to the DimStyle settings."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "hsbItemClone.xml settings file is present",
            "effect": "sDimStyle and dTextHeight become read-only and adopt values from the settings file.",
            "cascade": [
              "sDimStyle",
              "dTextHeight"
            ]
          },
          {
            "trigger": "dLength or dWidth changes",
            "effect": "The master outline PLine is regenerated and the nesting algorithm is re-triggered to fit items into the new area.",
            "cascade": [
              "Geometry"
            ]
          },
          {
            "trigger": "sGrainDirection is set to Isotropic",
            "effect": "The nesting engine allows items to be rotated 90 degrees to fit tighter, which is not permitted when set to Lengthwise.",
            "cascade": [
              "ItemRotation"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "PLine (Polyline)",
            "description": "A rectangle representing the raw material sheet dimensions (Master).",
            "appliedTo": "Model Space (at insertion point)"
          },
          {
            "type": "TslInst (Transformed)",
            "description": "The selected item clones are physically moved and rotated to their optimal positions on the master sheet.",
            "appliedTo": "Selected Items (Hsb_ItemClone)"
          },
          {
            "type": "Text / Attributes",
            "description": "Labels displaying project info or item details, formatted by the 'Format' property.",
            "appliedTo": "Model Space (near items or master)"
          },
          {
            "type": "Dimensions",
            "description": "Linear dimensions indicating the size of the master sheet and item positions.",
            "appliedTo": "Model Space"
          }
        ]
      },
      "tokens_used": 10133,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script starts: Load constants and read settings from hsbItemClone.xml",
          "[On Insert] Check for Execute Key (command line preset)",
          "Branch: If Execute Key exists, load properties from Catalog; else Show Dynamic Dialog",
          "Prompt User: Select item clone(s) (TslInst with Hsb_ItemClone key)",
          "Validate Selection: Filter out non-clone entities",
          "Prompt User: Select insertion point for the master sheet",
          "Establish Coordinate System: Calculate origin and axes based on grain direction",
          "Generate Master Geometry: Create PLine rectangle based on Length/Width properties",
          "Initialize Nester Object: Add Master sheet and Item Clones as children",
          "Configure Nesting Options: Set Gap, Oversize, Grain Direction, and Face Alignment",
          "Execute Nesting Algorithm: Run layout calculation",
          "Branch: Check Result (Success vs Failure/No Dongle)",
          "Process Successful Nest: Transform child entities to their calculated nested positions",
          "Branch: Handle Leftover Items (Recursive Nest vs Too Large)",
          "Finish: Display attributes and dimensions (if configured)"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion - Execute Key Presence",
            "path1": {
              "name": "Automated/Scripted",
              "steps": [
                "Read _kExecuteKey",
                "Match key against script catalog entries",
                "Load properties from catalog entry",
                "Skip user dialog"
              ]
            },
            "path2": {
              "name": "Manual",
              "steps": [
                "Call showDialog()",
                "User modifies properties in OPM or Dialog",
                "User clicks OK",
                "Proceed to entity selection"
              ]
            }
          },
          {
            "condition": "User Modifies Master Dimensions (Length/Width)",
            "path1": {
              "name": "Geometry Update",
              "steps": [
                "Detect change in _kNameLastChangedProp",
                "Erase existing Master PLine",
                "Set 'CallOnCreated' flag",
                "Trigger script re-execution",
                "Re-run nesting logic with new bounds"
              ]
            }
          },
          {
            "condition": "Nesting Algorithm - Leftover Items",
            "path1": {
              "name": "Recursive Nesting (Items fit, just ran out of space)",
              "steps": [
                "Verify current master has at least one child",
                "Calculate new insertion point offset (Next Column)",
                "Create new instance of hsbItemNester via dbCreate",
                "Pass leftover entities and properties to new instance",
                "New instance runs nesting automatically"
              ]
            },
            "path2": {
              "name": "Error Handling (Items too large for Master)",
              "steps": [
                "Verify current master has zero children (completely empty)",
                "Generate Warning Report",
                "Calculate 'graveyard' position above the master sheet",
                "Transform leftover items to graveyard location for visibility",
                "Report individual item dimensions that failed"
              ]
            }
          },
          {
            "condition": "Nesting Engine Availability",
            "path1": {
              "name": "Success",
              "steps": [
                "nSuccess == _kNROk",
                "Retrieve child indices and transformation matrices",
                "Apply transforms to entities"
              ]
            },
            "path2": {
              "name": "Failure",
              "steps": [
                "nSuccess != _kNROk (e.g., _kNRNoDongle)",
                "Report Error Notice to user",
                "Force script recalculation (loops=2)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection Type",
            "errorMessage": "(Implicit filtering)",
            "recovery": "Script automatically removes entities from the selection set that do not have the 'Hsb_ItemClone' subMap key."
          },
          {
            "check": "Nesting Engine License",
            "errorMessage": "scriptName: No dongle present",
            "recovery": "Ensure the required hsbCAD licensing/dongle for nesting features is attached."
          },
          {
            "check": "Item Size vs Master Size",
            "errorMessage": "Warning, could not nest item(s). Usable master dimensions: [X] x [Y]",
            "recovery": "Script moves oversized items above the master. User must increase Master Length/Width properties or check if item size is valid."
          },
          {
            "check": "Settings File Existence",
            "errorMessage": "(Implicit default)",
            "recovery": "If 'hsbItemClone.xml' is missing, script falls back to hardcoded defaults for DimStyle and TextHeight."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Resize Master Sheet",
            "how": "OPM Properties Palette",
            "effect": "Changes the Length or Width. The script erases the old master rectangle and re-runs the nesting algorithm to fit items into the new area."
          },
          {
            "action": "Adjust Nesting Parameters",
            "how": "OPM Properties Palette",
            "effect": "Changing Gap, Oversize, Grain Direction, or Face Alignment triggers a recalculation of the item positions within the existing master area."
          },
          {
            "action": "Move Nesting Layout",
            "how": "Grip Edit / Move Command",
            "effect": "Moving the script insertion point (_Pt0) moves the entire Master sheet and all successfully nested items as a group."
          },
          {
            "action": "Delete Script",
            "how": "Erase Command",
            "effect": "Deletes the Master PLine. The nested items (which were transformed in place) typically remain in the model as standard entities unless specifically erased by the script's purge logic."
          }
        ]
      },
      "tokens_used": 11486,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbItemNester.mcr\n\n## Overview\nThis script optimizes material usage by automatically arranging (nesting) selected timber item clones onto a defined raw material sheet. It generates a cutting layout that accounts for grain direction, saw kerf gaps, and panel dimensions.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script creates geometry (polylines, text) and transforms items in 3D model space. |\n| Paper Space | No | This script does not function in layout views. |\n| Shop Drawing | No | This is a production/modeling tool, not a drawing generator. |\n\n## Prerequisites\n- **Required Entities**: `TslInst` entities generated by the `Hsb_ItemClone` script.\n- **Minimum Beam Count**: 0 (This script works with TSL instances, not structural beams).\n- **Required Settings**: `hsbItemClone.xml` (Optional; if missing, internal defaults are used).\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command**: `TSLINSERT`\n1. Browse and select `hsbItemNester.mcr`.\n2. Click **Open**.\n\n### Step 2: Configure Properties\n**Action**: The Properties Palette (OPM) will open automatically upon insertion.\n1. Review the default settings (Length, Width, Gap, Grain Direction).\n2. Adjust values to match your raw material stock (e.g., change Length to `6000` for a 6m board).\n3. Keep the palette open or click in the drawing area to proceed.\n\n### Step 3: Select Items\n**Command Line**: `Select item clone(s)`\n**Action**: Click on the timber item clones (TslInst) you wish to nest onto the sheet.\n1. Press **Enter** to confirm selection.\n   *Note: The script automatically filters out invalid entities.*\n\n### Step 4: Place Master Sheet\n**Command Line**: `[Select insertion point]`\n**Action**: Click in the Model Space to define the bottom-left corner of the raw material sheet.\n1. The script will generate the rectangle outline.\n2. The items will automatically move and rotate to their calculated nested positions.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Grain Direction** | dropdown | Lengthwise | Constrains how items can be rotated. *Isotropic* allows 90Â° rotation (best for sheet goods); *Lengthwise* keeps items aligned with the board length. |\n| **Length** | number | 5000 mm | The total length of the raw material (master board). |\n| **Width** | number | 2000 mm | The total width of the raw material. |\n| **Oversize Format Cut** | number | 0 mm | A safety margin subtracted from the outer edge of the master sheet (e.g., for saw trims). |\n| **Top Face Alignment** | dropdown | Unchanged | Controls orientation of the \"Top\" face. Use to ensure the finished side remains facing up. |\n| **Gap** | number | 0 mm | The spacing between individual items. Typically set to the saw blade thickness (kerf). |\n| **Format** | text | Project info | Defines the label text displayed on the drawing (e.g., ElementNumber, ProjectName). Separate lines with `\\P`. |\n| **DimStyle** | dropdown | *Current* | Sets the visual style (arrows, text size) for dimensions. |\n| **Text Height** | number | 0 | Sets the height for labels. `0` uses the default defined in the DimStyle. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No custom context menu items are defined for this script. Use the Properties Palette to modify settings. |\n\n## Settings Files\n- **Filename**: `hsbItemClone.xml`\n- **Location**: `\\\\TSL\\Settings` (Company or Install path)\n- **Purpose**: Provides default values for display settings (like DimStyle and Text Height) so they are consistent across the project.\n\n## Tips\n- **Recycling Space**: If your selected items do not fit on the first sheet, the script automatically creates a second (or third) sheet next to the first one to fit the leftovers.\n- **Oversized Items**: If an item is physically larger than the defined Master Length/Width, the script will move it to a \"graveyard\" position above the sheet and display a warning. Increase the Length/Width properties to accommodate it.\n- **Adjusting Layout**: If you change the *Length*, *Width*, or *Gap* in the Properties Palette, the script immediately erases the old layout and recalculates the nest.\n- **Moving the Group**: You can use the standard AutoCAD **Move** command on the master sheet polyline (insertion point), and the nested items will move with it.\n\n## FAQ\n- **Q: Why did my items disappear?**\n  A: They have been moved to the nested position on the master sheet. If you cannot see them, they might have been nested, or if the nesting failed, they may be placed in a \"graveyard\" location above the sheet.\n- **Q: What does \"Isotropic\" mean?**\n  A: It means the material has no grain direction constraint (like OSB or particle board). This allows the script to rotate items 90 degrees to pack them more tightly.\n- **Q: How do I account for saw blade width?**\n  A: Set the **Gap** property to the width of your saw blade (e.g., 4mm or 5mm). This adds space between parts so they aren't cut directly touching each other."
      },
      "tokens_used": 7284,
      "error": null
    }
  }
}