{
  "filename": "hsb_PanelNester.mcr",
  "status": "completed",
  "total_tokens": 54862,
  "processing_time": 337.0058979988098,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9613,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script prompts for a 3D point via getPoint() to set origin. Uses World Coordinate System vectors (_XW, _YW, _ZW) for transformations and geometry creation. Creates structural entities (ChildPanel, Sip) using dbCreate() directly in the drawing. Lacks ShopDrawing-specific indicators like sd_ prefixes, #Type E, or _Viewport handling."
        },
        "prerequisites": {
          "requiredEntities": [
            "ChildPanel",
            "EntPLine"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "SipStyle definitions",
            "MasterPanelStyle definitions",
            "Property Set 'PanelInfo'",
            "Nesting Dongle (License Key)"
          ]
        }
      },
      "tokens_used": 7772,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Set point to place master panels|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select child panels|",
              "condition": "_bOnInsert && sObjects==sChildPanels",
              "required": true
            },
            {
              "step": 3,
              "function": "PrEntity",
              "promptOriginal": "|Select close polylines|",
              "condition": "_bOnInsert && sObjects==sPLines",
              "required": true
            },
            {
              "step": 4,
              "function": "PrEntity",
              "promptOriginal": "|Select labels|",
              "condition": "_bOnInsert && sObjects==sPLines",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "Called via showDialogOnce() during _bOnInsert",
            "title": "hsb_PanelNester",
            "dataSource": "OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sEmpty",
            "type": "PropString",
            "displayName": "",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "NESTER INFO",
            "description": "Read-only info field"
          },
          {
            "index": 11,
            "variable": "sObjects",
            "type": "PropString",
            "displayName": "|Objects To Nest|",
            "defaultValue": "|Child Panels|",
            "inputType": "dropdown",
            "options": [
              "|Child Panels|",
              "|Polylines|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 12,
            "variable": "pSipStyle",
            "type": "PropString",
            "displayName": "Sip style",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": "Dynamic list from SipStyle().getAllEntryNames()",
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "pStyle",
            "type": "PropString",
            "displayName": "MasterPanel style:",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": "Dynamic list from MasterPanelStyle().getAllEntryNames()",
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "sMPName",
            "type": "PropString",
            "displayName": "MasterPanel Name:",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sMP1",
            "type": "PropString",
            "displayName": "|Use 1220x4800|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 13,
            "variable": "sMP8",
            "type": "PropString",
            "displayName": "|Use 1220x4900|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 4,
            "variable": "sMP2",
            "type": "PropString",
            "displayName": "|Use 1220x5100|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 5,
            "variable": "sMP3",
            "type": "PropString",
            "displayName": "|Use 1220x5500|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 6,
            "variable": "sMP4",
            "type": "PropString",
            "displayName": "|Use 1220x6000|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 7,
            "variable": "sMP5",
            "type": "PropString",
            "displayName": "|Use 1220x6250|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 8,
            "variable": "sMP6",
            "type": "PropString",
            "displayName": "|Use 1220x6500|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 9,
            "variable": "sMP7",
            "type": "PropString",
            "displayName": "|Use 1220x7500|",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|No|",
              "|Yes|"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "dResuceLength",
            "type": "PropDouble",
            "displayName": "|Reduce length by|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "dResuceWidth",
            "type": "PropDouble",
            "displayName": "|Reduce width by|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "dAllowedTimeInSeconds",
            "type": "PropDouble",
            "displayName": "|Allowed run time in seconds|",
            "defaultValue": 360,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": "Format set to _kNoUnit"
          },
          {
            "index": 1,
            "variable": "dMinimumSpacing",
            "type": "PropDouble",
            "displayName": "|Minimum spacing|",
            "defaultValue": 35,
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 10,
            "variable": "sNester",
            "type": "PropString",
            "displayName": "Nester to use",
            "defaultValue": "|Test|",
            "inputType": "dropdown",
            "options": [
              "|Test|",
              "|V4|",
              "|V5|",
              "|V6|"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9810,
      "error": null
    },
    "4": {
      "success": true,
      "data": {},
      "tokens_used": 9932,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launch triggered via _bOnInsert flag.",
          "2. Check if insertCycleCount() > 1. If true, erase instance and exit.",
          "3. Trigger dynamic dialog (ShowDynamicDialog) to configure OPM properties (styles, sheet sizes, spacing, nester version).",
          "4. Prompt user for a 3D point to place the master panels (Origin).",
          "5. Branch based on 'Objects To Nest' property (Child Panels vs Polylines).",
          "   - Path A (Child Panels): Select entities of type ChildPanel.",
          "   - Path B (Polylines): Select entities of type EntPLine, then prompt for optional Labels (Text/MText).",
          "   - Path B (Post-Selection): Attach 'PanelInfo' property set to Polylines, calculate text centroids, and map text content to 'PanelCode' property of enclosing Polylines.",
          "6. Initialize NesterCaller object.",
          "7. Define Master Panels based on selected sheet sizes (sMP1-sMP8). Subtract 'Reduce Length' and 'Reduce Width' values. Add to Nester.",
          "8. Iterate through selected entities (Child Panels or Polylines):",
          "   - Calculate geometric profile (shadow profile for panels, PLine for polylines).",
          "   - Filter out profiles with area < 1mm^2.",
          "   - Add entity as NesterChild with 90-degree rotation allowance.",
          "9. Execute Nester.nest(NesterData).",
          "10. Check Nesting Result status:",
          "   - If _kNRNoDongle: Report 'No dongle present', exit.",
          "   - If Error: Report 'Not possible to nest', exit.",
          "11. If Success: Iterate through Nester results (Masters and Children).",
          "12. Apply transformations to Child Entities:",
          "   - Path A: Transform ChildPanel to nested position. Collect vertices for collision/spacing adjustments.",
          "   - Path B: Transform PLine, create new Sip entity using assigned style and PanelCode label, create associated ChildPanel, transform to nested position.",
          "13. Optimize Placement (Post-Nest Logic):",
          "   - Align child panels to origin/start point.",
          "   - Check for collisions between specific panels (e.g., if 2 panels in a batch). Shift panels along Y axis if they do not overlap intersection profiles (to pack them tighter).",
          "14. Arrange generated Sip entities (if Path B): Move to a separate layout area offset by Y*10000mm.",
          "15. Report Leftover Masters and Children to console.",
          "16. Erase the script instance."
        ],
        "conditionalBranches": [
          {
            "condition": "Check if insertCycleCount > 1",
            "path1": {
              "name": "Re-insertion Detected",
              "steps": [
                "Erase current script instance",
                "Exit immediately"
              ]
            },
            "path2": {
              "name": "First Insertion",
              "steps": [
                "Show Dynamic Dialog",
                "Prompt for Master Panel Origin",
                "Continue with input selection"
              ]
            }
          },
          {
            "condition": "Check 'Objects To Nest' property",
            "path1": {
              "name": "Child Panels",
              "steps": [
                "Prompt for selection of ChildPanel entities",
                "Store valid panels in _Entity array",
                "Later: Transform existing panels, create geometry from realBody()"
              ]
            },
            "path2": {
              "name": "Polylines",
              "steps": [
                "Prompt for selection of EntPLine entities",
                "Prompt for selection of Labels (Text/MText)",
                "Attach 'PanelInfo' PropSet to PLine",
                "Parse Text content to get PanelCode",
                "Map Text to PLine based on centroid containment",
                "Later: Create Sip and ChildPanel from PLine geometry"
              ]
            }
          },
          {
            "condition": "Nesting Success Status (nSuccess)",
            "path1": {
              "name": "Success",
              "steps": [
                "Iterate nested results",
                "Transform geometry",
                "Run spacing/collision optimization",
                "Report leftovers"
              ]
            },
            "path2": {
              "name": "Failure",
              "steps": [
                "Report 'Not possible to nest'",
                "Check if Dongle missing, report if so",
                "Erase instance and exit"
              ]
            }
          },
          {
            "condition": "Check specific panel count in nesting batch (allChildPanels.length())",
            "path1": {
              "name": "Two Panels",
              "steps": [
                "Calculate intersection of shrunk profiles",
                "If intersection area is negligible",
                "Shift panels closer along Y-axis (dDist1 or dDist2)"
              ]
            },
            "path2": {
              "name": "Not Two Panels",
              "steps": [
                "Skip specific 2-panel intersection optimization"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Nesting Dongle Presence",
            "errorMessage": "|No dongle present|",
            "recovery": "User must ensure the hsbCAD Nesting Dongle is connected to the computer."
          },
          {
            "check": "Nesting Algorithm Success",
            "errorMessage": "|Not possible to nest|",
            "recovery": "Check if selected objects fit within the defined Master Panels, adjust spacing or increase Master Panel sizes."
          },
          {
            "check": "Child Panel Area",
            "errorMessage": "(Implicit: Panel skipped)",
            "recovery": "Ensure selected Polylines/Panels are larger than 1mm^2."
          },
          {
            "check": "Property Set Existence (PanelInfo)",
            "errorMessage": "(Script fails if missing)",
            "recovery": "Ensure Property Set 'PanelInfo' with definition 'PanelCode' exists in the drawing when nesting Polylines."
          }
        ],
        "postInsertionActions": [
          {
            "action": "No direct interaction",
            "how": "N/A",
            "effect": "The script operates as a one-shot generator. It erases itself upon completion. The resulting ChildPanels and Sips are independent entities in the model. To re-nest, the user must delete the results and run the script again."
          }
        ]
      },
      "tokens_used": 10406,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsb_PanelNester.mcr\n\n## Overview\nThis script automates the nesting of timber panels (either existing Child Panels or closed Polylines) onto standard Master Panel sheets. It calculates an optimal layout to minimize material waste and generates the nested geometry in the model.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in 3D Model Space. |\n| Paper Space | No | Not supported for layout or nesting. |\n| Shop Drawing | No | This is a pre-production/modeling tool. |\n\n## Prerequisites\n- **Required Entities**:\n  - Existing `ChildPanel` entities OR closed `Polylines` (EntPLine).\n  - If using Polylines, `Text` or `MText` entities (Labels) are recommended for naming.\n- **Required Settings**:\n  - **Nesting Dongle**: A valid hsbCAD nesting license key/dongle must be present.\n  - **SipStyle**: Definitions must exist in the catalog (if nesting from Polylines).\n  - **MasterPanelStyle**: Definitions must exist in the catalog.\n  - **Property Sets**: A Property Set definition named `PanelInfo` containing a property `PanelCode` is required when nesting Polylines.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1. Type `TSLINSERT` in the command line.\n2. Select `hsb_PanelNester.mcr` from the file dialog.\n\n### Step 2: Configure Parameters\n1. The script will either display a dynamic dialog or populate the Properties Palette.\n2. Set the **Objects To Nest** (Child Panels or Polylines).\n3. Select the appropriate **Sip style** and **MasterPanel style**.\n4. Toggle the desired sheet sizes (e.g., **Use 1220x6000**).\n5. Adjust **Minimum spacing** or **Reduce length/width** if necessary for saw kerfs.\n\n### Step 3: Set Origin\n```\nCommand Line: Set point to place master panels\nAction: Click in the Model Space to define the insertion point for the nested sheets (e.g., 0,0,0).\n```\n\n### Step 4: Select Objects\nThe prompt depends on your selection in Step 2.\n\n**Option A: Nesting Child Panels**\n```\nCommand Line: Select child panels\nAction: Select the existing Child Panel entities you wish to nest and press Enter.\n```\n\n**Option B: Nesting Polylines**\n```\nCommand Line: Select close polylines\nAction: Select the closed Polylines representing your panels and press Enter.\nCommand Line: Select labels\nAction: Select Text/MText entities to name the panels (Optional, press Enter to skip).\n```\n\n### Step 5: Generation\nThe script runs the nesting algorithm. If successful, it creates the Master Panels and places the nested panels inside them. The script instance then erases itself automatically.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Objects To Nest** | dropdown | Child Panels | Choose between nesting existing Child Panels or creating new ones from Polylines. |\n| **Sip style** | dropdown | *Empty* | Style assigned to new panels created from Polylines. |\n| **MasterPanel style** | dropdown | *Empty* | Style assigned to the generated stock sheets. |\n| **MasterPanel Name** | text | *Empty* | Prefix name for the generated Master Panels. |\n| **Use 1220x4800** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x4900** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x5100** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x5500** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x6000** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x6250** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x6500** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Use 1220x7500** | dropdown | No | Include this specific sheet size in the nesting stock. |\n| **Reduce length by** | number | 0 | Trims the length of the Master Panels (e.g., for saw blade thickness). |\n| **Reduce width by** | number | 0 | Trims the width of the Master Panels. |\n| **Allowed run time in seconds** | number | 360 | Maximum time the nesting engine is allowed to calculate. |\n| **Minimum spacing** | number | 35 | Distance required between nested parts. |\n| **Nester to use** | dropdown | Test | Select the nesting algorithm version (Test, V4, V5, V6). |\n\n## Right-Click Menu Options\nThis script does not add specific items to the entity context menu. It runs once upon insertion and deletes itself.\n\n## Settings Files\nThis script relies on standard hsbCAD catalogs rather than external XML files:\n- **SipStyle Catalog**: Defines the construction makeup of panels.\n- **MasterPanelStyle Catalog**: Defines the material/properties of the stock sheets.\n\n## Tips\n- **Dongle Required**: If the script reports \"No dongle present\", ensure your hardware security key is connected or your network license is active.\n- **Polyline Workflow**: When nesting Polylines, ensure the Text labels are inside the Polyline boundaries. The script links the text to the panel via the `PanelCode` property.\n- **Algorithm Selection**: Use the \"Test\" nester for instant previews. Use \"V6\" for the best optimization, but be aware it may take longer to process large quantities.\n- **Re-running**: Since the script erases itself, simply run `TSLINSERT` again if you need to adjust settings or re-nest.\n\n## FAQ\n- **Q: Why did my script disappear after running?**\n  - **A**: This is normal behavior. The script is a \"one-shot\" generator. It creates the geometry and removes itself from the drawing to prevent clutter.\n- **Q: I see the error \"Not possible to nest\".**\n  - **A**: This means the parts cannot fit into the selected sheet sizes with the current spacing. Try enabling larger sheet sizes (e.g., 1220x7500) or reducing the \"Minimum spacing\".\n- **Q: What happens if I select Polylines but no Labels?**\n  - **A**: The script will still generate the panels, but the `PanelCode` property in the resulting data may be empty or default."
      },
      "tokens_used": 7329,
      "error": null
    }
  }
}