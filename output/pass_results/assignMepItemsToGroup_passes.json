{
  "filename": "assignMepItemsToGroup.mcr",
  "status": "completed",
  "total_tokens": 32685,
  "processing_time": 287.01368379592896,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": \"\",\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 0,\n    \"minorVersion\": 0,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"1.00\",\n      \"date\": \"13.05.2020\",\n      \"author\": \"AS\",\n      \"changes\": \"Pilot version.\"\n    },\n    {\n      \"version\": \"1.01\",\n      \"date\": \"14.05.2020\",\n      \"author\": \"AS\",\n      \"changes\": \"Use profiles to determine if the mep item belongs to the element.\"\n    },\n    {\n      \"version\": \"1.02\",\n      \"date\": \"28.06.2020\",\n      \"author\": \"AS\",\n      \"changes\": \"Assign mep items to floorgroup if they are inside the module bounds and not assigned to an element.\\t\\t\\t\\t\\t Rename from assignMepItemsToElement to assignMepItemsToGroup.\"\n    },\n    {\n      \"version\": \"1.03\",\n      \"date\": \"23.09."
      },
      "tokens_used": 6730,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly calls `Group().collectEntities(..., _kModelSpace)` to fetch elements and TSL instances. It does not utilize ShopDrawing API calls (sd_*), does not check for Viewports, and does not use PaperSpace specific entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "TslInst (script named 'mepitem')"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing Elements to define modules and MEP items to be assigned.",
          "requiredSettings": [
            "MapKey 'text.modul' must be present on Elements to group them into modules."
          ]
        }
      },
      "tokens_used": 4605,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 3778,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically organizes MEP (Mechanical, Electrical, Plumbing) items by assigning them to the correct structural elements or module groups based on their physical location relative to the timber structure.",
          "category": "Data Management / Utility",
          "typicalUseCase": "Used during the detailing phase to logically link imported or placed MEP accessories (like pipes or ducts represented as TSLs) to specific timber walls/floors. This ensures that when data is exported for production or BIM, the MEP items are correctly associated with the structural modules they belong to."
        },
        "parameters": [],
        "parameterDependencies": [],
        "outputEntities": [
          {
            "type": "GroupAssignment",
            "description": "Modifies the group hierarchy of 'mepitem' TSL instances. Items intersecting an element's profile are assigned to that element's group. Remaining items inside the module's bounding box are assigned to the module's floor group.",
            "appliedTo": "TSL Instances (script name: 'mepitem') and hsbCAD Elements."
          }
        ]
      },
      "tokens_used": 5879,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script inserted/launched via TSL palette or command.",
          "2. Check insertion cycle: if > 1, erase instance and exit.",
          "3. Collect all 'Element' entities from ModelSpace.",
          "4. Verify Elements exist: if 0, erase instance and exit.",
          "5. Collect all 'TslInst' entities from ModelSpace.",
          "6. Iterate through Elements to extract Module Name using format @(text.modul).",
          "7. Sort Elements and Indexes to group contiguous elements by Module.",
          "8. Enter processing loop: Iterate through sorted Elements by Module.",
          "9. Accumulate Elements belonging to the current Module into a buffer list.",
          "10. [Conditional] First Element Check: If processing the first element of the first module, scan all TSL instances to filter valid 'mepitem' scripts into a master list.",
          "11. Iterate through Elements in the current Module buffer.",
          "12. Calculate Elevation and Plan profiles for the Element.",
          "13. Check if unassigned 'mepitem' origins are within the Element profiles.",
          "14. Assign intersecting items to the Element's Group.",
          "15. After Element loop: Validate Module Name (check for empty string or '@' character).",
          "16. [Conditional] If Module Name is valid, calculate Module bounding box (Min/Max) and profiles.",
          "17. Check if remaining unassigned 'mepitem' origins are within the Module profiles.",
          "18. Assign intersecting items to the Module's Floor Group.",
          "19. Report the count of items assigned to the command line.",
          "20. Erase the script instance from the drawing."
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Cycle Count",
            "path1": {
              "name": "Subsequent Cycle (>1)",
              "steps": [
                "Erase script instance",
                "Return (Exit)"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Proceed to Data Collection"
              ]
            }
          },
          {
            "condition": "Elements Found in ModelSpace",
            "path1": {
              "name": "No Elements",
              "steps": [
                "Erase script instance",
                "Return (Exit)"
              ]
            },
            "path2": {
              "name": "Elements Present",
              "steps": [
                "Proceed to TSL Collection",
                "Process modules"
              ]
            }
          },
          {
            "condition": "First Element of First Module (Optimization)",
            "path1": {
              "name": "First Element",
              "steps": [
                "Iterate all TSL instances in ModelSpace",
                "Filter for script name 'mepitem'",
                "Populate master mepItems list",
                "Perform Element assignment checks"
              ]
            },
            "path2": {
              "name": "Subsequent Elements",
              "steps": [
                "Iterate existing master mepItems list",
                "Perform Element assignment checks"
              ]
            }
          },
          {
            "condition": "Module Name Validity (@ or Empty check)",
            "path1": {
              "name": "Invalid Module Name",
              "steps": [
                "Skip Module (Floor Group) assignment",
                "Proceed to next module group"
              ]
            },
            "path2": {
              "name": "Valid Module Name",
              "steps": [
                "Calculate Module Bounding Box",
                "Assign remaining items to Element Floor Group"
              ]
            }
          },
          {
            "condition": "MEP Item Location",
            "path1": {
              "name": "Inside Element Profile",
              "steps": [
                "Assign to Element Group",
                "Mark as Assigned"
              ]
            },
            "path2": {
              "name": "Outside Element Profile",
              "steps": [
                "Check against Module Profile (if valid)",
                "Assign to Floor Group if inside"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of Elements in ModelSpace",
            "errorMessage": "None reported to user, script silently erases.",
            "recovery": "Ensure structural elements exist in the model before running the script."
          },
          {
            "check": "TSL script name equals 'mepitem'",
            "errorMessage": "None reported.",
            "recovery": "Ensure MEP objects are instances of the 'mepitem' script."
          },
          {
            "check": "Module Name contains '@' or is empty",
            "errorMessage": "None reported, floor grouping is skipped for this module.",
            "recovery": "Ensure Elements have the MapKey 'text.modul' populated with a valid string."
          }
        ],
        "postInsertionActions": [
          {
            "action": "None",
            "how": "N/A",
            "effect": "The script executes a batch process and calls eraseInstance(), removing itself from the drawing immediately upon completion. No persistent object remains to edit."
          }
        ]
      },
      "tokens_used": 7406,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# assignMepItemsToGroup.mcr\n\n## Overview\nThis script automatically organizes MEP (Mechanical, Electrical, and Plumbing) items by assigning them to the correct structural elements or module floor groups based on their physical location within the model.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be run in Model Space. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**:\n  - **Elements**: Structural timber elements (e.g., walls, floors) must be present in the model.\n  - **MEP Items**: TSL instances specifically named `mepitem` must be present.\n- **Minimum Entities**: At least 1 Element must exist in the drawing.\n- **Required Settings**:\n  - Elements must have the MapKey `text.modul` assigned to define module names.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or select from hsbCAD TSL palette) â†’ Select `assignMepItemsToGroup.mcr`\n\n### Step 2: Automatic Execution\n```\nCommand Line: Script initiates automatically.\nAction: The script processes the drawing without further prompts.\n```\n*Note: Do not wait for command line input. The script will scan the model, update group assignments, report the number of items processed to the command line history, and delete itself immediately upon completion.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| N/A | N/A | N/A | This script runs a batch process and deletes itself. It has no persistent properties to edit. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| N/A | This script does not remain in the drawing; thus, it has no context menu options. |\n\n## Settings Files\n- **Filename**: None.\n- **Location**: N/A.\n- **Purpose**: This script relies on existing MapKeys (`text.modul`) within the drawing elements rather than external settings files.\n\n## Tips\n- **MapKey Setup**: Ensure your structural elements have the `text.modul` MapKey populated correctly. If this MapKey is missing or invalid for a module, items inside that module's bounds will not be assigned to the Floor Group.\n- **Script Naming**: This utility specifically looks for TSL instances named `mepitem`. Ensure your MEP accessories are generated using this script name.\n- **Verification**: After running, check your Project Manager or Element hierarchy to verify that MEP items appear under the correct Element Groups or Floor Groups.\n\n## FAQ\n- **Q: I ran the script, but nothing happened and I can't find it.**\n  **A**: This is normal behavior. `assignMepItemsToGroup.mcr` is a \"fire and forget\" utility. It performs the assignment and automatically erases itself from the drawing to prevent clutter.\n- **Q: Why were some of my MEP items not assigned to a Floor Group?**\n  **A**: Check the `text.modul` MapKey on the Elements in that area. The script skips Floor Group assignment if the Module Name is empty or contains the `@` character.\n- **Q: Can I undo the changes?**\n  **A**: Yes, you can use the standard AutoCAD `UNDO` command to revert the group changes made by the script."
      },
      "tokens_used": 4287,
      "error": null
    }
  }
}