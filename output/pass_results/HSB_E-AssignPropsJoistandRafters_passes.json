{
  "filename": "HSB_E-AssignPropsJoistandRafters.mcr",
  "status": "completed",
  "total_tokens": 41366,
  "processing_time": 421.9915840625763,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "This tsl adds a Beamcode for Joist and Rafters in Floor/Roof Elements.",
        "versionHistory": [
          {
            "version": "1.00",
            "date": "15.07.2016",
            "author": "RP",
            "changes": "First version"
          },
          {
            "version": "1.01",
            "date": "18.08.2016",
            "author": "RP",
            "changes": "Only rename when empty"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6366,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script targets the 3D model environment. It selects elements using `PrEntity ssElements(T(\"|Select elements|\"), ElementRoof())` and creates TSL instances explicitly in `_kModelSpace` via `dbCreate(..., _kModelSpace, ...)`. It processes `GenBeam` objects within `Element` objects, which are model entities. No `sd_` prefixes, `_Viewport` checks, or `_kPaperSpace` references exist."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (specifically Roof/Floor containing beams)",
            "GenBeam (beams of type _kDakCenterJoist or _kExtraRafter within the selected elements)"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing valid Roof or Floor elements.",
          "requiredSettings": []
        }
      },
      "tokens_used": 3173,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select elements|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "On Insert (if not executed via a key)",
            "title": null,
            "dataSource": "Internal OPM Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sequenceNumber",
            "type": "PropInt",
            "displayName": "|Sequence number|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|General|",
            "description": "|The sequence number is used to sort the list of tsl's during generate construction|"
          },
          {
            "index": 1,
            "variable": "NameJoists",
            "type": "PropString",
            "displayName": "Name Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Name of joists in a floor element|"
          },
          {
            "index": 2,
            "variable": "NameRafters",
            "type": "PropString",
            "displayName": "Name Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Name of rafters in a roof element|"
          },
          {
            "index": 3,
            "variable": "MaterialJoists",
            "type": "PropString",
            "displayName": "Material Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Material of joists in a floor element|"
          },
          {
            "index": 4,
            "variable": "MaterialRafters",
            "type": "PropString",
            "displayName": "Material Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Material of rafters in a roof element|"
          },
          {
            "index": 5,
            "variable": "GradeJoists",
            "type": "PropString",
            "displayName": "Grade Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Grade of joists in a floor element|"
          },
          {
            "index": 6,
            "variable": "GradeRafters",
            "type": "PropString",
            "displayName": "Grade Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Grade of rafters in a roof element|"
          },
          {
            "index": 7,
            "variable": "InformationJoists",
            "type": "PropString",
            "displayName": "Information Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Information of joists in a floor element|"
          },
          {
            "index": 8,
            "variable": "InformationRafters",
            "type": "PropString",
            "displayName": "Information Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Information of rafters in a roof element|"
          },
          {
            "index": 9,
            "variable": "LabelJoists",
            "type": "PropString",
            "displayName": "Label Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Label of joists in a floor element|"
          },
          {
            "index": 10,
            "variable": "LabelRafters",
            "type": "PropString",
            "displayName": "Label Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Label of rafters in a roof element|"
          },
          {
            "index": 11,
            "variable": "SubLabelJoists",
            "type": "PropString",
            "displayName": "SubLabel Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the SubLabel of joists in a floor element|"
          },
          {
            "index": 12,
            "variable": "SubLabelRafters",
            "type": "PropString",
            "displayName": "SubLabel Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the SubLabel of rafters in a roof element|"
          },
          {
            "index": 13,
            "variable": "SubLabel2Joists",
            "type": "PropString",
            "displayName": "SubLabel2 Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the SubLabel2 of joists in a floor element|"
          },
          {
            "index": 14,
            "variable": "SubLabel2Rafters",
            "type": "PropString",
            "displayName": "SubLabel2 Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the SubLabel2 of rafters in a roof element|"
          },
          {
            "index": 15,
            "variable": "beamCodeJoists",
            "type": "PropString",
            "displayName": "|Beamcode Joists|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Joists|",
            "description": "|Specify the Beamcode of joists in a floor element|"
          },
          {
            "index": 16,
            "variable": "beamCodeRafters",
            "type": "PropString",
            "displayName": "|Beamcode Rafters|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Rafters|",
            "description": "|Specify the Beamcode of rafters in a roof element|"
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 6607,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Bulk-assigns naming, material, grade, labeling, and coding properties to floor joists and roof rafters within selected elements, specifically targeting fields that are currently empty.",
          "category": "Data Management / Property Assignment",
          "typicalUseCase": "Standardizing the properties of structural elements immediately after generating a floor or roof to ensure beams have the correct material codes (e.g., C24) and production labels (e.g., BeamCode 'J1')."
        },
        "parameters": [
          {
            "name": "sequenceNumber",
            "technicalDefault": "0",
            "businessMeaning": "Defines the priority of this script's execution during the automated construction generation phase, ensuring it runs before or after other processing scripts.",
            "validRange": "Integer (0 is standard)",
            "unit": "count",
            "affectsOutput": "Determines when property assignment occurs relative to other TSL scripts."
          },
          {
            "name": "NameJoists",
            "technicalDefault": "",
            "businessMeaning": "The default entity name assigned to horizontal floor joists (beams running perpendicular to World Z).",
            "validRange": "String (Standard naming conventions)",
            "unit": "text",
            "affectsOutput": "Updates the 'Name' attribute of the beam entity in the model and database."
          },
          {
            "name": "NameRafters",
            "technicalDefault": "",
            "businessMeaning": "The default entity name assigned to sloped roof rafters.",
            "validRange": "String (Standard naming conventions)",
            "unit": "text",
            "affectsOutput": "Updates the 'Name' attribute of the beam entity in the model and database."
          },
          {
            "name": "MaterialJoists",
            "technicalDefault": "",
            "businessMeaning": "Specifies the timber material species for joists (e.g., 'Spruce', 'Fir').",
            "validRange": "String (Manufacturer Material Codes)",
            "unit": "text",
            "affectsOutput": "Updates the beam's material property, affecting reports and BOMs."
          },
          {
            "name": "MaterialRafters",
            "technicalDefault": "",
            "businessMeaning": "Specifies the timber material species for rafters.",
            "validRange": "String (Manufacturer Material Codes)",
            "unit": "text",
            "affectsOutput": "Updates the beam's material property, affecting reports and BOMs."
          },
          {
            "name": "GradeJoists",
            "technicalDefault": "",
            "businessMeaning": "Specifies the structural strength grade of the timber for joists (e.g., 'C24', 'GL24h').",
            "validRange": "String (Structural Grade Codes)",
            "unit": "text",
            "affectsOutput": "Updates the beam's grade property, critical for engineering calculations and labels."
          },
          {
            "name": "GradeRafters",
            "technicalDefault": "",
            "businessMeaning": "Specifies the structural strength grade of the timber for rafters.",
            "validRange": "String (Structural Grade Codes)",
            "unit": "text",
            "affectsOutput": "Updates the beam's grade property, critical for engineering calculations and labels."
          },
          {
            "name": "InformationJoists",
            "technicalDefault": "",
            "businessMeaning": "Auxiliary text field for adding specific notes or handling instructions to joists.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Populates the 'Information' field on the beam."
          },
          {
            "name": "InformationRafters",
            "technicalDefault": "",
            "businessMeaning": "Auxiliary text field for adding specific notes or handling instructions to rafters.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Populates the 'Information' field on the beam."
          },
          {
            "name": "LabelJoists",
            "technicalDefault": "",
            "businessMeaning": "The primary label used to identify joists in drawings, lists, and CAM output.",
            "validRange": "String (Labeling Scheme)",
            "unit": "text",
            "affectsOutput": "Sets the main label for the beam."
          },
          {
            "name": "LabelRafters",
            "technicalDefault": "",
            "businessMeaning": "The primary label used to identify rafters in drawings, lists, and CAM output.",
            "validRange": "String (Labeling Scheme)",
            "unit": "text",
            "affectsOutput": "Sets the main label for the beam."
          },
          {
            "name": "SubLabelJoists",
            "technicalDefault": "",
            "businessMeaning": "A secondary categorization label for joists, often used for sorting or grouping.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Sets the sub-label for the beam."
          },
          {
            "name": "SubLabelRafters",
            "technicalDefault": "",
            "businessMeaning": "A secondary categorization label for rafters, often used for sorting or grouping.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Sets the sub-label for the beam."
          },
          {
            "name": "SubLabel2Joists",
            "technicalDefault": "",
            "businessMeaning": "A tertiary categorization label for joists.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Sets the second sub-label for the beam."
          },
          {
            "name": "SubLabel2Rafters",
            "technicalDefault": "",
            "businessMeaning": "A tertiary categorization label for rafters.",
            "validRange": "String",
            "unit": "text",
            "affectsOutput": "Sets the second sub-label for the beam."
          },
          {
            "name": "beamCodeJoists",
            "technicalDefault": "",
            "businessMeaning": "A critical code often used to trigger specific machining rules, nesting logic, or labeling templates for joists.",
            "validRange": "String (Production Codes)",
            "unit": "text",
            "affectsOutput": "Can drive automated machining decisions and production reports."
          },
          {
            "name": "beamCodeRafters",
            "technicalDefault": "",
            "businessMeaning": "A critical code often used to trigger specific machining rules, nesting logic, or labeling templates for rafters.",
            "validRange": "String (Production Codes)",
            "unit": "text",
            "affectsOutput": "Can drive automated machining decisions and production reports."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Beam Orientation (Geometry)",
            "effect": "Determines which set of properties (Joists vs Rafters) is applied to a specific beam.",
            "cascade": [
              "If beam vector X is perpendicular to World Z (Horizontal) -> Apply Joist Properties",
              "If beam vector X is sloped/not perpendicular to World Z -> Apply Rafter Properties"
            ]
          },
          {
            "trigger": "Existing Property Value",
            "effect": "Properties are only applied if the target field on the beam is currently empty.",
            "cascade": [
              "If 'Name' is empty -> Assign Value",
              "If 'Name' is not empty -> Preserve Existing Value"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "GenBeam (Modified)",
            "description": "Existing beam entities within the selected Floor or Roof elements have their string properties updated.",
            "appliedTo": "Beams of type _kDakCenterJoist or _kExtraRafter contained within the selected elements."
          }
        ]
      },
      "tokens_used": 8337,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched",
          "Check for Execute Key (catalog name) to set properties",
          "[Conditional] If Insert Cycle > 1: Erase instance and exit",
          "[Conditional] If Insert Cycle is 1: Check if _kExecuteKey is empty",
          "[Conditional] If _kExecuteKey is empty: Show OPM Dialog (showDialog) for user input",
          "Save current properties to '_LastInserted' catalog",
          "Prompt user to select Elements (PrEntity) with filter ElementRoof",
          "[Conditional] If user cancels selection: Script ends (no TSL instances created)",
          "If user selects elements: Iterate through selected Elements",
          "For each Element: Create a new instance of the TSL attached to that Element in ModelSpace",
          "Erase the temporary interactive instance used for selection",
          "[New Instance Start] Initialize with properties from '_LastInserted' catalog",
          "Set Instance Sequence Number",
          "Retrieve Element Geometry and Coordinate System",
          "Iterate through Beams within the Element",
          "Filter Beams: Check if type is '_kDakCenterJoist' or '_kExtraRafter'",
          "[Conditional] Check Beam Orientation (Dot product of Beam X and World Z)",
          "If Horizontal (dot product ≈ 0): Assign 'Joist' properties to empty fields",
          "If Sloped (dot product ≠ 0): Assign 'Rafter' properties to empty fields",
          "Erase instance (Cleanup) if triggered by construction or manual insertion"
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count on Launch",
            "path1": {
              "name": "Cycle > 1",
              "steps": [
                "Erase current instance",
                "Return (Stop script)"
              ]
            },
            "path2": {
              "name": "Cycle == 1",
              "steps": [
                "Proceed to Execute Key check",
                "Potentially show Dialog",
                "Prompt for Element selection"
              ]
            }
          },
          {
            "condition": "Execution Source (_kExecuteKey)",
            "path1": {
              "name": "Run via Execute Key (Catalog)",
              "steps": [
                "Load properties from specified Catalog",
                "Skip OPM Dialog",
                "Prompt for Element selection"
              ]
            },
            "path2": {
              "name": "Manual Run (No Key)",
              "steps": [
                "Show OPM Dialog for user input",
                "Save input to '_LastInserted' Catalog",
                "Prompt for Element selection"
              ]
            }
          },
          {
            "condition": "Beam Orientation (Geometry)",
            "path1": {
              "name": "Joist (Horizontal)",
              "steps": [
                "Calculate dot product of Beam Vector X and World Z",
                "If result is < 0.001 (effectively 0)",
                "Assign properties from 'Joists' category (NameJoists, MaterialJoists, etc.)"
              ]
            },
            "path2": {
              "name": "Rafter (Sloped)",
              "steps": [
                "Calculate dot product of Beam Vector X and World Z",
                "If result is >= 0.001",
                "Assign properties from 'Rafters' category (NameRafters, MaterialRafters, etc.)"
              ]
            }
          },
          {
            "condition": "Existing Property Data",
            "path1": {
              "name": "Field is Empty",
              "steps": [
                "Check specific beam property (e.g., name(), material())",
                "If string is empty (\"\")",
                "Overwrite with TSL parameter value"
              ]
            },
            "path2": {
              "name": "Field is Populated",
              "steps": [
                "Check specific beam property",
                "If string is not empty",
                "Preserve existing value (Do not overwrite)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection Validity",
            "errorMessage": "|invalid or no element selected.|",
            "recovery": "Script erases the instance automatically. User must run the command again and select a valid Roof or Floor element."
          },
          {
            "check": "Beam Type Filter",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script silently skips beams that are not of type '_kDakCenterJoist' or '_kExtraRafter'."
          },
          {
            "check": "Element Validity in Loop",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script checks if `selectedElement.bIsValid()` is true before creating the TSL instance. Invalid elements are skipped in the loop."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Properties via OPM",
            "how": "Select the TSL instance (before it self-deletes) or modify the script in the catalog. Note: As this script uses `eraseInstance()` immediately after processing, post-insertion editing of the specific instance is difficult unless it is part of a Generate Construction process where the instance persists until construction is complete.",
            "effect": "Changing OPM properties (NameJoists, beamCodeJoists, etc.) and regenerating the element or script will update the beam properties based on the new logic."
          },
          {
            "action": "Re-running the Script",
            "how": "Launch the TSL again on existing elements.",
            "effect": "Since the script logic includes `if (bm.name() == \"\")`, it respects existing data. Re-running will only fill fields that are currently empty, preventing accidental overwriting of manual changes."
          }
        ]
      },
      "tokens_used": 8698,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-AssignPropsJoistandRafters\n\n## Overview\nThis script allows you to batch assign properties (such as Name, Material, Grade, and Production Codes) to floor joists and roof rafters. It automatically identifies horizontal beams as joists and sloped beams as rafters, updating only fields that are currently empty to preserve your existing data.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script must be run in the 3D model where Floor or Roof elements exist. |\n| Paper Space | No | Not designed for layout views or shop drawings. |\n| Shop Drawing | No | Does not process 2D drawings. |\n\n## Prerequisites\n- **Required Entities**: Floor or Roof elements containing beams.\n- **Minimum Beam Count**: 1 beam within the selected element(s).\n- **Required Settings**: None (properties are set via the Properties Panel).\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `HSB_E-AssignPropsJoistandRafters.mcr` from the list and click **Open**.\n\n### Step 2: Configure Properties\nIf you are running the script manually (without a predefined Catalog key):\n1.  The **Properties Palette** (OPM) will open automatically.\n2.  Set the default values for Joists and Rafters.\n3.  Click the \"Close\" button or simply click back into the drawing area to proceed.\n\n### Step 3: Select Elements\n```\nCommand Line: Select elements\nAction: Click on the Floor or Roof elements you wish to process.\n```\n1.  Select one or more elements in the model.\n2.  Press **Enter** or **Space** to confirm.\n3.  The script will process the beams and attach itself to the elements.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Sequence number** | number | 0 | Determines the execution order of this script during automated construction generation. |\n| **Name Joists** | text | (empty) | The entity name assigned to floor joists. |\n| **Name Rafters** | text | (empty) | The entity name assigned to roof rafters. |\n| **Material Joists** | text | (empty) | The timber material code for joists (e.g., C24). |\n| **Material Rafters** | text | (empty) | The timber material code for rafters. |\n| **Grade Joists** | text | (empty) | The structural strength grade for joists. |\n| **Grade Rafters** | text | (empty) | The structural strength grade for rafters. |\n| **Information Joists** | text | (empty) | Additional notes or handling instructions for joists. |\n| **Information Rafters** | text | (empty) | Additional notes or handling instructions for rafters. |\n| **Label Joists** | text | (empty) | The primary label used for joists in drawings and production lists. |\n| **Label Rafters** | text | (empty) | The primary label used for rafters in drawings and production lists. |\n| **SubLabel Joists** | text | (empty) | A secondary label for sorting or grouping joists. |\n| **SubLabel Rafters** | text | (empty) | A secondary label for sorting or grouping rafters. |\n| **SubLabel2 Joists** | text | (empty) | A tertiary categorization label for joists. |\n| **SubLabel2 Rafters** | text | (empty) | A tertiary categorization label for rafters. |\n| **Beamcode Joists** | text | (empty) | Production code often used to trigger specific machining or nesting logic for joists. |\n| **Beamcode Rafters** | text | (empty) | Production code often used to trigger specific machining or nesting logic for rafters. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add specific custom options to the entity right-click menu. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies entirely on the Properties Palette for configuration; no external settings files are required.\n\n## Tips\n- **Smart Update**: The script only updates fields that are currently empty. If you have already manually named a specific beam, running this script will not overwrite your custom entry.\n- **Orientation Detection**: The script determines if a beam is a \"Joist\" or \"Rafter\" based on its slope. Beams perfectly horizontal (perpendicular to World Z) are treated as Joists; sloped beams are treated as Rafters.\n- **Catalog Use**: To speed up workflow, you can create a Catalog entry with pre-filled properties (e.g., a standard \"C24 Roof\" preset). Running the script via this catalog will skip the Properties Palette step and apply the saved settings immediately.\n\n## FAQ\n- **Q: Why didn't the script update the Material for my specific beam?**\n  **A:** The script is designed to preserve data. It will only fill in a field (like Material) if that field is currently empty on the beam. Check if the beam already has a value assigned.\n- **Q: How does it distinguish between a floor joist and a roof rafter?**\n  **A:** It checks the geometry. If the beam is horizontal (flat), it uses the \"Joist\" settings. If the beam is sloped, it uses the \"Rafter\" settings.\n- **Q: Can I use this on Wall elements?**\n  **A:** No, the script is specifically designed for Floor and Roof elements (using the `ElementRoof` filter)."
      },
      "tokens_used": 8185,
      "error": null
    }
  }
}