{
  "filename": "hsbScheduleTable.mcr",
  "status": "completed",
  "total_tokens": 53967,
  "processing_time": 828.2167592048645,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": null,\n    \"majorVersion\": null,\n    \"minorVersion\": null,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"This tsl creates a schedule table based on excel report definitions\",\n  \"versionHistory\": [\n    {\n      \"version\": \"4.1\",\n      \"date\": \"19/08/2025\",\n      \"author\": \"Marsel Nakuci\",\n      \"changes\": \"Reactivate property \\\"Alignment\\\" {top/bottom}\"\n    },\n    {\n      \"version\": \"4.0\",\n      \"date\": \"05.06.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"counting quantity improved for nested items of metalparts\"\n    },\n    {\n      \"version\": \"3.9\",\n      \"date\": \"24.03.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"drawing hardware color and transparency improved\"\n    },\n    {\n      \"version\": \"3.8\",\n      \"date\": \"06.02.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"Property 'Number' resolves as integer or text\"\n    },\n    {\n      \"version\": \"3.7\",\n      \"date\": \"30.01.2025\",\n      \"author\": \"Thorsten Huck\",\n      \"changes\": \"Hardware supports simple queries equal '=' and not equal '!=', summary type added for hardware\"\n    },\n    {\n      \"version\": \"3.6\",\n      \"date\": \"16.01.2025\",\n     "
      },
      "tokens_used": 8913,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "History comments explicitly state 'viewport support added' and 'supports insertion on multipages'. Logic block contains conditional checks for 'bHasPage' and 'bHasSection' to determine behavior within ShopDrawing contexts (e.g., erasing instance if invalid on a page). The script uses 'PrEntity' prompts for interactive selection, indicating it is a tool script rather than an auto-generated element script."
        },
        "prerequisites": {
          "requiredEntities": [
            "User-selected Entities (GenBeam, Element, etc.)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space or Paper Space (ShopDrawing)",
          "requiredSettings": [
            "Excel Report Definitions (referenced by GetReportMapFromCompany)",
            "hsbExcel.dll",
            "TslUtilities.dll"
          ]
        }
      },
      "tokens_used": 9024,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "|Select entities|",
              "condition": "_kExecuteKey == \"|Add Entities|\"",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select entities|",
              "condition": "_kExecuteKey == \"|Remove Entities|\"",
              "required": true
            },
            {
              "step": 3,
              "function": "getString",
              "promptOriginal": "|Are you sure to overwrite existing settings?| [|No|]/[|Yes|]",
              "condition": "_kExecuteKey == \"|Export Settings|\" and file exists",
              "required": false
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "SelectFromList",
            "trigger": "_kExecuteKey == \"|Select Report|\" or _kExecuteKey == sDoubleClick",
            "title": "|Report Definitions|",
            "dataSource": "Report map definitions from company folder (sReports)",
            "features": {
              "searchable": null,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "|Add Entities|",
            "handler": "|Add Entities|",
            "action": "Prompts user to select entities to append to the schedule list.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove Entities|",
            "handler": "|Remove Entities|",
            "action": "Prompts user to select entities to remove from the schedule list.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Select Report|",
            "handler": "|Select Report|",
            "action": "Opens a dialog to change the active report definition.",
            "alsoTriggeredBy": "Double Click"
          },
          {
            "menuItem": "|Update Report Definition|",
            "handler": "|Update Report Definition|",
            "action": "Reloads the report definition map from the company settings.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Import Settings|",
            "handler": "|Import Settings|",
            "action": "Imports schedule table settings from an XML file.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Export Settings|",
            "handler": "|Export Settings|",
            "action": "Exports current schedule table settings to an XML file.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "Referenced by variable sFullPath",
            "searchPaths": [
              "Company Folder structure (derived from sPath/sFolder variables)"
            ],
            "purpose": "Storage for schedule table configuration (Import/Export).",
            "required": false
          },
          {
            "filename": "Excel Report Definitions",
            "searchPaths": [
              "Company Folder (retrieved via GetReportMapFromCompany)"
            ],
            "purpose": "Provides the structure and content for the schedule table.",
            "required": true
          }
        ]
      },
      "tokens_used": 9773,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates a customizable schedule table (BOM, cut list, or hardware list) in the CAD drawing based on user-selected entities and Excel-based report definitions.",
          "category": "ShopDrawing/Reporting",
          "typicalUseCase": "Creating a material take-off or parts list for a specific assembly, wall panel, or the entire project directly in the model space or on a layout sheet."
        },
        "parameters": [
          {
            "name": "_Pt0",
            "technicalDefault": "Point3d(0,0,0) / User selected",
            "businessMeaning": "The insertion point (origin) of the schedule table in the drawing.",
            "validRange": "Any X,Y,Z coordinate in Model or Paper Space",
            "unit": "mm (Coordinate)",
            "affectsOutput": "Determines the physical location of the table geometry on the drawing."
          },
          {
            "name": "sReport",
            "technicalDefault": "Empty String",
            "businessMeaning": "The name of the Report Definition (template) used to structure the table (defines columns, data sources, and sorting).",
            "validRange": "Any valid report name available in the Company folder",
            "unit": "String",
            "affectsOutput": "Changes the layout, column headers, and type of data displayed (e.g., switching from a Timber List to a Hardware List)."
          },
          {
            "name": "sSubReport",
            "technicalDefault": "Empty String",
            "businessMeaning": "The specific section or category within the Report Definition to display.",
            "validRange": "Valid sections defined within the selected Report Definition",
            "unit": "String",
            "affectsOutput": "Filters the data to show only specific subsets (e.g., only 'Beams' vs 'Sheathing' within a wall report)."
          },
          {
            "name": "_Entity[]",
            "technicalDefault": "Empty Array",
            "businessMeaning": "The list of construction elements (Beams, Elements, etc.) currently included in the schedule calculation.",
            "validRange": "Any hsbCAD Entity (GenBeam, Element, etc.)",
            "unit": "Array of Entities",
            "affectsOutput": "Directly controls the rows and quantities calculated in the table. Adding entities adds rows; removing them deletes rows."
          },
          {
            "name": "mapSetting",
            "technicalDefault": "Empty Map",
            "businessMeaning": "Internal storage for user configurations such as column widths, text height, and sort orders.",
            "validRange": "N/A (Managed via Import/Export)",
            "unit": "Map",
            "affectsOutput": "Controls the visual formatting (font size, column alignment) and persistence of the table state between sessions."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User changes 'sReport' (via Select Report)",
            "effect": "The script fetches the new 'ReportDefinition' map from the company folder, resets internal grip points, and rebuilds the table structure.",
            "cascade": [
              "sSubReport",
              "ReportDefinition Map",
              "Table Geometry"
            ]
          },
          {
            "trigger": "User adds/removes entities (via Add/Remove Entities)",
            "effect": "The script recalculates the quantities and data rows, then updates the table geometry to fit the new content.",
            "cascade": [
              "Table Content",
              "Table Height",
              "Grip Locations"
            ]
          },
          {
            "trigger": "User moves grips (Resizing/Scaling)",
            "effect": "The script recalculates column widths or text height based on the relative movement of the grip points.",
            "cascade": [
              "mapSetting (Column Widths)",
              "Text Height",
              "Table Geometry"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Text/Attributes",
            "description": "Formatted text strings displaying data (Length, Width, Material, Mark, etc.) derived from the selected entities.",
            "appliedTo": "N/A (Created at _Pt0)"
          },
          {
            "type": "Line/Polyline",
            "description": "Grid lines and border outlines representing the table structure (headers, rows, columns).",
            "appliedTo": "N/A (Created at _Pt0)"
          },
          {
            "type": "GripPoints",
            "description": "Interactive handles allowing the user to move the table or resize columns/text height dynamically.",
            "appliedTo": "TSL Instance"
          }
        ]
      },
      "tokens_used": 9408,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Execute insertion command to place TSL instance in drawing (Model or Paper Space).",
          "2. [Initial State] Instance created with default or empty settings.",
          "3. Right-click instance and select '|Add Entities|'.",
          "4. Select GenBeam, Element, or other valid entities from the CAD model.",
          "5. Script appends entities to internal list and recalculates table content.",
          "6. [Optional] Double-click instance or select '|Select Report|' to change the template.",
          "7. Select desired Report Definition from the list dialog.",
          "8. Script rebuilds table geometry based on new definition and data.",
          "9. [Optional] Drag grips to resize text height (vertical) or column widths (horizontal).",
          "10. [Optional] Use '|Export Settings|' to save configuration for future use."
        ],
        "conditionalBranches": [
          {
            "condition": "User triggers '|Export Settings|' and a file with the same name already exists at the target path.",
            "path1": {
              "name": "Confirm Overwrite",
              "steps": [
                "Prompt appears on command line: '|Are you sure to overwrite existing settings?| [|No|]/[|Yes|]'",
                "User inputs 'Yes' to proceed with overwriting the XML file."
              ]
            },
            "path2": {
              "name": "Cancel/No",
              "steps": [
                "User inputs 'No' or cancels the command.",
                "Export operation is aborted; existing file remains unchanged."
              ]
            }
          },
          {
            "condition": "Script running in ShopDrawing context (on a Sheet/View) and calculated row count is less than 2.",
            "path1": {
              "name": "Valid Content (Rows >= 2)",
              "steps": [
                "Table geometry (lines and text) is generated.",
                "Bounding shape (PlaneProfile) is updated.",
                "Instance remains visible in the drawing."
              ]
            },
            "path2": {
              "name": "Empty/Invalid Content (Rows < 2)",
              "steps": [
                "Message displayed: '|Could not find any content, schedule table will be deleted.|'",
                "Function 'eraseInstance()' is called.",
                "TSL instance is removed from the drawing."
              ]
            }
          },
          {
            "condition": "User changes the 'sReport' property (via Select Report).",
            "path1": {
              "name": "Successful Update",
              "steps": [
                "New report map is fetched from Company folder.",
                "Internal 'ReportDefinition' map is updated.",
                "Grips are reset (_Grip.setLength(0)).",
                "Table is redrawn with new structure."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Selection",
            "errorMessage": "No explicit error, but selection set is checked for validity (ssE.go()).",
            "recovery": "User must select valid hsbCAD entities (GenBeam, Element, etc.). Invalid selections are ignored."
          },
          {
            "check": "Report Definition Availability",
            "errorMessage": "If the report definition is missing from the company folder, the script attempts to use a buffered report or logs a message (implied by version notes HSB-22667).",
            "recovery": "Update report definitions via '|Update Report Definition|' or ensure correct company folder path."
          },
          {
            "check": "ShopDrawing Content",
            "errorMessage": "'Could not find any content, schedule table will be deleted.'",
            "recovery": "Ensure the entities associated with the schedule are visible/valid in the specific ShopDrawing context, or switch to a report that generates output for the current selection."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add/Remove Entities",
            "how": "Context Menu -> '|Add Entities|' or '|Remove Entities|'",
            "effect": "Updates the internal entity list, triggering a recalculation of quantities and rows."
          },
          {
            "action": "Change Report Template",
            "how": "Context Menu -> '|Select Report|' or Double-Click",
            "effect": "Changes the table structure (columns/sorting) and data source, completely regenerating the table."
          },
          {
            "action": "Resize Table",
            "how": "Grip Edit (Drag handles)",
            "effect": "Horizontal drag adjusts column widths; Vertical drag adjusts text height; Non-orthogonal drag scales both."
          },
          {
            "action": "Update Report Definitions",
            "how": "Context Menu -> '|Update Report Definition|'",
            "effect": "Reloads the report map from the company folder (useful if Excel definitions changed externally)."
          },
          {
            "action": "Save/Load Configuration",
            "how": "Context Menu -> '|Export Settings|' or '|Import Settings|'",
            "effect": "Saves current layout/settings to XML or restores them, ensuring consistency across drawings."
          }
        ]
      },
      "tokens_used": 10387,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbScheduleTable.mcr\n\n## Overview\nThis script generates a customizable schedule table (such as a BOM, cut list, or hardware list) directly in your CAD drawing. It uses Excel-based report definitions to format data derived from selected timber elements, hardware, or other entities.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Standard placement for project-wide schedules. |\n| Paper Space | Yes | Can be placed on layout sheets. |\n| Shop Drawing | Yes | Supports automatic generation on shop drawings; will delete itself if no content is found. |\n\n## Prerequisites\n- **Required Entities**: You must manually select GenBeams, Elements, or other entities to populate the table.\n- **Minimum Beam Count**: 0 (Empty tables are allowed during creation, though they may auto-delete in Shop Drawings).\n- **Required Settings**:\n    - Excel Report Definitions located in your Company folder.\n    - `hsbExcel.dll` and `TslUtilities.dll` must be installed.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbScheduleTable.mcr`\nClick in the drawing (Model or Paper Space) to set the insertion point (`_Pt0`).\n\n### Step 2: Select a Report Definition\n**Action:** Double-click the new table instance OR Right-click and select **|Select Report|**.\nA dialog appears listing available report definitions from your Company folder. Select the template that matches the data you want to show (e.g., \"Timber List\", \"Hardware List\").\n\n### Step 3: Add Entities to the Table\n**Action:** Right-click and select **|Add Entities|**.\nThe command line will prompt:\n```\nSelect entities:\n```\nSelect the beams, walls, or elements in your model that you want to include in the schedule. Press Enter to confirm. The table will update immediately with the new data.\n\n### Step 4: Adjust Table Layout\n**Action:** Click and drag the blue grips on the table.\n- **Horizontal Drag**: Adjusts column widths.\n- **Vertical Drag**: Adjusts text height.\n- **Free Drag**: Scales both text and width proportionally.\n\n## Properties Panel Parameters\nThis script primarily utilizes the Right-Click Context Menu and interactive Grips for configuration. Standard Properties Panel inputs are not used for the main configuration.\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **|Add Entities|** | Opens a selection prompt to append new elements to the current schedule. |\n| **|Remove Entities|** | Opens a selection prompt to remove specific elements from the current schedule. |\n| **|Select Report|** | Opens a dialog to switch the table template (e.g., from a BOM to a Cut List). |\n| **|Update Report Definition|** | Reloads the report configuration from the Company folder (useful if Excel templates were edited externally). |\n| **|Export Settings|** | Saves the current table configuration (column widths, text height, etc.) to an XML file. |\n| **|Import Settings|** | Loads a previously saved configuration from an XML file. |\n\n## Settings Files\n- **Filename**: `Excel Report Definitions` (varies by Company)\n- **Location**: Company Folder (retrieved automatically)\n- **Purpose**: Defines the columns, sorting, and data sources for the table.\n\n- **Filename**: `[UserDefined].xml`\n- **Location`: User-defined path (during Export)\n- **Purpose`: Stores custom visual settings (text height, column widths) to reuse in other drawings.\n\n## Tips\n- **Quick Template Change**: Simply double-click the table to swap the report definition without going through the context menu.\n- **Shop Drawing Safety**: If a schedule table placed on a Shop Drawing finds fewer than 2 rows of data (effectively empty), it will automatically delete itself to keep drawings clean.\n- **Overwrite Warning**: When exporting settings, if the file name already exists, the command line will ask `|Are you sure to overwrite existing settings?|`. Type `Yes` to confirm.\n- **Grip Editing**: Use the grips to fit the table perfectly into your drawing title block.\n\n## FAQ\n- **Q: My table is blank after inserting it.**\n  - A: The table starts empty. You must Right-click -> **|Add Entities|** and select the parts from your model to generate data.\n\n- **Q: Can I use this for hardware only?**\n  - A: Yes. Select a Report Definition designed for hardware/metal parts during the **|Select Report|** step.\n\n- **Q: Why did my table disappear from the layout?**\n  - A: In Shop Drawing mode, if the script detects no valid content (rows < 2), it erases the instance automatically. Check if your referenced elements exist in that specific view or section."
      },
      "tokens_used": 6462,
      "error": null
    }
  }
}