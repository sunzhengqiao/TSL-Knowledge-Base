{
  "filename": "NA_FLOOR_CENTER_OF_GRAVITY.mcr",
  "status": "completed",
  "total_tokens": 53960,
  "processing_time": 500.1405680179596,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9628,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script attaches to _Element. Collects entities using _kModelSpace filter (GenBeam, TrussEntity, Sheet). Calculates Center of Gravity based on Body volume (3D geometry). Uses showInDispRep('LayoutDisplay') to visualize results in drawings, but operates on the 3D model."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam",
            "Sheet",
            "TrussEntity"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": [
            "NA_FLOOR_HOLES.mcr"
          ]
        }
      },
      "tokens_used": 8057,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "\\nSelect a set of elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "psCircleInBy",
            "type": "PropString",
            "displayName": "Length Factor",
            "defaultValue": "1/2 Length In",
            "inputType": "dropdown",
            "options": [
              "1/2 Length In",
              "1/4 Length In",
              "1/3 Length In"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "psShowCirscle",
            "type": "PropString",
            "displayName": "Show Circle",
            "defaultValue": "Yes",
            "inputType": "dropdown",
            "options": [
              "Yes",
              "No"
            ],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "psHoles",
            "type": "PropString",
            "displayName": "Sheathing Hole",
            "defaultValue": "2-1\"Drills Spaced at 3-3/4\"",
            "inputType": "dropdown",
            "options": [
              "2-1\"Drills Spaced at 3-3/4\"",
              "2-1\"Drills Spaced at 1-3/4\"",
              "2-1\"Drills Spaced at 3\"",
              "Circular Hole 1.25",
              "Circular Hole 1.5",
              "Circular Hole 4",
              "Circular Hole 5",
              "Circular Hole 6",
              "Circular Hole 9",
              "Circular Hole 10",
              "Ellipse 3x1",
              "Ellipse 3x2",
              "Ellipse 4x2",
              "Ellipse 4x1.5",
              "Diamond Hole 4 1/2",
              "Diamond Hole 5 1/2",
              "Diamond Hole 8",
              "Rectangle Hole 6X9",
              "Rectangle Hole 5.5x8",
              "Rectangle Hole 5.5x10",
              "Rectangle Hole 3.5x14.5",
              "Rectangle Hole 4.25x10.25",
              "Square Hole 5",
              "Square Hole 6",
              "Square Hole 8",
              "Square Hole 10"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 9665,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Calculates the Center of Gravity (CoG) for a floor or roof element and automatically places lift holes at optimal balance points.",
          "category": "Hardware/ShopDrawing",
          "typicalUseCase": "Preparing a floor panel for shop fabrication where lifting/pick-up points need to be machined to ensure the panel is balanced during crane lifting."
        },
        "parameters": [
          {
            "name": "psCircleInBy",
            "technicalDefault": "1/2 Length In",
            "businessMeaning": "Defines the diameter of a visual reference circle drawn at the Center of Gravity. The diameter is calculated as a percentage of the element's largest dimension (Length or Width). This helps riggers visualize the spread area of the lifting gear.",
            "validRange": "1/2 Length In (50%), 1/4 Length In (25%), 1/3 Length In (33.3%)",
            "unit": "Ratio",
            "affectsOutput": "Changes the size of the circle visual (PLine) in the model and drawing layout."
          },
          {
            "name": "psShowCirscle",
            "technicalDefault": "Yes",
            "businessMeaning": "Toggles the visibility of the visual reference circle around the Center of Gravity.",
            "validRange": "Yes, No",
            "unit": "Boolean",
            "affectsOutput": "If 'No', the reference circle geometry is not generated; if 'Yes', it is drawn."
          },
          {
            "name": "psHoles",
            "technicalDefault": "2-1\"Drills Spaced at 3-3/4\"",
            "businessMeaning": "Specifies the profile and type of lift hole to be machined at the calculated lift points. This string is passed directly to the sub-script 'NA_FLOOR_HOLES' which generates the actual machining operations.",
            "validRange": "List of specific hole patterns (e.g., 'Circular Hole 6', 'Ellipse 3x2', 'Rectangle Hole 6X9')",
            "unit": "String",
            "affectsOutput": "Determines the geometry and size of the holes created by the NA_FLOOR_HOLES script."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selection of psHoles",
            "effect": "Passes the selected string as a property to the generated NA_FLOOR_HOLES instances.",
            "cascade": [
              "NA_FLOOR_HOLES Instances"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Visual Geometry",
            "description": "Text label 'CG', crosshair lines, and an optional reference circle centered on the calculated CoG.",
            "appliedTo": "Model Space and Layout Display (visualization only)."
          },
          {
            "type": "TSL Instance",
            "description": "Instances of the 'NA_FLOOR_HOLES' script created at calculated lift points.",
            "appliedTo": "The selected Element (Floor/Roof)."
          }
        ]
      },
      "tokens_used": 10193,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script launches via _bOnInsert flag (True during insertion).",
          "2. OPM Dialog shows for user to configure 'Length Factor', 'Show Circle', and 'Sheathing Hole' options.",
          "3. User selects a set of elements (PrEntity prompt) to analyze.",
          "4. Script filters selection for 'ElementRoof' types (Floor/Roof panels) and stores valid entities.",
          "5. Script loops through selected elements, cloning itself onto each valid element using 'dbCreate', passing current OPM property values.",
          "6. Original script instance erases itself (eraseInstance).",
          "7. (Cloned Instance) Security Check: Validates that it is attached to an element. If not, reports 'No Element Found', erases, and exits.",
          "8. (Cloned Instance) Duplicate Check: Scans attached TSLs for other instances of this script. If found, it erases the old instance and its associated hole map entities to ensure single-instance-per-element integrity.",
          "9. (Cloned Instance) Data Collection: Collects GenBeams, TrussEntities, and Sheets from the element's group.",
          "10. (Cloned Instance) Body Calculation: Generates real bodies for Beams and bounding quaders for Trusses.",
          "11. (Cloned Instance) Loop Analysis: Iterates through collected entities to calculate volume, weight (using material lookups), and moment arms relative to the element origin.",
          "12. (Cloned Instance) Filtering: Excludes dummy beams or beams marked 'LOOSE'. Logs ignored items.",
          "13. (Cloned Instance) CoG Calculation: Computes the Center of Gravity (ptDatum) using total moments and total weight.",
          "14. (Cloned Instance) Visualization: Draws 'CG' text and crosshairs at the CoG. Draws a reference circle if 'Show Circle' is Yes.",
          "15. (Cloned Instance) Lift Point Logic: Identifies internal structural members (Beams/Trusses) suitable for lifting based on location relative to CoG and sheeting overlaps.",
          "16. (Cloned Instance) Collision Detection: Checks identified lift points against truss plates and sheet gaps, adjusting coordinates to avoid conflicts.",
          "17. (Cloned Instance) Hole Generation: Inserts 'NA_FLOOR_HOLES' TSL instances at the final calculated lift points, passing the selected hole configuration.",
          "18. (Cloned Instance) Map Storage: Stores generated hole instances in the script's entity map ('mpHoles') for reference/removal later."
        ],
        "conditionalBranches": [
          {
            "condition": "_bOnInsert flag",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Show Dialog",
                "Select Elements",
                "Clone instance to Elements",
                "Erase original instance"
              ]
            },
            "path2": {
              "name": "Execution Mode (Cloned)",
              "steps": [
                "Verify Element attachment",
                "Remove Duplicates",
                "Calculate CoG",
                "Generate Geometry & Holes"
              ]
            }
          },
          {
            "condition": "Element Count",
            "path1": {
              "name": "Valid Selection",
              "steps": [
                "Iterate entities",
                "Proceed with cloning"
              ]
            },
            "path2": {
              "name": "Empty Selection",
              "steps": [
                "Do nothing (Script terminates silently after insertion block)"
              ]
            }
          },
          {
            "condition": "Material Match",
            "path1": {
              "name": "Match Found in Array",
              "steps": [
                "Assign density from arDWeight array"
              ]
            },
            "path2": {
              "name": "Default Fallback",
              "steps": [
                "Assign default Beam (50) or Sheet (38) density based on type"
              ]
            }
          },
          {
            "condition": "Show Circle Property",
            "path1": {
              "name": "Yes",
              "steps": [
                "Calculate Element Extents (Width/Length)",
                "Draw PLine Circle at CoG"
              ]
            },
            "path2": {
              "name": "No",
              "steps": [
                "Skip Circle drawing"
              ]
            }
          },
          {
            "condition": "Lift Point Location Logic",
            "path1": {
              "name": "Valid Beam/Truss Found",
              "steps": [
                "Check distance from edge",
                "Check for Truss Plate intersection",
                "Check for Sheet Gap overlap",
                "Confirm final lift point"
              ]
            },
            "path2": {
              "name": "Conflict/No Valid Point",
              "steps": [
                "Shift search line inward",
                "Retry finding valid member",
                "Log 'Redo: true' message"
              ]
            }
          },
          {
            "condition": "Debug Mode (iDebug)",
            "path1": {
              "name": "True",
              "steps": [
                "Visualize intersection bodies",
                "Skip Hole creation (replaced by markers)"
              ]
            },
            "path2": {
              "name": "False",
              "steps": [
                "Execute standard TSL creation for holes"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Attachment",
            "errorMessage": "\\nNo Element Found",
            "recovery": "Script self-destructs. User must run script again and select a valid Element."
          },
          {
            "check": "Beam/Entity Validity",
            "errorMessage": "None (Internal Logic)",
            "recovery": "Script ignores dummy beams or those containing 'LOOSE' in the name. It recalculates CoG based on remaining geometry."
          },
          {
            "check": "Geometry Collection",
            "errorMessage": "None (Internal Logic)",
            "recovery": "If no bodies are found (arGb.length() == 0), the script stops further processing to prevent division by zero errors in CoG calculation."
          },
          {
            "check": "Duplicate Script Instance",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically finds and erases previous instances of itself attached to the same element, ensuring only the latest calculation and geometry exist."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Update Properties",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Changing 'Length Factor', 'Show Circle', or 'Sheathing Hole' triggers a script recalculation, updating the CoG circle visibility and the type of lift holes generated."
          },
          {
            "action": "Modify Geometry",
            "how": "Modify underlying Element (e.g., add/remove beams, change dimensions)",
            "effect": "Script recalculates Center of Gravity and relocates lift points to maintain balance. Old holes are erased (via duplicate cleanup logic) and new ones generated."
          }
        ]
      },
      "tokens_used": 10376,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# NA_FLOOR_CENTER_OF_GRAVITY.mcr\n\n## Overview\nThis script automatically calculates the Center of Gravity (CoG) for floor or roof panels and generates lift holes at optimal balance points. It ensures that panels are balanced during crane lifting by accounting for the weight of beams, trusses, and sheathing materials.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Primary environment for calculation and geometry generation. |\n| Paper Space | Yes | Visual reference (CG Text and Circle) appears in layout displays. |\n| Shop Drawing | No | This is a model generation tool, not a detailing tool. |\n\n## Prerequisites\n- **Required Entities**: An Element (Floor or Roof) containing GenBeams, Trusses, or Sheets.\n- **Minimum Beam Count**: 0 (Calculates based on available geometry).\n- **Required Settings Files**:\n  - `NA_FLOOR_HOLES.mcr` (Must be available for the script to generate hole geometry).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `NA_FLOOR_CENTER_OF_GRAVITY.mcr` from the file dialog.\n\n### Step 2: Select Elements\n```\nCommand Line: Select a set of elements\nAction: Click on one or more floor/roof elements in the model and press Enter.\n```\nThe script will automatically attach itself to the selected elements and calculate the Center of Gravity.\n\n### Step 3: Configure Properties\nAfter insertion, select an element with the script attached to open the **Properties Palette**.\n1. Locate the *Script Parameters* or *Object Data* section.\n2. Adjust the **Length Factor**, **Show Circle**, or **Sheathing Hole** options as desired.\n3. The script will automatically update the geometry and hole placement when properties are changed.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Length Factor | dropdown | 1/2 Length In | Determines the size of the visual reference circle drawn at the Center of Gravity. Options include 1/2, 1/3, or 1/4 of the element's length. |\n| Show Circle | dropdown | Yes | Toggles the visibility of the reference circle around the Center of Gravity. Set to \"No\" to hide the circle. |\n| Sheathing Hole | dropdown | 2-1\"Drills Spaced at 3-3/4\" | Selects the specific hole pattern or profile to be machined at the lift points. Includes options for circular holes, rectangles, ellipses, and drill patterns. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | This script does not add specific items to the right-click context menu. |\n\n## Settings Files\n- **Filename**: `NA_FLOOR_HOLES.mcr`\n- **Location**: TSL Scripts folder (Company or hsbCAD Install path)\n- **Purpose**: This sub-script is responsible for actually creating the machining operations (holes) based on the configuration selected in the main script.\n\n## Tips\n- **Visualizing the Lift Zone**: Use the **Length Factor** property to draw a large circle around the CoG. This helps riggers understand the spread of the lifting gear.\n- **Automatic Updates**: If you modify the floor structure (e.g., add heavy beams or change sheathing), select the element and press Enter to trigger a recalculation. The CoG and lift points will move to the new balanced position.\n- **Collision Detection**: The script attempts to avoid placing holes on Truss Plates or in gaps between sheathing. If it cannot find a suitable spot, it will shift the lift point inward and retry.\n- **Loose Material**: Beams marked as \"LOOSE\" or dummy beams are automatically excluded from the weight calculation.\n\n## FAQ\n- **Q: Why did the script not generate any holes?**\n  **A:** The script searches for internal structural members (beams/trusses) near the CoG to place holes. If no valid member is found (e.g., the CoG falls in a large open gap or directly on a truss plate that cannot be avoided), holes may not be generated.\n- **Q: Can I change the hole size after insertion?**\n  **A:** Yes. Select the element, open the Properties Palette, and change the **Sheathing Hole** dropdown to a different profile (e.g., \"Circular Hole 6\"). The script will regenerate the holes immediately.\n- **Q: Does this include the weight of the sheathing?**\n  **A:** Yes, the script collects Sheets, GenBeams, and TrussEntities to calculate the true volumetric Center of Gravity.\n- **Q: What does the \"CG\" text indicate?**\n  **A:** This marks the exact calculated Center of Gravity for the panel. Lifting hooks should theoretically align vertically above this point for a balanced lift."
      },
      "tokens_used": 6041,
      "error": null
    }
  }
}