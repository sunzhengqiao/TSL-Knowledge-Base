{
  "filename": "hsbBeamCornerConnection.mcr",
  "status": "completed",
  "total_tokens": 53545,
  "processing_time": 282.99256348609924,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "10Oct2020",
            "author": "marsel.nakuci@hsbcad.com",
            "changes": "HSB-9321: add properties nR drills, distance between drills "
          },
          {
            "version": "1.0",
            "date": "10Jun2020",
            "author": "geoffroy.cenni@hsbcad.com",
            "changes": "initial "
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9076,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script modifies beam geometry using addTool (Cut, Drill, Mortise). Uses getBeam for user selection. No 'sd_' or 'Multipage' prefixes. No 'Sheet' or '_Viewport' usage."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7311,
      "error": null
    },
    "3": {
      "success": true,
      "data": {},
      "tokens_used": 10665,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation of a structural corner connection between two perpendicular joists, including mitering, material clearance, and optional mortise/tenon and drilling connections to a perpendicular post.",
          "category": "Joinery/Framing",
          "typicalUseCase": "Used in timber frame construction to connect perpendicular floor joists or rafters at a corner, optionally integrating with a vertical post for a beam-to-column joint."
        },
        "parameters": [
          {
            "name": "dAngleWidth",
            "technicalDefault": "U(50)",
            "businessMeaning": "Defines the width parameter used in the angular geometry calculations for the connection.",
            "validRange": "20 - 200",
            "unit": "mm",
            "affectsOutput": "Adjusts the dimensional properties of the angular connection geometry."
          },
          {
            "name": "dDrillDia",
            "technicalDefault": "U(22)",
            "businessMeaning": "Diameter of the dowel, bolt, or drill hole passing through the joists and post.",
            "validRange": "12 - 50",
            "unit": "mm",
            "affectsOutput": "Determines the size of the Drill tools added to the beams and the scale of the generated hardware component (Peg)."
          },
          {
            "name": "dDrillHeight",
            "technicalDefault": "U(26)",
            "businessMeaning": "Vertical reference height for the center of the first drill hole.",
            "validRange": "10 - BeamHeight",
            "unit": "mm",
            "affectsOutput": "Sets the vertical position (Z-coordinate) of the drill sequence center point."
          },
          {
            "name": "nNr",
            "technicalDefault": "1",
            "businessMeaning": "The number of drill holes to generate in the vertical direction.",
            "validRange": "1 - 5",
            "unit": "count",
            "affectsOutput": "Controls the loop that creates Drill tools. If > 1, multiple holes are spaced vertically."
          },
          {
            "name": "dDistance",
            "technicalDefault": "U(25)",
            "businessMeaning": "The center-to-center spacing between multiple drill holes.",
            "validRange": "30 - 200",
            "unit": "mm",
            "affectsOutput": "Calculates the offset for each subsequent drill hole when nNr > 1."
          },
          {
            "name": "dToljoist",
            "technicalDefault": "U(4)",
            "businessMeaning": "Expansion gap or play allowed between the two intersecting joists to ensure fit.",
            "validRange": "0 - 10",
            "unit": "mm",
            "affectsOutput": "Expands the size of the cutting bodies (CubeCut) that clear the intersection volume."
          },
          {
            "name": "dTolMortise",
            "technicalDefault": "U(4)",
            "businessMeaning": "Expansion gap or play allowed for the mortise and tenon joint (typically making the tenon slightly smaller).",
            "validRange": "0 - 10",
            "unit": "mm",
            "affectsOutput": "Increases the dimensions of the Mortise tool on the joist (tenon) relative to the post mortise."
          },
          {
            "name": "dMortiseOffX",
            "technicalDefault": "U(95)",
            "businessMeaning": "Longitudinal (length-wise) offset of the mortise pocket from the reference point.",
            "validRange": "0 - BeamLength",
            "unit": "mm",
            "affectsOutput": "Locates the position of the mortise along the beam's length."
          },
          {
            "name": "dMortiseOffY",
            "technicalDefault": "U(70)",
            "businessMeaning": "Lateral (width-wise) offset of the mortise pocket from the beam centerline.",
            "validRange": "0 - BeamWidth",
            "unit": "mm",
            "affectsOutput": "Shifts the mortise position sideways relative to the beam."
          },
          {
            "name": "dMortiseWidth",
            "technicalDefault": "U(64)",
            "businessMeaning": "The width of the mortise pocket.",
            "validRange": "40 - BeamWidth",
            "unit": "mm",
            "affectsOutput": "Defines the Y-axis dimension of the Mortise tool."
          },
          {
            "name": "dMortiseDepth",
            "technicalDefault": "U(99)",
            "businessMeaning": "The depth of the mortise pocket (penetration into the beam/post).",
            "validRange": "20 - 300",
            "unit": "mm",
            "affectsOutput": "Defines the X-axis dimension (length) of the Mortise tool."
          },
          {
            "name": "dMortiseHeight",
            "technicalDefault": "U(70)",
            "businessMeaning": "The vertical height of the mortise pocket.",
            "validRange": "40 - BeamHeight",
            "unit": "mm",
            "affectsOutput": "Defines the Z-axis dimension of the Mortise tool."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User selects a Post (3 beams total)",
            "effect": "Activates the PostConnection logic. Mortise and Drill tools are applied to the post and the male joist. Without the post, only joist-joist cuts are applied.",
            "cascade": [
              "dMortiseWidth",
              "dMortiseDepth",
              "dMortiseHeight",
              "dDrillDia",
              "nNr",
              "dDistance"
            ]
          },
          {
            "trigger": "nNr is increased",
            "effect": "Additional drill holes are generated. The spacing is determined by dDistance, centered around the original dDrillHeight.",
            "cascade": [
              "dDistance",
              "dDrillHeight"
            ]
          },
          {
            "trigger": "Flip Side trigger",
            "effect": "Swaps joist0 and joist1 in the array, effectively reversing the roles of the two beams (which one is treated as the primary male connection).",
            "cascade": [
              "joist0",
              "joist1"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Cut",
            "description": "End cuts applied to the joists to create the corner meeting (can be mitered depending on geometry).",
            "appliedTo": "joist0, joist1"
          },
          {
            "type": "BeamCut (CubeCut)",
            "description": "Boolean subtraction of a rectangular volume at the intersection to prevent physical collision between the two joists.",
            "appliedTo": "joist0, joist1"
          },
          {
            "type": "Mortise",
            "description": "Creates a pocket in the post and a corresponding male pocket on the joist (tenon) for a post-to-beam connection.",
            "appliedTo": "post (if selected), joist0 (if post selected)"
          },
          {
            "type": "Drill",
            "description": "Through-holes for dowels or bolts, aligned through the post and the joist.",
            "appliedTo": "post (if selected), joist0 (if post selected)"
          },
          {
            "type": "Hardware Component",
            "description": "Generates a BOM entry for a 'Peg' connector sized according to the drill diameter and beam width.",
            "appliedTo": "Script Instance (List)"
          }
        ]
      },
      "tokens_used": 9438,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins (Insert Mode)",
          "Check for execution key (_kExecuteKey) to determine insertion method",
          "If execution key exists: Load properties from Catalog or Last Inserted settings",
          "If execution key missing: Show Properties Dialog to user",
          "Prompt user to Select Male Joist (Beam 0)",
          "Prompt user to Select Female Joist (Beam 1)",
          "Prompt user to Select Post (Optional selection)",
          "Validate Post: Check if selected beam is perpendicular to both joists",
          "Save selection to _Beam array (length 2 or 3)",
          "Calculation Phase: Determine intersection geometry of joists",
          "Apply End Cuts to both joists",
          "Apply Miter/Intersection Cuts (CubeCut) to joists to prevent collision",
          "Branch: Check if Post is present (3 beams selected)",
          "If Post present: Apply Mortise to Post and Joist 0, Apply Drills, Apply Clearance Cuts",
          "Generate Hardware Component (Peg) for BOM",
          "Draw visual anchor/reference lines"
        ],
        "conditionalBranches": [
          {
            "condition": "Insertion Context during _bOnInsert",
            "path1": {
              "name": "Catalog/Journal Entry",
              "steps": [
                "Read _kExecuteKey",
                "Load properties from matching catalog entry or sLastInserted",
                "Skip dialog display"
              ]
            },
            "path2": {
              "name": "Standard Manual Insert",
              "steps": [
                "Execute showDialog()",
                "User enters parameters manually",
                "User clicks OK to proceed"
              ]
            }
          },
          {
            "condition": "User selection of Post during Insert",
            "path1": {
              "name": "Valid Post Selected",
              "steps": [
                "User selects beam",
                "Script verifies perpendicularity",
                "Post added to _Beam array (Index 2)",
                "Enables PostConnection logic (Mortise, Drills, SolidSubtract)"
              ]
            },
            "path2": {
              "name": "No/Invalid Post",
              "steps": [
                "User selects nothing or non-perpendicular beam",
                "Post NOT added to _Beam array",
                "Script reports warning: 'Correct post not found or selected joists are not perpendicular'",
                "Only Joist-Joist connection logic executes"
              ]
            }
          },
          {
            "condition": "Post-Insertion Trigger: AddPost",
            "path1": {
              "name": "Add Post to Existing",
              "steps": [
                "Right-click -> AddPost",
                "Prompt user to select post",
                "Validate perpendicularity",
                "Add to _Beam array",
                "Trigger recalculation (2 loops)"
              ]
            },
            "path2": {
              "name": "Post Already Exists",
              "steps": [
                "Right-click -> AddPost",
                "Script detects _Beam.length() == 3",
                "Exits immediately without changes"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Post Perpendicularity",
            "errorMessage": "Correct post not found or selected joists are not perpendicular",
            "recovery": "Select a beam that is mathematically perpendicular (90 degrees) to both joists, or run the 'AddPost' command later with a valid beam."
          },
          {
            "check": "Minimum Drill Count (nNr)",
            "errorMessage": "None (Auto-corrected)",
            "recovery": "If property nNr is < 1, script automatically sets it to 1 to prevent infinite loops or errors."
          },
          {
            "check": "Joist Count",
            "errorMessage": "Implicit (Script expects at least 2 beams)",
            "recovery": "Script initialization requires selecting Male and Female joists. Failing to select these aborts the script or leaves it in an invalid state."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Geometry Parameters",
            "how": "Object Properties Palette (OPM)",
            "effect": "Updates dimensions of cuts, mortises, and drills. Changing 'Drill Diameter' updates the hole size and the Hardware BOM entry."
          },
          {
            "action": "Flip Side",
            "how": "Right-click Context Menu",
            "effect": "Swaps _Beam[0] and _Beam[1]. Reverses which joist is considered 'Male' and which is 'Female', altering the cut direction and logic."
          },
          {
            "action": "Add Post",
            "how": "Right-click Context Menu",
            "effect": "Prompts user to select a post. If valid, it adds the post to the connection and generates the Mortise and Drill tools connecting the joists to the new post."
          }
        ]
      },
      "tokens_used": 10760,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbBeamCornerConnection.mcr\n\n## Overview\nThis script automates the creation of structural corner connections between two perpendicular joists. It handles mitering, material clearance, and optionally creates mortise/tenon joints and drill holes for a connecting vertical post.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required for 3D beam modifications. |\n| Paper Space | No | Not applicable. |\n| Shop Drawing | No | This script modifies the 3D model, not drawings. |\n\n## Prerequisites\n- **Required Entities**: Two or three `GenBeam` entities (Joists).\n- **Minimum Beam Count**: 2 Joists. If a post connection is required, 3 Beams (2 Joists + 1 Post).\n- **Required Settings**: None required.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbBeamCornerConnection.mcr`\n\n### Step 2: Configure Properties (Optional)\nIf not inserting from a pre-configured catalog entry, a Properties Dialog will appear.\n- Adjust dimensions for **Drill Diameter**, **Number of Drills**, or **Mortise Depth** as needed.\n- Click **OK** to confirm.\n\n### Step 3: Select Male Joist\n```\nCommand Line: Select Male Joist\nAction: Click on the first beam (Joist 0). This beam will typically host the tenon or primary cut side.\n```\n\n### Step 4: Select Female Joist\n```\nCommand Line: Select Female Joist\nAction: Click on the second beam (Joist 1). This beam must be perpendicular to the first beam.\n```\n\n### Step 5: Select Post (Optional)\n```\nCommand Line: Select Post (optional)\nAction: Click on a vertical post that intersects the joists, or press ENTER to skip.\nNote: If selected, the post must be perpendicular to both joists to generate mortise and drill holes.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| dAngleWidth | Number | 50 mm | Defines the width parameter used for angular geometry calculations at the corner. |\n| dDrillDia | Number | 22 mm | Diameter of the drill holes (dowels/bolts) passing through the beams and post. |\n| dDrillHeight | Number | 26 mm | Vertical reference height for the center of the first drill hole. |\n| nNr | Integer | 1 | The number of drill holes to generate vertically. |\n| dDistance | Number | 25 mm | The center-to-center spacing between multiple drill holes. |\n| dToljoist | Number | 4 mm | Expansion gap allowed between the two intersecting joists to ensure fit. |\n| dTolMortise | Number | 4 mm | Expansion gap for the mortise and tenon joint (play allowance). |\n| dMortiseOffX | Number | 95 mm | Longitudinal offset of the mortise pocket from the reference point. |\n| dMortiseOffY | Number | 70 mm | Lateral offset of the mortise pocket from the beam centerline. |\n| dMortiseWidth | Number | 64 mm | The width of the mortise pocket. |\n| dMortiseDepth | Number | 99 mm | The depth (penetration) of the mortise pocket. |\n| dMortiseHeight | Number | 70 mm | The vertical height of the mortise pocket. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side | Swaps the roles of Joist 0 and Joist 1. Use this if the cuts are applied to the wrong side of the beams. |\n| Add Post | Prompts you to select a post to add to an existing connection. Validates if the new post is perpendicular to the joists. |\n\n## Settings Files\nNone required for this script.\n\n## Tips\n- **Perpendicularity**: Ensure your joists are exactly perpendicular (90 degrees). If the post connection fails, check the angles of the selected beams.\n- **Multi-Drill Setup**: To create a vertical array of bolts, set **nNr** to greater than 1 and adjust **dDistance** to set the spacing.\n- **Modifying Geometry**: You can change drill sizes or gaps after insertion via the AutoCAD Properties Palette (Ctrl+1).\n\n## FAQ\n- **Q: Why didn't the script create holes in my post?**\n  A: The script validates the geometry. Ensure the post is perpendicular to both joists. If the beams are not perfectly square, the post logic will be skipped.\n- **Q: How do I reverse the direction of the cut?**\n  A: Select the script instance, right-click, and choose **Flip Side**.\n- **Q: Can I add the post later?**\n  A: Yes. Right-click the script instance and select **Add Post**, then click the desired beam."
      },
      "tokens_used": 6295,
      "error": null
    }
  }
}