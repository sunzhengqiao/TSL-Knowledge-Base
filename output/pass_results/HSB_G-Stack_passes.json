{
  "filename": "HSB_G-Stack.mcr",
  "status": "completed",
  "total_tokens": 22669,
  "processing_time": 233.1093213558197,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 5354,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script generates a 3D Body entity (stack) based on coordinate system inputs (_Pt0, _XW, _YW, _ZW) and uses Group().collectEntities(..., _kModelSpace) to find related instances. It contains no ShopDrawing patterns (#Type E), sd_ prefixes, or Viewport handling."
        },
        "prerequisites": {
          "requiredEntities": [],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 1641,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select a position|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "On insert if no execute key is provided or key is not found in catalog",
            "title": "Properties",
            "dataSource": "Local properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "stackLength",
            "type": "PropDouble",
            "displayName": "|Length|",
            "defaultValue": "U(7200)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "stackWidth",
            "type": "PropDouble",
            "displayName": "|Width|",
            "defaultValue": "U(2200)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "stackHeight",
            "type": "PropDouble",
            "displayName": "|Height|",
            "defaultValue": "U(2800)",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 2703,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates a 3D bounding box representing a material stack or pack, used for logistics planning and transport visualization within the CAD model.",
          "category": "Logistics/Planning",
          "typicalUseCase": "Defining the volume of timber packs to visualize loading onto trucks or calculating storage capacity."
        },
        "parameters": [
          {
            "name": "stackLength",
            "technicalDefault": "U(7200)",
            "businessMeaning": "The longitudinal dimension of the material stack (e.g., length of timber beams in the pack).",
            "validRange": "1000 - 18000 mm",
            "unit": "mm",
            "affectsOutput": "Extends the 3D Body along the X-axis, determining how much floor space the stack occupies longitudinally."
          },
          {
            "name": "stackWidth",
            "technicalDefault": "U(2200)",
            "businessMeaning": "The transverse dimension of the material stack, typically limited by truck bed width or handling equipment.",
            "validRange": "600 - 2500 mm",
            "unit": "mm",
            "affectsOutput": "Extends the 3D Body along the Y-axis, affecting intersection calculations with trucks."
          },
          {
            "name": "stackHeight",
            "technicalDefault": "U(2800)",
            "businessMeaning": "The vertical dimension of the material stack, often constrained by transport regulations or warehouse clearances.",
            "validRange": "500 - 4500 mm",
            "unit": "mm",
            "affectsOutput": "Extends the 3D Body along the Z-axis, defining the total height of the goods."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Any property (Length, Width, Height) change",
            "effect": "Regenerates the 3D bounding box and re-evaluates intersection with truck entities.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Body",
            "description": "A 3D box visualizing the physical volume of the stack.",
            "appliedTo": "Model Space (Placeholder)"
          }
        ]
      },
      "tokens_used": 4159,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Initialization",
          "Check for Execute Key presence in catalog",
          "[Conditional: Insert Phase]",
          "[Path A] If Execute Key is valid: Load properties from catalog",
          "[Path B] If Execute Key is invalid/empty: Show Properties Dialog (ShowDynamicDialog)",
          "Prompt user for origin point (getPoint)",
          "[End Insert Phase] Return from script",
          "[Calculation/Recalculation Phase]",
          "Check if debug mode active or specific property changed",
          "Reset/Initialize internal Map",
          "Retrieve existing 'Stack' Body from Map or create new Box Body based on Length, Width, Height",
          "Update Map with 'Stack' Body",
          "Visualize Entity Coordinate System (ECS) vectors",
          "Define 'Hsb_StackingParent' SubMap to expose coordinate system for child instances",
          "Collect all TslInst entities in Model Space",
          "Loop through collected entities",
          "[Conditional: Truck Interaction]",
          "Filter for valid 'HSB_G-Truck' instances",
          "Check for intersection between Stack Body and Truck Body",
          "[Path A] Intersection found: Set 'Hsb_TruckChild' SubMap (Link Stack to Truck)",
          "[Path B] No intersection: Continue searching next truck instance"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Insertion (_bOnInsert)",
            "path1": {
              "name": "Catalog Insertion",
              "steps": [
                "Detect _kExecuteKey",
                "Verify key exists in catalog",
                "Load properties (Length, Width, Height) from catalog",
                "Skip Dialog"
              ]
            },
            "path2": {
              "name": "Manual Insertion",
              "steps": [
                "Detect missing or invalid _kExecuteKey",
                "Open Properties Dialog (ShowDynamicDialog)",
                "User enters Length, Width, Height manually",
                "Confirm Dialog"
              ]
            }
          },
          {
            "condition": "Stack Body Creation",
            "path1": {
              "name": "Recalculate Existing",
              "steps": [
                "Check if 'Stack' Body exists in _Map",
                "Retrieve existing Body reference"
              ]
            },
            "path2": {
              "name": "Create New",
              "steps": [
                "Check _Map",
                "Create new Body using _Pt0, coordinate planes, and dimensions",
                "Store in _Map"
              ]
            }
          },
          {
            "condition": "Truck Intersection Detection",
            "path1": {
              "name": "Stack on Truck",
              "steps": [
                "Find 'HSB_G-Truck' entity",
                "Check geometric intersection",
                "Set SubMap 'Hsb_TruckChild' linking Stack to Truck handle",
                "Stop search loop"
              ]
            },
            "path2": {
              "name": "Stack on Ground",
              "steps": [
                "Iterate through trucks",
                "No intersection detected",
                "Do not set 'Hsb_TruckChild' SubMap"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Execute Key Validity",
            "errorMessage": "None explicitly shown, but logic defaults to manual entry if key fails",
            "recovery": "Script automatically switches to ShowDynamicDialog for manual input"
          },
          {
            "check": "Entity Collection",
            "errorMessage": "None handled explicitly",
            "recovery": "Script continues; if no truck is found or intersection fails, it defaults to unlinked stack"
          }
        ],
        "postInsertionActions": [
          {
            "action": "Resize Stack",
            "how": "OPM Properties (Length, Width, Height)",
            "effect": "Triggers recalculation, updates Body dimensions, re-evaluates intersection with trucks"
          },
          {
            "action": "Move Stack",
            "how": "Grip edit (moving the insertion point _Pt0)",
            "effect": "Body moves to new location; potentially triggers new intersection logic with nearby trucks"
          },
          {
            "action": "Relink to Truck",
            "how": "Move the Stack entity physically onto a Truck entity",
            "effect": "Recalculation detects intersection, sets 'Hsb_TruckChild' SubMap, effectively 'loading' the stack"
          }
        ]
      },
      "tokens_used": 4230,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-Stack\n\n## Overview\nThis script generates a 3D bounding box representing a material stack or pack. It is primarily used for logistics planning and transport visualization to determine how timber packs fit onto trucks or within storage areas.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be inserted in Model Space. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required entities**: None\n- **Minimum beam count**: 0\n- **Required settings files**: None\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_G-Stack.mcr` from the list.\n\n### Step 2: Configure Dimensions\n- **If inserting from a Catalog**: The script will automatically load pre-set dimensions (Length, Width, Height) if a valid Execute Key is present.\n- **If inserting manually**: A **Properties** dialog will appear. Enter the dimensions for the stack and click OK.\n\n### Step 3: Place Stack\n```\nCommand Line: |Select a position|\nAction: Click in the Model Space to set the origin point (bottom corner) of the stack.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Length | Number | 7200 mm | The longitudinal dimension of the stack (along the X-axis). |\n| Width | Number | 2200 mm | The transverse dimension of the stack (along the Y-axis). |\n| Height | Number | 2800 mm | The vertical dimension of the stack (along the Z-axis). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | No specific custom menu items are added by this script. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Linking to Trucks**: If you have a truck entity created with `HSB_G-Truck`, simply move the stack so it physically overlaps with the truck. The script will automatically detect the intersection and link the stack to the truck for visualization.\n- **Resizing**: You can adjust the stack size at any time by selecting it and changing the Length, Width, or Height values in the Properties Palette (Ctrl+1).\n- **Unit Independence**: The script uses internal unit conversion (function `U()`), so dimensions will adjust correctly regardless of your current drawing units (mm/cm/m).\n\n## FAQ\n- **Q: How do I visualize different pack sizes?**\n- **A**: Select the stack entity, open the Properties Palette, and modify the Length, Width, or Height to match your specific material pack dimensions.\n- **Q: The stack didn't attach to my truck.**\n- **A**: Ensure the stack is moved close enough to physically intersect the truck body in the 3D view. The link relies on geometric overlap."
      },
      "tokens_used": 4582,
      "error": null
    }
  }
}