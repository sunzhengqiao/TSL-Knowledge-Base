{
  "filename": "ScandiByg_MEPMasterAssignment.mcr",
  "status": "completed",
  "total_tokens": 30666,
  "processing_time": 466.1044511795044,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4570,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script operates entirely in Model Space, performing 3D geometric intersections between hsb Elements and MEP bodies. It uses _bOnInsert for entity selection and dbCreate to instantiate child TSLs on Elements. It self-erases after processing. No ShopDrawing (sd_*) functions or Viewport handling are present."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (hsbCAD Structural Entity)",
            "AecbDbConduit/Pipe/Duct (AutoCAD MEP Entity)"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing both hsbCAD Elements and Autodesk MEP objects.",
          "requiredSettings": [
            "ScandiByg_MEPSingleObject.mcr"
          ]
        }
      },
      "tokens_used": 4195,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select MEP objects",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "Select elements",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialogOnce",
            "trigger": "On Insert",
            "title": null,
            "dataSource": "PropString sMode",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sMode",
            "type": "PropString",
            "displayName": "Add Tolls to Curve Segments",
            "defaultValue": "No",
            "inputType": "dropdown",
            "options": [
              "No",
              "Yes"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5518,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the assignment of MEP (Mechanical, Electrical, Plumbing) processing scripts to timber elements by detecting intersections between Autodesk MEP objects and hsbCAD structural elements.",
          "category": "Interaction/Assignment",
          "typicalUseCase": "Used when an architectural model contains MEP services (pipes, ducts, conduits) that need to pass through timber walls or floors, requiring automated hole or cut-out generation."
        },
        "parameters": [
          {
            "name": "sMode",
            "technicalDefault": "No",
            "businessMeaning": "Determines whether the script should include MEP fittings (elbows, tees, bends) in the detection process. In TSL/MEP terminology, 'Curve Segments' often refer to these fitting objects that connect straight runs.",
            "validRange": "No, Yes",
            "unit": "Enumeration",
            "affectsOutput": "When set to 'Yes', the script filters and processes 'Fitting' type entities in addition to straight segments. This results in child scripts being assigned to junctions and bends, ensuring holes are cut for the full volume of the MEP assembly."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sMode is set to 'Yes'",
            "effect": "Modifies the internal list of valid AutoCAD object types to include 'Fitting' classes (e.g., AecbDbPipeFitting).",
            "cascade": [
              "arSValidObjectTypes"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "TslInst (Script Instance)",
            "description": "Instances of the child script 'ScandiByg_MEPSingleObject' are created and attached to the timber element.",
            "appliedTo": "hsbCAD Elements (Walls/Floors) that physically intersect with the selected MEP objects."
          }
        ]
      },
      "tokens_used": 5437,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script executed via command or insert",
          "Check if execution is part of a multi-insert cycle (insertCycleCount > 1)",
          "[Conditional] If multi-insert detected, erase current instance and terminate",
          "Display dialog to prompt user for mode ('Add Tolls to Curve Segments' - No/Yes)",
          "Prompt user to select MEP objects (PrEntity)",
          "Validate selected MEP objects against whitelist ('AecbDbPipe', 'AecbDbDuct', etc.)",
          "Prompt user to select hsbCAD Elements (PrEntity)",
          "[Conditional] If no valid entities or elements selected, script handles later logic",
          "Store selected entities and elements in script instance attributes",
          "Script recalculation triggered (or subsequent cycle)",
          "Verify stored Entity array is not empty; if empty, erase instance and terminate",
          "Verify stored Element array is not empty; if empty, erase instance and terminate",
          "Loop through each selected Element (hsbCAD Wall/Floor)",
          "Calculate Element geometry (Coordinate system, thickness, envelope)",
          "Create Body representation of the Element",
          "Retrieve existing TSL instances attached to the Element",
          "Loop through each selected MEP Entity",
          "Check if MEP Entity is actually an hsbCAD Element (Aux) and skip if true",
          "Check existing TSLs on the Element: If a TSL with matching 'Code' (Handle) exists, erase it",
          "Get properties of MEP Entity (specifically LENGTH)",
          "Generate a bounding Body for the MEP Entity (Box of size 10x10xLength or 2x2x2 default)",
          "[Conditional] Check for geometric intersection between Element Body and MEP Body",
          "If intersection found, instantiate child script 'ScandiByg_MEPSingleObject' attached to the Element",
          "Flag nErase as true",
          "After all loops, verify nErase flag or Element construction status",
          "Erase the master script instance (Self-cleanup)"
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count",
            "path1": {
              "name": "Subsequent Cycle",
              "steps": [
                "Erase current script instance",
                "Return immediately"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Show Mode Dialog",
                "Proceed with selection"
              ]
            }
          },
          {
            "condition": "Mode Selection (sMode)",
            "path1": {
              "name": "Include Fittings ('Yes')",
              "steps": [
                "Add 'Fitting' types (AecbDbPipeFitting, etc.) to valid object list",
                "Process both straight pipes and fittings"
              ]
            },
            "path2": {
              "name": "Exclude Fittings ('No')",
              "steps": [
                "Use standard object list (Conduit, Pipe, Duct, MassElem)",
                "Ignore fittings in selection processing"
              ]
            }
          },
          {
            "condition": "MEP Entity Length",
            "path1": {
              "name": "Valid Length (> 1mm)",
              "steps": [
                "Create Body with specific length (vx, vy, vz, length, 10mm width, 10mm height)"
              ]
            },
            "path2": {
              "name": "Invalid/Zero Length",
              "steps": [
                "Create default cubic Body (2mm x 2mm x 2mm)"
              ]
            }
          },
          {
            "condition": "Geometric Intersection",
            "path1": {
              "name": "Intersection Detected",
              "steps": [
                "Instantiate 'ScandiByg_MEPSingleObject' on the Element",
                "Pass Element and MEP Entity handles to child script",
                "Set nErase flag to true"
              ]
            },
            "path2": {
              "name": "No Intersection",
              "steps": [
                "Skip instantiation for this specific pair",
                "Continue to next Entity"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion Cycle",
            "errorMessage": "None (Silent)",
            "recovery": "Script automatically erases itself to prevent duplicate execution in multi-insert loops."
          },
          {
            "check": "MEP Object Type",
            "errorMessage": "None (Silent)",
            "recovery": "Selected entities are filtered against 'arSValidObjectTypes'. Invalid types are ignored silently; user must ensure correct selection."
          },
          {
            "check": "Stored Entities and Elements",
            "errorMessage": "None (Silent)",
            "recovery": "If either array is empty upon recalculation, the script self-erases. User must run the command again and provide selections."
          },
          {
            "check": "Element Envelope Area",
            "errorMessage": "None (Silent)",
            "recovery": "If an Element has a calculated envelope area of 0, it is skipped in the loop."
          },
          {
            "check": "Existing Child Instances",
            "errorMessage": "None (Silent)",
            "recovery": "The script automatically erases existing 'ScandiByg_MEPSingleObject' instances on the Element if they match the MEP Entity handle, preventing duplicates."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Script Self-Erasure",
            "how": "Automatic Execution",
            "effect": "The Master script instance removes itself from the drawing immediately after processing, leaving only the generated child scripts ('ScandiByg_MEPSingleObject') attached to the elements."
          },
          {
            "action": "Edit Parameters (Not Applicable)",
            "how": "N/A",
            "effect": "Because the script self-erases immediately, there is no persistent instance to edit via OPM or properties palette after insertion."
          }
        ]
      },
      "tokens_used": 5568,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# ScandiByg_MEPMasterAssignment.mcr\n\n## Overview\nThis script automates the assignment of MEP (Mechanical, Electrical, and Plumbing) processing to timber elements. It detects intersections between AutoCAD MEP objects (pipes, ducts, conduits) and hsbCAD structural elements, automatically generating the necessary child scripts to create holes or cut-outs.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Required. The script calculates 3D intersections between MEP entities and timber elements. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | Not supported. |\n\n## Prerequisites\n- **Required Entities**: \n  - hsbCAD Elements (Walls or Floors).\n  - AutoCAD MEP Entities (Conduits, Pipes, Ducts).\n- **Minimum Beam Count**: 0 (This script interacts with existing elements).\n- **Required Settings/Dependencies**: \n  - The child script `ScandiByg_MEPSingleObject.mcr` must be installed and accessible in the TSL search path.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` (or select from tool palette) â†’ Select `ScandiByg_MEPMasterAssignment.mcr`.\n\n### Step 2: Configure Processing Mode\n```\nDialog: \"Add Tolls to Curve Segments\"\nAction: Select \"No\" to process straight runs only, or \"Yes\" to include fittings (elbows, tees, bends). Click OK.\n```\n\n### Step 3: Select MEP Objects\n```\nCommand Line: \"Select MEP objects\"\nAction: Select the pipes, ducts, or conduits that pass through the timber structure. Press Enter when finished.\n```\n\n### Step 4: Select Timber Elements\n```\nCommand Line: \"Select elements\"\nAction: Select the hsbCAD Walls or Floors that the selected MEP objects intersect with. Press Enter to confirm.\n```\n\n### Step 5: Automatic Processing\nThe script will automatically calculate intersections, attach specific processing scripts to the timber elements, and then erase itself. The result is visible on the timber elements as new script instances.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Add Tolls to Curve Segments | dropdown | No | Determines if MEP fittings (elbows, tees) are included. \"Yes\" processes fittings; \"No\" processes only straight segments. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | The script runs once upon insertion and self-erases; there are no persistent right-click options. |\n\n## Settings Files\n- **Filename**: `ScandiByg_MEPSingleObject.mcr` (Dependency)\n- **Location**: TSL Search Path\n- **Purpose**: This is the child script instantiated by the master script. It contains the logic to actually generate the geometry for the holes or cut-outs on the specific element.\n\n## Tips\n- **Batch Processing**: You can select multiple MEP objects and multiple timber elements in a single window selection to speed up the workflow.\n- **Re-running the Script**: If you run the script again on the same elements, it will automatically detect and erase old instances of the child script before creating new ones, preventing duplicates.\n- **Complex Junctions**: If your MEP model contains many elbows and tees, set \"Add Tolls to Curve Segments\" to **Yes**. This ensures that the volume of the fittings is also calculated for the cut-out.\n\n## FAQ\n- **Q: Why did the script disappear immediately after I ran it?**\n  - A: This is normal behavior. The \"Master\" script is designed to assign the specific \"Single Object\" scripts to your walls and floors and then clean itself up. You do not need the master script to remain in the drawing.\n  \n- **Q: What happens if I select an object that isn't a pipe or duct?**\n  - A: The script filters the selection list. If an object is not a recognized MEP type (e.g., a generic line or text), it will be ignored silently.\n\n- **Q: Can I edit the parameters after insertion?**\n  - A: No, because the script instance erases itself immediately after processing. To change settings, simply run the script again."
      },
      "tokens_used": 5378,
      "error": null
    }
  }
}