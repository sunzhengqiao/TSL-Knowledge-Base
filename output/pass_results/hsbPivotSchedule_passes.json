{
  "filename": "hsbPivotSchedule.mcr",
  "status": "completed",
  "total_tokens": 51235,
  "processing_time": 181.4171860218048,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": null,\n    \"keywords\": null,\n    \"majorVersion\": 2,\n    \"minorVersion\": 8,\n    \"dxaOut\": null,\n    \"implInsert\": null\n  },\n  \"description\": \"\",\n"
      },
      "tokens_used": 9192,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "Both",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly checks for viewports using '_Viewport.length() > 0'. History comments indicate support for 'ACA and hsbcad viewports'. Properties include types like 'Sheet', 'Element', and 'Shopdrawing' for filtering. Code handles rendering in paper space context and resolves stacking items in model space."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element",
            "Sheet",
            "Panel",
            "Wall",
            "Truss",
            "TslInstance",
            "Tool Entity"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space (3D) or Paper Space (Layouts/Sheets)",
          "requiredSettings": []
        }
      },
      "tokens_used": 5658,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sConfiguration",
            "type": "PropString",
            "displayName": "|Configuration|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "General",
            "description": "|Defines the name of a configuration|"
          },
          {
            "index": 1,
            "variable": "sTypeProp",
            "type": "PropString",
            "displayName": "|Type|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|Masterpanel|",
              "|Stacking|",
              "|Truss|",
              "|Wall Stickframe|",
              "|Wall CLT|",
              "|Element Roof/Floor|",
              "|Element|",
              "|Shopdrawing|",
              "|Beam|",
              "|Sheet|",
              "|Panel|",
              "|GenBeam|",
              "|TslInstance|",
              "|Tool Entity|"
            ],
            "category": "General",
            "description": "|Defines the Type|"
          },
          {
            "index": 2,
            "variable": "sModeProp",
            "type": "PropString",
            "displayName": "|Mode|",
            "defaultValue": null,
            "inputType": "dropdown",
            "options": [
              "|for each Instance|",
              "|as Collection|"
            ],
            "category": "General",
            "description": "|Defines the Mode|"
          },
          {
            "index": 3,
            "variable": "sPainterProp",
            "type": "PropString",
            "displayName": "|Painter|",
            "defaultValue": "|<Disabled>|",
            "inputType": "dropdown",
            "options": [],
            "category": "General",
            "description": "|Defines the Painter|"
          },
          {
            "index": 4,
            "variable": "sHeaderFormatProp",
            "type": "PropString",
            "displayName": "|Header|",
            "defaultValue": "@(ProjectName)",
            "inputType": "text",
            "options": [],
            "category": "Formats",
            "description": "|Defines the header of the schedule table||Format variables like @(ProjectName) are supported.|"
          },
          {
            "index": 5,
            "variable": "sGroupFormatProp",
            "type": "PropString",
            "displayName": "|Group|",
            "defaultValue": "@(ProjectName)",
            "inputType": "text",
            "options": [],
            "category": "Formats",
            "description": "|Defines the group format of the description|"
          },
          {
            "index": 6,
            "variable": "sFormatProp",
            "type": "PropString",
            "displayName": "|Value|",
            "defaultValue": "@(PosNum)",
            "inputType": "text",
            "options": [],
            "category": "Formats",
            "description": "|Defines the format of the data grid|"
          },
          {
            "index": 7,
            "variable": "sTotalFormatProp",
            "type": "PropString",
            "displayName": "|Totals|",
            "defaultValue": "@(Quantity)",
            "inputType": "text",
            "options": [],
            "category": "Formats",
            "description": "|Defines the format of the totals|"
          },
          {
            "index": 0,
            "variable": "nMaxNumColumnProp",
            "type": "PropInt",
            "displayName": "|Columns|",
            "defaultValue": 5,
            "inputType": "number",
            "options": [],
            "category": "Display",
            "description": "|Defines the maximal allowed amount of columns| |0 = no limit|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Add/Remove Format Header|",
            "handler": "|Add/Remove Format Header|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add/Remove Format Group|",
            "handler": "|Add/Remove Format Group|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add/Remove Format Value|",
            "handler": "|Add/Remove Format Value|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add/Remove Format Total|",
            "handler": "|Add/Remove Format Total|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Add Entities|",
            "handler": "|Add Entities|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Remove Entities|",
            "handler": "|Remove Entities|",
            "action": "Select schedule table",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8155,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates flexible schedule tables (BOMs or lists) that aggregate and display data for timber construction entities like beams, walls, or panels, with support for grouping and totals.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used to create production lists, material take-offs, or summary tables on drawing layouts or in model space to quantify and document building components."
        },
        "parameters": [
          {
            "name": "sConfiguration",
            "technicalDefault": "",
            "businessMeaning": "Name of a saved configuration preset, allowing users to quickly switch between different table setups (e.g., 'Delivery Note', 'Production List').",
            "validRange": "Any text string representing a valid configuration name",
            "unit": "Text",
            "affectsOutput": "Loads a specific set of properties; controls the script's initialization state but not the geometry directly."
          },
          {
            "name": "sTypeProp",
            "technicalDefault": null,
            "businessMeaning": "Filters the specific category of construction elements to include in the schedule (e.g., only Wall CLT panels, or all Beams).",
            "validRange": "Masterpanel, Stacking, Truss, Wall Stickframe, Wall CLT, Element Roof/Floor, Element, Shopdrawing, Beam, Sheet, Panel, GenBeam, TslInstance, Tool Entity",
            "unit": "Enumeration",
            "affectsOutput": "Determines the entity set queried from the drawing; if the type doesn't match existing elements, the table may be empty."
          },
          {
            "name": "sModeProp",
            "technicalDefault": null,
            "businessMeaning": "Controls whether the schedule lists every individual entity separately or groups them by shared properties (e.g., Position Number).",
            "validRange": "for each Instance, as Collection",
            "unit": "Enumeration",
            "affectsOutput": "In 'Collection' mode, quantities are aggregated into single rows. In 'Instance' mode, every entity gets its own row."
          },
          {
            "name": "sPainterProp",
            "technicalDefault": "|<Disabled>|",
            "businessMeaning": "Applies a custom filter (Painter) to select entities based on specific criteria defined in the Painter catalog, offering more granular control than the basic Type filter.",
            "validRange": "List of available Painter definitions from the catalog",
            "unit": "Enumeration",
            "affectsOutput": "Filters the input entities; only those passing the Painter's logic are included in the schedule calculation."
          },
          {
            "name": "sHeaderFormatProp",
            "technicalDefault": "@(ProjectName)",
            "businessMeaning": "Defines the text displayed as the main title of the schedule table.",
            "validRange": "Text string supporting variables like @(ProjectName), @(Date), @(UserName)",
            "unit": "Text",
            "affectsOutput": "Updates the top text line of the generated table."
          },
          {
            "name": "sGroupFormatProp",
            "technicalDefault": "@(ProjectName)",
            "businessMeaning": "Defines the property used to group items in the table (e.g., group all items by 'Floor' or 'Phase').",
            "validRange": "Text string supporting variables like @(PosNum), @(Material), @(Elevation)",
            "unit": "Text",
            "affectsOutput": "Changes the sorting and hierarchical structure of the rows in the table."
          },
          {
            "name": "sFormatProp",
            "technicalDefault": "@(PosNum)",
            "businessMeaning": "Defines the actual data displayed in the grid cells for each item (e.g., the Mark Number, Dimensions, or Length).",
            "validRange": "Text string supporting variables like @(Length), @(Width), @(Height), @(PosNum)",
            "unit": "Text",
            "affectsOutput": "Populates the main content area of the schedule table."
          },
          {
            "name": "sTotalFormatProp",
            "technicalDefault": "@(Quantity)",
            "businessMeaning": "Defines the calculation for the summary line, typically aggregating quantities, volumes, or weights per group.",
            "validRange": "Text string supporting variables like @(Quantity), @(Volume), @(Area), @(Weight)",
            "unit": "Text",
            "affectsOutput": "Updates the totals column or footer summary; may trigger heavy calculations if Weight or Volume are used."
          },
          {
            "name": "nMaxNumColumnProp",
            "technicalDefault": 5,
            "businessMeaning": "Limits the width of the table by setting the maximum number of data columns before the list wraps to a new column or row.",
            "validRange": "0 (no limit) to typical layout widths (e.g., 5-20)",
            "unit": "Count",
            "affectsOutput": "Controls the graphical layout and width of the table; helps fitting the table onto paper space sheets."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sModeProp is set to 'as Collection'",
            "effect": "The script aggregates data. If sGroupFormatProp is not defined effectively, all items might be grouped into a single large block.",
            "cascade": [
              "sGroupFormatProp",
              "sTotalFormatProp"
            ]
          },
          {
            "trigger": "sTypeProp is set to 'Shopdrawing'",
            "effect": "The script attempts to resolve stacking items and parents specifically for shop drawings.",
            "cascade": []
          },
          {
            "trigger": "sTotalFormatProp includes '@(Weight)' or '@(Volume)'",
            "effect": "The script calls external calculations (e.g., hsbCenterOfGravity) which may increase processing time for large selections.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Text",
            "description": "The schedule content including Header, Group labels, Item values, and Totals.",
            "appliedTo": "Model Space or Paper Space (Layouts)"
          },
          {
            "type": "PLine (Polyline)",
            "description": "Grid lines and border rectangles that form the visual structure of the table.",
            "appliedTo": "Model Space or Paper Space (Layouts)"
          }
        ]
      },
      "tokens_used": 9295,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script Launch",
          "Check DialogMode variable in MapObject",
          "[Conditional] Branch: DialogMode == 1 (Configuration Mode) or 0 (Standard Mode)",
          "Load and Initialize OPM Properties (Type, Mode, Painter, Formats, Display Settings)",
          "Apply Translation Filters to Format Strings (if pipes | | are found)",
          "Collect Entities from Drawing based on Type (Beam, Sheet, Element, etc.) and Viewport context",
          "Filter Entities using Painter definition (if Painter is not Disabled)",
          "Process Entity Data: Calculate Group keys and Sort values",
          "[Conditional] Branch: Calculate Totals (Weight/Volume) based on Format requirements",
          "Determine Grid Geometry: Calculate column widths and row heights",
          "[Conditional] Branch: Apply Column Wrapping based on Max Column setting",
          "Draw Schedule Table: Render Header, Groups, Values, and Grid Lines",
          "Final Validation: Check if valid data was collected and drawn"
        ],
        "conditionalBranches": [
          {
            "condition": "DialogMode equals 1",
            "path1": {
              "name": "Configuration Dialog Path",
              "steps": [
                "Set OPM Key to 'SaveConfiguration'",
                "Display only Configuration Name property",
                "Return immediately (Skip execution)"
              ]
            },
            "path2": {
              "name": "Standard Execution Path",
              "steps": [
                "Initialize all TSL properties (Type, Mode, Formats, etc.)",
                "Proceed to entity collection and drawing"
              ]
            }
          },
          {
            "condition": "Entity Type is 'Sheet' during Total calculation",
            "path1": {
              "name": "Sheet Area Path",
              "steps": [
                "Calculate Area using sheet.plEnvelope().area()",
                "Multiply by unit conversion factor (10e-6)"
              ]
            },
            "path2": {
              "name": "Generic Entity Path",
              "steps": [
                "Calculate Area using ent.formatObject('@(Area)')"
              ]
            }
          },
          {
            "condition": "Total Format string contains '@(Weight)'",
            "path1": {
              "name": "Weight Calculation Path",
              "steps": [
                "Create Map with Entity data",
                "Call external script 'hsbCenterOfGravity' via TslInst().callMapIO",
                "Retrieve Weight from result map",
                "Add to total weight accumulator"
              ]
            },
            "path2": {
              "name": "Skip Weight Calculation",
              "steps": [
                "Proceed without calculating weight",
                "Weight value remains 0"
              ]
            }
          },
          {
            "condition": "Max Columns property (nMaxNumColumn) is greater than 0",
            "path1": {
              "name": "Restricted Column Layout",
              "steps": [
                "Limit number of columns to nMaxNumColumn",
                "Wrap data to new row/column segment when limit is reached"
              ]
            },
            "path2": {
              "name": "Unlimited Column Layout",
              "steps": [
                "Allow data to extend horizontally indefinitely",
                "nNumColumn defaults to total number of cells"
              ]
            }
          },
          {
            "condition": "Validation check fails (bHasValue is false / No data collected)",
            "path1": {
              "name": "Viewport/Shopdrawing Context",
              "steps": [
                "Detect Viewport or SDV context",
                "Return silently (no error message, no geometry drawn)"
              ]
            },
            "path2": {
              "name": "Model Space Context",
              "steps": [
                "Report Error Message: 'Could not collect any values.'",
                "Erase the Script Instance (if not in Debug mode)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Collection Success",
            "errorMessage": "|Could not collect any values.|",
            "recovery": "Verify that 'Type' matches existing entities, 'Painter' logic is valid, and entities exist in the active viewport or selection set."
          },
          {
            "check": "Format String Validity",
            "errorMessage": "Implicit failure (Blank values)",
            "recovery": "Ensure format variables (e.g., @(PosNum)) exist on the selected entities. Invalid variables usually result in empty strings rather than crashes."
          },
          {
            "check": "Element Validity",
            "errorMessage": "Script exits silently or skips invalid entities",
            "recovery": "Ensure source entities are valid and not corrupted in the drawing database."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add/Remove Format Header",
            "how": "Right-click Context Menu -> Recalc with Key",
            "effect": "Prompts user to modify the sHeaderFormatProp string directly via a specialized dialog or input."
          },
          {
            "action": "Add/Remove Format Group/Value/Total",
            "how": "Right-click Context Menu -> Recalc with Key",
            "effect": "Updates the format strings (sGroupFormatProp, sFormatProp, sTotalFormatProp) used to generate the table content."
          },
          {
            "action": "Add/Remove Entities",
            "how": "Right-click Context Menu -> Recalc with Key",
            "effect": "Prompts user to select new entities to include in the existing schedule instance."
          },
          {
            "action": "Modify Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Updates Type, Mode, Painter, Column count, or Text formats immediately upon recalculation."
          }
        ]
      },
      "tokens_used": 11501,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbPivotSchedule\n\n## Overview\nGenerates flexible schedule tables (BOMs or lists) that aggregate and display data for timber construction entities like beams, walls, or panels, with support for grouping, totals, and custom formatting.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Lists entities based on model content or selection sets. |\n| Paper Space | Yes | Supports ACA and hsbCAD viewports to list elements visible in specific views. |\n| Shop Drawing | No | Can list Shopdrawing entities, but is not a generation script itself. |\n\n## Prerequisites\n- **Required Entities:** GenBeams, Elements, Sheets, Panels, Walls, Trusses, TslInstances, or Tool Entities must exist in the drawing.\n- **Minimum Count:** 0 (The table may be empty if no entities match the filter).\n- **Required Settings:** None (uses standard hsbCAD properties).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT`\nAction: Select `hsbPivotSchedule.mcr` from the list and click OK.\n\n### Step 2: Place Schedule\nAction: Click a location in your drawing (Model Space or on a Layout) to place the schedule table.\n\n### Step 3: Configure Content\nAction: With the schedule selected, open the **Properties Palette (Ctrl+1)**. Adjust the **Type**, **Mode**, and **Format** properties to define what data is shown.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Configuration | Text | - | Name of a saved configuration preset to quickly switch table setups. |\n| Type | Dropdown | - | Filters the category of elements to list (e.g., Wall CLT, Masterpanel, Beam, Sheet, Element, Shopdrawing). |\n| Mode | Dropdown | - | Choose \"for each Instance\" to list every item separately, or \"as Collection\" to group identical items together. |\n| Painter | Dropdown | <Disabled> | Apply a specific filter (Painter) from the catalog to select entities based on custom criteria. |\n| Header | Text | @(ProjectName) | The title text displayed at the top of the table. Supports variables like `@(Date)`. |\n| Group | Text | @(ProjectName) | The property used to group rows in the table (e.g., `@(PosNum)`, `@(Material)`). |\n| Value | Text | @(PosNum) | The data displayed in the grid cells (e.g., `@(Length)`, `@(Width)`, `@(Volume)`). |\n| Totals | Text | @(Quantity) | The calculation for the summary line (e.g., `@(Quantity)`, `@(Weight)`). |\n| Columns | Number | 5 | Sets the maximum number of columns before the list wraps to the next row. Set to 0 for no limit. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add/Remove Format Header | Opens a dialog to quickly modify the Header text format. |\n| Add/Remove Format Group | Opens a dialog to modify the Grouping property. |\n| Add/Remove Format Value | Opens a dialog to modify the main grid data format. |\n| Add/Remove Format Total | Opens a dialog to modify the Totals calculation format. |\n| Add Entities | Prompts you to select additional entities from the drawing to include in the existing schedule. |\n| Remove Entities | Prompts you to select entities currently in the schedule to remove them. |\n\n## Settings Files\n- **Filename:** None specific.\n- **Location:** N/A\n- **Purpose:** This script relies on the standard hsbCAD database and does not require external XML settings files for basic operation.\n\n## Tips\n- **Use Variables:** Use the `@()` syntax to pull dynamic data. For example, use `@(Length)` to display beam lengths or `@(Material)` for material names.\n- **Formatting Collection Mode:** When using \"as Collection\" for the Mode, ensure your \"Group\" and \"Value\" fields are set correctly so items aggregate as expected (e.g., Group by `@(PosNum)` to count total pieces per position).\n- **Performance:** Calculating `@(Weight)` or `@(Volume)` for large projects can take time. Use these only when necessary.\n- **Layout Control:** If your table is too wide for your sheet, lower the \"Columns\" property to force the table to wrap into multiple vertical sections.\n\n## FAQ\n- **Q: Why is my schedule table empty?**\n  **A:** Check the **Type** property to ensure it matches the entities in your model (e.g., if you selected \"Wall CLT\" but only have \"Beams\", the table will be empty). Also verify the **Painter** is not set to a filter that excludes everything.\n- **Q: How do I show multiple data columns (e.g., Length and Width)?**\n  **A:** In the **Value** property, you can combine variables with text. For example: `@(Length) x @(Width)`.\n- **Q: What does the \"0 = no limit\" mean for Columns?**\n  **A:** It allows the table to grow indefinitely to the right. This is useful for model space but usually requires a manual limit (e.g., 5 or 10) to fit within a title block on Paper Space."
      },
      "tokens_used": 7434,
      "error": null
    }
  }
}