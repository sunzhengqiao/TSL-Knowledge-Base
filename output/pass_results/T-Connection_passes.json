{
  "filename": "T-Connection.mcr",
  "status": "completed",
  "total_tokens": 55267,
  "processing_time": 814.4111368656158,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.5",
            "date": "30.08.2023",
            "author": "Marsel Nakuci",
            "changes": "HSB-19830: Make hasTConnection test only if male axis intersects female beam"
          },
          {
            "version": "1.4",
            "date": "15.05.2023",
            "author": "Thorsten Huck",
            "changes": "HSB-18973 property value renamed, debug improved"
          },
          {
            "version": "1.3",
            "date": "12.05.2023",
            "author": "Marsel Nakuci",
            "changes": "HSB-18801: Enter wait state if no element beam found (beams without panhand state)"
          },
          {
            "version": "1.2",
            "date": "18.04.2023",
            "author": "Marsel Nakuci",
            "changes": "HSB-18551: Support copying of beam with TSL instance"
          },
          {
            "version": "1.1",
            "date": "21.02.2023",
            "author": "Marsel Nakuci",
            "changes": "HSB-18059: use quader to get the envelope of female beam"
          },
          {
            "version": "1.0",
            "date": "22.12.2022",
            "author": "Marsel Nakuci",
            "changes": "HSB-17255: Initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 9156,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit usage of _kModelSpace in tslNew.dbCreate(). The script utilizes 3D geometric entities (Body, PlaneProfile, Vector3d) and applies tools (BeamCut, Cut) to GenBeams. It selects Elements and Beams in the 3D model and does not contain ShopDrawing specific API calls (sd_*) or logic."
        },
        "prerequisites": {
          "requiredEntities": [
            "GenBeam",
            "Element"
          ],
          "minimumBeams": 2,
          "requiredSpace": "3D Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7480,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getGenBeam",
              "promptOriginal": "T(\"|Select male beam(s) or element(s)|\")",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getGenBeam",
              "promptOriginal": "T(\"|Select female beams|\")",
              "condition": "!bElementMode",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "Standard Properties Dialog",
            "trigger": "Insertion or MapIO",
            "title": null,
            "dataSource": "Script Properties (PropDouble, PropString, etc.)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sPainterMaleStream",
            "type": "PropString",
            "displayName": "T(\"|PainterMaleStream|\")",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "T(\"|General|\")",
            "description": "T(\"|Defines the PainterMaleStream|\")"
          },
          {
            "index": 1,
            "variable": "sPainterFemaleStream",
            "type": "PropString",
            "displayName": "T(\"|PainterFemaleStream|\")",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "T(\"|General|\")",
            "description": "T(\"|Defines the PainterFemaleStream|\")"
          },
          {
            "index": 2,
            "variable": "sPainterMale",
            "type": "PropString",
            "displayName": "T(\"|Male beams|\")",
            "defaultValue": "T(\"<|Disabled|>\")",
            "inputType": "dropdown",
            "options": "sPainters (Dynamic)",
            "category": "T(\"|Painter|\")",
            "description": "T(\"|Defines the PainterMale|\")"
          },
          {
            "index": 3,
            "variable": "sPainterFemale",
            "type": "PropString",
            "displayName": "T(\"|Female beams|\")",
            "defaultValue": "T(\"<|Disabled|>\")",
            "inputType": "dropdown",
            "options": "sPainters (Dynamic)",
            "category": "T(\"|Painter|\")",
            "description": "T(\"|Defines the PainterFemale|\")"
          },
          {
            "index": 0,
            "variable": "dDistance",
            "type": "PropDouble",
            "displayName": "T(\"|Depth|\") + \"/\" + T(\"|Distance|\")",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "T(\"|Painter|\")",
            "description": "T(\"|Defines the Distance|\")"
          },
          {
            "index": 1,
            "variable": "dGap",
            "type": "PropDouble",
            "displayName": "T(\"|Side Gap|\")",
            "defaultValue": "U(0)",
            "inputType": "number",
            "options": [],
            "category": "T(\"|Painter|\")",
            "description": "T(\"|Defines the Gap|\")"
          },
          {
            "index": 4,
            "variable": "sToolAlignment",
            "type": "PropString",
            "displayName": "T(\"|Tool Alignment|\")",
            "defaultValue": "T(\"|Female beam|\")",
            "inputType": "dropdown",
            "options": [
              "T(\"|Female beam|\")",
              "T(\"|Male beam|\")"
            ],
            "category": "T(\"|Painter|\")",
            "description": "T(\"|Defines if the tool aligns with the coordinate systems of the female or male beam|\")"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "T(\"|Reset + Erase|\")",
            "handler": "T(\"|Reset + Erase|\")",
            "action": "Applies a cut to the beam and erases the TSL instance",
            "alsoTriggeredBy": "TslDoubleClick"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 9792,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the creation of T-connections between timber beams by calculating intersections and applying precise cuts or pockets.",
          "category": "Framing/Machining",
          "typicalUseCase": "Joining a cross beam (male) into a main beam (female), such as a stud into a plate or a purlin into a rafter, allowing for specific clearances and depth control."
        },
        "parameters": [
          {
            "name": "sPainterMaleStream",
            "technicalDefault": "''",
            "businessMeaning": "Internal storage for the configuration of the contour profile (Painter) assigned to the male beam. Typically hidden from the user and managed via catalogs.",
            "validRange": "N/A (System String)",
            "unit": "text",
            "affectsOutput": "Defines the machining contour and filter rules for the male beam geometry."
          },
          {
            "name": "sPainterFemaleStream",
            "technicalDefault": "''",
            "businessMeaning": "Internal storage for the configuration of the contour profile (Painter) assigned to the female beam. Typically hidden from the user and managed via catalogs.",
            "validRange": "N/A (System String)",
            "unit": "text",
            "affectsOutput": "Defines the machining contour and filter rules for the female beam geometry."
          },
          {
            "name": "sPainterMale",
            "technicalDefault": "T(\"<|Disabled|>\")",
            "businessMeaning": "Selects a predefined machining profile or contour to apply to the male beam. It can also act as a filter to select only specific types of beams.",
            "validRange": "List of available Painter definitions in the catalog",
            "unit": "selection",
            "affectsOutput": "Filters which male beams are processed and applies specific geometric machining to them."
          },
          {
            "name": "sPainterFemale",
            "technicalDefault": "T(\"<|Disabled|>\")",
            "businessMeaning": "Selects a predefined machining profile or contour to apply to the female beam.",
            "validRange": "List of available Painter definitions in the catalog",
            "unit": "selection",
            "affectsOutput": "Filters which female beams are processed and defines the shape of the cut/pocket."
          },
          {
            "name": "dDistance",
            "technicalDefault": "U(0)",
            "businessMeaning": "Defines the depth of the connection cut or the penetration distance of the male beam into the female beam (along the tool's Z-axis).",
            "validRange": "0mm to full depth of the female beam",
            "unit": "mm",
            "affectsOutput": "Determines how far the cutting tool extends into the female beam to create the pocket or through-cut."
          },
          {
            "name": "dGap",
            "technicalDefault": "U(0)",
            "businessMeaning": "Specifies a clearance allowance around the cut profile to ensure easy assembly or account for material tolerances.",
            "validRange": "0mm to 10mm (Typically 1-5mm)",
            "unit": "mm",
            "affectsOutput": "Expands the size of the cut on the female beam, creating a looser fit for the male beam."
          },
          {
            "name": "sToolAlignment",
            "technicalDefault": "T(\"|Female beam|\")",
            "businessMeaning": "Determines the reference geometry used to calculate the width of the cut. 'Female beam' aligns the cut width with the female beam's dimensions (standard), while 'Male beam' aligns it with the male beam's profile (custom slot).",
            "validRange": "Female beam, Male beam",
            "unit": "selection",
            "affectsOutput": "Switches the cut width between the full width of the female beam or the width of the intersecting male beam."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Selection of sPainterMale or sPainterFemale",
            "effect": "Filters the entities selected in the model during insertion or recalculation.",
            "cascade": [
              "entMales",
              "entFemales"
            ]
          },
          {
            "trigger": "Calculation of Cut Geometry",
            "effect": "The dGap parameter modifies the profile (ppTool) before generating the BeamCut.",
            "cascade": [
              "dX",
              "dY",
              "BeamCut dimensions"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "BeamCut",
            "description": "A pocket or through-cut on the female beam to accommodate the male beam. The size is calculated based on the intersection profile, adjusted by the Side Gap and Tool Alignment.",
            "appliedTo": "Female beams"
          },
          {
            "type": "Cut (Conditional)",
            "description": "A clearance cut on the male beam (bm0) to prevent interference with the female beam's sides, added only if the male beam profile extends beyond the cut area.",
            "appliedTo": "Male beam (Primary beam)"
          }
        ]
      },
      "tokens_used": 9984,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch (Insert)",
          "2. Load Properties from Catalog (if key provided) or Show Properties Dialog",
          "3. Prompt User: Select Male Beam(s) or Element(s)",
          "4. Check Selection Type (Beam Mode vs Element Mode)",
          "5. [Element Mode] Loop: Create TSL Instance for each selected Element -> Erase Starter Instance",
          "6. [Beam Mode] Prompt User: Select Female Beams",
          "7. [Beam Mode] Filter selected entities based on 'sPainterMale' and 'sPainterFemale' settings",
          "8. [Beam Mode] Create single TSL Instance linking Male and Female beams -> Erase Starter Instance",
          "9. Instance Initialization: Read Map Data (Beam arrays)",
          "10. Calculation Phase: Validate Geometric Intersections",
          "11. Calculation Phase: Determine Cut Dimensions based on 'dDistance', 'dGap', and 'sToolAlignment'",
          "12. Apply Tools: Add 'CutStretch' to Male Beam",
          "13. Apply Tools: Create 'BeamCut' for Female Beams (check boundaries -> stretch if necessary)",
          "14. Apply Tools: Conditionally add secondary cut to Male Beam",
          "15. Visualization: Draw debug/display lines",
          "16. Wait State: Monitor OPM changes or Context Menu triggers"
        ],
        "conditionalBranches": [
          {
            "condition": "Type of entity selected in the first prompt",
            "path1": {
              "name": "Element Mode",
              "steps": [
                "Skips the female beam selection prompt",
                "Iterates through every Element selected in step 3",
                "Generates a unique TSL instance attached to each Element",
                "The TSL instances process the internal beams of those Elements"
              ]
            },
            "path2": {
              "name": "Beam Mode",
              "steps": [
                "Prompts user to select female beams",
                "Filters both male and female selections against Painter definitions (if active)",
                "Creates a single TSL instance containing arrays of male and female beams"
              ]
            }
          },
          {
            "condition": "Tool Alignment setting ('sToolAlignment')",
            "path1": {
              "name": "Female Beam (Default)",
              "steps": [
                "Calculates cut width (dX) based on the female beam's dimensions",
                "Ensures the cut spans the full width of the female beam"
              ]
            },
            "path2": {
              "name": "Male Beam",
              "steps": [
                "Calculates cut width (dX) and depth (dY) based on the intersecting male beam's profile",
                "Creates a pocket sized specifically to the male beam"
              ]
            }
          },
          {
            "condition": "Cut Boundary Check vs Female Beam Profile",
            "path1": {
              "name": "Cut Inside Profile",
              "steps": [
                "Proceeds with standard calculated dimensions (dX, dY)"
              ]
            },
            "path2": {
              "name": "Cut Outside Profile",
              "steps": [
                "Detects if the cut corners fall outside the female beam's cross-section",
                "Stretches the BeamCut dimensions in the Y-direction (add U(40)) to ensure full validity"
              ]
            }
          },
          {
            "condition": "Secondary Male Cut Intersection",
            "path1": {
              "name": "Intersection Detected",
              "steps": [
                "Shrinks the theoretical male cut profile",
                "Checks against actual male beam envelope",
                "Applies the cut to the male beam ('bm0.addTool')"
              ]
            },
            "path2": {
              "name": "No Intersection",
              "steps": [
                "Skips applying the secondary cut to the male beam (prevents unnecessary machining)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Intersection of Male Beam Axis and Stretch Plane",
            "errorMessage": "<ScriptName> |Unexpected|",
            "recovery": "Script erases itself. User must check alignment of male and female beams or the 'Distance' parameter to ensure a valid intersection exists."
          },
          {
            "check": "Intersection of Male Beam Corners and Stretch Plane",
            "errorMessage": "<ScriptName> |Unexpected|",
            "recovery": "Script erases itself. User must ensure the male beam physically touches or crosses the cutting plane defined by the distance."
          },
          {
            "check": "Minimum Dimension Threshold (dEps)",
            "errorMessage": "None (Silent Skip)",
            "recovery": "If calculated cut dimensions (dX, dY, dZ) are too small, the tooling is skipped entirely to prevent invalid geometry generation."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Connection Parameters",
            "how": "Object Properties Palette (OPM)",
            "effect": "Updating 'Distance', 'Side Gap', or 'Painter' properties triggers a recalculation, resizing the pockets or changing filtered beams immediately."
          },
          {
            "action": "Delete Connection (Reset)",
            "how": "Right-click Context Menu -> 'Reset + Erase' or Double-Click",
            "effect": "Applies a static cut to clean the male beam geometry and then deletes the TSL instance, removing the T-Connection."
          },
          {
            "action": "Geometry Update (Grip/Move)",
            "how": "Standard AutoCAD/hsbCAD Move/Rotate commands",
            "effect": "Moving the attached Male or Female beams triggers a recalculation (_bOnRecalc), and the T-Connection cuts update to match the new positions."
          }
        ]
      },
      "tokens_used": 11711,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# T-Connection.mcr\n\n## Overview\nAutomates the creation of T-connections between timber beams by calculating intersections and applying precise cuts or pockets. This script is ideal for joining cross beams (male) into main beams (female), such as studs into plates or purlins into rafters.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates in the 3D model environment. |\n| Paper Space | No | Not designed for 2D layout or detailing views. |\n| Shop Drawing | No | Does not generate shop drawing details directly. |\n\n## Prerequisites\n- **Required entities**: At least two `GenBeams` (one male, one female) or an `Element` containing beams.\n- **Minimum beam count**: 2.\n- **Required settings files**: None (Standard Painter catalogs are used).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `T-Connection.mcr` from the list.\n\n### Step 2: Select Male Beams\n```\nCommand Line: Select male beam(s) or element(s)\nAction: Click on the beam(s) that will cut into the main beam (e.g., a stud or purlin). You can also select an entire Wall/Element.\n```\n*Note: If you select an Element, the script automatically finds the connections within it and skips the next step.*\n\n### Step 3: Select Female Beams (If not in Element Mode)\n```\nCommand Line: Select female beams\nAction: Click on the main beam(s) that will receive the cut (e.g., a top plate or rafter).\n```\n\n### Step 4: Configuration\nAfter selection, the Properties Palette (OPM) will display the connection parameters. Adjust settings like Depth and Side Gap as needed. Press Enter to place the connection.\n\n### Step 5: Verification\nThe script calculates the intersection. If the beams align correctly, a cut/pocket is applied. If the geometry is invalid, the script instance may erase itself automatically.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Male beams** | dropdown | Disabled | Selects a predefined profile (Painter) to apply to the male beams. Acts as a filter to select specific beams or apply specific machining. |\n| **Female beams** | dropdown | Disabled | Selects a predefined profile (Painter) to apply to the female beams. Defines the shape of the cut/pocket. |\n| **Depth / Distance** | number | 0 | Defines how deep the male beam penetrates into the female beam (or the depth of the pocket). |\n| **Side Gap** | number | 0 | Adds a clearance allowance around the cut profile (e.g., 2mm) for easier assembly or tolerances. |\n| **Tool Alignment** | dropdown | Female beam | Determines the reference for the cut width. \"Female beam\" cuts the full width of the main beam; \"Male beam\" creates a slot sized exactly to the cross beam. |\n| **PainterMaleStream** | text | (Empty) | Internal storage for the male beam profile configuration. usually managed via catalogs. |\n| **PainterFemaleStream** | text | (Empty) | Internal storage for the female beam profile configuration. usually managed via catalogs. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Reset + Erase** | Converts the dynamic connection into static cuts (keeping the geometry) and deletes the TSL instance. This is also triggered by Double-Clicking the instance. |\n\n## Settings Files\n- **Filename**: None specific\n- **Location**: N/A\n- **Purpose**: This script relies on standard hsbCAD Painter catalogs loaded in your environment rather than a specific local settings file.\n\n## Tips\n- **Element Mode**: For walls or floors, select the whole Element in Step 2 to process all internal T-connections at once.\n- **Tool Alignment**: Use \"Male beam\" alignment if you want a slot that is exactly the width of the incoming beam, rather than cutting across the entire width of the main beam.\n- **Side Gap**: If your parts are fitting too tightly, increase the **Side Gap** parameter (e.g., to 1mm or 2mm) to add tolerance.\n- **Debugging**: If the script disappears immediately after insertion, check if the male beam axis actually intersects the female beam volume. The script performs a strict intersection check.\n\n## FAQ\n- **Q: Why did the script disappear after I placed it?**\n  A: The script performs an automatic validity check. If the male beam does not physically intersect the female beam (based on the Distance parameter) or if the geometry is invalid, the script erases itself. Check your beam alignment and ensure the \"Depth\" is sufficient.\n  \n- **Q: How do I make the cut wider than the male beam?**\n  A: Change the **Tool Alignment** property to \"Female beam\". This will calculate the cut width based on the main beam's dimensions.\n\n- **Q: Can I use this on multiple studs at once?**\n  A: Yes. You can window-select multiple male beams in Step 2, then select the single female plate in Step 3. One instance will manage all connections."
      },
      "tokens_used": 7144,
      "error": null
    }
  }
}