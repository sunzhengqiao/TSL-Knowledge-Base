{
  "filename": "hsbCLT-XRef-Updater.mcr",
  "status": "completed",
  "total_tokens": 39353,
  "processing_time": 293.4720125198364,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": "",
          "keywords": [],
          "majorVersion": "",
          "minorVersion": "",
          "dxaOut": "",
          "implInsert": ""
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.0",
            "date": "08aug2019",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 5338,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Explicit usage of '_kModelSpace' in Group().collectEntities() calls. Uses getPoint() for 3D placement of the TSL instance. Logic iterates through MasterPanel and ChildPanel entities which are construction elements stored in Model Space. Uses XrefLocker for XRef manipulation typically found in model structures."
        },
        "prerequisites": {
          "requiredEntities": [
            "MasterPanel",
            "ChildPanel",
            "Sip"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space with existing CLT panel hierarchy",
          "requiredSettings": []
        }
      },
      "tokens_used": 4839,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "../|Update by nestings|",
            "handler": "../|Update by nestings|",
            "action": "Prompts user to select MasterPanel and/or ChildPanel entities (or selects all if none). Updates the 'Masterpanel' submap in associated Sip entities with current drawing path and name.",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "../|Update panels|",
            "handler": "../|Update panels|",
            "action": "Prompts user to select Sip panels (or selects all if none). Removes the 'Masterpanel' submap from Sip entities in Xrefs or the current drawing that match the current drawing name.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 7958,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Synchronizes the metadata link between CLT Master/Child panels and their source drawing files (Xrefs) to ensure correct data association for manufacturing or export.\",\n    \"category\": \"DataManagement\",\n    \"typicalUseCase\": \"Used after importing or modifying CLT Xrefs. It updates the system registry to indicate which specific drawing file (DWG) 'owns' or defines the selected panel hierarchies, or cleans up these links when panels are deleted.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sMapKey\",\n      \"technicalDefault\": \"\\\"Masterpanel\\\"\",\n      \"businessMeaning\": \"The specific property tag name used to store the source drawing path and filename inside the Sip (Structural Insulated Panel) entity.\",\n      \"validRange\": \"N/A (Internal constant)\",\n      \"unit\": \"String\",\n      \"affectsOutput\": \"Determines the attribute key that hsbCAD or other scripts read to identify the origin drawing of a nested panel.\"\n    },\n    {\n      \"name\": \"_Pt0 (Insertion Point)\",\n      \"technicalDefault\": \"User input via getPoint\",\n      \"businessMeaning\": \"The physical location in the 3D model where the visual report of the panel hierarchy is displayed.\",\n      \"validRange\": \"Any valid coordinate in Model Space\",\n      \"unit\": \"mm (Coordinates)\",\n      \"affectsOutput\": \"Positions the generated text and lines that list Masterpanel numbers and their associated Sips for verification purposes.\"\n    },\n    {\n      \"name\": \"Selection (Master/Child Panels)\",\n      \"technicalDefault\": \"All MasterPanels in Model Space (if Enter is pressed)\",\n      \"businessMeaning\": \"The specific set of panel assemblies to be stamped with the current drawing's file information.\",\n      \"validRange\": \"1 or more MasterPanel or ChildPanel entities\",\n      \"unit\": \"Entity Collection\",\n      \"affectsOutput\": \"Writes the 'Masterpanel' submap (containing File Path, File Name, etc.) to the Sip entities nested within the selected panels. Also removes this data from any Sips"
      },
      "tokens_used": 7922,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Launch Script: User executes the TSL (hsbCLT-XRef-Updater).\",\n    \"2. Insertion Point: User selects a location in Model Space (getPoint) for the visual report instance.\",\n    \"3. Data Scan: Script scans Model Space for all MasterPanel entities that contain nested ChildPanels.\",\n    \"4. Sorting: Identified MasterPanels are sorted alphabetically by their number.\",\n    \"5. Visualization: Script draws a list of MasterPanels and their associated Sip entities at the insertion point.\",\n    \"6. User Decision: User triggers an action via Double-click or Context Menu to proceed with data modification.\",\n    \"7. Execution: Script processes the entities based on the chosen trigger.\",\n    \"8. Update: Script sets execution loops to 2 to refresh the visual display after data changes.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Trigger: 'Update by nestings' (Context Menu or Double-click)\",\n      \"path1\": {\n        \"name\": \"Sync Sips to Current Drawing\",\n        \"steps\": [\n          \"Prompt user to select MasterPanel and/or ChildPanel entities.\",\n          \"If user presses Enter (no selection), collect all ChildPanels in Model Space.\",\n          \"Iterate through selected entities to compile a list of unique ChildPanels.\",\n          \"Iterate through all MasterPanels in the drawing.\",\n          \"Check if a MasterPanel's child is in the selected list.\",\n          \"If match found: Write/Update 'Masterpanel' submap on the ChildPanel's Sip entity with current DWG path/name. Handles Xrefs via XrefLocker.\",\n          \"If selected child is NOT found in any MasterPanel (orphan): Remove 'Masterpanel' submap from that Sip entity.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Trigger: 'Update panels' (Context Menu only)\",\n      \"path1\": {\n        \"name\": \"Remove Sip Associations\",\n        \"steps\": [\n          \"Prompt user to select Sip entities.\",\n          \"If user presses Enter (no selection), collect all Sip entities in Model Space.\",\n          \"Iterate through selected Sips.\",\n          \"Check if the Sip contains a 'Masterpanel' submap matching the current drawing's path and name.\",\n          \"Verify if the Sip is actually nested within a MasterPanel in the current model.\",\n          \"Remove the 'Masterpanel' submap from the Sip entity (in current drawing or Xref via XrefLocker).\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Entity Validity\",\n      \"errorMessage\": \"(Implicit) Invalid or erased entities are skipped during collection.\",\n      \"recovery\": \"Script handles invalid entities internally using bIsValid() checks.\"\n    },\n    {\n      \"check\": \"Xref Database Access\",\n      \"errorMessage\": \"Silent failure or locked database error (caught in variable nLockErr but only reported in debug).\",\n      \"recovery\": \"Uses XrefLocker to attempt write access to Sips residing in external references.\"\n    },\n    {\n      \"check\": \"Hierarchy Matching\",\n      \"errorMessage\": \"None explicit to user.\",\n      \"recovery\": \"Script compares handles to ensure Sips are correctly linked to MasterPanels before writing"
      },
      "tokens_used": 8413,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-XRef-Updater\n\n## Overview\nThis script manages and synchronizes the data links between CLT (Cross Laminated Timber) panel hierarchies (Master/Child panels) and their source drawing files. It provides a visual report of the panel structure and allows you to update or clear the metadata that associates specific panels with the current drawing or Xrefs.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script must be inserted in Model Space where CLT panels are located. |\n| Paper Space | No | Not supported in layout views. |\n| Shop Drawing | No | Not intended for shop drawing generation. |\n\n## Prerequisites\n- **Required Entities**: The drawing must contain existing `MasterPanel`, `ChildPanel`, and `Sip` entities.\n- **Minimum Beam Count**: Not applicable (requires specific CLT entities, not beams).\n- **Required Settings**: None required.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbCLT-XRef-Updater.mcr`\n\n### Step 2: Place Visual Report\n```\nCommand Line: Specify insertion point:\nAction: Click in the Model Space to place the script instance.\n```\n*Note: Upon insertion, the script will generate a visual text list at the clicked location displaying the MasterPanels and their associated Sips found in the model.*\n\n### Step 3: Execute Update\nAfter insertion, the script acts as a tool to modify data links. You must interact with it via the Right-Click menu to perform updates.\n```\nAction: Select the script instance (the text/lines generated).\nAction: Right-click and select the desired option from the context menu (see Right-Click Menu Options below).\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| N/A | N/A | N/A | This script does not expose any editable parameters in the Properties Palette. All configuration is handled via the context menu. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Update by nestings** | **Links panels to the current drawing.**<br>Prompts you to select MasterPanels or ChildPanels. If you press Enter without selecting, it processes all panels in the model. It then updates the internal data of Sip entities nested inside the selected panels to point to the current drawing file. It also cleans up data from \"orphaned\" panels that are no longer nested. |\n| **Update panels** | **Removes links from Sip entities.**<br>Prompts you to select Sip entities. If you press Enter, it processes all Sips. It removes the internal reference to the current drawing from any Sip entities that are not currently nested within a MasterPanel in the model. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A.\n- **Purpose**: N/A.\n\n## Tips\n- **Visual Verification**: Use the text list generated at the insertion point to verify which MasterPanels and Sips are currently recognized by the script before running an update.\n- **Select All**: For both context menu options, simply pressing **Enter** at the selection prompt will apply the action to **all** relevant entities in the Model Space.\n- **Orphan Cleanup**: The \"Update by nestings\" option is particularly useful after deleting panels, as it automatically removes the source drawing link from panels that no longer exist in the hierarchy.\n- **Double-Click**: Double-clicking the script instance triggers the same action as selecting \"Update by nestings\" from the right-click menu.\n\n## FAQ\n- **Q: What does the text report show?**\n  - A: It displays a sorted list of MasterPanels found in the model and their relationship to ChildPanels/Sips. This is purely for visual verification.\n- **Q: Do I need to update every time I open a drawing?**\n  - A: Only if the panel hierarchy has changed, or if you have imported new Xrefs and need to establish the link between the panels and the new source drawing.\n- **Q: What is the difference between the two update options?**\n  - A: \"Update by nestings\" writes data to link panels to the current file (typically used when finalizing a layout). \"Update panels\" removes data (typically used for cleanup or resetting references)."
      },
      "tokens_used": 4883,
      "error": null
    }
  }
}