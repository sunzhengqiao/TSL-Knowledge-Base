{
  "filename": "HSB_E-StretchToBeam.mcr",
  "status": "completed",
  "total_tokens": 52659,
  "processing_time": 420.8674774169922,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"header\": {\n    \"type\": null,\n    \"numBeamsReq\": 0,\n    \"keywords\": [],\n    \"majorVersion\": 2,\n    \"minorVersion\": 4,\n    \"dxaOut\": 0,\n    \"implInsert\": 0\n  },\n  \"description\": \"\",\n  \"versionHistory\": [\n    {\n      \"version\": \"2.04\",\n      \"date\": \"27.03.2020\",\n      \"author\": \"\",\n      \"changes\": \"Stretch horizontal beam to an angled top plate.\"\n    },\n    {\n      \"version\": \"1.00\",\n      \"date\": \"04.04.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Pilot version\"\n    },\n    {\n      \"version\": \"1.01\",\n      \"date\": \"05.04.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Translate and add thumb\"\n    },\n    {\n      \"version\": \"1.02\",\n      \"date\": \"11.04.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Add option to 'cut at' a beam instead of only 'stretch to' a beam\"\n    },\n    {\n      \"version\": \"1.03\",\n      \"date\": \"08.07.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Add option to stretch to beamtype too.\"\n    },\n    {\n      \"version\": \"1.04\",\n      \"date\": \"11.07.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Fix stretch to beam type\"\n    },\n    {\n      \"version\": \"1.05\",\n      \"date\": \"21.10.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Chech intersection from center if stretchmode is set to cut.\"\n    },\n    {\n      \"version\": \"1.06\",\n      \"date\": \"06.12.2011\",\n      \"author\": \"AS\",\n      \"changes\": \"Add support for wildcards\"\n    },\n    {\n      \""
      },
      "tokens_used": 8547,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly uses _kModelSpace during insertion (tslNew.dbCreate(..., _kModelSpace, ...)). Execution relies on _bOnElementConstructed trigger and operates directly on 3D Beam objects (stretchStaticTo, addToolStatic). User input is collected via PrEntity for Element selection."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 2,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 7002,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"showDialog\",\n        \"promptOriginal\": null,\n        \"condition\": \"_bOnInsert\",\n        \"required\": false\n      },\n      {\n        \"step\": 2,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"T(\\\"|Select elements|\\\")\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"Property Dialog\",\n      \"trigger\": \"_bOnInsert\",\n      \"title\": null,\n      \"dataSource\": \"PropVariables\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sequenceNumber\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Sequence number\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": \"The sequence number is used to sort the list of tsl's during generate construction\"\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"sBmCodeToStretch\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Beamcode to stretch\",\n      \"defaultValue\": \"ZSP-02\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Beam to stretch\",\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sStretchTo\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Stretch to\",\n      \"defaultValue\": \"Code\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Code\",\n        \"Type\"\n      ],\n      \"category\": \"Stretch to\",\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sCodeToStretchTo\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Stretch to code\",\n      \"defaultValue\": \"KRL-07\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Stretch to\",\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sTypeToStretchTo\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Stretch to type\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"_BeamTypes\"\n      ],\n      \"category\": \"Stretch to\",\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sStretchType\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Stretch or cut\",\n      \"defaultValue\": \"Stretch to\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"Stretch to\",\n        \"Cut at\"\n      ],\n      \"category\": \"Stretch mode\",\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"stretchMargin\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Stretch margin\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Stretch mode\",\n      \"description\": \"Allow this beam to stretch if it ends up outside, but within this margin, of the beam to stretch to.\"\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"stretchToMargin\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Stretch to margin\",\n      \"defaultValue\": 0,\n      \"inputType"
      },
      "tokens_used": 9759,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically extends or trims specific beams within an element to intersect with other defined beams, commonly used for extending floor joists to meet angled top plates.",
          "category": "Framing",
          "typicalUseCase": "A user needs to ensure all floor joists (Beam Code: ZSP-02) extend precisely to touch an angled top plate (Beam Code: KRL-07), regardless of the wall angle, rather than manually stretching each joist."
        },
        "parameters": [
          {
            "name": "sequenceNumber",
            "technicalDefault": 0,
            "businessMeaning": "Determines the execution order of this script relative to other TSLs assigned to the element.",
            "validRange": "0-1000",
            "unit": "Integer",
            "affectsOutput": "Ensures this stretching logic happens after necessary beams are generated but before subsequent machining operations."
          },
          {
            "name": "sBmCodeToStretch",
            "technicalDefault": "ZSP-02",
            "businessMeaning": "The identifier (Beam Code) for the beams that need to be modified (the 'Source' beams).",
            "validRange": "Any valid Beam Code string (supports wildcards).",
            "unit": "String",
            "affectsOutput": "Selects which beams in the element will have their length adjusted or cut."
          },
          {
            "name": "sStretchTo",
            "technicalDefault": "Code",
            "businessMeaning": "The method used to identify the target boundary beam.",
            "validRange": "Code, Type",
            "unit": "Enumeration",
            "affectsOutput": "Switches the filtering logic between looking for a specific Name (Code) or a structural Category (Type)."
          },
          {
            "name": "sCodeToStretchTo",
            "technicalDefault": "KRL-07",
            "businessMeaning": "The identifier (Beam Code) for the beams that act as the boundary or stop point (the 'Target' beams).",
            "validRange": "Any valid Beam Code string.",
            "unit": "String",
            "affectsOutput": "Defines the geometry that the source beams will stretch to or be cut by."
          },
          {
            "name": "sTypeToStretchTo",
            "technicalDefault": "",
            "businessMeaning": "The structural type (e.g., TopPlate, Purlin) used to identify the target boundary beams.",
            "validRange": "Any valid Beam Type from project catalog.",
            "unit": "String",
            "affectsOutput": "Defines the geometry that the source beams will stretch to or be cut by when 'Type' is selected."
          },
          {
            "name": "sStretchType",
            "technicalDefault": "Stretch to",
            "businessMeaning": "The physical operation to perform on the source beam.",
            "validRange": "Stretch to, Cut at",
            "unit": "Enumeration",
            "affectsOutput": "'Stretch to' lengthens the beam to touch the target. 'Cut at' trims the beam end at the intersection with the target."
          },
          {
            "name": "stretchMargin",
            "technicalDefault": 0,
            "businessMeaning": "Virtual extension of the target beam. Allows the source beam to stretch even if it technically ends slightly past the target's physical envelope.",
            "validRange": "0 - 100 mm",
            "unit": "mm",
            "affectsOutput": "Prevents the script from failing if the source beam intersects a tiny gap beyond the target beam's end due to modeling tolerances."
          },
          {
            "name": "stretchToMargin",
            "technicalDefault": 0,
            "businessMeaning": "Maximum allowable gap between the source beam and the target beam. If the distance to the target exceeds the current length plus this margin, the stretch is skipped.",
            "validRange": "0 - 5000 mm",
            "unit": "mm",
            "affectsOutput": "Prevents unintended stretching across large openings or to distant beams that do not actually belong to the connection."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "sStretchTo = 'Code'",
            "effect": "Enables use of sCodeToStretchTo and ignores sTypeToStretchTo.",
            "cascade": [
              "sCodeToStretchTo"
            ]
          },
          {
            "trigger": "sStretchTo = 'Type'",
            "effect": "Enables use of sTypeToStretchTo and ignores sCodeToStretchTo.",
            "cascade": [
              "sTypeToStretchTo"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Beam Modification",
            "description": "Adjusts the length (stretch) or end geometry (cut) of the specified beam code.",
            "appliedTo": "Beams matching sBmCodeToStretch within the selected Element."
          }
        ]
      },
      "tokens_used": 9059,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Initialization: Check for Execute Key or Map arguments to pre-load properties.",
          "2. Insertion Routine (_bOnInsert): Verify insertion cycle count to prevent duplicates.",
          "3. User Input: Display Properties Dialog (showDialog) for parameter configuration (Source Code, Target Code/Type, Margins).",
          "4. User Selection: Prompt user to select one or more Elements (PrEntity).",
          "5. Batch Processing: For each selected Element, create a new instance of the TSL attached to that Element in Model Space.",
          "6. Instance Cleanup: Erase the initial temporary script instance.",
          "7. Execution Phase (_bOnElementConstructed): Retrieve beams from the attached Element.",
          "8. Beam Filtering: Separate beams into 'To Stretch' (Source) and 'Stretch To' (Target) lists based on property filters (Code/Type).",
          "9. Validation: Check if Source and Target codes are identical (Self-reference check); abort if true.",
          "10. Intersection Analysis: For each Source beam, calculate intersection points with Target beams using raycasting (X-axis) and plane intersection (Y-axis for encapsulation).",
          "11. Margin Validation: Verify intersections fall within 'stretchMargin' and 'stretchToMargin' tolerances.",
          "12. Apply Operation: Based on 'Stretch or Cut' setting, either stretch the beam or add a static cut tool.",
          "13. Finalize: Erase the TSL instance after modifying the beams."
        ],
        "conditionalBranches": [
          {
            "condition": "Property: 'Stretch to' (sStretchTo)",
            "path1": {
              "name": "Code",
              "steps": [
                "Filter Target beams by comparing 'Stretch to code' (sCodeToStretchTo) with beam codes.",
                "Supports Wildcards (e.g., 'KRL-*')."
              ]
            },
            "path2": {
              "name": "Type",
              "steps": [
                "Filter Target beams by comparing 'Stretch to type' (sTypeToStretchTo) with beam structural type."
              ]
            }
          },
          {
            "condition": "Property: 'Stretch or cut' (sStretchType)",
            "path1": {
              "name": "Stretch to",
              "steps": [
                "Calculate intersection vector.",
                "Apply beam stretching using stretchStaticTo (standard) or addToolStatic (if encapsulated)."
              ]
            },
            "path2": {
              "name": "Cut at",
              "steps": [
                "Verify source beam actually intersects target beam envelope (unless encapsulated).",
                "Add a Cut tool using addToolStatic."
              ]
            }
          },
          {
            "condition": "Geometric Intersection Analysis",
            "path1": {
              "name": "Standard Intersection",
              "steps": [
                "Cast rays from Source Beam Center along X-axis (+ and -).",
                "If Target beams found, use closest intersection for tool application."
              ]
            },
            "path2": {
              "name": "Encapsulation (Source passes through Target)",
              "steps": [
                "Standard X-axis raycast finds no targets.",
                "Intersect Source Center Line with Target Plane.",
                "Cast rays from this Plane Intersection along Source Y-axis.",
                "If targets found, mark as 'Encapsulated' and apply tool."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Selection",
            "errorMessage": "Invalid or no element selected.",
            "recovery": "Script instance is erased; user must re-run and select a valid Element."
          },
          {
            "check": "Self-Reference Prevention (Code Mode)",
            "errorMessage": "None (Silent abort)",
            "recovery": "If 'Beamcode to stretch' matches 'Stretch to code' (and are not empty), the script erases itself to prevent processing a beam against itself."
          },
          {
            "check": "Proximity/Distance (stretchToMargin)",
            "errorMessage": "None (Silent skip)",
            "recovery": "If the distance to the target beam exceeds (0.5 * source length + stretchToMargin), the specific beam operation is skipped."
          },
          {
            "check": "Target Range (stretchMargin)",
            "errorMessage": "None (Silent skip)",
            "recovery": "If the intersection point lies outside the effective length of the target beam (extended by margin), the operation is skipped."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Modify Parameters",
            "how": "Select the Element instance (if script persisted, though it erases by default, this applies if the script is catalog-linked to the Element Def) or modify properties during insertion.",
            "effect": "Changing Beam Codes, Margins, or Stretch Mode updates the calculation logic on the next generation."
          },
          {
            "action": "Regenerate Construction",
            "how": "Use hsbCAD commands (e.g., Generate Construction) or manual grips on beams.",
            "effect": "Since the script erases itself after running, changes to the Element's geometry require re-running the generation for the stretch/cut logic to re-evaluate."
          }
        ]
      },
      "tokens_used": 10625,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-StretchToBeam.mcr\n\n## Overview\nThis script automatically stretches or cuts specific beams (Source) to intersect with other defined beams (Target) within an element. It is primarily used to extend floor joists to meet angled top plates without manual adjustment.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script must be run in the 3D model. |\n| Paper Space | No | Not applicable for 2D layouts. |\n| Shop Drawing | No | This is a construction/generation script. |\n\n## Prerequisites\n- **Required Entities**: At least one Element containing two or more beams.\n- **Minimum Beam Count**: 2 (One to be stretched/cut, and one to serve as the target boundary).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_E-StretchToBeam.mcr` from the list.\nAlternatively, click the custom toolbar icon if mapped.\n\n### Step 2: Configure Properties\nA Properties dialog will appear immediately upon insertion.\n- **Action**: Set the \"Beamcode to stretch\" (e.g., your floor joist code) and the \"Stretch to code\" (e.g., your top plate code).\n- **Action**: Choose \"Stretch to\" to lengthen beams or \"Cut at\" to trim them.\n- **Action**: Click OK to confirm settings.\n\n### Step 3: Select Elements\n```\nCommand Line: Select elements:\nAction: Click on the Element(s) in the drawing that contain the beams you wish to modify.\nAction: Press Enter to finish selection.\n```\n*Note: Select the Element container, not the individual beams.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Sequence number | Integer | 0 | Determines the execution order relative to other TSLs (0-1000). |\n| Beamcode to stretch | String | ZSP-02 | The code of the beams to be modified (Source). Supports wildcards (e.g., `ZSP-*`). |\n| Stretch to | Dropdown | Code | Select how to identify the target beams: by \"Code\" or by \"Type\". |\n| Stretch to code | String | KRL-07 | The code of the beams to stretch to (Target). Only used if \"Stretch to\" is set to Code. |\n| Stretch to type | Dropdown | [Empty] | The structural type of the target beams (e.g., TopPlate). Only used if \"Stretch to\" is set to Type. |\n| Stretch or cut | Dropdown | Stretch to | Select \"Stretch to\" to extend the beam, or \"Cut at\" to trim the end at the intersection. |\n| Stretch margin | Number | 0 mm | Allows the source beam to stretch if it ends up slightly outside the target beam's volume (tolerance). |\n| Stretch to margin | Number | 0 mm | The maximum allowable gap between the source and target beams for the operation to occur. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| (None) | This script does not add custom items to the right-click context menu. It runs once upon insertion/generation. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Wildcards**: You can use wildcards in the \"Beamcode to stretch\" field (e.g., `Floor-*`) to target multiple beam types at once.\n- **Angled Walls**: This script is specifically useful for projects with non-90-degree walls (e.g., dormers or bay windows) where manual beam stretching is time-consuming.\n- **Margins**: If the script fails to stretch beams that look like they should touch, try increasing the **Stretch margin** (e.g., to 5 mm) to account for small geometric discrepancies.\n- **Sequence Number**: If the beams don't seem to exist when the script runs, increase the **Sequence number** to ensure this script runs *after* the beams are generated.\n\n## FAQ\n- **Q: Why did my beams not stretch?**\n  **A:** Check that the \"Beamcode to stretch\" matches the actual code of your joists exactly. Also, ensure the \"Sequence number\" is high enough that the beams exist when this script runs.\n- **Q: Can I use this to trim beams instead of stretching them?**\n  **A:** Yes. Set the **Stretch or cut** property to \"Cut at\". This will trim the source beam at the intersection point of the target beam.\n- **Q: What happens if I select the wrong element?**\n  **A:** The script will process the selected element. If no matching beams are found, no changes will be made. You can simply undo (Ctrl+Z) and try again."
      },
      "tokens_used": 7667,
      "error": null
    }
  }
}