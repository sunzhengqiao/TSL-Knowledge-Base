{
  "filename": "GE_AB_DIM.mcr",
  "status": "completed",
  "total_tokens": 44182,
  "processing_time": 206.0915491580963,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": null,
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": "Description",
        "versionHistory": [
          {
            "version": "1.03",
            "date": "02apr2020",
            "author": "david.rueda@hsbcad.com",
            "changes": "Renamed from GE_ANCHOR_DIM"
          },
          {
            "version": "1.02",
            "date": "12mar2020",
            "author": "david.rueda@hsbcad.com",
            "changes": "Align and stagger siblings available for XRefs"
          },
          {
            "version": "1.01",
            "date": "03mar2020",
            "author": "david.rueda@hsbcad.com",
            "changes": "Deactivated align and stagger triggers until solve issue with XRefs anchors"
          },
          {
            "version": "1.00",
            "date": "03mar2020",
            "author": "david.rueda@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6715,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script validates '_Element.length() == 1' and uses 'Element' and 'CoordSys' for geometry calculations. It uses 3D primitives (Point3d, Vector3d) and draws directly to the model via 'Display dp' and 'PLine'. No 'sd_' prefixes, 'Multipage' inheritance, or ShopDrawing specific entities (#Type E) are present. The script explicitly prevents manual insertion ('eraseInstance()'), indicating it is an automated component running in the model."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "ModelSpace",
          "requiredSettings": [
            "Map containing specific keys: LocationPoint, ReferencePoint, ImInRegion, ImOrphan, HideMe, IsVertical, DimStyle, Layer, ReferenceDirection."
          ]
        }
      },
      "tokens_used": 5560,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [],
        "contextMenu": [
          {
            "menuItem": "../Align Siblings",
            "handler": "|../Align Siblings|",
            "action": "Sets the alignment flag and point for sibling TSL instances to match the current instance's grip point.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "../Stagger Siblings",
            "handler": "|../Stagger Siblings|",
            "action": "Alternates the alignment position of sibling TSL instances along the element axis to prevent overlap.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "../WriteMapToDxx",
            "handler": "|../WriteMapToDxx|",
            "action": "Writes the instance Map data to a debug .dxx file in C:\\Temp\\DebugMaps (only available if debug mode is active).",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 6256,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and manages individual dimension annotations for anchor points or connection details on timber elements.",
          "category": "Annotation/Detailing",
          "typicalUseCase": "Used to display the offset distance of anchor bolts relative to a reference point, with features to align or stagger multiple dimensions to ensure drawing clarity."
        },
        "parameters": [
          {
            "name": "sMapKeyLocationPoint",
            "technicalDefault": "_Map.getPoint3d(\"LocationPoint\")",
            "businessMeaning": "The specific 3D coordinate on the timber element where the anchor or feature is located.",
            "validRange": "Any valid 3D coordinate on the element surface",
            "unit": "mm (coordinate)",
            "affectsOutput": "Determines the start point (foot) of the dimension leader line."
          },
          {
            "name": "sMapKeyReferencePoint",
            "technicalDefault": "_Map.getPoint3d(\"ReferencePoint\")",
            "businessMeaning": "The origin point from which the distance is measured (e.g., wall edge, grid line).",
            "validRange": "Any valid 3D coordinate",
            "unit": "mm (coordinate)",
            "affectsOutput": "Used to calculate the numerical distance value displayed in the text."
          },
          {
            "name": "sMapKeyReferenceDirection",
            "technicalDefault": "_Map.getVector3d(\"ReferenceDirection\")",
            "businessMeaning": "The axis direction along which the distance is calculated and measured.",
            "validRange": "Normalized Vector (e.g., X, Y, or Z axis)",
            "unit": "Vector direction",
            "affectsOutput": "Determines if the dimension measures X, Y, or Z distance and orients the leader line."
          },
          {
            "name": "sMapKeyImInRegion",
            "technicalDefault": "0",
            "businessMeaning": "Flag indicating if the anchor falls within the current processing or view region.",
            "validRange": "0 (No), 1 (Yes)",
            "unit": "Boolean",
            "affectsOutput": "If 0 (false), the dimension is completely hidden to reduce drawing clutter."
          },
          {
            "name": "sMapKeyHideMe",
            "technicalDefault": "0",
            "businessMeaning": "Manual override to force the dimension to be hidden.",
            "validRange": "0 (Show), 1 (Hide)",
            "unit": "Boolean",
            "affectsOutput": "If 1, the dimension geometry and text are not generated."
          },
          {
            "name": "sMapKeyIsVertical",
            "technicalDefault": "0",
            "businessMeaning": "Controls the rotation/orientation of the dimension text.",
            "validRange": "0 (Horizontal), 1 (Vertical)",
            "unit": "Boolean",
            "affectsOutput": "Rotates the text 90 degrees to ensure readability on vertical elements."
          },
          {
            "name": "sMapKeyDimStyle",
            "technicalDefault": "\"Standard\"",
            "businessMeaning": "The name of the CAD dimension style to use for text appearance.",
            "validRange": "Any string matching a DimStyle in the drawing",
            "unit": "String",
            "affectsOutput": "Font, height, and arrow style of the dimension text."
          },
          {
            "name": "sMapKeyLayer",
            "technicalDefault": "\"0\"",
            "businessMeaning": "The CAD layer on which the dimension geometry is drawn.",
            "validRange": "Any valid layer name string",
            "unit": "String",
            "affectsOutput": "Layer assignment of the generated lines and text."
          },
          {
            "name": "PtG[0]",
            "technicalDefault": "Calculated based on initial offset and alignment",
            "businessMeaning": "The user-editable grip point that defines the location of the dimension text.",
            "validRange": "Any 3D coordinate in free space",
            "unit": "mm (coordinate)",
            "affectsOutput": "Moves the end of the leader line and the position of the text."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "../Align Siblings",
            "effect": "Sets the grip point (PtG[0]) of all sibling instances to match the current instance's grip point.",
            "cascade": [
              "PtG[0]"
            ]
          },
          {
            "trigger": "../Stagger Siblings",
            "effect": "Alternates the grip point (PtG[0]) of sibling instances along the element axis to prevent text overlap.",
            "cascade": [
              "PtG[0]"
            ]
          },
          {
            "trigger": "sMapKeyImInRegion == 0 OR sMapKeyHideMe == 1",
            "effect": "Suppresses the execution of drawing commands, effectively hiding the dimension.",
            "cascade": []
          },
          {
            "trigger": "sMapKeyReferenceDirection",
            "effect": "Determines if the leader line is perpendicular to the element or follows the element's Z-axis.",
            "cascade": [
              "vOffsetDirection",
              "PtG[0]"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Annotation / Dimension",
            "description": "A leader line and text label displaying a distance measurement.",
            "appliedTo": "Model Space (associated with a parent Timber Element)"
          }
        ]
      },
      "tokens_used": 8018,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins",
          "Check for debug mode activation via 'hsbTSLDebugController' or script name match",
          "Initialize variables and constants (Offsets, Map keys, Vectors)",
          "Register context menu triggers (Align Siblings, Stagger Siblings, WriteMapToDxx)",
          "Check if '_bOnDbCreated' (first creation): Write debug map if enabled, then return",
          "Check '_bOnInsert' (Manual insertion): Report error, erase instance, and exit",
          "Validate '_Map' for required keys (LocationPoint, ReferencePoint, ImInRegion, etc.)",
          "If Map validation fails: Report debug error, erase instance, and exit",
          "Validate '_Element' count (must be exactly 1)",
          "If Element count is incorrect: Report debug error, erase instance, and exit",
          "Validate Element object validity",
          "If Element invalid: Report debug error, erase instance, and exit",
          "Extract data from Map (Points, Booleans, Strings, Vectors) and Element Geometry (CoordSys, SegmentMinMax)",
          "Check execution flags: 'bAlignSiblings' or 'bStaggerSiblings' (set by context menu)",
          "If Align/Stagger triggered: Process sibling instances, set their maps, force recalc, set execution loops to 2, and return",
          "Check Map flag 'bAlignMe': If true, move Grip Point 0 (_PtG[0]) along Element Z-axis to match 'AlignmentPoint', then reset flag",
          "Set Reference Point (_Pt0) to 'LocationPoint' and enable grip editing",
          "Assign script to the specified CAD Layer",
          "Check visibility conditions: '!bImInRegion' OR 'bHideMe'",
          "If hidden: Disable grip editing and exit without drawing",
          "Check 'bImOrphan': If true, set display color to Red (visual warning)",
          "Calculate perpendicularity check: Dot product of Element.vecZ and ReferenceDirection",
          "Determine 'vOffsetDirection' for the leader line",
          "Check if Grip Point 0 has been set ('bIsPtG0Set')",
          "If not set: Calculate initial position based on element edges and 'dInitialOffset', save to PtG[0]",
          "If set: Determine direction based on existing PtG[0] location relative to reference",
          "Validate PtG[0] existence",
          "Calculate distance value based on ReferenceDirection",
          "Format distance string to 2 decimal places",
          "Determine text orientation vectors based on 'bIsVertical'",
          "Draw Dimension Text at PtG[0] with offset",
          "Draw Leader Line (PLine) from _Pt0 to PtG[0]",
          "If debug mode active: Write final Map state to .dxx file and report status messages"
        ],
        "conditionalBranches": [
          {
            "condition": "Context Menu Trigger: Align Siblings vs Stagger Siblings",
            "path1": {
              "name": "Align Siblings",
              "steps": [
                "Retrieve sibling TSL instances from Map",
                "Loop through each valid sibling",
                "Set sibling's 'AlignMe' flag to true",
                "Set sibling's 'AlignmentPoint' to current instance's _PtG[0]",
                "Update sibling Map and trigger recalc",
                "Set script to run 2 execution loops",
                "Return (skip drawing)"
              ]
            },
            "path2": {
              "name": "Stagger Siblings",
              "steps": [
                "Retrieve sibling TSL instances",
                "Sort siblings based on their coordinate along Element X-axis",
                "Determine current instance index parity (Even/Odd)",
                "Calculate alignment vector along Element Z-axis",
                "Loop through siblings",
                "Invert alignment vector if sibling parity differs from current instance",
                "Set sibling's 'AlignMe' and 'AlignmentPoint' to calculated staggered position",
                "Update sibling Map and trigger recalc",
                "Set script to run 2 execution loops",
                "Return (skip drawing)"
              ]
            }
          },
          {
            "condition": "Initialization of Grip Point (PtG[0])",
            "path1": {
              "name": "Initial Placement (bIsPtG0Set == false)",
              "steps": [
                "Check if Reference is Perpendicular to Element Z",
                "If Perpendicular: Find closest Element edge (Start/End)",
                "Align Y-position to Element Center",
                "Set direction to Element X (outwards)",
                "If Not Perpendicular: Set direction to Element Z",
                "Apply fixed offset (dInitialOffset)",
                "Create PtG[0] and set 'bIsPtG0Set' to true"
              ]
            },
            "path2": {
              "name": "User Adjusted (bIsPtG0Set == true)",
              "steps": [
                "Check if Reference is Perpendicular",
                "Define base direction (Element X or Z)",
                "Calculate vector from Start Point to PtG[0]",
                "If vector opposes base direction, flip base direction",
                "Use this direction to draw lines to the existing PtG[0]"
              ]
            }
          },
          {
            "condition": "Visibility State",
            "path1": {
              "name": "Visible (bImInRegion && !bHideMe)",
              "steps": [
                "Enable Grips",
                "Execute geometry calculation",
                "Draw Text and PLine"
              ]
            },
            "path2": {
              "name": "Hidden (!bImInRegion || bHideMe)",
              "steps": [
                "Disable Grips",
                "Stop execution (Return)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Manual Insertion Attempt (_bOnInsert)",
            "errorMessage": "This TSL is not meant to be manually inserted. Is part of automation from GE_AB_DIMS",
            "recovery": "Script erases itself immediately. User must use the parent macro to generate instances."
          },
          {
            "check": "Map Data Integrity",
            "errorMessage": "has been deleted because _Map is missing one or more fields (Debug Mode)",
            "recovery": "Script erases itself. Parent automation must provide all required keys (LocationPoint, ReferencePoint, ImInRegion, etc.)."
          },
          {
            "check": "Single Element Association",
            "errorMessage": "has been deleted because _Element.length() was expected to be 1 (Debug Mode)",
            "recovery": "Script erases itself if attached to 0 or more than 1 element."
          },
          {
            "check": "Element Validity",
            "errorMessage": "has been deleted because element is not valid entity (Debug Mode)",
            "recovery": "Script erases itself if the host element is corrupted or deleted."
          },
          {
            "check": "Grip Point Validity",
            "errorMessage": "has been deleted because _PtG length is not 1 (Debug Mode)",
            "recovery": "Script erases itself if the grip array is corrupted."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Dimension Location",
            "how": "Grip Edit (Drag PtG[0])",
            "effect": "Moves the end of the leader line and the text position. The new location is saved in the Map for future recalculations."
          },
          {
            "action": "Align Multiple Dimensions",
            "how": "Right-click Context Menu -> '../Align Siblings'",
            "effect": "Finds all related dimensions (siblings) and sets their grip height/location to match the current instance, creating a straight line of text."
          },
          {
            "action": "Stagger Multiple Dimensions",
            "how": "Right-click Context Menu -> '../Stagger Siblings'",
            "effect": "Sorts dimensions and alternates their positions (Up/Down or Left/Right) to prevent text overlap."
          },
          {
            "action": "Debug Map Export",
            "how": "Right-click Context Menu -> '../WriteMapToDxx' (Only if Debug Mode active)",
            "effect": "Exports the internal property map to a .dxx file in C:\\Temp\\DebugMaps for troubleshooting."
          }
        ]
      },
      "tokens_used": 10250,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# GE_AB_DIM.mcr\n\n## Overview\nThis script is an automated component that generates individual dimension annotations for anchor points or connection details on timber elements. It handles the visual display of offset distances, leader lines, and includes tools to align or stagger multiple labels to ensure drawings remain clear.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script runs in the 3D model environment. |\n| Paper Space | No | Not designed for use in Layouts. |\n| Shop Drawing | No | Not a shop drawing output script. |\n\n## Prerequisites\n- **Required entities**: A single Timber Element (`Element`).\n- **Parent Automation**: This script is designed to be instantiated automatically by a parent script (e.g., `GE_AB_DIMS`). It cannot be manually inserted.\n- **Required Settings**: The instance requires specific Map data provided by the parent script, including `LocationPoint` (anchor location), `ReferencePoint` (measurement origin), and `ReferenceDirection` (measurement axis).\n\n## Usage Steps\n\n### Step 1: Automated Generation\nThis script is executed automatically by a parent macro. You cannot insert it manually using the `TSLINSERT` command. If you attempt to run it directly, it will display an error message and delete itself.\n\n### Step 2: Adjust Position (Grip Edit)\n```\nAction: Select the generated dimension annotation in the model.\nCommand Line: N/A\nAction: Click and drag the blue square **Grip Point** at the end of the leader line.\nResult: Moves the text label to a new location. This location is saved automatically.\n```\n\n### Step 3: Organize Multiple Dimensions\n```\nAction: Right-click on a dimension instance.\nAction: Select \"Align Siblings\" or \"Stagger Siblings\" from the context menu.\nResult: \n- \"Align Siblings\": Moves all related dimension texts to the same height/position as the selected one.\n- \"Stagger Siblings\": Alternates the position of related dimensions up and down to prevent overlapping text.\n```\n\n## Properties Panel Parameters\n\nThis script does not expose any user-editable parameters in the AutoCAD Properties Palette (OPM). All configuration is handled via the parent script's Map data.\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| *N/A* | *N/A* | *N/A* | *Configuration is automated via the parent script.* |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| **Align Siblings** | Aligns the grip point of all sibling dimension instances to match the current instance's text position. Useful for creating a straight row of dimensions. |\n| **Stagger Siblings** | Offsets the grip points of sibling instances alternately along the element axis. Useful for preventing text overlap when anchors are close together. |\n| **WriteMapToDxx** | (Debug Only) Exports the current instance's internal data to a `.dxx` file in `C:\\Temp\\DebugMaps`. Used for troubleshooting. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script does not use external settings files. All settings are passed via the internal instance Map.\n\n## Tips\n- **Visibility Control**: Dimensions will automatically hide if the parent script determines they are not in the current view region (`ImInRegion` = 0) or if manually set to hide.\n- **Visual Warnings**: If an anchor point becomes an \"orphan\" (e.g., the associated geometry is missing), the dimension will display in **Red**.\n- **Text Rotation**: The script automatically detects if the element is vertical (`IsVertical`) and rotates the text 90 degrees for readability.\n- **Grip Persistence**: Moving the grip point saves the position relative to the element, ensuring the dimension stays in the user-defined location during plan updates.\n\n## FAQ\n- **Q: Why did the script disappear immediately after I tried to insert it?**\n  A: This script is a \"child\" component intended for automation only. It checks if it was inserted manually; if so, it erases itself. Please use the parent macro to generate these dimensions.\n- **Q: How do I change the numerical value shown in the text?**\n  A: The value is calculated based on the `ReferencePoint` and `ReferenceDirection` provided by the parent script. You cannot edit the text directly, but you can move the text label using the grip.\n- **Q: What happens if I move the anchor point on the beam?**\n  A: The dimension line start point (`_Pt0`) is linked to the `LocationPoint`. If the beam geometry or anchor updates, the script will recalculate and move the dimension line accordingly."
      },
      "tokens_used": 7383,
      "error": null
    }
  }
}