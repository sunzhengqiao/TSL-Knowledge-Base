{
  "filename": "HSB_T-Drill Pattern.mcr",
  "status": "completed",
  "total_tokens": 47096,
  "processing_time": 367.09406208992004,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 6739,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `_kModelSpace` in the `dbCreate` call. It lacks `_Viewport`, `sd_`, or `Multipage` prefixes, and uses `#Type E` only for generic entity selection (`PrEntity`), not ShopDrawing generation. It directly modifies beam geometry via `bm.addTool` and `Drill/Mortise` entities."
        },
        "prerequisites": {
          "requiredEntities": [
            "Beam"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 3907,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"PrEntity\",\n        \"promptOriginal\": \"|Select one or more beams|\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [\n    {\n      \"type\": \"Dynamic Properties Dialog\",\n      \"trigger\": \"Insertion (if no execute key)\",\n      \"title\": null,\n      \"dataSource\": \"PropString/PropDouble definitions\",\n      \"features\": {\n        \"searchable\": false,\n        \"multiSelect\": false\n      }\n    }\n  ],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sSeperator01\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Orientation|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"label\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sSwap\",\n      \"type\": \"PropString\",\n      \"displayName\": \"     |Swap side|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sFlip\",\n      \"type\": \"PropString\",\n      \"displayName\": \"     |Flip|\",\n      \"defaultValue\": \"|No|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sSeperator02\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Start positions|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"label\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dyFront\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"     Y-|offset front|\",\n      \"defaultValue\": \"30\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"dxFront\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"     X-|offset front|\",\n      \"defaultValue\": \"85\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"dyBack\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"     Y-|offset back|\",\n      \"defaultValue\": \"30\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"dxBack\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"     X-|offset back|\",\n      \"defaultValue\": \"35\",\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sSeperator03\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Distribution|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"label\",\n      \"options\": [],\n      \"category\":"
      },
      "tokens_used": 8270,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the placement of rows of through-holes (ventilation or wiring) along timber beams, with options for alternating rows (zig-zag), single center line, or fixed front/back placement.",
          "category": "Machining",
          "typicalUseCase": "Creating ventilation holes in floor joists, roof battens, or wall studs, typically for passive house ventilation or running electrical/HVAC services."
        },
        "parameters": [
          {
            "name": "sSeperator01",
            "technicalDefault": "",
            "businessMeaning": "Group header for 'Orientation' settings. Read-only label.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "sSwap",
            "technicalDefault": "|No|",
            "businessMeaning": "Swaps the beam's Width (Y) and Height (Z) axes. This effectively moves the drill pattern from the side faces to the top/bottom faces or vice versa.",
            "validRange": "[|Yes|, |No|]",
            "unit": "Enumeration",
            "affectsOutput": "Rotates the drilling plane 90 degrees around the beam's longitudinal axis."
          },
          {
            "name": "sFlip",
            "technicalDefault": "|No|",
            "businessMeaning": "Mirrors the drill pattern to the opposite side of the reference face (e.g., from Top to Bottom, or Left to Right).",
            "validRange": "[|Yes|, |No|]",
            "unit": "Enumeration",
            "affectsOutput": "Inverts the offset direction relative to the beam's centerline."
          },
          {
            "name": "sSeperator02",
            "technicalDefault": "",
            "businessMeaning": "Group header for 'Start positions' settings. Read-only label.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "dyFront",
            "technicalDefault": "30",
            "businessMeaning": "The lateral offset from the beam's side edge to the center of the first row of drills (on the 'front' side).",
            "validRange": "0 to (Beam Width / 2)",
            "unit": "mm",
            "affectsOutput": "Moves the front row of holes closer to or further from the visible side edge."
          },
          {
            "name": "dxFront",
            "technicalDefault": "85",
            "businessMeaning": "The longitudinal distance from the beam's start (left) end to the center of the first drill row.",
            "validRange": "0 to Beam Length",
            "unit": "mm",
            "affectsOutput": "Sets the starting position of the drilling pattern along the beam."
          },
          {
            "name": "dyBack",
            "technicalDefault": "30",
            "businessMeaning": "The lateral offset from the beam's opposite side edge to the center of the second row of drills (used in front/back or zig-zag modes).",
            "validRange": "0 to (Beam Width / 2)",
            "unit": "mm",
            "affectsOutput": "Moves the back row of holes relative to the far side edge."
          },
          {
            "name": "dxBack",
            "technicalDefault": "35",
            "businessMeaning": "The longitudinal distance from the beam's end (right) end to the center of the last drill row.",
            "validRange": "0 to Beam Length",
            "unit": "mm",
            "affectsOutput": "Sets the ending position of the drilling pattern along the beam."
          },
          {
            "name": "sSeperator03",
            "technicalDefault": "",
            "businessMeaning": "Group header for 'Distribution' settings. Read-only label.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "dMaximumSpacing",
            "technicalDefault": "600",
            "businessMeaning": "The maximum allowable center-to-center distance between drill rows. The script calculates the exact spacing to fit an integer number of holes within the start/end limits.",
            "validRange": "Min (Drill Dia + 10mm) to Beam Length",
            "unit": "mm",
            "affectsOutput": "Controls the density of the holes; the script adjusts actual spacing to be equal or smaller than this value."
          },
          {
            "name": "distributionPattern",
            "technicalDefault": "|Front and back|",
            "businessMeaning": "Defines the layout strategy: 'Front and back' creates parallel lines on both sides; 'Zig-zag' alternates between sides; 'Centre line' drills directly through the geometric center of the beam.",
            "validRange": "[|Front and back|, |Zig-zag|, |Centre line|]",
            "unit": "Enumeration",
            "affectsOutput": "Determines if holes are single row (center), double row (parallel), or double row (staggered)."
          },
          {
            "name": "sSeperator04",
            "technicalDefault": "",
            "businessMeaning": "Group header for 'Drill & sinkhole' settings. Read-only label.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "dDrillDiam",
            "technicalDefault": "14",
            "businessMeaning": "The diameter of the through-hole drill.",
            "validRange": "10mm to 100mm",
            "unit": "mm",
            "affectsOutput": "Size of the circular cut passing through the beam."
          },
          {
            "name": "dDiamSinkhole",
            "technicalDefault": "40",
            "businessMeaning": "The diameter of the counterbore (sinkhole) on the drill entry face, used to recess bolt heads or connections.",
            "validRange": "0 (disabled) to 150mm",
            "unit": "mm",
            "affectsOutput": "Adds a cylindrical recess at the drill entry point if DepthSinkhole is also active."
          },
          {
            "name": "dDepthSinkhole",
            "technicalDefault": "15",
            "businessMeaning": "The depth of the counterbore (sinkhole).",
            "validRange": "0 (disabled) to (Beam Depth/2)",
            "unit": "mm",
            "affectsOutput": "Depth of the cylindrical recess. Requires DiamSinkhole > 0."
          },
          {
            "name": "sSeperator05",
            "technicalDefault": "",
            "businessMeaning": "Group header for 'Symbol' settings. Read-only label.",
            "validRange": "N/A",
            "unit": "N/A",
            "affectsOutput": "None"
          },
          {
            "name": "dSymbolSize",
            "technicalDefault": "50",
            "businessMeaning": "The scale size for the 2D plan view representation symbol.",
            "validRange": "10mm to 200mm",
            "unit": "mm",
            "affectsOutput": "Scales the visual annotation (arrows/circles) in CAD drawings, not the physical machining."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "distributionPattern = |Centre line|",
            "effect": "Ignores the Y-axis offsets (dyFront, dyBack) and places drills exactly in the middle of the beam's cross-section.",
            "cascade": [
              "dyFront",
              "dyBack",
              "sSwap"
            ]
          },
          {
            "trigger": "distributionPattern = |Zig-zag|",
            "effect": "Alternates drill placement between the coordinates defined by Front (dxFront/dyFront) and Back (dxBack/dyBack) for subsequent holes.",
            "cascade": [
              "dyFront",
              "dyBack"
            ]
          },
          {
            "trigger": "sSwap = |Yes|",
            "effect": "Swaps the interpretation of the Y-axis offsets. The offsets apply to the beam's height instead of its width.",
            "cascade": [
              "dyFront",
              "dyBack"
            ]
          },
          {
            "trigger": "dDiamSinkhole = 0 OR dDepthSinkhole = 0",
            "effect": "The sinkhole (Mortise) operation is skipped entirely.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "Drill",
            "description": "Through-holes generated along the beam length according to the spacing and pattern settings.",
            "appliedTo": "The selected GenBeam."
          },
          {
            "type": "Mortise",
            "description": "Counterbore (recess) at the entry point of each drill, created only if Diameter and Depth are positive.",
            "appliedTo": "The selected GenBeam."
          },
          {
            "type": "Display (Symbol)",
            "description": "2D CAD symbol showing the drill direction, start location, and calculated spacing in plan view.",
            "appliedTo": "The TSL instance (visible in plan view)."
          }
        ]
      },
      "tokens_used": 8779,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"workflowDiagram\": [\n    \"1. Script Launch: User executes script (Insert or via Execute Key).\",\n    \"2. Cycle Check: Script checks `insertCycleCount`. If > 1, instance is erased immediately (cleanup).\",\n    \"3. Configuration Check: Script checks if an Execute Key (preset) was used.\",\n    \"4. [Conditional] Dialog: If no valid Execute Key is found, the Properties Dialog (`showDialog`) opens for user input.\",\n    \"5. Entity Selection: User is prompted via command line to select one or more Beams (`PrEntity`).\",\n    \"6. Iteration Processing: Script loops through every beam selected.\",\n    \"   6a. Duplicate Check: Script checks if an instance of 'HSB_T-Drill Pattern' already exists on the beam. If found, it reports and erases the old instance.\",\n    \"   6b. Instance Creation: Script calculates the insertion point and creates a new TSL instance attached to the beam (`dbCreate`).\",\n    \"   6c. Propagation: Current property values are passed to the new instance via a Map (MasterToSatellite).\",\n    \"7. Cleanup: The temporary 'Master' instance used to launch the script is erased.\",\n    \"8. Calculation Phase (Satellite Instances):\",\n    \"   8a. Property Load: Instance reads properties passed from the Master or from the catalog.\",\n    \"   8b. Validation: Checks if a valid beam is attached. If not, instance is erased.\",\n    \"   8c. Coordinate System: Determines beam vectors (X, Y, Z). Applies Swap/Flip transformations.\",\n    \"   8d. Position Calculation: Calculates start and end points for the drill pattern based on offsets (`dy`, `dx`).\",\n    \"   8e. Spacing Algorithm: Calculates even spacing based on `dMaximumSpacing` and the total distribution length.\",\n    \"   8f. Tool Generation: Loops through calculated positions.\",\n    \"       - Adds Drill entities.\",\n    \"       - [Conditional] Adds Mortise (Sinkhole) entities if dimensions are valid.\",\n    \"   8g. Visualization: Generates 2D plan view symbol with dimensions and direction arrow.\"\n  ],\n  \"conditionalBranches\": [\n    {\n      \"condition\": \"Preset Configuration vs. Manual Input\",\n      \"path1\": {\n        \"name\": \"Execute Key Used\",\n        \"steps\": [\n          \"Script detects `_kExecuteKey`.\",\n          \"Properties are loaded silently from the specific catalog entry.\",\n          \"Skips the interactive `showDialog()` step.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Manual Input\",\n        \"steps\": [\n          \"Script finds no valid Execute Key.\",\n          \"Properties Dialog is displayed.\",\n          \"User must confirm or change settings before proceeding to selection.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Distribution Pattern Selection\",\n      \"path1\": {\n        \"name\": \"Centre Line\",\n        \"steps\": [\n          \"Ignores `dyFront` and `dyBack` offsets.\",\n          \"Calculates hole coordinates exactly at the center of the beam's cross-section.\",\n          \"Only one hole is generated per spacing interval.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Front and back\",\n        \"steps\": [\n          \"Uses `dyFront` and `dyBack` offsets.\",\n          \"Generates two holes (front and back) at every spacing interval.\"\n        ]\n      },\n      \"path3\": {\n        \"name\": \"Zig-zag\",\n        \"steps\": [\n          \"Uses `dyFront` and `dyBack` offsets.\",\n          \"Alternates hole generation: Front on even intervals, Back on odd intervals.\",\n          \"Exceptions: Both front and back are always generated at the very start and very end of the beam.\"\n        ]\n      }\n    },\n    {\n      \"condition\": \"Sinkhole (Counterbore) Calculation\",\n      \"path1\": {\n        \"name\": \"Enabled\",\n        \"steps\": [\n          \"Check if `dDiamSinkhole * dDepthSinkhole > 0`.\",\n          \"Creates a Mortise entity at the entry point of every drill.\",\n          \"Transforms the Mortise along with the Drill during the loop.\"\n        ]\n      },\n      \"path2\": {\n        \"name\": \"Disabled\",\n        \"steps\": [\n          \"Check fails (diameter or depth is 0).\",\n          \"Skips Mortise creation.\",\n          \"Only Drill entities are added to the beam.\"\n        ]\n      }\n    }\n  ],\n  \"validationRules\": [\n    {\n      \"check\": \"Beam Attachment\",\n      \"errorMessage\": \"|No valid beam selected|!\",\n      \"recovery\": \"Ensure a beam is selected during insertion or the TSL is dragged onto a valid beam in the model.\"\n    },\n    {\n      \"check\": \"Duplicate Script\",\n      \"errorMessage\": \"|Duplicate tsls were found and removed during insert|! or |Duplicate tsl found and removed|!\",\n      \"recovery\": \"Script handles this automatically by erasing the old instance. No user action required.\"\n    },\n    {\n      \"check\": \"Insertion Cycle\",\n      \"errorMessage\": \"None (Silent)\",\n      \"recovery\": \"Internal logic. If `insertCycleCount() > 1`, the script self-erases to prevent ghost instances during multi-selection.\"\n    }\n  ],\n  \"postInsertionActions\": [\n    {\n      \"action\": \"Modify Parameters (OPM)\",\n      \"how\": \"Select the TSL instance or the Beam and edit properties in the AutoCAD Properties Palette.\",\n      \"effect\": \"Changing offsets (`dy`, `dx`), spacing, or diameters triggers an immediate recalculation and update of the drill geometry.\"\n    },\n    {\n      \"action\": \"Beam Geometry Change\",\n      \"how\": \"Stretch or shorten the beam using standard CAD grips or properties.\",\n      \"effect\": \"The script has `setDependencyOnBeamLength`. The drill pattern automatically redistributes to fit the new length while maintaining the specified Maximum Spacing logic.\"\n    },\n    {\n      \"action\": \"Change Pattern Type\",\n      \"how\": \"Modify the 'Distribution pattern' property in OPM (e.g., switch from Front and back to Zig-zag).\",\n      \"effect\": \"The script recalculates the hole locations, adding or removing holes to match the new geometric logic.\"\n    }\n"
      },
      "tokens_used": 10818,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_T-Drill Pattern.mcr\n\n## Overview\nThis script automates the creation of through-holes (drills) and counterbores along timber beams. It is designed for ventilation or service holes and supports patterns like parallel rows, zig-zag, or center line placement with automatic spacing calculations.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script operates exclusively in the 3D model environment. |\n| Paper Space | No | Not intended for layout or detailing views. |\n| Shop Drawing | No | This script creates physical tooling (Drills), not 2D annotations for drawings. |\n\n## Prerequisites\n- **Required entities**: One or more Timber Beams (GenBeam).\n- **Minimum beam count**: 1.\n- **Required settings**: None (uses internal property defaults).\n\n## Usage Steps\n\n### Step 1: Launch Script\nRun the `TSLINSERT` command in AutoCAD and select `HSB_T-Drill Pattern.mcr` from the list.\n\n### Step 2: Configure Properties\nUpon launch, a Properties Dialog will appear.\n- **Action**: Set the desired drill diameter, offsets, and distribution pattern (e.g., \"Zig-zag\"). Click **OK** to confirm.\n\n### Step 3: Select Beams\n```\nCommand Line: Select one or more beams\nAction: Click on the beam(s) in the model where you want the drill pattern applied. Press Enter to finish selection.\n```\n\n### Step 4: Completion\nThe script calculates the positions based on the beam length and settings, adds the drill operations to the beams, and displays a 2D symbol indicating the hole locations.\n\n## Properties Panel Parameters\n\n### Orientation\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Swap side | Dropdown | No | Swaps the Width (Y) and Height (Z) axes. Use this to move the drill pattern from the side faces to the top/bottom faces. |\n| Flip | Dropdown | No | Mirrors the drill pattern to the opposite side of the reference face (e.g., Top to Bottom). |\n\n### Start positions\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Y-offset front | Number | 30 mm | Distance from the beam's side edge to the center of the first row of drills. |\n| X-offset front | Number | 85 mm | Longitudinal distance from the beam's start (left) end to the center of the first drill. |\n| Y-offset back | Number | 30 mm | Distance from the opposite side edge to the center of the second row (if applicable). |\n| X-offset back | Number | 35 mm | Longitudinal distance from the beam's end (right) end to the center of the last drill. |\n\n### Distribution\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Maximum Spacing | Number | 600 mm | Maximum allowable center-to-center distance. The script automatically adjusts this to fit an even number of holes. |\n| Distribution pattern | Dropdown | Front and back | Determines layout: <br>• *Front and back*: Two parallel lines.<br>• *Zig-zag*: Alternating lines.<br>• *Centre line*: Single line through the beam center. |\n\n### Drill & sinkhole\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Drill Diameter | Number | 14 mm | Diameter of the through-hole. |\n| Diam Sinkhole | Number | 40 mm | Diameter of the counterbore (recess) at the drill entry. Set to 0 to disable. |\n| Depth Sinkhole | Number | 15 mm | Depth of the counterbore. |\n\n### Symbol\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Symbol Size | Number | 50 mm | Scale of the 2D visual annotation in plan view. |\n\n## Right-Click Menu Options\nNo custom context menu items are defined for this script. Use the AutoCAD Properties Palette to modify parameters.\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: All configuration is handled via the Properties Palette/Dialog.\n\n## Tips\n- **Automatic Spacing**: If you set the Maximum Spacing to 600mm, but the beam length allows for a spacing of 580mm to fit perfectly, the script will use 580mm.\n- **Zig-Zag Pattern**: When using \"Zig-zag\", holes are placed at both the Front and Back positions at the very start and very end of the beam to ensure stability.\n- **Dynamic Updates**: If you stretch or change the length of the beam after insertion, the drill pattern will automatically recalculate to maintain the correct spacing and distribution.\n- **Center Line Mode**: Selecting \"Centre line\" for the Distribution pattern ignores the Y-offsets and places holes exactly in the middle of the beam, regardless of \"Swap side\" settings.\n\n## FAQ\n- **Q: Why are my holes not exactly 600mm apart?**\n  **A:** The script prioritizes even distribution between the start and end points. The actual spacing will be equal to or less than the \"Maximum Spacing\" value to ensure the holes fit perfectly within the specified range.\n- **Q: How do I drill through the top of the beam instead of the side?**\n  **A:** Set the \"Swap side\" property to \"Yes\". This exchanges the beam's width and height axes for the drill calculation.\n- **Q: Can I use this for a single hole?**\n  **A:** Yes. Set the \"Distribution pattern\" to \"Centre line\" or set the X-offsets (Front and Back) to be very close together, effectively creating a single hole (or a pair) at a specific location."
      },
      "tokens_used": 8583,
      "error": null
    }
  }
}