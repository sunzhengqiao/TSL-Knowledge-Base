{
  "filename": "HSB_G-Delivery.mcr",
  "status": "completed",
  "total_tokens": 49585,
  "processing_time": 526.8066363334656,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8959,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script collects data using Group().allExistingGroups() and Entity.collectEntities(TRUE, Element(), _kModelSpace). Filename prefix 'HSB_G-' indicates a global/construct script. No references to _kPaperSpace, Sheets, or viewports."
        },
        "prerequisites": {
          "requiredEntities": [
            "Group",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space containing Groups flagged as deliverable containers (e.g., Floor Groups)",
          "requiredSettings": [
            "Utilities\\hsbDatabase\\hsbTslDelivery.dll",
            "HSB-DeliveryItem",
            "HSB_I-ShowElementQuantity"
          ]
        }
      },
      "tokens_used": 6549,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "getPoint",
              "promptOriginal": "|Select a point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "ShowDynamicDialog",
            "trigger": "_bOnInsert or 'Create a new delivery' context menu",
            "title": null,
            "dataSource": "Local PropString variables (sNewDeliveryName, sNewDeliveryDescription)",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sDimStyle",
            "type": "PropString",
            "displayName": "Dimension style",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": null,
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "nColorTable",
            "type": "PropInt",
            "displayName": "Color table",
            "defaultValue": "-1",
            "inputType": "number",
            "options": null,
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "nColorContent",
            "type": "PropInt",
            "displayName": "Color content",
            "defaultValue": "5",
            "inputType": "number",
            "options": null,
            "category": null,
            "description": null
          },
          {
            "index": 3,
            "variable": "sHideWhenZero",
            "type": "PropString",
            "displayName": "Hide when amount is '0'",
            "defaultValue": "|No|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [
          {
            "menuItem": "Create a new delivery",
            "handler": "arSTrigger[0]",
            "action": "Opens dialog to define delivery name and description",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Edit the current delivery",
            "handler": "arSTrigger[1]",
            "action": "Edits existing delivery details",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Recalculate element list",
            "handler": "arSTrigger[2]",
            "action": "Updates the list of elements in the delivery based on current model state",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove current project delivery data",
            "handler": "arSTrigger[3]",
            "action": "Clean up and remove project-level delivery data",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "Remove current delivery",
            "handler": "arSTrigger[4]",
            "action": "Deletes the current delivery instance",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": [
          {
            "filename": "hsbTslDelivery.dll",
            "searchPaths": [
              "_kPathHsbInstall\\Utilities\\hsbDatabase"
            ],
            "purpose": "External assembly used for processing delivery data and likely external UI",
            "required": true
          }
        ]
      },
      "tokens_used": 9654,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Generates and manages delivery lists (packing lists) for construction projects by grouping elements into specific batches, calculating quantities, and updating element data for production and database integration.",
          "category": "Data Management",
          "typicalUseCase": "Creating a shipping manifest or delivery schedule to define which floors, groups, and specific timber elements are included in a specific delivery batch for transport to the construction site."
        },
        "parameters": [
          {
            "name": "sDimStyle",
            "technicalDefault": "",
            "businessMeaning": "Defines the text style (font, height, etc.) used for the text content of the generated delivery schedule table.",
            "validRange": "Any Dimension Style currently defined in the CAD drawing",
            "unit": "String",
            "affectsOutput": "Visual appearance of text in the delivery table (font size, typeface)."
          },
          {
            "name": "nColorTable",
            "technicalDefault": "-1",
            "businessMeaning": "Sets the AutoCAD color index for the graphical lines (grid and borders) of the delivery table.",
            "validRange": "AutoCAD Color Index (0-255, typically -1 for ByLayer)",
            "unit": "Integer",
            "affectsOutput": "Color of the table frame and grid lines drawn in the model."
          },
          {
            "name": "nColorContent",
            "technicalDefault": "5",
            "businessMeaning": "Sets the AutoCAD color index for the text content (element names, types, quantities) displayed within the delivery table.",
            "validRange": "AutoCAD Color Index (0-255)",
            "unit": "Integer",
            "affectsOutput": "Color of the text items in the delivery table."
          },
          {
            "name": "sHideWhenZero",
            "technicalDefault": "|No|",
            "businessMeaning": "Determines whether items with a calculated quantity of zero (e.g., fully delivered or excluded elements) should be hidden from the generated table to keep the list clean.",
            "validRange": "|Yes|, |No|",
            "unit": "Option",
            "affectsOutput": "Number of rows visible in the delivery table; controls visibility of completed items."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "User sets 'Hide when amount is 0' to Yes",
            "effect": "The script evaluates the calculated quantity of elements; rows with quantity 0 are skipped during the table generation loop.",
            "cascade": [
              "arSDeliveryItemInfo"
            ]
          },
          {
            "trigger": "User changes Dimension Style",
            "effect": "The row height and column width of the table are recalculated based on the text metrics of the selected style.",
            "cascade": [
              "dRowHeight",
              "dColumnWidth"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry (Lines and Text)",
            "description": "Draws a formatted schedule table in Model Space displaying the delivery name, description, group names, and a list of elements with their quantities.",
            "appliedTo": "Model Space at the selected insertion point (_Pt0)"
          },
          {
            "type": "Element Data Update",
            "description": "Updates the 'Quantity' property of individual Elements based on the delivery multiplier and default amount.",
            "appliedTo": "Elements contained within the designated floor groups"
          },
          {
            "type": "External Data Map",
            "description": "Generates a structured Map containing delivery groups and items, which is passed to an external database DLL.",
            "appliedTo": "Project Data / External Database"
          }
        ]
      },
      "tokens_used": 8623,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script loads and defines Recalc Triggers (Create, Edit, Recalculate, Clean, Remove).",
          "Execution checks if Insert Mode (_bOnInsert) or 'Create a new delivery' context menu is triggered.",
          "[Conditional] If Insert Cycle Count > 1, script self-destructs (erases instance) to prevent duplicates.",
          "Script scans Model Space for Groups acting as deliverable containers (Floor Groups).",
          "Script prompts user for Insertion Point (_Pt0) via Command Line.",
          "Dialog opens asking for Delivery Name and Delivery Description (sNewDeliveryName, sNewDeliveryDescription).",
          "Script iterates through found Floor Groups.",
          "For each Floor Group, a Map is created containing group info and default amount.",
          "Script collects all Elements within the Floor Group.",
          "[Conditional] Check if Element is a Replicated Element (has HSB_E-Replicator or HSB_E-Replica). If yes, skip it.",
          "For valid Elements, a Delivery Item Map is created with Element Number, default amount, and status flags.",
          "Delivery Item Maps are appended to the Delivery Group Map, which is appended to the main Delivery Map.",
          "Script checks for existing 'HSB_G-Delivery' TSL instances attached to the group.",
          "[Conditional] If another instance exists, Warning is issued ('There is already a delivery tsl attached...') and current instance is erased.",
          "Delivery Map is serialized and passed to external DLL (hsbTslDelivery.dll) via callDotNetFunction2.",
          "External DLL processes data and returns an Output Map.",
          "Output Map is stored in the Script's internal _Map under key 'DELIVERY'.",
          "[Conditional] If _bOnInsert, script ends execution here.",
          "Script enters Drawing/Calculation phase (executed on recalc/parameter change).",
          "Display properties (Colors, Dimension Style) are retrieved from properties.",
          "Table dimensions (Row Height, Column Width) are calculated based on text style metrics.",
          "Script draws the Table Header ('HSB_G-Delivery') and Delivery Name/Description.",
          "Script iterates through stored Delivery Groups.",
          "For each Group, Group Name and Amount are drawn.",
          "Script iterates through stored Delivery Items (Elements/Floors).",
          "[Conditional] If 'Hide when amount is 0' is Yes and the calculated quantity is 0, the item is skipped.",
          "Element quantity is updated in the Model (el.setQuantity) based on Delivery Amount.",
          "Delivery Items are sorted alphabetically by Name.",
          "Item rows (Name, Type, Amount) are drawn in the table.",
          "Table grid lines and borders are drawn.",
          "Script finishes drawing."
        ],
        "conditionalBranches": [
          {
            "condition": "Insert Cycle Count > 1",
            "path1": {
              "name": "Duplicate Cycle Detected",
              "steps": [
                "Call eraseInstance()",
                "Return immediately"
              ]
            },
            "path2": {
              "name": "First Cycle",
              "steps": [
                "Proceed to Group Collection"
              ]
            }
          },
          {
            "condition": "Element is Replicated",
            "path1": {
              "name": "Replicated Element",
              "steps": [
                "Skip adding to Delivery Map",
                "Do not draw in table"
              ]
            },
            "path2": {
              "name": "Unique Element",
              "steps": [
                "Add to Delivery Map",
                "Draw in table"
              ]
            }
          },
          {
            "condition": "Existing Delivery Instance Found",
            "path1": {
              "name": "Conflict",
              "steps": [
                "Show Warning: 'There is already a delivery tsl attached to this floorgroup!'",
                "Call eraseInstance()",
                "Return"
              ]
            },
            "path2": {
              "name": "No Conflict",
              "steps": [
                "Proceed to External DLL Call"
              ]
            }
          },
          {
            "condition": "Hide When Zero is 'Yes' AND Quantity is 0",
            "path1": {
              "name": "Hidden Item",
              "steps": [
                "Skip row generation",
                "Continue to next item"
              ]
            },
            "path2": {
              "name": "Visible Item",
              "steps": [
                "Calculate display position",
                "Draw text and grid lines"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Existence of another 'HSB_G-Delivery' script in the current context.",
            "errorMessage": "|There is already a delivery tsl attached to this floorgroup!|",
            "recovery": "Script automatically self-destructs to enforce singleton pattern. User does not need to manually fix, but should ensure they are running the correct instance."
          },
          {
            "check": "Validity of collected Elements.",
            "errorMessage": "None (Internal check).",
            "recovery": "Script checks el.bIsValid() and silently skips invalid elements."
          },
          {
            "check": "Group is a Deliverable Container (bIsDeliverableContainer).",
            "errorMessage": "None (Internal check).",
            "recovery": "Script ignores groups that do not return true for this flag."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit the current delivery",
            "how": "Right-click context menu -> 'Edit the current delivery'",
            "effect": "Likely invokes the external dialog to modify the Name or Description stored in the map, though the specific handler logic is in the external DLL."
          },
          {
            "action": "Recalculate element list",
            "how": "Right-click context menu -> 'Recalculate element list'",
            "effect": "Scans the model for new elements added to floor groups and adds them to the existing delivery map without resetting existing amounts (logic inferred from _kExecuteKey == arSTrigger[2])."
          },
          {
            "action": "Remove current project delivery data",
            "how": "Right-click context menu -> 'Remove current project delivery data'",
            "effect": "Cleans up the project-level data associated with the delivery structure."
          },
          {
            "action": "Remove current delivery",
            "how": "Right-click context menu -> 'Remove current delivery'",
            "effect": "Deletes the TSL instance. History note indicates it sets element amounts to 1 before final deletion to reset quantities."
          },
          {
            "action": "Change Dimension Style",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Regenerates the table using the new text style, recalculating row heights and column widths."
          },
          {
            "action": "Change Color properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Immediate redraw of the table lines and text in the newly selected colors."
          },
          {
            "action": "Toggle 'Hide when amount is 0'",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Filters the visible rows in the generated table."
          }
        ]
      },
      "tokens_used": 9797,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_G-Delivery\n\n## Overview\nGenerates and manages delivery lists (packing lists) for construction projects. It groups elements into specific batches, calculates quantities, and updates element data for production and transport scheduling.\n\n## Usage Environment\n\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script creates a graphical table in the model. |\n| Paper Space | No | This script operates within the 3D model environment. |\n| Shop Drawing | No | This is a global/project management script, not a detailing tool. |\n\n## Prerequisites\n- **Required Entities:**\n  - **Groups:** Floor Groups or similar container groups flagged as deliverable.\n  - **Elements:** Structural timber elements located within those groups.\n- **Minimum Beam Count:** 0\n- **Required Settings:**\n  - `hsbTslDelivery.dll` (Located in `..\\hsbCAD\\Utilities\\hsbDatabase`)\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_G-Delivery.mcr` from the list.\n\n### Step 2: Define Location\n```\nCommand Line: Select a point\nAction: Click in the Model Space where you want the delivery schedule table to appear.\n```\n\n### Step 3: Define Delivery Details\n```\nDialog: Dynamic Input\nAction: Enter the 'Delivery Name' and 'Delivery Description' (e.g., \"Floor 1 - Batch A\").\n```\n*Once confirmed, the script automatically scans the model for Floor Groups and generates the table.*\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimension style | Dropdown | (Current Style) | Selects the text style (font, size) used for the table content. |\n| Color table | Number | -1 (ByLayer) | Sets the color of the table grid lines and borders. Use AutoCAD Color Index (e.g., 1-255). |\n| Color content | Number | 5 (Blue) | Sets the color of the text inside the table. |\n| Hide when amount is '0' | Dropdown | \\|No\\| | Controls visibility. Select \"\\|Yes\\|\" to hide rows where the quantity is zero (e.g., fully delivered items). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Create a new delivery | Opens a dialog to define a new delivery name and description, resetting the list. |\n| Edit the current delivery | Allows you to modify the name or description of the existing delivery. |\n| Recalculate element list | Updates the list to include new elements added to the floor groups since creation. |\n| Remove current project delivery data | Cleans up the specific data associated with this delivery structure. |\n| Remove current delivery | Deletes the script instance and resets element quantities to default (1). |\n\n## Settings Files\n- **Filename**: `hsbTslDelivery.dll`\n- **Location**: `_kPathHsbInstall\\Utilities\\hsbDatabase`\n- **Purpose**: Processes the delivery data structure and handles external database interactions.\n\n## Tips\n- **Location Matters:** Place the table in a clear area of Model Space, as it draws lines and text entities directly.\n- **One Per Group:** If you try to insert a second delivery script on the same Floor Group, the new script will automatically delete itself to prevent conflicts.\n- **Replicated Elements:** The script automatically skips \"Replicated\" elements (e.g., copies made with specific tools) so they aren't counted twice.\n- **Quick Updates:** If you modify the model (add/remove beams), simply right-click the table and choose **Recalculate element list** to update the quantities instantly.\n- **Visual Customization:** You can change the table colors or text size via the Properties Palette without deleting the script.\n\n## FAQ\n\n**Q: Why did the script disappear immediately after I inserted it?**\n**A:** You likely already have an existing delivery script attached to the same Floor Group. To avoid duplicate records, the new instance self-destructs. Locate the existing table to edit it instead.\n\n**Q: Why are some of my elements missing from the list?**\n**A:** The script might be skipping them if they are identified as \"Replicated\" elements (copies), or if they are not inside a Group recognized as a deliverable container. Check your group structure in the model.\n\n**Q: Can I change the text size of the table?**\n**A:** Yes. Select the table, open the Properties palette, and change the **Dimension style** parameter to a text style with your desired height/font.\n\n**Q: What happens if I set \"Hide when amount is '0'\" to Yes?**\n**A:** Any item in the list that has a quantity of zero will not be drawn in the table, making the list shorter and easier to read."
      },
      "tokens_used": 6003,
      "error": null
    }
  }
}