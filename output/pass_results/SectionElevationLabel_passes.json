{
  "filename": "SectionElevationLabel.mcr",
  "status": "completed",
  "total_tokens": 29537,
  "processing_time": 811.4711871147156,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": null,
          "numBeamsReq": null,
          "keywords": [],
          "majorVersion": null,
          "minorVersion": null,
          "dxaOut": null,
          "implInsert": null
        },
        "description": null,
        "versionHistory": [],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 4699,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": true,
          "isMultipageScript": false,
          "detectionEvidence": "The script uses `Section2d` which is the fundamental class for Shop Drawing contexts. It handles `_Entity[0]` which stores the Section/Elevation entity passed from a layout. The insertion logic uses `getSection2d()` and stores it in the entity list, confirming it operates on 2D drawing views."
        },
        "prerequisites": {
          "requiredEntities": [
            "Section2d"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Must be inserted or executed within a Shop Drawing (2D Layout/Section) context.",
          "requiredSettings": []
        }
      },
      "tokens_used": 2284,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialogOnce",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": false
            },
            {
              "step": 2,
              "function": "PrPoint.goJig",
              "promptOriginal": "|Select Point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 0,
            "variable": "psDimstyle",
            "type": "PropString",
            "displayName": "Dimstyle",
            "defaultValue": "_DimStyles",
            "inputType": "dropdown",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 0,
            "variable": "pdTextH",
            "type": "PropDouble",
            "displayName": "Text Height Override",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "pdArrowScale",
            "type": "PropDouble",
            "displayName": "Arrow Scale",
            "defaultValue": "1",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 1,
            "variable": "psNote",
            "type": "PropString",
            "displayName": "Note",
            "defaultValue": "T. O. Beam",
            "inputType": "text",
            "options": [],
            "category": null,
            "description": null
          },
          {
            "index": 2,
            "variable": "pdRefElevation",
            "type": "PropDouble",
            "displayName": "Base/Reference Elevation",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": null,
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 5587,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automates the annotation of elevation points within a section or elevation view, displaying height differences relative to a reference level.",
          "category": "ShopDrawing",
          "typicalUseCase": "Used during detailing to mark top-of-beam or other critical height levels on 2D layout views, ensuring accurate construction communication."
        },
        "parameters": [
          {
            "name": "psDimstyle",
            "technicalDefault": "\"_DimStyles\"",
            "businessMeaning": "Determines the visual style of the text and arrow markers according to the CAD drafting standards.",
            "validRange": "Existing Dimstyle names in the drawing template.",
            "unit": "String",
            "affectsOutput": "Changes the font, line weight, and color used for the elevation label text and arrow geometry."
          },
          {
            "name": "pdTextH",
            "technicalDefault": "0",
            "businessMeaning": "Sets a fixed height for the annotation text. If zero, it defaults to the Dimstyle's defined text size.",
            "validRange": "2.5 to 10 mm (standard text heights) or 0 to use Dimstyle default.",
            "unit": "mm (or drawing units)",
            "affectsOutput": "Directly scales the size of the elevation text string."
          },
          {
            "name": "pdArrowScale",
            "technicalDefault": "1",
            "businessMeaning": "Controls the visual size of the arrow indicator pointing to the elevation mark.",
            "validRange": "0.5 to 2.0 (relative scale)",
            "unit": "Scale factor",
            "affectsOutput": "Scales the arrow geometry and offsets the elevation text horizontally based on this size."
          },
          {
            "name": "psNote",
            "technicalDefault": "\"T. O. Beam\"",
            "businessMeaning": "A custom text label describing the point being marked (e.g., 'T. O. Beam', 'Sill Height').",
            "validRange": "Short alphanumeric strings",
            "unit": "String",
            "affectsOutput": "Displays the note text below the elevation value."
          },
          {
            "name": "pdRefElevation",
            "technicalDefault": "0",
            "businessMeaning": "The base elevation (Z-value) from which the relative height is calculated.",
            "validRange": "Project specific (e.g., finished floor level, sea level)",
            "unit": "mm (or drawing units)",
            "affectsOutput": "Alters the calculated numeric value displayed for the elevation (Displayed Value = Point Z - Reference Z)."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "pdTextH is set to 0",
            "effect": "Text height is derived from the settings defined in psDimstyle.",
            "cascade": [
              "psDimstyle"
            ]
          },
          {
            "trigger": "pdTextH is greater than 0",
            "effect": "Text height is forced to pdTextH, ignoring psDimstyle text settings.",
            "cascade": []
          }
        ],
        "outputEntities": [
          {
            "type": "2D Geometry / Annotation",
            "description": "Creates a visual arrow symbol, elevation text label (+/- value), and a descriptive note string in the 2D Section view.",
            "appliedTo": "PaperSpace / Layout Section2d Entity"
          }
        ]
      },
      "tokens_used": 4114,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script execution begins (Launcher Phase).",
          "Check for 'mpProps' map to restore previous property settings.",
          "Identify Unit system (Metric vs Imperial) for internal scaling.",
          "If inserting (_bOnInsert): Display Properties Dialog (showDialogOnce).",
          "Attach to the active Shop Drawing Section context (getSection2d).",
          "Initiate Point JiggoJig) with prompt 'Select Point'.",
          "[Loop] User moves cursor: Script calculates Model Z from Section 2D point and updates preview.",
          "User confirms point location (Enter/Click).",
          "Script creates a new permanent instance using tsl.dbCreate with current coordinates and properties.",
          "Launcher script self-destructs (eraseInstance).",
          "New Instance activates.",
          "Instance retrieves Section2d entity from _Entity[0].",
          "Instance transforms insertion point from Section coordinates back to Model coordinates.",
          "Instance calculates Elevation: Model Z - Reference Elevation.",
          "Instance determines text height: Uses 'Text Height Override' if > 0, else queries Dimstyle.",
          "Instance generates Geometry: Arrow polyline at insertion point.",
          "Instance renders Annotation: Elevation Text and Note string.",
          "[Check] If Grip map 'iSetGrip' is missing, set initial Note position based on Text Height."
        ],
        "conditionalBranches": [
          {
            "condition": "Check for Property Map (mpProps)",
            "path1": {
              "name": "Map Exists",
              "steps": [
                "Load properties from map",
                "Remove map from memory"
              ]
            },
            "path2": {
              "name": "Map Missing",
              "steps": [
                "Use default property values defined in code"
              ]
            }
          },
          {
            "condition": "Execution State (_bOnInsert)",
            "path1": {
              "name": "Insertion (Launcher)",
              "steps": [
                "Show Dialog",
                "Get Section Context",
                "Run Point Selection Jig",
                "Create Instance",
                "Erase Self"
              ]
            },
            "path2": {
              "name": "Instance / Recalculation",
              "steps": [
                "Extract Section Entity",
                "Calculate Geometry",
                "Draw Annotation"
              ]
            }
          },
          {
            "condition": "Text Height Property (pdTextH)",
            "path1": {
              "name": "Manual Override",
              "steps": [
                "Condition: pdTextH > 0",
                "Use pdTextH value for display"
              ]
            },
            "path2": {
              "name": "Dimstyle Default",
              "steps": [
                "Condition: pdTextH == 0",
                "Query textHeightForStyle from psDimstyle"
              ]
            }
          },
          {
            "condition": "Elevation Sign Calculation",
            "path1": {
              "name": "Positive Elevation",
              "steps": [
                "Condition: Calculated Z >= 0",
                "Prefix string with '+ '"
              ]
            },
            "path2": {
              "name": "Negative Elevation",
              "steps": [
                "Condition: Calculated Z < 0",
                "Prefix string with '- '"
              ]
            }
          },
          {
            "condition": "Grip Initialization (iSetGrip)",
            "path1": {
              "name": "First Run",
              "steps": [
                "Condition: iSetGrip not set (0)",
                "Calculate default grip position (offset Y by 1.5 * TextHeight)",
                "Set iSetGrip to 1"
              ]
            },
            "path2": {
              "name": "Subsequent Runs",
              "steps": [
                "Condition: iSetGrip is set (1)",
                "Keep existing Grip position (Note stays where user moved it)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Section2d Context Availability",
            "errorMessage": "Implicit failure in getSection2d().",
            "recovery": "User must be inside an active Layout/Section view or have a Section entity selected to run the script."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Edit Note Text",
            "how": "OPM Property 'Note'",
            "effect": "Updates the descriptive string (e.g., 'T. O. Beam') drawn below the elevation."
          },
          {
            "action": "Adjust Elevation Reference",
            "how": "OPM Property 'Base/Reference Elevation'",
            "effect": "Changes the base Z-value, causing the displayed elevation number to increase or decrease relative to the fixed point."
          },
          {
            "action": "Move Label",
            "how": "Grip Edit (Base Point)",
            "effect": "Updates the arrow position and recalculates the elevation based on the new location's Model Z-height."
          },
          {
            "action": "Move Note",
            "how": "Grip Edit (Note Grip)",
            "effect": "Moves the Note text to a new location without moving the arrow or changing the elevation calculation."
          },
          {
            "action": "Resize Visuals",
            "how": "OPM Properties 'Text Height Override' / 'Arrow Scale'",
            "effect": "Immediately scales the text size and arrow geometry."
          }
        ]
      },
      "tokens_used": 7194,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# SectionElevationLabel.mcr\n\n## Overview\nThis script automates the annotation of elevation points within shop drawings (Section or Elevation views). It calculates and displays the height difference relative to a reference level (e.g., Finished Floor Level), placing an arrow, the elevation value, and a custom note in the 2D view.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | This script is designed for detailing views. |\n| Paper Space | Yes | Must be used inside an active Layout or view. |\n| Shop Drawing | Yes | Requires an active Section or Elevation entity (`Section2d`) to function. |\n\n## Prerequisites\n- **Required Entities**: An active Section or Elevation view (Section2d).\n- **Minimum Beam Count**: 0 (This script annotates geometry points, not specific beams).\n- **Required Settings**: None (Relies on standard AutoCAD/hsbCAD Dimstyles).\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `SectionElevationLabel.mcr` from the list.\n\n### Step 2: Configure Properties (Optional)\nUpon insertion, a dialog may appear allowing you to preset values (like the Note text or Reference Elevation). You can also change these later in the Properties Palette.\n\n### Step 3: Select Point\n```\nCommand Line: |Select Point|\nAction: Click inside the Section or Elevation view where you want to mark the elevation.\n```\n*Note: The script automatically detects the Model Z-height based on where you click in the 2D view.*\n\n### Step 4: Finalize\nThe script draws the elevation marker at the selected location.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Dimstyle | dropdown | _DimStyles | Selects the visual style (font, color, line type) for the text and arrow from your drawing's dimension styles. |\n| Text Height Override | number | 0 | Sets a specific text height. If set to `0`, the text height defined in the selected Dimstyle is used. |\n| Arrow Scale | number | 1 | Adjusts the size of the arrow marker. (e.g., 1.5 makes the arrow 50% larger). |\n| Note | text | T. O. Beam | A custom description label displayed with the elevation (e.g., \"Sill Height\", \"T.O. Plate\"). |\n| Base/Reference Elevation | number | 0 | The Z-level from which the height is calculated. The displayed value is: `Point Height - Reference Elevation`. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| None | Use the **Grips** (blue squares) to adjust the label position or text location graphically. |\n\n## Settings Files\n- **Filename**: None required.\n- **Location**: N/A\n- **Purpose**: N/A\n\n## Tips\n- **Text Height**: To keep your drawings consistent, leave the **Text Height Override** as `0` and manage text sizes through your **Dimstyle** settings.\n- **Moving Labels**: Select the label to see two grips. Use the base grip (at the arrow tip) to move the marker to a different height (the value updates automatically). Use the secondary grip to drag the text/note to a clearer position without changing the elevation.\n- **Negative Values**: If the calculated elevation is below the Reference Elevation, the script automatically prefixes the value with a minus sign (`-`).\n- **Reference Levels**: If your project uses a non-zero reference (e.g., sea level or a specific floor offset), update the **Base/Reference Elevation** property to ensure the displayed levels are correct relative to that benchmark.\n\n## FAQ\n- **Q: How do I change the elevation from \"3000\" to \"+3000\"?**\n  A: The script adds signs automatically. Ensure the math (Point Z minus Ref Elevation) results in a positive number.\n- **Q: My text is too small to read.**\n  A: You can either increase the **Text Height Override** property or modify the text size in the selected **Dimstyle** in AutoCAD.\n- **Q: Can I use this in Model Space?**\n  A: No, this script is specifically designed to calculate 3D coordinates based on 2D Section/Elevation views found in Paper Space or Shop Drawing contexts."
      },
      "tokens_used": 5659,
      "error": null
    }
  }
}