{
  "filename": "HSB_W-OpeningInformation.mcr",
  "status": "completed",
  "total_tokens": 45442,
  "processing_time": 545.7588708400726,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 7621,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "PaperSpace",
          "supportsPaperSpace": true,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script explicitly prompts to 'Select a viewport' using getViewport() and appends it to _Viewport array. It performs coordinate system transformations between Model Space and Paper Space (ms2ps) and accesses element data via the viewport."
        },
        "prerequisites": {
          "requiredEntities": [
            "Viewport",
            "Element"
          ],
          "minimumBeams": 0,
          "requiredSpace": "The script must be inserted on a layout (Paper Space) and requires the user to select a viewport that is linked to a valid construction element (Wall/Roof).",
          "requiredSettings": []
        }
      },
      "tokens_used": 3947,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getViewport\",\n        \"promptOriginal\": \"Select a viewport\",\n        \"condition\": \"_bOnInsert\",\n        \"required\": true\n      }\n    ],\n    \"keywordOptions\": []\n  },\n  \"dialogs\": [],\n  \"opmProperties\": [\n    {\n      \"index\": 0,\n      \"variable\": \"sSeperator01\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Information|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"separator\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 1,\n      \"variable\": \"sInformationToShow\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Information\",\n      \"defaultValue\": \"|Description|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Description|\",\n        \"|Description| & |Header|\",\n        \"|Description| & |Size|\",\n        \"|None|\"\n      ],\n      \"category\": \"Information\",\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"sCustomText\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Custom text\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"text\",\n      \"options\": [],\n      \"category\": \"Information\",\n      \"description\": null\n    },\n    {\n      \"index\": 2,\n      \"variable\": \"sSeperator02\",\n      \"type\": \"PropString\",\n      \"displayName\": \"|Layout|\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"separator\",\n      \"options\": [],\n      \"category\": null,\n      \"description\": null\n    },\n    {\n      \"index\": 3,\n      \"variable\": \"sDimStyle\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimension style\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [],\n      \"category\": \"Layout\",\n      \"description\": null\n    },\n    {\n      \"index\": 0,\n      \"variable\": \"dTextHeight\",\n      \"type\": \"PropDouble\",\n      \"displayName\": \"Text height\",\n      \"defaultValue\": 0,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Layout\",\n      \"description\": \"|0=Default from dimstyle|\"\n    },\n    {\n      \"index\": 7,\n      \"variable\": \"sDimensionBeamsBesideOpening\",\n      \"type\": \"PropString\",\n      \"displayName\": \"Dimension opening beams\",\n      \"defaultValue\": \"|Yes|\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": \"Layout\",\n      \"description\": \"|This option will take the opening dimensions looking at the beams around the opening. This will take the gap as set in the openingDetails into account.|\"\n    },\n    {\n      \"index\": 4,\n      \"variable\": \"sWithCross\",\n      \"type\": \"PropString\",\n      \"displayName\": \"With cross\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": \"Layout\",\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"sWithFrame\",\n      \"type\": \"PropString\",\n      \"displayName\": \"With frame\",\n      \"defaultValue\": \"\",\n      \"inputType\": \"dropdown\",\n      \"options\": [\n        \"|Yes|\",\n        \"|No|\"\n      ],\n      \"category\": \"Layout\",\n      \"description\": null\n    },\n    {\n      \"index\": 5,\n      \"variable\": \"colorCross\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color cross\",\n      \"defaultValue\": -1,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Layout\",\n      \"description\": null\n    },\n    {\n      \"index\": 6,\n      \"variable\": \"colorDescription\",\n      \"type\": \"PropInt\",\n      \"displayName\": \"Color description\",\n      \"defaultValue\": -1,\n      \"inputType\": \"number\",\n      \"options\": [],\n      \"category\": \"Layout\",\n      \"description\": null\n    },\n   "
      },
      "tokens_used": 8324,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"scriptPurpose\": {\n    \"summary\": \"Annotates 2D layout views (Paper Space) with architectural information regarding wall or roof openings, displaying sizes, descriptions, and visual markers based on the 3D model.\",\n    \"category\": \"ShopDrawing / Annotation\",\n    \"typicalUseCase\": \"Creating production drawings or architectural plans where window and door locations need to be clearly labeled with dimensions, descriptions, and cross indicators directly on the layout sheets.\"\n  },\n  \"parameters\": [\n    {\n      \"name\": \"sInformationToShow\",\n      \"technicalDefault\": \"|Description|\",\n      \"businessMeaning\": \"Controls the level of detail displayed for the opening. It can show the default description, the header material, the nominal dimensions (Width x Height), or nothing.\",\n      \"validRange\": \"[|Description|, |Description| & |Header|, |Description| & |Size|, |None|]\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"Determines what text strings are drawn at the opening centroid and whether the script searches for header beams to retrieve material information.\"\n    },\n    {\n      \"name\": \"sCustomText\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning \"Allows the user to append manual notes to the automatic annotation, such as 'Supplied by Owner' or 'See Detail A'.\",\n      \"validRange\": \"String\",\n      \"unit\": \"text\",\n      \"affectsOutput\": \"Draws additional text at the opening center, vertically offset based on other info settings.\"\n    },\n    {\n      \"name\": \"sDimStyle\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Selects the specific CAD dimension style (text font, arrow style, units) to be used for the annotations in this layout.\",\n      \"validRange\": \"Existing Dimension Styles in the drawing\",\n      \"unit\": \"style\",\n      \"affectsOutput\": \"Sets the visual appearance (font, color) of the text and dimensions via the Display object.\"\n    },\n    {\n      \"name\": \"dTextHeight\",\n      \"technicalDefault\": 0,\n      \"businessMeaning\": \"Overrides the text height defined in the dimension style. A value of 0 forces the use of the dimension style's default height.\",\n      \"validRange\": \">= 0 (Typical drafting values 2.5mm to 5.0mm in model space, or scaled for paper space)\",\n      \"unit\": \"mm (drawing units)\",\n      \"affectsOutput\": \"Scales the size of the text labels drawn on screen.\"\n    },\n    {\n      \"name\": \"sDimensionBeamsBesideOpening\",\n      \"technicalDefault\": \"|Yes|\",\n      \"businessMeaning\": \"Defines whether the opening size is calculated based on the theoretical opening outline or the actual gap between the surrounding structural beams (accounting for clearances and gaps defined in opening details).\",\n      \"validRange\": \"[|Yes|, |No|]\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"If Yes, the script projects rays to find the nearest beam edge, effectively dimensioning the 'rough opening' including any specified gaps, rather than the nominal frame size.\"\n    },\n    {\n      \"name\": \"sWithCross\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Toggles the visibility of a diagonal cross symbol inside the opening, commonly used in architectural drawings to denote a void or window.\",\n      \"validRange\": \"[|Yes|, |No|]\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"If Yes, draws diagonal lines connecting the extents of the opening profile.\"\n    },\n    {\n      \"name\": \"sWithFrame\",\n      \"technicalDefault\": \"\",\n      \"businessMeaning\": \"Toggles the visibility of the opening frame/hide lines in the 2D view.\",\n      \"validRange\": \"[|Yes|, |No|]\",\n      \"unit\": \"enum\",\n      \"affectsOutput\": \"If Yes, generates the outline of the opening body as projected onto the 2D plane.\"\n    },\n    {\n      \"name\": \"colorCross\",\n      \"technicalDefault\": -1,\n      \"businessMeaning\": \"Sets the CAD color index for the diagonal cross lines.\",\n      \"validRange\": \"0-255 (AutoCAD Color Index), -1 for ByLayer/Default\",\n      \"unit\": \"index\",\n      \"affectsOutput\": \"Changes the display color of the cross geometry.\"\n    },\n    {\n      \"name\": \"colorDescription\",\n      \"technicalDefault\": -1,\n      \"businessMeaning\": \"Sets the CAD color index for the text descriptions (labels and dimensions).\",\n      \"validRange\": \"0-255 (AutoCAD Color Index), -1 for ByLayer/Default\",\n      \"unit\": \"index\",\n      \"affectsOutput\": \"Changes the display color of the text entities.\"\n    },\n    {\n      \"name\": \"colorFrame\",\n      \"technicalDefault\": -1,\n      \"businessMeaning\": \"Sets the CAD color index for the frame outline.\",\n      \"validRange\": \"0-255 (AutoCAD Color Index), -1 for ByLayer/Default\",\n      \"unit\": \"index\",\n      \"affectsOutput\": \"Changes the display color of the frame geometry.\"\n    }\n  ],\n  \"parameterDependencies\": [\n    {\n      \"trigger\": \"sInformationToShow includes '|Size|' or '|Header|'\",\n      \"effect\": \"The vertical offset of the 'Custom Text' is adjusted further down to prevent overlap.\",\n      \"cascade\": [\n        \"sCustomText\"\n      ]\n    },\n    {\n      \"trigger\": \"dTextHeight is set to 0\",\n      \"effect\": \"The text height defaults to the settings defined in the selected Dimension Style.\",\n      \"cascade\": [\n        \"sDimStyle\"\n      ]\n    },\n    {\n      \"trigger\": \"sDimensionBeamsBesideOpening is set to '|Yes|'\",\n      \"effect\": \"The opening geometry used for the cross, frame, and size calculation is modified to reflect the gap to the nearest beam rather than the catalog size.\",\n      \"cascade\": [\n        \"sInformationToShow\",\n        \"sWithCross\",\n        \"sWithFrame\"\n      ]\n    }\n  ],\n  \"outputEntities\": [\n    {\n      \"type\": \"Text\",\n      \"description\": \"Annotations displaying opening description, header material, dimensions (WxH), and custom text.\",\n      \"appliedTo\": \"Paper Space Viewport (at transformed opening coordinates).\"\n    },\n    {\n      \"type\": \"PLine / LineSeg\",\n      \"description\": \"Visual markers including diagonal crosses and opening outlines/frames.\",\n      \"appliedTo\": \"Paper Space Viewport.\"\n    }\n  ]\n}\n```"
      },
      "tokens_used": 7859,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script initializes in Paper Space and checks insertion flag.",
          "2. If inserting for the first time (_bOnInsert), user is prompted via command line to select a viewport.",
          "3. Selected viewport is stored in the script instance (_Viewport array).",
          "4. Properties dialog is shown once to configure initial settings.",
          "5. Script executes calculation and rendering phase:",
          "   a. Validates viewport existence (erases instance if missing).",
          "   b. Retrieves the Element linked to the viewport and validates it (exits silently if invalid).",
          "   c. Establishes coordinate systems for Model Space (Element), Paper Space (Viewport), and transformations between them.",
          "   d. Calculates scale factor for display purposes.",
          "   e. Configures Display objects for text, frame, and cross based on OPM properties.",
          "   f. Filters Element beams to identify Header beams.",
          "   g. Iterates through all Opening objects in the Element:",
          "     i. Skips 'OpeningRoof' types.",
          "     ii. Calculates opening geometry and midpoint.",
          "     iii. [Conditional Geometry Adjustment] If 'Dimension opening beams' is Yes, projects rays from edges to find closest beam edges and adjusts the opening profile outline.",
          "     iv. Generates 3D Body for the opening in Paper Space.",
          "     v. [Conditional] Draws Cross lines (diagonals) if 'With cross' is Yes.",
          "     vi. [Conditional] Draws Frame lines (outline) if 'With frame' is Yes.",
          "     vii. [Conditional] Draws Opening Description at center (unless 'None' selected).",
          "     viii. [Conditional] Draws Header Material text if 'Description & Header' selected.",
          "     ix. [Conditional] Draws Dimensions (Width x Height) if 'Description & Size' selected.",
          "     x. Draws Custom Text at the calculated vertical offset."
        ],
        "conditionalBranches": [
          {
            "condition": "Execution Phase",
            "path1": {
              "name": "Insertion Phase",
              "steps": [
                "Prompt user to select viewport",
                "Store viewport reference",
                "Show properties dialog",
                "Return/Exit"
              ]
            },
            "path2": {
              "name": "Calculation/Render Phase",
              "steps": [
                "Retrieve stored viewport",
                "Get linked Element",
                "Process openings and draw geometry"
              ]
            }
          },
          {
            "condition": "Viewport/Element Validity",
            "path1": {
              "name": "Valid Setup",
              "steps": [
                "Proceed to coordinate system setup",
                "Process openings"
              ]
            },
            "path2": {
              "name": "Invalid/Missing Data",
              "steps": [
                "Erase script instance (if no viewport)",
                "Silent exit (if element invalid)"
              ]
            }
          },
          {
            "condition": "sDimensionBeamsBesideOpening (Dimension opening beams)",
            "path1": {
              "name": "Yes (Nearest Beam Logic)",
              "steps": [
                "Calculate edge midpoints of theoretical opening",
                "Cast normal ray towards beams",
                "Find closest beam intersection",
                "Adjust opening profile vertex to reflect beam gap",
                "Use adjusted profile for Cross/Frame/Dimensioning"
              ]
            },
            "path2": {
              "name": "No (Catalog Geometry)",
              "steps": [
                "Use original opening catalog outline",
                "Draw Cross/Frame based on catalog size"
              ]
            }
          },
          {
            "condition": "sInformationToShow (Information Content)",
            "path1": {
              "name": "Description Only",
              "steps": [
                "Draw op.openingDescr() at center",
                "Draw Custom Text at offset -3",
                "No header or size info"
              ]
            },
            "path2": {
              "name": "Description & Header",
              "steps": [
                "Draw op.openingDescr() at center",
                "Iterate Header beams",
                "Draw beam.material() at beam end",
                "Draw Custom Text at offset -3"
              ]
            },
            "path3": {
              "name": "Description & Size",
              "steps": [
                "Draw op.openingDescr() at center",
                "Calculate Width and Height strings",
                "Draw 'WxH' string at offset -3",
                "Draw Custom Text at offset -6 (pushed down)"
              ]
            },
            "path4": {
              "name": "None",
              "steps": [
                "Skip description text",
                "Skip header text",
                "Skip size text",
                "Draw Custom Text at center (offset 0)"
              ]
            }
          },
          {
            "condition": "Layout Options",
            "path1": {
              "name": "Visuals Enabled",
              "steps": [
                "If With Cross: Draw diagonal PLine using colorCross",
                "If With Frame: Draw outline PLine using colorFrame"
              ]
            },
            "path2": {
              "name": "Visuals Disabled",
              "steps": [
                "Skip drawing Cross",
                "Skip drawing Frame"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Viewport Selection",
            "errorMessage": "None (implicit in cancel)",
            "recovery": "User must select a viewport during insert command."
          },
          {
            "check": "Viewport hsbCAD Data Link",
            "errorMessage": "None (Silent exit)",
            "recovery": "User must select a viewport that contains a projection of a valid hsbCAD Element (Wall/Roof)."
          },
          {
            "check": "Opening Type",
            "errorMessage": "None",
            "recovery": "Script automatically skips 'OpeningRoof' types, processing only standard wall openings."
          },
          {
            "check": "Beam Height for Extrusion",
            "errorMessage": "None",
            "recovery": "If Element width is 0, script attempts to use width of the first beam found. If still 0, opening is skipped."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Information Content",
            "how": "OPM (Properties Palette) - Change 'Information' dropdown",
            "effect": "Toggles Description, Header info, Size info, and updates text layout immediately."
          },
          {
            "action": "Adjust Opening Geometry Dimensioning",
            "how": "OPM - Toggle 'Dimension opening beams'",
            "effect": "Switches between catalog opening size and rough opening size (gap to beams). Updates cross and frame outlines."
          },
          {
            "action": "Toggle Visuals",
            "how": "OPM - Toggle 'With cross' or 'With frame'",
            "effect": "Adds or removes diagonal crosses and frame outlines from the view."
          },
          {
            "action": "Modify Text Appearance",
            "how": "OPM - Change 'Dimension style', 'Text height', or 'Color description'",
            "effect": "Updates font, size, and color of all text labels."
          },
          {
            "action": "Edit Custom Text",
            "how": "OPM - Edit 'Custom text' string",
            "effect": "Updates the additional note displayed at the opening center."
          },
          {
            "action": "Move Script Instance",
            "how": "AutoCAD Move/Grips",
            "effect": "Script is anchored to the Viewport. Moving the script in Paper Space generally does not move the annotations because they are calculated relative to the Viewport's coordinate system (ms2ps). However, deleting the script removes annotations."
          }
        ]
      },
      "tokens_used": 9879,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_W-OpeningInformation.mcr\n\n## Overview\nThis script automates the annotation of openings (windows, doors) directly on 2D layout views (Paper Space). It displays dimensions, descriptions, material information, and visual markers based on the 3D model data, ensuring drawings match the current design state.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | No | The script is intended for Layout tabs (Paper Space). |\n| Paper Space | Yes | Select a viewport to link the annotation to the 3D element. |\n| Shop Drawing | No | This is a general annotation script, not a manufacturing layout generator. |\n\n## Prerequisites\n- **Required Entities:** A viewport on a Layout tab that is linked to a valid hsbCAD Element (Wall or Roof).\n- **Minimum Beam Count:** 0 (Depends on the Element linked to the viewport).\n- **Required Settings:** None specific, though a Dimension Style must exist in the drawing for text formatting.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `HSB_W-OpeningInformation.mcr` from the file dialog.\n\n### Step 2: Select Viewport\n```\nCommand Line: Select a viewport\nAction: Click on the viewport in Paper Space that displays the wall or roof containing the openings you wish to annotate.\n```\n*(Note: The script automatically detects the element projected within that viewport.)*\n\n### Step 3: Configure Settings\nThe Properties Palette (OPM) will appear immediately after insertion. Adjust the \"Information\" and \"Layout\" settings as desired.\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **Information** | dropdown | \\|Description\\| | Selects what data is shown: Description only, Description & Header material, Description & Size (WxH), or None. |\n| **Custom text** | text | (empty) | Adds an extra manual note below the opening info (e.g., \"See detail A\"). |\n| **Dimension style** | dropdown | (Current) | Selects the CAD dimension style to control font and arrow formatting for the labels. |\n| **Text height** | number | 0 | Sets the height of the text. Use `0` to use the height defined in the Dimension Style. |\n| **Dimension opening beams** | dropdown | \\|Yes\\| | **Yes:** Calculates size based on the gap to the nearest beams (Rough Opening). **No:** Uses the catalog/nominal size. |\n| **With cross** | dropdown | \\|Yes\\| | Draws diagonal cross lines inside the opening to indicate a void/window. |\n| **With frame** | dropdown | \\|Yes\\| | Draws the outline/frame of the opening. |\n| **Color cross** | number | -1 | Sets the color of the diagonal cross lines (-1 = ByLayer). |\n| **Color description** | number | -1 | Sets the color of the text labels (-1 = ByLayer). |\n| **Color frame** | number | -1 | Sets the color of the opening outline (-1 = ByLayer). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Refreshes the annotations to reflect changes in the 3D model or updated properties. |\n\n## Settings Files\n- **Filename**: None\n- **Location**: N/A\n- **Purpose**: This script relies on standard AutoCAD/hsbCAD Dimension Styles and Element properties, not external XML files.\n\n## Tips\n- **Rough Openings vs. Catalog Sizes:** If you need to dimension the actual space for the carpenter (clearance including gaps), set **Dimension opening beams** to `|Yes|`. This projects rays to find the nearest beam edge. If you need the nominal window/door size, set it to `|No|`.\n- **Text Layout:** If you select \"Description & Size\", the script automatically pushes the \"Custom text\" further down to prevent overlapping with the dimensions.\n- **Roof Openings:** This script automatically skips \"OpeningRoof\" types and focuses on vertical wall openings.\n- **Visibility:** If annotations disappear, check if the linked Element was deleted or if the Viewport was rotated/moved significantly.\n\n## FAQ\n- **Q: Why does the script ask me to select a viewport?**\n  A: The script needs to know which 3D model (Element) to read data from and how to transform those 3D coordinates into the correct position on your 2D drawing sheet.\n- **Q: My text is too small. How do I fix it without changing every script?**\n  A: Set **Text height** to `0` in the script properties. The script will then adopt the text size defined in your selected **Dimension style**, allowing you to control all text globally via CAD standards.\n- **Q: Can I use this on a roof plan?**\n  A: The script primarily targets Wall elements. While it might work on some roofs, it specifically skips \"OpeningRoof\" entities and is optimized for vertical wall views."
      },
      "tokens_used": 7812,
      "error": null
    }
  }
}