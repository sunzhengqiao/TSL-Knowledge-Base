{
  "filename": "HSB_E-Replicator.mcr",
  "status": "completed",
  "total_tokens": 47751,
  "processing_time": 302.773006439209,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 8891,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script filename starts with 'HSB_E-', indicating an Element script. Script uses getElement() and Element type handling. Performs 3D operations like dbCopy() and transformBy(). Explicitly uses _kModelSpace in Group().collectEntities(). No sd_ prefix, _Viewport usage, or #Type E properties found."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element (Main element)",
            "Element(s) (Replicas)"
          ],
          "minimumBeams": 1,
          "requiredSpace": "hsbCAD Model Space",
          "requiredSettings": [
            "Catalog named 'HSB_E-Replicator'",
            "Dimension styles defined in the drawing"
          ]
        }
      },
      "tokens_used": 6874,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "raw_content": "```json\n{\n  \"commandLine\": {\n    \"insertionFlow\": [\n      {\n        \"step\": 1,\n        \"function\": \"getString\",\n        \"promptOriginal\": \"T(\\\"|Specify the input mode.|\\\") + \\\" \\\" + \\\"<\\\" + T(\\\"|Select elements|\\\") + \\\">, \\\" + T(\\\"|Create elements|\\\")\",\n        \"condition\": \"(inputMode == 0) && (_bOnInsert || executeKey == \\\"Add Replica's\\\")\",\n        \"required\": true\n      },\n      {\n"
      },
      "tokens_used": 9616,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Creates and manages multiple identical copies (replicas) of a main timber element, keeping them synchronized for design changes and automatic numbering.",
          "category": "Element Management",
          "typicalUseCase": "Used in projects requiring repeated identical panels, roof cassettes, or floor sections where changes to the 'main' element must propagate to all copies automatically."
        },
        "parameters": [
          {
            "name": "dimStyle",
            "technicalDefault": "_DimStyles",
            "businessMeaning": "Specifies the visual style standard for any dimensions or text annotations generated by the script display.",
            "validRange": "Any dimension style defined in the current CAD drawing",
            "unit": "N/A",
            "affectsOutput": "Controls the text font, arrow style, and scaling of the on-screen display labels."
          },
          {
            "name": "textHeight",
            "technicalDefault": "100 mm",
            "businessMeaning": "Sets the height of the on-screen text labels that display the quantity and mirror status of the replicas.",
            "validRange": "50 mm - 300 mm (depending on plot scale)",
            "unit": "mm",
            "affectsOutput": "Scales the visibility of the information text in the 3D model and model space."
          },
          {
            "name": "seperator",
            "technicalDefault": "-",
            "businessMeaning": "Defines the character(s) placed between the main element's number and the sequence number when naming replica elements.",
            "validRange": "Text characters (e.g., '-', '_', '.', '/')",
            "unit": "String",
            "affectsOutput": "Alters the element number of the replicas (e.g., changing 'W01-1' to 'W01_1')."
          },
          {
            "name": "inputMode",
            "technicalDefault": "1",
            "businessMeaning": "Determines the method of creating replicas: 1 for selecting existing elements, 2 for creating new copies via point/rotation input.",
            "validRange": "1 (Select), 2 (Create)",
            "unit": "Integer",
            "affectsOutput": "Dictates whether the script links existing geometry or generates new geometry based on a base point and rotation."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "Changing 'seperator'",
            "effect": "Updates the Element Number property of all linked replica elements to reflect the new separator syntax.",
            "cascade": [
              "replicatedElement.setNumber()"
            ]
          },
          {
            "trigger": "Executing 'Delete Construction' context menu",
            "effect": "Erases all internal geometry (beams, tools) within the replica elements and re-copies them from the main element.",
            "cascade": [
              "replicatedElement geometry",
              "machining operations"
            ]
          },
          {
            "trigger": "Executing 'Mirror' context menu",
            "effect": "Flips the replica elements geometrically across a defined axis and toggles their mirror state.",
            "cascade": [
              "replicatedElement orientation",
              "IsMirrored flag"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Element (Replica)",
            "description": "A geometric clone of the main element, containing all beams and properties, but positioned uniquely.",
            "appliedTo": "Selected elements or new coordinates in ModelSpace."
          },
          {
            "type": "Element Number",
            "description": "Automatically generated identifier combining the main element number and a sequence index (e.g., WALL-1, WALL-2).",
            "appliedTo": "Each individual replica element."
          },
          {
            "type": "MapX Data",
            "description": "Hidden production attributes linking the replicas to the main element and storing quantity data for BOM/export.",
            "appliedTo": "Main Element and Replica Elements."
          }
        ]
      },
      "tokens_used": 7154,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Initialize script and read execute key (context menu action).",
          "2. Check insert cycle count; abort if > 1 (prevents double execution).",
          "3. Load properties from catalog if specified by execute key.",
          "4. Determine Input Mode (Select existing, Create new, or specific context action).",
          "5. [Condition: Insert or New Parent] Prompt user to select Main Element.",
          "6. Validate Main Element: Check if 'HSB_E-Replicator' is already assigned. If yes, abort and show error.",
          "7. Define Replica Elements:",
          "   a. If 'Create' mode: Loop to get Base Point, Second Point, and Rotation for each new copy. Generate geometry via dbCopy.",
          "   b. If 'Select' mode: Prompt user to select existing elements in model space.",
          "8. Calculate reference geometry (Midpoint, X-axis lines) for mirroring/display.",
          "9. Process Replica Loop:",
          "   a. Retrieve mapping data for each replica.",
          "   b. [Condition: 'Delete Construction'] Erase all internal beams/tools of the replica.",
          "   c. [Condition: 'Mirror'] Toggle mirror state and apply transformation matrix to element.",
          "   d. [Standard Update] Copy entities (beams/tools) from Main Element to Replica.",
          "   e. Update Replica Element Number (MainNumber + Separator + Index).",
          "   f. Copy and transform MapX data from Main to Replica.",
          "10. Update Production Map on Main Element with Replica list and status.",
          "11. Draw visual feedback (Text label, X-lines, outline)."
        ],
        "conditionalBranches": [
          {
            "condition": "Initial Input Mode Selection",
            "path1": {
              "name": "Select Existing Elements",
              "steps": [
                "Prompt user to select elements using selection box.",
                "Append selected elements to Replica list."
              ]
            },
            "path2": {
              "name": "Create New Elements",
              "steps": [
                "Prompt for Base Point.",
                "Prompt for Second Point (displacement).",
                "Prompt for Rotation angle.",
                "Copy Main Element geometry and transform to new location.",
                "Repeat for additional copies."
              ]
            }
          },
          {
            "condition": "Context Menu / Execute Key Action",
            "path1": {
              "name": "Delete Construction",
              "steps": [
                "Identify all entities inside Replica.",
                "Erase beams and tools.",
                "Skip re-copying from Main Element."
              ]
            },
            "path2": {
              "name": "Mirror",
              "steps": [
                "Toggle 'IsMirrored' boolean in map.",
                "Calculate mirroring coordinate system.",
                "Transform Replica geometry."
              ]
            },
            "path3": {
              "name": "Standard Update / Add Replica",
              "steps": [
                "Overwrite Replica geometry with Main Element geometry.",
                "Renumber based on sequence."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Duplicate Replicator Assignment",
            "errorMessage": "Mainelement already has a replicator tsl assigned, please use the custom action: add replicas on that tsl",
            "recovery": "Select the existing Replicator TSL on the main element and use 'Add Replica's' from its context menu, or delete the existing TSL first."
          },
          {
            "check": "Insert Cycle Count",
            "errorMessage": "(None - Silent exit)",
            "recovery": "Script automatically exits to prevent recursion; user should retry action."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Add Replica's",
            "how": "Context Menu (Right-click)",
            "effect": "Prompts to select or create additional elements to be added to the replication list."
          },
          {
            "action": "Mirror",
            "how": "Context Menu (Right-click)",
            "effect": "Flips the geometry of the replica elements across their central axis and updates the 'Mirrored' status."
          },
          {
            "action": "Delete Construction",
            "how": "Context Menu (Right-click)",
            "effect": "Removes all beams and machining from the replica elements, leaving them as empty shells. Main element remains intact."
          },
          {
            "action": "Recalculate All",
            "how": "Context Menu (Right-click)",
            "effect": "Forces a complete overwrite of all replica geometries based on the current state of the Main Element."
          },
          {
            "action": "Lock/Unlock Amount",
            "how": "Context Menu (Right-click)",
            "effect": "Toggles a lock state preventing or allowing changes to the number of replicas (Visual display only in code snippet)."
          },
          {
            "action": "Select new main element",
            "how": "Context Menu (Right-click)",
            "effect": "Allows re-assigning a different element as the master source for the replicas."
          },
          {
            "action": "Modify Seperator",
            "how": "Properties Palette (OPM)",
            "effect": "Updates the naming convention of all replicas immediately (e.g., changes 'WALL-1' to 'WALL_1')."
          }
        ]
      },
      "tokens_used": 9743,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_E-Replicator.mcr\n\n## Overview\nThis script allows you to create and manage multiple identical copies (replicas) of a master timber element. Any design changes made to the main element are automatically propagated to all linked replicas, ensuring consistency across the project.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates exclusively in the 3D model environment. |\n| Paper Space | No | Not intended for layout or detailing views. |\n| Shop Drawing | No | Does not generate 2D outputs directly. |\n\n## Prerequisites\n- **Required Entities:** One Main Element (master) to serve as the source for geometry.\n- **Minimum Beam Count:** The Main Element must contain at least one beam or constructive tool.\n- **Required Settings:** A TSL Catalog entry named `HSB_E-Replicator` must exist in your hsbCAD configuration.\n\n## Usage Steps\n\n### Step 1: Launch Script\n**Command:** `TSLINSERT`\n**Action:** Browse to and select `HSB_E-Replicator.mcr`.\n\n### Step 2: Select Main Element\n**Action:** Click on the timber element in the Model Space that you wish to use as the master (source).\n*Note: If the element already has a Replicator assigned, the script will abort.*\n\n### Step 3: Define Input Mode\n```\nCommand Line: Specify the input mode. <Select elements>, Create elements\nAction: Enter 1 to link existing elements, or Enter 2 to create new geometry.\n```\n\n### Step 4a: If you chose \"Create elements\" (Mode 2)\n```\nCommand Line: Specify base point for replica:\nAction: Click in the model to place the first replica.\n\nCommand Line: Specify second point (displacement):\nAction: Click a second point to determine the direction/distance.\n\nCommand Line: Specify rotation angle <0>:\nAction: Enter an angle or click to set the rotation of the replica.\n```\n*(Repeat for multiple replicas if requested)*\n\n### Step 4b: If you chose \"Select elements\" (Mode 1)\n```\nCommand Line: Select elements:\nAction: Use a selection box to click existing elements in the model that you want to turn into replicas of the Main Element.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| inputMode | Integer | 1 | Determines how replicas are defined: **1** = Select existing elements to link; **2** = Create new geometry interactively. |\n| textHeight | Double | 100 mm | Controls the height of the on-screen text labels (e.g., quantity or mirror status) displayed in the model. |\n| seperator | String | - | The character used between the Main Element number and the replica index (e.g., changing `-` to `_` results in `WALL_1` instead of `WALL-1`). |\n| dimStyle | String | _DimStyles | Specifies the dimension style to be used for any on-screen annotations generated by the script. |\n\n## Right-Click Menu Options\n*(Available after selecting the element and running the script)*\n\n| Menu Item | Description |\n|-----------|-------------|\n| Add Replica's | Prompts you to select or create additional elements and adds them to the list of managed replicas. |\n| Mirror | Flips the geometry of the replica elements across their central axis and updates their status to \"Mirrored\". |\n| Delete Construction | Removes all internal beams and machining from the replica elements, leaving them as empty shells. The Main Element remains untouched. |\n| Recalculate All | Forces a complete overwrite of all replica geometries based on the current state of the Main Element. Useful if replicas become out of sync. |\n| Lock/Unlock Amount | Toggles a lock state that prevents (or allows) changes to the number of replicas processed. |\n| Select new main element | Allows you to re-assign a different element in the model to be the master source for the existing replicas. |\n\n## Settings Files\n- **Catalog Name**: `HSB_E-Replicator`\n- **Location**: TSL Catalog (Company or hsbCAD Install path)\n- **Purpose**: Stores the default property values (text height, separator, etc.) used when the script is first inserted.\n\n## Tips\n- **Avoid Duplication:** Do not insert the script on an element that already has a Replicator assigned. Instead, right-click the existing element and select \"Add Replica's\".\n- **Renaming:** You can globally update the numbering of all replicas by simply changing the `seperator` property in the Properties Palette.\n- **Troubleshooting:** If a replica does not update after you changed the Main Element, right-click the Main Element and select \"Recalculate All\".\n\n## FAQ\n- **Q: Can I use this to create mirrored roof cassettes?**\n  A: Yes. After creating the replicas, use the \"Mirror\" option in the right-click context menu to flip specific copies as needed.\n- **Q: What happens if I delete a beam from the Main Element?**\n  A: The next time the script recalculates (or if you run \"Recalculate All\"), that beam will be automatically deleted from all replicas.\n- **Q: The script gives an error about a \"replicator tsl assigned\". What do I do?**\n  A: This means the element is already a master for another group. You must either delete that TSL instance first or use the \"Add Replica's\" command on the existing script instance."
      },
      "tokens_used": 5473,
      "error": null
    }
  }
}