{
  "filename": "hsbCLT-OpeningRebate.mcr",
  "status": "completed",
  "total_tokens": 50377,
  "processing_time": 754.2214841842651,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9453,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "The script explicitly uses `_kModelSpace` in the `dbCreate` call during insertion. It targets `Sip` entities for geometric modification using tools like `Mortise` and `BeamCut`, which are 3D operations. There are no `sd_` prefixes, `_Viewport` checks, or drawing view manipulations."
        },
        "prerequisites": {
          "requiredEntities": [
            "Sip"
          ],
          "minimumBeams": 1,
          "requiredSpace": "Model Space containing Sip entities (CLT panels).",
          "requiredSettings": []
        }
      },
      "tokens_used": 5802,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "PrEntity",
              "promptOriginal": "Select panel(s)",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "PropertyDialog",
            "trigger": "Insertion (via showDialog)",
            "title": "Properties",
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "sFace",
            "type": "PropString",
            "displayName": "Face",
            "defaultValue": "|Reference Side|",
            "inputType": "dropdown",
            "options": [
              "|Reference Side|",
              "|Opposite Side|"
            ],
            "category": "General",
            "description": null
          },
          {
            "index": 1,
            "variable": "sEdgeMode",
            "type": "PropString",
            "displayName": "Edge Mode",
            "defaultValue": "|all|",
            "inputType": "dropdown",
            "options": [
              "|all|",
              "|not bottom| (-Y)",
              "|not left|(-X)",
              "|not top|(Y)",
              "|not right|(X)",
              "|bottom + top| (-Y+Y)",
              "|left + right|(-X+X)",
              "|bottom|(-Y)",
              "|left|(-X)",
              "|top|(Y)",
              "|right|(X)"
            ],
            "category": "General",
            "description": "|Defines the EdgeMode|"
          },
          {
            "index": 0,
            "variable": "dDepth",
            "type": "PropDouble",
            "displayName": "Depth",
            "defaultValue": "98.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 1",
            "description": "|Defines the Depth|"
          },
          {
            "index": 1,
            "variable": "dWidth",
            "type": "PropDouble",
            "displayName": "Width",
            "defaultValue": "44.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 1",
            "description": "|Defines the Width|"
          },
          {
            "index": 2,
            "variable": "dDepth2",
            "type": "PropDouble",
            "displayName": "Depth ",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 2",
            "description": "|Defines the Depth|"
          },
          {
            "index": 3,
            "variable": "dWidth2",
            "type": "PropDouble",
            "displayName": "Width ",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 2",
            "description": "|Defines the Width|"
          },
          {
            "index": 4,
            "variable": "dRadius",
            "type": "PropDouble",
            "displayName": "Tool Radius",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 1",
            "description": "|Defines the radius of the tool.| |This option will enlarge the tool regarding to the specified value.|  |0 = irrelevant|"
          },
          {
            "index": 5,
            "variable": "dRadius2",
            "type": "PropDouble",
            "displayName": "Tool Radius ",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "Rebate 2",
            "description": "|Defines the radius of the tool.| |This option will enlarge the tool regarding to the specified value.|  |0 = irrelevant|"
          },
          {
            "index": 6,
            "variable": "dMinArea",
            "type": "PropDouble",
            "displayName": "Minimal Area",
            "defaultValue": "0.0",
            "inputType": "number",
            "options": [],
            "category": "Filter",
            "description": "|Defines the mininmal area of an opening to be processed|  |0 = all openings| |A negative value filters any opening being greater, positive values filter smaller openings.|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Flip Side| (|Doubleclick|)",
            "handler": "|Flip Side| (|Doubleclick|)",
            "action": "Toggles the Face property between Reference Side and Opposite Side.",
            "alsoTriggeredBy": "TslDoubleClick"
          },
          {
            "menuItem": "|Stretch tool to panel edge|",
            "handler": "|Stretch tool to panel edge|",
            "action": "Enables stretching of the tool to the panel edge based on the Edge Mode.",
            "alsoTriggeredBy": null
          },
          {
            "menuItem": "|Do not stretch Tool|",
            "handler": "|Do not stretch Tool|",
            "action": "Disables stretching of the tool to the panel edge.",
            "alsoTriggeredBy": null
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 8437,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Automatically applies single or double step rebates (grooves/shoulders) around the perimeter of openings (windows/doors) in CLT panels.",
          "category": "Machining",
          "typicalUseCase": "Creating a weathering seal, pre-installed gasket groove, or seating rebate around window and door cutouts in Cross Laminated Timber panels."
        },
        "parameters": [
          {
            "name": "sFace",
            "technicalDefault": "|Reference Side|",
            "businessMeaning": "Determines which side of the panel the rebate is machined into (front vs back face).",
            "validRange": "Selection List",
            "unit": "N/A",
            "affectsOutput": "Flips the Z-direction of the machining operation through the panel thickness."
          },
          {
            "name": "sEdgeMode",
            "technicalDefault": "|all|",
            "businessMeaning": "Controls which sides of the opening receive the rebate, allowing for partial rebates (e.g., top and bottom only) or extending the cut all the way to the panel edge.",
            "validRange": "Selection List",
            "unit": "N/A",
            "affectsOutput": "Filters which segments of the opening outline are machined."
          },
          {
            "name": "dDepth",
            "technicalDefault": "98.0",
            "businessMeaning": "The depth of the first rebate step measured perpendicular to the panel face (how deep the blade cuts into the timber).",
            "validRange": "0.0 to Panel Thickness",
            "unit": "mm",
            "affectsOutput": "Changes the Z-height of the bottom of the first rebate cut."
          },
          {
            "name": "dWidth",
            "technicalDefault": "44.0",
            "businessMeaning": "The width of the first rebate step measured horizontally from the edge of the opening inwards.",
            "validRange": "0.0 to Panel Dimension",
            "unit": "mm",
            "affectsOutput": "Determines how far back from the opening the first cut extends."
          },
          {
            "name": "dDepth2",
            "technicalDefault": "0.0",
            "businessMeaning": "The depth of the second (optional) rebate step. A value of 0 disables the second rebate.",
            "validRange": "0.0 to (dDepth)",
            "unit": "mm",
            "affectsOutput": "Enables and sets the depth of a secondary inner cut, creating a stepped profile."
          },
          {
            "name": "dWidth2",
            "technicalDefault": "0.0",
            "businessMeaning": "The width of the second (optional) rebate step.",
            "validRange": "0.0 to dWidth",
            "unit": "mm",
            "affectsOutput": "Sets the horizontal distance of the second step from the first step."
          },
          {
            "name": "dRadius",
            "technicalDefault": "0.0",
            "businessMeaning": "Tool radius for corner rounding on the first rebate. If set larger than width, it effectively enlarges the tool width.",
            "validRange": "0.0 to (dWidth / 2)",
            "unit": "mm",
            "affectsOutput": "Rounds the internal corners of the rebate profile and potentially widens the cut path."
          },
          {
            "name": "dRadius2",
            "technicalDefault": "0.0",
            "businessMeaning": "Tool radius for corner rounding on the second rebate step.",
            "validRange": "0.0 to (dWidth2 / 2)",
            "unit": "mm",
            "affectsOutput": "Rounds the internal corners of the second rebate profile."
          },
          {
            "name": "dMinArea",
            "technicalDefault": "0.0",
            "businessMeaning": "Filter to ignore small or large openings during automatic insertion. Positive values filter out smaller openings; negative values filter out larger ones.",
            "validRange": "Any Real Number",
            "unit": "mm²",
            "affectsOutput": "Prevents the TSL instance from being created on openings that do not meet the area criteria."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "dRadius > dWidth",
            "effect": "The effective width of the tool is enlarged to accommodate the radius, potentially increasing the rebate width beyond the specified dWidth.",
            "cascade": [
              "dWidth"
            ]
          },
          {
            "trigger": "dRadius2 > dWidth2",
            "effect": "The effective width of the second tool is enlarged to accommodate the radius.",
            "cascade": [
              "dWidth2"
            ]
          },
          {
            "trigger": "dDepth2 > 0",
            "effect": "Activates the generation of the second rebate step (Double Rebate mode).",
            "cascade": [
              "dWidth2",
              "dRadius2"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "Mortise",
            "description": "Rectilinear or rounded cuts used when specific tooling logic is applied (often when radii are involved).",
            "appliedTo": "Sip (CLT Panel)"
          },
          {
            "type": "BeamCut",
            "description": "Standard planar cuts used for straight rebate segments.",
            "appliedTo": "Sip (CLT Panel)"
          },
          {
            "type": "FreeProfile",
            "description": "Custom profile cuts used for arced or complex geometry segments of the rebate.",
            "appliedTo": "Sip (CLT Panel)"
          }
        ]
      },
      "tokens_used": 9241,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Script Launch",
          "2. Check Insertion Flag (_bOnInsert)",
          "3. [Insertion Branch] Check Insert Cycle Count (>1 results in erase)",
          "4. [Insertion Branch] Check Execution Key for Catalog Entry",
          "5. [Insertion Branch] If no Catalog Key, Show Property Dialog",
          "6. [Insertion Branch] Prompt User to Select Panel(s) (PrEntity)",
          "7. [Insertion Branch] Iterate through selected Panels",
          "8. [Insertion Branch] For each Panel, iterate through Openings",
          "9. [Insertion Branch] Filter Openings by Minimal Area (dMinArea)",
          "10. [Insertion Branch] Calculate Insertion Point (Average of opening vertices)",
          "11. [Insertion Branch] dbCreate TSL Instance on valid Opening",
          "12. [Insertion Branch] Erase Prototype Instance and Exit",
          "13. [Re-calculation Branch] Validate Attached Sip Entity (Erase if invalid)",
          "14. [Re-calculation Branch] Set Coordinate System (Planar or Wall)",
          "15. [Re-calculation Branch] Process Recalc Triggers (Flip Side / Stretch)",
          "16. [Re-calculation Branch] Determine Edge Mode and Stretch Flags",
          "17. [Re-calculation Branch] Generate Rebate 1 Geometry (Iterate Segments)",
          "18. [Re-calculation Branch] Check Double Rebate Condition (dDepth2 > 0)",
          "19. [Re-calculation Branch] [Active] Generate Rebate 2 Geometry",
          "20. [Re-calculation Branch] Add Tools to Panel (BeamCut, Mortise, FreeProfile)"
        ],
        "conditionalBranches": [
          {
            "condition": "Script Mode: Insertion vs. Recalculation",
            "path1": {
              "name": "Insertion Flow",
              "steps": [
                "Check insertCycleCount",
                "Load Catalog or Show Dialog",
                "Select Entities",
                "Filter Openings",
                "Create Instances",
                "Erase Self"
              ]
            },
            "path2": {
              "name": "Recalculation Flow",
              "steps": [
                "Validate Entity",
                "Handle Triggers",
                "Calculate Geometry",
                "Update/Insert Tools"
              ]
            }
          },
          {
            "condition": "Opening Area Filter (dMinArea)",
            "path1": {
              "name": "Opening Valid",
              "steps": [
                "Condition: (dMinArea < 0 AND Area > |dMinArea|) OR (dMinArea > 0 AND Area < dMinArea)",
                "Result: TSL instance is created on the opening"
              ]
            },
            "path2": {
              "name": "Opening Filtered",
              "steps": [
                "Condition: Area does not meet criteria",
                "Result: Loop continues to next opening without creating TSL"
              ]
            }
          },
          {
            "condition": "Double Rebate Activation (dDepth2)",
            "path1": {
              "name": "Active (Two Steps)",
              "steps": [
                "Condition: dDepth2 > 0",
                "Result: Geometry generation runs a second loop using Depth2, Width2, and Radius2"
              ]
            },
            "path2": {
              "name": "Inactive (Single Step)",
              "steps": [
                "Condition: dDepth2 <= 0",
                "Result: Second generation loop is skipped"
              ]
            }
          },
          {
            "condition": "Segment Geometry Type (Straight vs Arc)",
            "path1": {
              "name": "Arc Segment",
              "steps": [
                "Condition: Segment midpoint is not on the definition line",
                "Result: Calculates Bulge and Radius; Uses FreeProfile tool"
              ]
            },
            "path2": {
              "name": "Straight Segment",
              "steps": [
                "Condition: Segment midpoint is on the definition line",
                "Result: Uses Mortise (if Radius > 0) or BeamCut (if Radius == 0)"
              ]
            }
          },
          {
            "condition": "Trigger: Flip Side",
            "path1": {
              "name": "Execute",
              "steps": [
                "Condition: _kExecuteKey == 'Flip Side' or 'TslDoubleClick'",
                "Result: Inverts nFace variable (1 to -1 or vice versa), sets ExecutionLoops(2) to update display"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Entity Attachment",
            "errorMessage": "None (Implicit)",
            "recovery": "Script executes `eraseInstance()` if `_Sip.length() < 1`."
          },
          {
            "check": "Insert Cycle",
            "errorMessage": "None (Implicit)",
            "recovery": "Script executes `eraseInstance()` if `insertCycleCount() > 1` to prevent duplicate insertions."
          },
          {
            "check": "Edge Mode Value",
            "errorMessage": "None (Implicit)",
            "recovery": "If `nEdgeMode < 0`, it resets to 0 (All) and updates the property to the default value."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Flip Side",
            "how": "Context Menu: '|Flip Side| (|Doubleclick|)' or Double Click entity",
            "effect": "Toggles the 'Face' property between Reference Side and Opposite Side, causing the rebate to machine from the opposite face of the panel."
          },
          {
            "action": "Stretch to Edge",
            "how": "Context Menu: '|Stretch tool to panel edge|' or '|Do not stretch Tool|'",
            "effect": "Toggles the 'StretchToEdge' map flag, enabling or disabling the extension of the rebate cuts to the panel boundaries based on the Edge Mode configuration."
          },
          {
            "action": "Modify Properties",
            "how": "AutoCAD Properties Palette (OPM)",
            "effect": "Modifying Dimensions (Depth, Width), Radii, or Edge Mode triggers a recalculation to update the geometry and tooling immediately."
          }
        ]
      },
      "tokens_used": 10751,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbCLT-OpeningRebate.mcr\n\n## Overview\nAutomatically applies single or double step rebates (grooves/shoulders) around the perimeter of openings in CLT panels. Ideal for creating weathering seals, gasket grooves, or seating rebates for windows and doors.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | Script creates 3D machining operations on Sip entities. |\n| Paper Space | No | Not applicable for 2D drawing views. |\n| Shop Drawing | No | This script models physical geometry, not annotations. |\n\n## Prerequisites\n- **Required Entities**: CLT Panels (Sip entities) with existing openings.\n- **Minimum Beam Count**: N/A (Operates on Panels).\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` → Select `hsbCLT-OpeningRebate.mcr`\n\n### Step 2: Select Panel\n```\nCommand Line: Select panel(s)\nAction: Click on the CLT panel(s) containing the openings you wish to process. Press Enter to confirm selection.\n```\n\n### Step 3: Configure Properties\n**Note**: If a default catalog entry is not used, a Properties dialog will appear upon insertion.\n- **Face**: Select whether to machine on the \"Reference Side\" or \"Opposite Side\".\n- **Dimensions**: Set the Depth and Width for the rebate.\n- **Double Rebate**: If a second step is required, enter values for Depth 2 and Width 2 (leave as 0 for single rebate).\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| **General** | | | |\n| Face | dropdown | Reference Side | Determines which side of the panel the rebate is machined into. |\n| Edge Mode | dropdown | all | Defines which edges of the opening are rebated (e.g., all, top only, bottom+top, etc.). |\n| **Rebate 1** | | | |\n| Depth | number | 98.0 | The depth of the first rebate step (perpendicular to the panel face). |\n| Width | number | 44.0 | The width of the first rebate step (inwards from the opening edge). |\n| Tool Radius | number | 0.0 | Defines the radius of the tool. If set > 0, it rounds corners and effectively enlarges the tool width. |\n| **Rebate 2** | | | |\n| Depth | number | 0.0 | The depth of the second rebate step. Set to 0 to disable the second rebate. |\n| Width | number | 0.0 | The width of the second rebate step. |\n| Tool Radius | number | 0.0 | Defines the tool radius for the second rebate step. |\n| **Filter** | | | |\n| Minimal Area | number | 0.0 | Filters openings by area. Positive values ignore openings smaller than this; negative values ignore openings larger than this. |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Flip Side (Doubleclick) | Toggles the rebate to the opposite face of the panel. You can also double-click the script instance to activate this. |\n| Stretch tool to panel edge | Extends the rebate cut all the way to the physical edge of the panel (based on Edge Mode settings). |\n| Do not stretch Tool | Restricts the rebate to the immediate perimeter of the opening only. |\n\n## Settings Files\nNo specific external settings files are required for this script.\n\n## Tips\n- **Double Rebates**: To create a two-step machining profile, ensure `Rebate 2 > Depth` is set to a value greater than 0.\n- **Filtering Small Holes**: Use the `Minimal Area` property to prevent the script from running on small service holes (e.g., for pipes or cables) that do not need a rebate.\n- **Tool Radius Impact**: If you specify a Tool Radius that is larger than half the Width, the tool path will be widened to accommodate the radius size.\n- **Partial Rebates**: Use the Edge Mode dropdown to machine only specific sides of an opening (e.g., `|bottom + top|`) rather than the entire perimeter.\n\n## FAQ\n- **Q: How do I switch the rebate from the inside face to the outside face?**\n  A: Double-click the script instance in the model, or right-click and select \"Flip Side\".\n- **Q: Why is the second rebate not appearing?**\n  A: Ensure the property `Rebate 2 > Depth` is set to a value greater than 0.0.\n- **Q: Can I apply this to multiple panels at once?**\n  A: Yes, during the insertion step (\"Select panel(s)\"), you can select multiple CLT panels, and the script will iterate through valid openings on all of them."
      },
      "tokens_used": 6693,
      "error": null
    }
  }
}