{
  "filename": "hsbLathMarking.mcr",
  "status": "completed",
  "total_tokens": 41515,
  "processing_time": 226.6750841140747,
  "passes": {
    "1": {
      "success": true,
      "data": {
        "header": {
          "type": "",
          "numBeamsReq": 0,
          "keywords": [],
          "majorVersion": 0,
          "minorVersion": 0,
          "dxaOut": 0,
          "implInsert": 0
        },
        "description": "",
        "versionHistory": [
          {
            "version": "1.1",
            "date": "05.07.2022",
            "author": "Thorsten Huck",
            "changes": "HSB-15867 bugfix new in line when drawing info text"
          },
          {
            "version": "1.0",
            "date": "30jun2020",
            "author": "thorsten.huck@hsbcad.com",
            "changes": "initial"
          }
        ],
        "settingsFiles": [],
        "dependencies": []
      },
      "tokens_used": 7382,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Variable 'bForceModelSpace' is explicitly set to true in the script. Insertion is performed using _XW and _YW coordinate systems which are standard for Model Space. The script operates on ElementRoof entities and adds ElemMarker objects to the element (3D model data), rather than creating 2D drawing views or annotations."
        },
        "prerequisites": {
          "requiredEntities": [
            "ElementRoof"
          ],
          "minimumBeams": 0,
          "requiredSpace": "Model Space",
          "requiredSettings": []
        }
      },
      "tokens_used": 5284,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": "Select properties or catalog entry and press OK, then select roofelements",
              "condition": "_bOnInsert && !_kExecuteKey",
              "required": true
            },
            {
              "step": 2,
              "function": "PrEntity",
              "promptOriginal": "|Select element(s)|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [
          {
            "type": "showDialog",
            "trigger": "Insertion",
            "title": null,
            "dataSource": "Internal Properties",
            "features": {
              "searchable": false,
              "multiSelect": false
            }
          }
        ],
        "opmProperties": [
          {
            "index": 0,
            "variable": "nZoneDef",
            "type": "PropInt",
            "displayName": "|Defining Zone|",
            "defaultValue": 10,
            "inputType": "dropdown",
            "options": [
              -5,
              -4,
              -3,
              -2,
              -1,
              0,
              1,
              2,
              3,
              4,
              5
            ],
            "category": "|Tool|",
            "description": "|Defines the Marker Zone|"
          },
          {
            "index": 1,
            "variable": "nZone",
            "type": "PropInt",
            "displayName": "|Marking Zone|",
            "defaultValue": 0,
            "inputType": "dropdown",
            "options": [
              -5,
              -4,
              -3,
              -2,
              -1,
              0,
              1,
              2,
              3,
              4,
              5
            ],
            "category": "|Tool|",
            "description": null
          },
          {
            "index": 2,
            "variable": "nToolingIndex",
            "type": "PropInt",
            "displayName": "|Tooling Index|",
            "defaultValue": 1,
            "inputType": "number",
            "options": [],
            "category": "|Tool|",
            "description": "|Defines the Tooling Index|"
          },
          {
            "index": 0,
            "variable": "dMaxWidth",
            "type": "PropDouble",
            "displayName": "|Max. Width|",
            "defaultValue": "0",
            "inputType": "number",
            "options": [],
            "category": "|Element|",
            "description": "|Defines the maximal width of the element.|, |0 = any width|"
          }
        ],
        "contextMenu": [
          {
            "menuItem": "|Edit in Place|",
            "handler": "../|Edit in Place|",
            "action": "Toggles edit mode to allow modification of single marking instances or returns to batch generation.",
            "alsoTriggeredBy": "Double-click"
          }
        ],
        "settingsFiles": []
      },
      "tokens_used": 5983,
      "error": null
    },
    "4": {
      "success": true,
      "data": {
        "scriptPurpose": {
          "summary": "Projects the location of laths or beams from one construction zone onto a structural layer in another zone as machine markers or layout lines.",
          "category": "ShopDrawing / Machining",
          "typicalUseCase": "Marking rafter positions on top plates, or projecting lath locations onto rafters/timbers for nailing guides or machining operations."
        },
        "parameters": [
          {
            "name": "nZoneDef",
            "technicalDefault": "10",
            "businessMeaning": "The 'Source' Zone. This identifies the layer (e.g., laths or battens) whose position determines where the marks are drawn.",
            "validRange": "-5 to 5",
            "unit": "Zone Index",
            "affectsOutput": "Changes the origin of the projection lines. The script takes the centerline or edge of beams in this zone to generate the mark geometry."
          },
          {
            "name": "nZone",
            "technicalDefault": "0",
            "businessMeaning": "The 'Target' Zone. This identifies the layer (e.g., rafters or top chords) that will physically receive the markings.",
            "validRange": "-5 to 5",
            "unit": "Zone Index",
            "affectsOutput": "Determines which surface the lines are projected onto and to which zone index the `ElemMarker` is assigned."
          },
          {
            "name": "nToolingIndex",
            "technicalDefault": "1",
            "businessMeaning": "The Machine Identifier for the mark. Assigns a specific tool or instruction code to the generated line for the CNC machine or CAM export.",
            "validRange": "1 to 9999",
            "unit": "Integer ID",
            "affectsOutput": "Does not change geometry, but changes how the machine interprets the mark (e.g., scribe vs. drill vs. label)."
          },
          {
            "name": "dMaxWidth",
            "technicalDefault": "0",
            "businessMeaning": "Maximum Element Width Filter. Prevents the script from running on elements wider than this value.",
            "validRange": "0 (any width) to max element width",
            "unit": "mm",
            "affectsOutput": "If the element width exceeds this value, the script deletes itself and produces no markings. Used to restrict the tool to specific modular widths."
          }
        ],
        "parameterDependencies": [
          {
            "trigger": "nZoneDef and nZone selection",
            "effect": "The script validates that the Defining Zone is not identical to the Marking Zone and that the Defining Zone is logically positioned 'above' (higher index) than the Marking Zone based on the script's error trapping logic.",
            "cascade": [
              "nZone",
              "nZoneDef"
            ]
          },
          {
            "trigger": "Successful Insertion",
            "effect": "The `dMaxWidth` value is reset to 0 (read-only in code logic) after the initial check to allow the element to change size later without auto-deleting, though initial validation remains strict.",
            "cascade": [
              "dMaxWidth"
            ]
          }
        ],
        "outputEntities": [
          {
            "type": "ElemMarker",
            "description": "Projected line segments representing the intersection of the defining beams projected onto the surface of the marking zone beams.",
            "appliedTo": "The selected ElementRoof (assigned specifically to the beams in the 'nZone' layer)."
          }
        ]
      },
      "tokens_used": 7496,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "Script launched via command or catalog entry.",
          "Check if `_bOnInsert` is true.",
          "If Inserting: Check `insertCycleCount()`. If > 1, exit.",
          "If Inserting: Determine if running silently (`_kExecuteKey` exists) or via Standard Dialog.",
          "If Silent: Load properties from catalog specified by `_kExecuteKey` (or last inserted).",
          "If Standard: Show `showDialog` for user to set properties (Defining Zone, Marking Zone, Tooling Index, Max Width).",
          "Prompt user to select `ElementRoof` entities (`PrEntity`).",
          "Iterate through selected elements.",
          "For each element, create a new TSL instance attached to the element (`dbCreate`).",
          "Erase the temporary insertion instance.",
          "Instance Calculation (`_bOnInsert` false): Validate attached `_Element` exists and is `ElementRoof`.",
          "Read OPM properties (`nZoneDef`, `nZone`, `nToolingIndex`, `dMaxWidth`).",
          "Validate Element Size: Check if width > `dMaxWidth`. If so, error and delete instance.",
          "Validate Zones: Check if Defining Zone == Marking Zone. If so, error.",
          "Validate Zones: Check if Defining Zone is 'above' (higher index) than Marking Zone relative to 0. If so, error.",
          "If validation error triggered by property change: Restore previous properties from Map and recalc.",
          "Collect Defining Beams (`GenBeam` from `nZoneDef`).",
          "Collect Marking Beams (`GenBeam` from `nZone`).",
          "Check if beams exist. If missing, display 'waiting for construction' text or error.",
          "Check Edit In Place status via Map (`directEdit`).",
          "If in Batch Mode (`_GenBeam` empty):",
          "   Calculate projection of Defining Beams onto Marking Beams.",
          "   Generate `ElemMarker` objects on the element for all projected lines.",
          "   Store properties to Map for crash recovery.",
          "If in Edit Mode (`_GenBeam` has 2 beams):",
          "   Calculate projection specifically for the selected pair.",
          "   Display Grip Points on the single projected line.",
          "   Update `ElemMarker` based on moved Grip Points.",
          "   Store properties."
        ],
        "conditionalBranches": [
          {
            "condition": "Element Width > dMaxWidth",
            "path1": {
              "name": "Validation Fail",
              "steps": [
                "Report error message ('The width of element X exceeds...')",
                "Erase script instance.",
                "Stop execution."
              ]
            },
            "path2": {
              "name": "Validation Pass",
              "steps": [
                "If `dMaxWidth` was > 0, reset `dMaxWidth` to 0 (allow future width changes).",
                "Proceed to Zone validation."
              ]
            }
          },
          {
            "condition": "Property Change causing Validation Error (Zone mismatch or Index logic)",
            "path1": {
              "name": "User Edit Property",
              "steps": [
                "Detect invalid state.",
                "Check if triggered by property change (`_kNameLastChangedProp`).",
                "Restore previous property values from stored Map.",
                "Request recalculation (`setExecutionLoops(2)`)."
              ]
            },
            "path2": {
              "name": "Initial Load",
              "steps": [
                "Detect invalid state.",
                "Report error.",
                "Erase script instance."
              ]
            }
          },
          {
            "condition": "Context Menu 'Edit in Place' or Double Click",
            "path1": {
              "name": "Enter Edit Mode",
              "steps": [
                "User triggers 'Edit in Place'.",
                "Save current properties to catalog ('LastInserted').",
                "Toggle 'directEdit' flag in Map.",
                "Request recalculation."
              ]
            },
            "path2": {
              "name": "Exit to Batch Mode",
              "steps": [
                "User triggers 'Edit in Place' again.",
                "Toggle 'directEdit' flag off.",
                "Request recalculation.",
                "Return to generating all markings for the element."
              ]
            }
          },
          {
            "condition": "Beam Availability (Defining vs Marking)",
            "path1": {
              "name": "Missing Beams",
              "steps": [
                "Check if `nZoneDef` or `nZone` beams exist.",
                "If missing and initial load: Erase instance.",
                "If missing and property change: Restore previous values.",
                "If missing but valid zones: Draw 'waiting for construction' text in 3D."
              ]
            },
            "path2": {
              "name": "Beams Found",
              "steps": [
                "Proceed to geometry calculation (Projection)."
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Element Width vs Max Width",
            "errorMessage": "The width of element [Number] exceeds the maximal width of [MaxWidth] ([ActualWidth])",
            "recovery": "Reduce element width or increase Max Width property before insertion."
          },
          {
            "check": "Zone Identity",
            "errorMessage": "the defining and the marking zone may not be identical.",
            "recovery": "Change either 'Defining Zone' or 'Marking Zone' to a different index in OPM."
          },
          {
            "check": "Zone Hierarchy (Logic: Defining must be above Marking)",
            "errorMessage": "the defining zone may not be above the marking zone.",
            "recovery": "Ensure `nZoneDef` is less than `nZone` if both negative, or `nZoneDef` is greater than `nZone` if positive (Standard Z-axis direction logic applied)."
          },
          {
            "check": "Element Reference",
            "errorMessage": "could not find reference to element.",
            "recovery": "Re-run script and ensure a valid ElementRoof is selected."
          },
          {
            "check": "Construction Readiness",
            "errorMessage": "No defining and marking entities found.",
            "recovery": "Ensure the selected ElementRoof has generated beams in the specified zones."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Change Tooling Index",
            "how": "OPM Properties Palette",
            "effect": "Updates the numeric ID associated with the existing `ElemMarker` lines (e.g., changing machine operation from Scribe to Cut)."
          },
          {
            "action": "Edit in Place",
            "how": "Right-click Context Menu or Double-Click",
            "effect": "Explodes the batch markings into a single editable instance. Displays a grip point on the specific line. Allows dragging the line along the beam. Re-calculates projection based on new position."
          },
          {
            "action": "Modify Zones",
            "how": "OPM Properties Palette",
            "effect": "If valid, re-calculates all projection lines based on new source/ target layers. If invalid (e.g., zone mismatch), restores previous settings."
          },
          {
            "action": "Element Geometry Change",
            "how": "Modify ElementRoof dimensions",
            "effect": "Script re-runs automatically. If width was checked on insert (`dMaxWidth`), subsequent width changes are allowed (unless new logic is added). Projections update to new beam positions."
          }
        ]
      },
      "tokens_used": 8897,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# hsbLathMarking\n\n## Overview\nProjects the location of beams or laths from one construction zone (source) onto another zone (target) as machine markers or layout lines. This is typically used to project rafter or lath positions onto underlying structural layers for machining or assembly guides.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | This script operates on 3D model elements (ElementRoof). |\n| Paper Space | No | Not applicable for 2D drawings. |\n| Shop Drawing | No | Generates 3D marker data only. |\n\n## Prerequisites\n- **Required Entities**: An `ElementRoof` containing generated beams in at least two different zones.\n- **Minimum Beams**: Beams must exist in both the Source (Defining) and Target (Marking) zones.\n- **Required Settings**: None.\n\n## Usage Steps\n\n### Step 1: Launch Script\nCommand: `TSLINSERT` â†’ Select `hsbLathMarking.mcr`\n\n### Step 2: Configure Properties\n```\nCommand Line: Select properties or catalog entry and press OK, then select roofelements\nAction: A dialog appears. Set the Source Zone (Defining), Target Zone (Marking), and Tooling Index. Click OK to confirm.\n```\n\n### Step 3: Select Elements\n```\nCommand Line: Select element(s)\nAction: Click on the desired ElementRoof entities in the model view. Press Enter to finish selection and generate the markings.\n```\n\n## Properties Panel Parameters\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Defining Zone | dropdown | 10 | The \"Source\" zone containing the beams whose positions you want to project (e.g., laths). |\n| Marking Zone | dropdown | 0 | The \"Target\" zone that will receive the projected marks (e.g., rafters or top plates). |\n| Tooling Index | number | 1 | The machine identifier code (CNC/CAM) assigned to the generated marker lines. |\n| Max. Width | number | 0 | Restricts the script to elements with a width less than or equal to this value (0 = any width). |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Edit in Place | Toggles \"Edit Mode\". When active, allows you to select and modify individual projection lines using grip points. When inactive, the script automatically calculates markings for the whole element. |\n\n## Settings Files\n- **Filename**: None specific.\n- **Location**: N/A\n- **Purpose**: Uses internal script maps to store \"LastInserted\" settings and temporary edit states.\n\n## Tips\n- **Validation**: The script will automatically delete itself if the element width exceeds the \"Max. Width\" value or if the Defining and Marking Zones are set to the same index.\n- **Zone Hierarchy**: Ensure your Defining Zone is logically positioned relative to the Marking Zone to avoid \"Defining zone may not be above marking zone\" errors.\n- **Fine-tuning**: Use the \"Edit in Place\" function to adjust specific marker lines that might intersect with obstacles or require manual tweaking.\n\n## FAQ\n- **Q: Why did the script disappear after I inserted it?**\n  **A:** Check the command line for an error. This usually happens if the element width is larger than the \"Max. Width\" setting, or if the selected zones do not contain any beams yet.\n- **Q: Can I change the machine operation after creating the marks?**\n  **A:** Yes. Select the element, open the Properties Palette, and change the \"Tooling Index\" value. The markers will update to the new ID.\n- **Q: How do I move just one mark?**\n  **A:** Right-click the element and select \"Edit in Place\". Select the specific line you wish to move and use the blue grip point to slide it along the beam."
      },
      "tokens_used": 6473,
      "error": null
    }
  }
}