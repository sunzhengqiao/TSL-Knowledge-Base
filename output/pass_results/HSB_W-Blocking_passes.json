{
  "filename": "HSB_W-Blocking.mcr",
  "status": "completed",
  "total_tokens": 51573,
  "processing_time": 342.9117305278778,
  "passes": {
    "1": {
      "success": true,
      "data": {},
      "tokens_used": 9513,
      "error": null
    },
    "2": {
      "success": true,
      "data": {
        "usageEnvironment": {
          "primarySpace": "ModelSpace",
          "supportsPaperSpace": false,
          "isShopDrawingScript": false,
          "isMultipageScript": false,
          "detectionEvidence": "Script uses getElement() and getPoint() for 3D user interaction. It creates GenBeam entities using dbCreate() and performs 3D boolean operations (BeamCut, addToolStatic) on Element bodies. No 'sd_' or 'Multipage' prefixes, no viewport handling, and no ShopDrawing (#Type E) structures."
        },
        "prerequisites": {
          "requiredEntities": [
            "Element",
            "GenBeam"
          ],
          "minimumBeams": 2,
          "requiredSpace": "3D Model Space within an Element context",
          "requiredSettings": [
            "HSB_G-FilterGenBeams.mcr (Required for filtering logic)",
            "HSB_T-IntegratedTooling.mcr (Required if integrated tooling catalog is specified)"
          ]
        }
      },
      "tokens_used": 7308,
      "error": null
    },
    "3": {
      "success": true,
      "data": {
        "commandLine": {
          "insertionFlow": [
            {
              "step": 1,
              "function": "showDialog",
              "promptOriginal": null,
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 2,
              "function": "getElement",
              "promptOriginal": "|Select an element|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 3,
              "function": "getPoint",
              "promptOriginal": "|Select start point|",
              "condition": "_bOnInsert",
              "required": true
            },
            {
              "step": 4,
              "function": "PrPoint",
              "promptOriginal": "|Select end point|",
              "condition": "_bOnInsert",
              "required": true
            }
          ],
          "keywordOptions": []
        },
        "dialogs": [],
        "opmProperties": [
          {
            "index": 9,
            "variable": "sFilterBC",
            "type": "PropString",
            "displayName": "|Filter beams with beamcode|",
            "defaultValue": "",
            "inputType": "text",
            "options": [],
            "category": "|Filter|",
            "description": null
          },
          {
            "index": 12,
            "variable": "genBeamFilterDefinition",
            "type": "PropString",
            "displayName": "|Filter definition|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": "|Filter|",
            "description": "|Filter definition for GenBeams.| (|Will be combined with custom filters|)|Use| HSB_G-FilterGenBeams |to define the filters|."
          },
          {
            "index": 0,
            "variable": "dBmW",
            "type": "PropDouble",
            "displayName": "|Beam width|",
            "defaultValue": 45,
            "inputType": "number",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 1,
            "variable": "dBmH",
            "type": "PropDouble",
            "displayName": "|Beam height|",
            "defaultValue": 170,
            "inputType": "number",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 1,
            "variable": "sSide",
            "type": "PropString",
            "displayName": "|Side|",
            "defaultValue": "|Front|",
            "inputType": "dropdown",
            "options": [
              "|Front|",
              "|Back|"
            ],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 2,
            "variable": "sMaterial",
            "type": "PropString",
            "displayName": "|Material|",
            "defaultValue": "C14",
            "inputType": "text",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 11,
            "variable": "sName",
            "type": "PropString",
            "displayName": "|Name|",
            "defaultValue": "Blocking",
            "inputType": "text",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 2,
            "variable": "dMinLengthBm",
            "type": "PropDouble",
            "displayName": "|Minimum blocking length|",
            "defaultValue": 40,
            "inputType": "number",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 4,
            "variable": "gap",
            "type": "PropDouble",
            "displayName": "|Gap|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Blocking|",
            "description": null
          },
          {
            "index": 4,
            "variable": "sReferencePoint",
            "type": "PropString",
            "displayName": "|Reference point|",
            "defaultValue": "|Bottom| (up)",
            "inputType": "dropdown",
            "options": [
              "|Bottom| (up)",
              "|Middle| (up)",
              "|Top| (down)"
            ],
            "category": "|Positioning|",
            "description": null
          },
          {
            "index": 10,
            "variable": "sOffsetFromReferencePoint",
            "type": "PropString",
            "displayName": "|Offset from reference point|",
            "defaultValue": "0",
            "inputType": "text",
            "options": [],
            "category": "|Positioning|",
            "description": "|Multiple positions can be specified|.|Use| ';' |as a seperator|"
          },
          {
            "index": 3,
            "variable": "dRotationAngle",
            "type": "PropDouble",
            "displayName": "|Rotation|",
            "defaultValue": 0,
            "inputType": "number",
            "options": [],
            "category": "|Positioning|",
            "description": null
          },
          {
            "index": 6,
            "variable": "sType",
            "type": "PropString",
            "displayName": "|Type|",
            "defaultValue": "|Blocking|",
            "inputType": "dropdown",
            "options": [
              "|Blocking|",
              "|Integrated beam|"
            ],
            "category": "|Style|",
            "description": null
          },
          {
            "index": 7,
            "variable": "sDrawLine",
            "type": "PropString",
            "displayName": "|Draw line|",
            "defaultValue": "|Yes|",
            "inputType": "dropdown",
            "options": [
              "|Yes|",
              "|No|"
            ],
            "category": "|Style|",
            "description": null
          },
          {
            "index": 13,
            "variable": "integratedToolingCatalog",
            "type": "PropString",
            "displayName": "|Integrated tooling catalog|",
            "defaultValue": "",
            "inputType": "dropdown",
            "options": [],
            "category": "|Style|",
            "description": null
          }
        ],
        "contextMenu": [],
        "settingsFiles": []
      },
      "tokens_used": 8983,
      "error": null
    },
    "4": {
      "success": true,
      "data": {},
      "tokens_used": 9052,
      "error": null
    },
    "5": {
      "success": true,
      "data": {
        "workflowDiagram": [
          "1. Launch Script (Insert or Edit)",
          "2. [Conditional - Insert] Check cycle count. If > 1, erase instance and exit.",
          "3. [Conditional - Insert] If ExecuteKey is empty, show Dialog.",
          "4. [Conditional - Insert] Prompt user to select an Element.",
          "5. [Conditional - Insert] Prompt user to select Start Point.",
          "6. [Conditional - Insert] Loop prompt for End Point until valid.",
          "7. Store Element and Points, Exit insert cycle.",
          "8. Check if Element and Grip Points exist. If missing, erase instance.",
          "9. Parse User Properties (Dimensions, Materials, Filters, Offsets).",
          "10. Delete any existing blocking beams associated with this script instance.",
          "11. Gather all GenBeams from the Element.",
          "12. [Conditional] Filter GenBeams based on BeamCode and Filter Definition.",
          "13. Filter results to include only Zone 0 beams.",
          "14. Generate a unified body of all Zone 0 beams to determine bounding geometry.",
          "15. Calculate Bottom, Middle, and Top reference points based on geometry.",
          "16. Iterate through user-defined offset positions.",
          "17. [Conditional] Calculate Reference Point based on Property (Bottom/Middle/Top) + Offset.",
          "18. Project Start and End points onto the calculated reference plane.",
          "19. Identify intersecting beams (Left and Right) along the blocking vector.",
          "20. [Conditional] Check for valid intersecting beams. If none found, report warning and continue to next offset.",
          "21. Calculate gaps and intervals between intersecting beams.",
          "22. Iterate through calculated intervals.",
          "23. [Conditional] Check Minimum Length property. If length < min, skip interval.",
          "24. [Conditional] Check Element Openings. If interval center is inside an opening, skip interval.",
          "25. Create Blocking GenBeam entity at calculated interval.",
          "26. Apply material, name, layer, and beam code.",
          "27. Add Cut tools to the blocking beam ends (incorporating 'Gap' property).",
          "28. [Conditional - Integrated Tooling] If Type is 'Integrated beam':",
          "   28a. Check for 'Integrated tooling catalog'.",
          "   28b. [Path A] If Catalog specified: Run HSB_T-IntegratedTooling script to modify intersecting beams.",
          "   28c. [Path B] If Catalog empty: Perform standard BeamCut boolean operation on intersecting beams.",
          "29. Complete script execution."
        ],
        "conditionalBranches": [
          {
            "condition": "Script Execution State (Insert vs Recalc)",
            "path1": {
              "name": "Insertion Mode",
              "steps": [
                "Check cycle count",
                "Show Dialog (if needed)",
                "Select Element",
                "Select Start Point",
                "Select End Point"
              ]
            },
            "path2": {
              "name": "Recalculation/Edit Mode",
              "steps": [
                "Validate stored data",
                "Read Properties from OPM",
                "Re-run geometry generation logic"
              ]
            }
          },
          {
            "condition": "Type Property",
            "path1": {
              "name": "Standard Blocking",
              "steps": [
                "Create physical beam body",
                "Apply cuts to ends",
                "Do not modify surrounding structure"
              ]
            },
            "path2": {
              "name": "Integrated Beam",
              "steps": [
                "Calculate full span (ignoring intermediate gaps)",
                "Modify intersecting beams",
                "Sub-branch: Use Catalog TSL vs Standard Boolean Cut"
              ]
            }
          },
          {
            "condition": "Filter Results",
            "path1": {
              "name": "Beams Found",
              "steps": [
                "Calculate intersection planes",
                "Generate blocking"
              ]
            },
            "path2": {
              "name": "No Beams Found",
              "steps": [
                "Report Warning",
                "Exit Script (Erase Instance)"
              ]
            }
          }
        ],
        "validationRules": [
          {
            "check": "Insertion cycle count",
            "errorMessage": "N/A (Silent fail)",
            "recovery": "Script erases itself if run multiple times in a single insert command."
          },
          {
            "check": "Element and Point selection",
            "errorMessage": "N/A",
            "recovery": "Script erases instance if Element (_Element) or Grip Points (_PtG) are missing on recalculation."
          },
          {
            "check": "Reference Points Calculation",
            "errorMessage": "TSL is not able to calculate the reference points. Not enough points found.",
            "recovery": "Check that sufficient Zone 0 beams exist in the element to define height/width bounds. Script erases itself."
          },
          {
            "check": "Start/End Position Calculation",
            "errorMessage": "Startposition cannot be calculated. OR Endposition cannot be calculated.",
            "recovery": "Ensure the line defined by Start/End points actually intersects structural beams in the element."
          },
          {
            "check": "Minimum Blocking Length",
            "errorMessage": "N/A",
            "recovery": "Blocking segments shorter than the 'Minimum blocking length' property are automatically skipped."
          },
          {
            "check": "Opening Intersection",
            "errorMessage": "N/A",
            "recovery": "Blocking segments falling inside element openings (Windows/Doors) are automatically skipped."
          },
          {
            "check": "Intersecting Beams Found",
            "errorMessage": "No intersecting beams found in element [Element Number]! Please check the reference position and offset.",
            "recovery": "Adjust 'Offset from reference point' or ensure blocking vector is perpendicular to structural beams."
          }
        ],
        "postInsertionActions": [
          {
            "action": "Adjust Blocking Dimensions",
            "how": "OPM (AutoCAD Properties Palette)",
            "effect": "Updates Width (dBmW) and Height (dBmH). Script recalculates geometry."
          },
          {
            "action": "Change Positioning",
            "how": "OPM",
            "effect": "Updates Reference Point, Offset, or Rotation. Script recalculates location and orientation."
          },
          {
            "action": "Toggle Integrated Mode",
            "how": "OPM (Change 'Type' property)",
            "effect": "Switches between creating a standalone beam and cutting holes in surrounding studs."
          },
          {
            "action": "Modify Geometry via Grips",
            "how": "Grip Edit",
            "effect": "Moving the Start/End points (_Pt0, _PtG) updates the blocking line and recalculates intersections."
          },
          {
            "action": "Filter Beams",
            "how": "OPM ('Filter definition' or 'Beamcode')",
            "effect": "Changes which structural beams are considered for intersection/cutting."
          }
        ]
      },
      "tokens_used": 10155,
      "error": null
    },
    "6": {
      "success": true,
      "data": {
        "markdown": "# HSB_W-Blocking.mcr\n\n## Overview\nThis script automatically generates blocking members (noggings) or integrated tooling cuts between structural beams based on a user-defined path. It calculates intersections with existing elements to place blocking at specific offsets, skipping areas with openings or segments shorter than the minimum length.\n\n## Usage Environment\n| Space | Supported | Notes |\n|-------|-----------|-------|\n| Model Space | Yes | The script operates in the 3D model environment and requires an Element context. |\n| Paper Space | No | Not supported. |\n| Shop Drawing | No | This is a model generation script, not a detailing script. |\n\n## Prerequisites\n- **Required Entities**: An existing hsbCAD Element containing GenBeams (studs/joists).\n- **Minimum Beam Count**: The Element must contain enough Zone 0 beams to define the bounding geometry for calculations.\n- **Required Settings Files**:\n  - `HSB_G-FilterGenBeams.mcr`: Required if using advanced beam filtering.\n  - `HSB_T-IntegratedTooling.mcr`: Required if using the \"Integrated beam\" type with a specific catalog.\n\n## Usage Steps\n\n### Step 1: Launch Script\n1.  Type `TSLINSERT` in the command line.\n2.  Select `HSB_W-Blocking.mcr` from the file dialog.\n\n### Step 2: Select Element\n```\nCommand Line: |Select an element|\nAction: Click on the structural element (wall or floor) where you want to add blocking.\n```\n\n### Step 3: Define Path\n```\nCommand Line: |Select start point|\nAction: Click a point in 3D space to define the start of the blocking line.\n```\n\n```\nCommand Line: |Select end point|\nAction: Click a second point to define the direction and length of the blocking path.\n```\n\n## Properties Panel Parameters\n\nAfter insertion, select the script instance in the model to edit parameters in the Properties Palette.\n\n### Filter\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Filter beams with beamcode | Text | | Filters which structural beams are considered for intersection/cutting based on their beam code. |\n| Filter definition | Dropdown | | Applies a pre-defined filter set (configured in HSB_G-FilterGenBeams). |\n\n### Blocking\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Beam width | Number | 45 | The width (thickness) of the blocking member. |\n| Beam height | Number | 170 | The height (depth) of the blocking member. |\n| Side | Dropdown | Front | Sets the placement side (Front or Back) relative to the reference. |\n| Material | Text | C14 | The material grade assigned to the blocking beams. |\n| Name | Text | Blocking | The name/identifier for the generated beams. |\n| Minimum blocking length | Number | 40 | Blocking segments shorter than this value will not be created. |\n| Gap | Number | 0 | The distance between the ends of the blocking and the intersecting beams. |\n\n### Positioning\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Reference point | Dropdown | Bottom (up) | The base geometric reference: Bottom, Middle, or Top of the bounding beams. |\n| Offset from reference point | Text | 0 | Distance from the reference point. Use `;` to specify multiple positions (e.g., `500; 1000`). |\n| Rotation | Number | 0 | The rotation angle of the blocking beams. |\n\n### Style\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| Type | Dropdown | Blocking | **Blocking**: Creates physical beams. **Integrated beam**: Cuts holes in existing studs rather than adding new beams. |\n| Draw line | Dropdown | Yes | If Yes, draws a visual line indicating the blocking path. |\n| Integrated tooling catalog | Dropdown | | Specifies the tooling catalog to use when \"Type\" is set to \"Integrated beam\". |\n\n## Right-Click Menu Options\n\n| Menu Item | Description |\n|-----------|-------------|\n| Recalculate | Updates the blocking geometry based on the current properties and any changes to the surrounding structural beams. |\n| Erase | Removes the script instance and all generated blocking. |\n\n## Settings Files\n- **Filename**: `HSB_G-FilterGenBeams.mcr`\n- **Purpose**: Defines complex logic for filtering which beams in the element should be intersected or ignored by the blocking script.\n\n## Tips\n- **Multiple Rows**: You can generate multiple rows of blocking at once by separating offset values with a semi-colon (e.g., `500;1000;1500`).\n- **Integrated vs. Blocking**: Use the **Integrated beam** type when you want to cut holes in existing studs (for services) rather than adding solid timber blocking between them.\n- **Openings**: The script automatically detects Element openings (windows/doors) and will not generate blocking segments that fall inside them.\n- **Grip Editing**: You can drag the Start and End grip points in the model to adjust the blocking line length or angle after insertion.\n\n## FAQ\n- **Q: The script reports \"No intersecting beams found\".**\n  - A: This usually means the line drawn by your start/end points does not cross the path of any structural beams in the filtered set. Try adjusting the **Offset from reference point** or rotate the path to ensure it crosses studs/joists.\n- **Q: Why are small gaps in the blocking missing?**\n  - A: Check the **Minimum blocking length** property. If the space between structural studs is smaller than this value, the script will skip that segment to avoid creating tiny, unusable pieces.\n- **Q: Can I use this to cut holes for pipes instead of adding blocking?**\n  - A: Yes. Set the **Type** property to **Integrated beam** and select your desired **Integrated tooling catalog**."
      },
      "tokens_used": 6562,
      "error": null
    }
  }
}